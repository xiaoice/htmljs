var alertd,assert,fn_body,get_stack_rep,global_report_exception,strip_comments;strip_comments=function(a){return a.replace(/\/\/.*/g,"").replace(/\/\*[\s\S]*?\*\//g,"")};fn_body=function(b){var a;a=strip_comments(b.toString());a=a.replace(/[\s]+/g," ");if(a[0]==="("){a=a.substr(1)}if(a[a.length-1]===")"){a=a.substr(0,a.length-1)}a=a.replace("function (","function(");return a};get_stack_rep=function(){var d,c,b,a;b=[];a={};d=arguments.callee.caller;while(d){if(d.__tb_ajax_info__){b.unshift("Ajax.DBRequest: "+d.__tb_ajax_info__);break}if(d.__tb__){b=d.__tb__.concat(b);break}c=fn_body(d);if(c in a){break}a[c]=true;b.unshift(c);d=d.caller}return b};global_report_exception=function(h,g,b,c,a,k){var i,d;if(!window.active_user_loaded){window.an_error_happened_before_loading=true}else{window.an_error_happened_after_loading=true}if(!(window.reported_exception!=null)||a){d="";if(!c){try{i=get_stack_rep();i.pop();i.pop();c=i.join("\\n")}catch(j){}}if(!k){k=[]}jQuery.ajax({url:"/jse",type:"POST",data:{e:h,f:g||window.location.href,l:b,loc:window.location.href,ref:Constants.referrer,tb:c,trace:typeof Trace!=="undefined"&&Trace!==null?Trace.get():void 0,tags:JSON.stringify(k)}});return window.reported_exception=h}};window.onerror=function(c,b,a){return global_report_exception(c,b,a)};alertd=window.alert;assert=function(c,f,b,d,e){var a;if(b==null){b=true}if(d==null){d=[]}if(e==null){e=true}if(!c){f="Assertion Error: "+f;if(!Constants.IS_PROD){if(typeof console!=="undefined"&&console!==null){if(typeof console.trace==="function"){console.trace()}}alertd(f)}a=get_stack_rep();a.pop();global_report_exception(f,window.location.href,"",a.join("\n"),b,d);if(e){throw f}}};window.alert=function(a){jQuery.ajax({url:"/tormod",type:"POST",data:{tor:""+a,mod:window.location.href,ssk:get_stack_rep().join("\n\n"),oog:document.documentElement.innerHTML}});return alertd(a)};var HTML;HTML=(function(){function a(b){this._str_DONT_TOUCH=b}a.prototype.toHTML=function(){return this._str_DONT_TOUCH};a.prototype.toString=function(){return"[object HTML]"};return a})();(function(){var b,d,c,a;HTML.tmpl=function(g,f){var e;if(!/[^\w:.-]/.test(g)){g=document.getElementById(g).innerHTML}e=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+g.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<%=(.*?)%>/g,"',HTML._raw_escape($1),'").split("<%").join("');").split("%>").join("p.push('")+"');}return new HTML(jQuery.trim(p.join('')));");if(f){return e(f)}else{return e}};b=/[^\w@\.\ \-\(\)\,\$~%#\[\]\{\}\!\^]/g;c=function(e){return"&#"+e.charCodeAt(0)+";"};d=function(e){return(""+e).replace(b,c)};HTML.escape=function(e){if(e instanceof HTML){return e}else{return new HTML(d(e))}};return HTML._raw_escape=a=function(e){if(e instanceof HTML){return e.toHTML()}else{if(typeof e==="number"){return e}else{return d(e)}}}})();(function(){var a,b;Function.prototype.defer=Function.prototype.defer.wrap(function(d){var c;c=$A(arguments).slice(1);this.__tb__=get_stack_rep();return d.apply(this,c)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(d){var c;c=$A(arguments).slice(1);try{return d.apply(this,c)}catch(f){return assert(0,f.toString())}});Function.prototype.cached=function(c){var e,d;d=Math.random();e=this;return function(){var f;f=Jcached.get(d);if(f!==false){return f}f=e();Jcached.set(d,f,c);return f}};Array.prototype.sort_by_key=function(d,e){var c;if(e==null){e=false}c=e?-1:1;return this.sort(function(f,g){f=d(f);g=d(g);if(f<g){return c*-1}else{if(f>g){return c*1}else{return 0}}})};Array.prototype.contains=function(c){return this.indexOf(c)!==-1};Array.prototype.remove=function(d,c){c=c||d+1;return this.splice(d,c-d)};Array.prototype.removeItem=function(d){var c;c=this.indexOf(d);if(c>=0){return this.remove(c)}else{return false}};Array.prototype.dict_by=function(c){var f,g,e,h,d;e={};for(f=h=0,d=this.length;h<d;f=++h){g=this[f];e[this[f][c]]=this[f]}return e};Array.prototype.unique=function(){var g,e,f,d,c;g={};for(f=0,d=this.length;f<d;f++){e=this[f];if(typeof e!=="string"){return this}g[e]=0}c=[];for(e in g){c.push(e)}return c};String.prototype.widthSplit=function(f){var c,e,d,g;if(f==null){f=15}c=[];e=this;g=0;d=e.substring(g,g+f);while(d!==""){c.push(d);g+=f;d=e.substring(g,g+f)}return c};Object.extend(Effect.Transitions,{EaseIn:function(c){return Math.pow(c,2)},EaseOut:function(c){return Math.pow(c,0.5)}});(function(e){var d,c;d=function(j){var g,n,m,k,o,i,h,l,f;if(j){if(Object.isArray(j)){g=[];for(i=0,l=j.length;i<l;i++){n=j[i];g.push(HTML.escape(n).toHTML())}j=new HTML(g.join(""))}else{if(j.top||j.bottom||j.before||j.after){k=["top","bottom","before","after"];for(h=0,f=k.length;h<f;h++){m=k[h];o=j[m];if(o){j[m]=arguments.callee(o)}}}else{if(Util.isElm(j)||j.toElement||j.toHTML){}else{j=HTML.escape(j)}}}}return j};return Element.addMethods({db_observe:function(g,f,h){return g.observe(f,function(i){return h(i,g)})},smoothScrollIntoView:function(i,h){var m,g,f,l,k,j;if(h==null){h={}}m={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};h=Object.extend(m,h);f=i.viewportOffset(i);g=i.getDimensions();j=document.viewport.getDimensions();k=h.padding||0;if(f.top>k&&(f.top+g.height)<(j.height-k)){return}l=f.top<k?-1*Math.floor(j.height/4):-1*Math.floor(3*j.height/4);h.offset=h.offset||l;return new Effect.ScrollTo(i,h)},__sert:function(f,g){return Element.insert(f,d(g))},__date:function(f,g){return Element.update(f,d(g))},replace:c=function(f,g){return e(f,d(g))}})})(Element.replace);a=function(c){if(c!=null?c.target:void 0){try{return document.activeElement=c.target===document?null:c.target}catch(d){}}};b=function(c){try{return document.activeElement=null}catch(d){}};if(document.addEventListener){document.addEventListener("focus",a,true);document.addEventListener("blur",b,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(d,c){var e;if(c==null){c="0"}e=this;while(e.length<d){e=c+e}return e.toString()};String.prototype.reverse=function(){var e,d,c;c=this.split("");d=c.reverse();e=d.join("");return e};String.prototype.count=function(c){return(this.length-this.gsub(c,"").length)/c.length};String.prototype.repeat=function(c){return(new Array(c+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,l,j){var p,o,v,i,e,c,r,m,k,q,f,d,t,u,n,h,g,s=this;if(j==null){j={}}this.orig_req={url:l,options:j};this.start_time=Util.time();j.method=j.method||"post";j.evalJS=false;j.suppress_nonstandard_headers=true;j.parameters=j.parameters||{};j.parameters.t=Constants.TOKEN;j.parameters.is_xhr=true;if(j.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){j.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){j.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.GANDALF_PANEL&&l.indexOf("/")===0){j.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){j.parameters.restrict=Ajax.DBRequest.restrict}o=j.cleanUp||(function(){});this.subject_user=j.subject_user||j.job_user;if(j.job){this.job_id=Util.nonce();j.parameters.job_id=this.job_id;ProgressWatcher.watch(this,j.dont_hide_progress_on_complete)}if(!j.no_watch){RequestWatcher.watch(this,!!j.job)}r=j.onFailure;m=j.onSuccess;c=j.onComplete;e=function(w){var y,x;if(j.parameters.xhr_retry||!j.allow_retries){return false}if((x=w.status)===0||x===500||x===502||x===503){s.orig_req.options.parameters.xhr_retry=true;s.orig_req.options.onFailure=r;s.orig_req.options.onSuccess=m;y=new Ajax.DBRequest(s.orig_req.url,s.orig_req.options);return true}return false};i=function(x){var w;if(j.noAutonotify||j.no_watch){return}if(x.status!==0&&x.status<400){return}w={url:s.orig_req.url,response_code:x.status,source_type:"web",request_id:x.getHeader("X-Dropbox-Request-Id")};return new Ajax.DBRequest("/web_response_code_log",{noAutonotify:true,no_watch:true,parameters:w})};j.onFailure=function(x){var z,w,y;if(Job.handled(x.request.job_id)){return}i(x);if(e(x)){return}if(!j.noAutonotify){if(!Constants.IS_PROD&&x.status===500&&x.getHeader("X-Debug-Url")){l=x.getHeader("X-Debug-Url");z=_("There was a problem completing this request.")+(' <a href="'+l+'" target="_blank">View debug</a>');Notify.server_error(new HTML(z))}else{Notify.server_error()}}o(false);if(r){r(x)}if(x.status===403){w=Util.session_storage_get("reload-timestamp");if(!w||Util.time()-w>30*1000){Util.session_storage_set("reload-timestamp",Util.time());location.reload(true)}}return assert(j.noAutonotify||((y=x.status)===403||y===404||y===502),"Ajax "+x.status+" on "+x.request.url)};j.onComplete=function(w){if(w.responseText.length&&c){if(w.responseText.indexOf("async_task_started:")!==0){return c(w)}}};j.onSuccess=function(F){var E,w,L,I,G,x,K,z,B,J,y,C,H,D,A;y=Util.time()-F.request.start_time;if(Job.handled(F.request.job_id)){return}if(typeof QueryLog!=="undefined"){QueryLog.update_query_log_from_req(F)}if(!F.responseText.length){if(!j.job){i(F);if(e(F)){return}if(!j.noAutonotify?!F||F.status!==0:void 0){Notify.server_error()}if(r){r(F)}}}else{if(F.responseText.indexOf("err:")===0){if(!j.noAutonotify){x=F.responseText.substr(4);if(j.html_in_error_msg){x=new HTML(x)}Notify.server_error(x)}if(r){r(F)}}else{if(F.responseText.indexOf("async_task_started:")===0){s.async_task_id=F.responseText.split(":")[1];ProgressWatcher.watch(s)}else{if(m){if(F.responseText.indexOf("ok:")===0){Notify.server_success(F.responseText.substr(3))}m(F)}}J=F.getHeader("X-Server-Response-Time")||"-1";if(j.log_timing){WebTimingLogger.log_ajax_transition.defer(y,void 0,void 0,void 0,J,l=URLUtil.absolutize(s.url))}E=$j("#cprofile");if(!j.no_watch&&E.length){B=""+Constants.REQUEST_ID+"-"+(F.getHeader("X-Dropbox-Request-Id"));l=F.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");I="Ajax: "+l+" ("+J+"ms)";K="/profile/cprofile?request_id="+B;z=F.request.url;if(z.indexOf(Constants.BLOCK_CLUSTER)!==-1){K+="&block=1"}else{D=Constants.BATCH_THUMB_ENDPOINTS;for(C=0,H=D.length;C<H;C++){L=D[C];if(z.indexOf(L)!==-1){K+="&block=1";break}}}G=$j('<a class="ajax" target="_new" />').attr("href",K).text(I);w=E.find(".ajax");if(w.length>=10){w.last().remove()}E.prepend(G)}if($j("#gandalf_panel").length&&F.request.url.substring(0,14)!=="/gandalf_panel"){if((A=window.gandalf_panel)!=null){A.add(F.request.url,F.getHeader("X-Dropbox-Request-Id"))}}}}return o(true)};j.onException=function(x,y){var z,w;if(window.console){throw y}z=("Error with AJAX callback for: "+l+" :::: ")+y.toString();w=get_stack_rep();w.pop();return global_report_exception(z,window.location.href,"",w.join("\n"))};if(j.job){l+=(l.indexOf("?")===-1?"?":"&")+"long_running=1"}if((n=j.parameters)!=null?n[Constants.UID_PARAM_NAME]:void 0){}else{if("subject_user" in j){q=j.subject_user;l=URI.parse(l).updateQuery(Constants.UID_PARAM_NAME,q).toString()}else{if("role" in j&&Multiaccount.is_valid_role(j.role)){l=Multiaccount.add_role_param(l,j.role)}else{if(Multiaccount.has_role()){if(!j.suppress_role){l=Multiaccount.add_role_param(l)}}}}}p=$H({url:l});if(j.parameters){p.update(j.parameters);h=p.keys();for(f=0,t=h.length;f<t;f++){v=h[f];g=["passwd","password","oauth","ccn","host_id"];for(d=0,u=g.length;d<u;d++){k=g[d];if(v.indexOf(k)!==-1){p.unset(v)}}}p.unset("t")}j.onSuccess.__tb_ajax_info__=j.onFailure.__tb_ajax_info__=Object.toJSON(p);return $super(l,j)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(Util.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())})}).call(this);var __slice=[].slice;if(!window.$j){window.$j=window.jQuery}if(!Function.prototype.bind){Function.prototype.bind=function(a){var e,d,b,c;if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}e=Array.prototype.slice.call(arguments,1);c=this;b=function(){};d=function(){return c.apply((this instanceof b&&a?this:a),e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;d.prototype=new b();return d}}jQuery.fn.curry=function(){var a,c,b;c=arguments[0],b=arguments[1],a=3<=arguments.length?__slice.call(arguments,2):[];if(b==null){b=window}return function(){var d;d=1<=arguments.length?__slice.call(arguments,0):[];return c.apply(b,__slice.call(a).concat(__slice.call(d)))}};jQuery.fn.stripTags=function(a){return a.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.controller=function(a){if(a!=null){return this.data("jscontroller",a)}else{return this.data("jscontroller")}};jQuery.fn.hasScrollBar=function(){return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(a){var c,b;c=jQuery(this).offset();b=jQuery(window);return{left:c.left-b.scrollLeft(),top:c.top-b.scrollTop()}};jQuery.fn.visible=function(){return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(c,k){var f,e,h,d,g,i,j;j={setLeft:true,setTop:true,setWidth:true,setHeight:true,offsetTop:0,offsetLeft:0};jQuery.extend(j,k||{});c=jQuery(c);i=c.viewportOffset();h={top:0,left:0};g=null;d=this;if(d.css("position")==="absolute"){g=d.offsetParent();h=g.viewportOffset()}if(g&&g[0]===document.body){h.left-=document.body.offsetLeft;h.top-=document.body.offsetTop}if(j.setLeft){f=(i.left-h.left+j.offsetLeft)+"px";d.css("left",f)}if(j.setTop){e=(i.top-h.top+j.offsetTop)+"px";d.css("top",e)}if(j.setWidth){d.width(c[0].offsetWidth)}if(j.setHeight){d.height(c[0].offsetHeight)}return d};jQuery.fn.binarySearch=function(c,b,a){return Util.binarySearch(this,c,b,a)};jQuery.format=function(b,a){return b.replace(/\{([^}]+)\}/g,function(d,c){if(c in a){return a[c]}else{return d}})};jQuery.formatDate=function(c,a){var b;b=[_("AM"),_("PM")];return a.replace(/'[^']*'|y+|M+|d+|h+|k+|K+|H+|m+|s+|S+|a+/g,function(e){var d;switch(e[0]){case"'":if(e.length===2){return"'"}return e.slice(1,-1);case"y":if(e==="yy"){return c.getYear()%100}d=c.getFullYear();break;case"M":if(e.length>=3){return Util.month_name(c.getMonth(),e.length===3)}d=c.getMonth()+1;break;case"d":d=c.getDate();break;case"h":d=c.getHours()%12||12;break;case"k":d=c.getHours()%12+1;break;case"K":d=c.getHours()%12;break;case"H":d=c.getHours();break;case"m":d=c.getMinutes();break;case"s":d=c.getSeconds();break;case"S":d=c.getMilliseconds();break;case"a":return b[(c.getHours()>=12)*1]}d=""+d;if(d.length<e.length){d=("00000000"+d).slice(e.length*-1)}return d})};jQuery.cachedScript=function(b,a){a=$j.extend(a||{},{dataType:"script",cache:true,url:b});return jQuery.ajax(a)};(function(){var b,a,c;b=200;a=function(g,e,f,d){if(typeof g==="function"){return g.call(e[0],f,d)}};c="ontouchstart" in window;return jQuery.fn.tappable=function(d,e){var h,g,f;g={cancelOnMove:true,touchDelay:0,callback:null,touchstartCallback:null};f=false;h=function(i){if(!f){f=true;setTimeout(function(){return f=false},b);return i()}else{}};if(undefined===e){e=d;d=null}switch(typeof e){case"function":g.callback=e;break;case"object":$.extend(g,e)}if(c){this.on("touchstart",d,function(k){var j,i;j=jQuery(this);i=j.prop("tappable");a(g.touchstartCallback,j,k);if(!i){i={event:k,attached:0};j.prop("tappable",i)}i.attached++;return window.setTimeout((function(){if(i){return j.addClass("touched")}}),g.touchDelay)});this.on("touchend",d,function(k){var j,i;j=jQuery(this);i=j.prop("tappable");if(i){k=i.event;if(0===--i.attached){j.removeProp("tappable").removeClass("touched")}h(function(){return a(g.callback,j,k,true)});return document.activeElement.blur()}});if(g.cancelOnMove){this.on("touchmove",d,function(){return jQuery(this).removeProp("tappable").removeClass("touched")})}this.on("touchcancel",d,function(i){return jQuery(this).removeProp("tappable").removeClass("touched")})}this.on("click",d,function(i){return h(function(){return a(g.callback,jQuery(this),i,false)})});return this}})();(function(){var b,a;jQuery.uaMatch=function(d){var c;d=d.toLowerCase();c=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||/(trident).*? rv:([\w.]+)/.exec(d)||d.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:c[1]||"",version:c[2]||"0"}};a=jQuery.uaMatch(navigator.userAgent);b={};if(a.browser==="trident"){a.browser="msie"}if(a.browser){b[a.browser]=true;b.version=a.version}if(b.chrome){b.webkit=true}else{if(b.webkit){b.safari=true}}b.msie_version_at_most=function(c){return b.msie&&parseInt(b.version,10)<=c};return jQuery.browser=b})();jQuery.addSubjectParam=function(d,a){var c,b;if((b=d.data)!=null?b[Constants.UID_PARAM_NAME]:void 0){}else{if("subject_user" in d){c=d.subject_user;if(c){return a[Constants.UID_PARAM_NAME]=String(c)}}else{if(d.data&&"role" in d.data&&Multiaccount.is_valid_role(d.data.role)){return a[Constants.ROLE_PARAM]=d.data.role}else{if(Multiaccount.has_role()){return a[Constants.ROLE_PARAM]=Multiaccount.get_role()}}}}};jQuery.ajaxPrefilter(function(a,d,c){var b;if(!d.noDropboxDefaults){b={t:Constants.TOKEN,is_xhr:true};jQuery.addSubjectParam(d,b);if(jQuery.ajaxSettings.restrict!=null){b.restrict=jQuery.ajaxSettings.restrict}a.data=$j.param($j.extend(d.data,b),d.traditional);return false}});jQuery.ajax.retryOnce=function(d,a,b){var c;if(a!=="abort"&&((c=d.status)===0||c===500||c===502||c===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var E_,I18nProjects,LANGPACK,N_,NoOpTranslated,PLURAL_RULES,add_i18n_message,fake_translate,get_langpack,i18n_default_project,locale_is_fake,localized_path,render_sentences,russia_ukraine,singular_01,singular_1,singular_all,ungettext,_,__slice=[].slice;add_i18n_message=function(d,c,a,b){Constants.messages=Constants.messages||{};Constants.emessages=Constants.emessages||{};c=$j.fn.stripTags(c).friendly_format();a=$j.fn.stripTags(a);Constants.messages[c]=d;Constants.emessages[c]=a;if(b){delete Constants.messages[b];return delete Constants.emessages[b]}};singular_1=function(a){if(a===1){return 0}else{return 1}};singular_01=function(a){if(a<=1){return 0}else{return 1}};singular_all=function(a){return 0};russia_ukraine=function(a){if(a%10===1&&a%100!==11){return 0}else{if(a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)){return 1}else{return 2}}};PLURAL_RULES={en:singular_1,da_DK:singular_1,de:singular_1,es_ES:singular_1,es:singular_1,fr:singular_01,id:singular_all,it:singular_1,ja:singular_all,ko:singular_all,ms:singular_all,nb_NO:singular_1,nl_NL:singular_1,pl:function(a){if(a===1){return 0}else{if(a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)){return 1}else{return 2}}},pt_BR:singular_01,ru:russia_ukraine,sv_SE:singular_1,th_TH:singular_all,tr:singular_all,uk_UA:russia_ukraine,xx_AC:singular_1,xx_LS:singular_1,zh_CN:singular_all,zh_TW:singular_all};if(!window.LANGPACK){LANGPACK={}}get_langpack=function(){return LANGPACK};_=function(){var c,h,a,g,e,d,b,f;d=arguments[0],c=2<=arguments.length?__slice.call(arguments,1):[];f=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(c))),g=f.project,h=f.comment;if(locale_is_fake(Constants.USER_LOCALE)){e=fake_translate(d,Constants.USER_LOCALE)}else{b=I18nProjects.get_string_key(d,g,h);a=get_langpack();e=a[b]||a[d]||d}add_i18n_message(d,e,d);return e};fake_translate=function(b,a){if(a==="xx_LS"){b=b+"SSSSSSSSSSSSSSSSSSSSSSSSS"}if(a==="xx_AC"&&!/<a/.test(b)){b=b.toUpperCase()}return b};locale_is_fake=function(a){return a==="xx_LS"||a==="xx_AC"};ungettext=function(){var h,e,g,m,j,b,a,i,o,k,f,d,l,c;d=arguments[0],i=arguments[1],a=arguments[2],h=4<=arguments.length?__slice.call(arguments,3):[];c=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(h))),k=c.project,e=c.comment;assert(a!=null,"missing number parameter for ungettext");j=Constants.USER_LOCALE;if(j){if(locale_is_fake(j)){d=fake_translate(d,j);i=fake_translate(i,j)}else{l=I18nProjects.get_string_key(d,k,e);m=get_langpack();b=m[l]||m[d];if(b){if(b instanceof String||typeof b==="string"){return b}o=PLURAL_RULES[j](a);if(o in b){f=b[o]}}}}g=a===1?d:i;if(f==null){f=g}add_i18n_message(d,f,g);return f};NoOpTranslated=(function(){function a(c,b,d){this.msg=c;this.project=b;this.comment=d}return a})();N_=function(){var a,e,d,b,c;b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[];c=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(a))),d=c.project,e=c.comment;return new NoOpTranslated(b,d,e)};E_=function(a){return _(a.msg,a.project,a.comment)};i18n_default_project=function(a){return{_:function(){var b,e,c,d;c=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];d=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(b))),a=d.project,e=d.comment;return _(c,a,e)},ungettext:function(){var c,g,f,b,d,e;d=arguments[0],b=arguments[1],f=arguments[2],c=4<=arguments.length?__slice.call(arguments,3):[];e=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(c))),a=e.project,g=e.comment;return ungettext(d,b,f,a,g)},N_:function(){var b,e,c,d;c=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];d=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(b))),a=d.project,e=d.comment;return N_(c,a,e)},E_:E_}};I18nProjects={get_message_context:function(c,e){var b,a,d;a=void 0;if(c!=="web"){a="project:"+c}if(e!=null){d=new jsSHA(e,"TEXT");b=d.getHash("SHA-1","HEX");if(a!=null){a+=" "+b}else{a=b}}return a},CONTEXT_DELIMITER:"\u0004",get_string_key:function(a,c,d){var b;b=I18nProjects.get_message_context(c,d);if(b!=null){return b+I18nProjects.CONTEXT_DELIMITER+a}else{return a}}};localized_path=function(f,b){var c,e,a,d;if(!b){d=Constants.LOCALES;for(e=0,a=d.length;e<a;e++){c=d[e];b=c[0]}}if(b.indexOf(Constants.USER_LOCALE)!==-1){return f.replace(/(\.[a-zA-Z0-9]{2,4})$/,"__%s$1".format(Constants.USER_LOCALE))}else{return f}};render_sentences=function(g){var c,b,e,f,d,a;c=g.length;if(c===1){return g[0]}else{if(c===2){return _("%s %s",{comment:"Two sentences"}).format(g)}else{if(c===3){return _("%s %s %s",{comment:"Three sentences"}).format(g)}else{if(c===4){return _("%s %s %s %s",{comment:"Four sentences"}).format(g)}else{b="";f=0;for(d=0,a=g.length;d<a;d++){e=g[d];b+=e;if(f!==(c-1)){b+=_(" ",{comment:"Sentence separator character"})}f+=1}return b}}}}};String.prototype.format_sub=function(a){return this.replace(/%(\([a-zA-Z0-9_\-]+\))?(.\d+)?(.)/g,a.bind(this))};String.prototype.format=function(){var g,f,e,c,b,a;if(arguments.length===0){return this.toString()}f=void 0;g=0;if(arguments.length===1&&arguments[0] instanceof Object){f=arguments[0]}else{f=$j.makeArray(arguments)}b=function(l,j,i,k){var n,m,d,h;if(!j){if(!$j.isArray(f)){f=[f]}assert(g>-1,"Cannot mix named and positional indices in string formatting for string '"+this+"'.");assert(g<f.length,"Insufficient number of items in format for string '"+this+"'");h=f[g];g++}else{j=j.slice(1,-1);assert(g<=0,"Cannot mix named and positional indices in string formatting for string '"+this+"'.");g=-1;n=Constants.USER_LOCALE==="xx_AC";assert(j in f||(n&&j.toLowerCase() in f),"Key '"+j+"' not present during string substitution for string '"+this+"'");h=f[j];if(n){h=f[j.toLowerCase()]}}assert(typeof h!=="undefined","value for key '"+(j||"")+"' is undefined");d=void 0;if(k==="s"||k==="S"){d=h.toString()}else{if(k==="d"||k==="D"){d=parseInt(h,10).toString()}else{if(k==="f"||k==="F"){d=Number(h).toString()}else{if(k==="%"){return"%"}else{assert(false,"Unexpected format character '"+k+"' for string '"+this+"'.")}}}}if(i){i=parseInt(i.slice(1),10);if(k==="f"||k==="F"){if(d.indexOf("."===-1)){d=d+".0"}m=d.split(".");return m[0]+"."+m[1].slice(0,i)}else{return d.slice(0,i)}}return d};a=this.format_sub(b);if(Constants.messages&&this in Constants.messages){g=0;c=Constants.emessages[this];e=String.prototype.format_sub.call(c,b);add_i18n_message(c,a,e,this)}return a};String.prototype.friendly_format=function(){var a,c,b;c=function(g,e,d,f){if(!e){if(f==="s"||f==="S"){return"[word"+(b++)+"]"}else{return"[number"+(a++)+"]"}}else{return"["+(e.slice(1,1).replace("-","_"))+"]"}};a=1;b=1;return this.format_sub(c)};String.prototype.blank_format=function(){var a;a=function(){return""};return this.format_sub(a)};var PyKeywordArguments,__slice=[].slice;PyKeywordArguments=function(){var g,h,f,l,c,a,j,k,d,e,b;a=arguments[0],g=2<=arguments.length?__slice.call(arguments,1):[];c={};a=(function(){var n,m,i;i=[];for(n=0,m=a.length;n<m;n++){j=a[n];i.push(typeof j==="string"?{name:j,"default":void 0}:{name:j[0],"default":j[1]})}return i})();h=function(){var p,o,n,s,r,q,m,t;if(!((g!=null)&&typeof g[g.length-1]==="object")){return false}n={};for(p=r=q=g.length-1,m=a.length-1;r<=m;p=r+=1){n[a[p].name]=true}t=g[g.length-1];for(o in t){s=t[o];if(!(o in n)){return false}}return true};if(h()){e=g[g.length-1];for(l in e){k=e[l];c[l]=k}g.pop()}for(f=d=0,b=a.length-1;d<=b;f=d+=1){if(f<g.length){c[a[f].name]=g[f]}else{if(!(a[f].name in c)){c[a[f].name]=a[f]["default"]}}}return c};var QueryComponent,URI;URI=(function(){function a(b,g){var d,f,e,c;if(!(this instanceof a)){return new a(b,g)}this._query=new QueryComponent;e={};if(typeof b==="string"||b instanceof a){if(!(typeof Constants!=="undefined"&&Constants!==null?Constants.IS_PROD:void 0)){throw new Error("URI/uri string passed into URI constructor.  Use URI.parse instead.")}e=a.parse(b).toObject()}else{if(typeof b==="object"){e=b}}if(g&&!(typeof Constants!=="undefined"&&Constants!==null?Constants.IS_PROD:void 0)){throw new Error("Multiple arguments passed into URI constructor.")}f=g||{};for(d in f){c=f[d];e[d]=c}this.initFromObject(e)}a.prototype.initFromObject=function(b){var e,c,d;d=b!=null?b:{},c=d.scheme,this.authority=d.authority,this.path=d.path,e=d.query,this.fragment=d.fragment;this.setScheme(c);return this.setQuery(e)};a.parse=function(g){var d,b,e,i,j,f,h,c;assert(g!=null,"must pass in a valid url-encoded string");d=String(g).match(a.REGEXP)||[];c=d[0],h=d[1],e=d[2],j=d[3],f=d[4],i=d[5];b=new a();b.setScheme(h);b.setAuthority(a.decode(e));b.setPath(a.decode(j));b.setQuery(QueryComponent.parse_string(f));b.setFragment(a.decode(i));return b};a.prototype.getScheme=function(){return this.scheme||""};a.prototype.setScheme=function(b){assert(!b||b.match(a.SCHEME_REGEXP,"Invalid scheme"));this.scheme=b;return this};a.prototype.getAuthority=function(){return this.authority||""};a.prototype.setAuthority=function(b){this.authority=b;return this};a.prototype.getPath=function(){return this.path||""};a.prototype.setPath=function(b){this.path=b;return this};a.prototype.getFragment=function(){return this.fragment||""};a.prototype.setFragment=function(b){this.fragment=b;return this};a.prototype.getQuery=function(){return this._query.dict};a.prototype.setQuery=function(b){if(b==null){b={}}this._query=new QueryComponent(b);return this};a.prototype.updateQuery=function(c,b){if(b==null){b=null}this._query.add(c,b);return this};a.prototype.clone=function(){return a(this.toObject())};a.prototype.toObject=function(){return{scheme:this.getScheme(),authority:this.getAuthority(),path:this.getPath(),query:this.getQuery(),fragment:this.getFragment()}};a.prototype.toString=function(){var c,b;b="";if(this.scheme){b+=this.scheme+":"}if(this.authority){b+="//"+a.encode(this.authority,":@[]")}if(this.path){assert(!this.authority||!this.path.length||this.path[0]==="/",'Path must start with a "/" if URI is not relative');b+=a.encode(this.path,"/")}c=this._query.toString();if(c){b+="?"+c}if(this.fragment){b+="#"+a.encode(this.fragment,":@[]/&=+?#!")}return b};a.REGEXP=/^(?:([^:/\\?#]+):)?(?:[/\\]{2}([^/\\?#]*))?([^?#]*)(?:\?([^#]*))?(?:[#](.*))?$/;a.SCHEME_REGEXP=/^[a-zA-Z][a-zA-Z0-9+.\-]*$/;a.decode=function(b){if(!b){return""}return decodeURIComponent(b)};a.encode=function(e,d){var f,g,c,b;if(d==null){d=""}if(!e){return""}e=encodeURIComponent(e);d+="~";for(c=0,b=d.length;c<b;c++){g=d[c];f=encodeURIComponent(g);e=e.replace(new RegExp(f,"g"),g)}return e};return a})();QueryComponent=(function(){function a(b){this.dict={};this.add(b)}a.parse_string=function(g){var d,b,h,c,e,j,f,i;if(!g){return null}h={};c=g.split("&");for(f=0,i=c.length;f<i;f++){b=c[f];if(b!==""){e=b.split("=");d=a.decode(e[0]);j=a.decode(e.slice(1).join("="));h[d]=j}}return h};a.prototype.add=function(f,d){var c,e,b;if(d==null){d=null}if(typeof f==="string"){if(d!=null){this.dict[f]=String(d)}}else{e=f||{};for(c in e){b=e[c];if(b!=null){this.dict[c]=String(b)}}}return this};a.prototype.replace=function(b){this.dict=b||{};return this};a.prototype.toString=function(){var d,b,c,e;b=[];e=this.dict;for(d in e){c=e[d];b.push(a.encode(d)+"="+a.encode(c))}if(!b.length){return""}return b.join("&")};a.decode=function(b){if(b===null){return""}return URI.decode(b.replace(/\+/g,"%20"))};a.encode=function(b){if(b===null){return""}return URI.encode(b).replace(/%20/g,"+")};return a})();var User,__hasProp={}.hasOwnProperty;User=(function(){function a(c){var b;for(b in c){if(!__hasProp.call(c,b)){continue}if(typeof b==="string"&&b[0]!=="_"){this[b]=c[b]}}}a.prototype.toString=function(){return String(this.id)};return a})();var Viewer,__hasProp={}.hasOwnProperty;Viewer=(function(){function a(f){var e,d,c,g,h,b;if(f==null){f={}}this._authed_users={};this._all_users={};c=f._user_data||[];for(h=0,b=c.length;h<b;h++){g=c[h];d=new User(g);this._all_users[d.id]=d;if(g._authed){this._authed_users[d.id]=d}}for(e in f){if(!__hasProp.call(f,e)){continue}if(typeof e==="string"&&e[0]!=="_"){this[e]=f[e]}}this.is_signed_in=c.length>0;this.is_paired=c.length>1;this.personal_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_PERSONAL)];this.photos_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_PHOTOS)];this.work_user=this._authed_users[this.get_uid_by_role(Constants.ROLE_WORK)];if(this.deprecated_first_user_in_the_cookie_id){this.deprecated_first_user_in_the_cookie=this.get_user_by_id(this.deprecated_first_user_in_the_cookie_id);delete this.deprecated_first_user_in_the_cookie_id}this.personal_email=this.get_email_by_role(Constants.ROLE_PERSONAL);this.work_email=this.get_email_by_role(Constants.ROLE_WORK);this.is_personal_user_signed_in=this.is_role_signed_in(Constants.ROLE_PERSONAL);this.is_photos_user_signed_in=this.is_role_signed_in(Constants.ROLE_PHOTOS);this.is_work_user_signed_in=this.is_role_signed_in(Constants.ROLE_WORK)}a.prototype.get_user_by_role=function(d,c){var b;b=this.get_uid_by_role(d);if(b===void 0){return void 0}return this.get_user_by_id(b,c)};a.prototype.role_exists=function(b){return this.get_uid_by_role(b)!==void 0};a.prototype.get_user_by_id=function(c,e){var b,d;assert(this.is_uid_associated(c),"User "+c+" is not associated with this viewer");d=e?this._all_users:this._authed_users;b=d[c];assert(b,"User "+c+" is not signed in");return b};a.prototype.is_role_signed_in=function(b){return this.get_uid_by_role(b) in this._authed_users};a.prototype.is_uid_signed_in=function(b){return b in this._authed_users};a.prototype.is_user_signed_in=function(b){return !!(b&&this.is_uid_signed_in(b.id))};a.prototype.is_uid_associated=function(b){return b in this._all_users};a.prototype.get_users=function(f){var d,c,e,b;e=f?this._all_users:this._authed_users;b=(function(){var g;g=[];for(d in e){c=e[d];g.push(c)}return g})();b.sort(function(h,g){if(h.role===Constants.ROLE_PERSONAL){return -1}else{return 1}});return b};a.prototype.get_user_ids=function(c){var b;return(function(){var g,e,f,d;f=this.get_users(c);d=[];for(g=0,e=f.length;g<e;g++){b=f[g];d.push(b.id)}return d}).call(this)};a.prototype.get_email_by_role=function(c){var b;b=this.get_user_by_role(c,true);return b&&b.email};a.prototype.get_uid_by_role=function(e){var c,b,d;if(e===Constants.ROLE_PHOTOS){e=this._get_photos_role()}d=this._all_users;for(c in d){b=d[c];if(b.role===e){return c}}return void 0};a.prototype._get_photos_role=function(){if(this.is_paired||!this.is_signed_in){return Constants.ROLE_PERSONAL}else{return this._values(this._all_users)[0].role}};a.prototype._sign_in_all_users=function(){return this._authed_users=this._shallow_clone(this._all_users)};a.prototype._sign_out_user_by_id=function(b){return delete this._authed_users[b]};a.prototype.sign_in_user_by_id=function(b){assert(this.is_uid_associated(b),"User "+b+" is not associated with this viewer");return this._authed_users[b]=this._all_users[b]};a.prototype._values=function(d){var c,b;b=[];for(c in d){b.push(d[c])}return b};a.prototype._shallow_clone=function(c){var b,d;d={};for(b in c){d[b]=c[b]}return d};return a})();var Multiaccount,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Multiaccount={role:null,possible_roles:[Constants.ROLE_PERSONAL,Constants.ROLE_WORK],init_please_do_not_call_this:function(a){if(a==null){a=null}return this.set_role(a)},get_role:function(){return this.role},has_role:function(){var a;return a=this.get_role(),__indexOf.call(this.possible_roles,a)>=0},set_role:function(a){assert(a===null||this.is_valid_role(a));return this.role=a},is_valid_role:function(a){return __indexOf.call(this.possible_roles,a)>=0},add_role_param:function(b,a){var c;if(a==null){a=null}if(!a){a=this.role}if(!a){return b}else{c={};c[Constants.ROLE_PARAM]=a;return URI.parse(b).updateQuery(c).toString()}},add_role_input:function(a,b){if(b==null){b=null}if(!b){b=this.get_role()}if(!b){return}if($j(a).find("input[name='"+Constants.ROLE_PARAM+"']").length){return $j(a).find("input[name='"+Constants.ROLE_PARAM+"']").val(b)}else{return $j("<input name='role' type='hidden' />").val(b).appendTo(a)}},set_logged_out_role:function(a){assert(a===null||Multiaccount.is_valid_role(a),"role should be a valid role");return this.logged_out_role=a},append_role_to_selector:function(b,a){if(!a){return b}return""+b+"-"+a},set_team_name:function(a){return this.team_name=a},show_page_login_modal:function(b){var a;if(!this.logged_out_role){return}a={role:this.logged_out_role};if(typeof b==="string"){a.success_href=b}else{if(typeof b==="function"){a.on_success=b}}MultiaccountLogin.show_modal(a);return false}};var Cookies;Cookies={create_cookie:function(c,d,e){var b,a;a="";if(e){b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));a="; expires="+(b.toGMTString())}return document.cookie=""+c+"="+d+a+"; path=/"},read_cookie:function(b){var g,f,e,a,d;f=""+b+"=";d=document.cookie.split(";");for(e=0,a=d.length;e<a;e++){g=d[e];while(g.charAt(0)===" "){g=g.substring(1,g.length)}if(g.indexOf(f)===0){return g.substring(f.length,g.length)}}return null},delete_cookie:function(a){return this.create_cookie(a,"",-1)},check_cookies_enabled:function(){var a;a=!(navigator.cookieEnabled!=null)?(document.cookie="this_is_a_test_cookie",document.cookie.indexOf("this_is_a_test_cookie")!==-1):navigator.cookieEnabled;if(!a){Notify.server_error(_("Please enable browser-cookies to use the Dropbox website."))}return a}};var DBObserver,Email,T,Trace,UIButton,URLUtil,Util,Velocity,console,__bind=function(a,b){return function(){return a.apply(b,arguments)}};DBObserver={watch:function(b,c){var a;a=function(){var e,d;e=$(b);assert(e,"Couldn't find watch element");d=e.getValue().strip();if(d!==e.last_search&&!SuggestionInput.defaulted(e)){e.last_search=d;return c(d)}};return setInterval(a,300)}};Email={mailto:function(c,b,d,a){if(d==null){d="dropbox.com"}if(a==null){a=""}c.href="mailto:"+b+"@"+d;if(a){c.href+="?body="+a}return c.onMouseover=null}};Util={get_browse_root:function(a){if(!viewer.is_paired){return"/home"}else{if(a.role===Constants.ROLE_PERSONAL){return"/personal"}else{return"/work"}}},text_width:function(d,a){var c,b;c=$j("<span/>");c.text(d);c.css("font-size",a);$j("body").append(c);b=c.width();c.remove();return b},file_extension_for_logging:function(a){if(a.indexOf(".")===-1){return""}else{return Util.file_extension(a).toLowerCase()}},remove_param_from_url:function(b){var a;if(HTML5_HISTORY){a=DBHistory.deconstruct_url();delete a.qargs[b];return DBHistory.replace_state(a.path,a.qargs)}},viewport_dimensions:function(){var a=this;if(!this._cached_viewport_dimensions){this._cached_viewport_dimensions={height:$j(window).height(),width:$j(window).width()}}if(!this._listening_for_resize){Event.observe(window,"resize",function(){return delete a._cached_viewport_dimensions});this._listening_for_resize=1}return this._cached_viewport_dimensions},set_min_body_height_to_viewport_height:function(){var a;a=$(document.body);if(a!=null?a.style:void 0){return a.style.minHeight=this.viewport_dimensions().height+"px"}},_listen_for_scroll:function(){var a=this;if(!this._listening_for_scroll){Event.observe(window,"scroll",function(){if(a._ignore_scroll_event){a._ignore_scroll_event=0;return}return delete a._cached_scroll_offsets});return this._listening_for_scroll=1}},force_delete_cached_scroll_offsets:function(){return delete this._cached_scroll_offsets},scroll_offsets:function(){var a,c,b;this._listen_for_scroll();if(this.is_page_scrollable()){if(!this._cached_scroll_offsets){this._cached_scroll_offsets=document.viewport.getScrollOffsets()}return this._cached_scroll_offsets}else{a=$j(document.documentElement);b=-1*parseInt(a.css("top"),10);c=-1*parseInt(a.css("left"),10);this._cached_scroll_offsets={0:c,1:b,left:c,top:b};return this._cached_scroll_offsets}},scroll_to:function(a,b){this._listen_for_scroll();this._ignore_scroll_event=1;a=Math.max(a,0);b=Math.max(b,0);if(b>this.scroll_offsets().top){b=Math.min(b,Util.get_document_height()-this.viewport_dimensions().height)}this._cached_scroll_offsets=Element._returnOffset(a,b);return window.scrollTo(a,b)},get_document_height:function(){return Math.max($j(document).height(),$j(window).height(),document.documentElement.clientHeight)},scroll_to_thumb:function(a){var e,d,c,b;d=a.cumulativeOffset().top;e=a.getHeight();b=this.scroll_offsets().top;c=this.viewport_dimensions().height;if(d<b||d+e>b+c){return this.scroll_to(0,d-c/2)}},get_viewport:function(){var a,b;b=Util.scroll_offsets().top;a=Util.viewport_dimensions().height;return{top:b,height:a,bottom:b+a}},is_page_scrollable:function(){return !$j(document.documentElement).hasClass("no-scroll")},set_page_scrollable:function(d){var a,f,g,c,b,e;a=$j(document.documentElement);if(d){if(a.hasClass("no-scroll")){b=-1*parseInt(a.css("top"),10);g=-1*parseInt(a.css("left"),10);a.css({top:"",left:""});a.removeClass("no-scroll");this.scroll_to(g,b+1);this.scroll_to(g,b-1);return this.scroll_to(g,b)}}else{if(!a.hasClass("no-scroll")){c=this.scroll_offsets();e=(-1*c.top)+"px";f=(-1*c.left)+"px";a.css({top:e,left:f});return a.addClass("no-scroll")}}},decode_sort_key:function(c){var e,d,b,a;a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(typeof e==="string"){a.push(this.decode_b64(e))}else{a.push(e)}}return a},sort_by_rank_or_key:function(a,b){if((a.sort_rank!=null)&&(b.sort_rank!=null)){return a.sort_rank-b.sort_rank}assert((a.sort_key!=null)&&(b.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(a,b)},_sort_by_key:function(b,g){var d,a,c,f,e;a=b.sort_key;c=g.sort_key;for(d=f=0,e=a.length;0<=e?f<e:f>e;d=0<=e?++f:--f){if(!(c[d]!=null)){return 1}if(typeof a[d]!==typeof c[d]){if(typeof a[d]==="string"){return 1}else{return -1}}else{if(a[d]!==c[d]){if(a[d]>c[d]){return 1}else{return -1}}}}if(c.length>a.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(a,e,c,b){var h,f,i,g,d;g=$$(c);d=[];for(f=0,i=g.length;f<i;f++){h=g[f];d.push((function(j){var k;if(a!==j){Sprite.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}k=e?"arrow-up-gray":"arrow-down-gray";return Sprite.src(j.down("img"),"web",k)}})(h))}return d},add_sort_arrow_mouseover_j:function(a,e,c,b){var h,f,i,g,d;g=$j(c);d=[];for(f=0,i=g.length;f<i;f++){h=g[f];d.push((function(j){var k;if(a.attr("data-sort")!==$j(j).attr("data-sort")){Sprite.src($j(j).find("img")[0],"web","downtick-spacer");return $j(j).removeClass("bolded")}else{$j(j).addClass("bolded");if($j(j).hasClass("noarrow")){return}k=e?"arrow-up-gray":"arrow-down-gray";return Sprite.src($j(j).find("img")[0],"web",k)}})(h))}return d},one_line_fit:function(a){var c,b,d=this;c=$$(a);if(c.length<2){return}b=function(){var m,j,i,g,l,h,e,f,k;i=c[0];l=c[c.length-1];g=i.cumulativeOffset().top;h=l.cumulativeOffset().top;if(g!==h){m=parseInt(i.getStyle("font-size"),10);e=m-1;if(e<8){return}for(f=0,k=c.length;f<k;f++){j=c[f];j.style.fontSize=e+"px"}return b()}};return b()},dimensions_to_imagesize:function(e,a){var i,g,c,h,b,d,f;c=[["480x320",480,320],["640x480",640,480],["800x600",800,600],["1024x768",1024,768],["1280x960",1280,960],["1600x1200",1600,1200],["2048x1536",2048,1536]];for(d=0,f=c.length;d<f;d++){h=c[d];g=h[0];b=h[1];i=h[2];if(b>e||i>a){return g}}return c.last()[0]},timedelta:function(b,g){var f,d,a,c,e;d=b.getTime()-g.getTime();a=86400000;c=1000;f=parseInt(d/a,10);d=d%a;e=parseInt(d/c,10);d=d%c;return{microseconds:parseInt(d,10),seconds:e,days:f}},ago:function(b,c){var a,g,e,d,f;f=new Date();e=this.timedelta(f,b);if(e.days<2){d=e.seconds+e.days*86400;if(d<60){a=d;if(c){return ungettext("%d second","%d seconds",a).format(a)}else{return ungettext("%d sec","%d secs",a).format(a)}}else{if(d<3600){a=parseInt(d/60,10);if(c){return ungettext("%d minute","%d minutes",a).format(a)}else{return ungettext("%d min","%d mins",a).format(a)}}else{a=parseInt(d/3600,10);if(c){return ungettext("%d hour","%d hours",a).format(a)}else{return ungettext("%d hr","%d hrs",a).format(a)}}}}else{g=parseInt(e.days+Math.round(e.seconds/86400),10);if(g<30){return ungettext("%d day","%d days",g).format(g)}else{if(g<56){a=parseInt(g/7,10);return ungettext("%d week","%d weeks",a).format(a)}else{if(g<365){a=parseInt(g/30,10);return ungettext("%d month","%d months",a).format(a)}else{a=parseInt(g/365,10);return ungettext("%d year","%d years",a).format(a)}}}}},nice_list:function(b){var f,e,d,a,c;if(!b){return""}else{if(b.length===1){return b[0]}else{if(b.length===2){return _(Constants.TWO_ITEM_LIST).format({x:b[0],y:b[1]})}}}c=_(Constants.THREE_ITEM_LIST).split(/%\(x\)s|%\(y\)s|%\(z\)s/);assert(c.length===4,"bad item list format "+Constants.THREE_ITEM_LIST);e=c[0];d=c[1];a=c[2];f=c[3];return[e,b.slice(0,-1).join(d),a,b[b.length-1],f].join("")},list_em_snippet:function(c,b){var g,e,d,f,j,h;d="";b-=new Emstring("...").length;for(e=j=0,h=c.length;0<=h?j<h:j>h;e=0<=h?++j:--j){f=c[e];if(e!==0){f=", "+f}g=new Emstring(f).length;if(g>b){break}b-=g;d+=f}return{str:d,snipped:c.length-e}},center:function(b){var a;b=$(b);a=(document.viewport.getWidth()-b.getWidth())/2;return b.setStyle({left:Math.floor(a)+"px"})},start_of_day:function(a){var b;b=new Date();b.setTime(a.getTime());b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return b},to_iso8601_date:function(e,b,c){var a;if(b==null){b=false}if(c==null){c=false}if(b){a=e.getUTCFullYear().toString()+"-"+(e.getUTCMonth()+1).toString().lpad(2)+"-"+e.getUTCDate().toString().lpad(2);if(c){a+=" "+e.getUTCHours().toString().lpad(2)+":"+e.getUTCMinutes().toString().lpad(2)+":"+e.getUTCSeconds().toString().lpad(2)}}else{a=e.getFullYear().toString()+"-"+(e.getMonth()+1).toString().lpad(2)+"-"+e.getDate().toString().lpad(2);if(c){a+=" "+e.getHours().toString().lpad(2)+":"+e.getMinutes().toString().lpad(2)+":"+e.getSeconds().toString().lpad(2)}}return a},to_mysql_date:function(f,a,c){var b,g,e;b=f.getFullYear().toString()+"-"+(f.getMonth()+1).toString().lpad(2)+"-"+f.getDate().toString().lpad(2);e=f.getHours().toString().lpad(2)+":"+f.getMinutes().toString().lpad(2)+":"+f.getSeconds().toString().lpad(2);g="."+f.getMilliseconds().toString().lpad(3);if(!a){return b}if(!c){return b+" "+e}return b+" "+e+g},from_mysql_date:function(b){var d,f,c,h,a,g,e;h=b.split(" ");d=h[0];g=h.length>1?h[1]:false;f=d.split("-");assert(f.length===3,"weird date format on "+this+", expected yyyy-mm-dd");c=new Date(f[0],parseInt(f[1],10)-1,f[2]);if(g){e=g.split(":");assert(e.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");c.setHours(e[0]);c.setMinutes(e[1]);a=e[2].split(".");c.setSeconds(a[0]);if(a.length>1){c.setMilliseconds(a[1])}}return c},make_table:function(a,h){var c,g,i,b,e,d,f;i=new Element("table",h);b=new Element("tbody");i.__sert(b);for(g in a){f=a[g];d=new Element("tr");e=new Element("td").insert(g);c=new Element("td").insert(f);d.__sert(e);d.__sert(c);b.__sert(d)}return i},time:function(){return new Date().getTime()},url_hash:function(){var a;a=window.location.href;if(a.indexOf("#")>=0){return a.split("#").last()}else{return""}},validate_email:function(a){var b;b=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return b.test(a)},report_exception:global_report_exception,scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(c){var b,a;a=this.scried;b=a[c];if(!b){b=$(c);a[c]=b}return b},parentDir:function(b){var a;a=b.split("/").slice(0,-1).compact().join("/");return a||"/"},urlquote:function(a){return a.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var b,a;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(b=$("ieconsole"))!=null?b.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(a=console.log)!=null?a.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(d,c){var b;b=this.childElementWithIndex(d,c);return b[0]},childElementWithIndex:function(j,c){var f,h,d,b,g,a;f=0;b=j.childNodes;for(d=g=0,a=b.length;g<a;d=++g){h=b[d];if(h.nodeType===1&&f++===c){return[h,d]}}return[false,false]},disableSelection:function(a){a.onselectstart=function(){return false};a.unselectable="on";a.style.MozUserSelect="none";return a.style.cursor="default"},enableSelection:function(a){a.onselectstart=function(){return true};a.unselectable="off";a.style.MozUserSelect="";return a.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(a,h,f,e){var c,d,b,g;if(!f){f=function(i,j){return i-j}}c=a.length;d=0;while(c>d){b=Math.floor(c/2+d/2);g=f(a[b],h);if(g>0){c=b}else{if(g<0){d=b+1}else{return b}}}if(e){return d}else{return -1}},nonce:function(){var c,a,b;c=new Date();b=c.getTime().toString();a=Math.floor(Math.random()*1000000).toString().lpad(6);return b+a},focus:function(b){if(b){b=$(b);try{return b.focus()}catch(a){}}},focus_in_input:function(){var b,a,d,c;return((b=(a=document.activeElement)!=null?a.tagName:void 0)==="INPUT"||b==="TEXTAREA"||b==="SELECT")&&((d=(c=document.activeElement)!=null?c.type:void 0)!=="submit"&&d!=="button")},sumStyles:function(d,e){var a,c,f,b;c=0;if(d){for(f=0,b=e.length;f<b;f++){a=e[f];c+=parseInt(d.getStyle(a),10)||0}}return c},syncHeight:function(a){var b;if(a==null){a=".sync-height"}$$(a).invoke("setStyle",{height:"auto"});b=$$(a).invoke("getHeight").max();b-=this.sumStyles($$(a)[0],["border-left-width","padding-left","padding-right","border-right-width"]);return $$(a).invoke("setStyle",{height:b>0?""+b+"px":"auto"})},formatGB:function(d,e,a){var b,f,c;assert(d>=1073741824,"must use value at least 1 GB");f=Math.round(d/1073741824);b=e?" ":"";c=a?_("GB"):"";return f+b+c},formatBytes:function(e,d,g,c){var b,h,a,f;e=parseFloat(e);b=Math.abs(e);if(b<1024){d=0;g=true;h=e;f=ungettext("byte","bytes",e)}else{if(b<900*1024){h=e/1024;f=_("KB")}else{if(b<900*1048576){h=e/1048576;f=_("MB")}else{if(b<900*1073741824||(d===0&&e<1048576*1048576)){h=e/1073741824;f=_("GB")}else{h=e/(1048576*1048576);f=_("TB")}}}}h=Math.round(h*Math.pow(10,d))/parseFloat(Math.pow(10,d));h=h.toFixed(d);a=c&&d>0?h!==Math.floor(h)?h:parseInt(Math.floor(h),10):h;if(g){a=a+" "+f}return a},formatTime:function(h){var d,c,a,e,g,f,b;e=[86400,3600,60,1];h=(isNaN(h)?0:h);for(d=f=0,b=e.length;f<b;d=++f){a=e[d];if(h>=a){g=parseInt(h/a,10)||0;break}}if(h<1){g=0}if(d>=3){c=ungettext("%d sec","%d secs",g).format(g)}else{if(d===2){c=ungettext("%d min","%d mins",g).format(g)}else{if(d===1){c=ungettext("%d hour","%d hours",g).format(g)}else{if(d===0){c=ungettext("%d day","%d days",g).format(g)}else{assert(false,"Invalid time")}}}}return c},async_load_script:function(b){var a;a=function(){var d,c;c=document.createElement("script");c.src=b;c.type="text/javascript";c.async=true;d=document.getElementsByTagName("script")[0];return d.parentNode.insertBefore(c,d)};if(document.readyState==="complete"){return a()}else{if(window.attachEvent!=null){return window.attachEvent("onload",a)}else{return window.addEventListener("load",a,false)}}},async_load_css:function(b,a){return new Ajax.DBRequest(b,{method:"get",onSuccess:function(c){$j("head").append("<style>"+c.responseText+"</style>");if(a){return a()}}})},async_load_js:function(c,d){var a,b;b=document.createElement("script");b.src=c;b.type="text/javascript";b.onload=d;b.onreadystatechange=function(){if(_this.readyState==="complete"){return typeof d==="function"?d():void 0}};a=document.getElementsByTagName("head")[0];return a.appendChild(b)},async_multiload:function(a,c,e){var b,d;d={};if(!a){if(typeof e==="function"){e()}return}a.each(function(f){return d[f]=false});b=function(h,j){var g,f,i;j[h]=true;f=true;for(g in j){i=j[g];if(!i){f=false;break}}if(f){return typeof e==="function"?e():void 0}};return a.each(function(f){return c(f,b.curry(f,d))})},async_multiload_css:function(a,b){return Util.async_multiload(a,Util.async_load_css,b)},async_multiload_js:function(a,b){return Util.async_multiload(a,Util.async_load_js,b)},async_multiload_static:function(b,d,e){var a,c;c={css:!b,js:!d};a=function(f,j){var h,g,i;j[f]=true;g=true;for(h in j){i=j[h];if(!i){g=false;break}}if(g){return typeof e==="function"?e():void 0}};Util.async_multiload(b,Util.async_load_css,a.curry("css",c));return Util.async_multiload(d,Util.async_load_js,a.curry("js",c))},smartLoad:function(a){if(document.loaded){return a.defer()}else{return document.observe("dom:loaded",a)}},smart_window_load:function(a){if(document.readyState==="complete"){return a.defer()}else{return Event.observe(window,"load",a)}},niceDate:function(a){if(a==null){a=new Date()}return""+(1+a.getMonth())+"-"+(a.getDate())+"-"+(a.getFullYear())},reverseNiceDate:function(a){var b;if(!a){return false}b=a.split("/");if(b.length!==3){return false}return new Date(parseInt(b[2],10),parseInt(b[0],10)-1,parseInt(b[1],10))},niceDateWithMonthName:function(e,c,h,a){var d,g,b,f;if(h==null){h=false}if(a==null){a=false}if(h){d=e.getUTCDate();g=e.getUTCMonth();f=e.getUTCFullYear()}else{d=e.getDate();g=e.getMonth();f=e.getFullYear()}b=this.month_name(g,!a);if(c){return _("%(month)s %(date)s, %(year)s").format({month:b,date:d,year:f})}else{return _("%(month)s %(date)s").format({month:b,date:d})}},monthAbrWithYear:function(b,a){return _("%(month)s %(year)s").format({month:this.month_name(b,true),year:a})},incrementDate:function(c,d,e,b,a,f){if(d==null){d=0}if(e==null){e=0}if(b==null){b=0}if(a==null){a=0}if(f==null){f=0}c.setFullYear(c.getFullYear()+d);c.setMonth(c.getMonth()+e);c.setDate(c.getDate()+b);c.setHours(c.getHours()+a);c.setMinutes(c.getMinutes()+f);return c},isNumber:function(a){return !isNaN(Number(a,10))},shorten_url:function(a,b){return new Ajax.DBRequest("/shorten_url",{parameters:{url:a},onSuccess:function(c){return b(c.responseText)}})},flash_version:function(){return""+FlashDetect.major+"."+FlashDetect.revision},falsy_to_empty:function(a){return a||""},seconds_to_time:function(c,b){var a;if(b==null){b=false}c=parseInt(c,10);if(c>60){a=parseInt(c/60,10);c=c%60}else{a=0}a=a.toString();c=c.toString().lpad(2,"0");if(!b){a=a.lpad(2,"0")}return""+a+":"+c},add_script:function(b){var a;a=document.createElement("script");a.setAttribute("type","text/javascript");a.setAttribute("src",b);return document.getElementsByTagName("head")[0].appendChild(a)},preloaded_images:{},preload_image:function(d,c,b){var a;if(this.preloaded_images[d]){return}a=new Image();if(c!=null){Element.extend(a).observe("error",c)}if(b!=null){Element.extend(a).observe("load",b)}a.src=d;return this.preloaded_images[d]=a},get_preloaded_image:function(a){if(this.preloaded_images[a]){return this.preloaded_images[a].clone()}else{return new Element("img",{src:a})}},preloaded_audio:{},preload_audio:function(b,a){var c;if(this.preloaded_audio[b]){return}c=new Element("audio",{src:b});if(a!=null){Element.extend(c).observe("error",a)}return this.preloaded_audio[b]=c},get_preloaded_audio:function(a){var b;if(this.preloaded_audio[a]){return this.preloaded_audio[a]}else{b=new Element("audio",{src:a});this.preloaded_audio[a]=b;return b}},clipboard_copy_done:function(){Notify.server_success(_("Link copied to clipboard!"));return Modal.hide()},addCopyUrlFlash:function(b,c){var a;if(c==null){c="real_copy"}a=Util.copy_to_clipboard_swf(b,c,"Util.clipboard_copy_done");return $j("#"+a).parent().css("zIndex","1001")},copy_to_clipboard_swf:function(g,f,i,k,c,e){var a,j,b,d,h=this;if(e==null){e="absolute"}d={wmode:"transparent",scale:"exactfit",allowScriptAccess:"always"};a=new Element("div",{id:"flash_copy_container"});if(c){a.writeAttribute(c)}j=new Element("div");a.update(j);k=$(k)||document.body;k.appendChild(a);b=j.identify();window.copyLoaded=function(){var l;l=$(b);l.setCopyText(g);return l.setCallbackFunction(i)};swfobject.embedSWF(Constants.static_url_copy_clipboard_swf,b,"100%","100%","6.0.65",false,false,d);a.style.position=e;a.style.zIndex=1;$j(a).clonePosition($j("#"+f),{offsetTop:-3,offsetLeft:-3,offsetHeight:6,offsetWidth:6});this.freshbutton_overlay(a,$(f));return b},inner_height:function(g){var c,d,f,b,e,a;g=$(g);assert(g,"inner_height missing elm");c=g.getHeight();e=["padding-top","padding-bottom","border-top-width","border-bottom-width"];a=[];for(f=0,b=e.length;f<b;f++){d=e[f];a.push(c-=parseInt(g.getStyle(d),10))}return a},encode_b64:function(j){var p,e,o,g,n,m,l,k,h,d,c,b,a,f;e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";d=void 0;c=void 0;b=void 0;n=void 0;m=void 0;l=void 0;k=void 0;o=void 0;h=0;p=0;g="";f=[];if(!j){return j}while(true){d=j.charCodeAt(h++);c=j.charCodeAt(h++);b=j.charCodeAt(h++);o=d<<16|c<<8|b;n=o>>18&63;m=o>>12&63;l=o>>6&63;k=o&63;f[p++]=e.charAt(n)+e.charAt(m)+e.charAt(l)+e.charAt(k);if(!(h<j.length)){break}}g=f.join("");a=j.length%3;return(a?g.slice(0,a-3):g)+"===".slice(a||3)},decode_b64:function(k,m){var r,d,q,f,j,p,o,n,l,h,e,c,b,a,g;e=function(i){return i};j=m?e:this.utf8_decode;if(typeof window.atob==="function"){return j(window.atob(k))}d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";h=0;r=0;g=[];if(!k){return k}k+="";while(true){p=d.indexOf(k.charAt(h++));o=d.indexOf(k.charAt(h++));n=d.indexOf(k.charAt(h++));l=d.indexOf(k.charAt(h++));q=p<<18|o<<12|n<<6|l;c=q>>16&255;b=q>>8&255;a=q&255;if(n===64){g[r++]=String.fromCharCode(c)}else{if(l===64){g[r++]=String.fromCharCode(c,b)}else{g[r++]=String.fromCharCode(c,b,a)}}if(!(h<k.length)){break}}f=g.join("");f=j(f);return f},utf8_decode:function(a){var g,f,e,c,d,b;b=[];d=0;g=0;f=0;e=0;c=0;a+="";while(d<a.length){f=a.charCodeAt(d);if(f<128){b[g++]=String.fromCharCode(f);d++}else{if((f>191)&&(f<224)){e=a.charCodeAt(d+1);b[g++]=String.fromCharCode(((f&31)<<6)|(e&63));d+=2}else{e=a.charCodeAt(d+1);c=a.charCodeAt(d+2);b[g++]=String.fromCharCode(((f&15)<<12)|((e&63)<<6)|(c&63));d+=3}}}return b.join("")},utf8_encode:function(a){var h,f,g,e,d,b,i,c,j;if(a===null||typeof a==="undefined"){return""}i=a+"";j="";b=void 0;e=void 0;c=0;b=e=0;c=i.length;d=0;while(d<c){h=i.charCodeAt(d);g=null;if(h<128){e++}else{if(h>127&&h<2048){g=String.fromCharCode((h>>6)|192,(h&63)|128)}else{if(h&63488!==55296){g=String.fromCharCode((h>>12)|224,((h>>6)&63)|128,(h&63)|128)}else{if(h&64512!==55296){throw new RangeError("Unmatched trail surrogate at "+d)}f=i.charCodeAt(++d);if(f&64512!==56320){throw new RangeError("Unmatched lead surrogate at "+(d-1))}h=((h&1023)<<10)+(f&1023)+65536;g=String.fromCharCode((h>>18)|240,((h>>12)&63)|128,((h>>6)&63)|128,(h&63)|128)}}}if(g!==null){if(e>b){j+=i.slice(b,e)}j+=g;b=e=d+1}d++}if(e>b){j+=i.slice(b,c)}return j},clear_selected:function(){var a;if(window.getSelection){a=window.getSelection();if(a.removeAllRanges){return a.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},select_text:function(a){var b,c,d;d=$j(a)[0];if(document.body.createTextRange){b=document.body.createTextRange();b.moveToElementText(d);return b.select()}else{if(window.getSelection){c=window.getSelection();b=document.createRange();b.selectNodeContents(d);c.removeAllRanges();return c.addRange(b)}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(a){var c,b;c=20;b=this.viewport_dimensions();return a>b.width-c},freshbutton_overlay:function(b,a){var d,c,e=this;c=b instanceof jQuery&&b||$j(b);d=a instanceof jQuery&&a||$j(a);c.on("mouseover",function(){return d.addClass("hovered")});c.on("mouseout",function(){d.removeClass("hovered");return d.removeClass("pressed")});c.on("mousedown",function(){d.removeClass("hovered");return d.addClass("pressed")});return c.on("mouseup",function(){return d.removeClass("pressed")})},isElm:function(a){if(typeof HTMLElement==="object"){return a instanceof HTMLElement}else{return a&&typeof a==="object"&&a.nodeType===1&&typeof a.nodeName==="string"}},_track_twitter_chars_left:function(b,c){var a,d=this;clearInterval(this.chars_left_interval);a=function(){var e,f;e=$("twitter-chars");f=c-$F(b).strip().length;if(f<0){e.addClassName("too-long")}else{e.removeClassName("too-long")}return e.__date(f)};return this.chars_left_interval=setInterval(a,250)},session_storage_set:function(a,b){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(a,JSON.stringify(b))},session_storage_get:function(a){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(a))}},pdf_plugins:function(){var c,b,a;a=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return c=(function(){var g,e,f,d;f=window.navigator.plugins;d=[];for(g=0,e=f.length;g<e;g++){b=f[g];if(a.test(b.name)){d.push(b)}}return d})()},get_window_location:function(){return window.location}};Util.scrollLeft=Util.scrollLeft.cached(50);Util.scrollTop=Util.scrollTop.cached(50);UIButton=(function(){a.prototype.selector=function(){return".ui-button"};a.prototype.over=function(b,c){return c.addClassName("over")};a.prototype.out=function(b,c){return c.removeClassName("over")};a.prototype.down=function(b,c){return c.addClassName("down")};a.prototype.up=function(b){return $$(this.selector()+".down").invoke("removeClassName","down")};function a(){this.clear=__bind(this.clear,this);this.up=__bind(this.up,this);this.listen()}a.prototype.active=function(b,c){return c.toggleClassName("active")};a.prototype.clear=function(h){var b,j,i,f,d,k,g,c;i=$(h.target);b=this.selector()+".active";f=i.match(b)&&i||i.up(b);g=$$(b);c=[];for(d=0,k=g.length;d<k;d++){j=g[d];if(f!==j){c.push(j.removeClassName("active"))}else{c.push(void 0)}}return c};a.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return a})();if(typeof console==="undefined"||console===null){console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var c,e,b,d,a;new UIButton();if(Util.ie8){d=$$("#page-header a, #page-footer a");a=[];for(e=0,b=d.length;e<b;e++){c=d[e];if(c.target==="_blank"){a.push(c.target="")}else{a.push(void 0)}}return a}});Util.smart_window_load(function(){return Util.syncHeight()});Trace=(function(){var a;a=[];return{log:function(){var b;b=Util.time()+": "+$A(arguments).join(" ");return a.push(b)},get:function(){return a.join("\n")}}})();T=function(){return Trace.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var a;T("dom:loaded");a=function(){var b,c;b=$("page-content");if(b){c=Util.viewport_dimensions();if(c.width<b.getWidth()){return $(document.body).addClassName("absolutize")}else{return $(document.body).removeClassName("absolutize")}}};Event.observe(window,"resize",a);return a()});Event.observe(window,"load",function(){return T("window:load")});URLUtil={absolutize:function(a){if(a.startsWith("https://")||a.startsWith("http://")){return a}else{if(a.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+a}else{return assert(0,"absolutize is confused by "+a)}}}};Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var a,b;if(!(this.old_y!=null)){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:Util.scroll_offsets().top;return}if(!(this.max_delta_y!=null)){this.max_delta_y=0;return}b=this.scroll_container!=null?this.scroll_container.scrollTop:Util.scroll_offsets().top;a=Math.abs(this.max_delta_y)<Math.abs(b-this.old_y);if(a){this.max_delta_y=b-this.old_y;return this.old_y=b}},start_capture:function(a){this.scroll_container=a;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(a){if(a==null){a=false}assert(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(a){return this.last_nonzero_velocity}return this.velocity}};"The following is a smashed version of a array and a dictionary that enables us\nto have a dictionary mapping that is sorted.";var OrderedDictionary;OrderedDictionary=(function(){a.list=[];a.dict={};function a(b,c){this.list=b;this.dict=c;return}a.prototype.push=function(b,c){this.list.push(b);this.dict[b]=c};a.prototype.remove=function(b){this.list.removeItem(b);delete this.dict[b]};a.prototype.indexOfKey=function(b){return this.list.indexOf(b)};a.prototype.keyAtIndex=function(b){return this.list[b]};a.prototype.valueFromKey=function(b){return this.dict[b]};a.prototype.valueAtIndex=function(b){return this.dict[this.list[b]]};a.prototype.getValues=function(){var b;return(function(){var f,d,e,c;e=this.list;c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push(this.dict[b])}return c}).call(this)};a.prototype.length=function(){return this.list.length};a.prototype.insertAtIndex=function(b,c,d){this.list.splice(b,0,c);return this.dict[c]=d};return a})();var DomUtil;DomUtil={fromElm:function(a){return $(a).innerHTML},updateFromElm:function(b,a){b=$(b);a=$(a);return b.update(this.fromElm(a))},fillVal:function(h,e){var b,g,d,f,a,c;f=$$("."+e);c=[];for(g=0,d=f.length;g<d;g++){b=f[g];b=$(b);if(b.tagName==="INPUT"){b.value=h;c.push(b.defaultValue=h)}else{if(b.innerHTML===""&&((a=b.tagName)==="A"||a==="B"||a==="INPUT"||a==="I"||a==="LABEL"||a==="SELECT"||a==="SPAN"||a==="TEXTAREA")){Util.log("Filling an empty value; this may look broken in IE7",b)}c.push(b.innerHTML=h)}}return c},copy_to_clipboard:function(i,f,j){var d,c,a,b,g;d=$("hold_clipboard");d.value=i;if(d.createTextRange){g=d.createTextRange();if(g&&(!(typeof BodyLoaded!=="undefined"&&BodyLoaded!==null)||BodyLoaded===1)){try{return g.execCommand("Copy")}catch(h){j=j||_("Please copy the text below:");f=f||_("Copy text");this.fillVal(i,"text-to-copy");this.fillVal(j,"copy-modal-body");Modal.show(f,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){a=document.createElement("div");a.id="flashcb";document.body.appendChild(a)}$("flashcb").innerHTML="";c=encodeURIComponent(d.value);b='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=b}}};var VideoUtil;VideoUtil={_video_counter:0,embed:function(g,j){var b,h,d,a,c,e,i,f;if(j==null){j={}}if(typeof _V_!=="undefined"&&_V_!==null){_V_.options.flash.swf=Constants.static_url_video_js_swf}if(j.preload===void 0){j.preload="auto"}b="video-"+this._video_counter;this._video_counter+=1;c=$j("<video/>",{"class":"video-js vjs-default-skin",id:b,controls:j.controls});c=c[0];f=["width","height","preload","poster","autoplay"];for(e=0,i=f.length;e<i;e++){d=f[e];if(j[d]){c.setAttribute(d,j[d])}}a=$j("<source/>",{src:j.src,type:j.type});a=a[0];c.appendChild(a);if(typeof g==="string"){g=$j(g)[0]}g.innerHTML="";g.appendChild(c);h=function(){var l,k;k=this;if(j.onError){this.addEvent("error",j.onError)}if(typeof j.onReady==="function"){j.onReady()}l=function(){return $j("#truncated-video-message-bar").text(_("The clip displayed here is a preview. To view the entire video, download or add it to your Dropbox.")).css("display","inherit")};if(!j.metadata&&j.metadata_link){return $j.ajax(j.metadata_link,{data:{},type:"GET",noDropboxDefaults:true,xhrFields:{withCredentials:true},success:function(m){var n;n=JSON.parse(m);if(typeof j.metadata_cb==="function"){j.metadata_cb(n)}if(n.is_truncated){return l.defer()}}})}else{if(j.metadata&&j.metadata.is_truncated){return l.defer()}}};return _V_(c,{},h)},embed_help_video:function(d,j,h){var i,c,b,f,e,g=this;b=function(l,k,m,a){return g.embed($(l)({src:d,width:k,height:a,type:"video/mp4",autoplay:m,preload:true}))};if(h){f=new Element("img",{src:h});i=new Element("a",{href:"#",style:"position: relative; display: block;"});e=new Element("img",{src:"/static/images/help_play.png"});e.addClassName("overlay_play");i.appendChild(f);i.appendChild(e);c=new Element("div");i.observe("click",function(m){var l,a,k;c.__date();Event.stop(m);Modal.show("",c,false,false,860);k=800;l=true;a=600;b(c,k,l,a);return $("modal-title").hide()});return $(j).__date(i)}else{return b(j)}}};var _ref;if((_ref=window.Util)==null){window.Util={}}Util.binarySearch=function(g,f,e,b){var d,c,a;e=Util.constrainIndex(e,0,g.length);b=Util.constrainIndex(b,g.length,g.length)-1;while(e<=b){c=(e+b)>>>1;d=g[c];a=f.call(d,c,d,g);if(a===0){return c}if(a>0){b=c-1}else{e=c+1}}return ~e};Util.constrainIndex=function(a,c,b){if(a==null){a=c}if(a<0){a+=b;if(a<0){a=0}}else{if(a>b){a=b}}return a};Util.thumb_load=function(a,c){var b;a=$j(a);b=a.data("src");if(b){a.removeData("src");a.error(function(){return a.attr("src",a.data("fail-src")||Sprite.SPACER)});a.load(function(){return typeof c==="function"?c(a[0]):void 0});a.attr("src",b)}};Util.string_hash=function(f){var g,e,b,d,a;e=0;if(f.length===0){return}for(b=d=0,a=f.length;0<=a?d<a:d>a;b=0<=a?++d:--d){g=f.charCodeAt(b);e=((e<<5)-e)+g;e=e&e}return e};Util.month_names=[_("January"),_("February"),_("March"),_("April"),_("May"),_("June"),_("July"),_("August"),_("September"),_("October"),_("November"),_("December")];Util.abbr_month_names=[_("Jan"),_("Feb"),_("Mar"),_("Apr"),_("May"),_("Jun"),_("Jul"),_("Aug"),_("Sep"),_("Oct"),_("Nov"),_("Dec")];Util.month_name=function(b,a){if(a){return this.abbr_month_names[b]}else{return this.month_names[b]}};Util.normalize=function(a){if(!a){return""}if(a.charAt(0)!=="/"){a="/"+a}if(a.charAt(a.length-1)==="/"){return a.substr(0,a.length-1)}else{return a}};Util.filename=function(c,b){var a;if(b==null){b=_("Dropbox")}c=Util.normalize(c);c=c.split("/");a=c.pop();if(a===""){return b}else{return a}};Util.file_extension=function(a){return a.split(".").pop()};Util.filename_to_icon=function(a){var b,c;c=Util.file_extension(a).toLowerCase();b={_other:"page_white",log:"page_white",msg:"page_white",sln:"page_white",vcproj:"page_white",txt:"page_white_text",wps:"page_white_text",doc:"page_white_word",docx:"page_white_word",rtf:"page_white_word",pages:"page_white_word",wpd:"page_white_word",odt:"page_white_word",pdf:"page_white_acrobat",xls:"page_white_excel",xlsm:"page_white_excel",xlsx:"page_white_excel",xlsb:"page_white_excel",ods:"page_white_excel",ppt:"page_white_powerpoint",pptx:"page_white_powerpoint",pps:"page_white_powerpoint",ppsx:"page_white_powerpoint",odp:"page_white_powerpoint",css:"page_white_code",html:"page_white_code",htm:"page_white_code",xml:"page_white_code",php:"page_white_code",c:"page_white_code",h:"page_white_code",rb:"page_white_code",cpp:"page_white_code",java:"page_white_code",js:"page_white_code",json:"page_white_code",cs:"page_white_code",py:"page_white_code",exe:"page_white_gear",dll:"page_white_gear",app:"page_white_gear",mp3:"page_white_sound",m3u:"page_white_sound",wav:"page_white_sound",m4a:"page_white_sound",wma:"page_white_sound",aif:"page_white_sound",iff:"page_white_sound",mid:"page_white_sound",mpa:"page_white_sound",ra:"page_white_sound",aiff:"page_white_sound",amr:"page_white_sound",ogg:"page_white_sound",gif:"page_white_picture",png:"page_white_picture",jpg:"page_white_picture",jpeg:"page_white_picture",tiff:"page_white_picture",tif:"page_white_picture",bmp:"page_white_picture",odg:"page_white_picture",ari:"page_white_picture",arw:"page_white_picture",srf:"page_white_picture",sr2:"page_white_picture",bay:"page_white_picture",crw:"page_white_picture",cr2:"page_white_picture",cap:"page_white_picture",eip:"page_white_picture",dcs:"page_white_picture",dcr:"page_white_picture",drf:"page_white_picture",k25:"page_white_picture",kdc:"page_white_picture",dng:"page_white_picture",erf:"page_white_picture",fff:"page_white_picture",iiq:"page_white_picture",mef:"page_white_picture",mos:"page_white_picture",mrw:"page_white_picture",nef:"page_white_picture",nrw:"page_white_picture",orf:"page_white_picture",pef:"page_white_picture",ptx:"page_white_picture",pxn:"page_white_picture",r3d:"page_white_picture",raf:"page_white_picture",rw2:"page_white_picture",raw:"page_white_picture",rwl:"page_white_picture",rwz:"page_white_picture",obm:"page_white_picture",srw:"page_white_picture",x3f:"page_white_picture",avi:"page_white_film",mov:"page_white_film",mp4:"page_white_film",mkv:"page_white_film",wmv:"page_white_film",mpg:"page_white_film",m4v:"page_white_film",vob:"page_white_film",ogv:"page_white_film",gz:"page_white_compressed",tar:"page_white_compressed",rar:"page_white_compressed",zip:"page_white_compressed",tgz:"page_white_compressed",bz2:"page_white_compressed",iso:"page_white_dvd",dmg:"page_white_dvd",ai:"ai",psd:"page_white_paint",au:"page_white_sound",fla:"fla",swf:"fla"};return b[c]||"page_white"};Util.remove_qstring=function(a,c){var j,i,b,d,e,f,h,g;c=c+"=";f=a.indexOf("#");i="";if(f!==-1){g=a.slice(0,f);i=a.slice(f)}else{g=a}h=g.indexOf("?");if(h!==-1){e=[g.slice(0,h),g.slice(h+1)];d=e[1].split("&");j=(function(){var m,l,k;k=[];for(m=0,l=d.length;m<l;m++){b=d[m];if(b.indexOf(c)!==0){k.push(b)}}return k})();if(j.length===0){return e[0]+i}else{return e[0]+"?"+j.join("&")+i}}else{return a}};Util.append_ellipsis=function(a){return _("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:a})};Util.role_title_for_user=function(a){if(!viewer.is_paired){return""}else{if(a.role===Constants.ROLE_PERSONAL){return _("Personal")}else{return viewer.team_name}}};var CreditCardUtil,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};CreditCardUtil={setCreditCardInfoMap:function(a){this._creditCardInfoMap=a},getAllTypes:function(){var a,b;return(function(){var d,c;d=this._creditCardInfoMap;c=[];for(b in d){a=d[b];c.push(b)}return c}).call(this)},getValidCardTypesForCountryCode:function(c){var a,e,b,d;b=[];d=this._creditCardInfoMap;for(e in d){a=d[e];if(__indexOf.call(a.accepted_countries,"all")>=0||__indexOf.call(a.accepted_countries,c)>=0){b.push(e)}}return b},isValidCardTypeForCountryCode:function(a,b){return __indexOf.call(this.getValidCardTypesForCountryCode(b),a)>=0},getNameForType:function(a){return this._creditCardInfoMap[a]["name"]}};var RequestWatcher;RequestWatcher={reqs:[],working_msg:_("Still working..."),TIMEOUT:10,watch:function(b,c){var a;a=this.reqs;if(!a.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(c){b.skip_message=true}return a.push([b,Util.time()])},check_up:function(){return this.scan(false)},remove:function(a){return this.scan(a)},scan:function(f){var j,b,d,a,h,g,c,i,e;b=Util.time();d=[];e=this.reqs;for(c=0,i=e.length;c<i;c++){a=e[c];h=a[0];g=a[1];j=b-g;if(h.transport.readyState===4){Notify.clear_if(this.working_msg);continue}if(j>4000&&!h.skip_message){h.skip_message=true;if(Notify.is_shown()&&!Notify.preserve_last_msg){Notify.server_success(this.working_msg)}}if(j>this.TIMEOUT*1000&&h.job){h.transport.abort()}if(h!==f){d.push([h,g])}else{h.transport.abort()}}this.reqs=d;if(!d.length){return clearInterval(this.int_id)}}};var Emstring;Emstring=(function(){function a(b){this.s=b;this.info=this.widthInfo();this.length=b.length?this.info[this.s.length-1]:0}a.prototype.widthInfo=function(){var b,c,e,d;c={};c[-1]=0;for(b=e=0,d=this.s.length;0<=d?e<d:e>d;b=0<=d?++e:--e){c[b]=c[b-1]+this.ems(this.s.charAt(b))}return c};a.prototype.findSpot=function(c){var f,g,b,d;if(!c){return 0}d=0;g=this.s.length;while(d<=g){b=Math.floor(d/2+g/2);f=this.info[b-1];if(f>c){g=b-1}else{if(f<c){d=b+1}else{return b}}}if(d>b){return d}else{return b}};a.prototype.ems=function(h){var d,b,g,f,e;b=0.65;d=1.08;g=0.58;f=h.charCodeAt(0);e=a.CODEPOINT_TO_WIDTH[f];if(e){return e/Math.pow(10,a.ACCURACY)}if((768<=f&&f<=879)){return 0}if((65377<=f&&f<=65500)){return g}if(((11904<=f&&f<=40911))||((44032<=f&&f<=55215))||((4352<=f&&f<=4607))||((63744<=f&&f<=64255))||((65280<=f&&f<=65535))||((131072<=f&&f<=196607))){return d}return b};a.prototype.substr=function(e,b){var c,d;d=this.findSpot(e);if(b!=null){c=this.findSpot(e+b);return new a(this.s.substr(d,c-d))}else{return new a(this.s.substr(d))}};a.prototype.toString=function(){return this.s};a.prototype.snippet=function(d,c){var e,f,h,b,g;if(d==null){d=50}if(c==null){c=0.75}if(this.length<=d){return this}d=d-a._ELLIPSIS_LENGTH;e=d*c;b=d-e;g=this.length-b;h=this.substr(0,e);f=this.substr(g);return new a(h.toString()+"\u2026"+f.toString())};return a})();Emstring.ACCURACY=2;Emstring.CODEPOINT_TO_WIDTH={32:38,33:25,34:42,35:67,36:58,37:92,38:75,39:25,40:33,41:33,42:58,43:58,44:25,45:33,46:25,47:42,48:58,49:58,50:58,51:58,52:58,53:58,54:58,55:58,56:58,57:58,58:25,59:25,60:58,61:58,62:58,63:50,64:100,65:67,66:67,67:67,68:75,69:58,70:58,71:75,72:83,73:33,74:25,75:67,76:58,77:100,78:83,79:83,80:67,81:83,82:67,83:58,84:58,85:75,86:67,87:100,88:67,89:58,90:58,91:33,92:42,93:33,94:58,95:50,96:67,97:58,98:67,99:50,100:67,101:58,102:33,103:58,104:67,105:25,106:25,107:58,108:25,109:100,110:67,111:67,112:67,113:67,114:42,115:50,116:42,117:67,118:58,119:83,120:58,121:58,122:50,123:42,124:58,125:42,126:58,161:25,162:58,163:58,164:58,165:58,166:58,167:58,168:67,169:92,170:42,171:50,172:58,174:92,175:58,176:50,177:58,178:42,179:42,180:67,181:67,182:75,183:25,184:25,185:42,186:42,187:50,188:83,189:83,190:83,191:50,192:67,193:67,194:67,195:67,196:67,197:67,198:92,199:67,200:58,201:58,202:58,203:58,204:33,205:33,206:33,207:33,208:75,209:83,210:83,211:83,212:83,213:83,214:83,215:58,216:83,217:75,218:75,219:75,220:75,221:58,222:67,223:67,224:58,225:58,226:58,227:58,228:58,229:58,230:92,231:50,232:58,233:58,234:58,235:58,236:25,237:25,238:25,239:25,240:67,241:67,242:67,243:67,244:67,245:67,246:67,247:58,248:67,249:67,250:67,251:67,252:67,253:58,254:67,255:58,256:75,257:67,258:75,259:67,260:75,261:67,262:75,263:58,264:75,265:58,266:75,267:58,268:75,269:58,270:83,271:83,272:83,273:75,274:67,275:67,276:67,277:67,278:67,279:67,280:67,281:67,282:67,283:67,284:83,285:75,286:83,287:75,288:83,289:75,290:83,291:75,292:83,293:75,294:92,295:75,296:33,297:33,298:33,299:33,300:33,301:33,302:33,303:33,304:33,305:25,306:67,307:67,308:42,309:33,310:75,311:67,312:67,313:58,314:33,315:58,316:33,317:58,318:42,319:58,320:50,321:67,322:42,323:83,324:75,325:83,326:75,327:83,328:75,329:83,330:83,331:75,332:92,333:67,334:92,335:67,336:92,337:67,338:100,339:100,340:75,341:50,342:75,343:50,344:75,345:50,346:67,347:58,348:67,349:58,350:67,351:58,352:67,353:58,354:75,355:42,356:75,357:42,358:75,359:42,360:83,361:75,362:83,363:75,364:83,365:75,366:83,367:75,368:83,369:75,370:83,371:75,372:100,373:92,374:75,375:58,376:75,377:67,378:67,379:67,380:67,381:67,382:67,383:42,384:75,385:83,386:67,387:75,388:75,389:67,390:75,391:83,392:58,393:83,394:100,395:67,396:75,397:67,398:67,399:75,400:58,401:58,402:75,403:83,404:75,405:100,406:50,407:50,408:75,409:67,410:50,411:67,412:117,413:83,414:75,415:92,416:92,417:75,418:117,419:100,420:75,421:75,422:75,423:67,424:58,425:67,426:58,427:42,428:75,429:42,430:75,431:83,432:75,433:92,434:83,435:75,436:75,437:67,438:67,439:67,440:67,441:58,442:58,443:75,444:75,445:58,446:50,447:67,448:33,449:50,450:50,451:33,452:142,453:142,454:133,455:100,456:92,457:67,458:117,459:117,460:100,461:75,462:67,463:33,464:33,465:92,466:67,467:83,468:75,469:83,470:75,471:83,472:75,473:83,474:75,475:83,476:75,477:67,478:75,479:67,480:75,481:67,482:100,483:100,484:92,485:75,486:83,487:75,488:75,489:67,490:92,491:67,492:92,493:67,494:67,495:58,496:33,497:142,498:142,499:133,500:83,501:75,502:117,503:67,504:83,505:75,506:75,507:67,508:100,509:100,510:92,511:67,512:75,513:67,514:75,515:67,516:67,517:67,518:67,519:67,520:33,521:33,522:33,523:33,524:92,525:67,526:92,527:67,528:75,529:50,530:75,531:50,532:83,533:75,534:83,535:75,536:67,537:58,538:75,539:42,540:58,541:58,542:83,543:75,544:83,545:100,546:92,547:67,548:67,549:67,550:75,551:67,552:67,553:67,554:92,555:67,556:92,557:67,558:92,559:67,560:92,561:67,562:75,563:58,564:67,565:100,566:67,567:33,568:100,569:100,570:75,571:75,572:58,573:58,574:67,575:58,576:58,577:67,578:50,579:75,580:75,581:75,582:75,583:58,584:58,585:25,586:83,587:58,588:75,589:33,590:75,591:58,880:67,881:50,882:67,883:50,884:33,885:33,886:75,887:67,888:108,889:108,890:67,891:58,892:58,893:58,894:42,895:108,896:108,897:108,898:108,899:108,900:67,901:67,902:75,903:42,904:83,905:100,906:58,907:108,908:100,909:108,910:100,911:100,912:42,913:75,914:67,915:58,916:83,917:67,918:67,919:83,920:92,921:33,922:75,923:75,924:100,925:83,926:75,927:92,928:83,929:67,930:108,931:67,932:75,933:75,934:83,935:75,936:83,937:92,938:33,939:75,940:83,941:58,942:75,943:42,944:67,945:83,946:67,947:67,948:67,949:58,950:75,951:75,952:67,953:42,954:67,955:67,956:75,957:67,958:67,959:67,960:92,961:67,962:67,963:75,964:67,965:67,966:92,967:67,968:92,969:100,970:42,971:67,972:67,973:67,974:100,975:108,976:58,977:75,978:75,979:100,980:75,981:92,982:100,983:67,984:92,985:67,986:75,987:58,988:58,989:58,990:67,991:58,992:75,993:92,994:100,995:92,996:75,997:58,998:75,999:58,1000:75,1001:75,1002:67,1003:67,1004:83,1005:58,1006:50,1007:42,1008:67,1009:67,1010:58,1011:33,1012:92,1013:58,1014:58,1015:67,1016:67,1017:75,1018:100,1019:83,1020:58,1021:75,1022:75,1023:75,1024:67,1025:67,1026:92,1027:58,1028:75,1029:67,1030:33,1031:33,1032:42,1033:108,1034:108,1035:83,1036:75,1037:83,1038:75,1039:83,1040:75,1041:67,1042:67,1043:58,1044:83,1045:67,1046:92,1047:67,1048:83,1049:83,1050:75,1051:83,1052:100,1053:83,1054:92,1055:83,1056:67,1057:75,1058:75,1059:75,1060:83,1061:75,1062:83,1063:75,1064:108,1065:108,1066:75,1067:92,1068:67,1069:75,1070:108,1071:75,1072:67,1073:67,1074:58,1075:58,1076:75,1077:67,1078:83,1079:58,1080:75,1081:75,1082:67,1083:67,1084:83,1085:75,1086:67,1087:75,1088:75,1089:58,1090:58,1091:58,1092:92,1093:67,1094:75,1095:58,1096:92,1097:100,1098:67,1099:83,1100:58,1101:58,1102:92,1103:58,1104:67,1105:67,1106:75,1107:58,1108:58,1109:58,1110:33,1111:33,1112:42,1113:92,1114:92,1115:75,1116:67,1117:75,1118:58,1119:75,1120:100,1121:75,1122:75,1123:67,1124:83,1125:83,1126:75,1127:67,1128:100,1129:92,1130:92,1131:83,1132:117,1133:108,1134:67,1135:67,1136:83,1137:83,1138:92,1139:67,1140:83,1141:67,1142:83,1143:67,1144:133,1145:125,1146:92,1147:67,1148:100,1149:75,1150:100,1151:75,1152:75,1153:58,1154:75,1155:0,1156:0,1157:0,1158:0,1159:108,1160:0,1161:0,1162:83,1163:75,1164:67,1165:58,1166:67,1167:75,1168:58,1169:58,1170:67,1171:58,1172:75,1173:67,1174:100,1175:92,1176:67,1177:58,1178:75,1179:67,1180:83,1181:75,1182:75,1183:67,1184:83,1185:75,1186:83,1187:75,1188:100,1189:83,1190:117,1191:100,1192:92,1193:75,1194:75,1195:58,1196:75,1197:58,1198:75,1199:58,1200:75,1201:58,1202:75,1203:75,1204:100,1205:83,1206:75,1207:67,1208:75,1209:67,1210:75,1211:58,1212:92,1213:75,1214:92,1215:75,1216:33,1217:92,1218:83,1219:75,1220:67,1221:83,1222:67,1223:83,1224:75,1225:83,1226:75,1227:75,1228:58,1229:100,1230:83,1231:25,1232:75,1233:67,1234:75,1235:67,1236:100,1237:100,1238:67,1239:67,1240:75,1241:67,1242:75,1243:67,1244:92,1245:83,1246:67,1247:58,1248:67,1249:58,1250:83,1251:75,1252:83,1253:75,1254:92,1255:67,1256:92,1257:67,1258:92,1259:67,1260:75,1261:58,1262:75,1263:58,1264:75,1265:58,1266:75,1267:58,1268:75,1269:58,1270:58,1271:42,1272:92,1273:83,1274:58,1275:42,1276:75,1277:58,1278:75,1279:58,2026:67,19977:108,65403:58};Emstring._ELLIPSIS_LENGTH=new Emstring("\u2026").length;String.prototype.em_snippet=function(b,a){return new Emstring(this.toString()).snippet(b,a).toString()};var DBModal,DBModalLoading,DBModalStack,DBRoleAwareUserModal,DBUserModal,SimpleModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};DBModalStack=(function(){function a(){}a.__stack=[];a.CLEAR="dbmodal:clear";a.pop=function(b){var c;if(b==null){b=null}if(b!=null){a.remove(b)}else{b=a.__stack.pop()}if(b!=null){b._hide()}c=a.top();if(c!=null){return c._show()}else{return $j(document).trigger(a.CLEAR)}};a.push=function(b){var c;assert(b instanceof DBModal,"must pass in valid DBModal");a.remove(b);c=a.top();if(c!=null?c.visible:void 0){c._hide()}a.__stack.push(b);return b._show()};a.top=function(){var b;b=a.__stack.length;if(!b){return null}return a.__stack[b-1]};a.remove=function(d){var b,g,f,c,e;g=[];e=a.__stack;for(f=0,c=e.length;f<c;f++){b=e[f];if(b!==d){g.push(b)}}a.__stack=g};a.clear=function(){var b,c,e,d;for(b=e=d=a.__stack.length-1;e>=0;b=e+=-1){c=a.__stack[b];if(c.visible){c._hide()}}$j(document).trigger(a.CLEAR);return a.__stack=[]};a.register=function(b,c){$j(document).on(b,c);return $j(document).on(a.CLEAR,function(){return $j(document).off(b,c)})};a.unregister=function(b,c){return $j(document).off(b,c)};a.trigger=function(b,c){return $j(document).trigger(b,c)};return a})();DBModal=(function(){a.KEY_SCOPE="dbmodal";a.__stack=[];a.get_containing_modal=function(b){var c;c=b.closest(".db-modal-wrapper").controller();if(c){assert(c instanceof a,"controller of .db-modal-wrapper must be a DBModal object")}return c};a.prototype.before_show=function(b){if(this.options.title!=null){return this.set_title(this.options.title)}};a.prototype.on_confirm_button_click=function(b){b.preventDefault();return DBModalStack.pop()};a.prototype.on_cancel_button_click=function(b){b.preventDefault();return DBModalStack.pop()};a.prototype.on_show=null;a.prototype.on_hide=null;a.prototype.format=function(c){var b,d;for(b in c){if(!__hasProp.call(c,b)){continue}d=c[b];this.$modal_window.find(b).text(d)}return this};a.prototype.make_async_form_submit=function(f,b,d){var c,e=this;c=function(k){var j,h,i,g;k.preventDefault();j=$j(k.target);h=j.closest("form");if(f!=null){g=function(l){f(l);return e.hide()}}else{g=void 0}if(b!=null){i=function(l){return b(l)}}else{i=void 0}return Forms.ajax_submit(h[0],false,g,i,j[0],d)};return c};function a(b){var c;this.options=b;this.set_title=__bind(this.set_title,this);this._hide=__bind(this._hide,this);this._show=__bind(this._show,this);this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);this.__focus=__bind(this.__focus,this);this.__unlisten=__bind(this.__unlisten,this);this.__listen_buttons=__bind(this.__listen_buttons,this);this.__listen=__bind(this.__listen,this);this.__overlay_click_handler=__bind(this.__overlay_click_handler,this);this.__fix_position=__bind(this.__fix_position,this);this.__keydown_handler=__bind(this.__keydown_handler,this);this.__tabbable_elements=__bind(this.__tabbable_elements,this);this.__x_click_handler=__bind(this.__x_click_handler,this);this.__show_modal=__bind(this.__show_modal,this);this.__clone_modal=__bind(this.__clone_modal,this);this.make_async_form_submit=__bind(this.make_async_form_submit,this);this.format=__bind(this.format,this);this.on_cancel_button_click=__bind(this.on_cancel_button_click,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.before_show=__bind(this.before_show,this);this.element_id=a.add_role_to_id(this.options.element_id,this.options.role);this.$template=$j("#db-modal-"+this.element_id);c=this.$template.find(".db-modal");assert(this.$template.length,"Missing DBModal pyxl element for '"+this.element_id+"'");if(this.options.focus){if(this.options.focus==="confirm"){assert(c.find(".confirm-button").length,"DBModal pyxl element is missing a confirm button to focus")}else{if(this.options.focus==="cancel"){assert(c.find(".cancel-button").length,"DBModal pyxl element is missing a cancel button to focus")}else{assert(c.find(this.options.focus).length,"DBModal pyxl element is missing focus element with selector '"+this.options.focus+"'")}}}if(this.on_show!=null){assert(typeof this.on_show==="function","'on_show' must be a function")}if(this.before_show!=null){assert(typeof this.before_show==="function","'before_show' must be a function")}if(this.on_hide!=null){assert(typeof this.on_hide==="function","'on_hide' must be a function")}if(this.on_confirm_button_click!=null){assert(typeof this.on_confirm_button_click==="function","'on_confirm_button_click' must be a function")}if(this.on_cancel_button_click!=null){assert(typeof this.on_cancel_button_click==="function","'on_cancel_button_click' must be a function")}if(this.options.vars){this.vars=this.options.vars}this.click_out_to_close=true;if(this.options.click_out_to_close===false){this.click_out_to_close=false}this.prev_key_scope=null;this.vertical_offset=90;this}a.prototype.__clone_modal=function(){if(!this.$modal_window){this.$modal_window=this.$template.clone().attr("id",this.element_id);this.$overlay=this.$modal_window.find(".db-modal-overlay")}this.$modal_window.controller(this);return $j("body").prepend(this.$modal_window)};a.prototype.__show_modal=function(){this.$modal_window.show();return this.__fix_position()};a.prototype.__x_click_handler=function(b){b.preventDefault();return DBModalStack.clear()};a.prototype.__tabbable_elements=function(){var b,h,f,g,d,k,e,l,c,j;e=this.$modal_window.find(".db-modal").find(":tabbable");assert(e.length,'"dbmodal-x" should be in tabbable_elms');l=(function(){var n,m,i;i=[];for(n=0,m=e.length;n<m;n++){f=e[n];if(parseInt($j(f).attr("tabindex"))>-1){i.push(f)}}return i})();if(l.length){k=function(m,i){var n,o;n=parseInt($j(m).attr("tabindex"),10);o=parseInt($j(i).attr("tabindex"),10);if(n<o){return -1}if(n>o){return 1}return 0};l.sort(k);g=-1;for(c=0,j=l.length;c<j;c++){f=l[c];d=e.index(f);if(g===-1){g=d}e.splice(d,1)}assert(g>-1,"First index should be set");h=e.slice(0,g);b=e.slice(g);e=$j.merge(h,l);e=$j.merge(e,b)}return e};a.prototype.__keydown_handler=function(f){var d,c,b,g;if(f.keyCode===27||(f.keyCode===8&&!Util.focus_in_input())){f.preventDefault();DBModalStack.clear()}if(f.keyCode===9){f.preventDefault();d=this.__tabbable_elements();c=d.index($j(f.target));if(c<0){if(this.focus_element){return $j(this.focus_element).focus()}if(f.shiftKey){g=d.last()}else{g=d.first()}return g.focus()}if(c>-1){if(f.shiftKey){b=-1}else{b=1}g=(c+b)%d.length;return d.get(g).focus()}}};a.prototype.__fix_position=function(h){var f,c,d,b,g;f=this.$modal_window.find(".db-modal");g=f.width();c=f.height();d=$j(document).scrollTop()+this.vertical_offset;b="absolute";if(c+this.vertical_offset<$j(window).height()){b="fixed"}return f.css({margin:"0 0 0 "+(Math.floor(-g/2).toString())+"px",position:b,top:this.vertical_offset})};a.prototype.__overlay_click_handler=function(b){b.preventDefault();return DBModalStack.clear()};a.prototype.__listen=function(){if(this.click_out_to_close!==false){this.$overlay.on("click",this.__overlay_click_handler)}this.$db_modal_x=this.$modal_window.find(".db-modal-x");this.$db_modal_x.on("click",this.__x_click_handler);$j(document).on("keydown",this.__keydown_handler);return this.__listen_buttons()};a.prototype.__listen_buttons=function(){if(this.on_confirm_button_click!=null){this.$confirm_button=this.$modal_window.find(".confirm-button");this.$confirm_button.on("click",this.on_confirm_button_click)}if(this.on_cancel_button_click!=null){this.$cancel_button=this.$modal_window.find(".cancel-button");return this.$cancel_button.on("click",this.on_cancel_button_click)}};a.prototype.__unlisten=function(){if(this.click_out_to_close!==false){this.$overlay.off("click")}this.$db_modal_x.off("click");$j(document).off("keydown",this.__keydown_handler);if(this.on_confirm_button_click!=null){this.$confirm_button.off("click")}if(this.on_cancel_button_click!=null){return this.$cancel_button.off("click")}};a.prototype.__focus=function(){var e,b,c,d;b=this.$modal_window.find(".db-modal");if(this.options.focus==="confirm"){this.focus_element=b.find(".confirm-button").first()}else{if(this.options.focus==="cancel"){this.focus_element=b.find(".cancel-button").first()}else{if(this.options.focus){this.focus_element=b.find(this.options.focus).first()}else{this.focus_element=b;e=b.find("input[type=text], input[type=email]").first();if(e.length){this.focus_element=e}else{if(!Util.ie){c=b.find("input[type=button]").first();if(c.length){this.focus_element=c}d=b.find("input[type=submit]").first();if(d.length){this.focus_element=d}}}}}}return this.focus_element.focus()};a.add_role_to_id=function(c,b){if(b){return""+c+"-"+b}else{return c}};a.prototype.show=function(){return DBModalStack.push(this)};a.prototype.hide=function(){if(this!==DBModalStack.top()){DBModalStack.remove(this);return this._hide()}else{return DBModalStack.pop()}};a.prototype._show=function(){var f,e,b,i,h,g,d,c;if(this.visible){return}this.__clone_modal();if(typeof this.before_show==="function"){this.before_show(this.$modal_window)}this.__show_modal();this.__listen();this.visible=true;if(key.getScope()!==this.constructor.KEY_SCOPE){this.prev_key_scope=key.getScope()}key.setScope(this.constructor.KEY_SCOPE);Util.set_page_scrollable(false);if(typeof this.on_show==="function"){this.on_show()}this.__focus();if(window.TextInput!=null){e=this.$modal_window.find(".text-input");for(h=0,d=e.length;h<d;h++){i=e[h];new TextInput($j(i),$j(i).find("input, textarea"))}}f=this.$modal_window.find(".db-select");for(g=0,c=f.length;g<c;g++){b=f[g];$j(b).controller(new DBSelect($j(b)))}return this};a.prototype._hide=function(){if(!this.visible){return}this.__unlisten();key.setScope(this.prev_key_scope);this.$modal_window.remove();this.visible=false;this.prev_key_scope=null;Util.set_page_scrollable(true);if(typeof this.on_hide==="function"){this.on_hide()}return this};a.prototype.set_title=function(b){this.$modal_window.find(".db-modal-title-text").text(b);return this};return a}).call(this);DBModalLoading=(function(b){__extends(a,b);function a(c){a.__super__.constructor.call(this,c)}a.prototype.on_show=function(){return this.fetch()};a.prototype.fetch=function(){var c=this;return new UIRequest(this.$modal_window,this.options.endpoint_url,{parameters:this.options.parameters||{},subject_user:this.options.subject_user,html_in_error_msg:this.options.html_in_error_msg,onFailure:function(d){return c.hide()}})};a.prototype.on_confirm_button_click=null;a.prototype.on_cancel_button_click=null;return a})(DBModal);DBUserModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.__inject_basic_user_properties=__bind(this.__inject_basic_user_properties,this);this.before_show=__bind(this.before_show,this);assert(this.user instanceof User,"DBUserModal must be constructed with a user object");a.__super__.constructor.call(this,d)}a.prototype.before_show=function(c){a.__super__.before_show.call(this,c);return this.__inject_basic_user_properties(c)};a.prototype.__inject_basic_user_properties=function(c){var e,d;e=c.find("form");e.find("input[name='"+Constants.UID_PARAM_NAME+"']").remove();d=$j('<input type="hidden">').attr({name:Constants.UID_PARAM_NAME,value:this.user.id});e.append(d);return c.find(".dbmodal-email-placeholder").text(this.user.email)};return a})(DBModal);DBRoleAwareUserModal=(function(b){__extends(a,b);function a(){this.before_show=__bind(this.before_show,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.before_show=function(e){var h,c,f,g,d;a.__super__.before_show.call(this,e);f={regular:".dbmodal-role-regular",personal:".dbmodal-role-personal",work:".dbmodal-role-work"};g=null;if(viewer.is_paired&&this.user.role===Constants.ROLE_PERSONAL){g=f.personal}else{if(viewer.is_paired&&this.user.role===Constants.ROLE_WORK){g=f.work;e.find(".dbmodal-teamname-placeholder").text(viewer.team_name)}else{g=f.regular}}d=[];for(h in f){c=f[h];if(c===g){d.push($j(c).show())}else{d.push($j(c).hide())}}return d};return a})(DBUserModal);SimpleModal={show:function(a){var c,b;b=new DBModal({element_id:"simple_modal"});b.show();c=$j("#simple_modal");assert(a.title_html!=null);assert(a.body_html!=null);b.set_title(a.title_html);c.find(".confirm-button").bind("click",a.confirm_callback);c.find(".cancel-button").bind("click",a.cancel_callback);c.find(".simple-modal-content").html(a.body_html);if(a.cancel_text){c.find(".cancel-button").val(a.cancel_text);c.find(".cancel-button").show()}else{c.find(".cancel-button").hide()}if(a.confirm_text){c.find(".confirm-button").val(a.confirm_text);return c.find(".confirm-button").show()}else{return c.find(".confirm-button").hide()}}};var UIRequest;UIRequest=Class.create(Ajax.DBRequest,{initialize:function($super,c,a,k){var f,b,j,d,e,i,h,g;if(k==null){k={}}h=k.parameters||{};d=k.onComplete;i=k.onSuccess;e=k.onFailure;c=$j(c);this.delayComplete=false;j=function(m,l){var n;n=JSON.parse(l.responseText);if(n.redirect){window.location.href=n.redirect;return}if(n.reload){window.location.reload();return}this.delayComplete=n.js||n.css;if(!this.delayComplete){g(m,n.actions||[]);if(typeof i==="function"){i(l)}return}return Util.async_multiload_static(n.css,n.js,function(){g(m,n.actions||[]);if(typeof i==="function"){i(l)}m.removeClass("ajax-loading");Forms.remove_loading();return typeof d==="function"?d(l):void 0})};g=function(m,r){var p,s,l,w,t,n,v,q,u,o;o=[];for(q=0,u=r.length;q<u;q++){p=r[q];w=p[0],l=p[1],n=p[2];if(n&&w!=="modal"){if(n.charAt(0)==="^"){s=m.closest(n.substr(1))}else{s=m.find(n).filter(":first")}}else{s=m}switch(w){case"modal":t=new HTML(l);if(n){v=new HTML(n)}DBModalStack.clear();o.push(Modal.show(v,t));break;case"html":o.push(s.html(l));break;case"replaceWith":o.push(s.replaceWith(l));break;case"after":o.push(s.after(l));break;case"before":o.push(s.before(l));break;case"toggleClass":o.push(s.toggleClass(l));break;case"addClass":o.push(s.addClass(l));break;case"removeClass":o.push(s.removeClass(l));break;case"notify":o.push(Notify.server_success(l));break;case"notifyError":o.push(Notify.server_error(l));break;default:o.push(void 0)}}return o};b=function(o,l){var m,n;if(l){if(l.responseText.indexOf("err:")===0){m=l.responseText.substr(4);if(m.indexOf("{")===0){n=m.evalJSON(true);Forms.fill_errors(o.get(0),n)}else{Notify.server_error(m)}}else{Notify.server_error()}if(e){return e(l)}}};f=function(m,l){if(!this.delayComplete){m.removeClass("ajax-loading");Forms.remove_loading();if(d){return d(l)}}};if(c.hasClass("ajax-loading")){return false}c.addClass("ajax-loading");return $super(a,{parameters:h,noAutonotify:true,onSuccess:j.curry(c),onFailure:b.curry(c),onComplete:f.curry(c)})}});Util.smartLoad(function(){var c,b,d,a;d=Prototype.Browser;a=[];for(c in d){b=d[c];if(b){a.push($(document.body).addClassName(c.toLowerCase()))}}return a});var HomePageController;HomePageController={init:function(c){var a,b;PromoHolder.init(Browse.active_user,c.force_campaign,c.force_promo);if(c.show_email_just_verified){return EmailVerification.getForRole(c.role).show_verified_modal()}else{if(c.show_email_just_verified_and_changed){return EmailVerification.getForRole(c.role).show_verified_and_changed_modal()}else{if(c.show_sent_verification_email){return EmailVerification.getForRole(c.role).show_sent_modal()}else{if(c.show_upload){return FileOps.show_upload()}else{if(c.show_share_existing_modal){return SharingModals.show_share_existing_modal(c.fq_path,Browse.active_user)}else{if(c.show_share_options&&!c.share_subfolder){b=viewer.get_user_by_role(c.role);if(!b){b=viewer.get_users()[0]}return SharingModals.show_shared_folder_options_modal(c.fq_path,b)}else{if(c.show_share_options&&c.share_subfolder){b=viewer.get_user_by_role(c.role);if(!b){b=viewer.get_users()[0]}return SharingModals.show_shared_subfolder_modal(c.fq_path,b)}else{if(c.show_download_modal){a=new ClientDownload();return a.show_download_modal()}else{if(c.language_modal_locale){return HomePageController.show_language_modal(c.language_modal_locale)}else{if(c.language_modal_invite_locale){return HomePageController.show_language_modal_invite(c.language_modal_invite_locale)}}}}}}}}}}},show_language_modal:function(b){var a;if(!b||Constants.USER_LOCALE!=="en"){return}a={from_locale:"en",to_locale:b};GrowthWebActivityLogger.log("i18n-language-modal-show",a);$j("#lm-stay").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-stay",a,(function(){return Modal.hide()}))});$j("#lm-switch").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-switch",a,function(){return LocaleSelector.set_locale(b,window.location.href+"?lm2="+b)})});return Modal.show(false,$j("#language-modal")[0],{},false,500,false,"language-modal")},show_language_modal_invite:function(b){var a;if(!b||Constants.USER_LOCALE==="en"){return}a={from_locale:"en",to_locale:b};GrowthWebActivityLogger.log("i18n-language-modal-invite-show",a);$j("#lm-invite").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-invite-click",a,function(){return window.location.href="/referrals"})});$j("#lm-not-now").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-invite-not-now",a,(function(){return Modal.hide()}))});return Modal.show(false,$j("#language-modal-invite")[0],{},false,680,false,"language-modal")}};var BrowseActionsContextMenuLogger,GrowthWebActivityLogger,Jcached,TeamsWebActionsLogger,UserActivityLogger,ViralLogger,WebMiscActivityLogger,get_uids_for_logging;Jcached={cache:{},set:function(b,d,a){var e;e=Jcached.cache[b];if(e==null){e=Jcached.cache[b]={}}e.value=d;return e.expires=a?new Date().getTime()+a:0},get:function(a){var b;b=Jcached.cache[a];if(!(b!=null)||new Date().getTime()>b.expires){delete Jcached.cache[a];return false}return b.value}};get_uids_for_logging=function(d){var b,c;if(!d){b=(function(){var g,e,f,a;f=viewer.get_users();a=[];for(g=0,e=f.length;g<e;g++){c=f[g];a.push(c.id)}return a})()}else{b=[for_uid]}return b};UserActivityLogger={log:function(b,d,a,e){var c;if(e==null){e=null}c=get_uids_for_logging(e);return new Ajax.DBRequest("/ualogger",{parameters:{platform:b,event_name:d,extra:a,for_uids:JSON.stringify(c)},noAutonotify:true})}};TeamsWebActionsLogger={log:function(d,a,b,e){var c;if(e==null){e=null}c=get_uids_for_logging(e);return new Ajax.DBRequest("/teamswalogger",{parameters:{event_name:d,extra:JSON.stringify(a),for_uids:JSON.stringify(c)},noAutonotify:true,onSuccess:b?b:void 0,onFailure:b?b:void 0})}};WebMiscActivityLogger={log:function(c,a,d){var b;if(d==null){d=null}b=get_uids_for_logging(d);return new Ajax.DBRequest("/misclogger",{parameters:{event_name:c,extra:JSON.stringify(a),for_uids:JSON.stringify(b)},noAutonotify:true})}};GrowthWebActivityLogger={log:function(d,e,a,f){var b,c;if(f==null){f=null}b=get_uids_for_logging(f);c={event_name:d,for_uids:JSON.stringify(b)};if(e!=null){c.params=JSON.stringify(e)}return new Ajax.DBRequest("/gwalogger",{parameters:c,noAutonotify:true,onSuccess:a?a:void 0,onFailure:a?a:void 0})}};ViralLogger={log:function(b,d,c,a){return new Ajax.DBRequest("/virallogger",{parameters:{user_ids:JSON.stringify(b),viral_type:d,action:c,extra:JSON.stringify(a||{})},noAutonotify:true})}};BrowseActionsContextMenuLogger={log:function(d,h){var g,b,c,e,a;b=0;c=0;for(e=0,a=d.length;e<a;e++){g=d[e];if(g.dir){c+=1}else{b+=1}}return new Ajax.DBRequest("/browse_actions_context_menu_logger",{parameters:{file_count:b,folder_count:c,action:h},noAutonotify:true})}};var DBHistory,HTML5_HISTORY,HashRouter,_this=this,__slice=[].slice;HTML5_HISTORY=Modernizr.history;DBHistory=(function(){var l,j,k,g,m,h,b,a,e,i,c,f,d;l=new RegExp("#|;|\\?|:|@|&|=|\\+|\\$");c=function(){var o,p,n;n=void 0;if(HTML5_HISTORY){o=window.location.pathname;p=window.location.search;if(o.search(l)!==-1){o=Util.urlquote(o)}n=o+p}else{n=window.location.href.split("#!").last()}return n};m=function(p,q){var o,n;n=p;o=q&&Object.toQueryString(q);if(o){n+="?"+o}return n};h=function(n){var p,q,o;if(n==null){n=c()}o=n.split("?");p=o[0];q={};if(n.indexOf("?")!==-1){q=n.toQueryParams()}return{url:n,path:p,qargs:q}};j={};b={};f=c();d=null;i=function(n){return"/"+n.split("/")[1]};a=function(){var p,o,n;n=f;o=h(n);p=i(o.path);if(p in j){return j[p](o.path.substr(p.length+1),o.qargs)}};e=function(){var p,o,n;n=f;o=h(n);p=i(o.path);if(p in b){return b[p](o.path.substr(p.length+1),o.qargs)}};k=function(q,o){var n,p;p=i(q);n=i(o);if(p!==n){return e()}};g=function(){var n;n=c();if(n!==f){k(f,n);f=n;return a()}};return{init:function(){if(!d){f=c();return d=setInterval(g,50)}},add_callback:function(o,n){assert(typeof o==="string","DBHistory prefix is not a string");assert(o.startsWith("/"),"DBHistory prefix must be absolute");assert(o.count("/")===1,"multi-component prefixes arent supported");j[o]=n;return a()},add_exit_callback:function(o,n){assert(typeof o==="string","DBHistory prefix is not a string");assert(o.startsWith("/"),"DBHistory prefix must be absolute");assert(o.count("/")===1,"multi-component prefixes arent supported");return b[o]=n},_build_url_for_state_change:function(o,p){var n;assert(typeof o==="string","DBHistory path is not a string");assert(o.startsWith("/"),"DBHistory path must be absolute");assert(o.indexOf("//")===-1,"DBHistory path contains //");return n=m(o,p)},_pre_state_change:function(n){if(n===f){return false}k(f,n);return true},_post_state_change:function(){f=c();return a()},replace_state:function(o,p){var n;n=this._build_url_for_state_change(o,p);if(!this._pre_state_change(n)){return}assert(HTML5_HISTORY,"replace_state is only available on modern browsers");window.history.replaceState(null,null,n);return this._post_state_change()},push_state:function(o,p){var n;assert(o.indexOf("?")===-1,"DBHistory path contains ?");assert(o.indexOf("#")===-1,"DBHistory path contains #");n=this._build_url_for_state_change(o,p);if(!this._pre_state_change(n)){return}if(HTML5_HISTORY){window.history.pushState(null,null,n)}else{window.location.href="#!"+n}return this._post_state_change()},get_url:c,construct_url:m,deconstruct_url:h,URL_ESCAPE_REGEX:l}})();Util.smartLoad(function(){return DBHistory.init()});HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(a,b){this.callback_map[a]=b;if(!this.watch_timer){return this.init()}},check_hash:function(){var b,d,c,a;d=Util.url_hash();if($j.browser.mozilla){d=d.replace(/%27/g,"'").replace(/%22/,'"')}if(this.last_hash===d){return}this.last_hash=d;if(this.last_prefix&&d===""){d=this.last_prefix+":"}else{if(!d){return}}a=d.split(":");c=a.first();this.last_prefix=c;b=this.callback_map[c];if(b){b.apply(b,a.slice(1))}return $(document).fire("db:hash_change",{hash:d})},_prepare_hash:function(c){var b,a;a=$A(c).map(Util.falsy_to_empty);b=a.map(encodeURIComponent);return b.join(":")},set_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b)},replace_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b,true)},_set_hash:function(b,a){if(b===""){b="/"}this.last_hash=b;if(!a){return window.location.href="#"+b}else{return window.location.replace("#"+b)}}};var MultiaccountLogin;MultiaccountLogin={$element:function(){return $j("#login-modal")},set_during_login_callback:function(a){assert(!this._during_login_callback,"already have a during_login_callback");return this._during_login_callback=a},show_modal:function(d){var b,a,g,e,c,f=this;if(d==null){d={}}b=$j.isFunction(this.$element)?this.$element():this.$element;assert(b!=null?b.length:void 0,"MultiaccountLogin needs its @$element to be set");assert(!((d.on_success!=null)&&(d.success_href!=null)),"on_success and success_href are mutually exclusive");if(d.user!=null){c=viewer.get_user_by_id(String(d.user),true)}else{if(d.user_id!=null){c=viewer.get_user_by_id(d.user_id,true)}else{if(d.role!=null){c=viewer.get_user_by_role(d.role,true)}}}assert(c!=null,"invalid user");g=c.role;assert(!viewer.is_user_signed_in(c),"called MultiaccountLogin for a user that's already signed in");if(g==="personal"){e=_("Sign in to your personal Dropbox")}else{e=_("Sign in to your %(team_name)s Dropbox").format({team_name:viewer.team_name})}b.find("#login_email").val(c.email);a=function(){var h;$j("#modal form")[0].ajax_submitted=true;viewer._sign_in_all_users();Multiaccount.set_logged_out_role(null);h=function(j){var m,l,i,k;k=$j("#modal form");for(l=0,i=k.length;l<i;l++){m=k[l];m.ajax_submitted=false}if(j!=null){Notify.server_error(j);viewer._sign_out_user_by_id(c.id);Multiaccount.set_logged_out_role(c.role);Modal.hide();return}if(d.success_href!=null){if(window.location.href!==d.success_href){return window.location.href=d.success_href}else{return window.location.reload()}}else{Modal.hide();return typeof d.on_success==="function"?d.on_success():void 0}};if((f._during_login_callback!=null)&&!(d.success_href!=null)){f._during_login_callback(c,h)}else{h()}return false};$j(document).off("login:success.multiaccount");$j(document).on("login:success.multiaccount",a);b.find(".db-login-container").controller().reset();Modal.show(e,b[0],false,false,460,false,"switch-login-modal",true,true);if(c.sso_required&&c.seamless_sso_enabled){b.find("#password-field").hide();b.find("#remember-me").hide();b.find("#login_submit").val(_("Continue"));b.find(".forgot-link").hide();return b.find("#sso_description").show()}else{return b.find("#login_password").focus()}}};var SF_VIEWS;SF_VIEWS={CURRENT:"current",PAST:"past"};var ContactTypes;ContactTypes={EMAIL:0,FB:1,INVALID:2,USER_GROUP:3};var SharingState;SharingState=(function(){function a(){}a.set_role=function(b){if(Multiaccount.is_valid_role(b)){$j(".shared-folder-role-param").val(b);return this.role=b}};a.set_is_merged=function(b){return this.is_merged=b};a.set_team_name=function(b){return this.team_name=b};a.set_team_permissions=function(c,b){if(c==null){c=false}if(b==null){b=false}this.team_only=c;return this.show_groups=b};a.set_not_logged_in_role_and_email=function(c,b){this.not_logged_in_role=c;return this.not_logged_in_email=b};a.set_show_inbox=function(b){return this.show_inbox=b};return a})();var SharingUtil;SharingUtil=(function(){function a(){}a.success_string_for_recipients=function(b){var c;if(b.length===1){if(b[0].indexOf("@")===-1){c=_("Sent to %(recipient)s.").format({recipient:b[0]})}else{c=_("Sent to %(recipient)s.").format({recipient:b[0]})}}else{if(b.length===2){if(b[0].indexOf("@")===-1){if(b[1].indexOf("@")===-1){c=_("Sent to %(recipient_first)s and %(recipient_second)s.").format({recipient_first:b[0],recipient_second:b[1]})}else{c=_("Sent to %(recipient_first)s and %(recipient_second)s.").format({recipient_first:b[0],recipient_second:b[1]})}}else{if(b[1].indexOf("@")===-1){c=_("Sent to %(recipient_first)s and %(recipient_second)s.").format({recipient_first:b[0],recipient_second:b[1]})}else{c=_("Sent to %(recipient_first)s and %(recipient_second)s.").format({recipient_first:b[0],recipient_second:b[1]})}}}else{if(b[0].indexOf("@")===-1){c=_("Sent to %(recipient)s and %(num_others)s others.").format({recipient:b[0],num_others:b.length-1})}else{c=_("Sent to %(recipient)s and %(num_others)s others.").format({recipient:b[0],num_others:b.length-1})}}}return c};return a})();var SharingApi,UserlessSharingApi;SharingApi=(function(){function a(b){this.user=b}a.prototype.invite_more_to_folder=function(c,b,e,g,d,f){var h;h={ns_id:c,emails:b.emails||[],fb_ids:b.fb_ids||[],group_ids:b.group_ids||[],custom_message:e||"",access_type:g};return this._make_request("/share_ajax/invite_more",h,d,f,true)};a.prototype.update_access_type=function(b,e,f,c,d){var g;g={ns_id:b,member_id:e,access_type:f};return this._make_request("/share_ajax/update_access_type",g,c,d,true)};a.prototype.share_folder=function(j,e,d,i,h,c,b,k,f){var g,l;g={emails:d.emails||[],fb_ids:d.fb_ids||[],group_ids:d.group_ids||[],custom_message:i||"",audience:h,inviter:c,access_type:b,folder_settings:1};if(j){g.folder_name=e;l="/share_ajax/new"}else{g.path=e;l="/share_ajax/existing"}if(h||c){g.custom_folder_settings=1}return this._make_request(l,g,k,f,true)};a.prototype.unshare_folder=function(c,b,d){var e;e={ns_id:c,async:true};if(b){e.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",e,d)};a.prototype.leave_folder=function(c,b,d){var e;e={ns_id:c};if(b){e.keep_files=true}return this._make_request("/share_ajax/leave?long_running",e,d)};a.prototype.transfer_ownership=function(b,d,c){var e;e={ns_id:b,user_id:d};return this._make_request("/share_ajax/change_sf_owner",e,c)};a.prototype.cancel_invite=function(b,e,c){var d;d={ns_id:b,invite_id:e};return this._make_request("/share_ajax/cancel_invite",d,c)};a.prototype.kick=function(c,e,b,d){var f;f={ns_id:c,user_id:e};if(b){f.keep_files=true}return this._make_request("/share_ajax/kick_user",f,d)};a.prototype.kick_group=function(b,d,c){return Notify.server_error("This feature has been removed.")};a.prototype.reinvite_user=function(b,e,c){var d;d={ns_id:b,invite_id:e};return this._make_request("/share_ajax/reinvite_user",d,c)};a.prototype.update_sf_permissions=function(b,e,c,d){var f;f={ns_id:b,new_permissions:e};return this._make_request("/share_ajax/change_sf_perm",f,c,d)};a.prototype.update_sf_team_permissions=function(b,d,e,c){var f;f={ns_id:b,audience:d,inviter:e};return this._make_request("/share_ajax/save_folder_settings",f,c)};a.prototype.validate_new_sf_path=function(e,b,c){var d;d={share_type:"new",folder_name:e};return this._make_request("/share_ajax/validate_folder",d,b,c,true)};a.prototype.validate_existing_sf_path=function(e,b,c){var d;d={share_type:"existing",path:e};return this._make_request("/share_ajax/validate_folder",d,b,c,true)};a.prototype._make_request=function(c,g,b,d,f){var e,h=this;if(f==null){f=false}g[Constants.UID_PARAM_NAME]=this.user.id;if((e=this.loading_elem)!=null){e.addClass("ajax-loading")}return new Ajax.DBRequest(c,{parameters:g,onSuccess:b,onFailure:d,onComplete:function(){var i;return(i=h.loading_elem)!=null?i.removeClass("ajax-loading"):void 0},noAutonotify:f})};return a})();UserlessSharingApi=(function(){function a(){}a.prototype.shmodel_quicksend=function(e,f,c,b,d){return new Ajax.DBRequest("/sm/quicksend",{parameters:{path:e,emails:f},onSuccess:b,onFailure:d,subject_user:c})};a.prototype.get_inbox_counts=function(b){var c=this;return new Ajax.DBRequest("/inbox_count",{suppress_role:true,onSuccess:function(e){var d;d=JSON.parse(e.responseText);assert(typeof d==="object","bad inbox_count");return b(d)}})};a.prototype.get_folder_info=function(b,c){return new Ajax.DBRequest("/share_ajax/list_folders",{suppress_role:true,onSuccess:b,onFailure:c})};return a})();var SharingForms;SharingForms=(function(){function a(){}a.submit_share_new=function(c){var b;b=$$(".invite-more-form")[0];assert(b,"Couldn't find the invite more form.");Forms.ui_form_submit(b,"/share_ajax/new");return Forms.add_loading(c)};a.submit_share_existing=function(c){var b;b=$$(".invite-more-form")[0];assert(b,"Couldn't find the invite more form.");Forms.ui_form_submit(b,"/share_ajax/existing?long_running");return Forms.add_loading(c)};a.submit_invite_more=function(c){var b;b=$$(".invite-more-form")[0];assert(b.down("input[name=ns_id]"),"Submit invite more wizard is missing ns_id");Forms.ui_form_submit(b,"/share_ajax/invite_more");return Forms.add_loading(c)};return a})();var SharingModals;SharingModals=(function(){function a(){}a.show_shared_folder_options_modal=function(c,b){return DBModalStack.push(new ExistingSharedFolderOptionsModal(b,c))};a.show_shared_folder_wizard=function(b){return new ShareAFolderWizardModal(b,{element_id:"share-a-folder-wizard-modal"}).show()};a.get_select_role_modal=function(){return new SharedFolderSelectRoleModal({element_id:"select-role-modal"})};a.start_wizard_without_user=function(){if(viewer.is_paired){if(!(this.select_role_modal!=null)){this.select_role_modal=a.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(viewer.get_users()[0])}};a.start_wizard_for_user=function(b){if(EmailVerification.getForRole(SharingState.role).verified()){return a.show_shared_folder_wizard(b)}};a.show_share_existing_modal=function(d,b){var c;if(EmailVerification.getForRole(b.role).verified()){c=new InviteToNewSharedFolderWizardModal(b,{folder_name:d,existing_folder:true,element_id:"invite-to-new-sf-wizard-modal-"+b.id});return c.show()}};a.show_unshare_team_sf_modal=function(c,b,e){var d;d=new UnshareFolderModal(c,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:b,folder_path:e});return d.show()};a.show_ignore_modal=function(c,f,b){var e,d,h,g;assert(b,"Share ignore did not get an ns_id");g=_("Permanently remove '%(folder_name)s'").format({folder_name:Util.filename(f).em_snippet(15)});e={path:f,ns_id:b};h=function(i){Notify.server_success(_("Removed shared folder successfully."));return document.fire(FileEvents.SF_IGNORE,{target_ns_id:b,user_id:c.id})};d=new DBUserModal(c,{element_id:"ignore-confirm",title:g});d.on_confirm_button_click=d.make_async_form_submit(h,void 0,e);return d.show()};a.show_rejoin_modal=function(c,f,b){var e,d,h,g;assert(b,"Rejoin didn't get an ns_id");g=_("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:Util.filename(f).em_snippet(13)});e={path:f,ns_id:b};h=function(j){var i;i=Util.filename(j.responseText);Notify.server_success(_("Rejoined shared folder successfully."));return document.fire(FileEvents.SF_REJOIN,{target_ns_id:b,user_id:c.id,filename:i})};d=new DBUserModal(c,{element_id:"rejoin-confirm",title:g});d.on_confirm_button_click=d.make_async_form_submit(h,void 0,e);return d.show()};a.show_invites=function(){return DBModalStack.push(new DBModalLoading({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};a.show_shared_subfolder_modal=function(c,e){var i,f,h,b,d,g=this;h=Util.filename(c).em_snippet(14);f=_("Can't share folder");b="'%(parent_shared_folder)s' ".format({parent_shared_folder:h});DomUtil.fillVal(b.escapeHTML(),"parent_shared_folder_name");i=_("Share '%(parent_shared_folder)s' folder");d=i.format({parent_shared_folder:h});($("share_parent_folder_button")).value=d;Modal.show_loading("folder_user_32",_("Loading shared folder options..."));$j("#share_parent_folder_button").on("click",function(j){Modal.hide();return g.show_shared_folder_options_modal(c,e)});return Modal.show(f,$("share_subfolder"))};return a})();var InviteFormController;InviteFormController=(function(){function a(c,b,f){var e,d;this.user=c;this.$form=b;this.team_only=this.$form.data("team-only");d={tokens:[",",";"],include_fb:true};if(this.user.role==="work"){e=Autocompleter.TeamTokenizer;d.team_only=this.team_only}else{e=Autocompleter.ContactsTokenizer;d.include_team=true}this.sharing_options_auto_completer=new e(this.user,f+"-new-collab-input",f+"-new-whobulk",f+"-hidden-input",d);SickInput._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new TeamSharedFolderInviteController(this.$form)}}a.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};a.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};a.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};a.prototype.set_team_only=function(b){this.team_only=b;return this.sharing_options_auto_completer.setTeamOnly(b)};a.prototype.extract_invitees=function(){var e,d,c,h,g,b,f;h={};f=["emails","fb_ids","group_ids"];for(g=0,b=f.length;g<b;g++){d=f[g];c=this.$form.find("input[name="+d+"]");h[d]=[(function(){var k,j,i;i=[];for(k=0,j=c.length;k<j;k++){e=c[k];i.push($j(e).val())}return i})()]}return h};a.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};a.prototype.get_access_type=function(){return this.$form.find(".sf-invite-can-edit #selected").val()};return a})();var ExistingSharedFolderOptionsContent,ExistingSharedFolderOptionsModal,ExistingSharedFolderPermissionsContent,ExistingSharedFolderPermissionsModal,KickGroupModal,KickUserModal,LeaveFolderModal,SharedFolderBaseModal,TransferOwnershipModal,UninviteModal,UnshareFolderModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};SharedFolderBaseModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;a.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new SharingApi(this.user)}a.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return a})(DBModal);ExistingSharedFolderOptionsModal=(function(b){__extends(a,b);function a(c,d){var f,e;this.user=c;assert(d!=null,"Missing folder path");this.path=Util.normalize(d);e=_("Shared folder options for '%(folder)s'");e=e.format({folder:Util.filename(d).em_snippet(13)});f={};f[Constants.UID_PARAM_NAME]=this.user.id;a.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:e,endpoint_url:URI({path:"/share_options"+this.path}).toString(),parameters:f})}return a})(DBModalLoading);ExistingSharedFolderOptionsContent=(function(){function a(d,b,c){this.$root=d;this.show_email_verification=__bind(this.show_email_verification,this);this.show_folder_settings=__bind(this.show_folder_settings,this);this.toggle_from_invite_mode=__bind(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=__bind(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=__bind(this.show_leave_folder_modal,this);this.show_unshare_folder_modal=__bind(this.show_unshare_folder_modal,this);this.show_uninvite_modal=__bind(this.show_uninvite_modal,this);this.show_transfer_user_modal=__bind(this.show_transfer_user_modal,this);this.show_kick_group_modal=__bind(this.show_kick_group_modal,this);this.show_kick_user_modal=__bind(this.show_kick_user_modal,this);this.update_sf_perms=__bind(this.update_sf_perms,this);this.reinvite_user=__bind(this.reinvite_user,this);this.submit_invitations=__bind(this.submit_invitations,this);this.extract_user_data_and_call=__bind(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=__bind(this.extract_invitee_data_and_call,this);this.user=viewer.get_user_by_id(b);this.path=Util.normalize(c);this.sharing_api=new SharingApi(this.user);this.sharing_api.loading_elem=this.$root;BrowseStyleRows.register_all();SuggestionInput.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.sf_access_type.hide();this.listen()}a.prototype.listen=function(){var e,d,c,g,b,f,h=this;this.$root.find(".confirm-button").click(function(i){i.preventDefault();return h.submit_invitations()});this.$root.find(".cancel-button").click(function(i){i.preventDefault();return h.toggle_from_invite_mode()});e=this.$root.find("#sharing-options-new-collab-input");f=["focus","keypress","contextmenu"];for(g=0,b=f.length;g<b;g++){c=f[g];e.off(c);e.on(c,this.toggle_to_invite_mode)}d=this.$root.find("#custom-message-wizard");d.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new InviteFormController(this.user,this.$invite_form,"sharing-options")}this.$root.on("click","a.kick-user",function(i){return h.extract_user_data_and_call(i,h.show_kick_user_modal)});this.$root.on("click","a.kick-group",function(k){var i,j,l;k.preventDefault();i=$j(k.currentTarget);l=i.data("group-name");j=i.data("group-id");return h.show_kick_group_modal(l,j)});this.$root.on("click","a.make-owner",function(i){return h.extract_user_data_and_call(i,h.show_transfer_user_modal)});this.$root.on("click","a.send-email",function(j){var i,k;j.preventDefault();i=$j(j.currentTarget);k=i.data("email");return window.location=URI({scheme:"mailto",path:k}).toString()});this.$root.on("click","a.reinvite-user",function(i){return h.extract_invitee_data_and_call(i,h.reinvite_user)});this.$root.on("click","a.uninvite-user",function(i){return h.extract_invitee_data_and_call(i,h.show_uninvite_modal)});this.$root.on("click","input.sf-action-leave",function(i){i.preventDefault();return h.show_leave_folder_modal()});this.$root.on("click","input.sf-action-unshare",function(i){i.preventDefault();return h.show_unshare_folder_modal()});this.$root.on("click","input.sf-action-done",function(i){i.preventDefault();return DBModalStack.pop()});return this.$root.on("click","input#change-sf-perm-checkbox",function(j){var i;i=$j(j.currentTarget);return h.update_sf_perms(i.prop("checked"))})};a.prototype.extract_invitee_data_and_call=function(f,d){var b,g,c;f.preventDefault();b=$j(f.currentTarget);c=b.data("email-or-fbname");g=b.data("invite-id");return d(c,this.ns_id,g)};a.prototype.extract_user_data_and_call=function(h,g){var c,f,d,b;h.preventDefault();c=$j(h.currentTarget);d=c.data("display-name");f=c.data("email");b=c.data("user-id");return g(d,f,b)};a.prototype.submit_invitations=function(){var d,c,g,e,b,f=this;this.invite_form_controller.tokenize();g=this.invite_form_controller.extract_invitees();e=this.invite_form_controller.get_custom_message();d=this.invite_form_controller.get_access_type();b=function(h){DBModalStack.pop();return Notify.server_success(h.responseText)};c=function(h){return InlineModalValidationError.show_validation_error(h,f.$root.find(".tokenized_autocompleter_container"))};return this.sharing_api.invite_more_to_folder(this.ns_id,g,e,d,b,c)};a.prototype.reinvite_user=function(d,b,c){var e=this;return this.sharing_api.reinvite_user(b,c,function(){var f;f=_("%(email_or_fbname)s was reinvited successfully");f=f.format({email_or_fbname:d});return Notify.server_success(f)})};a.prototype.update_sf_perms=function(e){var c,d,b,f=this;this.$root.find("#change-sf-perm-saving").show();c=(e?1:0);b=function(g){if(e){Notify.server_success(_("Members can now share this folder."))}else{Notify.server_success(_("Members can no longer share this folder."))}return f.$root.find("#change-sf-perm-saving").hide()};d=function(g){if(g.responseText.indexOf("err:")===0){Notify.server_error(g.responseText.substr(4))}else{Notify.server_error(_("Error updating your preference! Please try again."))}return f.$root.find("#change-sf-perm-saving").hide()};return this.sharing_api.update_sf_permissions(this.ns_id,c,b,d)};a.prototype.show_kick_user_modal=function(d,c,b){return DBModalStack.push(new KickUserModal(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:d,folder_path:this.path,user_id:b}))};a.prototype.show_kick_group_modal=function(b,c){return DBModalStack.push(new KickGroupModal(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:b,folder_path:this.path,group_id:c}))};a.prototype.show_transfer_user_modal=function(d,c,b){return DBModalStack.push(new TransferOwnershipModal(this.user,{element_id:"transfer-confirm-modal",user_id:b,user_name:d,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.show_uninvite_modal=function(d,b,c){return DBModalStack.push(new UninviteModal(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:d,ns_id:b,invite_id:c,folder_path:this.path}))};a.prototype.show_unshare_folder_modal=function(){return DBModalStack.push(new UnshareFolderModal(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.show_leave_folder_modal=function(){return DBModalStack.push(new LeaveFolderModal(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};a.prototype.toggle_to_invite_mode=function(){this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if(this.sf_access_type){return this.sf_access_type.show()}};a.prototype.toggle_from_invite_mode=function(){this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if(this.sf_access_type){return this.sf_access_type.hide()}};a.prototype.show_folder_settings=function(b){var c=this;b.preventDefault();DBModalStack.register(ExistingSharedFolderPermissionsModal.SAVED_PERMISSIONS,function(f,d){if(d!=null){return c.set_team_only(d)}});return DBModalStack.push(new ExistingSharedFolderPermissionsModal(this.user,this.path,this.ns_id))};a.prototype.show_email_verification=function(b){DBModalStack.pop();return EmailVerification.getForRole(this.user.role).show()};a.prototype.set_team_only=function(b){var c;this.invite_form_controller.set_team_only(b);c=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(b){return c.addClass("team-only")}else{return c.removeClass("team-only")}};return a})();LeaveFolderModal=(function(a){__extends(b,a);function b(){this.before_show=__bind(this.before_show,this);this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(d){var c,f=this;d.preventDefault();c=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,c,function(){var e;e=_("You removed yourself from '%(msg)s'.").format({msg:Util.filename(f.path).em_snippet(25)});Notify.server_success(e);document.fire(FileEvents.SF_LEAVE,{target_ns_id:f.ns_id,folder_deleted:!c,user_id:f.user.id});return DBModalStack.clear()})};b.prototype.on_show=function(){b.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};b.prototype.before_show=function(){var c;c=_("Leave the shared folder '%(folder_name)s'");c=c.format({folder_name:Util.filename(this.path).em_snippet(14)});return this.format({".db-modal-title-text":c})};return b})(SharedFolderBaseModal);UnshareFolderModal=(function(b){__extends(a,b);function a(){this.before_show=__bind(this.before_show,this);this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(d){var c,f=this;d.preventDefault();c=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,c,function(){var e;e=_("Unshared folder '%(folder_name)s'");e=e.format({folder_name:Util.filename(f.path).em_snippet(25)});Notify.server_success(e);document.fire(FileEvents.SF_UNSHARE,{target_ns_id:f.ns_id,user_id:f.user.id});return DBModalStack.clear()})};a.prototype.on_show=function(){a.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};a.prototype.before_show=function(){var c;c=_("Unshare '%(folder_name)s'");c=c.format({folder_name:Util.filename(this.path).em_snippet(21)});return this.format({".db-modal-title-text":c})};return a})(SharedFolderBaseModal);UninviteModal=(function(b){__extends(a,b);function a(c,d){this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.email_or_fbname=d.email_or_fbname;this.ns_id=d.ns_id;this.invite_id=d.invite_id;a.__super__.constructor.call(this,c,d)}a.prototype.on_confirm_button_click=function(c){var d=this;c.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,function(k){var i,j,h,e,g;g=_("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:d.email_or_fbname});try{h=JSON.parse(k.responseText);e=h.status;if(e==="OK"){Notify.server_success(g)}else{j=h.reason;if(j==="ACCEPTED"){i=_("That invitation has already been accepted.")}else{if(j==="DECLINED"){i=_("That invitation has already been declined.")}}Notify.server_error(i)}}catch(f){Notify.server_success(g)}return DBModalStack.pop()})};a.prototype.before_show=function(c){var d;d=_("Uninvite %(email_or_fbname)s from '%(folder_name)s'?").format({email_or_fbname:this.email_or_fbname.em_snippet(20),folder_name:Util.filename(this.path).em_snippet(13)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":Util.filename(this.path),".db-modal-title-text":d})};return a})(SharedFolderBaseModal);KickUserModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.user_id=d.user_id;this.user_name=d.user_name;b.__super__.constructor.call(this,c,d)}b.prototype.on_confirm_button_click=function(d){var c,f=this;d.preventDefault();c=this.$modal_window.find("#keep-files-check").prop("checked");return this.sharing_api.kick(this.ns_id,this.user_id,c,function(){Notify.server_success(_("User removed successfully."));return DBModalStack.pop()})};b.prototype.before_show=function(c){var d;d=_("Kick %(person_name)s out of %(folder_name)s?");d=d.format({person_name:this.user_name,folder_name:Util.filename(this.path).em_snippet(13)});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":d})};return b})(SharedFolderBaseModal);KickGroupModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.group_id=d.group_id;this.group_name=d.group_name;b.__super__.constructor.call(this,c,d)}b.prototype.on_confirm_button_click=function(d){var c,f=this;d.preventDefault();c=this.$modal_window.find("#keep-files-check").prop("checked");return this.sharing_api.kick_group(this.ns_id,this.group_id,c,function(){Notify.server_success(_("Group removed successfully."));return DBModalStack.pop()})};b.prototype.before_show=function(){var c;c=_("Kick %(group_name)s out of %(folder_name)s?");c=c.format({group_name:this.user_name,folder_name:Util.filename(this.path).em_snippet(13)});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":c})};return b})(SharedFolderBaseModal);TransferOwnershipModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.before_show=__bind(this.before_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.user_id=d.user_id;this.user_name=d.user_name;a.__super__.constructor.call(this,c,d)}a.prototype.on_confirm_button_click=function(c){var d=this;c.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,function(f){Notify.server_success(_("Ownership changed successfully"));return DBModalStack.pop()})};a.prototype.before_show=function(){var c;c=_("Make %(person_name)s the owner of this folder?");c=c.format({person_name:this.user_name.em_snippet(14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":c})};return a})(SharedFolderBaseModal);ExistingSharedFolderPermissionsModal=(function(b){__extends(a,b);a.SAVED_PERMISSIONS="existing_sf_permissions:saved";function a(d,e,c){var g,f;this.user=d;this.path=e;this.ns_id=c;g={ns_id:this.ns_id,folder_name:this.path};g[Constants.UID_PARAM_NAME]=this.user.id;f=_("'%(page_path)s' settings");f=f.format({page_path:this.path});a.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:f,endpoint_url:"/share_ajax/folder_settings",parameters:g})}return a})(DBModalLoading);ExistingSharedFolderPermissionsContent=(function(){function a(c,d,b){this.$form=c;this.ns_id=b;this._submit=__bind(this._submit,this);this.user=viewer.get_user_by_id(d);this.sharing_api=new SharingApi(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}a.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};a.prototype._cancel=function(){return DBModalStack.pop()};a.prototype._submit=function(d){var b,c,f=this;d.preventDefault();b=this.$form.find("input[name=audience]:checked").val();c=this.$form.find("input[name=inviter]:checked").val();this.sharing_api.update_sf_team_permissions(this.ns_id,b,c,function(g){var e,h;e=JSON.parse(g.responseText);h=e.team_only_invite;Notify.server_success(e.message);DBModalStack.trigger(ExistingSharedFolderPermissionsModal.SAVED_PERMISSIONS,h);return DBModalStack.pop()});return false};return a})();var BaseShareAFolderWizardModal,InlineModalValidationError,InviteToNewSharedFolderWizardModal,NewSharedFolderPermissionsContent,ShareAFolderWizardModal,ShareExistingFolderWizardModal,ShareNewFolderWizardModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};BaseShareAFolderWizardModal=(function(a){__extends(b,a);b.prototype.base_title=null;b.prototype.personal_title=null;b.prototype.work_title=null;function b(c,d){this.user=c;this.option=d;b.__super__.constructor.call(this,this.options);this.sharing_api=new SharingApi(this.user)}b.prototype.before_show=function(){var c;this.sharing_api.loading_elem=this.$modal_window;c=this.base_title;if(viewer.is_paired){if(this.user.role==="personal"){c=this.personal_title}else{c=this.work_title.format({team_name:viewer.team_name})}}return this.format({".db-modal-title-text":c})};return b})(DBModal);ShareAFolderWizardModal=(function(a){__extends(b,a);function b(c,d){this.user=c;this.options=d;b.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Share a folder");this.personal_title=_("Share a folder from your personal Dropbox");this.work_title=_("Share a folder from your %(team_name)s Dropbox")}b.prototype.on_show=function(){var c=this;this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",function(d){d.preventDefault();SharingModals.start_wizard_without_user();return c.hide()});return this.$modal_window.find("#new-or-existing-sf li").on("click",function(d){return $j(d.currentTarget).find('input[name="sf_type"]').prop("checked",true)})};b.prototype.on_confirm_button_click=function(g){var d,f,c,h=this;g.preventDefault();f=this.$modal_window.find("input#create-new-sf").is(":checked");if(f){c=new ShareNewFolderWizardModal(this.user,{element_id:"share-new-folder-wizard-modal"});this.hide();return c.show()}d=this.$modal_window.find(".ajax-loading-indicator").show();return $j.ajax({url:"/share_ajax/account_has_existing_folders",method:"post",subject_user:this.user,success:function(e){var i;e=JSON.parse(e);if(e===true){c=new ShareExistingFolderWizardModal(h.user,{element_id:"share-existing-folder-wizard-modal"})}else{i=_("You don't have any existing folders. Please create and share a new folder.");c=new ShareNewFolderWizardModal(h.user,{element_id:"share-new-folder-wizard-modal",error_msg:i})}h.hide();return c.show()},error:function(){return Notify.server_error()},complete:function(){return d.hide()}})};return b})(BaseShareAFolderWizardModal);InlineModalValidationError=(function(){function a(){}a.show_validation_error=function(i,e){var f,g,d,c,h,b;if(i.responseText.indexOf("err:{")===0){b=i.responseText.substr(4);h=JSON.parse(b);for(g in h){f=h[g];if("message_text" in f){c=e.find("span.error-message");if(c.length===0){c=$j("<span/>").addClass("error-message");e.prepend(c)}c.text(f.message_text);return}}e.find("span.error-message").remove();return Notify.server_error()}else{e.find("span.error-message").remove();if(i.responseText.indexOf("err:")===0){d=i.responseText.substr(4);return Notify.server_error(d)}else{return Notify.server_error()}}};return a})();ShareNewFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.options.focus="#new-shared-folder-name-input";a.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Create a new shared folder");this.personal_title=_("Create a shared folder in your personal Dropbox");this.work_title=_("Create a shared folder in your %(team_name)s Dropbox")}a.prototype.on_show=function(){var d,f,c,e,g=this;SickInput._create(this.$modal_window.find("#new-shared-folder-name-input-field")[0]);e=this.$modal_window.find(".suggestion-input");for(f=0,c=e.length;f<c;f++){d=e[f];SuggestionInput.register($(d))}this.$modal_window.find("#validate-folder-name").submit(function(h){h.preventDefault();return g.on_confirm_button_click(h)});if(this.options.error_msg){Notify.server_error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",function(h){h.preventDefault();SharingModals.start_wizard_for_user(g.user);return g.hide()})};a.prototype.on_confirm_button_click=function(f){var d,h,c,g=this;f.preventDefault();h=this.$modal_window.find("#new-shared-folder-name-input").val();c=function(){var e;e=new InviteToNewSharedFolderWizardModal(g.user,{folder_name:h,element_id:"invite-to-new-sf-wizard-modal-"+g.user.id});g.hide();e.new_folder=true;return e.show()};d=function(e){return InlineModalValidationError.show_validation_error(e,g.$modal_window.find("#new-shared-folder-name-input-field"))};return this.sharing_api.validate_new_sf_path(h,c,d)};return a})(BaseShareAFolderWizardModal);ShareExistingFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this._hide=__bind(this._hide,this);this.on_show=__bind(this.on_show,this);a.__super__.constructor.call(this,this.user,this.options);this.base_title=_("Choose folder to share");this.personal_title=_("Choose a folder from your personal Dropbox");this.work_title=_("Choose a folder from your %(team_name)s Dropbox")}a.prototype.on_show=function(){var c=this;this.treeview_id="copy-move-treeview";this.treeview_parent_id=$j("#"+this.treeview_id).parent().attr("id");TreeView.schedule_reset();TreeView.move(this.treeview_id,"share-existing-treeview",{onSuccess:(function(){var d;$j(document).on("db:treeview_selected",function(g,f){return c.folder_name=f});d=$j(".first-treeview-link");if(!Util.ie){return d.click()}}),user:this.user});return this.$modal_window.find("a.back").on("click",function(d){d.preventDefault();c.hide();return SharingModals.start_wizard_for_user(c.user)})};a.prototype._hide=function(){TreeView.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return a.__super__._hide.apply(this,arguments)};a.prototype.on_hide=function(){return $j(document).off("db:treeview_selected")};a.prototype.on_confirm_button_click=function(f){var d,c,g=this;f.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();return SharingModals.show_shared_folder_options_modal(this.folder_name,this.user)}else{c=function(){var e;e=new InviteToNewSharedFolderWizardModal(g.user,{folder_name:g.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+g.user.id});g.hide();e.new_folder=false;return e.show()};d=function(e){return InlineModalValidationError.show_validation_error(e,g.$modal_window.find("#choose-existing-folder"))};return this.sharing_api.validate_existing_sf_path(this.folder_name,c,d)}};return a})(BaseShareAFolderWizardModal);InviteToNewSharedFolderWizardModal=(function(b){__extends(a,b);function a(c,d){this.user=c;this.options=d;this.insert_folder_settings=__bind(this.insert_folder_settings,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.show_settings_modal=__bind(this.show_settings_modal,this);this.options.focus=".new-collab-input";a.__super__.constructor.call(this,this.options);this.sharing_api=new SharingApi(this.user);this.folder_name=this.options.folder_name;this.existing_folder=this.options.existing_folder}a.prototype.before_show=function(){var c;this.sharing_api.loading_elem=this.$modal_window;c=_("Share '%(folder_name)s' with others");c=c.format({folder_name:Util.filename(this.folder_name).em_snippet(16)});return this.format({".db-modal-title-text":c})};a.prototype.on_show=function(){var l,h,d,i,f,e,k,c,g,j=this;g=this.$modal_window.find(".suggestion-input");for(f=0,k=g.length;f<k;f++){d=g[f];SuggestionInput.register($(d))}h=this.$modal_window.find(".sf-invite-can-edit .can-edit-dropdown");for(e=0,c=h.length;e<c;e++){d=h[e];SharedFolderAccessType.register(d)}l=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){i="invite-wizard-"+this.user.id;this.invite_form_controller=new InviteFormController(this.user,l,i);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();return this.$modal_window.find(".change-new-folder-settings").on("click",function(m){m.preventDefault();return j.show_settings_modal()})};a.prototype.show_settings_modal=function(){var d,c,e=this;c=_("'%(folder_name)s' settings");c=c.format({folder_name:this.folder_name});d={folder_name:this.folder_name};if(this.audience_restriction){d.audience=this.audience_restriction}if(this.inviter_restriction){d.inviter=this.inviter_restriction}d[Constants.UID_PARAM_NAME]=this.user.id;DBModalStack.register(NewSharedFolderPermissionsContent.SAVED_PERMISSIONS,function(g,f){return e.insert_folder_settings(f.audience,f.inviter)});return DBModalStack.push(new DBModalLoading({element_id:"folder-permissions-modal",title:c,endpoint_url:"/share_ajax/default_folder_settings",parameters:d}))};a.prototype.on_confirm_button_click=function(h){var g,f,k,d,i,c,j=this;h.preventDefault();this.invite_form_controller.tokenize();k=this.invite_form_controller.extract_invitees();i=this.invite_form_controller.get_custom_message();g=this.invite_form_controller.get_access_type();d=this.$modal_window.find("input#allow_other_members_to_share");if(d.length>0){this.inviter_restriction=d.is(":checked")?"all":"me"}f=function(e){return InlineModalValidationError.show_validation_error(e,j.$modal_window.find(".tokenized_autocompleter_container"))};c=function(l){var e;e=JSON.parse(l.responseText);Notify.server_success(e.success_msg);document.fire(FileEvents.SF_NEW,{sf_info:Sharing.decode_sort_key(e.sf_info)});return j.hide()};return this.sharing_api.share_folder(this.new_folder,this.folder_name,k,i,this.audience_restriction,this.inviter_restriction,g,c,f)};a.prototype.insert_folder_settings=function(d,c){var e;this.audience_restriction=d;this.inviter_restriction=c;e=this.$modal_window.find(".invite-more-form,      .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return e.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return e.removeClass("team-only")}};return a})(DBModal);NewSharedFolderPermissionsContent=(function(){a.SAVED_PERMISSIONS="new_sf_permissions:saved";function a(b){this.$form=b;this._submit=__bind(this._submit,this);this._listen()}a.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};a.prototype._cancel=function(){return DBModalStack.pop()};a.prototype._submit=function(d){var b,c;d.preventDefault();b=this.$form.find("input[name=audience]:checked").val();c=this.$form.find("input[name=inviter]:checked").val();DBModalStack.trigger(a.SAVED_PERMISSIONS,{audience:b,inviter:c});return DBModalStack.pop()};return a})();var SharingShmodel;SharingShmodel=(function(){function a(){}a.shmodel_quicksend=function(d,b){var c;c=Browse.find_file(d);if(c){c.get_div().addClassName("shmodeled")}Notify.server_success(_("Sending\u2026"),null,null,null,null);return new UserlessSharingApi().shmodel_quicksend(d,[b.email],Browse.active_user,(function(){var e;e=SharingUtil.success_string_for_recipients([b.name&&b.name.length?b.name:b.email]);return Notify.server_success(e,null,null,null,null)}),(function(){var e;e=_("Failed to share link.");return Notify.server_error(e,null,null,null,null)}))};a.shmodel=function(e,d,g){var b,c,f;if(d==null){d=true}if(g==null){g=true}c=URI({path:"/sm/create"+e});f={};f[Constants.UID_PARAM_NAME]=Browse.active_user.id;f.show_shmodal=g?"1":"0";if(d){Forms.postRequest(c.toString(),f,{target:"_blank"});b=Browse.find_file(e);if(b){return b.get_div().addClassName("shmodeled")}}else{return Forms.postRequest(c.toString(),f)}};return a})();var Sharing;Sharing={init:function(g,f,b,d,c,a){var e=this;[g.current,g.past].each(function(h){return h.each(function(i){return e.decode_sort_key(i)})});this._state={sf_info:g,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{}};if(f){this.role_picker=$j("#role-selector").controller();this.role_picker.on_state_change=this._render.bind(this);MultiaccountLogin.set_during_login_callback(function(i,h){SharingState.set_not_logged_in_role_and_email(null,null);return e.reload_folder_info(function(){return h()},function(j){h(_("Error displaying shared folders"));return window.location.reload()})})}SharingState.set_is_merged(f);SharingState.set_not_logged_in_role_and_email(b,d);SharingState.set_team_name(c);SharingState.set_show_inbox(a);this.listen();this._tmpl=HTML.tmpl("sf_list_item_tmpl");this._render();this.refresh_inbox_counts(true);return $j("#sf-view").show()},decode_sort_key:function(a){assert((a.encoded_sort_key!=null)&&!(a.sort_key!=null),"expected encoded sort keys on each elm");a.sort_key=Util.decode_sort_key(a.encoded_sort_key);delete a.encoded_sort_key;return a},reload_folder_info:function(d,a){var c,b=this;c=function(e){var f;f=JSON.parse(e.responseText);b._state.sf_info=f;b._render();return typeof d==="function"?d():void 0};return new UserlessSharingApi().get_folder_info(c,a)},refresh_inbox_counts:function(a){var b=this;return new UserlessSharingApi().get_inbox_counts(function(c){return b.update_inbox_counts(c,a)})},update_inbox_counts:function(h,b){var g,i,j,a,d,e,f=this;e=0;for(a in h){g=h[a];e+=g}$j("#inbox-count").text(e);$j("#inbox-count").toggleClass("show",e>0);if(!this._state){return}i=function(k,c){var l;for(a in k){l=k[a];if(c[a]!==k[a]){return false}}return true};if((!b)&&this._state&&i(this._state.inbox_counts,h)){return}this._state.inbox_counts=h;if(e){j=new Element("a",{id:"new-invites-link",href:"#"});j.__sert(Sprite.make("web","email_32",{"class":"link-img"}));d=ungettext("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",e);d+=" \n";d=d.format({total_count:e});j.__sert(d);j.observe("click",function(c){Event.stop(c);return f.show_invites()});$("invites-box").show();$("invites-box").__date(j)}else{$("invites-box").hide()}if(e>0&&SharingState.show_inbox){SharingState.set_show_inbox(false);return this.show_invites()}},register_accept:function(a){var b=this;$j(a).closest(".sf-invite-action").addClass("loading");new UIRequest(a,a.action,{parameters:Forms.collect_form_vars(a),onComplete:function(){$j(a).closest(".sf-invite-action").removeClass("loading");b.refresh_inbox_counts();return b.reload_folder_info()},onSuccess:function(c){var d,g,f,h,e;f=(e=JSON.parse(c.responseText))!=null?e.data:void 0;d=$j(a).closest(".sf-invite-action");d.addClass("sf-accepted");if(f!=null?f.redirect:void 0){g=d.find(".view-folder-button");return g.click(function(){return window.location.href=f!=null?f.redirect:void 0})}else{h=$j(a).closest(".invitation-row").attr("data-invite-id");return b._remove_invite_row(h)}}});return false},register_decline:function(b,d){var a,c,e=this;a=$j(b).closest("form");if((c=a.closest(".sf-invite-action"))!=null){c.addClass("loading")}if(a.length){new UIRequest(a[0],a[0].action,{parameters:Forms.collect_form_vars(a[0]),onComplete:function(){var f;if((f=a.closest(".sf-invite-action"))!=null){f.removeClass("loading")}e._remove_invite_row(d);e.refresh_inbox_counts();return e.reload_folder_info()}})}return false},_remove_invite_row:function(e){var a,d,c,b;a=$j("#invites-container");d=a.find('[data-invite-id="'+e+'"]');if(d){b=d.parent("tbody");d.remove();if(b.children().length===0){a.find(".invitation-table-container").hide();a.find(".message-bottom").removeClass("message-bottom");a.find(".message-top").removeClass("message-top");if(a.find(".invites-message").length===0){c=DBModal.get_containing_modal(a);return c!=null?c.hide():void 0}}}},listen:function(){var c,b,a,d=this;this.listen_modals();c=function(f,o,j){var k,e,n,m,l,q,g,p,h;h=d._get_current_sf_list_info(j),m=h[0],n=h[1];assert(o,"SF _transfer w/o target_ns_id");for(k=g=0,p=m.length;g<p;k=++g){e=m[k];if(e.target_ns_id===o&&e.user_id===f){l=e;q=k;break}}assert(q!=null,"SF _transfer w/o js obj");return[l,q]};a=function(k,p,m){var n,l,q,o,j,g,i,h,f;i=d._get_current_sf_list_info(p),n=i[0],g=i[1];h=d._get_current_sf_list_info(m),o=h[0],j=h[1];f=c(k.memo.user_id,k.memo.target_ns_id,p),l=f[0],q=f[1];n.splice(q,1);d._empty_check(p);if(k.memo.filename!=null){l.filename=k.memo.filename}o.push(l);return d._render()};b=function(k,h){var m,j,l,g,i,f;i=d._get_current_sf_list_info(h),m=i[0],g=i[1];f=c(k.memo.user_id,k.memo.target_ns_id,h),j=f[0],l=f[1];m.splice(l,1);return d._render()};document.observe(FileEvents.SF_UNSHARE,function(f){return b(f,"#sf-current")});document.observe(FileEvents.SF_LEAVE,function(f){return a(f,"#sf-current","#sf-past")});document.observe(FileEvents.SF_REJOIN,function(f){return a(f,"#sf-past","#sf-current")});document.observe(FileEvents.SF_IGNORE,function(f){return b(f,"#sf-past")});document.observe(FileEvents.SF_NEW,function(g){var f;f=g.memo.sf_info;assert(f,"SF_NEW without info");d._state.sf_info.current.push(f);return d._render()});$("create-share").observe("click",function(f){Event.stop(f);return SharingModals.start_wizard_without_user()});if($("new-invites-link")){$("new-invites-link").observe("click",function(f){Event.stop(f);return d.show_invites()})}return $j("#sf-current, #sf-past").each(function(e,f){var g;g=["#sf-current","#sf-past"][e];$j(".sf-list",f).on("click","a.options-link",function(n){var l,k,h,i,m,j;n.preventDefault();l=$j(n.target).closest("a.options-link");h=l.attr("data-type");k=l.attr("data-mount");m=parseInt(l.attr("data-nsid"),10);j=viewer.get_user_by_id(l.attr("data-user_id"));i=$j(n.target).closest("li.sf-folder").data("role");if(i!=null){SharingState.set_role(i)}if(h==="normal"){return SharingModals.show_shared_folder_options_modal(k,j)}else{if(h==="remove"){return SharingModals.show_ignore_modal(j,k,m)}else{if(h==="rejoin"){return SharingModals.show_rejoin_modal(j,k,m)}}}});$j(".sf-sort",f).on("click","a.sort-option",function(j){var i,h,k;j.preventDefault();i=$j(j.target).closest("a.sort-option");k={SF_BY_NAME:d._name_cmp,SF_BY_MODIFIED:d._modified_cmp};h=k[i.attr("data-sort")];if(d._state.cmp[g]===h){d._state.is_ascending[g]=!d._state.is_ascending[g]}else{d._state.cmp[g]=h;d._state.is_ascending[g]=true}Util.add_sort_arrow_mouseover_j(i,d._state.is_ascending[g],g+" .sf-sort a.sort-option",true);return d._render_list_id(g)});return Util.add_sort_arrow_mouseover_j($j(".modified-sorter",f),d._state.is_ascending[g],g+" .sf-sort a.sort-option",false)})},listen_modals:function(){var a=this;return $j("#new-or-existing-sf li").click(function(c){var b;$j("#new-or-existing-sf li").removeClass("active");b=$j(c.target).closest("li");b.find("input").prop("checked",true);return b.addClass("active")})},_render:function(){this._render_list_id("#sf-current");this._render_list_id("#sf-past");if($j("#sf-current").hasClass("empty-list")&&$j("#sf-past").hasClass("empty-list")){$j("#page-content").addClass("no-shares");return $j("#empty-content").show()}else{$j("#page-content").removeClass("no-shares");return $j("#empty-content").hide()}},_render_list_id:function(c){var j,h,i,f,g,e,a,k,b,d=this;b=this._get_current_sf_list_info(c),f=b[0],i=b[1];j=function(l,n){var m;m=d._state.is_ascending[c]?1:-1;return m*d._state.cmp[c](l,n)};f.sort(j);g=$j(".sf-list",c);g.empty();for(a=0,k=f.length;a<k;a++){e=f[a];if(this._should_render(e)){h=this._tmpl({options_str:_("Options"),remove_str:_("Remove"),rejoin_str:_("Rejoin"),is_past:i,sf:e});g.append(h.toHTML())}}return this._empty_check(c)},_should_render:function(a){if(this.role_picker!=null){return this.role_picker.is_role_visible(a.role)}else{return true}},_empty_check:function(d){var c,a,b;b=this._get_current_sf_list_info(d),c=b[0],a=b[1];if($j(".sf-list",d).children().length){return $j(d).removeClass("empty-list")}else{return $j(d).addClass("empty-list")}},_get_current_sf_list_info:function(a){switch(a){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return assert(false,"invalid sf list id")}},_name_cmp:function(a,b){return Util.sort_by_rank_or_key(a,b)},_modified_cmp:function(a,b){return a.modified_ts-b.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){return SharingModals.show_invites()}};var autoCompleteDiv,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(c,d,b,j){var i,a,g,h,f,e=this;this.user=c;this.baseInitialize(d,b,j);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;a=this.options.include_fb===true;if(!(this.options.include_team!=null)){this.options.include_team=true}f=this.options.include_team===true;g=this.options.include_groups===true;h=this.options.include_me===true;this.contacts_importer=get_contacts_importer({user:this.user,on_update_services:this.update_import_contacts_link.bind(this),hide_containing_modal:this.hide_containing_modal.bind(this),show_containing_modal:this.show_containing_modal.bind(this)});this.update_import_contacts_link();this.contacts_importer.on_open_auth_popup=this.contact_importer_unshow.bind(this);this._autocompleter_contact_import_item_tmpl=HTML.tmpl("autocompleter_item_tmpl");this.listen();i=function(k){k=k.includeForUser(e.user.id);if(e.options.contact_filter){k=e.options.contact_filter(k)}else{if(!a){k=k.excludeFacebook()}if(!g){k=k.excludeGroups()}if(!f){k=k.excludeTeamMembers()}if(!h){k=k.excludeMe()}}return e.setContacts(k)};(function(){var k;return DefaultContactsCache.load_contacts(k=false,function(l){i(l);return DefaultContactsCache.register_for_updates(i)})}).defer();return this.options.onShow=function(k,l){if(!l.style.position||l.style.position==="absolute"){l.style.position="absolute";$j(l).clonePosition($j(k),{setHeight:false,setTop:false,setLeft:false})}return $j(l).fadeIn(150)}},getToken:function(){var a;a=this.getTokenBounds();return this.element.value.substring(a[0],a[1])},listen:function(){return this.install_contact_importer_listener()},install_contact_importer_listener:function(){var a,b=this;Event.stopObserving(this.element,"blur");a=function(c){var d;if(!$j(c.target).hasClass("import-contacts-link")){if(b.contact_importer_currently_showing()){return b.contact_importer_unshow()}else{return(d=b.get_entry_container())!=null?d.hide():void 0}}};$j(this.element).closest(".db-modal-box").click(a);$j(this.element).closest("#modal-box").click(a);return $j(this.element).closest("form").find(".import-contacts-link").click(this.contact_importer_toggle.bind(this))},get_entry_container:function(){var a;return(a=this.element.up(".tokenized_autocompleter_container"))!=null?a.down(".autocomplete"):void 0},contact_importer_currently_showing:function(){var b,a;b=this.get_entry_container();if((b!=null)&&b.style.display!=="none"){if(((a=b.firstChild.firstChild)!=null?a.value:void 0)===0){if(b.firstChild.children.length>1){return true}}}return false},contact_importer_show:function(){var c,b,a,d;c=this.get_entry_container();if(((b=c.firstChild)!=null?(a=b.firstChild)!=null?a.value:void 0:void 0)>0){this.old_display=c.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.contact_importer_render_buttons();if((d=$("flash_copy_container"))!=null){d.hide()}return this.element.focus()},contact_importer_unshow:function(){var a;this.hasFocus=true;this.changed=false;this.updateChoices(this.old_contents);this.get_entry_container().style.display=this.old_display;return(a=$("flash_copy_container"))!=null?a.show():void 0},contact_importer_toggle:function(){if(this.contact_importer_currently_showing()){return this.contact_importer_unshow()}else{return this.contact_importer_show()}},contact_importer_render_buttons:function(){var e,b,d,a,c;b=[];c=ThirdParty.contact_services();for(d=0,a=c.length;d<a;d++){e=c[d];assert(this.contacts_importer.connected_services!=null,"connected_services has not been set");b.push(this._autocompleter_contact_import_item_tmpl({email_provider_num:e,email_provider_img:ThirdParty.to_img(e),email_provider_name:ThirdParty.to_name(e),bottom_text:this.contacts_importer.connected_services[e]?_("Connected"):"",is_suggestion:0}).toHTML())}this.hasFocus=true;return this.updateChoices("<ul>"+(b.join(""))+"</ul>")},update_import_contacts_link:function(){if(this.contacts_importer.has_unconnected_services()){return $j(this.element).closest("form").find(".import-contacts-link").show()}else{return $j(this.element).closest("form").find(".import-contacts-link").hide()}},hide_containing_modal:function(){this.$hidden_modals=$j(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=$j("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(a){this.options.array=a.contacts;this.options.larray=a.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){var a=this;this.updateChoices(this.options.selector());$j(".autocomplete-item-cancel-button").off();return $j(".autocomplete-item-cancel-button").on("click",(function(b){b.stopPropagation();a.contacts_importer.suggestions_enabled=false;a.getUpdatedChoices();return new Ajax.DBRequest("/contacts/turn_off_importer_suggestions",{subject_user:a.user})}))},selectEntry:function(){var c,b,a;b=this.getCurrentEntry();c=this.options.array[b.value];if(c.type===ContactTypes.FB){b.innerHTML=c.name}else{b.innerHTML=c.email}if(this.options.tokens.length>1){a=this.options.tokens[0]+" "}else{a=""}b.innerHTML+=a;this.active=false;this.updateElement(b);return $(this.element).fire("db:autocompleted")}},autoCompleteDiv=function(a,b){var c;c=$j("<div>");c.addClass(a);if(typeof b==="string"||b instanceof String){c.text(b)}else{c.append(b)}return c},{setOptions:function(b){var a,c=this;if(b==null){b={}}a={choices:5,selector:function(){var L,o,I,F,u,G,f,N,g,s,t,E,A,B,m,k,q,j,n,z,J,v,y,C,i,w,x,H,h,D,e,d,K,M,r;x=$j("<ul>");f=c.getToken().toLowerCase();A=c.options.array.length;I=c.options.choices;L=c.options.array;B=c.options.larray;w=[];if(f.indexOf(" ")===-1){w.push("\\s+")}if(f.indexOf("+")===-1){w.push("\\+")}if(f.indexOf("@")===-1){w.push("@")}if(f.indexOf(".")===-1){w.push("\\.")}if(f.indexOf("&lt;")===-1){w.push("&lt;")}i=RegExp("("+w.join("|")+")");t=0;while(t<A&&x.children().length<I){G=L[t];q=B[t];N=-1;u=[];z=[];s="";switch(G.type){case ContactTypes.EMAIL:u.push(G.name,G.email);z.push(q.name,q.email);s="/static/images/icons/mail28.png";break;case ContactTypes.FB:u.push(G.name);z.push(q.name);if(Sharing.use_fb_profile_pics){s="https://graph.facebook.com/"+q.fb_id+"/picture"}else{s="/static/images/icons/fb24.png"}break;case ContactTypes.USER_GROUP:u.push(G.name,G.members);z.push(q.name,"");s="/static/images/icons/groupicon_large.png";break;default:assert(false,"should never get here due to type: "+G.type+", "+G.name+", "+G.email+", "+G)}for(E=e=0,K=z.length;e<K;E=++e){n=z[E];y=w.length?n.split(i):[n];F=0;for(d=0,M=y.length;d<M;d++){v=y[d];if(!v){continue}if(v.indexOf(f)===0){N=F;break}F+=v.length}if(N!==-1){m=document.createTextNode(u[E].substr(0,N));J=$j("<strong>").text(u[E].substr(N,f.length));H=document.createTextNode(u[E].substr(N+f.length));u[E]=[m,J,H];break}}if(G.type===ContactTypes.FB){u.push(_("Facebook message"))}if(N!==-1){g=$j('<img width="28px" height="28px">').attr("src",s);C=autoCompleteDiv("autocomplete-line",u[0]);D=autoCompleteDiv("autocomplete-line autocomplete-secondary",u[1]);k=autoCompleteDiv("autocomplete-left",g);h=autoCompleteDiv(null,[C,D]);j=$j("<li>").attr("value",t).append(k,h);x.append(j)}t++}if(r=c.contacts_importer.contacts_to_import,__indexOf.call(ThirdParty.contact_services(),r)>=0){if(!c.contacts_importer.connected_services[c.contacts_importer.contacts_to_import]){if(!b.suggestions_disabled){if(c.contacts_importer.suggestions_enabled){x.append(c._autocompleter_contact_import_item_tmpl({email_provider_num:c.contacts_importer.contacts_to_import,email_provider_img:ThirdParty.to_img(c.contacts_importer.contacts_to_import),email_provider_name:_("Import your %(email_provider_name)s contacts").format({email_provider_name:ThirdParty.to_name(c.contacts_importer.contacts_to_import)}),bottom_text:_("Easily share with friends, family or coworkers"),is_suggestion:1}).toHTML())}}}}o=x.wrap("<span>").parent().html();c.old_contents=o;return o}};return this.options=Object.extend(a,b)}});var Token;Token=Class.create({initialize:function(b,a,c,d){this.element=$(b);this.token_manager=c;this.hidden_input=a;this.element.token=this;this.selected=false;this.info=d;return $j(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var a;this.token_manager.token=this;if((a=this.hidden_input)!=null){a.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(a){if(a&&a.preventDefault){a.preventDefault()}if(this.detect(a)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(a){return this.token_manager.remove(this)},detect:function(d){var b,c,a;c=d.target?d.target:d.srcElement;a=c.token;b=c;while(!(a!=null)&&b.parentNode){b=b.parentNode;a=b.token}return(a!=null)&&a.element===this.element}});var TokenManager;TokenManager=Class.create({initialize:function(b,c,a){this.shift_boundary_right_func=c;this.shift_boundary_left_func=a;this.element=b;this.tokens=[];return this.token=null},add:function(a){this.tokens.push(a);return this.element.fire("token:add",a.info)},populate:function(){var g,c,e,d,f,b,a;d=this.element.select(".token");a=[];for(f=0,b=d.length;f<b;f++){e=d[f];g=e.hasClassName("token-warn");c=new Token(e,null,this,{external:g});a.push(this.add(c))}return a},remove:function(b){var a;if(!(b!=null)){b=this.token}if(b!=null){a=this.tokens.indexOf(b);this.tokens.splice(a,1);b.element.remove();if(this.token===b&&a<this.tokens.length){this.tokens[a].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",b.info)}},removeAll:function(){var b,d,a,c;c=this.tokens;for(d=0,a=c.length;d<a;d++){b=c[d];b.element.remove();this.element.fire("token:remove",b.info)}return this.tokens.clear()},shift_left:function(){var a;a=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(a>0){if(this.token){this.token.deselect()}return this.tokens[a-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var a;a=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(a+1<this.tokens.length){return this.tokens[a+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var HiddenInput;HiddenInput=Class.create({initialize:function(a,c,b){this.element=$(a);this.auto_complete_element=c;this.token_manager=b;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(a){switch(a.keyCode){case Event.KEY_LEFT:a.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var __indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,a,d,f,c,b){var e;$super(a,d,f,b);this.token_manager=new TokenManager(this.element,this.generate_shift_boundary_right_func());this.hidden_input=new HiddenInput(c,this.element,this.token_manager);if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){$j(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(g,h){$j(h).clonePosition($j(g.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return h.show()};this.options.onHide=function(g,h){return h.hide()};if(DBHistory.get_url().indexOf("/referrals")!==-1){e=$j("#retrieve-contacts-button")}else{e=$j(this.element).closest("form").find(".tokenizer-submit-button")[0]}$j(e).on("mousedown",this.beforeSubmit.bindAsEventListener(this));$j(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!b.hide_import_contacts){this.import_links=$j(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onBlur:function($super,a){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(a)},onFocus:function(a){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(a){return this.tokenize_emails_input(true)},clearTokens:function(a){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getEmails:function(){var b,a;b=$j(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push($j(a).val())}return c})()).join(", ")},check_populated:function(){var b,a;b=$(this.element.parentNode);a=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(b.hasClassName("populated")&&a){return b.removeClassName("populated")}else{if(!b.hasClassName("populated")&&!a){return b.addClassName("populated")}}},clean_email_addr:function(e,c){var b,d,a;for(d=0,a=e.length;d<a;d++){b=e[d];c=c.sub(b,"")}return c.strip()},get_regexp_from_delimiters:function(e){var b,d,c,a;d="";for(c=0,a=e.length;c<a;c++){b=e[c];d+=b+"|"}return new RegExp("["+d+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(d,c,a){var b;b=true;if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}if(!d&&c){d=c.toString()}return{display:d,value:c,type:a,valid:b}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(b){var a,c;a=b.match(this.COMPOUND_EMAIL_REGEX);if(a){c=this.createTokenInfo(a[0],a[2],ContactTypes.EMAIL);return c}return null},tokenize_emails_input:function(j,e){var o,i,f,n,c,p,m,l,g,t,h,d,b,a,q,s,r,k;i=this.options.tokens;l=this.get_regexp_from_delimiters(i);if(this.options.single_token){n=[this.element.value]}else{n=this.element.value.split(l)}t="";if(!j){t=n[n.length-1];m=this.clean_email_addr(i,t);n=n.slice(0,n.length-1);if((k=t[t.length-1])===" "||k===">"){if(m.match(this.COMPOUND_EMAIL_REGEX)||Util.validate_email(m)){n.push(m);t=""}}}o=false;h=[];if(n.length>0){for(d=0,q=n.length;d<q;d++){f=n[d];g=this.parse_compound_email(f);if(g!=null?g.valid:void 0){o=true;this.set_input_size(1);this.addContact(g)}else{h.push(f)}}}n=h;if(!this.options.single_token){p=[];for(b=0,s=n.length;b<s;b++){f=n[b];p.push.apply(p,f.split(" "))}n=p}if(n.length>0){for(a=0,r=n.length;a<r;a++){f=n[a];f=this.clean_email_addr(i,f);if(f){g=this.createTokenInfo(f,f,ContactTypes.EMAIL);if(g.valid){o=true}else{if(e){continue}}this.set_input_size(1);this.addContact(g)}}}if(this.element.value!==t){this.element.value=t}c=this.element.up("form");if(o){Forms.clear_errors(c)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var b,a;b=this.element;a=function(){return b.focus()};return a},set_input_size:function(a){if(!(a!=null)||a<0){a=20}return this.element.setStyle({width:""+a+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var k,p,f,d,s,g,m,o,l,i,e,j,n,c,a,q,r,h,b;l=$(this.element.parentNode.parentNode);i=parseInt(l.getStyle("width"),10)-15;s=i;k=$j(".import-contacts-link",l.parentNode);if(k.length>0){s-=k.width()}j=this.token_manager.tokens;g=false;n=0;for(c=0,q=j.length;c<q;c++){e=j[c];d=e.element;f=parseInt(d.getStyle("width"),10)+parseInt(d.getStyle("margin-right"),10);o=n+f;if(o>i){n=f;g=true}else{if(f>i){n=0;g=true}else{n=o}}}m=s-n;p=this.element.value.length*7;if(p>m){m=i}this.set_input_size(m);if(this.import_links.length&&this.import_links_visible){if(g||i-n-p<1.25*this.import_links_width){this.import_links_visible=false;h=this.import_links;b=[];for(a=0,r=h.length;a<r;a++){d=h[a];b.push($j(d).fadeOut(100))}return b}}},onKeyPress:function(b){var c,a;this.dynamically_resize_input();if(this.active){switch(b.keyCode){case 44:case 188:case 59:case 186:this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();Event.stop(b);return}this.selectEntry();this.hide();this.active=false;Event.stop(b);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(b);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(b);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(b);return}}else{this.tokenize_emails_input(false);if(b.keyCode===Event.KEY_TAB||b.keyCode===Event.KEY_RETURN){if(this.element.value&&b.preventDefault){b.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((c=b.keyCode)===Event.KEY_LEFT||c===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((a=b.keyCode)===Event.KEY_LEFT||a===Event.KEY_RIGHT||a===Event.KEY_UP||a===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var b,c,f,e,a,d;if(this.active){f=this.element.value;d=this.options.tokens;for(e=0,a=d.length;e<a;e++){b=d[e];c=f.indexOf(b);if(c!==-1){if(this.selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=f.substr(0,c);this.selectEntry();this.hide();this.active=false;this.element.value=f.substr(c+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},selected_contact_importer_entry:function(a){var b;if(a==null){a=this.getCurrentEntry()}return a.value===0&&((b=a.id)!=null?b.length:void 0)!==0},selectEntry:function(){var c,b,f,a,d,e;b=this.getCurrentEntry();if(this.selected_contact_importer_entry(b)){f=b.id.split("_")[0];assert(parseInt(f,10)<0,"The 'id-value' of an autocompleter-entry being <0 signifies that it's a contact-importer button");d=ThirdParty.to_name(f);if(this.contacts_importer.connected_services[f]){Notify.server_success(_("You're already connected to %(service_name)s").format({service_name:d}));return}if(__indexOf.call(ThirdParty.contact_services(),f)>=0){if($j(b).attr("suggestion")==="1"){return this.contacts_importer.auth_import(f,"suggestion")}else{return this.contacts_importer.auth_import(f)}}else{return assert(false,"Should never get here. entry_value: "+f)}}else{c=this.options.array[b.value];a=c.type===ContactTypes.FB?c.fb_id:c.type===ContactTypes.USER_GROUP?c.group_id:c.email;this.set_input_size(1);e=this.createTokenInfo(c.name.strip(),a,c.type);this.addContact(e);Forms.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}},addContact:function(b){var d,m,n,e,j,c,k,a,g,l,i,p,f,o,h;this.element.value="";switch(b.type){case ContactTypes.FB:j="fb_ids";n=new Element("img",{src:"/static/images/icons/fb_16.png"});break;case ContactTypes.EMAIL:j="emails";n=new Element("img",{src:"/static/images/icons/email_16.png"});break;case ContactTypes.USER_GROUP:j="group_ids";n=new Element("img",{src:"/static/images/icons/groupicon_small.png"});break;case ContactTypes.INVALID:j="invalids";n=new Element("span",{"class":"hidden"});break;default:assert(false,"should never get here due to type: "+b.type)}k=this.getTokenClass(b);p=new Element("span",{"class":"x "+k,onmouseout:"this.className='x "+k+"'",onmouseover:"this.className='x_hover "+k+"'",onclick:"this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(event); return false;"}).__date(" ");g=new Element("input",{type:"hidden",name:j,value:b.value.toString()});c=new Element("a",{"class":"title_bubble token "+k,href:"#",tabindex:"-1",title:b.value});e=new Element("span");if(this.options.wrap_name){l=new Element("div",{"class":"token-display-text"});l.__sert(b.display);a=l;d=1}else{a=b.display;d=0}h=[g,n,a,p];for(f=0,o=h.length;f<o;f++){m=h[f];e.__sert(m)}c.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(e))));$(c).down(5).next(d).innerHTML="&nbsp;";i=new Token(c,this.hidden_input,this.token_manager,b);this.token_manager.add(i);return this.element.up().__sert({before:c})},getTokenClass:function(a){if(!a.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,a,d,e,c,b){$super(a,d,e,c,b);this.warn_only=!b.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));return this.element.observe("token:add",this.notifyExternal.bind(this))},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(a){this.warn_only=!a;return this.reloadContacts()},reloadContacts:function(){var a,b=this;return DefaultContactsCache.load_contacts(a=false,function(c){return b.setContacts(c)})},setContacts:function($super,e){var a,d,b,c;this.team_contacts={};this.team_contacts[viewer.work_email]=1;e=e.sortByTeamFirst();c=e.contacts;for(d=0,b=c.length;d<b;d++){a=c[d];if(a.team){this.team_contacts[a.email]=1}}if(!this.warn_only){e=e.excludeNonTeam()}return $super(e)},createTokenInfo:function(e,c,a){var f,d,b;b=true;f=false;if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}else{if(a===ContactTypes.EMAIL&&!this.team_contacts[c]){b=this.warn_only;f=true}else{if(a===ContactTypes.FB){b=this.warn_only;f=true}}}if(!e&&c){e=c.toString()}return d={display:e,value:c,type:a,valid:b,external:f}},getTokenClass:function(a){if(!a.valid){return"token-error"}if(a.external){return"token-warn"}return"token-valid"},notifyExternal:function(b){var a,c,d;d=b.memo;if(d.external){c=this.token_manager.tokens.filter(function(e){return e.info.external});a=c?c.length:0;return this.element.fire("sf:token:external",{count:a})}}});var TeamSharedFolderInviteController;TeamSharedFolderInviteController=(function(){function a(b){var c;this.element=$(b[0]);c=this.element.down(".new-collab-input");c.observe("sf:token:external",this.handle_external.bind(this))}a.prototype.handle_external=function(c){var b,d;b=c.memo.count;d=this.element.down(".external-invite-message");if(b>1){DomUtil.fillVal(b,"external-invite-num");if(d!=null){d.removeClassName("single")}return d!=null?d.show():void 0}else{if(b===1){if(d!=null){d.addClassName("single")}return d!=null?d.show():void 0}else{return d!=null?d.hide():void 0}}};return a})();var TeamExternalShareConfirm;TeamExternalShareConfirm=(function(){function a(c){var b;this.root=$(c[0]);b=this.root.down(".token-container");this.token_manager=new TokenManager(b);this.token_manager.populate();b.observe("token:remove",this.remove.bind(this))}a.prototype.remove=function(d){var c,e,b;if(!this.token_manager.tokens.length){return this.root.addClassName("no-recipients")}else{if(d.memo.external){e=this.token_manager.tokens.filter(function(f){return f.info.external});c=e?e.length:0;b=this.root.down(".external_prompt");if(c===0){return b.hide()}else{if(c===1){return b.addClassName("single")}else{return DomUtil.fillVal(c,"external_member_count")}}}}};return a})();var Links;Links={SNIPPET_LENGTH:30,THUMBS_BATCH_SIZE:16,_tmpl:null,init:function(a){this.decodeLinks(a);this._state={links:a,cmp:this._created_cmp,is_ascending:false};this.listen();this._tmpl=HTML.tmpl("links_list_item_tmpl");return this._render()},decodeLinks:function(c){var d,e,b,a;a=[];for(e=0,b=c.length;e<b;e++){d=c[e];assert(d.encoded_sort_key&&!(d.sort_key!=null),"expected encoded sort key on each elm");d.sort_key=Util.decode_sort_key(d.encoded_sort_key);a.push(delete d.encoded_sort_key)}return a},setLinks:function(a){this._state.links=a;return this._render()},listen:function(){var a,b=this;$("links-view").on("click","a.remove-link",function(k,f){var d,g,j,i,h,c;Event.stop(k);d=f.readAttribute("data-filename");h=f.readAttribute("data-tkey");i=parseInt(f.readAttribute("data-is-dir"),10);g=parseInt(f.readAttribute("data-is-album"),10);j=false;c=f.readAttribute("data-uid");return SharingModel.confirm_remove(d,h,i,g,j,c)});document.observe(FileEvents.LINKS_REMOVE,function(k){var g,h,d,l,f,j,c;f=k.memo.token;d=b._state.links;assert(f,"LINKS_REMOVE without token");for(g=j=0,c=d.length;j<c;g=++j){h=d[g];if(h.tkey===f){l=g}}assert(l!=null,"LINK_REMOVE w/o DOM elm");d.splice(l,1);$$("#links-list li.link")[l].remove();return b._empty_check()});a="#links-sort a.sort-option";$("links-sort").on("click","a.sort-option",function(f,d){var c,g;Event.stop(f);g={LINKS_BY_NAME:b._name_cmp,LINKS_BY_CREATED:b._created_cmp};c=g[d.readAttribute("data-sort")];if(b._state.cmp===c){b._state.is_ascending=!b._state.is_ascending}else{b._state.cmp=c;b._state.is_ascending=true}Util.add_sort_arrow_mouseover(d,b._state.is_ascending,a,true);return b._render()});return Util.add_sort_arrow_mouseover($("created-sorter"),this._state.is_ascending,a,false)},_render:function(){var f,b,g,i,a,d,c,h,e=this;f=function(j,l){var k;k=e._state.is_ascending?1:-1;return k*e._state.cmp(j,l)};b=[];i=this._state.links;i.sort(f);for(c=0,h=i.length;c<h;c++){g=i[c];if(g.is_album){d=_("Unshare album")}else{d=_("Remove")}b.push(this._tmpl({link:g,remove_str:d}))}$("links-list").__date(b);a=function(j){if(!j.src.endsWith(Sprite.SPACER)){return j.addClassName("thumbnail")}};BatchThumbLoader.batch_load_thumbs($$("#links-list img"),this.THUMBS_BATCH_SIZE,a);this._empty_check();return $j("#links-view").show()},_empty_check:function(){var b,a,e,d,c;if(this._state.links.length){$("no-created-links").hide();$("links-view").removeClassName("empty-list");return $j("#page-content").removeClass("no-links")}else{$("no-created-links").show();$("links-view").addClassName("empty-list");if((typeof MergedLinks!=="undefined"&&MergedLinks!==null?(b=MergedLinks.links)!=null?(a=b.personal)!=null?a.length:void 0:void 0:void 0)||(typeof MergedLinks!=="undefined"&&MergedLinks!==null?(e=MergedLinks.links)!=null?(d=e.work)!=null?d.length:void 0:void 0:void 0)){return}if(typeof RecentLinks!=="undefined"&&RecentLinks!==null?(c=RecentLinks.links)!=null?c.length:void 0:void 0){return}return $j("#page-content").addClass("no-links")}},_name_cmp:Util.sort_by_rank_or_key,_created_cmp:function(a,b){return a.created_ts-b.created_ts}};var RecentLinks;RecentLinks={YOUR_LINKS:0,RECENT_LINKS:1,SNIPPET_LENGTH:30,THUMBS_BATCH_SIZE:16,_tmpl:null,init:function(a){this.links=a;this._toggle_loading();this._tmpl=HTML.tmpl("recent_links_list_item_tmpl");this._listen();if(!HTML5_HISTORY&&!window.location.hash){this._history_change(null)}return $j("#no-recent-links").css("display","")},_history_change:function(a,b){if(a==="visited"){return $j("#page-content").removeClass("your-links").addClass("recent-links")}else{return $j("#page-content").removeClass("recent-links").addClass("your-links")}},_toggle_loading:function(){return $j("#recent-links-content").toggleClass("loading")},_listen:function(){$j("#links-filter").change(this._links_filter_change.bind(this));DBHistory.add_callback("/links",$j.proxy(this._history_change,this));return $j(document.body).on("click","#recent-links-list .remove-recent-link",$j.proxy(this._do_remove,this))},_links_filter_change:function(a){var b;a.preventDefault();b=parseInt(a.target.value);if(b===this.YOUR_LINKS){return DBHistory.push_state("/links/your_links")}else{return DBHistory.push_state("/links/visited")}},_render:function(a){var c,d,f,e,b;this.links=a;if(!a.length){$j("#recent-links-content").addClass("empty-list")}else{$j("#links-view").removeClass("no-links");$j("#recent-links-content").removeClass("empty-list")}c=[];for(e=0,b=a.length;e<b;e++){d=a[e];c.push(this._tmpl({link:d}))}c=$j.map(c,function(g){return g.toHTML()});$j("#recent-links-list").html(c.join(""));f=function(g){if(!g.src.endsWith(Sprite.SPACER)){return g.addClassName("thumbnail")}};BatchThumbLoader.batch_load_thumbs($$("#recent-links-list img"),this.THUMBS_BATCH_SIZE,f);return $j("#recent-links-content").removeClass("loading")},_do_remove:function(f){var c,a,d,b,g=this;f.preventDefault();a=$j(f.currentTarget);d=a.attr("data-tkey");c=a.closest(".link");b=c.data("uid");return new Ajax.DBRequest("/links/remove_recent_link",{subject_user:b,parameters:{tkey:d},onSuccess:function(h){var e;Notify.clear_all();e=c.attr("title").em_snippet(g.SNIPPET_LENGTH);switch(h.responseText.strip()){case"OK":Notify.server_success(_("Removed '%(filename)s.'").format({filename:e}));return g._remove_link_elm(c);case"INVALID":Notify.server_error(_("'%(filename)s' has already been removed.").format({filename:e}));return g._remove_link_elm(c);default:return Notify.server_error(_("There was a problem removing '%(filename)s.'").format({filename:e}))}}})},_remove_link_elm:function(a){a.remove();if($j("#recent-links-list .link").length===0){return $j("#recent-links-content").addClass("empty-list")}}};var SharingModel;SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(b,a,c){var d=this;this.filename=b;this.c2d_vars=a;this.c2d_url=c!=null?c:"/sm/c2d";this.init_logger();return on_script_loaded(function(){var i,f,e,h,g;i=$("login-create-an-account");if(i){i.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);if((f=$j("#c2d-register-form"))!=null){f.on("submit",d.c2d_register.bind(d))}if((e=$j("#c2d-login-form"))!=null){e.on("submit",d.c2d_login.bind(d))}if((h=$j("#c2d-twofactor-login-form"))!=null){h.on("submit",d.c2d_twofactor_login.bind(d))}if((g=$j("#download_button_link[data-dl-link]"))!=null){g.on("click",d.download_zip)}return d.set_viewport_size()})},init_folder:function(a,c,b){var d=this;this.gallery_enabled=a;this.gallery_showing=c;this.is_folder=true;this.init_lightbox(b);return on_script_loaded(function(){return d.load_thumbs()})},init_album:function(){this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&!(this.c2d_vars.item_id!=null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},init_logger:function(){var a=this;on_script_loaded(function(){var b;b=$("login-hover-link");if(b){b.observe("click",function(){return ShmodelLogger.log("click_sign_in")});b.observe("click",function(){return RegistrationLogger.log("click_sign_in")})}if($("download_button_link")){ShmodelLogger.attachLogListener("click_download",$("download_button_link"))}b=$("add_to_my_dropbox_link");if(b){ShmodelLogger.attachLogListener("click_add_to_my_dropbox",b);RegistrationLogger.attachLogListener("click_add_to_my_dropbox",b)}if($$(".remove-link").length){ShmodelLogger.attachLogListener("remove_link",$$(".remove-link")[0])}if($$(".shmodel-filename").length){ShmodelLogger.attachLogListener("click_filename",$$(".shmodel-filename")[0])}if($("default_content_download_button")){ShmodelLogger.attachLogListener("click_download",$("default_content_download_button"))}if($("default_content_a2md")){return ShmodelLogger.attachLogListener("click_add_to_my_dropbox",$("default_content_a2md"))}});return document.observe(Lightbox.ACTIONS_ADDED,function(){var d,c,b;b=$("view_original");if(b){ShmodelLogger.attachLogListener("shmodel_lightbox_click_vieworiginal",b)}c=$("lightbox_shmodel_link");if(c){ShmodelLogger.attachLogListener("shmodel_lightbox_click_getlink",c)}d=$("lightbox_download_link");if(d){return ShmodelLogger.attachLogListener("shmodel_lightbox_click_download",d)}})},set_team_only_shmodel:function(b,a){this.team_only_shmodel=b;return this.owner_name=a},_resize_album_view:function(){var a;a=Math.floor((Util.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+a+"px"})},init_lightbox:function(a){return Lightbox.init_from_preview_objs(a,"#gallery-view-media li")},load_thumbs:function(){var b,a;a=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");b=function(c){if(!c.src.endsWith(Sprite.SPACER)){return c.addClassName("thumbnail")}};return BatchThumbLoader.batch_load_thumbs(a,this.THUMBS_BATCH_SIZE,b)},switch_mode:function(g){var c,h,f,a,e,b,d;d=$A(["gallery","list"]);for(e=0,b=d.length;e<b;e++){a=d[e];h=$(a+"-view-container");c=$(a+"-toggle");if(g===a){h.show();c.addClassName("selected")}else{h.hide();c.removeClassName("selected")}}if(history.replaceState){f=window.location.pathname;if(g==="list"){f+="?lst"}history.replaceState({},"",f)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var a;if($(document.body).hasClassName("mobile")){a=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(a)}},toggle_dropdown:function(d,f,c){var a,b;if(d){Event.extend(d).preventDefault()}if(!f.visible()){if(this.is_album){return FreshDropdown.show(f,c,null,true)}else{b=$$(".nav-header").first().getHeight();a=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(a<0&&Util.ie8){a=4}return FreshDropdown.show(f,c,b-a,true)}}},confirm_remove:function(b,i,e,a,h,j){var d,f,c,g=this;if(e==null){e=false}if(a==null){a=false}if(h==null){h=false}if(j==null){j=null}assert(i,"confirm_remove missing tkey");assert(b,"confirm_remove missing name");assert(j,"confirm_remove missing user_id");if(!viewer.is_uid_signed_in(j)){MultiaccountLogin.show_modal({user_id:j,on_success:function(){return g.confirm_remove(b,i,e,a,h,j)}});return}if(a){c=h?_("Unshare?"):_("Unshare album?");d=$("album-disable-token-modal");DomUtil.fillVal(b.escapeHTML(),"album_unshare_name")}else{c=_("Remove link to '%(name)s'").format({name:b.em_snippet(17)});d=$("disable-token-modal");if(e){f=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{f=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}DomUtil.fillVal(f,"disable-token-desc")}return Modal.icon_show("alert_32",c,d,{token:i,name:b,is_album:a,user_id:j})},do_remove:function(b){var a,c,d=this;a=$j("#modal-content input").first();a.attr("disabled",true);$j("#modal-content").addClass("ajax-loading");if((c=window.location.pathname)==="/links"||c==="/links/your_links"){return new Ajax.DBRequest("/sm/disable/"+b.token,{subject_user:b.user_id,onSuccess:function(){var e;Modal.hide();if(b.is_album){e=_("Unshared '%(name)s'")}else{e=_("Removed link for '%(name)s'")}e=e.format({name:b.name});Notify.server_success(e);return document.fire(FileEvents.LINKS_REMOVE,{token:b.token})},onComplete:function(){a.attr("disabled",false);return $j("#modal-content").removeClass("ajax-loading")}})}else{return Forms.postRequest(URI({path:"/sm/disable/"+b.token}).updateQuery(Constants.UID_PARAM_NAME,b.user_id).toString())}},show_shmodal_onload:function(c,d,b,a){var e=this;if(a==null){a=null}return Util.smartLoad(function(){Util.remove_param_from_url("m");if(!viewer.is_uid_signed_in(a)){MultiaccountLogin.show_modal({user_id:a,on_success:function(){return e.show_shmodal_onload(c,d,b,a)}});return}if((a!=null)&&EmailVerification.get_for_user(viewer.get_user_by_id(a)).verified()){return e.show_shmodal(c,d,b,a)}else{if(!(a!=null)){assert(viewer.is_paired,"Expected viewer to be paired.");return e.show_share_shmodel_role_chooser(c,d,b)}}})},show_shmodal:function(c,j,a,o){var l,n,k,g,h,b,e,d,m,f,i=this;this.url=c;this.short_url=j;if(!viewer.is_uid_signed_in(o)){MultiaccountLogin.show_modal({user_id:o,on_success:function(){return i.show_shmodal(c,j,a,o)}});return}e=viewer.get_user_by_id(o);if(EmailVerification.get_for_user(e).verified()){h="shmodal-user-"+o;Modal.show(this._get_shmodal_title(),DomUtil.fromElm($(h)).stripScripts());g={};g[Constants.UID_PARAM_NAME]=o;Forms.add_vars("shmodal-send-form",g);if(this._get_thumbnail_type()){f=$$(".shmodal-image");for(d=0,m=f.length;d<m;d++){k=f[d];k.addClassName("thumbnail")}}if(a==="contacts"){n=Autocompleter.ContactsTokenizer}else{n=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new n(e,h+"-new-collab-input",h+"-new-whobulk",h+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:a==="team_only",user_id:o});this.configure_dropdown();if(FlashDetect.installed){b=Util.copy_to_clipboard_swf(c,h+"-copy-link","SharingModel.copied_to_clipboard");$(b).up().style.zIndex="1001";clearInterval(this.follow_freshbutton);l=function(){return $j("#"+b).parent().clonePosition($j("#"+h+"-copy-link"),{offsetHeight:6,offsetWidth:6})};this.follow_freshbutton=setInterval(l,500)}else{$(h+"-copy-link").hide()}SickInput._create($("modal").down(".custom-message-container"));SickInput._create($("modal").down(".fb-post-sickinput"));SickInput._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(j,o);$(h+"-new-collab-input").focus();return ShmodelLogger.log("shmodal_show")}},configure_dropdown:function(){var f,b,d,a,c,e=this;c=$$(".dropdown-menu-container");for(d=0,a=c.length;d<a;d++){f=c[d];b=f.down(".dropdown-menu-trigger");if(b!=null){b.observe("click",function(h){var g;g=h.target.up(".dropdown-menu-container");return g.toggleClassName("dropdown-shown")})}}return document.on("click",function(l){var j,k,i,g,h;if(l.target.hasClassName("dropdown-menu-trigger")||l.target.up(".dropdown-menu-trigger")){return}g=$$(".dropdown-shown");h=[];for(k=0,i=g.length;k<i;k++){j=g[k];h.push(j.removeClassName("dropdown-shown"))}return h})},copied_to_clipboard:function(){Notify.server_success(_("Link copied to clipboard"));Modal.hide();ShmodelLogger.log("shmodal_copy_link");return ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(c){var d,k,h,l,m,i,a,f,e,j,b,g;assert(c,"Must pass the shmodal send form into get_shmodel_send_recipients");d=c.select('input[name="emails"]');k=c.select('input[name="fb_ids"]');h=c.select('input[name="group_ids"]');a=[];g=[d,k,h];for(f=0,j=g.length;f<j;f++){m=g[f];for(e=0,b=m.length;e<b;e++){l=m[e];i=l.up().innerHTML.stripTags().escapeHTML();a.push(i.substring(0,i.indexOf("&")))}}return a},send_shmodel_link:function(d){var c,b,f,a,g=this;c=$("shmodal-send-form");assert(c,"Couldn't find the shmodal send form.");a=this.get_shmodel_send_recipients(c);f=function(e){var h;h=SharingUtil.success_string_for_recipients(a);Notify.server_success(h);Modal.hide();return ShmodelLogger.log("shmodal_send")};b=function(e){return Forms.remove_loading()};return Forms.ajax_submit(c,"/sm/share",f,b,c.down(".tokenizer-submit-button"))},show_content:function(b){var e,d,a,c;$("shmodal-title-text").__date(ShmodalPanes.to_title_str(b));c=ShmodalPanes.list;for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){$(ShmodalPanes.to_toggle_str(e)).removeClassName("toggled");$(ShmodalPanes.to_content_str(e)).hide()}}$(ShmodalPanes.to_content_str(b)).show();$(ShmodalPanes.to_toggle_str(b)).addClassName("toggled");return $j("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(ShmodalPanes.SEND)},show_fb_content:function(){return this.show_content(ShmodalPanes.FB)},show_twitter_content:function(){return this.show_content(ShmodalPanes.TWITTER)},start_fb_post:function(e,b){var f,c,a,d,g=this;c=function(){return FacebookOAuth.do_auth(g.do_fb_post.curry(e,b),b)};f=$j("#modal:visible, #modal-overlay:visible");a=function(){return f.show()};if(FacebookOAuth.authed_user_id===b){return this.do_fb_post(e,b)}else{if(viewer.is_uid_associated(FacebookOAuth.authed_user_id)){f.hide();d=new FacebookConfirmModal(viewer.get_user_by_id(b),a,c.bind(this));return d.show()}else{return c()}}},start_twitter_post:function(a){if(Twitter.is_authed(a)){return this.do_twitter_post(a)}else{return Twitter.do_auth(this.do_twitter_post,a)}},do_fb_post:function(b,a){FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.server_success(_("Successfully posted to Facebook"));ShmodelLogger.log("shmodal_fb_post");return ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})};return FacebookOAuth.post($F("shmodal-fb-post-input"),b,null,null,null,function(){return Modal.hide()},a)},do_twitter_post:function(a){var b,c=this;b=$F("shmodal-twitter-post-input");if(!b){Notify.server_error(_("Please enter a Twitter post"));return}else{if(b.length>140){Notify.server_error(_("Your post must be 140 characters or less"));return}}Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};return Twitter.custom_post(b,function(){Modal.hide();Notify.server_success(_("Successfully posted to Twitter"));ShmodelLogger.log("shmodal_tweet");return ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})},a)},_get_shmodal_title:function(){var a=this;return this.generate_title_content(this._get_shmodal_title_text(),(function(){return a.show_send_content()}),(function(){return a.show_fb_content()}),(function(){return a.show_twitter_content()}))},generate_title_content:function(a,f,c,i){var b,e,j,g,d,h;d=new Element("div",{id:"shmodal-title-text"});d.__date(a);j=new Element("a",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});j.__date(Sprite.make("web","email_20"));j.observe("click",f);e=new Element("a",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});e.__date(Sprite.make("web","fb_20"));e.observe("click",c);h=new Element("a",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});h.__date(Sprite.make("web","twitter_20"));h.observe("click",i);b=new Element("div",{"class":"clear"});g=new Element("div",{id:"shmodal-title"});g.__sert(d);g.__sert(j);g.__sert(e);g.__sert(h);g.__sert(b);return g},_get_shmodal_title_text:function(){var b,a;if(this.is_folder){b=_("Share link to '%(folder_name)s'");return b=b.format({folder_name:this.filename.em_snippet(15)})}else{a=this._get_thumbnail_type();if(a===BrowseFile.CATEGORY_TO_TRANSLATION.IMAGE){return _("Share this image")}else{if(a===BrowseFile.CATEGORY_TO_TRANSLATION.VIDEO){return _("Share this video")}else{return _("Share '%(filename)s'").format({filename:this.filename.em_snippet(18)})}}}},_get_thumbnail_type:function(){var b,a;if(this.filename.indexOf(".")===-1){return false}a=Util.file_extension(this.filename).toLowerCase();b=BrowseFile.EXTENSION_TO_CATEGORY[a];if(b&&(b==="IMAGE"||b==="VIDEO")){return BrowseFile.CATEGORY_TO_TRANSLATION[b]}return false},_populate_twitter_info:function(c,a){var d,b;d=this.is_folder?_("Just shared some files using @Dropbox"):(b=this._get_thumbnail_type(),b&&b===BrowseFile.CATEGORY_TO_TRANSLATION.IMAGE?_("Just shared an image using @Dropbox"):_("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(d+" "+c);Util._track_twitter_chars_left("shmodal-twitter-post-input",140);if(Twitter.is_authed(a)){return Twitter.get_user_info(function(e){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:e.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(e.name);$("shmodal-twitter-profile").down(".username").__date("@"+e.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},a)}},download_zip:function(d){var b,c,e,a,g,f=this;b=$j("#download_button_link").attr("data-dl-link");g=$j("#download_button_link").attr("data-test-link");a=$j("#download_button_link").attr("data-owner")==="true";e=function(h){var i;if(h==="True"){window.location=b}else{if(h.indexOf("err:")===0){if(a){i=_("The zip file is too large.")}else{i=_("The zip file is too large. Please add it to your Dropbox.")}Notify.server_error(i)}else{Notify.server_error(_("Failed to download zip file."))}}return false};c=function(h){Notify.server_error(_("Failed to download zip file."));return false};if(g&&$j.support.cors===true){$j.ajax({url:g,type:"GET",success:e,error:c})}else{window.location=b}return false},show_share_shmodel_role_chooser:function(b,c,a){if(!(this.shmodel_select_role_modal!=null)){this.shmodel_select_role_modal=new ShareShmodelSelectRoleModal({element_id:"share-shmodel-select-role-modal",link_url:b,short_url:c,tokenizer_type:a})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(b,c,a,f){var d,e=this;d=function(){var g;Modal.hide();$j("#role-selector option").removeClass("disabled");g=viewer.get_uid_by_role(f);viewer.sign_in_user_by_id(g);ShmodelUILogger.log("via-shmodel-viewer");return SharingModel.show_shmodal(b,c,a,g)};if(!viewer.is_role_signed_in(f)){SharingState.not_logged_in_role=f;return MultiaccountLogin.show_modal({role:f,on_success:d})}else{return d()}},show_c2d_modal:function(g,a){var j,c,e,b,h,d,f,i=this;if(g==null){g=""}if(a==null){a=false}"If a role is passed in:\n  If the role is not logged in, that role will be prompted to login.\n  If the role is logged in, we'll show the c2d for that role.\nIf no role is passed in:\n  If the viewer is paired: (and thus logged in)\n    We'll present a role chooser.\n  If the viewer is logged in: (and not paired)\n    We'll present the c2d modal for the logged in unpaired user.\n  If the viewer isn't logged in:\n    We'll present the c2d modal that lets them login or register.";if(g){if(g===Constants.ROLE_PERSONAL){assert(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!viewer.is_role_signed_in(g)){MultiaccountLogin.show_modal({role:g,on_success:function(){return i.show_c2d_modal(g)}});return}}else{if(viewer.is_paired){new ShmodelC2DSelectRoleModal({element_id:"select-role-modal"}).show();return}}if(g){h="#c2d-modal-"+g}else{h="#c2d-modal"}d=this._c2d_modal_msg(g,viewer.team_name);j=this._c2d_modal_button_msg(g,viewer.team_name);e=this._c2d_modal_desc(g,viewer.team_name);if(a){e=this._c2d_modal_team_only_desc(viewer.team_name)+"<br/><br/>"+e}c=this._c2d_modal_create_account_desc();b=this._c2d_modal_login_desc(g,viewer.team_name);DomUtil.fillVal(e,"c2d-desc");DomUtil.fillVal(c,"c2d-create-account-desc");DomUtil.fillVal(b,"c2d-login-desc");if((f=$j(".c2d-submit-button"))!=null){f.val(j)}return Modal.icon_show("glyph",d,$j(h)[0],false,false,false,false)},_c2d_modal_msg:function(d,b){var a,c;if(d==null){d=""}if(b==null){b=""}if(this.c2d_vars.title){return c=this.c2d_vars.title}else{if(d===Constants.ROLE_PERSONAL){c=_("Save '%(filename)s' to my personal Dropbox");return c.format({filename:this.filename.em_snippet(10)})}else{if(d===Constants.ROLE_WORK){c=_("Save '%(filename)s' to my %(team_name)s Dropbox");a=Math.max(10,15-new Emstring(b).length);return c.format({filename:this.filename.em_snippet(a),team_name:b})}else{c=_("Save '%(filename)s' to my Dropbox");return c.format({filename:this.filename.em_snippet(15)})}}}},_c2d_modal_button_msg:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){return b=_("Save to my personal Dropbox")}else{if(c===Constants.ROLE_WORK){b=_("Save to my %(team_name)s Dropbox");return b.format({team_name:a})}else{return _("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(a){var b;if(this.is_album){b=_("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){b=_("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{b=_("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return b.format({owner_name:this.owner_name,team_name:a})},_c2d_modal_desc:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){b=_("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){b=_("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){b=_("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return b.format({owner_name:this.owner_name,team_name:a})}else{return b=_("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(c===Constants.ROLE_WORK){if(this.is_album){b=_("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){b=_("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{b=_("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return b.format({team_name:a})}else{if(this.is_album){return _("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return _("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return _("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_create_account_desc:function(){if(this.is_album){return _("Once you register for Dropbox, the photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return _("Once you register for Dropbox, this folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return _("Once you register for Dropbox, this file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}},_c2d_modal_login_desc:function(c,a){var b;if(c==null){c=""}if(a==null){a=""}if(c===Constants.ROLE_PERSONAL){if(this.is_album){return b=_("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return b=_("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return b=_("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(c===Constants.ROLE_WORK){if(this.is_album){b=_("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){b=_("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{b=_("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return b.format({team_name:a})}else{if(this.is_album){return _("Once you sign in to Dropbox, the photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return _("Once you sign in to Dropbox, this folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return _("Once you sign in to Dropbox, this file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},c2d_register:function(b){var a,c,d=this;b.preventDefault();a=$("c2d-register-form");c=function(f){var e;e=JSON.parse(f.responseText);Constants.TOKEN=e.csrf_token;return d.do_c2d(e.id)};return Forms.ajax_submit(a,"/ajax_register",c,false,$(a).down("input[type=submit]"))},c2d_login:function(d,a){var c,b,f,g=this;if(a==null){a="c2d-login-form"}d.preventDefault();c=$(a);f=function(h){var e;e=JSON.parse(h.responseText);switch(e.status){case"OK":Constants.TOKEN=e.csrf_token;return g.do_c2d(e.id);case"TWOFACTOR":return g.show_c2d_twofactor(e.last_four_digits);case"SSO":return window.location=e.sso_url}};b=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(c,"/ajax_login",f,b,$(c).down("input[type=submit]"))},show_c2d_twofactor:function(a){$("c2d-login").hide();if(a){$("c2d-twofactor-login").addClassName("sms");DomUtil.fillVal(a,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){var a=this;if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(b){switch(b.responseText.strip()){case"OK":return Notify.server_success(_("We sent you another code. It may take a few minutes to arrive."));case"UNREACHABLE":return a.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return a.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return a.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return a.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":a.hide_c2d_twofactor();return Notify.server_error(_("Sorry, your phone code has expired. Please log in again."))}},onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(c){var b,a,d,f=this;c.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}b=$("c2d-twofactor-login-form");d=function(g){var e;e=JSON.parse(g.responseText);switch(e.status){case"OK":Constants.TOKEN=e.csrf_token;return f.do_c2d(e.id);case"INVALID":return f.c2d_show_twofactor_error_invalid();case"EXPIRED":f.hide_c2d_twofactor();return Notify.server_error(_("Sorry, your phone code has expired. Please log in again."))}};a=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(b,"/ajax_verify_code",d,a)},do_c2d:function(a){var b,c=this;assert(a,"Must specify a user_id for saving to Dropbox.");b=_("Saving to your Dropbox...");if(viewer.is_paired){if(viewer.get_user_by_id(a).is_team){b=_("Saving to your %(team_name)s Dropbox...");b=b.format({team_name:viewer.team_name})}else{b=_("Saving to your personal Dropbox...")}}Notify.server_success(b);Modal.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:b,subject_user:a,onSuccess:function(d){if(d.responseText&&d.responseText[0]==="/"){return window.location.href=d.responseText}else{if(d.responseText==="snapshot_ok"){return Notify.server_success(_("Successfully saved to your Dropbox."))}}}})},c2d_show_twofactor_error:function(b){var a;a=$("c2d-twofactor-error");a.__date(b);return a.show()},c2d_hide_twofactor_error:function(a){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(_("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(_("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(_("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(_("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(_("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(_("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var ShmodalPanes;ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",_("Share on Facebook"),_("Share on Twitter")],to_content_str:function(a){return this._content_str[a]},to_toggle_str:function(a){return this._toggle_str[a]},to_title_str:function(a){if(a===0){return SharingModel._get_shmodal_title_text()}return this._title_str[a]},to_focus_str:function(a){return this._focus_str[a]}};var Foshmodal,FoshmodalPanes;FoshmodalPanes=Object.clone(ShmodalPanes);FoshmodalPanes.to_title_str=function(){var a,b,f,d,e,c;if(Foshmodal.sharing_collection){d=Foshmodal.collection_to_share.name.em_snippet(18,1);return _("Share '%(snippeted_name)s'").format({snippeted_name:d})}else{a=Foshmodal._selection;c=PhotosUtil.categorize_files(a),b=c[0],f=c[1];if(b&&f){e=ungettext("Share %(file_count)s item","Share %(file_count)s items",a.length)}else{if(b){e=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",a.length)}else{e=ungettext("Share %(file_count)s video","Share %(file_count)s videos",a.length)}}e=e.format({file_count:a.length});return e}};Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:FoshmodalPanes.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=FoshmodalPanes.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;PhotosSelection.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();$j(".link-image").attr("src","static/images/empty_album_big.png");Forms.remove_loading($j("#modal").find(".tokenizer-submit-button")[0]);Forms.remove_loading($j("#modal").find(".foshmodal-copy-link")[0]);Forms.remove_loading($j("#shmodal-twitter-post-submit")[0]);return Forms.remove_loading($j("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(a){var b;assert(this._selection.length,"This should never be called with an empty selection");assert(this.current_tkey!=null,"Missing tkey");assert(this.current_shmodel_url!=null,"Missing shmodel url");assert(this.current_short_url!=null,"Missing short url");assert(a!=null,"Missing collection info");a.is_anonymous=this.creating_anonymous_collection();a.share_tkey=this.current_tkey;a.shmodel_url=this.current_shmodel_url;a.short_url=this.current_short_url;return b=new PhotoCollection(a)},set_shmodel_url:function(c,a){var b=this;if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof c==="function"?c():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:function(e){var d;d=JSON.parse(e.responseText);b.current_shmodel_url=d.token_link;b.current_short_url=d.short_link;b.current_tkey=d.tkey;if(typeof c==="function"){c()}return typeof b.callback_for_when_we_have_shmodel_url==="function"?b.callback_for_when_we_have_shmodel_url():void 0},onFailure:function(){return typeof a==="function"?a():void 0}})}},attach_collection_to_token:function(b,a){assert(this.collection_to_share!=null,"Should get called only when there is an existing collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof b==="function"){b(this.collection_to_share.gid)}return}assert(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,b,a)},create_collection_and_attach_to_token:function(g,a){var c,e,d,b,f=this;assert(this.sharing_collection===false,"Should not get called when we already have a collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");e=function(h){var i;i=JSON.parse(h.responseText);f.create_album_from_selected_photos(i);return typeof g==="function"?g(i.gid):void 0};c=function(h){return typeof a==="function"?a(h):void 0};d={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var k,i,j,h;j=this._selection;h=[];for(k=0,i=j.length;k<i;k++){b=j[k];h.push(b.item_counter)}return h}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:e,onFailure:c,parameters:d})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){Notify.server_error(_("Please enter a name for this album"));this.unlock();return true}if(PhotosCollections.collection_name_in_use(this.current_album_name)){Notify.server_error(_("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(c){var b,a,d=this;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}b=$("shmodal-send-form");assert(b,"Couldn't find the shmodal send form.");if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}a=function(e){d.unlock();if(!e.responseText.startsWith("err:")){Notify.server_error(_("We couldn't send this album. Please try again."));Modal.hide();return d.refresh()}};if(this.sharing_collection){this.send_collection(b,a)}else{this.send_selection(b,a)}return PhotosLogger.log_interaction(PhotosEvents.SEND,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var d,b,c,a,e;d=this.get_current_display_name();a=SharingModel.get_shmodel_send_recipients($("shmodal-send-form"));b=a[0].split(" ")[0];if(a.length===1){e=_("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:d,first_name_of_recipient:b})}else{if(a.length===2){c=a[1].split(" ")[0];e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:d,first_name_of_recipient:b,first_name_of_second_recipient:c})}else{e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:d,first_name_of_recipient:b,num_other_recipients:a.length-1})}}return e},send_selection:function(c,b){var e,d,a,f=this;e=function(g){var h;h=JSON.parse(g.responseText);f.create_album_from_selected_photos(h);Notify.server_success(f.get_send_success_text());f.refresh();return Modal.hide()};d={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var j,h,i,g;i=this._selection;g=[];for(j=0,h=i.length;j<h;j++){a=i[j];g.push(a.item_counter)}return g}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}if(this.creating_anonymous_collection()){d.collection_name=""}else{if(this.current_album_name.trim().length===0){d.collection_name=PhotosCollections.get_default_album_name()}}return Forms.ajax_submit(c,"/collection_create_and_send_link",e,b,c.down(".tokenizer-submit-button"),d)},send_collection:function(b,a){var c,d=this;assert(this.current_tkey!=null,"tkey should be set");assert(this.current_shmodel_url!=null,"shmodel url should be set");c=function(){Notify.server_success(d.get_send_success_text());Modal.hide();return d.refresh()};return this.collection_to_share.send_link(b,this.current_tkey,this.current_shmodel_url,this.current_short_url,c,a)},get_link_button_onclick:function(){var a,c,b,d=this;if(!this.lock()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}b=$("modal").down(".tokenizer-submit-button");c=function(f){var e;e=d.get_current_display_name();if(FlashDetect.installed){Notify.server_success(_("The link to %(album_name)s was copied to your clipboard").format({album_name:e}))}d.show_get_link_modal(d.current_shmodel_url,e,f);ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(d.collection_to_share!=null){AlbumsLogger.log_share("share_link",f,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)}return d.refresh()};a=function(e){d.unlock();Forms.remove_loading(b);if(!e.responseText.startsWith("err")){Notify.server_error(_("We couldn't create a link to this album. Please try again."));Modal.hide();return d.refresh()}};if(this.sharing_collection){Forms.add_loading(b);this.attach_collection_to_token(c,a)}else{if(this.alert_if_album_name_invalid()){return}Forms.add_loading(b);this.create_collection_and_attach_to_token(c,a)}return PhotosLogger.log_interaction(PhotosEvents.GET_LINK,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var b,a,c=this;if(FlashDetect.installed){a=Util.copy_to_clipboard_swf(this.current_shmodel_url,"foshmodal-copy-link","Foshmodal.get_link_button_onclick",null,null,"fixed");$(a).up().style.zIndex="1001";clearInterval(this.follow_freshbutton);b=function(){return $j("#"+a).parent().clonePosition($j("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})};return this.follow_freshbutton=setInterval(b,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(g,b){var f,c,a,d,h=this;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(g,b);return}f=$j("#modal:visible, #modal-overlay:visible");a=function(){return f.show()};c=function(){h.lock();setTimeout(h.unlock.bind(h),750);return FacebookOAuth.do_auth((function(){return h.do_fb_post(b)}),b)};if(FacebookOAuth.authed_user_id===b){this.do_fb_post(b)}else{if(viewer.is_uid_associated(FacebookOAuth.authed_user_id)){this.unlock();f.hide();d=new FacebookConfirmModal(viewer.get_user_by_id(b),a,c.bind(this));d.show()}else{c()}}return PhotosLogger.log_interaction(PhotosEvents.FB_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(b,a){var c=this;if(!this.lock()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(b,a);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(Twitter.is_authed(a)){this.do_twitter_post(a)}else{setTimeout(this.unlock.bind(this),750);Twitter.do_auth((function(){return c.do_twitter_post(a)}),a)}return PhotosLogger.log_interaction(PhotosEvents.TWITTER_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(a){var b,c,d=this;b=function(){Notify.server_error(_("We couldn't share this album on Facebook. Please try again."));Modal.hide();return d.refresh()};c=function(f){var e;FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.progress_container=$("modal").down(".modal-buttons");e=d.get_current_display_name();FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.server_success(_("Shared %(album_name)s on Facebook!").format({album_name:e}));return d.refresh()};FacebookOAuth.post($F("shmodal-fb-post-input"),d.current_shmodel_url,null,null,null,b,a);ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return AlbumsLogger.log_share("share_facebook",f,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)};if(this.sharing_collection){return this.attach_collection_to_token(c,b)}else{return this.create_collection_and_attach_to_token(c,b)}},do_twitter_post:function(a){var d,b,c,e=this;d=$F("shmodal-twitter-post-input");if(!d){Notify.server_error(_("Please enter a tweet"));this.unlock();return}if(d.length>140){Notify.server_error(_("Your tweet must be 140 characters or less"));this.unlock();return}c=function(f){Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};Twitter.custom_post(d,function(){Modal.hide();Notify.server_success(_("Your tweet has been posted!"));return e.refresh()},a);ViralLogger.log(viewer.get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return AlbumsLogger.log_share("share_twitter",f,e.num_photos_to_share,e.creating_anonymous_collection(),!e.sharing_collection)};b=function(){Notify.server_error(_("We couldn't share this album on Twitter. Please try again."));Modal.hide();return e.refresh()};if(this.sharing_collection){return this.attach_collection_to_token(c,b)}else{return this.create_collection_and_attach_to_token(c,b)}},show_get_link_modal:function(b,a,c){var d;Modal.show(_("Link to %(album_name)s").format({album_name:a.escapeHTML()}),$("get-link-modal"));d=$("get-link-modal").down(".link-input");d.setValue(b);d.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(b,"_blank");return Modal.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(c!=null){PhotosCollections.flash_sidebar_album(c)}return Modal.hide()}},update_current_album_name_text:function(a){this.current_album_name=$(FoshmodalPanes.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===FoshmodalPanes.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(e){var b,d,c,a;a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(e){if(this.num_photos_to_share===1){b=e}else{b=_("%(album_name_text)s (%(album_desc)s)").format({album_name_text:e,album_desc:PhotosUtil.file_desc(a)})}}else{if(a.length===1){c=a[0];if(c.preview_type==="photo"){d=_("Photo from %(date_taken)s")}else{d=_("Video from %(date_taken)s")}b=d.format({date_taken:Util.niceDateWithMonthName(new Date(c.time_taken),true,true,true)})}else{b=PhotosUtil.file_desc(a)}}return $(FoshmodalPanes.to_content_str(FoshmodalPanes.FB)).down(".link-name").__date(b)},set_current_album_name_text:function(b,a){$(FoshmodalPanes.to_content_str(b)).down(".album-name-input").value=a;if(b===FoshmodalPanes.FB){return this.set_fb_post_title(a)}},show_content:function(e){var b,d,a,c;if(this.working){return}$("shmodal-title-text").__date(FoshmodalPanes.to_title_str());c=FoshmodalPanes.list;for(d=0,a=c.length;d<a;d++){b=c[d];if(b!==e){$(FoshmodalPanes.to_toggle_str(b)).removeClassName("toggled");$(FoshmodalPanes.to_content_str(b)).hide()}}$(FoshmodalPanes.to_content_str(e)).show();$(FoshmodalPanes.to_toggle_str(e)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(e,this.current_album_name)}switch(e){case FoshmodalPanes.FB:$("shmodal-fb-post-input").focus();break;case FoshmodalPanes.TWITTER:$("shmodal-twitter-post-input").focus();break;case FoshmodalPanes.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=e},_get_foshmodal_title:function(){var a=this;return SharingModel.generate_title_content(FoshmodalPanes.to_title_str(),(function(){return a.show_content(FoshmodalPanes.SEND)}),(function(){return a.show_content(FoshmodalPanes.FB)}),(function(){return a.show_content(FoshmodalPanes.TWITTER)}))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return PhotosUtil.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var a,c,b,e,d;a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(a.length===1){d=PhotosUtil.categorize_files(a),b=d[0],e=d[1];if(b){c=_("Just shared a photo using @Dropbox")}else{if(e){c=_("Just shared a video using @Dropbox")}else{assert(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{c=_("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+c+" "+this.current_short_url)},update_shmodal_image_text:function(){var h,k,j,f,e,i,a,g,d,c,b;if(this.sharing_collection){k=this.collection_to_share.num_items;j=PhotosUtil.album_desc(this.collection_to_share,false,true)}else{k=this._selection.length;j=PhotosUtil.file_desc(this._selection,false,true)}if(k>1){g=$$(".shmodal-image");c=[];for(f=0,i=g.length;f<i;f++){h=g[f];h.down("span").__date(j);c.push(h.down(".share-file-count").show())}return c}else{d=$$(".shmodal-image");b=[];for(e=0,a=d.length;e<a;e++){h=d[e];b.push(h.down(".share-file-count").hide())}return b}},show:function(i,q){var j,n,o,k,p,g,f,d,m,b,a,h,e,c,l=this;this.unlock();Modal.onHide=function(){var s,r;if((s=$("flash_copy_container"))!=null){s.remove()}if((r=l.send_link_autocompleter)!=null){r.hide()}$j("#modal").find(".new-collab-input").val("");clearInterval(l.follow_freshbutton);Photos.disable_selection();delete Modal.onHide;return Modal.hide()};this.sharing_collection=q;p=this.sharing_collection?i.thumbnail_url_256:i[0].thumbnail_url;h=$$(".link_image");for(g=0,m=h.length;g<m;g++){n=h[g];if(p!=null){n.src=p}else{n.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=FoshmodalPanes.SEND;this.have_real_tkey=this.sharing_collection&&(i.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=i;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=i.sort(function(s,r){return s.time_taken-r.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");e=$$(".save-as-album-checkbox");for(f=0,b=e.length;f<b;f++){j=e[f];j.checked=false;k=function(z){var A,w,u,s,r,v,t,y,x;if(z.target.checked){$("shmodal").addClassName("saving-as-album");l.current_album_name=l.previous_album_name||PhotosCollections.get_default_album_name();l.set_current_album_name_text(l.current_foshmodal_pane,l.current_album_name);A=$(FoshmodalPanes.to_content_str(l.current_foshmodal_pane)).down(".album-name-input");A.focus();A.select();v=$$(".save-as-album-checkbox");y=[];for(w=0,s=v.length;w<s;w++){j=v[w];y.push(j.checked=true)}return y}else{$("shmodal").removeClassName("saving-as-album");l.previous_album_name=l.current_album_name;l.current_album_name="";l.set_current_album_name_text(l.current_foshmodal_pane,l.current_album_name);t=$$(".save-as-album-checkbox");x=[];for(u=0,r=t.length;u<r;u++){j=t[u];x.push(j.checked=false)}return x}};j.observe("change",k);if($j.browser.msie_version_at_most(8)){j.observe("click",k)}}c=$$(".album-name-input");for(d=0,a=c.length;d<a;d++){o=c[d];o.observe("keyup",this.update_current_album_name_text.bind(this))}}Photos.enable_selection();Modal.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url((function(){l.initialize_get_link_button();return l.set_twitter_message()}),(function(){Notify.server_error(_("This request could not be completed.  Please try again."));return Modal.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(viewer.get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();ActAsBlock.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return Util._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(b,g){var d={};function c(m,n){var l,j=[];for(var k=0;k<m.length;++k){l=d[m[k]]||e(m[k]);if(!l){throw"module definition dependecy not found: "+m[k]}j.push(l)}n.apply(null,j)}function h(k,j,i){if(typeof k!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(j===g){throw"invalid module definition, dependencies must be specified"}if(i===g){throw"invalid module definition, definition function must be specified"}c(j,function(){d[k]=i.apply(null,arguments)})}function f(i){return !!d[i]}function e(l){var j=b;var i=l.split(/[.\/]/);for(var k=0;k<i.length;++k){if(!j[i[k]]){return}j=j[i[k]]}return j}function a(l){for(var k=0;k<l.length;k++){var m=b;var o=l[k];var j=o.split(/[.\/]/);for(var n=0;n<j.length-1;++n){if(m[j[n]]===g){m[j[n]]={}}m=m[j[n]]}m[j[j.length-1]]=d[o]}}h("moxie/core/utils/Basic",[],function(){var q=function(v){var u;if(v===u){return"undefined"}else{if(v===null){return"null"}else{if(v.nodeType){return"node"}}}return({}).toString.call(v).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var m=function(v){var u;o(arguments,function(w,x){if(x>0){o(w,function(z,y){if(z!==u){if(q(v[y])===q(z)&&!!~s(q(z),["array","object"])){m(v[y],z)}else{v[y]=z}}})}});return v};var o=function(z,A){var y,w,v,x;if(z){try{y=z.length}catch(u){y=x}if(y===x){for(w in z){if(z.hasOwnProperty(w)){if(A(z[w],w)===false){return}}}}else{for(v=0;v<y;v++){if(A(z[v],v)===false){return}}}}};var r=function(u){var v;if(!u||q(u)!=="object"){return true}for(v in u){return false}return true};var k=function(v,u){var w=0,x=v.length;if(q(u)!=="function"){u=function(){}}if(!v||!v.length){u()}function y(z){if(q(v[z])==="function"){v[z](function(A){++z<x&&!A?y(z):u(A)})}}y(w)};var s=function(w,x){if(x){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(x,w)}for(var u=0,v=x.length;u<v;u++){if(x[u]===w){return u}}}return -1};var p=function(v,x){var w=[];if(q(v)!=="array"){v=[v]}if(q(x)!=="array"){x=[x]}for(var u in v){if(s(v[u],x)===-1){w.push(v[u])}}return w.length?w:false};var t=function(w,v){var u=[];o(w,function(x){if(s(x,v)!==-1){u.push(x)}});return u.length?u:null};var l=function(w){var v,u=[];for(v=0;v<w.length;v++){u[v]=w[v]}return u};var n=(function(){var u=0;return function(x){var v=new Date().getTime().toString(32),w;for(w=0;w<5;w++){v+=Math.floor(Math.random()*65535).toString(32)}return(x||"o_")+v+(u++).toString(32)}}());var i=function(u){if(!u){return u}return String.prototype.trim?String.prototype.trim.call(u):u.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var j=function(u){if(typeof(u)!=="string"){return u}var w={t:1099511627776,g:1073741824,m:1048576,k:1024},v;u=/^([0-9]+)([mgk]?)$/.exec(u.toLowerCase().replace(/[^0-9mkg]/g,""));v=u[2];u=+u[1];if(w.hasOwnProperty(v)){u*=w[v]}return u};return{guid:n,typeOf:q,extend:m,each:o,isEmptyObj:r,inSeries:k,inArray:s,arrayDiff:p,arrayIntersect:t,toArray:l,trim:i,parseSizeStr:j}});h("moxie/core/I18n",["moxie/core/utils/Basic"],function(j){var i={};return{addI18n:function(k){return j.extend(i,k)},translate:function(k){return i[k]||k},_:function(k){return this.translate(k)},sprintf:function(m){var l=[].slice.call(arguments,1),k="";j.each(m.split(/%[a-z]/),function(n){k+=n;if(l.length){k+=l.shift()}});return k}}});h("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(l,k){var i="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var j={mimes:{},extensions:{},addMimeType:function(m){var n=m.split(/,/),o,q,p;for(o=0;o<n.length;o+=2){p=n[o+1].split(/ /);for(q=0;q<p.length;q++){this.mimes[p[q]]=n[o]}this.extensions[n[o]]=p}},extList2mimes:function(s,t){var n=this,r,o,q,p,m=[];for(o=0;o<s.length;o++){r=s[o].extensions.split(/\s*,\s*/);for(q=0;q<r.length;q++){if(r[q]==="*"){return[]}p=n.mimes[r[q]];if(!p){if(t&&/^\w+$/.test(r[q])){m.push("."+r[q])}else{return[]}}else{if(l.inArray(p,m)===-1){m.push(p)}}}}return m},mimes2exts:function(m){var n=this,o=[];l.each(m,function(q){if(q==="*"){o=[];return false}var p=q.match(/^(\w+)\/(\*|\w+)$/);if(p){if(p[2]==="*"){l.each(n.extensions,function(r,s){if((new RegExp("^"+p[1]+"/")).test(s)){[].push.apply(o,n.extensions[s])}})}else{if(n.extensions[q]){[].push.apply(o,n.extensions[q])}}}});return o},mimes2extList:function(m){var o=[],n=[];if(l.typeOf(m)==="string"){m=l.trim(m).split(/\s*,\s*/)}n=this.mimes2exts(m);o.push({title:k.translate("Files"),extensions:n.length?n.join(","):"*"});o.mimes=m;return o},getFileExtension:function(n){var m=n&&n.match(/\.([^.]+)$/);if(m){return m[1].toLowerCase()}return""},getFileMime:function(m){return this.mimes[this.getFileExtension(m)]||""}};j.addMimeType(i);return j});h("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(o){var k=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],m=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],j;function n(r){var s,t;for(var q=0;q<r.length;q++){s=r[q].s1;t=r[q].prop;j=r[q].sv||r[q].id;if(s){if(s.indexOf(r[q].s2)!=-1){return r[q].id}}else{if(t){return r[q].id}}}}function p(r){var q=r.indexOf(j);if(q==-1){return}return parseFloat(r.substring(q+j.length+1))}var l=(function(){var q={define_property:(function(){return false}()),create_canvas:(function(){var r=document.createElement("canvas");return !!(r.getContext&&r.getContext("2d"))}()),return_response_type:function(r){try{if(o.inArray(r,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var t=new XMLHttpRequest();t.open("get","/");if("responseType" in t){t.responseType=r;if(t.responseType!==r){return false}return true}}}}catch(s){}return false},use_data_uri:(function(){var r=new Image();r.onload=function(){q.use_data_uri=(r.width===1&&r.height===1)};setTimeout(function(){r.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return q.use_data_uri&&(i.browser!=="IE"||i.version>=9)},use_data_uri_of:function(r){return(q.use_data_uri&&r<33000||q.use_data_uri_over32kb())},use_fileinput:function(){var r=document.createElement("input");r.setAttribute("type","file");return !r.disabled}};return function(s){var r=[].slice.call(arguments);r.shift();return o.typeOf(q[s])==="function"?q[s].apply(this,r):!!q[s]}}());var i={can:l,browser:n(k),version:p(navigator.userAgent)||p(navigator.appVersion),OS:n(m),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return i});h("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(j){var k=function(q){if(typeof q!=="string"){return q}return document.getElementById(q)};var l=function(s,r){var q;if(s.className===""){return false}q=new RegExp("(^|\\s+)"+r+"(\\s+|$)");return q.test(s.className)};var m=function(r,q){if(!l(r,q)){r.className=r.className===""?q:r.className.replace(/\s+$/,"")+" "+q}};var p=function(s,r){var q=new RegExp("(^|\\s+)"+r+"(\\s+|$)");s.className=s.className.replace(q,function(u,t,v){return t===" "&&v===" "?" ":""})};var i=function(r,q){if(r.currentStyle){return r.currentStyle[q]}else{if(window.getComputedStyle){return window.getComputedStyle(r,null)[q]}}};var o=function(r,v){var w=0,u=0,A,z=document,s,t;r=r;v=v||z.body;function q(E){var C,D,B=0,F=0;if(E){D=E.getBoundingClientRect();C=z.compatMode==="CSS1Compat"?z.documentElement:z.body;B=D.left+C.scrollLeft;F=D.top+C.scrollTop}return{x:B,y:F}}if(r&&r.getBoundingClientRect&&j.browser==="IE"&&(!z.documentMode||z.documentMode<8)){s=q(r);t=q(v);return{x:s.x-t.x,y:s.y-t.y}}A=r;while(A&&A!=v&&A.nodeType){w+=A.offsetLeft||0;u+=A.offsetTop||0;A=A.offsetParent}A=r.parentNode;while(A&&A!=v&&A.nodeType){w-=A.scrollLeft||0;u-=A.scrollTop||0;A=A.parentNode}return{x:w,y:u}};var n=function(q){return{w:q.offsetWidth||q.clientWidth,h:q.offsetHeight||q.clientHeight}};return{get:k,hasClass:l,addClass:m,removeClass:p,getStyle:i,getPos:o,getSize:n}});h("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(j){function i(m,l){var k;for(k in m){if(m[k]===l){return k}}return null}return{RuntimeError:(function(){var k={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": RuntimeError "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),OperationNotAllowedException:(function(){function k(l){this.code=l;this.name="OperationNotAllowedException"}j.extend(k,{NOT_ALLOWED_ERR:1});k.prototype=Error.prototype;return k}()),ImageError:(function(){var k={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": ImageError "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),FileException:(function(){var k={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": FileException "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),DOMException:(function(){var k={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function l(m){this.code=m;this.name=i(k,m);this.message=this.name+": DOMException "+this.code}j.extend(l,k);l.prototype=Error.prototype;return l}()),EventException:(function(){function k(l){this.code=l;this.name="EventException"}j.extend(k,{UNSPECIFIED_EVENT_TYPE_ERR:0});k.prototype=Error.prototype;return k}())}});h("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(i,j){function k(){var l={};j.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=j.guid("uid_")}},addEventListener:function(q,p,n,o){var m=this,r;q=j.trim(q);if(/\s/.test(q)){j.each(q.split(/\s+/),function(s){m.addEventListener(s,p,n,o)});return}q=q.toLowerCase();n=parseInt(n,10)||0;r=l[this.uid]&&l[this.uid][q]||[];r.push({fn:p,priority:n,scope:o||this});if(!l[this.uid]){l[this.uid]={}}l[this.uid][q]=r},hasEventListener:function(m){return m?!!(l[this.uid]&&l[this.uid][m]):!!l[this.uid]},removeEventListener:function(o,n){o=o.toLowerCase();var p=l[this.uid]&&l[this.uid][o],m;if(p){if(n){for(m=p.length-1;m>=0;m--){if(p[m].fn===n){p.splice(m,1);break}}}else{p=[]}if(!p.length){delete l[this.uid][o];if(j.isEmptyObj(l[this.uid])){delete l[this.uid]}}}},removeAllEventListeners:function(){if(l[this.uid]){delete l[this.uid]}},dispatchEvent:function(s){var r,t,q,p,o={},n=true;if(j.typeOf(s)!=="string"){p=s;if(j.typeOf(p.type)==="string"){s=p.type;if(p.total&&p.loaded){o.total=p.total;o.loaded=p.loaded}o.async=p.async||false}else{throw new i.EventException(i.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(s.indexOf("::")!==-1){(function(u){r=u[0];s=u[1]}(s.split("::")))}else{r=this.uid}s=s.toLowerCase();t=l[r]&&l[r][s];if(t){t.sort(function(v,u){return u.priority-v.priority});q=[].slice.call(arguments);q.shift();o.type=s;q.unshift(o);var m=[];j.each(t,function(u){q[0].target=u.scope;if(o.async){m.push(function(v){setTimeout(function(){v(u.fn.apply(u.scope,q)===false)},1)})}else{m.push(function(v){v(u.fn.apply(u.scope,q)===false)})}});if(m.length){j.inSeries(m,function(u){n=!u})}}return n},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(m){var o;if(j.typeOf(m)!=="array"){m=[m]}for(var n=0;n<m.length;n++){o="on"+m[n];if(j.typeOf(this[o])==="function"){this.addEventListener(m[n],this[o])}else{if(j.typeOf(this[o])==="undefined"){this[o]=null}}}}})}k.instance=new k();return k});h("moxie/core/utils/Encode",[],function(){var k=function(m){return unescape(encodeURIComponent(m))};var l=function(m){return decodeURIComponent(escape(m))};var j=function(t,y){if(typeof(window.atob)==="function"){return y?l(window.atob(t)):window.atob(t)}var p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o,n,m,x,w,v,u,z,s=0,A=0,q="",r=[];if(!t){return t}t+="";do{x=p.indexOf(t.charAt(s++));w=p.indexOf(t.charAt(s++));v=p.indexOf(t.charAt(s++));u=p.indexOf(t.charAt(s++));z=x<<18|w<<12|v<<6|u;o=z>>16&255;n=z>>8&255;m=z&255;if(v==64){r[A++]=String.fromCharCode(o)}else{if(u==64){r[A++]=String.fromCharCode(o,n)}else{r[A++]=String.fromCharCode(o,n,m)}}}while(s<t.length);q=r.join("");return y?l(q):q};var i=function(v,A){if(A){k(v)}if(typeof(window.btoa)==="function"){return window.btoa(v)}var q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var p,o,n,z,y,x,w,B,u=0,C=0,t="",s=[];if(!v){return v}do{p=v.charCodeAt(u++);o=v.charCodeAt(u++);n=v.charCodeAt(u++);B=p<<16|o<<8|n;z=B>>18&63;y=B>>12&63;x=B>>6&63;w=B&63;s[C++]=q.charAt(z)+q.charAt(y)+q.charAt(x)+q.charAt(w)}while(u<v.length);t=s.join("");var m=v.length%3;return(m?t.slice(0,m-3):t)+"===".slice(m||3)};return{utf8_encode:k,utf8_decode:l,atob:j,btoa:i}});h("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(m,l,n){var i={},j={};function k(w,t,r,p,s){var v=this,o,u=m.guid(t+"_");function q(x,y){var A=null,z=w&&w.required_caps;y=y||"browser";if(this.mode!==null){return this.mode}if(z&&!m.isEmptyObj(x)){m.each(z,function(D,B){if(x.hasOwnProperty(B)){var C=x[B](D);if(typeof(C)==="string"){C=[C]}if(!A){A=C}else{if(!(A=m.arrayIntersect(A,C))){return(A=false)}}}});if(A){this.mode=m.inArray(y,A)!==-1?y:A[0]}else{if(A===false){this.mode=false}}}if(this.mode===null){this.mode=y}if(this.mode&&z&&!this.can(z)){this.mode=false}}j[u]=this;r=m.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},r);o=(function(){var x={};return{exec:function(A,y,B,z){if(o[y]){if(!x[A]){x[A]={context:this,instance:new o[y]()}}if(x[A].instance[B]){return x[A].instance[B].apply(this,z)}}},removeInstance:function(y){delete x[y]},removeAllInstances:function(){var y=this;m.each(x,function(A,z){if(m.typeOf(A.instance.destroy)==="function"){A.instance.destroy.call(A.context)}y.removeInstance(z)})}}}());m.extend(this,{initialized:false,uid:u,type:t,mode:null,shimid:u+"_container",clients:0,options:w,can:function(z,A){var x=arguments[2]||r;if(m.typeOf(z)==="string"&&m.typeOf(A)==="undefined"){z=k.parseCaps(z)}if(m.typeOf(z)==="object"){for(var y in z){if(!this.can(y,z[y],x)){return false}}return true}if(m.typeOf(x[z])==="function"){return x[z].call(this,A)}else{return(A===x[z])}},getShimContainer:function(){var x,y=l.get(this.shimid);if(!y){x=this.options.container?l.get(this.options.container):document.body;y=document.createElement("div");y.id=this.shimid;y.className="moxie-shim moxie-shim-"+this.type;m.extend(y.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});x.appendChild(y);x=null}return y},getShim:function(){return o},shimExec:function(y,z){var x=[].slice.call(arguments,2);return v.getShim().exec.call(this,this.uid,y,z,x)},exec:function(y,z){var x=[].slice.call(arguments,2);if(v[y]&&v[y][z]){return v[y][z].apply(this,x)}return v.shimExec.apply(this,arguments)},destroy:function(){if(!v){return}var x=l.get(this.shimid);if(x){x.parentNode.removeChild(x)}if(o){o.removeAllInstances()}this.unbindAll();delete j[this.uid];this.uid=null;u=v=o=x=null}});q.call(this,p,s)}k.order="html5,flash,silverlight,html4";k.getRuntime=function(o){return j[o]?j[o]:false};k.addConstructor=function(p,o){o.prototype=n.instance;i[p]=o};k.getConstructor=function(o){return i[o]||null};k.getInfo=function(o){var p=k.getRuntime(o);if(p){return{uid:p.uid,type:p.type,can:function(){return p.can.apply(p,arguments)}}}return null};k.parseCaps=function(o){var p={};if(m.typeOf(o)!=="string"){return o||{}}m.each(o.split(","),function(q){p[q]=true});return p};k.can=function(p,r){var q,o=k.getConstructor(p),s;if(o){q=new o({required_caps:r});s=q.mode;q.destroy();return !!s}return false};k.thatCan=function(q,r){var p=(r||k.order).split(/\s*,\s*/);for(var o in p){if(k.can(p[o],q)){return p[o]}}return null};k.capTrue=function(){return true};k.capFalse=function(){return false};k.capTest=function(o){return function(){return !!o}};return k});h("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(i,l,k){return function j(){var m;l.extend(this,{connectRuntime:function(q){var o=this,p;function n(r){var t,s;if(!r.length){o.trigger("RuntimeError",new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR));m=null;return}t=r.shift();s=k.getConstructor(t);if(!s){n(r);return}m=new s(q);m.bind("Init",function(){m.initialized=true;setTimeout(function(){m.clients++;o.trigger("RuntimeInit",m)},1)});m.bind("Error",function(){m.destroy();n(r)});if(!m.mode){m.trigger("Error");return}m.init()}if(l.typeOf(q)==="string"){p=q}else{if(l.typeOf(q.ruid)==="string"){p=q.ruid}}if(p){m=k.getRuntime(p);if(m){m.clients++;return m}else{throw new i.RuntimeError(i.RuntimeError.NOT_INIT_ERR)}}n((q.runtime_order||k.order).split(/\s*,\s*/))},getRuntime:function(){if(m&&m.uid){return m}m=null;return null},disconnectRuntime:function(){if(m&&--m.clients<=0){m.destroy();m=null}}})}});h("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(l,j,k){var i={};function m(p,o){function n(u,q,s){var r,t=i[this.uid];if(l.typeOf(t)!=="string"||!t.length){return null}r=new m(null,{type:s,size:q-u});r.detach(t.substr(u,r.size));return r}k.call(this);if(p){this.connectRuntime(p)}if(!o){o={}}else{if(l.typeOf(o)==="string"){o={data:o}}}l.extend(this,{uid:o.uid||l.guid("uid_"),ruid:p,size:o.size||0,type:o.type||"",slice:function(s,q,r){if(this.isDetached()){return n.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),s,q,r)},getSource:function(){if(!i[this.uid]){return null}return i[this.uid]},detach:function(r){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",i[this.uid]);this.disconnectRuntime();this.ruid=null}r=r||"";var q=r.match(/^data:([^;]*);base64,/);if(q){this.type=q[1];r=j.atob(r.substring(r.indexOf("base64,")+7))}this.size=r.length;i[this.uid]=r},isDetached:function(){return !this.ruid&&l.typeOf(i[this.uid])==="string"},destroy:function(){this.detach();delete i[this.uid]}});if(o.data){this.detach(o.data)}else{i[this.uid]=o}}return m});h("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(k,j,l){function i(n,o){var m,p;if(!o){o={}}if(o.type&&o.type!==""){p=o.type}else{p=j.getFileMime(o.name)}if(o.name){m=o.name.replace(/\\/g,"/");m=m.substr(m.lastIndexOf("/")+1)}else{var q=p.split("/")[0];m=k.guid((q!==""?q:"file")+"_");if(j.extensions[p]){m+="."+j.extensions[p][0]}}l.apply(this,arguments);k.extend(this,{type:p||"",name:m||k.guid("file_"),lastModifiedDate:o.lastModifiedDate||(new Date()).toLocaleString()})}i.prototype=l.prototype;return i});h("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(j,m,l,q,s,k,o,i,p){var r=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function n(w){var u=this,t,v,x;if(j.inArray(j.typeOf(w),["string","node"])!==-1){w={browse_button:w}}v=l.get(w.browse_button);if(!v){throw new q.DOMException(q.DOMException.NOT_FOUND_ERR)}x={accept:[{title:k.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:v.parentNode||document.body};w=j.extend({},x,w);if(typeof(w.required_caps)==="string"){w.required_caps=i.parseCaps(w.required_caps)}if(typeof(w.accept)==="string"){w.accept=m.mimes2extList(w.accept)}t=l.get(w.container);if(!t){t=document.body}if(l.getStyle(t,"position")==="static"){t.style.position="relative"}t=v=null;p.call(u);j.extend(u,{uid:j.guid("uid_"),ruid:null,files:null,init:function(){u.convertEventPropsToHandlers(r);u.bind("RuntimeInit",function(z,y){u.ruid=y.uid;u.bind("Ready",function(){u.trigger("Refresh")},999);u.bind("Change",function(){var A=y.exec.call(u,"FileInput","getFiles");u.files=[];j.each(A,function(B){if(B.size===0){return true}u.files.push(new o(u.ruid,B))})},999);u.bind("Refresh",function(){var D,C,B,A;B=l.get(w.browse_button);A=l.get(y.shimid);if(B){D=l.getPos(B,l.get(w.container));C=l.getSize(B);if(A){j.extend(A.style,{top:D.y+"px",left:D.x+"px",width:C.w+"px",height:C.h+"px"})}}A=B=null});y.exec.call(u,"FileInput","init",w)});u.connectRuntime(j.extend({},w,{required_caps:{select_file:true}}))},disable:function(z){var y=this.getRuntime();if(y){y.exec.call(this,"FileInput","disable",j.typeOf(z)==="undefined"?true:z)}},refresh:function(){u.trigger("Refresh")},destroy:function(){var y=this.getRuntime();if(y){y.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(j.typeOf(this.files)==="array"){j.each(this.files,function(z){z.destroy()})}this.files=null}})}n.prototype=s.instance;return n});h("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(k,l,p,i,n,o,r,m){var q=["ready","dragenter","dragleave","drop","error"];function j(t){var s=this,u;if(typeof(t)==="string"){t={drop_zone:t}}u={accept:[{title:k.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};t=typeof(t)==="object"?i.extend({},u,t):u;t.container=l.get(t.drop_zone)||document.body;if(l.getStyle(t.container,"position")==="static"){t.container.style.position="relative"}if(typeof(t.accept)==="string"){t.accept=m.mimes2extList(t.accept)}o.call(s);i.extend(s,{uid:i.guid("uid_"),ruid:null,files:null,init:function(){s.convertEventPropsToHandlers(q);s.bind("RuntimeInit",function(w,v){s.ruid=v.uid;s.bind("Drop",function(){var x=v.exec.call(s,"FileDrop","getFiles");s.files=[];i.each(x,function(y){s.files.push(new n(s.ruid,y))})},999);v.exec.call(s,"FileDrop","init",t);s.dispatchEvent("ready")});s.connectRuntime(t)},destroy:function(){var v=this.getRuntime();if(v){v.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}j.prototype=r.instance;return j});h("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(k,j,l){function i(){this.uid=k.guid("uid_");j.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}i.prototype=l.instance;return i});h("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(i,m,o,q,l,n,k){var p=["loadstart","progress","load","abort","error","loadend"];function j(){var r=this,t;i.extend(this,{uid:i.guid("uid_"),readyState:j.EMPTY,result:null,error:null,readAsBinaryString:function(u){s.call(this,"readAsBinaryString",u)},readAsDataURL:function(u){s.call(this,"readAsDataURL",u)},readAsText:function(u){s.call(this,"readAsText",u)},abort:function(){this.result=null;if(i.inArray(this.readyState,[j.EMPTY,j.DONE])!==-1){return}else{if(this.readyState===j.LOADING){this.readyState=j.DONE}}if(t){t.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(t){t.getRuntime().exec.call(this,"FileReader","destroy");t.disconnectRuntime()}r=t=null}});function s(z,v){t=new k();function x(A){r.readyState=j.DONE;r.error=A;r.trigger("error");w()}function w(){t.destroy();t=null;r.trigger("loadend")}function u(A){t.bind("Error",function(C,B){x(B)});t.bind("Progress",function(B){r.result=A.exec.call(t,"FileReader","getResult");r.trigger(B)});t.bind("Load",function(B){r.readyState=j.DONE;r.result=A.exec.call(t,"FileReader","getResult");r.trigger(B);w()});A.exec.call(t,"FileReader","read",z,v)}this.convertEventPropsToHandlers(p);if(this.readyState===j.LOADING){return x(new o.DOMException(o.DOMException.INVALID_STATE_ERR))}this.readyState=j.LOADING;this.trigger("loadstart");if(v instanceof l){if(v.isDetached()){var y=v.getSource();switch(z){case"readAsText":case"readAsBinaryString":this.result=y;break;case"readAsDataURL":this.result="data:"+v.type+";base64,"+m.btoa(y);break}this.readyState=j.DONE;this.trigger("load");w()}else{u(t.connectRuntime(v.ruid))}}else{x(new o.DOMException(o.DOMException.NOT_FOUND_ERR))}}}j.EMPTY=0;j.LOADING=1;j.DONE=2;j.prototype=q.instance;return j});h("moxie/core/utils/Url",[],function(){var i=function(s){var o=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],n=o.length,t={http:80,https:443},q={},p=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,l=p.exec(s||"");while(n--){if(l[n]){q[o[n]]=l[n]}}if(/^[^\/]/.test(q.path)&&!q.scheme){var r=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(r)){r=r.replace(/[^\/]+$/,"")}q.host=document.location.hostname;q.path=r+(q.path||"")}if(!q.scheme){q.scheme=document.location.protocol.replace(/:$/,"")}if(!q.host){q.host=document.location.hostname}if(!q.port){q.port=document.location.port||t[q.scheme]||80}q.port=parseInt(q.port,10);if(!q.path){q.path="/"}delete q.source;return q};var k=function(m){var n={http:80,https:443},l=i(m);return l.scheme+"://"+l.host+(l.port!==n[l.scheme]?":"+l.port:"")+l.path+(l.query?l.query:"")};var j=function(m){function l(n){return[n.scheme,n.host,n.port].join("/")}if(typeof m==="string"){m=i(m)}return l(i())===l(m)};return{parseUrl:i,resolveUrl:k,hasSameOrigin:j}});h("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(k,j,i){return function(){j.call(this);k.extend(this,{uid:k.guid("uid_"),readAsBinaryString:function(m){return l.call(this,"readAsBinaryString",m)},readAsDataURL:function(m){return l.call(this,"readAsDataURL",m)},readAsText:function(m){return l.call(this,"readAsText",m)}});function l(s,o){if(o.isDetached()){var r=o.getSource();switch(s){case"readAsBinaryString":return r;case"readAsDataURL":return"data:"+o.type+";base64,"+i.btoa(r);case"readAsText":var n="";for(var p=0,q=r.length;p<q;p++){n+=String.fromCharCode(r[p])}return n}}else{var m=this.connectRuntime(o.ruid).exec.call(this,"FileReaderSync","read",s,o);this.disconnectRuntime();return m}}}});h("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(i,j,l){function k(){var n,o={},m="";j.extend(this,{append:function(q,r){var p=this,s=j.typeOf(r);if(r instanceof l){if(n){delete o[n]}n=q;o[q]=[r]}else{if("array"===s){q+="[]";j.each(r,function(t){p.append.call(p,q,t)})}else{if("object"===s){j.each(r,function(u,t){p.append.call(p,q+"["+t+"]",u)})}else{r=r.toString();if(!o[q]){o[q]=[]}o[q].push(r)}}}},hasBlob:function(){return !!n},getBlob:function(){return o[n]&&o[n][0]||null},getBlobName:function(){return n||null},each:function(p){j.each(o,function(r,q){j.each(r,function(s){p(s,q)})})},destroy:function(){n=null;m="";o={}}})}return k});h("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(q,r,p,y,u,o,s,n,w,z,i,t){var j={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function m(){this.uid=q.guid("uid_")}m.prototype=p.instance;var l=["loadstart","progress","abort","error","load","timeout","loadend"];var k=1,A=2;function v(){var R=this,E={timeout:0,readyState:v.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},Y=true,J,P,Q={},S,G,I=null,K=null,ab=false,B=false,x=false,L=false,D=false,H=false,N,X,W=null,Z=null,U={},O,V="",C;q.extend(this,E,{uid:q.guid("uid_"),upload:new m(),open:function(ah,af,ag,ad,ae){var ac;if(!ah||!af){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(ah)||y.utf8_encode(ah)!==ah){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}if(!!~q.inArray(ah.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){P=ah.toUpperCase()}if(!!~q.inArray(P,["CONNECT","TRACE","TRACK"])){throw new r.DOMException(r.DOMException.SECURITY_ERR)}af=y.utf8_encode(af);ac=u.parseUrl(af);H=u.hasSameOrigin(ac);J=u.resolveUrl(af);if((ad||ae)&&!H){throw new r.DOMException(r.DOMException.INVALID_ACCESS_ERR)}S=ad||ac.user;G=ae||ac.pass;Y=ag||true;if(Y===false&&(aa("timeout")||aa("withCredentials")||aa("responseType")!=="")){throw new r.DOMException(r.DOMException.INVALID_ACCESS_ERR)}ab=!Y;B=false;Q={};M.call(this);aa("readyState",v.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(ae,ad){var ac=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(aa("readyState")!==v.OPENED||B){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(ae)||y.utf8_encode(ae)!==ae){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}ae=q.trim(ae).toLowerCase();if(!!~q.inArray(ae,ac)||/^(proxy\-|sec\-)/.test(ae)){return false}if(!Q[ae]){Q[ae]=ad}else{Q[ae]+=", "+ad}return true},getAllResponseHeaders:function(){return V||""},getResponseHeader:function(ac){ac=ac.toLowerCase();if(D||!!~q.inArray(ac,["set-cookie","set-cookie2"])){return null}if(V&&V!==""){if(!C){C={};q.each(V.split(/\r\n/),function(ad){var ae=ad.split(/:\s+/);if(ae.length===2){ae[0]=q.trim(ae[0]);C[ae[0].toLowerCase()]={header:ae[0],value:q.trim(ae[1])}}})}if(C.hasOwnProperty(ac)){return C[ac].header+": "+C[ac].value}}return null},overrideMimeType:function(ad){var ac,ae;if(!!~q.inArray(aa("readyState"),[v.LOADING,v.DONE])){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}ad=q.trim(ad.toLowerCase());if(/;/.test(ad)&&(ac=ad.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){ad=ac[1];if(ac[2]){ae=ac[2]}}if(!t.mimes[ad]){throw new r.DOMException(r.DOMException.SYNTAX_ERR)}W=ad;Z=ae},send:function(ae,ad){if(q.typeOf(ad)==="string"){U={ruid:ad}}else{if(!ad){U={}}else{U=ad}}this.convertEventPropsToHandlers(l);this.upload.convertEventPropsToHandlers(l);if(this.readyState!==v.OPENED||B){throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}if(ae instanceof n){U.ruid=ae.ruid;K=ae.type||"application/octet-stream"}else{if(ae instanceof z){if(ae.hasBlob()){var ac=ae.getBlob();U.ruid=ac.ruid;K=ac.type||"application/octet-stream"}}else{if(typeof ae==="string"){I="UTF-8";K="text/plain;charset=UTF-8";ae=y.utf8_encode(ae)}}}if(!this.withCredentials){this.withCredentials=(U.required_caps&&U.required_caps.send_browser_cookies)&&!H}x=(!ab&&this.upload.hasEventListener());D=false;L=!ae;if(!ab){B=true;if(!L){}}F.call(this,ae)},abort:function(){D=true;ab=false;if(!~q.inArray(aa("readyState"),[v.UNSENT,v.OPENED,v.DONE])){aa("readyState",v.DONE);B=false;if(O){O.getRuntime().exec.call(O,"XMLHttpRequest","abort",L)}else{throw new r.DOMException(r.DOMException.INVALID_STATE_ERR)}L=true}else{aa("readyState",v.UNSENT)}},destroy:function(){if(O){if(q.typeOf(O.destroy)==="function"){O.destroy()}O=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function aa(ad,ac){if(!E.hasOwnProperty(ad)){return}if(arguments.length===1){return i.can("define_property")?E[ad]:R[ad]}else{if(i.can("define_property")){E[ad]=ac}else{R[ad]=ac}}}function F(af){var ad=this;N=new Date().getTime();O=new s();function ae(){O.destroy();O=null;ad.dispatchEvent("loadend");ad=null}function ac(ag){O.bind("LoadStart",function(ah){aa("readyState",v.LOADING);ad.dispatchEvent("readystatechange");ad.dispatchEvent(ah);if(x){ad.upload.dispatchEvent(ah)}});O.bind("Progress",function(ah){if(aa("readyState")!==v.LOADING){aa("readyState",v.LOADING);ad.dispatchEvent("readystatechange")}ad.dispatchEvent(ah)});O.bind("UploadProgress",function(ah){if(x){ad.upload.dispatchEvent({type:"progress",lengthComputable:false,total:ah.total,loaded:ah.loaded})}});O.bind("Load",function(ah){aa("readyState",v.DONE);aa("status",Number(ag.exec.call(O,"XMLHttpRequest","getStatus")||0));aa("statusText",j[aa("status")]||"");aa("response",ag.exec.call(O,"XMLHttpRequest","getResponse",aa("responseType")));if(!!~q.inArray(aa("responseType"),["text",""])){aa("responseText",aa("response"))}else{if(aa("responseType")==="document"){aa("responseXML",aa("response"))}}V=ag.exec.call(O,"XMLHttpRequest","getAllResponseHeaders");ad.dispatchEvent("readystatechange");if(aa("status")>0){if(x){ad.upload.dispatchEvent(ah)}ad.dispatchEvent(ah)}else{D=true;ad.dispatchEvent("error")}ae()});O.bind("Abort",function(ah){ad.dispatchEvent(ah);ae()});O.bind("Error",function(ah){D=true;aa("readyState",v.DONE);ad.dispatchEvent("readystatechange");L=true;ad.dispatchEvent(ah);ae()});ag.exec.call(O,"XMLHttpRequest","send",{url:J,method:P,async:Y,user:S,password:G,headers:Q,mimeType:K,encoding:I,responseType:ad.responseType,withCredentials:ad.withCredentials,options:U},af)}if(typeof(U.required_caps)==="string"){U.required_caps=o.parseCaps(U.required_caps)}U.required_caps=q.extend({},U.required_caps,{return_response_type:ad.responseType});if(af instanceof z){U.required_caps.send_multipart=true}if(!H){U.required_caps.do_cors=true}if(U.ruid){ac(O.connectRuntime(U))}else{O.bind("RuntimeInit",function(ah,ag){ac(ag)});O.bind("RuntimeError",function(ah,ag){ad.dispatchEvent("RuntimeError",ag)});O.connectRuntime(U)}}function M(){aa("responseText","");aa("responseXML",null);aa("response",null);aa("status",0);aa("statusText","");N=X=null}}v.UNSENT=0;v.OPENED=1;v.HEADERS_RECEIVED=2;v.LOADING=3;v.DONE=4;v.prototype=p.instance;return v});h("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(l,i,j,m){function k(){var r,p,n,s,v,u;j.call(this);l.extend(this,{uid:l.guid("uid_"),state:k.IDLE,result:null,transport:function(A,z,y){var x=this;y=l.extend({chunk_size:204798},y);if((r=y.chunk_size%3)){y.chunk_size+=3-r}u=y.chunk_size;t.call(this);n=A;s=A.length;if(l.typeOf(y)==="string"||y.ruid){q.call(x,z,this.connectRuntime(y))}else{var w=function(C,B){x.unbind("RuntimeInit",w);q.call(x,z,B)};this.bind("RuntimeInit",w);this.connectRuntime(y)}},abort:function(){var w=this;w.state=k.IDLE;if(p){p.exec.call(w,"Transporter","clear");w.trigger("TransportingAborted")}t.call(w)},destroy:function(){this.unbindAll();p=null;this.disconnectRuntime();t.call(this)}});function t(){s=v=0;n=this.result=null}function q(x,y){var w=this;p=y;w.bind("TransportingProgress",function(z){v=z.loaded;if(v<s&&l.inArray(w.state,[k.IDLE,k.DONE])===-1){o.call(w)}},999);w.bind("TransportingComplete",function(){v=s;w.state=k.DONE;n=null;w.result=p.exec.call(w,"Transporter","getAsBlob",x||"")},999);w.state=k.BUSY;w.trigger("TransportingStarted");o.call(w)}function o(){var w=this,x,y=s-v;if(u>y){u=y}x=i.btoa(n.substr(v,u));p.exec.call(w,"Transporter","receive",x,s)}}k.IDLE=0;k.BUSY=1;k.DONE=2;k.prototype=m.instance;return k});h("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var l,j,i={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},u,s=function(v){throw {name:"SyntaxError",message:v,at:l,text:u}},o=function(v){if(v&&v!==j){s("Expected '"+v+"' instead of '"+j+"'")}j=u.charAt(l);l+=1;return j},n=function(){var w,v="";if(j==="-"){v="-";o("-")}while(j>="0"&&j<="9"){v+=j;o()}if(j==="."){v+=".";while(o()&&j>="0"&&j<="9"){v+=j}}if(j==="e"||j==="E"){v+=j;o();if(j==="-"||j==="+"){v+=j;o()}while(j>="0"&&j<="9"){v+=j;o()}}w=+v;if(!isFinite(w)){s("Bad number")}else{return w}},p=function(){var y,x,w="",v;if(j==='"'){while(o()){if(j==='"'){o();return w}else{if(j==="\\"){o();if(j==="u"){v=0;for(x=0;x<4;x+=1){y=parseInt(o(),16);if(!isFinite(y)){break}v=v*16+y}w+=String.fromCharCode(v)}else{if(typeof i[j]==="string"){w+=i[j]}else{break}}}else{w+=j}}}}s("Bad string")},r=function(){while(j&&j<=" "){o()}},k=function(){switch(j){case"t":o("t");o("r");o("u");o("e");return true;case"f":o("f");o("a");o("l");o("s");o("e");return false;case"n":o("n");o("u");o("l");o("l");return null}s("Unexpected '"+j+"'")},t,q=function(){var v=[];if(j==="["){o("[");r();if(j==="]"){o("]");return v}while(j){v.push(t());r();if(j==="]"){o("]");return v}o(",");r()}}s("Bad array")},m=function(){var w,v={};if(j==="{"){o("{");r();if(j==="}"){o("}");return v}while(j){w=p();r();o(":");if(Object.hasOwnProperty.call(v,w)){s('Duplicate key "'+w+'"')}v[w]=t();r();if(j==="}"){o("}");return v}o(",");r()}}s("Bad object")};t=function(){r();switch(j){case"{":return m();case"[":return q();case'"':return p();case"-":return n();default:return j>="0"&&j<="9"?n():k()}};return function(y,w){var v;u=y;l=0;j=" ";v=t();r();if(j){s("Syntax error")}return typeof w==="function"?(function x(C,B){var A,z,D=C[B];if(D&&typeof D==="object"){for(A in D){if(Object.prototype.hasOwnProperty.call(D,A)){z=x(D,A);if(z!==g){D[A]=z}else{delete D[A]}}}}return w.call(C,B,D)}({"":v},"")):v}}())});h("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(k,o,u,s,v,j,t,n,r,y,m,q,p,l){var w=["progress","load","error","resize","embedded"];function i(){t.call(this);k.extend(this,{uid:k.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){z.call(this)},999);this.convertEventPropsToHandlers(w);A.apply(this,arguments)},downsize:function(H,D,G,E){try{if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(this.width>i.MAX_RESIZE_WIDTH||this.height>i.MAX_RESIZE_HEIGHT){throw new u.ImageError(u.ImageError.MAX_RESOLUTION_ERR)}if(!H&&!D||k.typeOf(G)==="undefined"){G=false}H=H||this.width;D=D||this.height;E=(k.typeOf(E)==="undefined"?true:!!E);this.getRuntime().exec.call(this,"Image","downsize",H,D,G,E)}catch(F){this.trigger("error",F)}},crop:function(F,D,E){this.downsize(F,D,true,E)},getAsCanvas:function(){if(!r.can("create_canvas")){throw new u.RuntimeError(u.RuntimeError.NOT_SUPPORTED_ERR)}var D=this.connectRuntime(this.ruid);return D.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(D,E){if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(!D){D="image/jpeg"}if(D==="image/jpeg"&&!E){E=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",D,E)},getAsDataURL:function(D,E){if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",D,E)},getAsBinaryString:function(D,F){var E=this.getAsDataURL(D,F);return p.atob(E.substring(E.indexOf("base64,")+7))},embed:function(G){var O=this,L,K,M,I,P=arguments[1]||{},F=this.width,N=this.height,H;function E(){if(r.can("create_canvas")){var Q=L.getAsCanvas();if(Q){G.appendChild(Q);Q=null;L.destroy();O.trigger("embedded");return}}var S=L.getAsDataURL(K,M);if(!S){throw new u.ImageError(u.ImageError.WRONG_FORMAT)}if(r.can("use_data_uri_of",S.length)){G.innerHTML='<img src="'+S+'" width="'+L.width+'" height="'+L.height+'" />';L.destroy();O.trigger("embedded")}else{var R=new n();R.bind("TransportingComplete",function(){H=O.connectRuntime(this.result.ruid);O.bind("Embedded",function(){k.extend(H.getShimContainer().style,{top:"0px",left:"0px",width:L.width+"px",height:L.height+"px"});H=null},999);H.exec.call(O,"ImageView","display",this.result.uid,F,N);L.destroy()});R.transport(p.atob(S.substring(S.indexOf("base64,")+7)),K,k.extend({},P,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:G}))}}try{if(!(G=o.get(G))){throw new u.DOMException(u.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}if(this.width>i.MAX_RESIZE_WIDTH||this.height>i.MAX_RESIZE_HEIGHT){throw new u.ImageError(u.ImageError.MAX_RESOLUTION_ERR)}K=P.type||this.type||"image/jpeg";M=P.quality||90;I=k.typeOf(P.crop)!=="undefined"?P.crop:false;if(P.width){F=P.width;N=P.height||F}else{var D=o.getSize(G);if(D.w&&D.h){F=D.w;N=D.h}}L=new i();L.bind("Resize",function(){E.call(O)});L.bind("Load",function(){L.downsize(F,N,I,false)});L.clone(this,false);return L}catch(J){this.trigger("error",J)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function z(E){if(!E){E=this.getRuntime().exec.call(this,"Image","getInfo")}if(E){if(k.typeOf(E.meta)==="string"){try{this.meta=l(E.meta)}catch(D){}}else{this.meta=E.meta}}k.extend(this,{size:parseInt(E.size,10),width:parseInt(E.width,10),height:parseInt(E.height,10),type:E.type});if(this.name===""){this.name=E.name}}function A(F){var E=k.typeOf(F);try{if(F instanceof i){if(!F.size){throw new u.DOMException(u.DOMException.INVALID_STATE_ERR)}x.apply(this,arguments)}else{if(F instanceof m){if(!~k.inArray(F.type,["image/jpeg","image/png"])){throw new u.ImageError(u.ImageError.WRONG_FORMAT)}B.apply(this,arguments)}else{if(k.inArray(E,["blob","file"])!==-1){A.call(this,new q(null,F),arguments[1])}else{if(E==="string"){if(/^data:[^;]*;base64,/.test(F)){A.call(this,new m(null,{data:F}),arguments[1])}else{C.apply(this,arguments)}}else{if(E==="node"&&F.nodeName.toLowerCase()==="img"){A.call(this,F.src,arguments[1])}else{throw new u.DOMException(u.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(D){this.trigger("error",D)}}function x(D,E){var F=this.connectRuntime(D.ruid);this.ruid=F.uid;F.exec.call(this,"Image","loadFromImage",D,(k.typeOf(E)==="undefined"?true:E))}function B(F,G){var E=this;E.name=F.name||"";function D(H){E.ruid=H.uid;H.exec.call(E,"Image","loadFromBlob",F)}if(F.isDetached()){this.bind("RuntimeInit",function(I,H){D(H)});if(G&&typeof(G.required_caps)==="string"){G.required_caps=j.parseCaps(G.required_caps)}this.connectRuntime(k.extend({required_caps:{access_image_binary:true,resize_image:true}},G))}else{D(this.connectRuntime(F.ruid))}}function C(F,E){var D=this,G;G=new v();G.open("get",F);G.responseType="blob";G.onprogress=function(H){D.trigger(H)};G.onload=function(){B.call(D,G.response,true)};G.onerror=function(H){D.trigger(H)};G.onloadend=function(){G.destroy()};G.bind("RuntimeError",function(I,H){D.trigger("RuntimeError",H)});G.send(null,E)}}i.MAX_RESIZE_WIDTH=6500;i.MAX_RESIZE_HEIGHT=6500;i.prototype=y.instance;return i});h("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(n,i,k,j){var m="html5",l={};function o(q){var p=this,t=k.capTest,s=k.capTrue;var r=n.extend({access_binary:t(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return p.can("access_binary")&&!!l.Image},display_media:t(j.can("create_canvas")||j.can("use_data_uri_over32kb")),do_cors:t(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:t(function(){var u=document.createElement("div");return(("draggable" in u)||("ondragstart" in u&&"ondrop" in u))&&(j.browser!=="IE"||j.version>9)}()),filter_by_extension:t(function(){return(j.browser==="Chrome"&&j.version>=28)||(j.browser==="IE"&&j.version>=10)}()),return_response_headers:s,return_response_type:function(u){if(u==="json"){return true}else{return j.can("return_response_type",u)}},return_status_code:s,report_upload_progress:t(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return p.can("access_binary")&&j.can("create_canvas")},select_file:function(){return j.can("use_fileinput")&&window.File},select_folder:function(){return p.can("select_file")&&j.browser==="Chrome"&&j.version>=21},select_multiple:function(){return p.can("select_file")&&!(j.browser==="Safari"&&j.OS==="Windows")},send_binary_string:t(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:t(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||p.can("send_binary_string")},slice_blob:t(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return p.can("slice_blob")&&p.can("send_multipart")},summon_file_dialog:t(function(){return(j.browser==="Firefox"&&j.version>=4)||(j.browser==="Opera"&&j.version>=12)||(j.browser==="IE"&&j.version>=10)||!!~n.inArray(j.browser,["Chrome","Safari"])}()),upload_filesize:s},arguments[2]);k.call(this,q,(arguments[1]||m),r);n.extend(this,{init:function(){this.trigger("Init")},destroy:(function(u){return function(){u.call(p);u=p=null}}(this.destroy))});n.extend(this.getShim(),l)}k.addConstructor(m,o);return l});h("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(j,k){function i(){function l(n,q,m){var o;if(window.File.prototype.slice){try{n.slice();return n.slice(q,m)}catch(p){return n.slice(q,m-q)}}else{if((o=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return o.call(n,q,m)}else{return null}}}this.slice=function(){return new k(this.getRuntime().uid,l.apply(this,arguments))}}return(j.Blob=i)});h("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(o){var p={},l="moxie_"+o.guid();function k(){this.returnValue=false}function j(){this.cancelBubble=true}var m=function(u,q,v,s){var t,r;q=q.toLowerCase();if(u.addEventListener){t=v;u.addEventListener(q,t,false)}else{if(u.attachEvent){t=function(){var w=window.event;if(!w.target){w.target=w.srcElement}w.preventDefault=k;w.stopPropagation=j;v(w)};u.attachEvent("on"+q,t)}}if(!u[l]){u[l]=o.guid()}if(!p.hasOwnProperty(u[l])){p[u[l]]={}}r=p[u[l]];if(!r.hasOwnProperty(q)){r[q]=[]}r[q].push({func:t,orig:v,key:s})};var n=function(v,q,w){var t,s;q=q.toLowerCase();if(v[l]&&p[v[l]]&&p[v[l]][q]){t=p[v[l]][q]}else{return}for(var r=t.length-1;r>=0;r--){if(t[r].orig===w||t[r].key===w){if(v.removeEventListener){v.removeEventListener(q,t[r].func,false)}else{if(v.detachEvent){v.detachEvent("on"+q,t[r].func)}}t[r].orig=null;t[r].func=null;t.splice(r,1);if(w!==s){break}}}if(!t.length){delete p[v[l]][q]}if(o.isEmptyObj(p[v[l]])){delete p[v[l]];try{delete v[l]}catch(u){v[l]=s}}};var i=function(r,q){if(!r||!r[l]){return}o.each(p[r[l]],function(t,s){n(r,s,q)})};return{addEvent:m,removeEvent:n,removeAllEvents:i}});h("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(m,o,l,j,k,i){function n(){var q=[],p;o.extend(this,{init:function(A){var r=this,y=r.getRuntime(),x,t,u,z,w,v;p=A;q=[];u=p.accept.mimes||k.extList2mimes(p.accept,y.can("filter_by_extension"));t=y.getShimContainer();t.innerHTML='<input id="'+y.uid+'" type="file" style="font-size:999px;opacity:0;"'+(p.multiple&&y.can("select_multiple")?"multiple":"")+(p.directory&&y.can("select_folder")?"webkitdirectory directory":"")+(u?' accept="'+u.join(",")+'"':"")+" />";x=l.get(y.uid);o.extend(x.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});z=l.get(p.browse_button);if(y.can("summon_file_dialog")){if(l.getStyle(z,"position")==="static"){z.style.position="relative"}w=parseInt(l.getStyle(z,"z-index"),10)||1;z.style.zIndex=w;t.style.zIndex=w-1;j.addEvent(z,"click",function(C){var B=l.get(y.uid);if(B&&!B.disabled){B.click()}C.preventDefault()},r.uid)}v=y.can("summon_file_dialog")?z:t;j.addEvent(v,"mouseover",function(){r.trigger("mouseenter")},r.uid);j.addEvent(v,"mouseout",function(){r.trigger("mouseleave")},r.uid);j.addEvent(v,"mousedown",function(){r.trigger("mousedown")},r.uid);j.addEvent(l.get(p.container),"mouseup",function(){r.trigger("mouseup")},r.uid);x.onchange=function s(){q=[];if(p.directory){o.each(this.files,function(C){if(C.name!=="."){q.push(C)}})}else{q=[].slice.call(this.files)}if(i.browser!=="IE"){this.value=""}else{var B=this.cloneNode(true);this.parentNode.replaceChild(B,this);B.onchange=s}r.trigger("change")};r.trigger({type:"ready",async:true});t=null},getFiles:function(){return q},disable:function(t){var s=this.getRuntime(),r;if((r=l.get(s.uid))){r.disabled=!!t}},destroy:function(){var s=this.getRuntime(),r=s.getShimContainer();j.removeAllEvents(r,this.uid);j.removeAllEvents(p&&l.get(p.container),this.uid);j.removeAllEvents(p&&l.get(p.browse_button),this.uid);if(r){r.innerHTML=""}q=p=null}})}return(m.FileInput=n)});h("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(l,m,k,i,j){function n(){var q=[],t=[],p;m.extend(this,{init:function(x){var w=this,y;p=x;t=r(p.accept);y=p.container;i.addEvent(y,"dragover",function(z){z.preventDefault();z.stopPropagation();z.dataTransfer.dropEffect="copy"},w.uid);i.addEvent(y,"drop",function(A){A.preventDefault();A.stopPropagation();q=[];if(A.dataTransfer.items&&A.dataTransfer.items[0].webkitGetAsEntry){var z=[];m.each(A.dataTransfer.items,function(B){z.push(B.webkitGetAsEntry())});u(z,function(){w.trigger("drop")})}else{m.each(A.dataTransfer.files,function(B){if(o(B)){q.push(B)}});w.trigger("drop")}},w.uid);i.addEvent(y,"dragenter",function(z){z.preventDefault();z.stopPropagation();w.trigger("dragenter")},w.uid);i.addEvent(y,"dragleave",function(z){z.preventDefault();z.stopPropagation();w.trigger("dragleave")},w.uid)},getFiles:function(){return q},destroy:function(){i.removeAllEvents(p&&k.get(p.container),this.uid);q=t=p=null}});function r(y){var x=[];for(var w=0;w<y.length;w++){[].push.apply(x,y[w].extensions.split(/\s*,\s*/))}return m.inArray("*",x)===-1?x:[]}function o(w){var x=j.getFileExtension(w.name);return !x||!t.length||m.inArray(x,t)!==-1}function u(y,x){var w=[];m.each(y,function(z){w.push(function(A){s(z,A)})});m.inSeries(w,function(){x()})}function s(x,w){if(x.isFile){x.file(function(y){if(o(y)){q.push(y)}w()},function(){w()})}else{if(x.isDirectory){v(x,w)}else{w()}}}function v(A,x){var w=[],z=A.createReader();function y(B){z.readEntries(function(C){if(C.length){[].push.apply(w,C);y(B)}else{B()}},B)}y(function(){u(w,x)})}}return(l.FileDrop=n)});h("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(j,i,l){function k(){var n,o=false;l.extend(this,{read:function(r,p){var q=this;n=new window.FileReader();n.addEventListener("progress",function(s){q.trigger(s)});n.addEventListener("load",function(s){q.trigger(s)});n.addEventListener("error",function(s){q.trigger(s,n.error)});n.addEventListener("loadend",function(){n=null});if(l.typeOf(n[r])==="function"){o=false;n[r](p.getSource())}else{if(r==="readAsBinaryString"){o=true;n.readAsDataURL(p.getSource())}}},getResult:function(){return n&&n.result?(o?m(n.result):n.result):null},abort:function(){if(n){n.abort()}},destroy:function(){n=null}});function m(p){return i.atob(p.substring(p.indexOf("base64,")+7))}}return(j.FileReader=k)});h("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(p,j,m,i,o,l,s,q,n,k){function r(){var y,w;j.extend(this,{send:function(G,D){var F=this,C=(n.browser==="Mozilla"&&n.version>=4&&n.version<7),z=n.browser==="Android Browser",E=false;w=G.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();y=x();y.open(G.method,G.url,G.async,G.user,G.password);if(D instanceof l){if(D.isDetached()){E=true}D=D.getSource()}else{if(D instanceof s){if(D.hasBlob()){if(D.getBlob().isDetached()){D=v.call(F,D);E=true}else{if((C||z)&&j.typeOf(D.getBlob().getSource())==="blob"&&window.FileReader){t.call(F,G,D);return}}}if(D instanceof s){var B=new window.FormData();D.each(function(I,H){if(I instanceof l){B.append(H,I.getSource())}else{B.append(H,I)}});D=B}}}if(y.upload){if(G.withCredentials){y.withCredentials=true}y.addEventListener("load",function(H){F.trigger(H)});y.addEventListener("error",function(H){F.trigger(H)});y.addEventListener("progress",function(H){F.trigger(H)});y.upload.addEventListener("progress",function(H){F.trigger({type:"UploadProgress",loaded:H.loaded,total:H.total})})}else{y.onreadystatechange=function A(){switch(y.readyState){case 1:break;case 2:break;case 3:var J,H;try{if(i.hasSameOrigin(G.url)){J=y.getResponseHeader("Content-Length")||0}if(y.responseText){H=y.responseText.length}}catch(I){J=H=0}F.trigger({type:"progress",lengthComputable:!!J,total:parseInt(J,10),loaded:H});break;case 4:y.onreadystatechange=function(){};if(y.status===0){F.trigger("error")}else{F.trigger("load")}break}}}if(!j.isEmptyObj(G.headers)){j.each(G.headers,function(H,I){y.setRequestHeader(I,H)})}if(""!==G.responseType&&"responseType" in y){if("json"===G.responseType&&!n.can("return_response_type","json")){y.responseType="text"}else{y.responseType=G.responseType}}if(!E){y.send(D)}else{if(y.sendAsBinary){y.sendAsBinary(D)}else{(function(){var H=new Uint8Array(D.length);for(var I=0;I<D.length;I++){H[I]=(D.charCodeAt(I)&255)}y.send(H.buffer)}())}}F.trigger("loadstart")},getStatus:function(){try{if(y){return y.status}}catch(z){}return 0},getResponse:function(B){var A=this.getRuntime();try{switch(B){case"blob":var D=new o(A.uid,y.response);var E=y.getResponseHeader("Content-Disposition");if(E){var z=E.match(/filename=([\'\"'])([^\1]+)\1/);if(z){w=z[2]}}D.name=w;if(!D.type){D.type=m.getFileMime(w)}return D;case"json":if(!n.can("return_response_type","json")){return y.status===200?k(y.responseText):null}return y.response;case"document":return u(y);default:return y.responseText!==""?y.responseText:null}}catch(C){return null}},getAllResponseHeaders:function(){try{return y.getAllResponseHeaders()}catch(z){}return""},abort:function(){if(y){y.abort()}},destroy:function(){self=w=null}});function t(D,B){var C=this,A,z;A=B.getBlob().getSource();z=new window.FileReader();z.onload=function(){B.append(B.getBlobName(),new l(null,{type:A.type,data:z.result}));self.send.call(C,D,B)};z.readAsBinaryString(A)}function x(){if(window.XMLHttpRequest&&!(n.browser==="IE"&&n.version<8)){return new window.XMLHttpRequest()}else{return(function(){var z=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var B=0;B<z.length;B++){try{return new ActiveXObject(z[B])}catch(A){}}})()}}function u(A){var B=A.responseXML;var z=A.responseText;if(n.browser==="IE"&&z&&B&&!B.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(A.getResponseHeader("Content-Type"))){B=new window.ActiveXObject("Microsoft.XMLDOM");B.async=false;B.validateOnParse=false;B.loadXML(z)}if(B){if((n.browser==="IE"&&B.parseError!==0)||!B.documentElement||B.documentElement.tagName==="parsererror"){return null}}return B}function v(B){var E="----moxieboundary"+new Date().getTime(),C="--",D="\r\n",z="",A=this.getRuntime();if(!A.can("send_binary_string")){throw new q.RuntimeError(q.RuntimeError.NOT_SUPPORTED_ERR)}y.setRequestHeader("Content-Type","multipart/form-data; boundary="+E);B.each(function(G,F){if(G instanceof l){z+=C+E+D+'Content-Disposition: form-data; name="'+F+'"; filename="'+unescape(encodeURIComponent(G.name||"blob"))+'"'+D+"Content-Type: "+G.type+D+D+G.getSource()+D}else{z+=C+E+D+'Content-Disposition: form-data; name="'+F+'"'+D+D+unescape(encodeURIComponent(G))+D}});z+=C+E+C+D;return z}}return(p.XMLHttpRequest=r)});h("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var l=false,j;function m(o,q){var n=l?0:-8*(q-1),r=0,p;for(p=0;p<q;p++){r|=(j.charCodeAt(o+p)<<Math.abs(n+p*8))}return r}function i(p,n,o){o=arguments.length===3?o:j.length-n-1;j=j.substr(0,n)+p+j.substr(o+n)}function k(o,p,r){var s="",n=l?0:-8*(r-1),q;for(q=0;q<r;q++){s+=String.fromCharCode((p>>Math.abs(n+q*8))&255)}i(s,o,r)}return{II:function(n){if(n===g){return l}else{l=n}},init:function(n){l=false;j=n},SEGMENT:function(n,p,o){switch(arguments.length){case 1:return j.substr(n,j.length-n-1);case 2:return j.substr(n,p);case 3:i(o,n,p);break;default:return j}},BYTE:function(n){return m(n,1)},SHORT:function(n){return m(n,2)},LONG:function(n,o){if(o===g){return m(n,4)}else{k(n,o,4)}},SLONG:function(n){var o=m(n,4);return(o>2147483647?o-4294967296:o)},STRING:function(n,o){var p="";for(o+=n;n<o;n++){p+=String.fromCharCode(m(n,1))}return p}}}});h("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(j){return function i(o){var p=[],n,k,l,m=0;n=new j();n.init(o);if(n.SHORT(0)!==65496){return}k=2;while(k<=o.length){l=n.SHORT(k);if(l>=65488&&l<=65495){k+=2;continue}if(l===65498||l===65497){break}m=n.SHORT(k+2)+2;if(l>=65505&&l<=65519){p.push({hex:l,name:"APP"+(l&15),start:k,length:m,segment:n.SEGMENT(k,m)})}k+=m}n.init(null);return{headers:p,restore:function(s){var q,r;n.init(s);k=n.SHORT(2)==65504?4+n.SHORT(4):2;for(r=0,q=p.length;r<q;r++){n.SEGMENT(k,0,p[r].segment);k+=p[r].length}s=n.SEGMENT();n.init(null);return s},strip:function(s){var t,q,r;q=new i(s);t=q.headers;q.purge();n.init(s);r=t.length;while(r--){n.SEGMENT(t[r].start,t[r].length,"")}s=n.SEGMENT();n.init(null);return s},get:function(r){var t=[];for(var s=0,q=p.length;s<q;s++){if(p[s].name===r.toUpperCase()){t.push(p[s].segment)}}return t},set:function(r,u){var v=[],s,t,q;if(typeof(u)==="string"){v.push(u)}else{v=u}for(s=t=0,q=p.length;s<q;s++){if(p[s].name===r.toUpperCase()){p[s].segment=v[t];p[s].length=v[t].length;t++}if(t>=v.length){break}}},purge:function(){p=[];n.init(null);n=null}}}});h("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(k,j){return function i(){var p,m,l,n={},s;p=new j();m={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};s={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function o(t,B){var v=p.SHORT(t),y,E,F,A,z,u,w,C,D=[],x={};for(y=0;y<v;y++){w=u=t+12*y+2;F=B[p.SHORT(w)];if(F===g){continue}A=p.SHORT(w+=2);z=p.LONG(w+=2);w+=4;D=[];switch(A){case 1:case 7:if(z>4){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.BYTE(w+E)}break;case 2:if(z>4){w=p.LONG(w)+n.tiffHeader}x[F]=p.STRING(w,z-1);continue;case 3:if(z>2){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.SHORT(w+E*2)}break;case 4:if(z>1){w=p.LONG(w)+n.tiffHeader}for(E=0;E<z;E++){D[E]=p.LONG(w+E*4)}break;case 5:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.LONG(w+E*4)/p.LONG(w+E*4+4)}break;case 9:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.SLONG(w+E*4)}break;case 10:w=p.LONG(w)+n.tiffHeader;for(E=0;E<z;E++){D[E]=p.SLONG(w+E*4)/p.SLONG(w+E*4+4)}break;default:continue}C=(z==1?D[0]:D);if(s.hasOwnProperty(F)&&typeof C!="object"){x[F]=s[F][C]}else{x[F]=C}}return x}function r(){var t=n.tiffHeader;p.II(p.SHORT(t)==18761);if(p.SHORT(t+=2)!==42){return false}n.IFD0=n.tiffHeader+p.LONG(t+=2);l=o(n.IFD0,m.tiff);if("ExifIFDPointer" in l){n.exifIFD=n.tiffHeader+l.ExifIFDPointer;delete l.ExifIFDPointer}if("GPSInfoIFDPointer" in l){n.gpsIFD=n.tiffHeader+l.GPSInfoIFDPointer;delete l.GPSInfoIFDPointer}return true}function q(A,C,z){var x,v,u,t=0;if(typeof(C)==="string"){var B=m[A.toLowerCase()];for(var w in B){if(B[w]===C){C=w;break}}}x=n[A.toLowerCase()+"IFD"];v=p.SHORT(x);for(var y=0;y<v;y++){u=x+12*y+2;if(p.SHORT(u)==C){t=u+8;break}}if(!t){return false}p.LONG(t,z);return true}return{init:function(t){n={tiffHeader:10};if(t===g||!t.length){return false}p.init(t);if(p.SHORT(0)===65505&&p.STRING(4,5).toUpperCase()==="EXIF\0"){return r()}return false},TIFF:function(){return l},EXIF:function(){var u;u=o(n.exifIFD,m.exif);if(u.ExifVersion&&k.typeOf(u.ExifVersion)==="array"){for(var v=0,t="";v<u.ExifVersion.length;v++){t+=String.fromCharCode(u.ExifVersion[v])}u.ExifVersion=t}return u},GPS:function(){var t;t=o(n.gpsIFD,m.gps);if(t.GPSVersionID&&k.typeOf(t.GPSVersionID)==="array"){t.GPSVersionID=t.GPSVersionID.join(".")}return t},setExif:function(t,u){if(t!=="PixelXDimension"&&t!=="PixelYDimension"){return false}return q("exif",t,u)},getBinary:function(){return p.SEGMENT()},purge:function(){p.init(null);p=l=null;n={}}}}});h("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(n,i,k,m,j){function l(w){var p,r,t,s,v,o;function u(){var x=0,y,z;while(x<=p.length){y=r.SHORT(x+=2);if(y>=65472&&y<=65475){x+=5;return{height:r.SHORT(x),width:r.SHORT(x+=2)}}z=r.SHORT(x+=2);x+=z-2}return null}p=w;r=new m();r.init(p);if(r.SHORT(0)!==65496){throw new i.ImageError(i.ImageError.WRONG_FORMAT)}t=new k(w);s=new j();o=!!s.init(t.get("app1")[0]);v=u.call(this);n.extend(this,{type:"image/jpeg",size:p.length,width:v&&v.width||0,height:v&&v.height||0,setExif:function(x,y){if(!o){return false}if(n.typeOf(x)==="object"){n.each(x,function(A,z){s.setExif(z,A)})}else{s.setExif(x,y)}t.set("app1",s.getBinary())},writeHeaders:function(){if(!arguments.length){return(p=t.restore(p))}return t.restore(arguments[0])},stripHeaders:function(x){return t.strip(x)},purge:function(){q.call(this)}});if(o){this.meta={tiff:s.TIFF(),exif:s.EXIF(),gps:s.GPS()}}function q(){if(!s||!t||!r){return}s.purge();t.purge();r.init(null);p=v=t=s=r=null}}return l});h("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(i,l,k){function j(u){var n,p,r,q,t;n=u;p=new k();p.init(n);(function(){var v=0,x=0,w=[35152,20039,3338,6666];for(x=0;x<w.length;x++,v+=2){if(w[x]!=p.SHORT(v)){throw new i.ImageError(i.ImageError.WRONG_FORMAT)}}}());function s(){var w,v;w=m.call(this,8);if(w.type=="IHDR"){v=w.start;return{width:p.LONG(v),height:p.LONG(v+=4)}}return null}function o(){if(!p){return}p.init(null);n=t=r=q=p=null}t=s.call(this);l.extend(this,{type:"image/png",size:n.length,width:t.width,height:t.height,purge:function(){o.call(this)}});o.call(this);function m(v){var y,x,z,w;y=p.LONG(v);x=p.STRING(v+=4,4);z=v+=4;w=p.LONG(v+y);return{length:y,type:x,start:z,CRC:w}}}return j});h("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(l,i,k,j){return function(n){var o=[k,j],m;m=(function(){for(var q=0;q<o.length;q++){try{return new o[q](n)}catch(p){}}throw new i.ImageError(i.ImageError.WRONG_FORMAT)}());l.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(p){return p},stripHeaders:function(p){return p},purge:function(){}});l.extend(this,m);this.purge=function(){m.purge();m=null}}});h("moxie/runtime/html5/image/MegaPixel",[],function(){function i(I,m,n){var p=I.naturalWidth,v=I.naturalHeight;var C=n.width,z=n.height;var r=n.x||0,q=n.y||0;var D=m.getContext("2d");if(j(I)){p/=2;v/=2}var G=1024;var l=document.createElement("canvas");l.width=l.height=G;var o=l.getContext("2d");var E=k(I,p,v);var w=0;while(w<v){var H=w+G>v?v-w:G;var A=0;while(A<p){var B=A+G>p?p-A:G;o.clearRect(0,0,G,G);o.drawImage(I,-A,-w);var t=(A*C/p+r)<<0;var u=Math.ceil(B*C/p);var s=(w*z/v/E+q)<<0;var F=Math.ceil(H*z/v/E);D.drawImage(l,0,0,B,H,t,s,u,F);A+=G}w+=G}l=o=null}function j(n){var m=n.naturalWidth,p=n.naturalHeight;if(m*p>1024*1024){var o=document.createElement("canvas");o.width=o.height=1;var l=o.getContext("2d");l.drawImage(n,-m+1,0);return l.getImageData(0,0,1,1).data[3]===0}else{return false}}function k(p,m,u){var l=document.createElement("canvas");l.width=1;l.height=u;var v=l.getContext("2d");v.drawImage(p,0,0);var o=v.getImageData(0,0,1,u).data;var s=0;var q=u;var t=u;while(t>s){var n=o[(t-1)*4+3];if(n===0){q=t}else{s=t}t=(q+s)>>1}l=null;var r=(t/u);return(r===0)?1:r}return{isSubsampled:j,renderTo:i}});h("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(o,i,p,l,j,r,q,k,m){function n(){var C=this,B,G,A,w,E,I=false,t=true;i.extend(this,{loadFromBlob:function(L){var K=this,M=K.getRuntime(),J=arguments.length>1?arguments[1]:true;if(!M.can("access_binary")){throw new p.RuntimeError(p.RuntimeError.NOT_SUPPORTED_ERR)}E=L;if(L.isDetached()){w=L.getSource();z.call(this,w);return}else{F.call(this,L.getSource(),function(N){if(J){w=H(N)}z.call(K,N)})}},loadFromImage:function(J,K){this.meta=J.meta;E=new j(null,{name:J.name,size:J.size,type:J.type});z.call(this,K?(w=J.getAsBinaryString()):J.getAsDataURL())},getInfo:function(){var J=this.getRuntime(),K;if(!G&&w&&J.can("access_image_binary")){G=new r(w)}K={width:x().width||0,height:x().height||0,type:E.type||k.getFileMime(E.name),size:w&&w.length||E.size||0,name:E.name||"",meta:G&&G.meta||this.meta||{}};return K},downsize:function(){s.apply(this,arguments)},getAsCanvas:function(){if(A){A.id=this.uid+"_canvas"}return A},getAsBlob:function(J,K){if(J!==this.type){s.call(this,this.width,this.height,false)}return new j(null,{type:J,data:C.getAsBinaryString.call(this,J,K)})},getAsDataURL:function(K){var L=arguments[1]||90;if(!I){return B.src}if("image/jpeg"!==K){return A.toDataURL("image/png")}else{try{return A.toDataURL("image/jpeg",L/100)}catch(J){return A.toDataURL("image/jpeg")}}},getAsBinaryString:function(K,M){if(!I){if(!w){w=H(C.getAsDataURL(K,M))}return w}if("image/jpeg"!==K){w=H(C.getAsDataURL(K,M))}else{var L;if(!M){M=90}try{L=A.toDataURL("image/jpeg",M/100)}catch(J){L=A.toDataURL("image/jpeg")}w=H(L);if(G){w=G.stripHeaders(w);if(t){if(G.meta&&G.meta.exif){G.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}w=G.writeHeaders(w)}G.purge();G=null}}I=false;return w},destroy:function(){C=null;u.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function x(){if(!A&&!B){throw new p.ImageError(p.DOMException.INVALID_STATE_ERR)}return A||B}function H(J){return l.atob(J.substring(J.indexOf("base64,")+7))}function D(K,J){return"data:"+(J||"")+";base64,"+l.btoa(K)}function z(K){var J=this;B=new Image();B.onerror=function(){u.call(this);J.trigger("error",new p.ImageError(p.ImageError.WRONG_FORMAT))};B.onload=function(){J.trigger("load")};B.src=/^data:[^;]*;base64,/.test(K)?K:D(K,E.type)}function F(L,M){var K=this,J;if(window.FileReader){J=new FileReader();J.onload=function(){M(this.result)};J.onerror=function(){K.trigger("error",new p.FileException(p.FileException.NOT_READABLE_ERR))};J.readAsDataURL(L)}else{return M(L.getAsDataURL())}}function s(K,W,O,U){var X=this,Y,M,L,S,R,N,Q,P,J;t=U;J=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(i.inArray(J,[5,6,7,8])!==-1){var V=K;K=W;W=V}N=x();L=!O?Math.min:Math.max;M=L(K/N.width,W/N.height);if(M>1&&(!O||U)){this.trigger("Resize");return}Q=Math.round(N.width*M);P=Math.round(N.height*M);if(!A){A=document.createElement("canvas")}Y=A.getContext("2d");if(O){A.width=K;A.height=W}else{A.width=Q;A.height=P}S=Q>A.width?Math.round((Q-A.width)/2):0;R=P>A.height?Math.round((P-A.height)/2):0;if(!t){y(A.width,A.height,J)}v.call(this,N,A,-S,-R,Q,P);this.width=A.width;this.height=A.height;I=true;X.trigger("Resize")}function v(M,N,J,P,L,O){if(m.OS==="iOS"){q.renderTo(M,N,{width:L,height:O,x:J,y:P})}else{var K=N.getContext("2d");K.drawImage(M,J,P,L,O)}}function y(M,J,L){switch(L){case 5:case 6:case 7:case 8:A.width=J;A.height=M;break;default:A.width=M;A.height=J}var K=A.getContext("2d");switch(L){case 2:K.translate(M,0);K.scale(-1,1);break;case 3:K.translate(M,J);K.rotate(Math.PI);break;case 4:K.translate(0,J);K.scale(1,-1);break;case 5:K.rotate(0.5*Math.PI);K.scale(1,-1);break;case 6:K.rotate(0.5*Math.PI);K.translate(0,-J);break;case 7:K.rotate(0.5*Math.PI);K.translate(M,-J);K.scale(-1,1);break;case 8:K.rotate(-0.5*Math.PI);K.translate(-M,0);break}}function u(){if(G){G.purge();G=null}w=B=A=E=null;I=false}}return(o.Image=n)});h("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(j,m,k,p,i){var n="flash",o={};function l(){var r;try{r=navigator.plugins["Shockwave Flash"];r=r.description}catch(t){try{r=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(s){r="0.0"}}r=r.match(/\d+/g);return parseFloat(r[0]+"."+r[1])}function q(s){var r=this,t;s=j.extend({swf_url:m.swf_url},s);i.call(this,s,n,{access_binary:function(u){return u&&r.mode==="browser"},access_image_binary:function(u){return u&&r.mode==="browser"},display_media:i.capTrue,do_cors:i.capTrue,drag_and_drop:false,report_upload_progress:function(){return r.mode==="client"},resize_image:i.capTrue,return_response_headers:false,return_response_type:function(u){return !j.arrayDiff(u,["","text","json","document"])||r.mode==="browser"},return_status_code:function(u){return r.mode==="browser"||!j.arrayDiff(u,[200,404])},select_file:i.capTrue,select_multiple:i.capTrue,send_binary_string:function(u){return u&&r.mode==="browser"},send_browser_cookies:function(u){return u&&r.mode==="browser"},send_custom_headers:function(u){return u&&r.mode==="browser"},send_multipart:i.capTrue,slice_blob:i.capTrue,stream_upload:function(u){return u&&r.mode==="browser"},summon_file_dialog:false,upload_filesize:function(u){return j.parseSizeStr(u)<=2097152||r.mode==="client"},use_http_method:function(u){return !j.arrayDiff(u,["GET","POST"])}},{access_binary:function(u){return u?"browser":"client"},access_image_binary:function(u){return u?"browser":"client"},report_upload_progress:function(u){return u?"browser":"client"},return_response_type:function(u){return j.arrayDiff(u,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(u){return j.arrayDiff(u,[200,404])?"browser":["client","browser"]},send_binary_string:function(u){return u?"browser":"client"},send_browser_cookies:function(u){return u?"browser":"client"},send_custom_headers:function(u){return u?"browser":"client"},stream_upload:function(u){return u?"client":"browser"},upload_filesize:function(u){return j.parseSizeStr(u)>=2097152?"client":"browser"}},"client");if(l()<10){this.mode=false}j.extend(this,{getShim:function(){return k.get(this.uid)},shimExec:function(v,w){var u=[].slice.call(arguments,2);return r.getShim().exec(this.uid,v,w,u)},init:function(){var v,w,u;u=this.getShimContainer();j.extend(u.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});v='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+s.swf_url+'" ';if(m.browser==="IE"){v+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}v+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+s.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+m.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(m.browser==="IE"){w=document.createElement("div");u.appendChild(w);w.outerHTML=v;w=u=null}else{u.innerHTML=v}t=setTimeout(function(){if(r&&!r.initialized){r.trigger("Error",new p.RuntimeError(p.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(u){return function(){u.call(r);clearTimeout(t);s=t=u=r=null}}(this.destroy))},o)}i.addConstructor(n,q);return o});h("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(j,k){var i={slice:function(n,p,l,o){var m=this.getRuntime();if(p<0){p=Math.max(n.size+p,0)}else{if(p>0){p=Math.min(p,n.size)}}if(l<0){l=Math.max(n.size+l,0)}else{if(l>0){l=Math.min(l,n.size)}}n=m.shimExec.call(this,"Blob","slice",p,l,o||"");if(n){n=new k(m.uid,n)}return n}};return(j.Blob=i)});h("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(i){var j={init:function(k){this.getRuntime().shimExec.call(this,"FileInput","init",{name:k.name,accept:k.accept,multiple:k.multiple});this.trigger("ready")}};return(i.FileInput=j)});h("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(l,i){var j="";function k(n,o){switch(o){case"readAsText":return i.atob(n,"utf8");case"readAsBinaryString":return i.atob(n);case"readAsDataURL":return n}return null}var m={read:function(q,o){var p=this,n=p.getRuntime();if(q==="readAsDataURL"){j="data:"+(o.type||"")+";base64,"}p.bind("Progress",function(s,r){if(r){j+=k(r,q)}});return n.shimExec.call(this,"FileReader","readAsBase64",o.uid)},getResult:function(){return j},destroy:function(){j=null}};return(l.FileReader=m)});h("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(k,i){function j(m,n){switch(n){case"readAsText":return i.atob(m,"utf8");case"readAsBinaryString":return i.atob(m);case"readAsDataURL":return m}return null}var l={read:function(p,o){var m,n=this.getRuntime();m=n.shimExec.call(this,"FileReaderSync","readAsBase64",o.uid);if(!m){return null}if(p==="readAsDataURL"){m="data:"+(o.type||"")+";base64,"+m}return j(m,p,o.type)}};return(k.FileReaderSync=l)});h("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(o,i,k,n,m,q,l,j){var p={send:function(y,t){var v=this,z=v.getRuntime();function s(){y.transport=z.mode;z.shimExec.call(v,"XMLHttpRequest","send",y,t)}function u(B,A){z.shimExec.call(v,"XMLHttpRequest","appendBlob",B,A.uid);t=null;s()}function w(B,A){var C=new l();C.bind("TransportingComplete",function(){A(this.result)});C.transport(B.getSource(),B.type,{ruid:z.uid})}if(!i.isEmptyObj(y.headers)){i.each(y.headers,function(A,B){z.shimExec.call(v,"XMLHttpRequest","setRequestHeader",B,A.toString())})}if(t instanceof q){var x;t.each(function(B,A){if(B instanceof k){x=A}else{z.shimExec.call(v,"XMLHttpRequest","append",A,B)}});if(!t.hasBlob()){t=null;s()}else{var r=t.getBlob();if(r.isDetached()){w(r,function(A){r.destroy();u(x,A)})}else{u(x,r)}}}else{if(t instanceof k){if(t.isDetached()){w(t,function(A){t.destroy();t=A.uid;s()})}else{t=t.uid;s()}}else{s()}}},getResponse:function(u){var r,t,s=this.getRuntime();t=s.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(t){t=new n(s.uid,t);if("blob"===u){return t}else{if(!!~i.inArray(u,["","text"])){r=new m();return r.readAsText(t)}else{if("arraybuffer"===u){}else{if("json"===u){r=new m();try{return j(r.readAsText(t))}catch(v){return null}}}}}}return null},abort:function(s){var r=this.getRuntime();r.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!s){}}};return(o.XMLHttpRequest=p)});h("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(i,k){var j={getAsBlob:function(n){var m=this.getRuntime(),l=m.shimExec.call(this,"Transporter","getAsBlob",n);if(l){return new k(m.uid,l)}return null}};return(i.Transporter=j)});h("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(j,l,k,n,m){var i={loadFromBlob:function(r){var q=this,p=q.getRuntime();function o(t){p.shimExec.call(q,"Image","loadFromBlob",t.uid);q=p=null}if(r.isDetached()){var s=new k();s.bind("TransportingComplete",function(){o(s.result.getSource())});s.transport(r.getSource(),r.type,{ruid:p.uid})}else{o(r.getSource())}},loadFromImage:function(p){var o=this.getRuntime();return o.shimExec.call(this,"Image","loadFromImage",p.uid)},getAsBlob:function(q,r){var p=this.getRuntime(),o=p.shimExec.call(this,"Image","getAsBlob",q,r);if(o){return new n(p.uid,o)}return null},getAsDataURL:function(){var q=this.getRuntime(),p=q.Image.getAsBlob.apply(this,arguments),o;if(!p){return null}o=new m();return o.readAsDataURL(p)}};return(j.Image=i)});h("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(j,m,l,p,i){var n="silverlight",o={};function q(z){var C=false,v=null,r,s,t,B,u,x=0;try{try{v=new ActiveXObject("AgControl.AgControl");if(v.IsVersionSupported(z)){C=true}v=null}catch(y){var w=navigator.plugins["Silverlight Plug-In"];if(w){r=w.description;if(r==="1.0.30226.2"){r="2.0.30226.2"}s=r.split(".");while(s.length>3){s.pop()}while(s.length<4){s.push(0)}t=z.split(".");while(t.length>4){t.pop()}do{B=parseInt(t[x],10);u=parseInt(s[x],10);x++}while(x<t.length&&B===u);if(B<=u&&!isNaN(B)){C=true}}}}catch(A){C=false}return C}function k(s){var r=this,t;s=j.extend({xap_url:m.xap_url},s);i.call(this,s,n,{access_binary:i.capTrue,access_image_binary:i.capTrue,display_media:i.capTrue,do_cors:i.capTrue,drag_and_drop:false,report_upload_progress:i.capTrue,resize_image:i.capTrue,return_response_headers:function(u){return u&&r.mode==="client"},return_response_type:i.capTrue,return_status_code:function(u){return r.mode==="client"||!j.arrayDiff(u,[200,404])},select_file:i.capTrue,select_multiple:i.capTrue,send_binary_string:i.capTrue,send_browser_cookies:function(u){return u&&r.mode==="browser"},send_custom_headers:function(u){return u&&r.mode==="client"},send_multipart:i.capTrue,slice_blob:i.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:i.capTrue,use_http_method:function(u){return r.mode==="client"||!j.arrayDiff(u,["GET","POST"])}},{return_response_headers:function(u){return u?"client":"browser"},return_status_code:function(u){return j.arrayDiff(u,[200,404])?"client":["client","browser"]},send_browser_cookies:function(u){return u?"browser":"client"},send_custom_headers:function(u){return u?"client":"browser"},use_http_method:function(u){return j.arrayDiff(u,["GET","POST"])?"client":["client","browser"]}});if(!q("2.0.31005.0")||m.browser==="Opera"){this.mode=false}j.extend(this,{getShim:function(){return l.get(this.uid).content.Moxie},shimExec:function(v,w){var u=[].slice.call(arguments,2);return r.getShim().exec(this.uid,v,w,u)},init:function(){var u;u=this.getShimContainer();u.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+s.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+m.global_event_dispatcher+'"/></object>';t=setTimeout(function(){if(r&&!r.initialized){r.trigger("Error",new p.RuntimeError(p.RuntimeError.NOT_INIT_ERR))}},m.OS!=="Windows"?10000:5000)},destroy:(function(u){return function(){u.call(r);clearTimeout(t);s=t=u=r=null}}(this.destroy))},o)}i.addConstructor(n,k);return o});h("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(i,j,k){return(i.Blob=j.extend({},k))});h("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(i){var j={init:function(l){function k(n){var o="";for(var m=0;m<n.length;m++){o+=(o!==""?"|":"")+n[m].title+" | *."+n[m].extensions.replace(/,/g,";*.")}return o}this.getRuntime().shimExec.call(this,"FileInput","init",k(l.accept),l.name,l.multiple);this.trigger("ready")}};return(i.FileInput=j)});h("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(k,j,i){var l={init:function(){var n=this,m=n.getRuntime(),o;o=m.getShimContainer();i.addEvent(o,"dragover",function(p){p.preventDefault();p.stopPropagation();p.dataTransfer.dropEffect="copy"},n.uid);i.addEvent(o,"dragenter",function(q){q.preventDefault();var p=j.get(m.uid).dragEnter(q);if(p){q.stopPropagation()}},n.uid);i.addEvent(o,"drop",function(q){q.preventDefault();var p=j.get(m.uid).dragDrop(q);if(p){q.stopPropagation()}},n.uid);return m.shimExec.call(this,"FileDrop","init")}};return(k.FileDrop=l)});h("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(i,k,j){return(i.FileReader=k.extend({},j))});h("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(i,j,k){return(i.FileReaderSync=j.extend({},k))});h("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(i,k,j){return(i.XMLHttpRequest=k.extend({},j))});h("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(i,k,j){return(i.Transporter=k.extend({},j))});h("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(j,k,i){return(j.Image=k.extend({},i))});h("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(o,i,l,k){var n="html4",m={};function j(q){var p=this,s=l.capTest,r=l.capTrue;l.call(this,q,n,{access_binary:s(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:s(m.Image&&(k.can("create_canvas")||k.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:s(function(){return(k.browser==="Chrome"&&k.version>=28)||(k.browser==="IE"&&k.version>=10)}()),resize_image:function(){return m.Image&&p.can("access_binary")&&k.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(t){return !!~o.inArray(t,["json","text","document",""])},return_status_code:function(t){return !o.arrayDiff(t,[200,404])},select_file:function(){return k.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return p.can("select_file")},summon_file_dialog:s(function(){return(k.browser==="Firefox"&&k.version>=4)||(k.browser==="Opera"&&k.version>=12)||(k.browser==="IE"&&k.version>=10)||!!~o.inArray(k.browser,["Chrome","Safari"])}()),upload_filesize:r,use_http_method:function(t){return !o.arrayDiff(t,["GET","POST"])}});o.extend(this,{init:function(){this.trigger("Init")},destroy:(function(t){return function(){t.call(p);t=p=null}}(this.destroy))});o.extend(this.getShim(),m)}l.addConstructor(n,j);return m});h("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(m,o,l,j,k,i){function n(){var s,q=[],t=[],p;function r(){var w=this,z=w.getRuntime(),y,x,u,B,v,A;A=o.guid("uid_");y=z.getShimContainer();if(s){u=l.get(s+"_form");if(u){o.extend(u.style,{top:"100%"})}}B=document.createElement("form");B.setAttribute("id",A+"_form");B.setAttribute("method","post");B.setAttribute("enctype","multipart/form-data");B.setAttribute("encoding","multipart/form-data");o.extend(B.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});v=document.createElement("input");v.setAttribute("id",A);v.setAttribute("type","file");v.setAttribute("name","Filedata");v.setAttribute("accept",t.join(","));o.extend(v.style,{fontSize:"999px",opacity:0});B.appendChild(v);y.appendChild(B);o.extend(v.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(i.browser==="IE"&&i.version<10){o.extend(v.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}v.onchange=function(){var C;if(!this.value){return}if(this.files){C=this.files[0]}else{C={name:this.value}}q=[C];this.onchange=function(){};r.call(w);w.bind("change",function(){var D=l.get(A),F=l.get(A+"_form"),E;if(w.files.length&&D&&F){E=w.files[0];D.setAttribute("id",E.uid);F.setAttribute("id",E.uid+"_form");F.setAttribute("target",E.uid+"_iframe")}D=F=null},998);v=B=null;w.trigger("change")};if(z.can("summon_file_dialog")){x=l.get(p.browse_button);j.removeEvent(x,"click",w.uid);j.addEvent(x,"click",function(C){if(v&&!v.disabled){v.click()}C.preventDefault()},w.uid)}s=A;y=u=x=null;w.trigger({type:"ready",async:true})}o.extend(this,{init:function(x){var u=this,w=u.getRuntime(),v;p=x;t=x.accept.mimes||k.extList2mimes(x.accept,w.can("filter_by_extension"));v=w.getShimContainer();(function(){var y,A,z;y=l.get(x.browse_button);if(w.can("summon_file_dialog")){if(l.getStyle(y,"position")==="static"){y.style.position="relative"}A=parseInt(l.getStyle(y,"z-index"),10)||1;y.style.zIndex=A;v.style.zIndex=A-1}z=w.can("summon_file_dialog")?y:v;j.addEvent(z,"mouseover",function(){u.trigger("mouseenter")},u.uid);j.addEvent(z,"mouseout",function(){u.trigger("mouseleave")},u.uid);j.addEvent(z,"mousedown",function(){u.trigger("mousedown")},u.uid);j.addEvent(l.get(x.container),"mouseup",function(){u.trigger("mouseup")},u.uid);y=null}());r.call(this);v=null},getFiles:function(){return q},disable:function(v){var u;if((u=l.get(s))){u.disabled=!!v}},destroy:function(){var v=this.getRuntime(),u=v.getShimContainer();j.removeAllEvents(u,this.uid);j.removeAllEvents(p&&l.get(p.container),this.uid);j.removeAllEvents(p&&l.get(p.browse_button),this.uid);if(u){u.innerHTML=""}s=q=t=p=null}})}return(m.FileInput=n)});h("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(i,j){return(i.FileReader=j)});h("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(n,j,m,i,o,q,l,r,k){function p(){var u,s,v;function t(w){var B=this,z,A,x,y,C=false;if(!v){return}z=v.id.replace(/_iframe$/,"");A=m.get(z+"_form");if(A){x=A.getElementsByTagName("input");y=x.length;while(y--){switch(x[y].getAttribute("type")){case"hidden":x[y].parentNode.removeChild(x[y]);break;case"file":C=true;break}}x=[];if(!C){A.parentNode.removeChild(A)}A=null}setTimeout(function(){q.removeEvent(v,"load",B.uid);if(v.parentNode){v.parentNode.removeChild(v)}var D=B.getRuntime().getShimContainer();if(!D.children.length){D.parentNode.removeChild(D)}D=v=null;w()},1)}j.extend(this,{send:function(E,y){var A=this,D=A.getRuntime(),z,x,C,w;u=s=null;function B(){var F=D.getShimContainer()||document.body,G=document.createElement("div");G.innerHTML='<iframe id="'+z+'_iframe" name="'+z+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';v=G.firstChild;F.appendChild(v);q.addEvent(v,"load",function(){var I;try{I=v.contentWindow.document||v.contentDocument||window.frames[v.id].document;if(/^4\d{2}\s/.test(I.title)&&I.getElementsByTagName("address").length){u=I.title.replace(/^(\d+).*$/,"$1")}else{u=200;s=j.trim(I.body.innerHTML);A.trigger({type:"progress",loaded:s.length,total:s.length});if(w){A.trigger({type:"uploadprogress",loaded:w.size||1025,total:w.size||1025})}}}catch(H){if(i.hasSameOrigin(E.url)){u=404}else{t.call(A,function(){A.trigger("error")});return}}t.call(A,function(){A.trigger("load")})},A.uid)}if(y instanceof r&&y.hasBlob()){w=y.getBlob();z=w.uid;C=m.get(z);x=m.get(z+"_form");if(!x){throw new o.DOMException(o.DOMException.NOT_FOUND_ERR)}}else{z=j.guid("uid_");x=document.createElement("form");x.setAttribute("id",z+"_form");x.setAttribute("method",E.method);x.setAttribute("enctype","multipart/form-data");x.setAttribute("encoding","multipart/form-data");x.setAttribute("target",z+"_iframe");D.getShimContainer().appendChild(x)}if(y instanceof r){y.each(function(H,F){if(H instanceof l){if(C){C.setAttribute("name",F)}}else{var G=document.createElement("input");j.extend(G,{type:"hidden",name:F,value:H});x.appendChild(G)}})}x.setAttribute("action",E.url);B();x.submit();A.trigger("loadstart")},getStatus:function(){return u},getResponse:function(w){if("json"===w){if(j.typeOf(s)==="string"){try{return k(s.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(x){return null}}}else{if("document"===w){}}return s},abort:function(){var w=this;if(v&&v.contentWindow){if(v.contentWindow.stop){v.contentWindow.stop()}else{if(v.contentWindow.document.execCommand){v.contentWindow.document.execCommand("Stop")}else{v.src="about:blank"}}}t.call(this,function(){w.dispatchEvent("abort")})}})}return(n.XMLHttpRequest=p)});h("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(j,i){return(j.Image=i)});a(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var c={},b=moxie.core.utils.Basic.inArray;(function a(e){var d,f;for(d in e){f=typeof(e[d]);if(f==="object"&&!~b(d,["Exceptions","Env","Mime"])){a(e[d])}else{if(f==="function"){c[d]=e[d]}}}})(window.moxie);c.Env=window.moxie.core.utils.Env;c.Mime=window.moxie.core.utils.Mime;c.Exceptions=window.moxie.core.Exceptions;window.mOxie=c;if(!window.o){window.o=c}return c})();(function(e,g,d){var c=e.setTimeout,f={};function a(i){var h=i.required_features,j={};function k(m,n,l){var o={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(o[m]){j[o[m]]=n}else{if(!l){j[m]=n}}}if(typeof(h)==="string"){b.each(h.split(/\s*,\s*/),function(l){k(l,true)})}else{if(typeof(h)==="object"){b.each(h,function(m,l){k(l,m)})}else{if(h===true){if(!i.multipart){j.send_binary_string=true}if(i.chunk_size>0){j.slice_blob=true}b.each(i,function(m,l){k(l,!!m,true)})}}}return j}var b={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:g.mimes,ua:g.ua,typeOf:g.typeOf,extend:g.extend,guid:g.guid,each:g.each,getPos:g.getPos,getSize:g.getSize,xmlEncode:function(i){var j={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},h=/[<>&\"\']/g;return i?(""+i).replace(h,function(k){return j[k]?"&"+j[k]+";":k}):i},toArray:g.toArray,inArray:g.inArray,addI18n:g.addI18n,translate:g.translate,isEmptyObj:g.isEmptyObj,hasClass:g.hasClass,addClass:g.addClass,removeClass:g.removeClass,getStyle:g.getStyle,addEvent:g.addEvent,removeEvent:g.removeEvent,removeAllEvents:g.removeAllEvents,cleanName:function(h){var j,k;k=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(j=0;j<k.length;j+=2){h=h.replace(k[j],k[j+1])}h=h.replace(/\s+/g,"_");h=h.replace(/[^a-z0-9_\-\.]+/gi,"");return h},buildUrl:function(i,h){var j="";b.each(h,function(l,k){j+=(j?"&":"")+encodeURIComponent(k)+"="+encodeURIComponent(l)});if(j){i+=(i.indexOf("?")>0?"&":"?")+j}return i},formatSize:function(h){if(h===d||/\D/.test(h)){return b.translate("N/A")}if(h>1099511627776){return Math.round(h/1099511627776,1)+" "+b.translate("tb")}if(h>1073741824){return Math.round(h/1073741824,1)+" "+b.translate("gb")}if(h>1048576){return Math.round(h/1048576,1)+" "+b.translate("mb")}if(h>1024){return Math.round(h/1024,1)+" "+b.translate("kb")}return h+" "+b.translate("b")},parseSize:g.parseSizeStr,predictRuntime:function(j,i){var h,k;if(i){j.runtimes=i}h=new b.Uploader(j);k=h.runtime;h.destroy();return k},addFileFilter:function(i,h){f[i]=h}};b.addFileFilter("mime_types",(function(){var i,j;function h(k){var l=[];b.each(k,function(m){b.each(m.extensions.split(/,/),function(n){if(/^\s*\*\s*$/.test(n)){l.push("\\.*")}else{l.push("\\."+n.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+l.join("|")+")$","i")}return function(m,l,k){if(!j||m!=i){j=h(m);i=[].slice.call(m)}if(!j.test(l.name)){this.trigger("Error",{code:b.FILE_EXTENSION_ERROR,message:b.translate("File extension error."),file:l});k(false)}else{k(true)}}}()));b.addFileFilter("max_file_size",function(k,i,h){var j;if(i.size!==j&&k&&i.size>k){this.trigger("Error",{code:b.FILE_SIZE_ERROR,message:b.translate("File size error."),file:i});h(false)}else{h(true)}});b.addFileFilter("prevent_duplicates",function(k,i,h){if(k){var j=this.files.length;while(j--){if(i.name===this.files[j].name&&i.size===this.files[j].size){this.trigger("Error",{code:b.FILE_DUPLICATE_ERROR,message:b.translate("Duplicate file error."),file:i});h(false);return}}}h(true)});b.Uploader=function(l){var i=[],v={},s={},k,q,n=false,o,p,u;function j(){var y,z=0,x;if(this.state==b.STARTED){for(x=0;x<i.length;x++){if(!y&&i[x].status==b.QUEUED){y=i[x];if(this.trigger("BeforeUpload",y)){y.status=b.UPLOADING;this.trigger("UploadFile",y)}}else{z++}}if(z==i.length){if(this.state!==b.STOPPED){this.state=b.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",i)}}}function t(x){x.percent=x.size>0?Math.ceil(x.loaded/x.size*100):100;m()}function m(){var y,x;q.reset();for(y=0;y<i.length;y++){x=i[y];if(x.size!==d){q.size+=x.origSize;q.loaded+=x.loaded*x.origSize/x.size}else{q.size=d}if(x.status==b.DONE){q.uploaded++}else{if(x.status==b.FAILED){q.failed++}else{q.queued++}}}if(q.size===d){q.percent=i.length>0?Math.ceil(q.uploaded/i.length*100):0}else{q.bytesPerSec=Math.ceil(q.loaded/((+new Date()-k||1)/1000));q.percent=q.size>0?Math.ceil(q.loaded/q.size*100):0}}function h(){var x=this,z=0;var y={accept:l.filters.mime_types,runtime_order:l.runtimes,required_caps:s,swf_url:l.flash_swf_url,xap_url:l.silverlight_xap_url};b.each(l.runtimes.split(/\s*,\s*/),function(A){if(l[A]){y[A]=l[A]}});g.inSeries([function(A){if(l.browse_button){o=new g.FileInput(b.extend({},y,{name:l.file_data_name,multiple:l.multi_selection,container:l.container,browse_button:l.browse_button}));o.onready=function(){var B=g.Runtime.getInfo(this.ruid);g.extend(x.features,{chunks:B.can("slice_blob"),multipart:B.can("send_multipart"),multi_selection:B.can("select_multiple")});z++;A()};o.onchange=function(){x.addFile(this.files)};o.bind("mouseenter mouseleave mousedown mouseup",function(C){if(!n){var B=g.get(l.browse_button);if(B){if(l.browse_button_hover){if("mouseenter"===C.type){g.addClass(B,l.browse_button_hover)}else{if("mouseleave"===C.type){g.removeClass(B,l.browse_button_hover)}}}if(l.browse_button_active){if("mousedown"===C.type){g.addClass(B,l.browse_button_active)}else{if("mouseup"===C.type){g.removeClass(B,l.browse_button_active)}}}B=null}}});o.bind("error runtimeerror",function(){o=null;A()});o.init()}else{A()}},function(A){if(l.drop_element){p=new g.FileDrop(b.extend({},y,{drop_zone:l.drop_element}));p.onready=function(){var B=g.Runtime.getInfo(this.ruid);x.features.dragdrop=B.can("drag_and_drop");z++;A()};p.ondrop=function(){x.addFile(this.files)};p.bind("error runtimeerror",function(){p=null;A()});p.init()}else{A()}}],function(){if(typeof(l.init)=="function"){l.init(x)}else{b.each(l.init,function(B,A){x.bind(A,B)})}if(z){x.trigger("PostInit")}else{x.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")})}})}function w(y,x){if(y.ruid){var z=g.Runtime.getInfo(y.ruid);if(z){return z.can(x)}}return false}function r(z,B,x){var y=new g.Image();try{y.onload=function(){y.downsize(B.width,B.height,B.crop,B.preserve_headers)};y.onresize=function(){x(this.getAsBlob(z.type,B.quality));this.destroy()};y.onerror=function(){x(z)};y.load(z)}catch(A){x(z)}}q=new b.QueueProgress();l=b.extend({runtimes:g.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},l);if(l.resize){l.resize=b.extend({preserve_headers:true,crop:false},l.resize)}if(b.typeOf(l.filters)==="array"){l.filters={mime_types:l.filters}}l.filters=b.extend({mime_types:[],prevent_duplicates:!!l.prevent_duplicates,max_file_size:l.max_file_size},l.filters);l.filters.max_file_size=b.parseSize(l.filters.max_file_size)||0;l.chunk_size=b.parseSize(l.chunk_size)||0;l.required_features=s=a(b.extend({},l));b.extend(this,{id:b.guid(),state:b.STOPPED,features:{},runtime:g.Runtime.thatCan(s,l.runtimes),files:i,settings:l,total:q,init:function(){var x=this;l.browse_button=g.get(l.browse_button);l.drop_element=g.get(l.drop_element);if(typeof(l.preinit)=="function"){l.preinit(x)}else{b.each(l.preinit,function(z,y){x.bind(y,z)})}if(!l.browse_button||!l.url){this.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")});return}x.bind("FilesAdded",function(z,y){[].push.apply(i,y);c(function(){x.trigger("QueueChanged");x.refresh()},1)});x.bind("CancelUpload",function(){if(u){u.abort()}});if(l.unique_names){x.bind("BeforeUpload",function(y,z){var B=z.name.match(/\.([^.]+)$/),A="part";if(B){A=B[1]}z.target_name=z.id+"."+A})}x.bind("UploadFile",function(G,D){var A=G.settings.url,B=G.features,E=l.chunk_size,H=l.max_retries,y,F=0;if(D.loaded){F=D.loaded=E*Math.floor(D.loaded/E)}function C(){if(H-->0){c(z,1)}else{D.loaded=F;G.trigger("Error",{code:b.HTTP_ERROR,message:b.translate("HTTP Error."),file:D,response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()})}}function z(){var K,J,I,L;if(D.status==b.DONE||D.status==b.FAILED||G.state==b.STOPPED){return}I={name:D.target_name||D.name};if(E&&B.chunks&&y.size>E){L=Math.min(E,y.size-F);K=y.slice(F,F+L)}else{L=y.size;K=y}if(E&&B.chunks){if(l.send_chunk_number){I.chunk=Math.ceil(F/E);I.chunks=Math.ceil(y.size/E)}else{I.offset=F;I.total=y.size}}else{I.chunk=0;I.chunks=1}u=new g.XMLHttpRequest();u.withCredentials=true;if(u.upload){u.upload.onprogress=function(M){D.loaded=Math.min(D.size,F+M.loaded);G.trigger("UploadProgress",D)}}u.onload=function(){if(u.status>=400){C();return}if(L<y.size){K.destroy();F+=L;D.loaded=Math.min(F,y.size);G.trigger("ChunkUploaded",D,{offset:D.loaded,total:y.size,response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()});if(g.Env.browser==="Android Browser"){G.trigger("UploadProgress",D)}}else{D.loaded=D.size}K=J=null;if(!F||F>=y.size){if(D.size!=D.origSize){y.destroy();y=null}G.trigger("UploadProgress",D);D.status=b.DONE;G.trigger("FileUploaded",D,{response:u.responseText,status:u.status,responseHeaders:u.getAllResponseHeaders()})}else{H=l.max_retries;c(z,1)}};u.onerror=function(){C()};u.onloadend=function(){this.destroy();u=null};if(G.settings.multipart&&B.multipart){I.name=D.target_name||D.name;u.open("post",A,true);b.each(G.settings.headers,function(N,M){u.setRequestHeader(M,N)});J=new g.FormData();b.each(b.extend(I,G.settings.multipart_params),function(N,M){J.append(M,N)});J.append(G.settings.file_data_name,K);u.send(J,{runtime_order:G.settings.runtimes,required_caps:s,swf_url:G.settings.flash_swf_url,xap_url:G.settings.silverlight_xap_url})}else{A=b.buildUrl(G.settings.url,b.extend(I,G.settings.multipart_params));u.open("post",A,true);u.setRequestHeader("Content-Type","application/octet-stream");b.each(G.settings.headers,function(N,M){u.setRequestHeader(M,N)});u.send(K,{runtime_order:G.settings.runtimes,required_caps:s,swf_url:G.settings.flash_swf_url,xap_url:G.settings.silverlight_xap_url})}}y=D.getSource();if(!g.isEmptyObj(G.settings.resize)&&w(y,"send_binary_string")&&!!~g.inArray(y.type,["image/jpeg","image/png"])){r.call(this,y,G.settings.resize,function(I){y=I;D.size=I.size;z()})}else{z()}});x.bind("UploadProgress",function(y,z){t(z)});x.bind("StateChanged",function(y){if(y.state==b.STARTED){k=(+new Date())}else{if(y.state==b.STOPPED){for(var z=y.files.length-1;z>=0;z--){if(y.files[z].status==b.UPLOADING){y.files[z].status=b.QUEUED;m()}}}}});x.bind("QueueChanged",m);x.bind("Error",function(y,z){if(z.file){z.file.status=b.FAILED;t(z.file);if(y.state==b.STARTED){c(function(){j.call(x)},1)}}});x.bind("FileUploaded",function(){m();c(function(){j.call(x)},1)});x.trigger("Init",{runtime:this.runtime});h.call(this)},refresh:function(){if(o){o.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=b.STARTED){this.state=b.STARTED;this.trigger("StateChanged");j.call(this)}},stop:function(){if(this.state!=b.STOPPED){this.state=b.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){n=arguments[0]!==d?arguments[0]:true;if(o){o.disable(n)}this.trigger("DisableBrowse",n)},getFile:function(y){var x;for(x=i.length-1;x>=0;x--){if(i[x].id===y){return i[x]}}},addFile:function(y,z){var E=this,B=[],x=[],D;function A(){var G=p||o;if(G){return G.getRuntime().uid}return false}function C(I,H){var G=[];g.each(E.settings.filters,function(K,J){if(f[J]){G.push(function(L){f[J].call(E,K,I,function(M){L(!M)})})}});g.inSeries(G,H)}function F(G){var H=g.typeOf(G);if(G instanceof g.File){if(!G.ruid&&!G.isDetached()){if(!D){return false}G.ruid=D;G.connectRuntime(D)}F(new b.File(G))}else{if(G instanceof g.Blob){F(G.getSource());G.destroy()}else{if(G instanceof b.File){if(z){G.name=z}B.push(function(I){C(G,function(J){if(!J){x.push(G)}I()})})}else{if(g.inArray(H,["file","blob"])!==-1){F(new g.File(null,G))}else{if(H==="node"&&g.typeOf(G.files)==="filelist"){g.each(G.files,F)}else{if(H==="array"){z=null;g.each(G,F)}}}}}}}D=A();F(y);if(B.length){g.inSeries(B,function(){if(x.length){E.trigger("FilesAdded",x)}})}},removeFile:function(y){var z=typeof(y)==="string"?y:y.id;for(var x=i.length-1;x>=0;x--){if(i[x].id===z){return this.splice(x,1)[0]}}},splice:function(z,x){var y=i.splice(z===d?0:z,x===d?i.length:x);this.trigger("FilesRemoved",y);this.trigger("QueueChanged");b.each(y,function(A){A.destroy()});return y},trigger:function(y){var A=v[y.toLowerCase()],z,x;if(A){x=Array.prototype.slice.call(arguments);x[0]=this;for(z=0;z<A.length;z++){if(A[z].func.apply(A[z].scope,x)===false){return false}}}return true},hasEventListener:function(x){return !!v[x.toLowerCase()]},bind:function(x,z,y){var A;x=x.toLowerCase();A=v[x]||[];A.push({func:z,scope:y||this});v[x]=A},unbind:function(x){x=x.toLowerCase();var A=v[x],y,z=arguments[1];if(A){if(z!==d){for(y=A.length-1;y>=0;y--){if(A[y].func===z){A.splice(y,1);break}}}else{A=[]}if(!A.length){delete v[x]}}},unbindAll:function(){var x=this;b.each(v,function(z,y){x.unbind(y)})},destroy:function(){this.stop();b.each(i,function(x){x.destroy()});i=[];if(o){o.destroy();o=null}if(p){p.destroy();p=null}s={};k=q=n=u=null;this.trigger("Destroy");this.unbindAll();v={}}})};b.File=(function(){var i={};function h(j){b.extend(this,{id:b.guid(),name:j.name||j.fileName,type:j.type||"",size:j.size||j.fileSize,origSize:j.size||j.fileSize,loaded:0,percent:0,status:b.QUEUED,lastModifiedDate:j.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var k=this.getSource().getSource();return g.inArray(g.typeOf(k),["blob","file"])!==-1?k:null},getSource:function(){if(!i[this.id]){return null}return i[this.id]},destroy:function(){var k=this.getSource();if(k){k.destroy();delete i[this.id]}}});i[this.id]=j}return h}());b.QueueProgress=function(){var h=this;h.size=0;h.loaded=0;h.uploaded=0;h.failed=0;h.queued=0;h.percent=0;h.bytesPerSec=0;h.reset=function(){h.size=h.loaded=h.uploaded=h.failed=h.queued=h.percent=h.bytesPerSec=0}};e.plupload=b}(window,mOxie));var BulkUpload,FileQueue,InlineUploadStatus,OverQuotaUploads,Upload,UploadFile,UploadPrep,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",current_dest:"",runtimes:(function(){var c,b,d,a;d={"MSIE 8.0":"flash","MSIE 9.0":"flash"};b="html5";for(c in d){a=d[c];if(navigator.userAgent.indexOf(c)!==-1){b=a}}return b})(),set_dest:function(a){DomUtil.fillVal(a,"dest-folder");return this.current_dest=a},init:function(c,d,e){var b,a;this.set_dest(c);a={};Object.extend(a,Upload.cookies);b=this.initPLU(a,e);if(!d){Util.smart_window_load(b)}else{b()}$j("#flash-upload-container > .moxie-shim").each(function(f){if(f.observe){Util.freshbutton_overlay(f,$("choose-button"));return Util.freshbutton_overlay(f,$("add-button"))}});return FileQueue.clear()},init_basic:function(){Util.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("basic-choose-button").observe("mousemove",function(c){var b,a,d;b=$("modal").cumulativeOffset();d=c.clientY-b.top-3;a=c.clientX-b.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:d+"px",left:a+"px"})});return $("file-box").observe("change",function(){var d,b,e,c,a;Modal.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();b=$("file-box").getValue().split("\\").pop();c=Sprite.make("web",Util.filename_to_icon(b));$("basic-upload-status").down(".icon").__date(c);d=_("Uploading %(filename)s").format({filename:b.em_snippet(25)});$("basic-upload-status").down(".file-desc").__date(d);$("basic-upload-status").show();$("basic-uploading-message").show();if(window.File&&window.FileList){e=$("file-box").files;if(e){a=e[0].lastModifiedDate;$("mtime").value=Math.round(Date.parse(a)/1000)||0}}return $("basic-upload-form").submit()})},initPLU:function(a,c){var b=this;return function(){var d;d=new plupload.Uploader({url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:b.runtimes,multipart_params:a,multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:"choose-button",container:"flash-upload-container",preinit:{PostInit:function(){if(c){c()}return b.uploaderLoaded()},Error:b.uploadError.bind(b)},init:{FilesAdded:b.fileQueued.bind(b),UploadProgress:b.uploadProgress.bind(b),FileUploaded:b.uploadSuccess.bind(b),BeforeUpload:b.prepareFileForUploading.bind(b),ChunkUploaded:b.chunkUploaded.bind(b),UploadComplete:FileQueue.finished.bind(FileQueue),Refresh:function(){if(b.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){$j("#flash-upload-container").clonePosition($j("#add-button"));$j("#flash-upload-container > .moxie-shim")[0].style.width="100%";return $j("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:Constants.static_url_moxie_swf});b.PLU=d;return b.PLU.init()}},reset:function(){if(FileQueue.uploading&&FileQueue.current_file){this.PLU.removeFile(FileQueue.current_file)}delete this.PLU;FileQueue.clear();return InlineUploadStatus.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return InlineUploadStatus.show()}},updatePostParams:function(c){var b,a;a=this.PLU.settings.multipart_params;for(b in c){if(c.hasOwnProperty(b)){a[b]=c[b]}}return this.PLU.settings.multipart_params=a},fileQueued:function(b,g){var e,d,a,c;for(d=0,a=g.length;d<a;d++){e=g[d];if((typeof e.getNative==="function"?(c=e.getNative())!=null?c.dest:void 0:void 0)===void 0){e.dest=Upload.current_dest}else{e.dest=e.getNative().dest}}document.fire(this.QUEUE_EVT,{files:g});return this.show_upload()},uploadNext:function(){var a,b;a=FileQueue.next();b={dest:FileQueue.next().dest,t:Constants.TOKEN};b[Constants.UID_PARAM_NAME]=Browse.active_user;Upload.updatePostParams(b);this.PLU.start();FileQueue.last_update_time=0;return FileQueue.last_update_size=0},pause:function(){return Upload.PLU.stop()},uploadProgress:function(b,a){if(!FileQueue.cancelled_files[a.id]){return document.fire(this.UPDATE_EVT,{file:a,percent_complete:a.loaded/a.size})}},generateUploadId:function(){var a,b,d,c;a="";for(b=c=0;c<=15;b=++c){a+=String.fromCharCode(Math.floor(Math.random()*256))}d=Util.encode_b64(a);d=d.replace(/\+/g,"-");d=d.replace(/\//g,"_");d=d.replace(/\=*$/,"");return d},chunkUploaded:function(b,c,d){var a;a=JSON.parse(d.response||"");return this.updatePostParams({offset:a.offset})},prepareFileForUploading:function(){var a;a=FileQueue.next();return this.updatePostParams({reported_total_size:a.size,dest:a.dest,t:Constants.TOKEN,upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(c,b,a){if(a.response==="{'error': 'quota'}"){return document.fire(this.ERROR_EVT,{file:b,message:_("Quota exceeded"),tooltip_text:_("Your upload failed because you are over quota.")})}else{if(a.response==="{'error': 'empty'}"){return document.fire(this.CANCEL_EVT,{file:b,message:_("Empty File")})}else{if(a.response==="{'error': 'ignored'}"){return document.fire(this.CANCEL_EVT,{file:b,message:_("File Ignored")})}else{return document.fire(this.COMPLETE_EVT,{file:b})}}}},uploadComplete:function(b,a){return document.fire(this.COMPLETE_EVT,{file:a})},uploadError:function(d,a){var b,c;if(c=a.file.id,__indexOf.call(FileQueue.file_ids(),c)<0){document.fire(this.QUEUE_EVT,{files:[a.file]})}window.errorObj=a;b=(function(){switch(a.code){case plupload.FILE_SIZE_ERROR:return _("File too large");default:return _("Upload Error")}})();this.show_upload();return document.fire(this.ERROR_EVT,{file:a.file,error_code:a.code,message:b})},grabURL:function(){var a;a=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(a)){$("url").value=a}return true},treeview_handler:function(b,a){var c;DomUtil.fillVal(b,"dest-folder");c=$("basic-uploader-url");if(c){c.href=c.href.replace(/(\/upload)(.*)(\?basic=1)/,function(g,e,h,d){return e+Util.urlquote(b)+d})}return FileQueue.clear()},new_folder:function(){TreeView.hide();Modal.show(_("Create new folder..."),DomUtil.fromElm("create-folder"),{action:this.do_new_folder.bind(this,Browse.active_user),wit_group:"new-folder-confirm"});if(!Util.ie){return $("first-treeview-link").onclick()}},do_new_folder:function(a){var d,c,b=this;if(!Modal.vars.selected_path){Notify.server_error(_("Please select a parent folder."));return}c=$F("entered-name");d=Modal.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+Util.urlquote(d)+"?to_path="+Util.urlquote(c),{subject_user:a,onSuccess:function(e){b.treeview_handler(Util.normalize(d)+"/"+c);return TreeView.schedule_reset()},cleanUp:function(){}})},uploaderLoaded:function(){var a=this;$("upload-loading").hide();$("choose-button").show();if(Upload.PLU.runtime==="flash"){$j("#flash-upload-container").clonePosition($j("#choose-button"));$j("#flash-upload-container > .moxie-shim")[0].style.top="0px";$j("#flash-upload-container > .moxie-shim")[0].style.left="0px";$j("#flash-upload-container > .moxie-shim")[0].style.width="100%";return $j("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{$j("#choose-button").click(function(b){return $j("#"+a.PLU.id+"_html5").click()});return $j("#add-button").click(function(b){return $j("#choose-button").click()})}}};FileQueue={init:function(){return FileQueue._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,FileQueue._file_queued.bind(this));document.observe(Upload.QUEUE_ERROR_EVT,FileQueue._file_queue_errored.bind(this));document.observe(Upload.UPDATE_EVT,FileQueue._file_updated.bind(this));document.observe(Upload.COMPLETE_EVT,FileQueue._file_completed.bind(this));document.observe(Upload.ERROR_EVT,FileQueue._file_errored.bind(this));return document.observe(Upload.CANCEL_EVT,FileQueue._file_cancelled.bind(this))},_file_queued:function(g){var c,f,b,d,a;d=g.memo.files;a=[];for(f=0,b=d.length;f<b;f++){c=d[f];this.files[c.id]=c;if(!FileQueue.uploading){this._start_uploading()}this.current_file=c;a.push(T("File queued:",c.name))}return a},_file_queue_errored:function(a){var b=this;this._file_queued(a);return setTimeout((function(){return b._file_errored(a)}),250)},_file_updated:function(j){var d,a,b,c,h,g,f,i,k;c=j.memo.file;g=j.memo.percent_complete;h=g*c.size;k=h+this.completed_size();b=new Date().getTime();if(this.last_update_time){f=(b-this.last_update_time)/1000;if(Upload.PLU.total.bytesPerSec){this.average_bps=Upload.PLU.total.bytesPerSec}else{a=h-this.last_update_size;d=a/f;this.average_bps=((k-a)*this.average_bps+a*d)/k}i=(this.queue_size()-k)/this.average_bps;this.formatted_time=Util.formatTime(i+this.num_left())}this.current_file=c;this.last_update_time=new Date().getTime();return this.last_update_size=h},_file_completed:function(b){var a;a=b.memo.file;this.completed_files[a.id]=true;T("File completed:",a.name);return this._check_if_finished(a)},_file_errored:function(b){var a;a=b.memo.file;this.errored_files[a.id]=true;BulkUpload.update_errors();InlineUploadStatus.update_errors();T("File errored:",a.name);return this._check_if_finished(a)},_file_cancelled:function(b){var a;a=b.memo.file;this.cancelled_files[a.id]=true;if(a.status===plupload.UPLOADING){Upload.PLU.stop();Upload.PLU.removeFile(a);Upload.PLU.start()}else{Upload.PLU.removeFile(a)}T("File cancelled:",a.name);return this._check_if_finished(a)},_start_uploading:function(){var a,b=this;Upload.uploadNext();this.uploading=true;this.all_cancelled=false;return window.onbeforeunload=a=function(){return _("Leaving this page will cancel your uploads.")}},finished:function(){return this._finished_uploading()},_check_if_finished:function(a){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return Upload.uploadNext()}},_finished_uploading:function(){var b,c,d,a;this.uploading=false;if(!this.num_files()){BulkUpload.cancelled()}else{if(this.errors()){BulkUpload.errored();InlineUploadStatus.errored()}else{BulkUpload.completed();InlineUploadStatus.completed()}}a=$("inline-upload-status").visible();Browse.select_fq_paths=[];if(Browse.inside_dir){for(d in this.completed_files){c=this.files[d];b=Util.normalize(c.dest);Browse.select_fq_paths.push(""+b+"/"+c.name)}Browse.force_reload()}else{if(Browse.in_search_mode()){FileSearch.force_reload()}}if(a){InlineUploadStatus.show()}Modal.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){var a=this;return $u(this.files).filter(function(b){return !(a.cancelled_files[b.id]||a.errored_files[b.id]||a.completed_files[b.id])})[0]},cancels:function(){return $u(this.cancelled_files).keys().length},errors:function(){return $u(this.errored_files).keys().length},queue_size:function(){var b,f,c,e,a,d;c=0;d=this.file_ids();for(e=0,a=d.length;e<a;e++){f=d[e];b=this.files[f];if(!this.errored_files[f]&&!this.cancelled_files[f]&&typeof b.size!=="undefined"){c+=b.size}}return c},completed_size:function(){var e,b,d,a,c;b=0;c=$u(this.completed_files).keys();for(d=0,a=c.length;d<a;d++){e=c[d];if(typeof this.files[e].size!=="undefined"){b+=this.files[e].size}}return b},file_ids:function(){var a=this;return $u(this.files).map(function(b,c){return c})},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){var a=this;return $u(this.file_ids()).filter(function(b){return !(a.cancelled_files[b]||a.errored_files[b]||a.completed_files[b])}).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof Modal!=="undefined"&&Modal!==null){return Modal.onHide=null}}};FileQueue.clear();UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){UploadFile._tmpl=HTML.tmpl("upload_list_item_tmpl");return UploadFile._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,UploadFile._file_queued);document.observe(Upload.QUEUE_ERROR_EVT,UploadFile._file_queue_errored);document.observe(Upload.UPDATE_EVT,UploadFile._file_updated);document.observe(Upload.COMPLETE_EVT,UploadFile._file_completed);document.observe(Upload.ERROR_EVT,UploadFile._file_errored);return document.observe(Upload.CANCEL_EVT,UploadFile._file_cancelled)},_file_queued:function(g){var c,f,b,d,a;d=g.memo.files;a=[];for(f=0,b=d.length;f<b;f++){c=d[f];a.push((function(k){var j,n,m,i,h,e,l;j=k.dest;h=Util.formatBytes(k.size||0,2,true);n=UploadFile._tmpl({file:k,icon:Util.filename_to_icon(k.name),filename_snippet:k.name.em_snippet(UploadFile.FILENAME_SNIPPET_LENGTH),size:h,dest:j,dest_snippet:(_("Dropbox")+j).em_snippet(UploadFile.DEST_SNIPPET_LENGTH,0)});$("upload-files-list").__sert(n);m=$(k.id);i=FileQueue.num_files();e=$("upload-files-list");if(i<=6){e.removeClassName("scroll")}else{e.addClassName("scroll")}e.scrollTop=e.scrollHeight;m.down(".dest").observe("click",function(){Browse.reload_fqpath(m.readAttribute("data-dest"),true);return Modal.hide()});l=m.down(".status-col").down("a.small-x-button");l.stopObserving("click");l.observe("click",function(o){return document.fire(Upload.CANCEL_EVT,{file:k})});return m.down(".upload-progress-bar").setStyle({width:"0"})})(c))}return a},_file_queue_errored:function(a){UploadFile._file_queued(a);return UploadFile._file_errored(a)},_file_updated:function(d){var c,f,b,a;c=d.memo.file;f=$(c.id);if(FileQueue.num_files()===1){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});f.down(".time-col").__date(a)}b=parseInt(c.percent,10)+"%";if(b==="100%"){f.down(".time-col").__date();f.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"}))}return f.down(".upload-progress-bar").setStyle({width:b})},_file_completed:function(b){var a,c;a=b.memo.file;a.completed=true;c=$(a.id);c.addClassName("complete");setTimeout(function(){return c.down(".status-col").__date(Sprite.make("web","s_check"))},0);return c.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(f){var a,c,b,g,d;b=f.memo.file;g=$(b.id);g.addClassName("error");g.down(".dest-col").hide();g.down(".time-col").__date();g.down(".status-col").__date(Sprite.make("web","nosync"));g.down(".upload-progress-bar").setStyle({width:"100%"});c=f.memo.message||_("Upload Error");a=void 0;if(f.memo.tooltip_text){a=f.memo.tooltip_text}else{a=_('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website');a=a.replace('id="basic_link"','onclick="FileOps.show_basic_upload(); return false;"')}g.down(".error-msg").__date(c);d=g.down(".error-details");d.observe("mouseover",function(){return Tooltip.show(d,a)});return g.down(".error-col").show()},_file_cancelled:function(b){var a,c;a=b.memo.file;c=$(a.id);c.addClassName("cancelled");c.down(".dest-col").__date(_(b.memo.message||"Canceled"));c.down(".time-col").__date();c.down(".status-col").__date(Sprite.make("web","cancelsync"));return c.down(".upload-progress-bar").setStyle({width:"100%"})}};BulkUpload={init:function(){this.elem=$("bulk-upload-status");return BulkUpload._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,BulkUpload._file_queued.bind(this));return document.observe(Upload.UPDATE_EVT,BulkUpload._file_updated.bind(this))},_file_queued:function(b){var a;a=new Element("a",{"class":"small-x-button"});a.observe("click",function(){var e,g,f,d,c;FileQueue.all_cancelled=true;e=FileQueue.file_ids().slice(0);c=[];for(f=0,d=e.length;f<d;f++){g=e[f];if(!FileQueue.completed_files[g]&&!FileQueue.errored_files[g]){c.push(document.fire(Upload.CANCEL_EVT,{file:FileQueue.files[g]}))}else{c.push(void 0)}}return c});return this.elem.down(".status").__date(a)},_file_updated:function(d){var c,b,a;if(FileQueue.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");c=ungettext("%d file","%d files",FileQueue.num_non_cancelled_files()).format(FileQueue.num_non_cancelled_files());this.elem.down(".num-files").__date(c);b=_("- %(size)s").format({size:Util.formatBytes(Upload.PLU.total.size,2,true)});this.elem.down(".size").__date(b);if(FileQueue.formatted_time){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});this.elem.down(".time-left").__date(a)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(FileQueue.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(Upload.PLU.runtime==="flash"){return $j("#flash-upload-container").clonePosition($j("#add-button"))}}},update_errors:function(){var a;a=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return $("bulk-upload-status").down(".num-errors").__date(a)},completed:function(){var b,a;$("hide-button").hide();$("done-button").show();if(FileQueue.num_files()>1){this.elem.addClassName("complete");b=ungettext("Uploaded %d file","Uploaded %d files",FileQueue.num_non_cancelled_files()).format(FileQueue.num_non_cancelled_files());this.elem.down(".num-files").__date(b);a=_("- %(size)s").format({size:Util.formatBytes(FileQueue.completed_size(),2,true)});this.elem.down(".size").__date(a);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Sprite.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var a;$("hide-button").hide();$("done-button").show();this.completed();a=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return this.elem.down(".num-errors").__date(a)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(FileQueue.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(_("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Sprite.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,InlineUploadStatus._file_queued.bind(this));return document.observe(Upload.UPDATE_EVT,InlineUploadStatus._file_updated.bind(this))},_file_queued:function(c){var b,a;b=$("inline-upload-status");b.removeClassName("error");b.removeClassName("complete");b.down(".icon").__date(Sprite.make("web","s_sync"));b.down(".file-desc").__date(_("Starting upload..."));b.down(".num-errors").__date();a=ungettext("%d file","%d files",FileQueue.num_left()).format(FileQueue.num_left());b.down(".view-details").__date(a);b.down(".status").__date();return b.down(".inline-upload-progress").style.width="0%"},_file_updated:function(h){var g,c,d,f,b,a;g=$("inline-upload-status");c=h.memo.file;g.down(".icon").__date(Sprite.make("web","s_sync"));d=_("Uploading %(filename)s").format({filename:c.name.em_snippet(this.FILENAME_SNIPPET_LENGTH)});g.down(".file-desc").__date(d);if(FileQueue.num_left()>1){a=ungettext("%d file left","%d files left",FileQueue.num_left()-1).format(FileQueue.num_left()-1);g.down(".view-details").__date(a)}else{g.down(".view-details").__date(_("View details"))}if(FileQueue.formatted_time){b=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});g.down(".status").__date(b)}f=c.percent+"%";return g.down(".inline-upload-progress").style.width=f},update_errors:function(){var a,b;a=$("inline-upload-status");b=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());return a.down(".num-errors").__date(b)},add_x_button:function(){var a,b;b=new Element("a",{"class":"small-x-button"});b.observe("click",function(){InlineUploadStatus.hide();return Upload.reset()});a=$("inline-upload-status");return a.down(".status").__date(b)},completed:function(){var b,a;b=$("inline-upload-status");b.addClassName("complete");b.removeClassName("error");b.down(".icon").__date(Sprite.make("web","s_check"));if(FileQueue.num_files()>1){a=_("Uploaded %(num_files)d files").format({num_files:FileQueue.num_non_cancelled_files()})}else{a=_("Uploaded %(filename)s").format({filename:FileQueue.current_file.name.em_snippet(this.FILENAME_SNIPPET_LENGTH)})}b.down(".file-desc").__date(a);b.down(".num-errors").__date();b.down(".view-details").__date(_("View details"));this.add_x_button();return b.down(".inline-upload-progress").style.width="100%"},errored:function(){var c,b,a,e,d;c=$("inline-upload-status");c.addClassName("error");c.removeClassName("complete");c.down(".icon").__date(Sprite.make("web","nosync"));b=void 0;if(FileQueue.num_files()>1){b=_("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:FileQueue.num_non_cancelled_files()-FileQueue.errors(),num_files:FileQueue.num_non_cancelled_files()});c.down(".file-desc").__date(b);e=ungettext("- %d error","- %d errors",FileQueue.errors()).format(FileQueue.errors());c.down(".num-errors").__date(e)}else{a=(d=FileQueue.current_file)!=null?d.name.em_snippet(this.FILENAME_SNIPPET_LENGTH):void 0;b=a?_("Unable to upload %(filename)s").format({filename:a}):_("Unable to upload file");c.down(".file-desc").__date(b);c.down(".num-errors").__date()}c.down(".view-details").__date(_("View details"));this.add_x_button();return c.down(".inline-upload-progress").style.width="100%"},show:function(a){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return UploadPrep.supported()&&Browse.inside_dir},browse_indicators_enabled:function(){var d,b,c,a;if(!UploadPrep.enabled()){return false}b=["file-preview-modal","modal-overlay"];for(c=0,a=b.length;c<a;c++){d=b[c];if($(d).visible()){return false}}return true},modal_indicators_enabled:function(){return UploadPrep.enabled()&&$("modal").down("#upload-modal-dropzone")},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(a){return $j(a).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(b){var a;if(!UploadPrep._drop_indicators){if(UploadPrep.modal_indicators_enabled()){a=$("upload-modal-dropzone");$j(a).clonePosition($j("#modal"),{setLeft:false,setTop:false});$j(a).fadeIn(500);UploadPrep._show_border_drop_indicators()}else{if(UploadPrep.browse_indicators_enabled()){BrowseDrag._add_drop_indicators(b)}else{return}}$("drag-status").removeClassName("active");return UploadPrep._drop_indicators=true}},hide_drop_indicators:function(){if(UploadPrep._drop_indicators){UploadPrep._hide_border_drop_indicators();BrowseDrag._remove_drop_indicators();if(!UploadPrep._notifications_cleared){Notify.clear_all()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){UploadPrep._drop_indicators=false;UploadPrep._drop_dest_folder=null;return UploadPrep._notifications_cleared=false}),500)}return UploadPrep._notifications_cleared=true},folder_dragover:function(a){var b;if(UploadPrep.browse_indicators_enabled()&&UploadPrep._drop_indicators){if(OverQuotaUploads.disabled){if(UploadPrep._drop_dest_folder==null){b=_("You can't upload files because you're out of space.");Notify.server_error(b,60);UploadPrep._notifications_cleared=false;UploadPrep._show_border_drop_indicators()}}else{if(a!==UploadPrep._drop_dest_folder){if(a===Browse.containing_fq_path()){if(Browse.inside_read_only_shared_folder){b=_("You don't have permission to add to this folder.");Notify.server_error(b,60)}else{b=_("Drop your file to ")+FileOps.upload_plain_snippet();Notify.server_success(b,60);UploadPrep._show_border_drop_indicators()}UploadPrep._notifications_cleared=false}else{Notify.clear_all();UploadPrep._hide_border_drop_indicators()}}}return UploadPrep._drop_dest_folder=a}},supports_recursive_upload:function(a){var b;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(a!=null?(b=a[0])!=null?b.webkitGetAsEntry:void 0:void 0)},upload:function(c,e,b){var d,g,f,a;if(b==null){b=null}if(Browse.inside_read_only_shared_folder){return}if(OverQuotaUploads.disabled){g=_("You can't upload files because you're out of space.");return Notify.server_error(g)}else{if(UploadPrep.supports_recursive_upload(b)){return UploadPrep._recursive_upload(c,b)}else{for(f=0,a=e.length;f<a;f++){d=e[f];d.dest=c}return UploadPrep._upload(e,b)}}},_recursive_upload:function(i,h){var j,b,c,g,e,k,a,d;d=(function(){var m,l,f;f=[];for(m=0,l=h.length;m<l;m++){e=h[m];f.push(e.webkitGetAsEntry())}return f})();a=[];c=0;k=0;j=3000;g=0;b=function(){var l,m,f;while(d.length){m=d.pop();if(m!==null){if(m.isDirectory){l=m.createReader();c+=1;l.readEntries(function(n){var q,p,o;for(p=0,o=n.length;p<o;p++){q=n[p];d.push(q)}return c-=1})}else{k+=1;f=function(n){return function(o){o.dest=i+Util.parentDir(n.fullPath);a.push(o);return k-=1}};m.file(f(m))}}}if(a.length>j&&!g){g=1;Notify.server_error(_("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:j}));return}if(c||k){return b.defer()}else{if(a.length){return UploadPrep._upload(a)}}};return b()},_upload:function(d,b){var a,c;if(b==null){b=null}if(b){a=this._parse_upload_items(b)}c=function(){var g,h,f,e;e=[];for(h=0,f=d.length;h<f;h++){g=d[h];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(a!=null?a[g.name].isDirectory:void 0)){g.is_directory=true}g.id=plupload.guid();e.push(Upload.PLU.addFile(g))}return e};if($("modal").visible()){return c()}else{FileOps.show_upload(c);return Modal.hide(null,true)}},_parse_upload_items:function(b){var c,d,e,a;c={};for(e=0,a=b.length;e<a;e++){d=b[e];if(d.getAsEntry){d=d.getAsEntry()}else{if(d.webkitGetAsEntry){d=d.webkitGetAsEntry()}}c[d.name]=d}return c}};OverQuotaUploads={disabled:false,init:function(a){this.disabled=a;if(this.disabled){return $j("body").addClass("uploads-disabled")}}};var FileOps;FileOps={NOTIFICATION_SNIPPET_LEN:40,_find_app_by_id:function(b){var e,d,a,c;c=Modal.vars.apps;for(d=0,a=c.length;d<a;d++){e=c[d];if(e.app_id!==b){continue}return e}return null},create_album_from_folder:function(b,a){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:b,album_name:a},job:true,job_user:viewer.photos_user,dont_hide_progress_on_complete:true,progress_text:_("Creating album..."),onSuccess:function(c){var d;d=JSON.parse(c.responseText);return window.location.href=d.url}})},dir_handler:function(d,c){var b,a;if(typeof c==="string"){c=$(c)}b=$$(".treeview .highlight")[0];if(b){b.removeClassName("highlight")}a=c.up("div");a.addClassName("highlight");Modal.selected_div=a;if(Modal.shown()){c.blur()}document.fire("db:dir_click",{path:d});return Modal.vars.selected_path=d},show_folder_pick:function(g,e,d,f,a){var b,c;DomUtil.fillVal(Util.filename(e).escapeHTML(),"folder-pick-file");TreeView.move("copy-move-treeview","folder-pick-treeview",{user:Browse.active_user});b=(a?_("Move"):_("Copy"));DomUtil.fillVal(b,"folder-pick-action-text");Modal.show(g,$("folder-pick"),{fq_path:e,action:d,folder:f});c=$("first-treeview-link");return c.onclick()},show_bulk_folder_pick:function(h,g,d,f){var b,a,e,c;c=BrowseUtil.profile_files(d);a=BrowseUtil.profile_summary(c);DomUtil.fillVal(a,"bulk-folder-pick-file");TreeView.move("copy-move-treeview","bulk-folder-pick-treeview",{user:Browse.active_user});if(g==="move"){b=_("Move")}else{if(g==="copy"){b=_("Copy")}else{b=_("Restore")}}DomUtil.fillVal(b,"bulk-folder-pick-action-text");Modal.show(h,$("bulk-folder-pick"),{files:d,action:f});e=$("first-treeview-link");return e.onclick()},show_copy:function(a,b){var c;c=(b?_("Copy folder to..."):_("Copy file to..."));TreeView.set_params({disable_read_only:true});return FileOps.show_folder_pick(c,a,FileOps.do_copy,b,false)},show_copy_bulk:function(a){var b;b=ungettext("Copy %(item_count)s item to...","Copy %(item_count)s items to...",a.length).format({item_count:a.length});TreeView.set_params({disable_read_only:true});return FileOps.show_bulk_folder_pick(b,"copy",a,FileOps.do_bulk_copy)},show_move_bulk:function(a){var b;b=ungettext("Move %(item_count)s item to...","Move %(item_count)s items to...",a.length).format({item_count:a.length});TreeView.set_params({disable_read_only:true});return FileOps.show_bulk_folder_pick(b,"move",a,FileOps.do_bulk_move)},show_move:function(a,b){var c;c=(b?_("Move folder to..."):_("Move file to..."));TreeView.set_params({disable_read_only:true});return FileOps.show_folder_pick(c,a,FileOps.do_move,b,true)},show_delete:function(a,c,d,b){var e,f;DomUtil.fillVal("<strong>"+Util.filename(c).escapeHTML()+"</strong>","delete_filename");e=void 0;if(b){e=function(){return FileOps.do_nonbrowse_delete(a,[c])}}else{e=function(){return FileOps.do_delete(a)}}f=(d?_("Delete folder?"):_("Delete file?"));return Modal.icon_show("delete_32",f,DomUtil.fromElm("delete-file"),{fq_path:c,action:e,folder:d,wit_group:"delete-confirm"})},show_bulk_delete:function(a,c){var d,b;d=ungettext("%(item_count)s item","%(item_count)s items",c.length).format({item_count:c.length});DomUtil.fillVal(d,"delete_filename");b=ungettext("Delete %(item_count)s item?","Delete %(item_count)s items?",c.length).format({item_count:c.length});return Modal.icon_show("delete_32",b,DomUtil.fromElm("delete-file"),{files:c,action:function(){return FileOps.do_bulk_delete(a)},wit_group:"delete-bulk-confirm"})},show_purge:function(a,b){var c;DomUtil.fillVal("<strong>"+Util.filename(a).escapeHTML()+"</strong>","purge-filename");c=(b?_("Permanently delete folder?"):_("Permanently delete file?"));return Modal.icon_show("alert_32",c,DomUtil.fromElm("purge-file"),{fq_path:a,action:FileOps.do_purge,folder:b,wit_group:"purge-file-confirm"})},show_bulk_purge:function(b){var c,a;c=ungettext("%(item_count)s item","%(item_count)s items",b.length).format({item_count:b.length});DomUtil.fillVal(c,"purge-filename");a=ungettext("Permanently delete %d item?","Permanently delete %d items?",b.length).format(b.length);return Modal.icon_show("alert_32",a,DomUtil.fromElm("purge-file"),{files:b,action:FileOps.do_bulk_purge,wit_group:"purge-bulk-confirm"})},show_bulk_restore:function(c,a){var d,b;d=ungettext("%(item_count)s item","%(item_count)s items",c.length).format({item_count:c.length});DomUtil.fillVal(d,"restore-filename");b=ungettext("Restore %d item...","Restore %d items...",c.length).format(c.length);return Modal.icon_show("alert_32",b,DomUtil.fromElm("restore-file"),{files:c,user:a,action:FileOps.do_bulk_restore,wit_group:"restore-bulk-confirm"})},wrap_strong:function(a){if(Browse.containing_fq_path()===""){return a.escapeHTML()}else{return"<strong>"+a.escapeHTML()+"</strong>"}},upload_snippet:function(c){var a,b;if(c==null){c=1000}if(viewer.is_paired&&Browse.active_user.is_team){b=viewer.team_name.em_snippet(c).escapeHTML()}if(Browse.containing_fq_path()===""){if(viewer.is_paired){if(Browse.active_user.is_team){return _(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...' "}).format({team_name:b})}else{return _(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...' "})}}else{return _(" upload to your Dropbox")}}else{a=Util.filename(Browse.containing_fq_path()).em_snippet(c).escapeHTML();if(viewer.is_paired){if(Browse.active_user.is_team){return _(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...' "}).format({folder:a,team_name:b})}else{return _(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...' "}).format({folder:a})}}else{return _(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...' "}).format({folder:a})}}},upload_short_snippet:function(b){var a;if(b==null){b=1000}a=Util.filename(Browse.containing_fq_path()).em_snippet(b).escapeHTML();return _("Upload to %(folder_name)s",{comment:"Upload a file to some folder on the website"}).format({folder_name:a})},upload_plain_snippet:function(a){if(a==null){a=1000}return this.upload_snippet(a).replace("<strong>","'").replace("</strong>","'")},show_upload:function(g){var b,c,f,e,a,d;b=Browse.containing_fq_path();if(OverQuotaUploads.disabled){DomUtil.fillVal(this.wrap_strong(Util.filename(b)),"disabled-upload-foldername");f=this.upload_short_snippet(20);Modal.icon_show("upload_32",f,$("disabled-upload-modal"),{},false);return}if((!FlashDetect.versionAtLeast(9))&&Upload.runtimes==="flash"){FileOps.show_basic_upload();$("enhanced-upload-toggle").hide();return}DomUtil.fillVal(this.upload_snippet(20),"upload-foldername");DomUtil.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&UploadPrep.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}f=this.upload_short_snippet(20);Modal.icon_show("upload_32",f,DomUtil.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,FileQueue.num_files());d=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(e=0,a=d.length;e<a;e++){c=d[e];c.observe("click",function(){FileOps.show_basic_upload();return false})}if(!FileQueue.num_files()){Upload.init(Util.normalize(b),true,g)}else{Upload.set_dest(Util.normalize(b))}return InlineUploadStatus.hide()},show_basic_upload:function(){DomUtil.fillVal(this.upload_snippet(20),"basic-upload-foldername");Modal.icon_show("upload_32",this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){FileOps.show_upload();return false});Upload.set_dest(Util.normalize(Browse.containing_fq_path()));return Upload.init_basic()},show_undelete:function(a){var b,c,d;DomUtil.fillVal(a.filename.escapeHTML(),"undelete_filename");b=Sprite.make("web",a.icon,{});b.addClassName("link-img");b.style.backgroundColor="transparent";c=FileOps.build_revisions_uri(a.fq_path,Browse.active_user,{undelete:1});$$(".undelete-icon").invoke("update",b);$$(".undelete-other-versions")[0].href=c;$$(".undelete-link")[0].href=c;d=_("Restore file?");return Modal.icon_show("alert_32",d,$("undelete-modal"),{file:a})},do_undelete:function(b){var a,c;a=Modal.vars.file;c=_("Restored '%(file_name)s'").format({file_name:a.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[a.fq_path]},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:function(d){Modal.hide();Notify.server_success(c);return document.fire(FileEvents.RESTORE,{files:[a]})}});return false},do_copy:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to copy a file we couldn't find.");return FileOps.do_bulk_copy([a],b)},do_bulk_copy:function(f,b){var d,e,c,g,a;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();f=f||Modal.vars.files;assert(f.length>0,"Tried to copy 0 files");if(typeof b==="undefined"){if(typeof Modal.vars.selected_path==="undefined"){Notify.server_error(_("You need to select a destination for the file."));return}else{b=Modal.vars.selected_path}}b=Util.normalize(b);c=0;for(g=0,a=f.length;g<a;g++){d=f[g];if(d.dir){if((b+"/").indexOf(d.fq_path+"/")===0){Notify.server_error(_("You cannot copy a folder into itself."));return}}}e=f.pluck("fq_path");Notify.clear_all();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:e,to_path:b},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Copying..."),onSuccess:function(o){var k,n,h,p,j,l,i,m;k=o.responseText.evalJSON().changesets;n=e.length;p=Util.filename(b).em_snippet(FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();j=ungettext("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",n);j=j.format({count:n,location:p});Notify.server_success(new HTML(j),null,null,k,FileOps.do_rollback);h=[];m=o.responseText.evalJSON().new_browse_files;for(l=0,i=m.length;l<i;l++){d=m[l];h.push(d.fq_path)}Browse.select_fq_paths=h;$("reload-link").observe("click",function(){return Browse.reload_fqpath(b)});TreeView.schedule_reset();return document.fire(FileEvents.COPY,{files:f,to_fq_path:b})}})},bulk_move_error:function(a,i){var g,d,j,e,k,f,b,c,h;j=Browse.find_file(i);e=BrowseUtil.profile_files(a);c=void 0;f=void 0;h=void 0;if(j){f=j.dir;c=j.fq_path;h=j.target_ns||j.ns_id}else{if(Browse.inside_dir&&Browse.can_get_details_from_fq_path(i)){d=Browse.details_from_fq_path(i);f=true;c=d.fq_path;h=d.ns_id}else{f=true;c=i;h=void 0}}k=a.pluck("fq_path").collect(Util.normalize);if(-1!==k.indexOf(Util.normalize(c))){return _("You cannot copy a folder into itself.")}g=b=function(l){var m;m=Util.parentDir(l.fq_path);return m===(c||"/")};if(a.all(g)){return ungettext("That file already exists in that folder.","Those files already exist in that folder.",a.length)}if(!f){return _("You cannot put files inside one another.")}if(e.target_namespaces>0&&h&&h!==Constants.root_ns){if(e.sandboxes>0){return _("You're not allowed to put an application folder inside a special folder.")}else{if(e.shared_folders>0){return _("You're not allowed to put a shared folder inside a special folder.")}else{return _("You're not allowed to nest special folders.")}}}if(Browse.public_folder_enabled){if(c==="/Public"&&e.target_namespaces>0){return _("You're not allowed to move shared folders to your Public folder.")}}if(e.public_folder>0){return _("You're not allowed to move your Public folder.")}if(e.deleted>0){return _("Moving deleted folders or files is not allowed.")}},do_move:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to move a file we couldn't find.");return FileOps.do_bulk_move([a],b)},do_bulk_move:function(e,f){var c,d,a,b;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();e=e||Modal.vars.files;if(!e){return}assert(e.length>0,"Tried to move 0 files");a=f||Modal.vars.selected_path||"";a=Util.normalize(a);c=FileOps.bulk_move_error(e,a);if(c){Notify.server_error(c);return}d=e.pluck("fq_path");Notify.clear_all();b="/cmd/move";return new Ajax.DBRequest(b,{parameters:{files:d,to_path:a},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Moving..."),onSuccess:function(j){var i,h,g,k;i=j.responseText.evalJSON().changesets;h=d.length;g=Util.filename(a).em_snippet(FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();k=ungettext("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",h);k=k.format({count:h,location:g});Notify.server_success(new HTML(k),null,null,i,FileOps.do_rollback);$("reload-link").observe("click",function(){return Browse.reload_fqpath(a)});TreeView.schedule_reset();return document.fire(FileEvents.MOVE,{files:e,to_fq_path:a})}})},do_rollback:function(a){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(a)},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(b){var c;c=_("Undo complete.");Notify.server_success(c);assert(Browse.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(Browse.in_search_mode()){FileSearch.select_fq_paths=Browse.pre_action_selection;FileSearch.force_reload()}else{if(Lightbox.shown){Browse.select_fq_paths=Browse.pre_action_selection}else{Browse.select_fq_paths=Browse.pre_action_selection;Browse.force_reload()}}return Browse.pre_action_selection=false}})},do_bulk_delete:function(a,d){var b,c;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();d=d||Modal.vars.files;assert(d.length>0,"Tried to delete 0 files");c=(function(){var g,f,e;e=[];for(g=0,f=d.length;g<f;g++){b=d[g];e.push(b.fq_path)}return e})();Notify.clear_all();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:c},subject_user:a,job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(e){var g,f;f=e.responseText.evalJSON();g=ungettext("Deleted %d item.","Deleted %d items.",c.length).format(c.length);Notify.server_success(g,null,null,f.changesets,FileOps.do_rollback);TreeView.schedule_reset();return document.fire(FileEvents.DELETE,{files:d})}})},do_delete:function(a,c){var b;b=Browse.find_file(c||Modal.vars.fq_path);assert(b,"Trying to delete a file we couldn't find.");return FileOps.do_bulk_delete(a,[b])},do_nonbrowse_delete:function(a,b){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:b},subject_user:a,html_in_error_msg:true,onSuccess:function(c){var d;d=ungettext("Deleted %(file_count)s item","Deleted %(file_count)s items",b.length);d=d.format({file_count:b.length});Notify.server_success(d);return document.fire(FileEvents.DELETE,{fq_paths:b})}})},do_purge:function(){var a;a=Browse.find_file(Modal.vars.fq_path);assert(a,"Trying to purge a file we couldn't find.");return FileOps.do_bulk_purge([a])},do_bulk_purge:function(b){var a,c;b=b||Modal.vars.files;assert(b.length>0,"Tried to purge 0 files");a=b.collect(function(d){return d.fq_path});c=ungettext("Permanently deleted %d item","Permanently deleted %d items",a.length).format(a.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:a},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(d){Notify.server_success(c);TreeView.schedule_reset();return document.fire(FileEvents.PURGE,{files:b})}})},do_bulk_restore:function(c){var b,d,a;c=c||Modal.vars.files;a=Modal.vars.user;assert(c.length>0,"Tried to restore 0 files");b=c.collect(function(e){return e.fq_path});d=ungettext("Restored %d item","Restored %d items",b.length).format(b.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:b},subject_user:Browse.active_user,job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:function(e){Notify.server_success(d);TreeView.schedule_reset();return document.fire(FileEvents.RESTORE,{files:c})}})},do_folder_restore:function(b,a){var c;c=function(d){var f,e;f=_("Restoring '%(folder_name)s'").format({folder_name:Util.filename(b)});e=d.responseText;if(e.startsWith("err:")){e=e.substring(4);$j("#async-result").html(e);Notify.server_error(new HTML(e),60)}else{f=_("Restored '%(folder_name)s'").format({folder_name:Util.filename(b)});$j("#status-of-files").text(_("Restored files"));Notify.server_success(f,60)}$j("#restore-done-heading").text(f);$j(".pre-restore").hide();return $j(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[b]},job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:c,onFailure:c,subject_user:a})},do_bulk_download:function(c){var e,b,d,a;e=new Element("form",{action:URI({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user.id).toString(),method:"post"});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{files:b.fq_path})}Forms.add_vars(e,{parent_path:Browse.block_hash_param||"/",w:Browse.block_hash});$(document.body).__sert(e);return e.submit()},do_bulk_photo_view:function(c){var e,b,d,a;e=new Element("form",{action:"https://"+Constants.WEBSERVER+"/photos",method:"post"});Forms.add_vars(e,{t:Constants.TOKEN});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{selected_items:b.root_coll_item_counter})}$(document.body).__sert(e);return e.submit()},build_revisions_uri:function(c,a,b){if(b==null){b={}}b[Constants.UID_PARAM_NAME]=String(a);return URI({path:"/revisions"+c}).updateQuery(b)}};var ContactsCache,ContactsList,DefaultContactsCache,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};ContactsList=(function(){function a(c){var b;this.contacts=c;this._lowercaseContact=__bind(this._lowercaseContact,this);this._excludeType=__bind(this._excludeType,this);this.sortByTeamFirst=__bind(this.sortByTeamFirst,this);this.excludeNonTeam=__bind(this.excludeNonTeam,this);this.excludeTeamMembers=__bind(this.excludeTeamMembers,this);this.excludeFacebook=__bind(this.excludeFacebook,this);this.excludeGroups=__bind(this.excludeGroups,this);this.excludeMe=__bind(this.excludeMe,this);this.excludeByEmail=__bind(this.excludeByEmail,this);this.includeForUser=__bind(this.includeForUser,this);this.slice=__bind(this.slice,this);this.length=__bind(this.length,this);this.filterContacts=__bind(this.filterContacts,this);this.lcontacts=(function(){var g,e,f,d;f=this.contacts;d=[];for(g=0,e=f.length;g<e;g++){b=f[g];d.push(this._lowercaseContact(b))}return d}).call(this)}a.prototype.filterContacts=function(b){var c;c=this.contacts.filter(b);return new a(c)};a.prototype.length=function(){return this.contacts.length};a.prototype.slice=function(c,b){return new a(this.contacts.slice(c,b))};a.prototype.includeForUser=function(b){return this.filterContacts(function(c){return c.owning_user_id===b})};a.prototype.excludeByEmail=function(e){var b,c,d=this;c=[(function(){var h,g,f;f=[];for(h=0,g=e.length;h<g;h++){b=e[h];f.push(b.toLowerCase())}return f})()];return this.filterContacts(function(f){var g;return !(g=f.email.toLowerCase(),__indexOf.call(e,g)>=0)})};a.prototype.excludeMe=function(){return this.filterContacts(function(b){return !b.is_owner})};a.prototype.excludeGroups=function(){return this._excludeType(ContactTypes.USER_GROUP)};a.prototype.excludeFacebook=function(){return this._excludeType(ContactTypes.FB)};a.prototype.excludeTeamMembers=function(){return this.filterContacts(function(b){return !b.team})};a.prototype.excludeNonTeam=function(){return this.filterContacts(function(b){return b.team})};a.prototype.sortByTeamFirst=function(){var b,d,g,f,c,e;g=[];d=[];e=this.contacts;for(f=0,c=e.length;f<c;f++){b=e[f];if(b.team||b.type===ContactTypes.USER_GROUP){g.push(b)}else{d.push(b)}}return new a(g.concat(d))};a.prototype._excludeType=function(b){return this.filterContacts(function(c){return c.type!==b})};a.prototype._lowercaseContact=function(b){var c,e,d;e={};for(c in b){d=b[c];if(typeof d==="string"||d instanceof String){d=d.toLowerCase()}e[c]=d}return e};return a})();ContactsCache=(function(){a.HAVENT_LOADED=0;a.LOADING_NONE_AVAILABLE=1;a.LOADING_STALE_AVAILABLE=2;a.LOADED=3;function a(){this._update_loading_state=__bind(this._update_loading_state,this);this._invoke_callbacks=__bind(this._invoke_callbacks,this);this._invoke_all_callbacks=__bind(this._invoke_all_callbacks,this);this.unregister_for_updates=__bind(this.unregister_for_updates,this);this.register_for_updates=__bind(this.register_for_updates,this);this.loading_state=a.HAVENT_LOADED;this.callbacks=[];this.one_time_callbacks=[]}a.prototype.load_contacts=function(d,c){var b,e=this;if((c!=null)&&__indexOf.call(this.one_time_callbacks,c)<0){this.one_time_callbacks.push(c)}if(!d){if(this.loading_state===a.LOADING_NONE_AVAILABLE){return}else{if(this.loading_state!==a.HAVENT_LOADED){this._invoke_all_callbacks();return}}}else{if(this.loading_state===a.LOADING_STALE_AVAILABLE){return}}if(this.loading_state===a.LOADED){this._update_loading_state(a.LOADING_STALE_AVAILABLE)}else{this._update_loading_state(a.LOADING_NONE_AVAILABLE)}b=function(g,f){e._update_loading_state(f);g=a._snippet_contact_list(g);e.cached_contacts=new ContactsList(g);return e._invoke_all_callbacks()};if(this.loading_state===a.LOADING_NONE_AVAILABLE){new Ajax.DBRequest("/get_cached_contacts",{onSuccess:function(f){var g;if(e.loading_state===a.LOADING_NONE_AVAILABLE){g=JSON.parse(f.responseText);if(g.length){return b(g,a.LOADING_STALE_AVAILABLE)}}},noAutonotify:true})}return new Ajax.DBRequest("/get_refreshed_contacts",{onSuccess:function(f){var g;g=JSON.parse(f.responseText);return b(g,a.LOADED)},noAutonotify:true})};a.prototype.register_for_updates=function(b){return this.callbacks.push(b)};a.prototype.unregister_for_updates=function(c){var b=this;return this.callbacks=this.callbacks.filter(function(d){return d!==c})};a.prototype._invoke_all_callbacks=function(){this._invoke_callbacks(this.one_time_callbacks,this.callbacks);this.one_time_callbacks=[];return this._invoke_callbacks(this.callbacks,this.one_time_callbacks)};a.prototype._invoke_callbacks=function(e,d){var g,f,c,b;b=[];for(f=0,c=e.length;f<c;f++){g=e[f];if(__indexOf.call(d,g)<0){b.push(g(this.cached_contacts))}else{b.push(void 0)}}return b};a.prototype._update_loading_state=function(b){assert(b===a.LOADING_NONE_AVAILABLE||b===a.LOADING_STALE_AVAILABLE||b===a.LOADED);return this.loading_state=b};a._snippet_contact_list=function(f){var d,b,e,c;d=22;for(e=0,c=f.length;e<c;e++){b=f[e];if(b.email!=null){b.email=b.email.em_snippet(d)}if(b.name!=null){b.name=b.name.em_snippet(d)}}return f};return a}).call(this);DefaultContactsCache=new ContactsCache();var ContactsImporter,ThirdParty,get_contacts_importer,_ContactsImporter,__bind=function(a,b){return function(){return a.apply(b,arguments)}};ThirdParty={GOOGLE:"-1",YAHOO:"-2",FACEBOOK:"-3",TWITTER:"-4",VARIOUS:"-5",NONE:"-6",services:function(){return[this.GOOGLE,this.YAHOO,this.FACEBOOK,this.TWITTER]},contact_services:function(){return[this.GOOGLE,this.YAHOO,this.FACEBOOK]},to_img:function(a){switch(a){case this.GOOGLE:return"/static/images/icons/gmail_logo28.png";case this.YAHOO:return"/static/images/icons/yahoo_mail_logo28.png";case this.FACEBOOK:return"/static/images/icons/facebook_logo28.png";default:return assert(false,"Should never get ThirdParty.to_img with provider: "+a)}},to_name:function(a){switch(a){case this.GOOGLE:return _("Gmail");case this.YAHOO:return _("Yahoo! Mail");case this.FACEBOOK:return _("Facebook");case this.VARIOUS:return _("Email");default:return assert(false,"Should never get ThirdParty.to_name with provider: "+a)}}};_ContactsImporter={};get_contacts_importer=function(c){var d,a,b;if((c!=null?c.user:void 0)!=null){b=c.user}else{if((c!=null?c.user_id:void 0)!=null){b=viewer.get_user_by_id(c.user_id,d=true)}else{assert(false,"must pass a user= or user_id= in options")}}if(_ContactsImporter[b.id]!=null){a=_ContactsImporter[b.id];if((c!=null?c.on_update_services:void 0)!=null){a.on_update_services=c.on_update_services}if((c!=null?c.hide_containing_modal:void 0)!=null){a.hide_containing_modal=c.hide_containing_modal}if((c!=null?c.show_containing_modal:void 0)!=null){a.show_containing_modal=c.show_containing_modal}}else{a=_ContactsImporter[b.id]=new ContactsImporter(b,c!=null?c.on_update_services:void 0,c!=null?c.hide_containing_modal:void 0,c!=null?c.show_containing_modal:void 0)}return a};ContactsImporter=(function(){a.update_connection_state_from_server=function(){var b=this;this.ever_updated=true;return new Ajax.DBRequest("/contacts/connected_services",{onSuccess:function(f){var h,e,d,g,c;g=JSON.parse(f.responseText);c=[];for(d in g){h=g[d];e=get_contacts_importer({user_id:d});e.connected_services=h;e.update_contacts_to_import_from_email_address();c.push(typeof e.on_update_services==="function"?e.on_update_services():void 0)}return c}})};function a(d,c,b,e){var f,g=this;this.user=d;this.on_update_services=c;this.hide_containing_modal=b;this.show_containing_modal=e;this.update_contacts_to_import_from_email_address=__bind(this.update_contacts_to_import_from_email_address,this);this._get_content_tab_selector=__bind(this._get_content_tab_selector,this);this._finish_auth_failure=__bind(this._finish_auth_failure,this);this._finish_auth_success=__bind(this._finish_auth_success,this);this.yahoo_auth_complete=__bind(this.yahoo_auth_complete,this);this.facebook_auth_complete=__bind(this.facebook_auth_complete,this);this.google_auth_complete=__bind(this.google_auth_complete,this);this.auth_complete=__bind(this.auth_complete,this);this.deauth_import=__bind(this.deauth_import,this);this.auth_import=__bind(this.auth_import,this);this.has_unconnected_services=__bind(this.has_unconnected_services,this);this.paired_account_has_facebook=__bind(this.paired_account_has_facebook,this);assert(this.user!=null,"invalid user");f=function(){var j,h,l,i,k;j={};k=ThirdParty.services();for(l=0,i=k.length;l<i;l++){h=k[l];j[""+h]=true}return j};this.contacts_to_import=ThirdParty.NONE;this.connected_services=f();this.suggestions_enabled=false;if(!a.ever_updated){a.update_connection_state_from_server()}if(viewer.is_user_signed_in(this.user)){new Ajax.DBRequest("/contacts/get_importer_suggestions_pref",{subject_user:this.user,onSuccess:function(h){return g.suggestions_enabled=JSON.parse(h.responseText)}})}return this}a.prototype.paired_account_has_facebook=function(){var g,d,c,f,b,e;e=viewer.get_users(g=true);for(f=0,b=e.length;f<b;f++){c=e[f];if(c===this.user){continue}d=get_contacts_importer({user:c});if(d.connected_services[ThirdParty.FACEBOOK]){return true}}return false};a.prototype.has_unconnected_services=function(){var b;return !$u.all((function(){var f,d,e,c;e=ThirdParty.contact_services();c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push(this.connected_services[b])}return c}).call(this))};a.prototype.auth_import=function(e,d){var c,b,f=this;if(d==null){d="none"}c=function(){var g;g=function(j,h){var i;i={};i[Constants.UID_PARAM_NAME]=f.user.id;return window.open(URI.parse(j).setQuery(i),h,"width=600,height=450")};switch(e){case ThirdParty.GOOGLE:g("/google/authentry","google_auth");break;case ThirdParty.YAHOO:g("/yahoo/authentry","yahoo_auth");break;case ThirdParty.FACEBOOK:g("/fb/access_token","fb_auth");break;default:assert(false,"Should never get here.  Input should be an ThirdParty.")}return typeof f.on_open_auth_popup==="function"?f.on_open_auth_popup():void 0};if(this.paired_account_has_facebook()&&e===ThirdParty.FACEBOOK){this.hide_containing_modal();b=new FacebookConfirmModal(this.user,this.show_containing_modal,c);return b.show()}else{return c()}};a.prototype.deauth_import=function(c,d){var b;b=this._get_content_tab_selector();switch(c){case ThirdParty.GOOGLE:return new Ajax.DBRequest("/google/remove_contacts",{subject_user:this.user.id,parameters:{source_id:d},onSuccess:function(e){$j(""+b+" #auth_gmail").show();$j(""+b+" #deauth_gmail").hide();return Notify.server_success(_("Successfully removed Gmail contacts"))},onFailure:function(){return Notify.server_error(_("We were unable to remove your Gmail contacts"))}});case ThirdParty.YAHOO:return new Ajax.DBRequest("/yahoo/remove_contacts",{subject_user:this.user.id,onSuccess:function(e){$j(""+b+" #auth_yahoo_mail").show();$j(""+b+" #deauth_yahoo_mail").hide();return Notify.server_success(_("Successfully removed Yahoo! Mail contacts."))},onFailure:function(){return Notify.server_error(_("We were unable to remove your Yahoo! Mail contacts."))}});default:return assert(false,"Should never get here.  Input should be an ThirdParty.")}};a.prototype.auth_complete=function(b,d,f,e){var c;if(e==null){e=null}c={google:this.google_auth_complete,yahoo:this.yahoo_auth_complete};return typeof c[b]==="function"?c[b](d,f,e):void 0};a.prototype.google_auth_complete=function(b,d,c){if(c==null){c=null}if(b){return this._finish_auth_success(ThirdParty.GOOGLE,_("Imported Gmail contacts."))}else{return this._finish_auth_failure(ThirdParty.GOOGLE,d||_("We need your permission to import your Gmail contacts."))}};a.prototype.facebook_auth_complete=function(b,c){if(b){FacebookOAuth.authed_user_id=this.user.id;if(FacebookOAuth.onLoginSuccessCallback!=null){FacebookOAuth.onLoginSuccessCallback();FacebookOAuth.onLoginSuccessCallback=null}return this._finish_auth_success(ThirdParty.FACEBOOK,_("Successfully connected to Facebook."))}else{return this._finish_auth_failure(ThirdParty.FACEBOOK,c||_("We need your permission to import your Facebook friends."))}};a.prototype.yahoo_auth_complete=function(b,d,c){if(b){return this._finish_auth_success(ThirdParty.YAHOO,_("Imported Yahoo! Mail contacts."))}else{return this._finish_auth_failure(ThirdParty.YAHOO,d||_("We need your permission to import your Yahoo! Mail contacts."))}};a.prototype._finish_auth_success=function(b,e){var d,c,f=this;switch(b){case ThirdParty.GOOGLE:c=this._get_content_tab_selector();$j(""+c+" #auth_gmail").hide();$j(""+c+" #deauth_gmail").show();break;case ThirdParty.FACEBOOK:if(DBHistory.get_url().startsWith("/account")){new Ajax.DBRequest("/fb/get_fb_profile",{subject_user:this.user.id,onSuccess:function(g){var h,i;c=f._get_content_tab_selector();h=JSON.parse(g.responseText);i=h.username?h.username:'"'+h.name+'"';$j(""+c+" #facebook_username").html(i);$j(".auth_facebook").show();$j(""+c+" .auth_facebook").hide();$j(".deauth_facebook").hide();return $j(""+c+" .deauth_facebook").show()}})}break;case ThirdParty.YAHOO:c=this._get_content_tab_selector();$j(""+c+" #auth_yahoo_mail").hide();$j(""+c+" #deauth_yahoo_mail").show()}if(b===this.contacts_to_import){this.contacts_to_import=ThirdParty.VARIOUS}this.connected_services[b]=true;a.update_connection_state_from_server();DefaultContactsCache.load_contacts(d=true);Notify.server_success(e);if(typeof this.on_update_services==="function"){this.on_update_services()}return typeof this.on_auth_success==="function"?this.on_auth_success(b):void 0};a.prototype._finish_auth_failure=function(b,c){Notify.server_error(c);return typeof this.on_auth_failure==="function"?this.on_auth_failure(b):void 0};a.prototype._get_content_tab_selector=function(){if(!viewer.is_paired||location.href.endsWith("settings")){return""}return"#"+this.user.role+"-content"};a.prototype.update_contacts_to_import_from_email_address=function(){var d,b,c;d=/@(.+?)\./g;b=d.exec(this.user.email);if(b&&b.length>1){if(b[1]==="gmail"&&!this.connected_services[ThirdParty.GOOGLE]){return this.contacts_to_import=ThirdParty.GOOGLE}else{if(((c=b[1])==="yahoo"||c==="ymail"||c==="rocketmail")&&!this.connected_services[ThirdParty.YAHOO]){return this.contacts_to_import=ThirdParty.YAHOO}else{return this.contacts_to_import=ThirdParty.VARIOUS}}}};return a})();var Forms,__hasProp={}.hasOwnProperty;Forms={submitOnlyOnce:function(){var a;a=Forms.submitted!==true;Forms.submitted=true;return a},disable:function(a){if(a){return setTimeout((function(){return a.disabled=true}),0)}},enable:function(a){if(a){return setTimeout((function(){return a.disabled=false}),0)}},show_button_on_change:function(c,b){var g,i,a,d,f,e,h=this;g=$j(c);g.hide();if(b==null){b=g.closest("form")}i=b[0];if((f=this.next_id)==null){this.next_id=0}a=this.next_id++;if((e=this.initial_vars)==null){this.initial_vars={}}this.initial_vars[a]=this.collect_form_vars(i);g.attr("data-id",a);b.data("button-id",a);d=function(){var l,k,j;g.hide();k=h.collect_form_vars(i);if(Object.keys(k).length!==Object.keys(h.initial_vars[a]).length){g.show()}j=[];for(l in k){if(k[l]!==h.initial_vars[a][l]){j.push(g.show())}else{j.push(void 0)}}return j};b.change(d);b.find("input").filter(":text").on("input",d);return b.find("textarea").on("input",d)},add_vars:function(c,d){var e,b,a;c=$(c);a=[];for(b in d){if(!__hasProp.call(d,b)){continue}e=new Element("input",{type:"hidden",name:b});e.setValue(d[b]);a.push(c.__sert(e))}return a},collect_form_vars:function(d){var g,c,b,f,e,a;d=d||$(document.body);c=d.select("input").concat(d.select("textarea")).concat(d.select("select"));b={};for(e=0,a=c.length;e<a;e++){g=c[e];if(g.name&&g.name!=="t"){f=g.getValue();if(f){if(typeof f!=="string"){f=f.join(",")}if(b[g.name]!=null){if(typeof b[g.name]==="string"){b[g.name]=[b[g.name],f]}else{b[g.name].push(f)}}else{b[g.name]=f}}}}return b},add_loading:function(c,a){var b;if(c){c=$(c);b=new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"});b.addClassName("text-img ajax_submit_loading");if(a==="after"){return $j(c).after(b)}else{return $j(c).before(b)}}},remove_loading:function(a){return $j(".ajax_submit_loading").remove()},ui_form_submit:function(b,a){var c=this;a=a||b.action;if(b.ajax_submitted){return false}b.ajax_submitted=true;return new UIRequest(b,a,{parameters:Forms.collect_form_vars(b),onSuccess:function(f){var e,d;d=$j(b).data("button-id");if(d!=null){e=$j(b).find("*[type='submit'][data-id='"+d+"']");c.initial_vars[d]=c.collect_form_vars(b);return e.hide()}},onComplete:function(d){return b.ajax_submitted=false}})},ajax_submit_obj:function(f){var j,l,c,d,b,e,h,i,g,k,a;d=f.form,a=f.url,k=f.success_callback,c=f.fail_callback,j=f.button,h=f.more_vars,i=f.position,e=f.job,b=f.html_response,l=f.complete_callback,g=f.progress_text;return Forms.ajax_submit(d,a,k,c,j,h,i,e,b,l,g)},ajax_submit:function(d,b,m,c,k,h,l,e,a,p,f){var n,g,i,o,j;if(a==null){a=false}if(d.ajax_submitted){return false}d.ajax_submitted=true;j=$j(d).find(".suggestion-input");for(i=0,o=j.length;i<o;i++){n=j[i];SuggestionInput.blank(n.identify())()}if(k){Forms.add_loading(k,l)}g=Forms.collect_form_vars(d);if(h){Object.extend(g,h)}new Ajax.DBRequest(b||d.action,{noAutonotify:true,parameters:g,job:e,progress_text:f,evalJSON:false,onSuccess:function(q){Forms.remove_loading();if(m&&typeof m==="function"){return m(q)}},onFailure:function(s){var q,r;if(s){if(s.responseText.indexOf("err:")===0){q=s.responseText.substr(4);if(q.indexOf("{")===0){r=q.evalJSON(true);Forms.fill_errors(d,r)}else{if(a){q=new HTML(q)}Notify.server_error(q)}}else{Notify.server_error()}Forms.remove_loading();if(c&&typeof c==="function"){return c(s)}}},onComplete:function(t){var s,r,q;q=d.select(".suggestion-input");for(s=0,r=q.length;s<r;s++){n=q[s];SuggestionInput.blur_elm(n)}d.ajax_submitted=false;if(p&&typeof p==="function"){return p(t)}}});return false},clear_errors:function(a){a=a||$(document.body);this.hide_errors(a);return a.select(".error-removable").invoke("remove")},fill_errors:function(f,e){var c,h,b,d,g,a;e=e||{};f=f||$(document.body);Forms.clear_errors(f);for(g in e){if(!__hasProp.call(e,g)){continue}h=f.down("[data-error-field-name='"+g+"']")||f.down("[name='"+g+"']");if(h){c=new Element("br",{"class":"error-removable"});b=new Element("span",{"class":"error-message error-removable"});d=e[g];assert(d.message_html||d.message_text,"Error message must have a message_html or message_text property");if(d.message_html){b.update(d.message_html)}else{b.__date(d.message_text)}$j(h).before(b);$j(h).before(c);a=$j(f).find("input[name='"+g+"'], textarea[name='"+g+"']");if(a){a.addClass("input-error")}}}return this.show_errors(f)},value:function(d){var c,b,f,e,a;b=$$('input[name="'+d+'"]');f=null;for(e=0,a=b.length;e<a;e++){c=b[e];f=$(c).getValue()||f}return f},postRequest:function(c,d,a){var b;if(d==null){d={}}if(a==null){a={}}assert(c!=null,"postRequest missing action");d.t=Constants.TOKEN;b=new Element("form",{action:c,method:"POST"});if(a.target){b.target=a.target}document.body.appendChild(b);Forms.add_vars(b,d);return b.submit()},hide_errors:function(c){var f,e,d,b,a;f=this.get_errors(c);a=[];for(d=0,b=f.length;d<b;d++){e=f[d];if(e.down("span.error-message")){a.push(e.hide())}else{a.push(void 0)}}return a},show_errors:function(b){var e,d,c,a;e=this.get_errors(b);for(c=0,a=e.length;c<a;c++){d=e[c];if(d.down("span.error-message")){d.show()}}return $j(".sick-input").find("label").css("top","")},get_errors:function(b){var c,a;a=".error-bubble, .error-plain-text";c=b?b.select(a):$$(a);return c}};Util.smartLoad(function(){return Forms.show_errors()});var ActAsBlock;ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(f,g){var d,b,c,a;if(g==null){g=document.body}c=$(g).getElementsByClassName("act_as_block");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];a.push(this.resize(f))}return a},resize:function(e){var a,c,d,b;e=$(e);c=e.up();a=Util.sumStyles(e,this.elm_list);d=Util.sumStyles(c,this.parent_list);e.style.width="1px";b=c.getWidth()-a-d;if(b>0){return e.style.width=b+"px"}}};var BrowseStyleRows;BrowseStyleRows={register_all:function(){var d,c,a,b;b=$$(".bs-row");for(c=0,a=b.length;c<a;c++){d=b[c];this.register(d)}Event.observe(document,"click",this.kill_current.bind(this));return $j(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(b){var a;b=$(b);b.db_observe("mouseover",this.mouseover.bind(this));b.db_observe("mouseout",this.mouseout.bind(this));a=b.down(".action-button");if(a){return a.db_observe("click",this.click.bind(this))}},mouseover:function(b,a){return a.addClassName("hover")},mouseout:function(b,a){return a.removeClassName("hover")},click:function(d,b){var a,f,c;if(d.target.tagName==="A"){return}f=b.up(".bs-row");Event.stop(d);if(f.hasClassName("selected")){this.kill_current(false);return}$j(document).trigger("dropdown-opened");this.kill_current(false);c=$(d.target);if(!c.match(".bs-actions-list *")){f.addClassName("selected")}a=(c.hasClassName("bs-row")?c:c.up(".bs-row"));return a.style.zIndex=9},kill_current:function(f){var g,d,b,c,a;c=$$(".bs-row.selected");a=[];for(d=0,b=c.length;d<b;d++){g=c[d];g.removeClassName("selected");a.push(g.style.zIndex="")}return a}};var Bubble;Bubble={make:function(q,D,v,o,j){var g,s,A,f,e,C,x,p,n,h,m,u,z,k,a,i,d,B,y,w;if(D==null){D="left"}j=j!=null?j:{};if(["left","right"].contains(D)){v=v||"middle";assert(["top","middle","bottom"].contains(v),"expected tail position ['top', 'middle', 'bottom'], got "+v)}else{if(["bottom","top"].contains(D)){v=v||"center";assert(["left","center","right"].contains(v),"expected tail position ['left', 'center', 'right'], got "+v)}else{if(!["none"].contains(D)){assert(false,"unexpected tail side, got "+D)}}}u=new Element("table");if(j.style==="titled"){u.addClassName("bluebubble");z="bluebubble"}else{u.addClassName("bubble");z="bubble"}if(o){u.style.width=o+"px"}a=new Element("tbody");B=new Element("tr");i=new Element("td");i.addClassName("tl");m=new Element("td");m.addClassName("t");if(j.style==="titled"){if(o){m.style.width=(o-42)+"px"}}d=new Element("td");d.addClassName("tr");if(D==="top"){k=new Element("img",{src:"/static/images/"+z+"_arrow_top.png"});k.addClassName("tarrow");if(j.style==="titled"){k.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(k);m.__sert(s)}else{m.style.textAlign=v;m.__sert(k)}}B.__sert(i);B.__sert(m);B.__sert(d);a.__sert(B);y=new Element("tr");p=new Element("td");p.addClassName("l");if(D==="left"){if(j.style==="titled"){g=new Element("img",{src:"/static/images/bluebubble_arrow_left.png"})}else{g=new Element("img",{src:"/static/images/bubble_arrow.png"})}g.addClassName("arrow");p.__sert(g);p.vAlign=v}x=new Element("td");x.addClassName("c");x.update(q);n=new Element("td");n.addClassName("r");if(D==="right"){h=new Element("img",{src:"/static/images/bubble_arrow_right.png"});h.addClassName("rarrow");n.__sert(h);n.vAlign=v}y.__sert(p);y.__sert(x);y.__sert(n);a.__sert(y);w=new Element("tr");e=new Element("td");e.addClassName("bl");A=new Element("td");A.addClassName("b");if(D==="bottom"){f=new Element("img",{src:"/static/images/"+z+"_arrow_bottom.png"});f.addClassName("barrow");if(j.style==="titled"){f.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(f);A.__sert(s)}else{A.style.textAlign=v;A.__sert(f)}}C=new Element("td");C.addClassName("br");w.__sert(e);w.__sert(A);w.__sert(C);a.__sert(w);u.__sert(a);return u}};var DbBubble;DbBubble={position:function(f,e,i){var j,b,a,h,c,g,d;f=$j(f).css({top:"auto",right:"auto",bottom:"auto",left:"auto",position:"absolute"});assert(f.find(".db-arrow").length,"db-arrow not found");j=f.find(".db-arrow-border");assert(j.length,"db-arrow-border not found");h=null;d=["top","right","bottom","left"];for(c=0,g=d.length;c<g;c++){a=d[c];if(f.hasClass("db-"+a+"-arrow")){h=a;break}}assert(h,"No db-#{direction}-arrow class set");if(h==="left"){b="left+"+(j.outerWidth())+"px top-"+(j.position().top)+"px"}else{if(h==="right"){b="right-"+(j.outerWidth())+"px top-"+(j.position().top)+"px"}else{if(h==="top"){b="left-"+(j.position().left)+"px top+"+(j.outerHeight())+"px"}else{if(h==="bottom"){b="left-"+(j.position().left)+"px bottom-"+(j.outerHeight())+"px"}}}}if(!i){i={top:"bottom",left:"right",bottom:"top",right:"left"}[h]}return f.position({my:b,at:i,of:e,collision:"none"})}};var FreshDropdown;FreshDropdown={show:function(c,e,f,h){var a,b,i,d,g=this;if(h==null){h=false}a=$j(e);if(!f){f=a[0].offsetHeight+10}this.hide_all();b=$j(c).show();d=b[0].offsetWidth;i=a[0].offsetWidth;b.clonePosition(a,{setHeight:false,setWidth:false,offsetLeft:-1*(d-i)+22,offsetTop:f});if(h){b.width(d)}e.addClassName("pressed");return(function(){return document.observe("click",g.hide_all)}).defer()},hide_all:function(a){$$(".freshdropdown-menu").invoke("hide");$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",this.hide_all)}};var JumpWatcher;JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&JumpWatcher.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=Util.url_hash()}},report:function(){clearInterval(JumpWatcher.interval);return assert(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash)}};var LocaleSelectorModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};LocaleSelectorModal=(function(b){__extends(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.on_show=function(){var c=this;return this.$modal_window.on("click",".locale-option",function(d){d.preventDefault();c.hide();return c.set_locale($j(d.target).attr("data-locale"))})};a.prototype.on_hide=function(){return this.$modal_window.off("click")};a.prototype.set_locale=function(c,e){var d;if(e==null){e=false}if(c===Constants.USER_LOCALE){return}d=$j("<form />",{action:"https://"+Constants.WEBSERVER+"/set_locale",method:"post"});Forms.add_vars(d[0],{locale:c,locale_cont:e||window.location.href,t:Constants.TOKEN});$j(document.body).append(d);return d.submit()};return a})(DBModal);var LoginDropdown;LoginDropdown={init:function(){var a;a=$j("#login-hover-link");if(!(a.length>0)){return}this.login_link=a;return this.register()},register:function(a){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(a){return this.clicking=true},click:function(a){a.preventDefault();if(this.clicking&&a.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}this.down=true;this.login_link.parent().addClass("down");return $j("#login_email_elm").focus()},unclick:function(b){var a;if(b){a=$j(b.target);if(a[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}this.down=false;return this.login_link.parent().removeClass("down")}};var Modal;Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(m,i,j,o,c,k,g,h,n){var b,e,l,a,d,f;if(j==null){j=false}if(o==null){o=false}if(c==null){c=false}if(k==null){k=false}if(g==null){g=""}if(h==null){h=true}if(n==null){n=false}c=c||this.width;e="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(e).invoke("hide");if(FileQueue.uploading&&!k){alertd(_("You can't do this while uploading."));return false}assert(i,"Missing modal content!");d=this.vars._prev_scope;this.vars=j||{};this.vars._prev_scope=d;$("modal").setStyle({width:""+c+"px",margin:"0 0 0 "+(Math.floor(-c/2).toString())+"px"});this.vars.extra_class="";if(g){$("modal").addClassName(g);this.vars.extra_class=g}if(!k){if(FileQueue.num_files()){Upload.reset()}a=Util.childElement($("modal-content"),0);if(a&&a!==i){$("grave-yard").__sert(a)}b=new Element("div");b.update(i);$("modal-content").__sert(b);if(i.show){i.show()}Element.show("modal")}$j("#modal-overlay").off("click");if(h){$j("#modal-overlay").on("click",function(p){Modal.hide(null,false,true);p.preventDefault();return p.stopPropagation()})}else{$j("#modal-overlay").on("click",function(p){p.preventDefault();return p.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(c+20)+"px",margin:"0 0 0 "+(Math.floor(-c/2-10).toString())+"px"});$j("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(o){$("modal-content").select("#"+o.id).first().focus()}else{if(!Util.ie){l=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(l){l.focus()}}}if(!this.track_id){this.track_resizes()}if(m){$("modal-title").update(m);$("modal-title").show();f=m.innerText||m.textContent||m;T("Modal.show:",f)}else{$("modal-title").hide();T("Modal.show")}ActAsBlock.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";Util.set_page_scrollable(false);if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=n;$j("#modal").find("input").filter(":visible:first").focus();return false},async_show:function(b,c){var a;a=new Element("img",{src:"/static/images/icons/ajax-loading.gif"});this.show("",a);return new Ajax.DBRequest(b,{parameters:c,onSuccess:this._async_load})},_async_load:function(a){var b;b=JSON.parse(a.responseText);$("modal-content").__date(new HTML(b.content));if(b.title){$("modal-title").update(new HTML(b.title));$("modal-title").show();return T("Modal.show:",b.title)}else{$("modal-title").hide();return T("Modal.show")}},fix_position:function(c){var b,a;a=document.viewport.getScrollOffsets().top+this.vertical_offset;b=parseInt($("modal").getStyle("height"),10);if(b+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(b+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:a+"px"});return $("modal-behind").setStyle({position:"absolute",height:(b+20)+"px",top:(a-10)+"px"})}},keydown:function(d){var f,a,c,b;c=d.keyCode||d.which||d.charCode;if(c===27||(c===8&&!Util.focus_in_input())){d.preventDefault();this.hide(null,false,true)}if(c===9&&!Util.focus_in_input()){a=$("modal").down("input[type=text], input[type=email]");b=$("modal").down(".modal-tabs");f=b;while(f&&f.next()){f=f.next();if(f.visible()){a=f.down("input[type=text], input[type=email]");break}}if(a){d.preventDefault();return a.focus()}}},icon_show:function(h,i,e,f,j,a,g,c,d){var b;if(c==null){c=""}if(d==null){d=true}b=new Element("div");if(h){b.__sert(Sprite.make("web",h,{"class":"modal-h-img"}))}b.__sert(i);return this.show(b,e,f,j,a,g,c,d)},show_loading:function(a,c){var b;b="<p style='margin: 3em 0; text-align: center;'>\n<img src='/static/images/icons/ajax-loading-small.gif' alt=''/></p>";return this.icon_show(a,c,b)},shown:function(){return $("modal").visible()},hide:function(c,a,b){if(c){Event.stop(c)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(b);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!a&&!FileQueue.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(FileQueue.uploading){InlineUploadStatus.show()}}Util.set_page_scrollable(true);if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return T("Modal.hide")},should_prevent_hide:function(){return this.prevent_hide_if_loading&&$u.some($j("#modal form"),function(a){return a.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var a;a=$("modal").getHeight();if(this.old_height!==a||$("modal-behind").getHeight()<a){this.old_height=a;return this.fix_position()}},vars:{}};var Notify;Notify={server_error:function(c,b,a){return this._show_div(c,b,a,"server-error",_("There was a problem completing this request."))},server_info:function(c,b,a){return this._show_div(c,b,a,"server-info")},server_success:function(e,d,b,a,c){return this._show_div(e,d,b,"server-success",_("Your request completed successfully."),a,c)},_show_div:function(b,e,g,d,k,a,j){var f,c,i,h=this;this.clear_all();b=b||k;e=e||(a?30:10);c=$j("#notify-msg");if(b.toHTML!=null){c.html(b.toHTML())}else{c.text(b)}if(a){UndoAction.set_undo_info(a,j);i=$j("<a/>",{href:"#"}).text(_("Undo"));i.click(function(){UndoAction.perform_undo();return false});c.append("&nbsp;").append(i);this.preserve_last_msg=true}else{this.preserve_last_msg=false}f=$j("#notify");f.removeClass("server-error server-info server-success").addClass(d);this.last_fade_effect=f.fadeIn(500);this.last_msg=b;this.last_fade_timeout=setTimeout((function(){return h.last_fade_effect=f.fadeOut(1000)}),e*1000);return this.cancel_on_reload=g},is_shown:function(){return $j("#notify").visible()},clear_all:function(){if(this.last_fade_timeout){clearTimeout(this.last_fade_timeout)}if(this.last_fade_effect){this.last_fade_effect.stop()}return $j("#notify").hide()},clear_if:function(a){if(this.last_msg===a){return this.clear_all()}}};var RolePicker,RolePickerState,RoleSelect,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};RolePicker=(function(){function a(c){var d,b;if(c==null){c={}}this._actually_set_state=__bind(this._actually_set_state,this);this._do_login=__bind(this._do_login,this);this.is_user_visible=__bind(this.is_user_visible,this);this.is_role_visible=__bind(this.is_role_visible,this);this.ensure_role_is_visible=__bind(this.ensure_role_is_visible,this);this.update_picker_ui=__bind(this.update_picker_ui,this);this.set_state=__bind(this.set_state,this);this.get_state=__bind(this.get_state,this);this._allow_merged_state=c.allow_merged_state!=null?c.allow_merged_state:true;if(viewer.is_role_signed_in(RolePickerState.PERSONAL)&&viewer.is_role_signed_in(RolePickerState.WORK)){this.set_state(RolePickerState.ALL)}else{d=viewer.get_users();assert(d.length,"tried to use RolePicker on a page with no users");b=d[0];this.set_state(b.role)}return this}a.prototype.get_state=function(){return this._state};a.prototype.set_state=function(c){var f,e,b,d;assert(this._allow_merged_state||(c!==RolePickerState.ALL),"tried to set merged state in non-merged picker");if(c===RolePickerState.ALL){d=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(e=0,b=d.length;e<b;e++){f=d[e];if(!viewer.is_role_signed_in(f)){this._do_login(f,c);return}}}else{f=c;if(!viewer.is_role_signed_in(f)){this._do_login(f,c);return}}return this._actually_set_state(c)};a.prototype.update_picker_ui=function(){};a.prototype.ensure_role_is_visible=function(b){if(!this.is_role_visible(b)){if(this._allow_merged_state){return this.set_state(RolePickerState.ALL)}else{return this.set_state(b)}}};a.prototype.is_role_visible=function(b){return this._state===RolePickerState.ALL||this._state===b};a.prototype.is_user_visible=function(b){return this.is_role_visible(b.role)};a.prototype._do_login=function(b,c){var d=this;return MultiaccountLogin.show_modal({role:b,on_success:function(){return d._actually_set_state(c)}})};a.prototype._actually_set_state=function(b){this._state=b;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(b):void 0};return a})();RoleSelect=(function(b){__extends(a,b);function a(d,c){if(c==null){c={}}this.update_picker_ui=__bind(this.update_picker_ui,this);this.on_ui_change=__bind(this.on_ui_change,this);this.$container=d;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(BubblePicker.CHANGED,this.on_ui_change);a.__super__.constructor.call(this,c);return this}a.prototype.on_ui_change=function(c,d){if(d!==this._state){this.$bubble_picker.controller().set_value(this._state);return this.set_state(d)}};a.prototype.update_picker_ui=function(){this.$bubble_picker.controller().set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};return a})(RolePicker);var SickInput;SickInput={init:function(){var e,d,b,c,a;c=$$(".sick-input");a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(!e.hasClassName("sickified")){a.push(this._create(e))}}return a},_create:function(d){var c,a,b;if(d==null){return}c=d.identify();a=d.down("input")||d.down("textarea")||d.down("select");a.observe("focus",function(){return d.addClassName("focused")});a.observe("blur",function(){return d.removeClassName("focused")});b=function(){if(d.hasClassName("populated")&&a.getValue()===""){d.removeClassName("populated")}else{if(!d.hasClassName("populated")&&a.getValue()!==""){d.addClassName("populated")}}if(c in SickInput._handler_map){return SickInput._handler_map[c]()}};Forms.show_errors();b();return setInterval(b,100)},_handler_map:{},add_interval_handler:function(b,a){var c;c=b.identify();return this._handler_map[c]=a},remove_interval_handler:function(b,a){var c;c=b.identify();if(this._handler_map[c]===a){return delete this._handler_map[c]}}};var Spinner;Spinner={showLoading:function(h,a,g,d){var b,e,f,c;g=true;e=$("spinner-loading");a=$(a);if(!e){e=new Element("div",{id:"spinner-loading"});b=new HTML('<table style="height: 100%; width: 100%; background:#fff;">\n  <tr>\n  <td valign="top">\n    <div id="spinner-loading-text" style="padding-top: 16px;text-align:center;"></div>\n  </td>\n  </tr>\n</table>');e.__date(b);document.body.appendChild(e)}$j(e).clonePosition($j(a));if(e.getWidth()===0){return}if(Util.ie){e.style.left=a.getBoundingClientRect().left+"px"}e.setOpacity(0.9);f=$("spinner-loading-text");if(h){f.__date()}else{c=new Element("img",{src:"/static/images/icons/ajax-loading.gif",style:"vertical-align: bottom;"});f.__date(c);if(!g){f.__sert(_("Loading..."))}}$("spinner-loading").show();if(d){return e.style.zIndex="1001"}},hideLoading:function(){return $("spinner-loading").hide()}};var Sprite;Sprite={SPACER:"/static/images/icons/icon_spacer.gif",CLASS_PREFIX:"s_",_make_class:function(b,a){return this.CLASS_PREFIX+b+"_"+a},src:function(c,b,a){this.clear(c);return $j(c).addClass(this._make_class(b,a))},replace:function(d,b,c,a){return $j(d).removeClass(this._make_class(b,c)).addClass(this._make_class(b,a))},clear:function(c){var a,b=this;a=c.className.split(" ");a=$j.grep(a,(function(d){return d.indexOf(b.CLASS_PREFIX)===0}),true);return c.className=a.join(" ")},make:function(c,b,a){a=this._prep_attrs(c,b,a);return new Element("img",a)},html:function(d,b,a){var e,c;a=this._prep_attrs(d,b,a);e=["<img "];for(c in a){e.push(c,'="',HTML._raw_escape(a[c]),'" ')}e.push("/>");return new HTML(e.join(""))},_prep_attrs:function(d,c,b){var a;if(b==null){b={}}b.src=b.src||this.SPACER;a=this._make_class(d,c);b["class"]=("sprite sprite_"+d+" "+a+" ")+(b["class"]||"");return b},_get:function(a){return a.className},_set:function(b,a){b.className=a;return b.src=this.SPACER}};var SuggestionInput;SuggestionInput={register:function(b){var a;b=$(b);a=b.up("form");if(SuggestionInput.defaulted(b)||b.getValue()===""){b.setValue(b.title)}else{b.addClassName("suggestion-input-unfaded")}b.observe("blur",this.blur.bind(this));b.observe("focus",this.focus.bind(this));b.observe("db:value_change",this.focus.bind(this));if(a){if(!b.id){b.id="r_elm_id_"+(Math.random().toString())}return a.observe("submit",SuggestionInput.blank(b.id).bind(this))}},register_all:function(){var c,e,b,d,a;d=$$(".suggestion-input");a=[];for(e=0,b=d.length;e<b;e++){c=d[e];a.push(this.register(c))}return a},blank:function(a){var b=this;return function(){var c;c=$(a);if(!c){return}if(b.defaulted(c)){return c.setValue("")}}},defaulted:function(a){a=$(a);return a.getValue()===a.title},do_blank:function(a){return this.blank(a)()},clear:function(a){var b;b={target:a};return this.focus(b)},focus:function(a){var b;b=$(a.target);if(!b){return}if(this.defaulted(b)){b.addClassName("suggestion-input-unfaded");return b.setValue("")}},blur_elm:function(a){if(a.getValue()===""){a.removeClassName("suggestion-input-unfaded");a.setValue(a.title)}return a.blur()},blur:function(a){var b;b=$(a.target);if(!b){return}return this.blur_elm(b)},reset:function(b){var a;a=$(b);if(!a){return}a.removeClassName("suggestion-input-unfaded");a.setValue(a.title);a.defaulted=true;return a.blur()},setValue:function(a,b){var c;c=$(a);if(!c){return}c.addClassName("suggestion-input-unfaded");c.setValue(b);return c.defaulted=false}};var TitleBubble;TitleBubble=(function(){var c,b,g,d,e,a,f;f=0;c=0;a=function(h){return f=h};e=function(l){var q,o,j,n,i,h,m,k,p;n=$j(l.currentTarget);p=n.attr("title");if(p!=null?p.length:void 0){n.attr("data-title",p);n.removeAttr("title")}j=parseInt(n.data("title-delay"));o="title-bubble-"+(c++);n.data("bubble-id",o);q=$j("<div/>",{id:o,"class":"title_bubble_container"});if(!j){q.css({opacity:0});q.addClass("has-transition")}if(n.hasClass("white")){q.addClass("white")}if(n.hasClass("black")){q.addClass("black")}q.text(n.attr("data-title"));k=$j("<div/>",{"class":"tail"});q.append(k);$j(document.body).append(q);h=g(n[0],q[0]);i=b(h,q[0],n[0]);q.clonePosition(n,{setWidth:false,setHeight:false,offsetTop:i.top-f,offsetLeft:i.left});q.addClass("position-"+h);k.css("margin-left",i.tail_offset_left+"px");k.css("margin-top",i.tail_offset_top+"px");m=function(){var r;if(!((q.data("pending-delay"))&&(n.data("bubble-id")===o))){return}r=(parseInt(n.data("title-fade-time")))||400;return q.fadeIn(r)};if(j){q.hide();q.data("pending-delay",true);return setTimeout(m,j)}else{return q.css({opacity:""})}};g=function(l,h){var k,j,i;l=$(l);i=l.getAttribute("data-title-position");k=document.viewport.getDimensions();j=l.viewportOffset();if(!(i==="above"||i==="below"||i==="right"||i==="left")){i="above"}if(i==="left"){if(j.left<h.width){return"right"}}else{if(i==="right"){if(k.width-(j.left+l.getWidth())<h.width){return"left"}}else{if(i==="below"){if(k.height-(j.top+l.getHeight())<h.height){return"above"}}else{if(i==="above"){if(j.top<h.height){return"below"}}}}}return i};b=function(j,q,m){var o,k,r,n,p,l,h,t,s,i;q=$(q);m=$(m);r=document.viewport.getDimensions();o=q.getDimensions();n=m.viewportOffset();k=6;p=0;l=0;s=0;i=0;if(j==="below"||j==="above"){if(j==="below"){l=m.getHeight()+k}else{l=(-1*o.height)-k}h=m.getWidth()/2-o.width/2;if(n.left+h+o.width>r.width){p=r.width-n.left-o.width;s=h-p-5}else{p=h;s=-5}}if(j==="left"||j==="right"){if(j==="right"){p=m.getWidth()+k}else{p=(-1*o.width)-k}t=m.getHeight()/2-o.height/2;if(n.top+t+o.height>r.height){l=r.height-n.top-o.height;i=t-l-5}else{l=t;i=-5}}return{left:p,top:l,tail_offset_left:s,tail_offset_top:i}};d=function(i){var h,j,k;k=$j(i!=null?i.currentTarget:void 0);h=$j("#"+k.data("bubble-id"));if(h.data("pending-delay")){h.removeData("pending-delay");j=(parseInt(k.data("title-fade-time")))||400;return h.fadeOut(j,function(){return h.remove()})}else{return h.remove()}};return{init:function(){$j(document).on("mouseenter",".title_bubble",e);$j(document).on("mouseleave",".title_bubble",d).on("mouseup",".title_bubble",d);$j(document).on("mouseenter",".title_bubble_sticky",e);return $j(document).on("mouseleave",".title_bubble_sticky",d)},set_vertical_space:a,hide_all:function(){return $j(".title_bubble_container").remove()}}})();var Tooltip;Tooltip={attach:function(g,c,a,b){var f,e;if(b==null){b={}}g=$(g);a=(a?$(a):null);f=Bubble.make(c,g.tail_position,b.tail_position,b.width,b);f.setStyle({display:"none",position:"absolute"});$("floaters").__sert(f);if(g.match("#modal-content *")||g.match(".db-modal-content *")){f.style.zIndex="13001"}else{f.style.zIndex=""}if(g.tail_position==="right"){e=(Util.ie?32:12);f.style.marginLeft=-(f.getWidth()+g.getWidth()+e)+"px"}g.tooltip=f;g.out_target=(a?true:false);g.observe("mouseout",this.mouseout("target",g));g.observe("mouseover",this.mouseover("target",g));g.out_trigger=(a?false:true);if(a){a.observe("mouseout",this.mouseout("trigger",g));a.observe("mouseover",this.mouseover("trigger",g))}g.out_tooltip=true;f.observe("mouseout",this.mouseout("tooltip",g));return f.observe("mouseover",this.mouseover("tooltip",g))},update:function(b,a){if(b.tooltip){return $(b.tooltip).update(a)}},mouseover:function(a,b){return function(){return b["out_"+a]=false}},mouseout:function(a,b){return function(){b["out_"+a]=true;return Tooltip.hide_if_out.defer(b)}},show_by:function(b){var c,a;c=$j(b.tooltip);b=$j(b);c.show();a=Math.floor(c[0].offsetHeight/2);return c.clonePosition(b,{setWidth:false,setHeight:false,offsetTop:Math.floor(b[0].offsetHeight/2)-a,offsetLeft:b[0].offsetWidth+1})},hide_if_out:function(a){var b;if(!a.out_target||!a.out_trigger||!a.out_tooltip){return}b=$(a.tooltip);return b.hide()},show:function(e,d,b,a,c){if(a==null){a="left"}e=$(e);if(!e.tail_position){e.tail_position=a}b=(b?$(b):null);if(!e.tooltip){this.attach(e,d,b,c)}return this.show_by(e)}};var TreeView;TreeView={tv:{},loaded:false,set_params:function(a){return this.ajax_params=a},init:function(c,a,d){var b;if(d==null){d="treeview"}this.tv[d]={};b=this.tv[d];b.autohide=(a===null?true:a);b.handler=c;b.viewdiv=$(d);b.hidefunc=this.hide.bindAsEventListener(this);return this.ajax_params={}},schedule_reset:function(){return this.loaded=false},reset:function(d){var b,c,a,e=this;b={url:"/ajax_subtreeview",method:"post",data:$j.extend({},this.ajax_params),success:function(g){var h,f;f=[];for(h in e.tv){if(e.tv.hasOwnProperty(h)){e.tv[h].viewdiv.down(".treeview-folders").update(g);if(d&&d.onSuccess){f.push(d.onSuccess(g))}else{f.push(void 0)}}else{f.push(void 0)}}return f}};if(d!=null?d.user:void 0){b.subject_user=d.user;a=Util.role_title_for_user(d.user);if(viewer.is_paired){if(d.user.is_team){c="s_briefcase"}else{c="s_house"}}else{c="dropbox"}if(!a){a=_("Dropbox")}$j("#first-treeview-link span").text(a);Sprite.replace($j("#root-img")[0],"web","dropbox",c)}else{$j("#first-treeview-link span").text(_("Dropbox"))}return $j.ajax(b)},toggle:function(c,b){var a;Event.stop(c);a=this.tv[b||"treeview"];if(a.shown){a.shown=false;this.hide(c,b)}else{a.shown=true;this.show(c.target,b)}return false},hide:function(c,b){var a;a=this.tv[b||"treeview"];if(!c||!$(c.target).descendantOf(a.viewdiv)){a.viewdiv.hide();Event.stopObserving(window,"click",a.hidefunc);return a.shown=false}},show:function(c,b){var d,a;a=this.tv[b||"treeview"];c=$(c);c.blur();d=c.cumulativeOffset();a.viewdiv.setStyle({top:(d.top+c.getHeight())+"px",left:(d.left-4)+"px"});a.viewdiv.show();return Event.observe(window,"click",a.hidefunc)},toggleNode:function(b){var a;b=$(b);a=b.down("img");if(a.className.match("bullet_plus")){Sprite.replace(a,"web","bullet_plus","bullet_minus")}else{Sprite.replace(a,"web","bullet_minus","bullet_plus")}b.up().next("div").toggle();b.blur();return false},toggleNodeAjax:function(d,a,b){var c,e,f=this;if(d.fetched_children){return this.toggleNode(d)}d=$(d);c=d.down("img");e=Sprite._get(c);c.src="/static/images/icons/ajax-loading-small.gif";$j.ajax({url:"/ajax_subtreeview"+a,method:"post",data:$j.extend({},this.ajax_params),subject_user:b,success:function(g){var h;h=new Element("div",{style:"display: none;"}).update(g);d.up().__sert({after:h});d.fetched_children=true;Sprite._set(c,e);return f.toggleNode(d)},complete:function(){if(/loading/.match(c.src)){return Sprite._set(c,e)}}});return false},handle:function(c,b){var d,a;d=$H(this.tv).keys();a=$(b).ancestors().find(function(e){return d.include(e.id)});if(!a){return}a=this.tv[a.id];$j(document).trigger("db:treeview_selected",[c]);if(a.handler){a.handler(c,b)}if(a.autohide){this.hide(a.id)}return false},move:function(c,d,b){var a,e=this;a=$(c);if(!this.loaded){this.reset({onSuccess:function(){e.loaded=1;return e.move(c,d,b)},user:b!=null?b.user:void 0})}else{if(b&&b.onSuccess){b.onSuccess()}}assert(a,"Couldn't find tree_id");assert($(d),"Couldn't find location_id");$(d).appendChild(a);return a.show()}};var ULSelectMenu;ULSelectMenu=(function(){var d,h,c,i,j,e,g,a,f,b,k;d=function(l){return l.removeClassName("shown")};k=function(l){return l.toggleClassName("shown")};g=function(){return this.removeClassName("hover")};e=function(){return this.addClassName("hover")};a=function(p,o){var l,q,n,m;m=[];for(q=0,n=o.length;q<n;q++){l=o[q];m.push(p.insert(l))}return m};i=function(n,l,m){a(n,m);if(n.firstChild!==l){return n.__sert({top:l})}};f=function(l,m){l.down(".selected").removeClassName("selected");return m.addClassName("selected")};b=function(n,q){var r,p,m,o,l;o=n.select("li");l=[];for(p=0,m=o.length;p<m;p++){r=o[p];if(r.getAttribute("data-value")===q){l.push(f(n,r))}else{l.push(void 0)}}return l};j=function(l,n,m){return function(o){if(!l.hasClassName("selected")){f(n,l);n.fire("db:change",l.getAttribute("data-value"));return d(n)}else{i(n,l,m);return k(n)}}};h=function(n){var q,t,p,m,s,l,o,r;t=n.select("li");assert(t.length,"Empty list of options "+n.identify());p=void 0;if(t.length===1){n.addClassName("one")}else{for(o=0,r=t.length;o<r;o++){q=t[o];s=q.getAttribute("data-value");assert(s,q.identify()+" missing data value");q.observe("click",j(q,n,t));q.observe("mouseenter",e);q.observe("mouseleave",g);if(q.hasClassName("selected")){p=q}}$(document.body).observe("click",function(u){if($(u.target).up(".ul_select_menu")===n){return}return d(n)})}if(!p){p=t[0]}p.addClassName("selected");l=new Element("span");m=p.getDimensions();l.setStyle({width:m.width+"px",height:m.height+"px",position:"relative",display:"inline-block"});return n.wrap(l)};c=function(){var p,o,m,n,l;n=$$(".ul_select_menu");l=[];for(o=0,m=n.length;o<m;o++){p=n[o];l.push(h(p))}return l};Util.smartLoad(c);return{init:function(l){return h(l)},set_selected_by_value:b}})();var UndoAction;UndoAction={set_undo_info:function(a,b){assert(b,"need to specify a function to start the undo");this.undo_info=a;return this.undo_handler=b},perform_undo:function(){if(this.undo_handler!=null){this.undo_handler(this.undo_info);return this.undo_handler=this.undo_info=null}}};var DBCalendar;DBCalendar=Class.create({initialize:function(b,a){this.options=a||{};this.container=$(b);assert(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=Util.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=Util.start_of_day(this.options.first_day||this.today)}this.view_date=Util.start_of_day(this.options.selected_date||this.today);this.selected_date=Util.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(b,a){Event.stop(b);this.view_date.setMonth(a);return this.render()},is_valid_date:function(d,f,e,c,a){var b;d=parseInt(d,10);f=parseInt(f,10);e=parseInt(e,10);c=parseInt(c,10);a=parseInt(a,10);c=c||1970;a=a||(new Date()).getFullYear()+1;f+=1;if(e<c){return false}if(e>a){return false}if(f<1||f>12){return false}if(d<=0){return false}if(f===2){b=((e%4)===0)&&(((e%100)!==0)||((e%400)===0));if(b){return d<=29}else{return d<=28}}else{if(f===4||f===6||f===9||f===11){return d<=30}else{return d<=31}}},change_date:function(a,d,b){var c;if(!this.is_valid_date(a,d,b)){return}c=b!==this.view_date.getFullYear()||d!==this.view_date.getMonth();this.selected_date.setDate(a);this.selected_date.setMonth(d);this.selected_date.setFullYear(b);if(c){this.view_date.setMonth(d);this.view_date.setFullYear(b);this.render()}else{$j(this.container).find(".selected").removeClass("selected");$j(this.container).find("a#day"+a+"-"+d).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var d,j,h,f,e,b,g,c,i,a;j=this.render_days();f=$j(".current-month",j);g=f.first().data("date");b=f.last().data("date");a=g<=this.options.first_day;i=b>=this.options.last_day;d=new Element("div");d.addClassName("calendar clearfix");if(!i){this._next_month=(function(k){return this._change_month(k,this.view_date.getMonth()+1)}).bind(this);e=new Element("a");e.addClassName("changemonth next");e.update(Sprite.make("web","arrowright",{}));Event.observe(e,"click",this._next_month);d.__sert(e)}if(!a){this._prev_month=(function(k){return this._change_month(k,this.view_date.getMonth()-1)}).bind(this);c=new Element("a");c.addClassName("changemonth prev");c.update(Sprite.make("web","arrowleft",{}));Event.observe(c,"click",this._prev_month);d.__sert(c)}h=new Element("h5");h.update(_("%(month)s %(year)s").format({month:Util.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));d.__sert(h);d.__sert(j);return this.container.__date(d)},render_days:function(){var h,g,a,f,b,e,d,c;g=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);d=g.getDay();h=new Element("div");h.addClassName("days");for(a=c=d;d<=0?c<0:c>0;a=d<=0?++c:--c){e=new Date(g.getFullYear(),g.getMonth(),g.getDate());e.setDate(e.getDate()-a);h.__sert(this.render_day(e,true))}f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(f.getMonth()===this.view_date.getMonth()){h.__sert(this.render_day(f));f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),f.getDate()+1)}b=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(b.getDay()!==6){b=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);h.__sert(this.render_day(b,true))}return h},render_day:function(c,e){var b,d;d=!e;if(this.options.last_day){e=e||c>this.options.last_day}if(this.options.first_day){e=e||c<this.options.first_day}b=new Element(e?"span":"a");$j(b).data("date",c);if(d){b.addClassName("current-month")}b.update(c.getDate());b.addClassName("date");b.writeAttribute("id","day"+c.getDate()+"-"+c.getMonth());if(this.selected_date.getDate()===c.getDate()&&this.selected_date.getMonth()===c.getMonth()&&this.selected_date.getFullYear()===c.getFullYear()){b.addClassName("selected")}if(e){b.addClassName("inactive")}else{this._handler=(function(f){var a;a=f.target.identify().substr(3).split("-");return this.change_date(a[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(b,"click",this._handler)}return b}});var DatePickerInput;DatePickerInput=Class.create({initialize:function(a,c){var d,b;this.container=a;this.options={};Object.extend(this.options,c||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");b=(this.input.value?Util.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){d=Util.from_mysql_date(this.container.getAttribute("data-first"))}this.cal_container=this.container.down(".cal-container");this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:d,disable_future:true,selected_date:b});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(b)},show_cal:function(b){var a;if(b){Event.stop(b)}a=$(b.target);if(a.match(".cal-container")||a.up(".cal-container")){return}$j(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(a){this.input.value=Util.to_mysql_date(a,false);this.display.update(DateUtil.localize(a));return this.hide_cal()}});var TextInputDatePicker;TextInputDatePicker=Class.create({initialize:function(d,c){var f,e,b,a;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,c||{});this.input=$(d);assert(this.input,"Couldn't find the element "+d.toString());b=new Date();a=(this.input.value?Util.from_mysql_date(this.input.value):false);e=new Date(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate());this.cal_icon=Sprite.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+d,style:"display: none; position: absolute; z-index: 1"});this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:e,selected_date:a});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));f=$j(this.input);$j(this.cal_container).clonePosition(f,{setWidth:false,setHeight:false,offsetTop:f[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(a){if(a){Event.stop(a)}return this.cal_container.toggle()},hide_cal:function(a){if(a){Event.stop(a)}return this.cal_container.hide()},onDateChange:function(a){if(this.options.choose_eod){a.setTime(Util.start_of_day(a).getTime()+86399999)}this.input.value=Util.to_mysql_date(a,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});Util.smart_window_load(ActAsBlock.register.bind(ActAsBlock));Util.smartLoad(SickInput.init.bind(SickInput));Util.smartLoad(SuggestionInput.register_all.bind(SuggestionInput));Event.observe(window,"scroll",function(){return TitleBubble.hide_all()});Util.smartLoad(function(){JumpWatcher.interval=setInterval(JumpWatcher.check.bind(JumpWatcher),500);LocaleSelector.init();LoginDropdown.init();return TitleBubble.init()});var LocaleSelector;LocaleSelector={init:function(){var a=this;$j(document).on("click",".modal-locale-link",function(b){b.preventDefault();return a.show()});return $j(document).on("click",".modal-locale-link-index-page",function(b){b.preventDefault();a.logShow();return a.show()})},show:function(){if(!this.modal){this.modal=new LocaleSelectorModal({element_id:"locale-selector-modal"})}return this.modal.show()},logShow:function(){return $j.ajax({url:"https://"+Constants.WEBSERVER+"/log_user_opened_locale_selector",type:"POST"})}};var ChangeNameModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ChangeNameModal=(function(a){__extends(b,a);function b(){b.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=this.make_async_form_submit(function(){return location.reload()})}return b})(DBModal);var AccountExtras;AccountExtras={prices:{},prices_value:{},watch_id:0,watch:function(){if(!AccountExtras.watch_id){return AccountExtras.watch_id=setInterval(AccountExtras.update_prices,200)}},show_detail:function(a,d,b){var c;c=_("What is %(feature_name)s?").format({feature_name:a});Modal.icon_show("alert_32",c,$(d+"-modal"),{},false);return false},register_price:function(e,a,d,c,b){AccountExtras.prices[e]=[a,d];return AccountExtras.prices_value[e]=[c,b]},update_prices:function(){var f,d,a,b,c,e;e=$("yearly").checked;d=(e?1:0);a=(e?_("year"):_("month"));b=0;for(f in AccountExtras.prices){if(AccountExtras.prices.hasOwnProperty(f)){$(f+"-price").__date(AccountExtras.prices[f][d]);$(f+"-priceperiod").__date(a)}if(AccountExtras.prices_value.hasOwnProperty(f)){if($(f).checked){c=AccountExtras.prices_value[f][d];b+=parseFloat(c)}}}return $(document).fire("widget:update_price",{price:b,period:a})}};var AliasManager,ManageAliasModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ManageAliasModal=(function(b){__extends(a,b);function a(c){this.options=c;this._poll_until_verified=__bind(this._poll_until_verified,this);this._get_params_from_target=__bind(this._get_params_from_target,this);this._on_load=__bind(this._on_load,this);this._show_action_panel=__bind(this._show_action_panel,this);this._input_enter_handler=__bind(this._input_enter_handler,this);this.resend_verify=__bind(this.resend_verify,this);this.remove_alias=__bind(this.remove_alias,this);this.add_alias=__bind(this.add_alias,this);this.refresh_alias=__bind(this.refresh_alias,this);this.on_show=__bind(this.on_show,this);a.__super__.constructor.call(this,this.options)}a.prototype.before_show=function(c){a.__super__.before_show.call(this,c);this.polling=0;c.find(".alias-action").on("click",this._show_action_panel);c.find(".alias-action-submit").on("click",this.add_alias);c.find("form").submit(function(){return false});return c.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};a.prototype.on_show=function(){SickInput.init();return this.refresh_alias(true,this._poll_until_verified)};a.prototype.refresh_alias=function(d,c){var e=this;if(d==null){d=true}if(d){Forms.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:function(f){e.$modal_window.find(".dynamic-content").html(f.responseText);e._on_load(f);if(typeof c==="function"){return c()}},onFailure:function(f){return e.hide()}})};a.prototype.add_alias=function(g){var f,c,d,h,i=this;g.preventDefault();c=$j(g.currentTarget).closest("form");f=c.find(".alias-action-submit");h={};h[Constants.UID_PARAM_NAME]=this.options.subject_user.id;d=function(){var e;i.$modal_window.find(".alias-action-inputs input").val("");i.polling=0;e=i.polling?null:i._poll_until_verified;return i.refresh_alias(true,e)};return Forms.ajax_submit(c[0],false,d,false,f[0],h,"before")};a.prototype.remove_alias=function(c){var d,f=this;c.preventDefault();d=this._get_params_from_target(c.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:d,onSuccess:function(e){return f.refresh_alias()}})};a.prototype.resend_verify=function(c){var d,f=this;c.preventDefault();d=this._get_params_from_target(c.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:d,onSuccess:function(e){return f.refresh_alias()}})};a.prototype._input_enter_handler=function(c){c.preventDefault();c.stopPropagation();if(c.which===13){return this.add_alias(c)}};a.prototype._show_action_panel=function(f){var d,c;f.preventDefault();c=$j(f.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();d=this.$modal_window.find("#"+c).show();return d.find("input:visible:enabled:first").focus()};a.prototype._on_load=function(c){var d=this;BrowseStyleRows.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",function(f){return d.remove_alias(f)});return this.$dynamic.on("click",".alias-verify",function(f){return d.resend_verify(f)})};a.prototype._get_params_from_target=function(e){var c,d,f;c=$j(e);f=c.data("alias-type");d=c.closest(".alias-row").find(".alias-text").text();return{alias:d,alias_type:f}};a.prototype._poll_until_verified=function(){var e,f,d,c,g=this;f=5;e=60;d=function(){return g.refresh_alias(false,g._poll_until_verified)};c=this.$dynamic.find(".alias-verify").length;if(c&&this.polling<e){this.polling++;return setTimeout(d,f*1000)}else{return this.polling=0}};return a})(DBModal);AliasManager={show:function(e){var c,d,b,a;a=viewer.get_user_by_role(e);if(!(a!=null)){return}if(!a.is_email_verified){if(e===Constants.ROLE_PERSONAL){personal_email_verification.verified()}else{work_email_verification.verified()}return}b=viewer.is_paired?e:"";d=_("Manage your %(role_show)s contact methods").format({role_show:b});c=new ManageAliasModal({element_id:"manage-alias",title:d,subject_user:a,role:a.role});c.show()}};var BonusTable;BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(a){this.user_id=a;if(BonusTable._inited){return}BonusTable._inited=true;$("bonus-loading").show();BonusTable._tmpl=HTML.tmpl("bonus_row_tmpl");BonusTable.listen();return BonusTable.get_next_page()},_render:function(d){var b,e,c,a;b=[];for(c=0,a=d.length;c<a;c++){e=d[c];b.push(BonusTable._tmpl({row:e}))}return $("bonus-table").__sert(b)},get_next_page:function(){if(BonusTable._fetching_page){return}BonusTable._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+BonusTable._next_page,{onSuccess:function(b){var d,a,c;d=b.responseText.evalJSON();c=d.rows;a=d.has_more;BonusTable._render(c);$("bonus-loading").hide();if(a){BonusTable._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return BonusTable._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(b){var a,d,c;d=$j(b.currentTarget);c=_("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");a=$j(Bubble.make(c,"right","middle"));Element.absolutize(a[0]);d.append(a);a.clonePosition(d,{setWidth:false,setHeight:false});return a.css({width:"200px",left:(parseInt(a.css("left"),10)-210)+"px",top:(parseInt(a.css("top"),10)-55)+"px"})},_max_referral_out:function(h){var a,g,d,f,c;f=$j(".reached-max-referral-bonus .bubble");c=[];for(g=0,d=f.length;g<d;g++){a=f[g];c.push(a.remove())}return c},listen:function(){$j("#load-more-bonus").on("click",BonusTable.get_next_page.bind(BonusTable));$j(document).on("mouseenter",".reached-max-referral-bonus",BonusTable._max_referral_over);return $j(document).on("mouseleave",".reached-max-referral-bonus",BonusTable._max_referral_out)},toggle:function(){if($j("#bonus-list").is(":visible")){this.hide();return $j("#space-earned-link").text(_("View all space earned"))}else{this.show();return $j("#space-earned-link").text(_("Hide space earned"))}},show:function(){return $j("#bonus-list").slideDown(150)},hide:function(){return $j("#bonus-list").slideUp(150)}};var ChangeEmail,ChangeEmailConstants,ChangeEmailModal,ChangeEmailWarningModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}},__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};ChangeEmailConstants={_email_changed_event_template:"db:email_changed",get_email_changed_event_for_user:function(a){return""+this._email_changed_event_template+":"+a.id}};ChangeEmailWarningModal=(function(a){__extends(b,a);function b(c,e,d){this.inbox_count=e;b.__super__.constructor.call(this,c,d)}b.prototype.on_confirm_button_click=function(c){c.preventDefault();this.hide();return ChangeEmail.show_form(this.user)};b.prototype.before_show=function(c){b.__super__.before_show.call(this,c);this.set_visible_sso_warning(this.user.sso_required,c);return this.set_inbox_count_warning(this.inbox_count,c)};b.prototype.set_visible_sso_warning=function(d,c){var e;if(d&&viewer.is_paired&&this.user.role===Constants.ROLE_WORK){e=_("Your %(team_name)s Dropbox uses single sign-on. If you change your email address you may not be able to sign in.").format({team_name:viewer.team_name});$j("#sso-change-email-warning",c).text(e);return $j(c).addClass("sso-required")}else{return $j(c).removeClass("sso-required")}};b.prototype.set_inbox_count_warning=function(e,c){var d;if(e===0){return $j(c).removeClass("inbox-warning")}else{if(viewer.is_paired&&this.user.role===Constants.ROLE_PERSONAL){d=ungettext("Your %(num)d existing shared folder invitation in your personal Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your personal Dropbox will be removed if you change your email address.",e).format({num:e})}else{if(viewer.is_paired&&this.user.role===Constants.ROLE_WORK){d=ungettext("Your %(num)d existing shared folder invitation in your %(team_name)s Dropbox will be removed if you change your email address.","Your %(num)d existing shared folder invitations in your %(team_name)s Dropbox will be removed if you change your email address.",e).format({num:e,team_name:viewer.team_name})}else{d=ungettext("Your %(num)d existing shared folder invitation will be removed if you change your email address.","Your %(num)d existing shared folder invitations will be removed if you change your email address.",e).format({num:e})}}$j("#shared-change-email-warning",c).text(d);return $j(c).addClass("inbox-warning")}};return b})(DBUserModal);ChangeEmailModal=(function(a){__extends(b,a);function b(c,d){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);b.__super__.constructor.call(this,c,d)}b.prototype.before_show=function(c){var e,d,f;b.__super__.before_show.call(this,c);e=[];if(viewer.is_paired){if(this.user.role===Constants.ROLE_PERSONAL){e.push(_("Enter a new email address for your personal Dropbox."))}else{if(this.user.role===Constants.ROLE_WORK){d=_("Enter a new email address for your %(team_name)s Dropbox.");e.push(d.format({team_name:viewer.team_name}))}}}if(this.user.is_email_verified&&ChangeEmail._viewer_can_have_pending_change){if(viewer.is_paired&&this.user.role===Constants.ROLE_PERSONAL){e.push(_("You'll need to verify your new email address in order to finish updating your personal email."))}else{if(viewer.is_paired&&this.user.role===Constants.ROLE_WORK){d=_("You'll need to verify your new email address in order to finish updating your %(team_name)s email.");e.push(d.format({team_name:viewer.team_name}))}else{e.push(_("You'll need to verify your new email address in order to finish updating your email."))}}}if(e.length>0){f=render_sentences(e);return c.find("#change-email-prompt-text").text(f)}};b.prototype.on_show=function(){return this.$modal_window.find("#change-email").addClass("warnings-not-seen")};b.prototype.on_confirm_button_click=function(g){var d,c,f,i,h=this;g.preventDefault();f=this.$modal_window.find(".change-email-form")[0];d=f.findFirstElement(".email").value;i=function(j){var m,k,e,l;l=j.responseText==="NEEDS_VERIFICATION";m=ChangeEmailConstants.get_email_changed_event_for_user(h.user);$j(document).trigger(m,[d,l]);e=Util.get_window_location();if(l){h.hide();k=EmailVerification.get_for_user(h.user);k.set_email_to_verify(d);return k.email_sent()}else{if(e.pathname.indexOf("/account")===0){if(d===h.user.email){return h.hide()}else{return e.reload()}}else{return e.href="/home?send_verification_email=1"}}};c=function(e){if((e!=null?e.status:void 0)===403){Notify.server_error(_("Request failed due to an unknown authentication error.  Please sign out of Dropbox and sign back in to try again."));return location.reload(true)}};return Forms.ajax_submit(f,false,i,c,$(g.target))};return b})(DBUserModal);ChangeEmail={modals:{},warning_modals:{},inbox_counts:{},_viewer_can_have_pending_change:false,should_show_warning:function(a){return this.inbox_counts[a.id]>0||(a.sso_required&&viewer.is_paired&&a.role===Constants.ROLE_WORK)},show_warning:function(a){var b;if(b=a.id,__indexOf.call(this.warning_modals,b)<0){this.warning_modals[a.id]=new ChangeEmailWarningModal(a,this.inbox_counts[a.id],{element_id:"change-email-warning"})}return this.warning_modals[a.id].show()},show_form:function(a){var b;if(b=a.id,__indexOf.call(this.modals,b)<0){this.modals[a.id]=new ChangeEmailModal(a,{element_id:"change-email",title:_("Update '%(email)s'").format({email:a.email})})}return this.modals[a.id].show()},show:function(a){var b;b=viewer.get_user_by_id(a);if(this.should_show_warning(b)){return this.show_warning(b)}return this.show_form(b)},set_inbox_counts:function(a,b){return this.inbox_counts[a]=b}};var DowngradeReasons;DowngradeReasons={reasons:{},addReason:function(a){return this.reasons[a]=true},addReasons:function(a){var d,e,c,b;b=[];for(e=0,c=a.length;e<c;e++){d=a[e];b.push(this.addReason(d))}return b},change:function(f,c,a){var g,i,h,d,b,e;f=parseInt(f,10);i=$(c);assert(i,"Couldn't find container for DowngradeReason");g=false;e=this.reasons;for(d in e){h=e[d];b=$(a+d);assert(b,"Couldn't find container for ",a+d);if(h&&parseInt(d,10)===f){b.show();g=true}else{b.hide()}}if(g){return i.show()}else{return i.hide()}}};var Downloading;Downloading={autostartDownloadFunction:function(b,a){return function(){return $j("#"+b).attr("src",a)}}};var EmailVerification,EmailVerificationConstants;EmailVerificationConstants={EMAIL_SENT_EVT:"db:verification_email_sent"};EmailVerification=(function(){a.prototype.polling=false;a.prototype.show_resend=false;function a(c){var b;this.role=c;if(this.role){this.user=viewer.get_user_by_role(this.role,true)}else{this.user=viewer.deprecated_first_user_in_the_cookie}this.email_to_verify=(b=this.user)!=null?b.email:void 0;this.verify_for_change=false}a.prototype.set_email_to_verify=function(b){if(b!==this.email_to_verify){this.verify_modal=null;this.resend_verify_modal=null;this.sent_modal=null;this.verified_modal=null;this.verified_and_changed_modal=null}this.email_to_verify=b;return this.verify_for_change=this.email_to_verify!==this.user.email};a.prototype.send_email=function(c,b){var d=this;return new Ajax.DBRequest("/sendverifyemail",{parameters:{reason:c,email:this.email_to_verify},onSuccess:function(){return $j(document).trigger(EmailVerificationConstants.EMAIL_SENT_EVT,[b])},subject_user:this.user})};a.prototype.poll_until_verified=function(c){var b,d=this;b=4000;return new Ajax.DBRequest("/isemailverified",{parameters:{email:this.email_to_verify},onSuccess:function(f){var e;if(f.responseText==="ok"){if(c!=null){if(d.verify_modal!=null){d.verify_modal.hide()}if(d.resend_verify_modal!=null){d.resend_verify_modal.hide()}return c()}else{return window.location.reload()}}else{e=function(){return d.poll_until_verified(c)};return setTimeout(e,b)}},subject_user:this.user})};a.prototype.email_sent=function(b){var c;this.show_resend=true;this.show();c=_("Verification email sent to %(email)s");c=c.format({email:this.email_to_verify});Notify.server_success(c);if(!this.polling){this.poll_until_verified(b);return this.polling=true}};a.prototype.show=function(b){if(this.show_resend){return this.show_resend_verify_modal()}return this.show_verify_modal(b)};a.prototype.show_verify_modal=function(c){var b;if(!this.verify_modal){b=this.verify_for_change?"verify-to-change-email":"verify-email";this.verify_modal=new VerifyEmailModal(this.user,{element_id:b,email_verification:this,email:this.email_to_verify})}return this.verify_modal.show(c)};a.prototype.show_resend_verify_modal=function(){var b;if(!this.resend_verify_modal){b=this.verify_for_change?"resend-verify-to-change-email":"resend-verify-email";this.resend_verify_modal=new ResendVerifyEmailModal(this.user,{element_id:b,email_verification:this,email:this.email_to_verify})}return this.resend_verify_modal.show()};a.prototype.verified=function(){if(this.user.is_email_verified){return true}else{this.show();return false}};a.prototype.show_sent_modal=function(){if(!this.sent_modal){this.sent_modal=new CustomEmailModal(this.user,{element_id:"verification-email-sent",email:this.email_to_verify})}return this.sent_modal.show()};a.prototype.show_verified_modal=function(){if(!this.verified_modal){this.verified_modal=new CustomEmailModal(this.user,{element_id:"email-verified",email:this.email_to_verify})}return this.verified_modal.show()};a.prototype.show_verified_and_changed_modal=function(){if(!this.verified_and_changed_modal){this.verified_and_changed_modal=new CustomEmailModal(this.user,{element_id:"email-verified-and-changed",email:this.email_to_verify})}return this.verified_and_changed_modal.show()};a.prototype.setup=function(b){return Util.smartLoad(function(){$j("#send-email-link").on("click",function(c){c.preventDefault();return this.send_email(b)});return $j(document).on(EmailVerificationConstants.EMAIL_SENT_EVT,function(){$j("#pre-resend").hide();$j("#post-resend").show();$j("#pre-resend-header").hide();return $j("#post-resend-header").show()})})};a.getForRole=function(b){if(!this.initalized){this.legacy=new a(null);this.personal=new a("personal");this.work=new a("work");this.initalized=true}if(b==="personal"){return this.personal}else{if(b==="work"){return this.work}else{return this.legacy}}};a.get_for_user=function(b){return this.getForRole(b.role)};return a})();var GetSpace;GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(c,b,d){var a;GetSpace._current_space=c;GetSpace._why_msg=b;GetSpace._twitter_url=d;if($("why_like")&&$("twitter_post")){$("twitter_post").hide()}$("space-actions").on("click",".space-action",GetSpace.perform_action);a=Util.url_hash();if(a){return GetSpace.highlight_offer(a)}},highlight_offer:function(b){var a,c;a=$j("#"+b);c=a.css("background-color");return a.css("background-color",GetSpace.offer_highlight_color).delay(2000).animate({"background-color":c}).queue(function(){return a.css("background-color","")})},perform_action:function(b){var c,a;a={contact_sales:GetSpace._contact_sales,contact_support:GetSpace._contact_support,teams:GetSpace._teams,upgrade:GetSpace._upgrade,plans:GetSpace._plans,refer:GetSpace._refer,get_started:GetSpace._get_started,fb_link:GetSpace._fb_link,twitter_link:GetSpace._twitter_link,twitter_follow:GetSpace._twitter_follow,why_like:GetSpace._why_like,twitter_post:GetSpace._twitter_post,mailbox_link:GetSpace._mailbox_link};c=$(b.target);if(!c.hasClassName("space-action")){c=c.up(".space-action")}return a[c.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return FacebookOAuth.do_auth(function(){GetSpace._refresh_link_bonuses();return GetSpace._completed($("fb_link"))},viewer.personal_user.id)},_twitter_link:function(){return Twitter.do_auth(function(){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(viewer.personal_user.id,true);return GetSpace._completed($("twitter_link"))},viewer.personal_user.id)},_twitter_follow:function(){if(Twitter.is_authed(viewer.personal_user.id)){return GetSpace.follow_dropbox()}else{return Twitter.do_auth(GetSpace.follow_dropbox,viewer.personal_user.id)}},_why_like:function(){Modal.icon_show("heart_32",_("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return Util._track_twitter_chars_left("why-i-like-input",90)},_twitter_post:function(){if(Twitter.is_authed(viewer.personal_user.id)){return GetSpace.start_twitter_post()}else{return Twitter.do_auth(GetSpace.start_twitter_post,viewer.personal_user.id)}},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!Twitter.is_authed(viewer.personal_user.id)){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(viewer.personal_user.id,true)}return Twitter.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(_("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(_("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}return GetSpace._completed($("twitter_follow"))}},viewer.personal_user.id)},submit_why:function(){GetSpace._why_msg=$F("why-i-like-input");return Forms.ajax_submit($("why-i-like-form"),false,(function(){Modal.hide();GetSpace._completed($("why_like"));if($("twitter_post")){return setTimeout((function(){return $j("#twitter_post").css("opacity",0).slideDown().animate({opacity:1},{queue:false,duration:2500})}),2500)}}),false,$("why-i-like-submit"))},start_twitter_post:function(){Modal.onHide=function(){if(!Twitter.is_authed(viewer.personal_user.id)){GetSpace._refresh_link_bonuses();Twitter.set_is_authed(viewer.personal_user.id,true)}if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}delete Modal.onHide;return Modal.hide()};return Twitter.get_user_info(function(a){Modal.icon_show("tweet_32",_("Tweet about your love of Dropbox"),$("twitter-post-modal"));$("twitter-post-header").down(".profile-pic").__date(new Element("img",{src:a.profile_image_url_https}));$("twitter-post-header").down(".name").__date(a.name);$("twitter-post-header").down(".username").__date("@"+a.screen_name);GetSpace._update_display_twitter_post();$("twitter-post-input").setValue(GetSpace._why_msg);return Util._track_twitter_chars_left("twitter-post-input",90)},viewer.personal_user.id)},show_edit_twitter_post:function(){$("display-twitter-post").hide();$("display-twitter-post-buttons").hide();$("edit-twitter-post").show();$("edit-twitter-post-buttons").show();$("twitter-post-input").observe("keypress",function(a){if(a.keyCode===13){return GetSpace.hide_edit_twitter_post()}});return $("twitter-post-input").focus()},hide_edit_twitter_post:function(){var a;a=$F("twitter-post-input");if(!a){Notify.server_error(_("Please enter a message"));return}else{if(a.length>90){Notify.server_error(_("Your post must be 90 characters or less"));return}}GetSpace._why_msg=a;GetSpace._update_display_twitter_post();$("edit-twitter-post").hide();$("edit-twitter-post-buttons").hide();$("display-twitter-post").show();return $("display-twitter-post-buttons").show()},do_twitter_post:function(){var a;Twitter.from_getspace=1;a=_("I love Dropbox because %(why_msg)s %(referral_link)s").format({why_msg:GetSpace._why_msg,referral_link:GetSpace._twitter_url});if(a.length>140){GetSpace.show_edit_twitter_post();Notify.server_error(_("Your tweet must be 140 characters or less"));return}Twitter.custom_show_posting=function(){return Forms.add_loading($("twitter-post-submit"))};return Twitter.custom_post(a,function(){Modal.hide();return GetSpace._completed($("twitter_post"))},viewer.personal_user.id)},_update_display_twitter_post:function(){var a;$("display-twitter-post").__date(_("I love Dropbox because %(why_msg)s ").format({why_msg:GetSpace._why_msg}));a=new Element("a",{href:GetSpace._twitter_url,target:"_blank"});a.__date(GetSpace._twitter_url);return $("display-twitter-post").__sert(a)},_completed:function(b){var a;b.addClassName("completed");b.down(".icon-col").__date(Sprite.make("web","check_36"));$j(b).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return $j(b).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);a=parseInt(b.down(".space").readAttribute("data-space"),10);GetSpace._current_space+=a;$("current-space").__date(Util.formatBytes(GetSpace._current_space,2,true));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var Help;Help={toggle_more_help:false,show_os:function(b,c,a){c=$(c);$$(".os-filter").invoke("removeClassName","selected");c.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+a).invoke("show");return Event.stop(b)},vote:function(a,b){new Ajax.DBRequest("/help/"+a+"/vote/"+b);$j("#help-vote-cont").fadeOut();return Notify.server_success(_("Thanks for your feedback!"))}};var Home;Home={hide_promo:function(a){new Ajax.DBRequest(a);return $$(".house-ad").invoke("remove")}};var DeleteFailuresModal,Hosts,UnlinkHostModal,show_delete_failures_modal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Hosts={attach_host_listener:function(e,c){var b,d,f,a;b=$j("#"+e);f=b.data("host-ids");d=b.data("display-name");a=function(){return new UnlinkHostModal(f,d,c,null,null).show()};return $j(".unlink-host-link",b).on("click",a)},edit:function(c,a){var f,e,h,b,d,g;h=$j("#host-device-row-"+a+" .host-item .sprite-text");if(h.data("editing")==="true"){return false}h.data("editing","true");e=h.text();h.data("previous",e);g=e.escapeHTML().gsub('"',"&quot;");d=_("Save");f=_("Cancel");c=$u.values(c);h.html('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" value="'+g+'">&nbsp;\n<input type="button" onclick="Hosts.doneEditing(['+c+"], "+a+')" class="button" value="'+d+'">&nbsp;\n<input type="button" onclick="Hosts.cancelEditing('+a+')" class="button grayed" value="'+f+'">');b=$j("input",h);b.on("keydown",function(){return Hosts.checkKey(c,a)});return b.focus()},doneEditing:function(c,b){var d,a;d=$j("#host-device-row-"+b+" .host-item .sprite-text");a=$j("input",d).val();return $j.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(c),name:a},type:"POST"}).success(function(e){return Hosts.unedit(d,JSON.parse(e).display_name)})},cancelEditing:function(a){var b;b=$j("#host-device-row-"+a+" .host-item");return Hosts.unedit(b,b.data("previous"))},unedit:function(b,a){b.data("editing","false");return b.text(a)},dismiss:function(c,b,d,a,e){new $j.ajax("/computer_edit",{type:"POST",data:{host_id:c,user_id:b,team_id:d,dismiss_unlink:"yessir"},subject_user:e,success:function(f){return a.remove()}});return false},checkKey:function(b,a){return function(c){c=c||window.event;if(c.keyCode===Event.KEY_RETURN){Hosts.doneEditing(b,a)}if(c.keyCode===Event.KEY_ESC){return Hosts.cancelEditing(a)}}},show_device_unlink_modal:function(b,c,a,f){var e,d;e=$j("#unlink-"+b);d={both:$u.values(f),personal:[f[Constants.ROLE_PERSONAL]],work:[f[Constants.ROLE_WORK]]};Modal.icon_show(c,a,e[0]);if($u.values(f).length>1){e.addClass("show-selector")}return $j("form input[type=submit]",e).on("click",function(g){g.preventDefault();f=d[$j(".unlink-select select",e).val()];Forms.add_vars($j("form",e)[0],{user_ids:JSON.stringify(f)});return $j("form",e).submit()})}};DeleteFailuresModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(c){c.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};b.prototype.on_show=function(d){var c;c=ungettext("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(c)};return b})(DBModal);show_delete_failures_modal=function(c,b,a){var d;d=new DeleteFailuresModal({element_id:"delete-failures-modal"});d.host_id=c;d.name=b;d.num_failures=a;d.show();return false};UnlinkHostModal=(function(b){__extends(a,b);function a(g,e,c,d,f){this.host_ids=g;this.name=e;this.delete_support_type=c;this.owner_id=d;this.team_id=f;this.on_show=__bind(this.on_show,this);this.fail_callback=__bind(this.fail_callback,this);this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.show_host_selector=$u(this.host_ids).values().length>1;a.__super__.constructor.call(this,{element_id:"unlink-host-modal"})}a.prototype.on_confirm_button_click=function(g){var d,f,c;g.preventDefault();f=this.$modal_window.find(".unlink_host_form")[0];d=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");c={host_ids:JSON.stringify(this.get_selected_hosts())};return Forms.ajax_submit(f,false,this.success_callback,this.fail_callback,d,c)};a.prototype.success_callback=function(){return window.location.reload()};a.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};a.prototype.on_show=function(d){var c;this.$modal_window.find(".delete_data").attr("checked",false);if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}}if(this.show_host_selector){c="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(_("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:c}));this.$modal_window.find(".delete_data_label").text(_("Delete files from these Dropboxes the next time this computer comes online."))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};a.prototype.get_selected_hosts=function(){var c;if($u.values(this.host_ids).length===1){return $u.values(this.host_ids)}c=$j("select.unlink-choice").val();if(c==="both"){return $u.values(this.host_ids)}else{return[this.host_ids[c]]}};return a})(DBModal);var LoginAndRegister;LoginAndRegister={init:function(b,a){$j("#login-link").on("click",function(){$j("#login-and-register-container").removeClass("show-register");if(a){return $j("#login_password").focus()}else{return $j("#login_email").focus()}});$j("#register-link").on("click",function(){$j("#login-and-register-container").addClass("show-register");return $j("#register-partial input").filter(":visible").first().focus()});if(b){return $j("#register-partial input").filter(":visible").first().focus()}else{if(a){return $j("#password-field input").focus()}else{return $j("#login_email").focus()}}}};var News;News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(b,c){var a;if(c.hasAttribute("data-div")){b.preventDefault();a=c.readAttribute("data-div");return DBHistory.push_state("/news/"+a)}});return DBHistory.add_callback("/news",News.history_change)},change_tab:function(a){var b;b=$$("#nav a[data-div="+a+"]").first();if($(b)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(b).addClassName("selected");return $(a).addClassName("selected")}},history_change:function(a){a=a||News.DEFAULT_TAB;return News.change_tab(a)}};var PasswordChange;PasswordChange={set_user_id:function(a){this.user_id=a},show_change_password_modal:function(){return Modal.icon_show("alert_32",_("Change password"),$("change-password"),{},false,550)},submit_password_change:function(d){var b,a,c,f;c=$("change-password-form");f=function(){return window.location.reload()};a=function(e){if((e!=null?e.status:void 0)===403){Notify.server_error(_("Request failed due to an unknown authentication error.  Please sign out of Dropbox and sign back in to try again."));return window.location.reload(true)}};b={};b[Constants.UID_PARAM_NAME]=this.user_id;return Forms.ajax_submit(c,false,f,a,$(d.target),b)}};var PromoHolder;PromoHolder={init:function(a,c,b){return new Ajax.DBRequest("/promo",{subject_user:a,parameters:{force_campaign:c,force_promo:b},noAutonotify:true,no_watch:true,onSuccess:function(f){var e,d;if(f.responseText.length>0){$j("#promo_holder").html(f.responseText);e=$j("#promo_holder img");d=0;return e.load(function(){d++;if(d===e.length){Event.observe(window,"resize",PromoHolder.check_sizing);return Util.smart_window_load(PromoHolder.check_sizing)}})}}})},check_sizing:function(){var a,c,e,d,f,b;f=$$("#promo_holder div");if(!f.length){return}e=f[0];a=20;c=$("page-sidebar");b=c.cumulativeOffset().top+c.getLayout().get("height");d=e.cumulativeOffset().top;if(b+a>d||$(document.body).getWidth()<1015){return $j("#promo_holder").css("visibility","hidden")}else{return $j("#promo_holder").css("visibility","visible")}}};var Recover;Recover={init:function(){var a;a=$("recover-form");return a.observe("submit",this.form_submit.bind(this))},form_submit:function(a){this.clear_error();a.preventDefault();return Forms.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(b){var a;a=JSON.parse(b.responseText);if(a.status==="error"){this.show_error(a.msg)}if(a.status==="ok"){this.show_hosts(a)}if(a.status==="redirect"){return window.location.href=a.url}},show_hosts:function(h){var e,c,d,a,g,b,f;Forms.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(h.filename);c=$("trusted-hosts");c.update();f=h.hosts;for(g=0,b=f.length;g<b;g++){e=f[g];a=new Element("li");d="lnx";if(e.platform==="mac"){d="osx"}if(e.platform==="win"){d="win"}a.__sert(Sprite.make("web",d));a.__sert(new HTML(e.display_name.escapeHTML()));c.appendChild(a)}$("login-step").hide();return $("hosts-step").show()},show_error:function(a){$("error-messages").update(a);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var Restore;Restore={next:function(a,d){var c,b;b=$j("ul.selected");c=b.next("ul");c.addClass("selected");b.removeClass("selected");if(c.next("ul").length){$j("#next-page").show()}else{$j("#next-page").hide()}$j("#prev-page").show();return Restore.inc_page(1)},prev:function(a,d){var c,b;b=$j("ul.selected");c=b.prev("ul");c.addClass("selected");b.removeClass("selected");if(c.prev("ul").length){$j("#prev-page").show()}else{$j("#prev-page").hide()}$j("#next-page").show();return Restore.inc_page(-1)},inc_page:function(c){var b,a;b=parseInt($j("#page_num").text(),10);a=b+c;return $j("#page_num").text(a)},init:function(d,a,b){var c;c=viewer.get_user_by_id(b);$j("#next-page").on("click",function(f){Restore.next(f);return false});$j("#prev-page").on("click",function(f){Restore.prev(f);return false});$j("#restore-submit-button").on("click",function(f){FileOps.do_folder_restore(d,c);return false});$j("#restore-cancel-button").on("click",function(f){return location.href=a});return $j("#restore-back-button").on("click",function(f){return location.href=a})}};var SelectRoleModal,ShareShmodelSelectRoleModal,SharedFolderSelectRoleModal,ShmodelC2DSelectRoleModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};SelectRoleModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=null;b.prototype.on_show=function(){var c=this;return $j(".role-options li").click(function(f){var d,g;d=$j(f.target).closest("li");g=d.data("role");assert(c.on_select_role,"missing on_select_role implementation");c.on_select_role(g);return c.hide()})};return b})(DBModal);SharedFolderSelectRoleModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(d){var c;c=function(){Sharing.role_picker.ensure_role_is_visible(d);SharingState.set_role(d);return SharingModals.start_wizard_for_user(viewer.get_user_by_role(d))};if(d===Multiaccount.logged_out_role){return MultiaccountLogin.show_modal({role:d,on_success:c})}else{return c()}};return b})(SelectRoleModal);ShmodelC2DSelectRoleModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(d){var c;c=function(){return SharingModel.show_c2d_modal(d)};if(!viewer.is_role_signed_in(d)){return MultiaccountLogin.show_modal({role:d,on_success:c})}else{return c()}};return b})(SelectRoleModal);"This is displayed when someone tries to share a shmodel but is paired and has\nmultiple accounts that they could share from. (This determines who the share\nemail sends from, who the contact gets added to, etc.)";ShareShmodelSelectRoleModal=(function(a){__extends(b,a);function b(){this.on_select_role=__bind(this.on_select_role,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_select_role=function(c){return SharingModel.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,c)};return b})(SelectRoleModal);var TabController;TabController=Class.create({initialize:function(c,b){var a;a=$(c);assert(a,c+" is missing.");this.container=a;this.options={killEvent:true};Object.extend(this.options,b);return this.listen()},listen:function(){var f,c,e,b,d,a;c=this;d=this.container.select("a");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];assert(f.id&&f.id.length>0,"Element is missing an id");a.push(f.observe("click",(function(g){return this.click(g)}).bindAsEventListener(c)))}return a},click:function(a){if(this.options.killEvent){Event.stop(a)}return this.toggle($(a.target))},toggle:function(b){var e,a,d,f,c;c=this.container.down("a.selected");if(c){f=$(c.id+"-content");if(f){f.hide()}}this.container.select(".selected").invoke("removeClassName","selected");a=false;if(!b){b=this.container.down("a");a=true}b.addClassName("selected");e=$(b.id+"-content");if(e){e.show()}if(this.options.onTabChange){this.options.onTabChange(b,c)}if(this.options.url_prefix){d=this.options.url_prefix;if(!a){d+="/"+b.id}return DBHistory.push_state(d)}}});var CustomEmailModal,ResendVerifyEmailModal,VerifyEmailModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};CustomEmailModal=(function(a){__extends(b,a);function b(c,d){this.before_show=__bind(this.before_show,this);b.__super__.constructor.call(this,c,d);this.email=d.email}b.prototype.before_show=function(c){b.__super__.before_show.call(this,c);return c.find(".dbmodal-email-placeholder").text(this.email)};return b})(DBRoleAwareUserModal);VerifyEmailModal=(function(b){__extends(a,b);function a(c,d){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.on_hide=__bind(this.on_hide,this);this.on_show=__bind(this.on_show,this);this.show=__bind(this.show,this);this._send_email=__bind(this._send_email,this);this._email_sent_callback=__bind(this._email_sent_callback,this);this._open_change_email_modal=__bind(this._open_change_email_modal,this);a.__super__.constructor.call(this,c,d);this.email_verification=d.email_verification}a.prototype._open_change_email_modal=function(c){c.preventDefault();this.hide();return ChangeEmail.show(this.user.id)};a.prototype._email_sent_callback=function(d,c){this.hide();return this.email_verification.email_sent(c)};a.prototype._send_email=function(d){var c;d.preventDefault();c=this.$modal_window.find(".verify-email-reason").attr("data-reason");return this.email_verification.send_email(c,this.on_verify)};a.prototype.show=function(c){this.on_verify=c;return a.__super__.show.call(this)};a.prototype.on_show=function(){this.$change_email_link=this.$modal_window.find(".change-email-before-verify");this.$change_email_link.on("click",this._open_change_email_modal);return $j(document).on(EmailVerificationConstants.EMAIL_SENT_EVT,this._email_sent_callback)};a.prototype.on_hide=function(){this.$change_email_link.off("click");return $j(document).off(EmailVerificationConstants.EMAIL_SENT_EVT)};a.prototype.on_confirm_button_click=function(c){return this._send_email(c)};return a})(CustomEmailModal);ResendVerifyEmailModal=(function(b){__extends(a,b);function a(){this.on_cancel_button_click=__bind(this.on_cancel_button_click,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.hide()};a.prototype.on_cancel_button_click=function(c){return this._send_email(c)};return a})(VerifyEmailModal);var FacebookConfirmModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};FacebookConfirmModal=(function(b){__extends(a,b);function a(d,e,c){this.show_hidden_modal=e;this.link_with_facebook=c;this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.on_hide=__bind(this.on_hide,this);a.__super__.constructor.call(this,d,{element_id:"facebook-confirm-modal-user-"+d.id})}a.prototype.on_hide=function(){return typeof this.show_hidden_modal==="function"?this.show_hidden_modal():void 0};a.prototype.on_confirm_button_click=function(c){this.hide();return this.link_with_facebook()};return a})(DBUserModal);var InviteForm;InviteForm={initialized:false,init:function(){var a=this;$j(function(){a.add_auto_completer=new Autocompleter.ContactsTokenizer(viewer.get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(b){return b.excludeTeamMembers().excludeFacebook().excludeGroups().excludeMe()}});return a.add_auto_completer.clearTokens()});this.tokenAdd=$j.proxy(this._tokenAdd,this);this.tokenRemove=$j.proxy(this._tokenRemove,this);$j("#team-invite-new-collab-input")[0].on("token:add",this.tokenAdd);$j("#team-invite-new-collab-input")[0].on("token:remove",this.tokenRemove);this.reset_licenses();this.initialized=true;this.setup_tab_support($j);return SickInput.init()},rebind_modal_submit_autocompleter:function(){var a,b,c=this;a=this.invite_modal.$modal_window;b=a.find(".tokenizer-submit-button");b.on("mousedown",function(){return c.add_auto_completer.beforeSubmit()});return this.setup_tab_support(a)},setup_tab_support:function(a){return a.find("#team-invite-new-collab-input").first().on("keyup change",function(){var b;b=a.find(".new-collab-input").first();if(b.val()!==""){return b.attr("tabindex",-1)}else{return b.removeAttr("tabindex")}})},reset_modal_licenses:function(){this.update_used_licenses(window.active_team_member_table.get_user_count());this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(){this.available_licenses-=1;this.new_users+=1;this.update_license_count();return $j(window).trigger("token:changed")},_tokenRemove:function(){this.available_licenses+=1;this.new_users-=1;this.update_license_count();return $j(window).trigger("token:changed")},update_license_count:function(){var a;a=this.available_licenses<0?_("You need more licenses for this invitation."):this.available_licenses===0?_("You have no remaining licenses."):ungettext("You have %d remaining license.","You have %d remaining licenses.",this.available_licenses).format(this.available_licenses);return $j("#license-count-message").text(a)},init_modal_licenses:function(b,a){if(!this.invite_modal){this.invite_modal=new InviteModal()}this.total_licenses=b;return this.is_trial=a},update_used_licenses:function(a){this.used_licenses=a;return this.reset_licenses()},init_form_licenses:function(c,a,b){this.total_licenses=c;this.used_licenses=a;return this.is_trial=b},on_add_licenses_exit:function(b,a){if(this.invite_modal!=null){this.rebind_modal_submit_autocompleter()}a=a||0;if(a>0){this.total_licenses+=a;this.available_licenses+=a;return this.update_license_count()}},reset_modal:function(){var a;a=this.invite_modal.$modal_window;SuggestionInput.reset(a.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return a.find(".new-collab-input").val("")},on_add_licenses_click:function(b){var c,a;b.preventDefault();if(this.is_trial){if((a=this.invite_modal)!=null){a.hide()}return add_more_licenses_to_trial()}else{c=$j.proxy(this.on_add_licenses_exit,this);DBModalStack.register(AddLicensesModal.LICENSES_ADDED,c);return DBModalStack.push(new AddLicensesModal())}}};var InviteModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};InviteModal=(function(b){__extends(a,b);function a(){a.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.skip_reset=false}a.prototype.on_confirm_button_click=function(c){return Team.add_users(c)};a.prototype.on_show=function(){var c;c=$j("#team-invite-wizard .team-invite-add-licenses");c.on("click",$j.proxy(InviteForm.on_add_licenses_click,InviteForm));if(InviteForm.initialized){InviteForm.update_license_count()}return DBModalStack.register(DBModalStack.CLEAR,function(){return InviteForm.reset_modal()})};return a})(DBModal);var AccountTransferBaseModal,DemoSignupModal,DfeRemoveUserModal,ManageFilesModal,Team,TwoFactorMessageModal,show_manage_files_modal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Team={invite_modal_show:function(){if(!this.invite_modal_already_initialized){InviteForm.invite_modal.show();InviteForm.init();this.invite_modal_already_initialized=true}else{InviteForm.invite_modal.show();InviteForm.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){return InviteForm.update_used_licenses(window.active_team_member_table.get_user_count())}},init_admin:function(){TitleBubble.set_vertical_space(2);return $j("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){var a=this;return $j(".team_name_change_notice .hide_link").click(function(b){return a.hide_team_name_change_banner()})},add_users:function(b){var c,a;Event.stop(b);a=$("team-invite-form");assert(a,"Couldn't find the team invite form.");c=$j(a).find("input[name='emails']");if(c.length===0){Notify.server_error(_("You haven't included anyone to invite! Please invite at least one       person."));return}return Forms.ajax_submit(a,"/account/team/add_users",(function(i){var g,f,e,h,d;InviteForm.reset_modal();InviteForm.invite_modal.hide();h=$j(".team_admin_members_table");e=JSON.parse(i.responseText);window.active_team_member_table.add_users(e);g=(function(){var j;j=[];for(f in e){d=e[f];j.push(d)}return j})();if(g.length===1){return Notify.server_success(_("Invited %(user_email)s.").format({user_email:g[0].email}))}else{if(g.length>1){return Notify.server_success(_("Invited %(user_count)d people.").format({user_count:g.length}))}else{return Notify.server_error(ungettext("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",c.length).format({num_skipped:c.length}))}}}),(function(){return Forms.enable(a.down("input[type='submit']"))}),b.target,{team_id:Constants.team_id},null,null,true)},show_demo_signup_modal:function(c,d,e,b,f){var a,i,h,g;this.webinar_key=c;this.webinar_iso_datetime=d;this.webinar_date=e;this.webinar_title=b;this.tab_url=f;g=_("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});i=new DemoSignupModal({element_id:"demo-signup-modal",title:g});i.show();i.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);i.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);i.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);i.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);h=i.$modal_window.find("input[name=retURL]");h.attr("value",h.val()+"#"+this.tab_url);a=i.$modal_window.find("#demo-signup-form")[0];return a.on("submit",i.on_confirm_button_click)},show_remove_modal:function(d,f,a,b,h,c){var e,g;if($j(".dfe-remove-user-modal").length){e=new DfeRemoveUserModal({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});e.user_name=f||b;e.email=b;e.user_id=a;e.team_id=Constants.team_id;e.invited=h;e.show();return false}if(f){DomUtil.fillVal(f,"remove-user-name");g=_("Remove '%(user_name)s'").format({user_name:f})}else{DomUtil.fillVal(b,"remove-user-name");g=_("Remove '%(user_email)s'").format({user_email:b})}if(!h&&c){$("user-migrated-message").show();$("delete-account").checked=false;$("remove-from-team").checked=true}else{$("user-migrated-message").hide();$("remove-from-team").checked=false;$("delete-account").checked=true}if(!h){return Modal.icon_show("delete_32",g,$("remove-user-modal"),{user_id:a,button:d})}else{return Modal.icon_show("delete_32",g,$("remove-user-modal-simple"),{user_id:a,button:d,disable_if_joined:false})}},remove_user:function(d,g){var c,b,a,f=this;Event.stop(d);b=$j("input[type=submit]","#remove-user-modal");b.attr("disabled",1);a=Modal.vars.user_id;if(g){c=true}else{c=$j("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:Constants.team_id,user_id:a,disable_if_joined:c},onSuccess:function(i){var h,j,e;h=JSON.parse(i.responseText);if((j=window.active_team_member_table)!=null){j.remove_user(Modal.vars.user_id)}if((e=window.removed_team_member_table)!=null){e.add_users(h)}f.decrement_used_licenses();return Notify.server_success(_("User removed."))},cleanUp:function(){Modal.hide();return b.removeAttr("disabled")}})},show_reinvite_modal:function(c,d,a,b){var e;DomUtil.fillVal(b,"reinvite-user-email");DomUtil.fillVal(d,"reinvite-user-team");e=_("Resend invite to '%(email_address)s'").format({email_address:b.em_snippet(18)});return Modal.icon_show("email_32",e,$("reinvite-user-modal"),{user_id:a,button:c})},reinvite_user:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(f){var d,e,c,g;Notify.server_success(_("Invite sent."));if((g=$("team-member-info"))!=null){g.update(f.responseText)}d=window.active_team_member_table;c=d.data.users[a];c.invite_expired=false;e={};e[a]=c;return d.update_user_data(e)},cleanUp:function(){return Modal.hide()}})},show_user_activity_log_modal:function(a,c,d){var b;b=$j("#activity-log-modal");b.find(".activity-log-email").text(c);b.find(".activity-log-name").text(d);b.find("#activity-log-user-message").show();return Modal.show(_("Create activity report"),b[0],{user_id:a})},show_team_activity_log_modal:function(b,c){var a;a=$j("#activity-log-modal");a.find(".activity-log-email").text(b);a.find(".activity-log-name").text(c);a.find("#activity-log-team-message").show();return Modal.show(_("Create activity report"),a[0])},generate_activity_log:function(h){var d,g,f,a,c,b;Event.stop(h);d=$j("#activity-log-modal");g=d.find("input[name='from_date']").val();a=d.find("input[name='to_date']").val();if(g>a){Notify.server_error(_("Your start date is after your end date."));return}f=Constants.team_id;b=Modal.vars.user_id;c=new Date().getTimezoneOffset().toString();return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:g,to_date:a,team_id:f,user_id:b,tzoffset:c},onSuccess:function(e){return Notify.server_success(_("Report started. We'll email you when it's ready."))},cleanUp:function(){return Modal.hide()}})},show_reset_password_modal:function(b,c,a){var d;$j("#reset-password-modal .member-name").text(c);d=_("Reset password for '%(user_name)s'").format({user_name:c});return Modal.show(d,$("reset-password-modal"),{user_id:a,button:b})},reset_password:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(c){return Notify.server_success(_("User's password reset."))},cleanUp:function(){return Modal.hide()}})},show_reset_all_passwords_modal:function(){return Modal.show(_("Reset all passwords"),$("reset-all-passwords-modal"))},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:Constants.team_id},job:Constants.use_async_reset,subject_user:viewer.work_user,progress_text:_("Resetting all passwords..."),onSuccess:function(a){return Notify.server_success(_("All passwords reset."))},cleanUp:function(){return Modal.hide()}})},show_admin_status_modal:function(c,i,k,e,j,f){var b,g,a,d,h;a=j.strip()||e;d=void 0;b=void 0;h=void 0;g=void 0;if(f){d=_("Are you sure you want to make <strong>%(person_name)s</strong> an admin?").format({person_name:a.escapeHTML()});b=_("Make admin");h=_("Make '%(person_name)s' an admin").format({person_name:a.escapeHTML()});g="alert_32"}else{d=_("Are you sure you want to remove admin privileges for <strong>%(person_name)s</strong>?").format({person_name:a.escapeHTML()});b=_("Remove admin status");h=_("Remove admin privileges for '%(person_name)s'").format({person_name:a.escapeHTML()});g="alert_32"}DomUtil.fillVal(e,"admin-status-email");DomUtil.fillVal(d,"admin-status-action");DomUtil.fillVal(b,"admin-status-button-action");return Modal.icon_show(g,h,$("admin-status-modal"),{user_id:k,button:c,admin_on:f})},set_admin_status:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:Constants.team_id,user_id:a,on:(Modal.vars.admin_on?"yes":"no")},onSuccess:function(d){var e,c;e=(Modal.vars.admin_on?_("User's admin status granted."):_("User's admin status removed."));if(window.active_team_member_table){c=JSON.parse(d.responseText);window.active_team_member_table.update_user_data(c);return Notify.server_success(e)}else{if(Modal.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(Modal.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(Modal.vars.user_id)}}},cleanUp:function(){return Modal.hide()}})},show_disable_2fa_modal:function(c,a,b){$j("#disable-2fa-modal .member-name").text(b);return Modal.icon_show("alert_32",_("Disable two-step verification"),$("disable-2fa-modal"),{user_id:a,elm:c})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(b){var a;$j(".tfa_enabled").replaceWith(_("Disabled"));a=JSON.parse(b.responseText);if(window.active_team_member_table){window.active_team_member_table.update_user_data(a)}else{MemberActionsMenu.update_container_users(".buttons",a)}Notify.server_success(_("Two-step verification disabled."));return Modal.hide()}})},show_sso_preview_email:function(a){return Modal.icon_show("email_32",_("Email preview"),$(a))},show_sso_sample_email:function(a){return Modal.icon_show("email_32",_("Sample email"),$(a))},show_user_message_modal:function(c,b,a){var d;DomUtil.fillVal(a,"user-message-email");d=_("Send email to '%(user_name)s'").format({user_name:c});$("user-message").value="";Modal.icon_show("email_32",d,$("user-message-modal"),{user_name:c,user_id:b});return Util.focus.defer("user-message")},send_user_message:function(){var b,a;a=Modal.vars.user_id;b=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:a,team_id:Constants.team_id,message:b},onSuccess:function(){var c;c=Modal.vars.user_name;Notify.server_success(_("Message successfully sent to %(user_name)s.").format({user_name:c}));return Modal.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:Constants.team_id}});$j(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return $j(".pin_notice").hide()},hide_pin_banner_with_user_id:function(a,b){return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:a},onSuccess:function(c){return $j(b).closest("span").removeClass("on").addClass("off")}})},get_pin_with_user_id:function(a,b){return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:a},onSuccess:function(d){var c;c=JSON.parse(d.responseText);$j(b).closest("span").find(".pin-value").text(c.pin+" -");return $j(b).closest("span").removeClass("off").addClass("on")}})},send_team_message:function(b){var a;Event.stop(b);a=$F("team-message").strip();if(a){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:Constants.team_id,message:a},onSuccess:function(c){Notify.server_success(_("Message successfully sent to team."));return Modal.hide()}})}},show_security_message_modal:function(){return new TwoFactorMessageModal().show()},send_team_security_message:function(c){var b,a;Event.stop(c);a=$F("team-security-message").strip();b=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:b.serialize(true),onSuccess:function(d){Notify.server_success(_("Message successfully sent."));return Modal.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(a,b){this.used_licenses=a;return this.total_licenses=b},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(a,b){$("migration-url").value=b;Modal.icon_show("alert_32",_("Migration link for '%(email)s'").format({email:a.em_snippet(18)}),$("migrate-url-modal"));return $("migration-url").select()},toggle_account_view:function(a){switch(a){case"new":$("account_info_new").removeClassName("hidden_elem");$("account_info_existing").addClassName("hidden_elem");break;case"existing":$("account_info_new").addClassName("hidden_elem");$("account_info_existing").removeClassName("hidden_elem")}$("account_info_type").value=a;return false},show_end_session_modal:function(b,a,c){TitleBubble.hide_all();$j("#end-session-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Close web session"),$("end-session-modal"),{login_id:b,user_id:a,elm:c})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:Modal.vars.login_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Web session closed."))}})},unlink_device:function(c,b,a,d){TitleBubble.hide_all();$j(".unlink-device-name").text(b);$j("#unlink-device-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Unlink device?"),$("unlink-device-modal"),{app_id:c,user_id:a,elm:d})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_device",{parameters:{app_id:Modal.vars.app_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},subject_user:viewer.work_user,onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Device unlinked."))}})},unlink_host:function(c,a,b,d){TitleBubble.hide_all();$j(".unlink-host-name").text(a);$j("#unlink-host-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Unlink device?"),$("unlink-host-modal"),{host_id:c,user_id:b,elm:d})},unlink_host_submit:function(){return new Ajax.DBRequest("/computer_edit",{parameters:{unlink:true,host_id:Modal.vars.host_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},subject_user:viewer.work_user,onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Device unlinked."))}})},disable_app:function(b,c,a,d){TitleBubble.hide_all();$j("#disable-app-modal .app-name").text(c);$j("#disable-app-modal .member-name").text($j("#member-name").text());return Modal.show(_("Disable '%(app_name)s'?").format({app_name:c}),$("disable-app-modal"),{app_id:b,user_id:a,elm:d})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:true,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(a){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(a.responseText)}})},remove_closest_row:function(c){var b,a;b=$j(c).closest(".team_admin_table_row");a=$j(b).closest(".team_admin_table");if(a.find(".team_admin_table_row").length===1){a.prev(".team_admin_table_title").remove();return a.remove()}else{return b.remove()}},submit_report_form:function(a){$j(a.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};DemoSignupModal=(function(a){__extends(b,a);function b(){this.on_show=__bind(this.on_show,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(h){var p,m,i,c,k,f,o,n,l,j,g,d=this;h.preventDefault();j=$("demo-signup-form");n=$("1210");f=$j(j).find("input[name='first_name']").val();$j(n).find("input[name='FirstName']").attr("value",f);o=$j(j).find("input[name='last_name']").val();$j(n).find("input[name='LastName']").attr("value",o);k=$j(j).find("input[name='email']").val();$j(n).find("input[name='Email']").attr("value",k);l=$j(j).find("input[name='phone_number']").val();$j(n).find("input[name='Phone']").attr("value",l);p=$j(j).find("input[name='company_name']").val();$j(n).find("input[name='Company']").attr("value",p);i=$j(j).find("select[name='company_size']");m=i.find("option:selected").val();$j(n).find("input[name='Company_size__c']").attr("value",m);c=$(this.$modal_window.find(".confirm-button")[0]);g=function(e){d.$modal_window.hide();return n.submit()};return Forms.ajax_submit(j,false,g,false,c)};b.prototype.on_show=function(c){return SickInput.init()};return b})(DBModal);AccountTransferBaseModal=(function(b){__extends(a,b);function a(c,e,d){this.file_action_selector=e;this.transfer_choice_selector=d;this._clearInput=__bind(this._clearInput,this);this._markInputInvalid=__bind(this._markInputInvalid,this);this._markInputValid=__bind(this._markInputValid,this);this._tokenRemove=__bind(this._tokenRemove,this);this._tokenAdd=__bind(this._tokenAdd,this);this._selectChange=__bind(this._selectChange,this);this._isTransferSelected=__bind(this._isTransferSelected,this);this.handleAjaxFailure=__bind(this.handleAjaxFailure,this);a.__super__.constructor.call(this,c,this.file_action_selector,this.transfer_choice_selector)}a.prototype.on_show=function(){var c=this;if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(viewer.get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:function(d){return d.excludeNonTeam().excludeGroups().excludeByEmail(c.email?[c.email.toLowerCase()]:[])}});this.tokenAdd=$j.proxy(this._tokenAdd,this);this.tokenRemove=$j.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=$j.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};a.prototype.handleAjaxFailure=function(c){if(c.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};a.prototype._isTransferSelected=function(){return $j(this.transfer_choice_selector).prop("checked")};a.prototype._selectChange=function(c){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};a.prototype._tokenAdd=function(c){this.$collab_input.hide();if(c.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};a.prototype._tokenRemove=function(c){this.$collab_input.show();return this._clearInput()};a.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};a.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};a.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return a})(DBModal);TwoFactorMessageModal=(function(b){__extends(a,b);function a(){a.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}a.prototype.on_confirm_button_click=function(c){return Team.send_team_security_message(c)};return a})(DBModal);DfeRemoveUserModal=(function(a){__extends(b,a);function b(c){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.success_callback=__bind(this.success_callback,this);this.on_show=__bind(this.on_show,this);b.__super__.constructor.call(this,c,"input[name=transfer_files]","#transfer_files_on")}b.prototype.on_show=function(c){var d;b.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){d=_("Uninvite %(user_name)s").format({user_name:this.user_name})}else{d=_("Remove %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(d);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();return this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}};b.prototype.success_callback=function(e){var d,f,c;d=JSON.parse(e.responseText);if((f=window.active_team_member_table)!=null){f.remove_user(this.user_id)}if((c=window.removed_team_member_table)!=null){c.add_users(d)}if(this.invited){Notify.server_success(_("User uninvited."))}else{Notify.server_success(_("User removed."))}Team.decrement_used_licenses();return this.hide()};b.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();d=this.$modal_window.find(".dfe-remove-user-modal")[0];c=$(this.$modal_window.find(".confirm-button")[0]);return Forms.ajax_submit(d,false,this.success_callback,this.handleAjaxFailure,c)};return b})(AccountTransferBaseModal);ManageFilesModal=(function(b){__extends(a,b);function a(d,e,c){this.source_user_id=d;this.source_user_name=e;this.options=c;this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);a.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}a.prototype.get_form=function(){return this.$modal_window.find("form")[0]};a.prototype.on_show=function(){var c;a.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);c=_("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(c);return this.get_form().on("submit",this.on_confirm_button_click)};a.prototype.on_confirm_button_click=function(f){var c,d,h,g=this;f.preventDefault();d=this.get_form();c=$(this.$modal_window.find(".confirm-button")[0]);h=function(i){var e;e=JSON.parse(i.responseText);if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(e)}else{MemberActionsMenu.update_container_users(".buttons",e)}if($j("#move-files").prop("checked")){Notify.server_success(_("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{Notify.server_success(_("Permanently deleted files"))}return g.$modal_window.hide()};return Forms.ajax_submit(d,false,h,this.handleAjaxFailure,c)};return a})(AccountTransferBaseModal);show_manage_files_modal=function(a,b){var c;c=new ManageFilesModal(a,b,{element_id:"manage-files-modal",focus:".new-collab-input"});return c.show()};var SnapshotCreateController,SnapshotCreateModal,Snapshots,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Snapshots={SETTINGS_SAVED:"snapshot_settings:saved",AUDIENCE_STRINGS:{"public":_("anyone"),recipients:_("recipients only")},fq_paths_to_name:function(d){var a,e,b,c;if(d.length<6){c=(function(){var h,g,f;f=[];for(h=0,g=d.length;h<g;h++){b=d[h];f.push(b.substring(b.lastIndexOf("/")+1))}return f})();return c.join(", ")}else{e=4;c=(function(){var h,g,f;f=[];for(a=h=0,g=d.length;h<g;a=++h){b=d[a];if(a<e){f.push(b.substring(b.lastIndexOf("/")+1))}}return f})();return _("%(filenames)s and %(count)s others").format({filenames:c.join(", "),count:d.length})}},send_copy:function(a){this.modal=new SnapshotCreateModal({element_id:"send-copy-modal",endpoint_url:"/snapshots/send_copy",title:_("Send a copy ")+" \u2014 "+Snapshots.fq_paths_to_name(a),parameters:this._gen_params(a)});return this.modal.show()},_gen_params:function(b){var a;a={paths:JSON.stringify(b)};a[Constants.UID_PARAM_NAME]=Browse.active_user.id;return a},init_send:function(e,a,d,b){var c;this.snapshot_id=e;this.permission=a;this.expiry=d;this.snapshot_url=b;c=$j("#send-copy-modal").controller();return c.create_controller.init(this.snapshot_id,this.permission,this.expiry,this.snapshot_url)},show_settings:function(a){var c,b;a.preventDefault();b=_("Copy settings");c={snapshot_id:this.snapshot_id};c[Constants.UID_PARAM_NAME]=Browse.active_user.id;DBModalStack.register(Snapshots.SETTINGS_SAVED,function(h,g){var f,d;d=$j("#send-copy-modal");f=d.controller();return f.create_controller.insert_snapshot_settings(g.audience,g.expiry)});return DBModalStack.push(new DBModalLoading({element_id:"snapshot-settings-modal",title:b,endpoint_url:"/snapshots/snapshot_settings",parameters:c}))}};SnapshotCreateModal=(function(b){__extends(a,b);function a(c){a.__super__.constructor.call(this,c);this.fetched=false;this.create_controller=new SnapshotCreateController(this)}a.prototype.on_show=function(){if(!this.fetched){this.fetch();return this.fetched=true}};return a})(DBModalLoading);SnapshotCreateController=(function(){function a(b){this.modal=b}a.prototype.init=function(f,b,d,c){var e,g,h=this;this.snapshot_id=f;this.permission=b;this.expiry=d;this.snapshot_url=c;if(!this.autocomplete){g={tokens:[",",";"],include_fb:true,include_team:true,include_groups:false};this.autocomplete=new Autocompleter.ContactsTokenizer(Browse.active_user,"snapshot-new-collab-input","snapshot-new-whobulk","snapshot-hidden-input",g)}else{this.autocomplete.listen()}$j("#send-copy-button").on("click",function(i){return h._send()});$j("#send-copy-done-button").on("click",function(i){return h.modal.hide()});$j("#send-copy-cancel-button").off("click").on("click",function(i){return h.modal.hide()});$j(".snapshot-show-settings").on("click",function(i){return Snapshots.show_settings(i)});$j("#snapshot-new-collab-input").focus();e=$j("#snapshot-new-collab-input")[0];e.observe("token:add",function(j){var i;if(((i=h.autocomplete)!=null?i.token_manager.tokens.length:void 0)===1){return h._show_send_button()}});return e.observe("token:remove",function(j){var i;if(((i=h.autocomplete)!=null?i.token_manager.tokens.length:void 0)===0){return h._hide_send_button()}})};a.prototype._show_send_button=function(){$j("#send-copy-done-button").hide();$j("#send-copy-button").show();return $j("#send-copy-cancel-button").show()};a.prototype._hide_send_button=function(){$j("#send-copy-button").hide();$j("#send-copy-cancel-button").hide();return $j("#send-copy-done-button").show()};a.prototype._send=function(h){var f,c,d,i,b,g,j=this;f=$j("#shmodal-send-form");assert(f,"Couldn't find the shmodal send form.");Notify.server_success(_("Sending\u2026"));if((g=this.autocomplete)!=null){g.beforeSubmit()}b=this._get_snapshot_send_recipients(f[0]);i=function(e){var k;Snapshots.modal.hide();k=SharingUtil.success_string_for_recipients(b);Notify.server_success(k);return ShmodelLogger.log("shmodal_send")};d=function(e){Snapshots.modal.hide();return Forms.remove_loading()};c={};c[Constants.UID_PARAM_NAME]=Browse.active_user.id;c.perm=this.permission;return Forms.ajax_submit(f[0],"/snapshots/send",i,d,f.find(".tokenizer-submit-button"),c)};a.prototype._get_snapshot_send_recipients=function(d){var e,k,i,l,m,b,g,f,j,c,h;e=d.select('input[name="emails"]');k=d.select('input[name="fb_ids"]');i=d.select('input[name="group_ids"]');b=[];h=[e,k,i];for(g=0,j=h.length;g<j;g++){m=h[g];for(f=0,c=m.length;f<c;f++){l=m[f];b.push($j(l).parent().text().strip())}}return b};a.prototype.insert_snapshot_settings=function(b,c){return $j("#audience-link").text(Snapshots.AUDIENCE_STRINGS[b])};return a})();var NOTCLIENTS,NOTCLIENT_DEBUG,add_notclient,new_notclient,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1},__slice=[].slice;NOTCLIENTS={};NOTCLIENT_DEBUG=false;add_notclient=function(a,c,b){new_notclient(a);return setTimeout((function(){return NOTCLIENTS[a].init(c,b)}),2000)};new_notclient=function(s){var G,I,j,l,i,t,q,B,c,n,a,e,m,L,d,M,g,x,r,f,z,k,p,H,w,N,F,o,E,b,y,D,h,u,K,C,v,J,A;assert(__indexOf.call(NOTCLIENTS,s)<0,"cannot create more than one notclient per user");r=function(O){return $u.isNumber(O)&&O%1===0&&O>0};x=function(O){return $u.isNumber(O)&&O%1===0&&O>=0};assert(r(s),"user_id must be a positive integer");f=function(){var O;O=1<=arguments.length?__slice.call(arguments,0):[];if(NOTCLIENT_DEBUG){return console.log.apply(console,O)}};G=90000;l=8096;t="user";i="list";d=false;I=1000;j=5*60*1000;N=0;u=function(){var O;if(e===0){O=0}else{O=Math.min(I*Math.pow(2,e-1),j)}return Math.max(O,N)};H=null;F={};L={};p=1;M=false;g=false;J=null;B=false;C=[];h=null;a=null;z=null;k={};o=false;e=0;K=0;v=function(S,Q){var P,O,R;R=[];for(P in Q){O=Q[P];P=parseInt(P,10);assert(r(P),"ns_ids must be positive integers: "+P);assert(x(O),"sjids must be nonnegative integers: "+O);if(S[P]!=null){R.push(S[P]=Math.min(S[P],O))}else{R.push(S[P]=O)}}return R};c=function(){var Q,P,R,O;assert((H!=null)&&!$u.isEmpty(F),"expected nid and ns_map");R={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};Q=$u.pluck($u.values(L),"type");if(__indexOf.call(Q,t)>=0){R.user_id=s;R.nid=H!=null?H.replace(/^0+(.)/,"$1"):void 0}if(__indexOf.call(Q,i)>=0){R.ns_map=((function(){var S;S=[];for(P in F){O=F[P];S.push(""+P+"_"+O)}return S})()).join(",")}if(URI.parse(Constants.SUBSCRIBE_URL).updateQuery(R).toString().length>l){delete R.ns_map}return R};n=function(){var O;if(!d){return}O=u();if(O>0){return a=window.setTimeout(A,O)}else{return A()}};A=function(){var O;assert(!M&&!g,"connect: invalid state");assert(H>=0||!$u.isEmpty(F),"notclient: called connect with nothing to subscribe to");f("###########################");O=c();if(!(O.nid!=null)&&!O.ns_map){f("nothing to subscribe to. skipping notserver connection.");return}f("connecting to notserver...");M=true;K+=1;return J=$j.ajax(Constants.SUBSCRIBE_URL,{data:O,dataType:"json",noDropboxDefaults:true,error:function(){if(B){B=false;return}e+=1;f("error connecting to notserver. bad rounds="+e+".");M=false;return n()},success:function(P){f("notserver connection closed. response:",P);M=false;if(P.chillout!=null){N=parseInt(P.chillout,10)*1000;f("notserver told us to chill for "+N+"ms")}else{if(N>0){f("setting notserver chillout back to 0ms");N=0}}if(P.ret==="punt"){return n()}else{assert(P.ret==="new","unknown notserver ret: "+P.ret);assert("refresh" in P,"expected notserver ret:new to have refresh keyword");return D(P.refresh)}}})};q=function(){if(J!=null){B=true;J.abort();return J=null}};E=function(){N=0;M=false;g=false;q();C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return n()};y=function(){var O;d=false;N=0;H=null;F={};L={};O=0;p=1;M=false;g=false;J=null;B=false;C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return K=0};D=function(U){var X,S,O,P,V,Q,W,R;assert(!g&&!M,"run_handlers: invalid state");assert(z===null,"run_handlers: new_nid must start at null");assert($u.isEqual(k,{}),"run_handlers: new_ns_map must start at {}");assert(!o,"expected one_or_more_handler_failures=false");g=true;f("running handlers...");P=$u.filter($u.values(L),function(Z){var Y;return Y=Z.type,__indexOf.call(U,Y)>=0});assert(!$u.isEmpty(P),"notserver sent a ping for unsubscribed activity");C=$u.pluck(P,"handler_id");for(Q=0,W=P.length;Q<W;Q++){R=P[Q],X=R.handler,S=R.handler_id,O=R.name,V=R.type;f("running id="+S+", name="+O+", type="+V);X()}if($u.isEmpty(C)){return f("all handlers already finished running. no need for a slacker timeout.")}else{f("all handlers running. slacker timeout set.");return h=window.setTimeout(b,G)}};b=function(){var Q,R,P,O;assert(g&&!M,"called report_slackers in an invalid state.");assert(!$u.isEmpty(C,"report_slackers called w/ nothing slackin'"));f("found some slackers");o=true;O=[];for(R=0,P=C.length;R<P;R++){Q=C[R];O.push(m(Q))}return O};m=function(O){if(__indexOf.call(C,O)<0){return}f("done handling: "+O);C=$u.without(C,O);if($u.isEmpty(C)){f("all handlers are done running.");g=false;window.clearTimeout(h);if(z!=null){f("new nid: "+z);H=z}if(!$u.isEmpty(k)){f("new ns_map:",k);F=k}if(o){e+=1;f("one or more handler errors. bad_rounds="+e)}else{e=0}z=null;k={};o=false;return n()}};w={get_user_id:function(){return s},get_nid:function(){return H},get_ns_map:function(){return $u.clone(F)},get_consecutive_bad_rounds:function(){return e},get_total_rounds:function(){return K},get_notserver_chillout_ms:function(){return N},get_sleep_ms:u,subscribe_user:function(W){var P,Q,V,U,S,O,R;assert(!g,"adding new handlers from inside handlers is not currently supported");R=["name","handler"];for(S=0,O=R.length;S<O;S++){U=R[S];assert(W[U],"subscribe_user requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding user handler "+W.name);Q=$u.pluck($u.values(L),"type");V=__indexOf.call(Q,t)<0;P=p++;L[P]={handler_id:P,handler:W.handler,name:W.name,type:t};if(V){f("first user handler added, reconnecting");E()}return P},subscribe_sfj:function(W){var P,Q,V,U,S,O,R;assert(!g,"adding new handlers from inside handlers is not currently supported");R=["name","handler"];for(S=0,O=R.length;S<O;S++){U=R[S];assert(W[U],"subscribe_sfj requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding sfj handler "+W.name);Q=$u.pluck($u.values(L),"type");V=__indexOf.call(Q,i)<0;P=p++;L[P]={handler_id:P,handler:W.handler,name:W.name,type:i};if(V){f("first sfj handler added, reconnecting");E()}return P},handler_success:function(O,Q){var P;if(__indexOf.call(C,O)<0){return}P=L[O].type;if(P===i){assert("ns_map" in Q,"ns_map required param is missing");assert(!("nid" in Q),"nid is disallowed from SFJ handlers");v(k,Q.ns_map)}else{assert(P===t,"unknown handler type: "+P);assert("nid" in Q,"nid required param is missing");assert(!("ns_map" in Q),"ns_map is disallowed from user handlers");if(!(z!=null)||Q.nid<z){z=Q.nid}}return m(O)},handler_failure:function(O){f("handler failed. handler_id="+O);if(__indexOf.call(C,O)<0){return}o=true;return m(O)},handle_visibility_change:function(){if(window.document.hidden){return q()}else{return E()}},init:function(P,O){assert(!d,"error: init() has been called twice.");H=P;v(F,O);d=true;if(window.document.visibilityState!=null){window.document.on("visibilitychange",this.handle_visibility_change);if(!window.document.hidden){return n()}}else{return n()}},reset:y,abort:q,reconnect:E};NOTCLIENTS[s]=w;return w};var UpdateEvents;UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var FileTypes;FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5};var BrowseUtil;BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(b){var a;a=Object.clone(b);if(a.is_dir){a.ago="";a.ts=0}else{a.target_ns=false}a.sort_key=Util.decode_sort_key(a.sort_key);return new BrowseFile(a)},filepreview_from_selected:function(d,c){var e,b,k,l,m,h,g,a,f,n,j;if(c&&(c.bytes<0||c.preview_type==="download")){window.open(c.href,"_blank");return}a=DBHistory.get_url();l=a.indexOf("/lightbox")===0;b=a.indexOf("/view")===0;if(d==="callback"&&((l&&Lightbox.shown)||(b&&FileViewer.shown))){return}else{if(d==="callback"&&b&&!c){FileViewer.show();return}else{if(d==="fileclick"&&c&&((j=c.preview_type)!=="photo"&&j!=="video")){FileViewer.show(c);return}}}if(!c){h=BrowseSelection.get_selected_files();c=h&&h.first()}m=this.browsefile_to_filepreview(Browse.files);if(m.length){g=0;if(c){for(k=f=0,n=m.length;f<n;k=++f){e=m[k];if(e.fq_path===c.fq_path){g=k;break}}}return Lightbox.init(m,{start_index:g,include_delete:true,keep_url:false})}},browsefile_to_filepreview:function(e){var h,c,a,d,g,b;a=[];for(g=0,b=e.length;g<b;g++){h=e[g];if(h.bytes<0||h.dir){continue}if(h.preview_type==="photo"&&h.large_thumbnail_url_tmpl){c=new PhotoPreview({filename:h.filename,fq_path:h.fq_path,thumbnail_url_tmpl:h.large_thumbnail_url_tmpl,dl_url:URI.parse(h.href).updateQuery({dl:1}).toString(),original_url:h.href,ns_id:h.ns_id,ns_path:h.ns_path});a.push(c)}else{if(h.preview_type==="video"&&h.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){d=new VideoPreview({filename:h.filename,fq_path:h.fq_path,thumbnail_url_tmpl:h.large_thumbnail_url_tmpl,preview_url:h.video_transcode_url(),dl_url:URI.parse(h.href).updateQuery({dl:1}).toString(),ns_id:h.ns_id,ns_path:h.ns_path});a.push(d)}}}return a},profile_files:function(b){var c,d,e,a;d={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(e=0,a=b.length;e<a;e++){c=b[e];if(c.dir){d.folders+=1}else{d.files+=1}if(c.is_sandbox()){d.sandboxes+=1}if(c.is_share()){d.shared_folders+=1}if(c.bytes===-1){d.deleted+=1}if(c.target_ns){d.target_namespaces+=1}if(c.fq_path.toLowerCase()==="/public"&&Browse.public_folder_enabled){d.public_folder=1}if(c.root_coll_item_counter>=0){d.in_root_coll+=1}}return d},profile_summary:function(b){var c,a;c=ungettext("%d file","%d files",b.files).format(b.files);a=ungettext("%d folder","%d folders",b.folders).format(b.folders);if(b.files&&b.folders){return _("%(x_files)s and %(y_folders)s").format({x_files:c,y_folders:a})}else{if(b.files){return c}else{if(b.folders){return a}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var d,c,a,b;b=this.SPECIAL_MODES;for(c=0,a=b.length;c<a;c++){d=b[c];$("browse").removeClassName(d);$("browse-root-actions").removeClassName(d);$("browse-sort").removeClassName(d)}$("browse-sort").removeClassName("cathywu");return $("browse-root-actions").removeClassName("cathywu")},set_special_mode:function(b){var e,d,a,c;assert(this.SPECIAL_MODES.indexOf(b)!==-1,"unknown mode");if($("browse").hasClassName(b)){assert($("browse-root-actions").hasClassName(b),"inconsistent modes");assert($("browse-sort").hasClassName(b),"inconsistent modes");return}c=this.SPECIAL_MODES;for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){$("browse").removeClassName(e);$("browse-root-actions").removeClassName(e);$("browse-sort").removeClassName(e)}}$("browse").addClassName(b);$("browse-root-actions").addClassName(b);$("browse-sort").addClassName(b);if(b===this.SEARCH_MODE){$("browse-sort").addClassName("cathywu");return $("browse-root-actions").addClassName("cathywu")}},get_mode:function(){var e,a,d,b,c;a=this.BROWSE_MODE;c=this.SPECIAL_MODES;for(d=0,b=c.length;d<b;d++){e=c[d];if($("browse").hasClassName(e)){a=e}}return a},load_visible_thumbs:function(){var m,p,d,l,q,r,n,c,h,b,g,f,o,a,k,e;c=this.get_files_in_view();p=c[1]-c[0];n=[Math.max(c[0]-p,0),c[0]];r=[Math.min(c[1],Browse.files.length),Math.min(c[1]+p,Browse.files.length)];m=[];k=[c,r,n];for(g=0,o=k.length;g<o;g++){q=k[g];l=q[0],h=q[1];e=Browse.files.slice(l,h+1||9000000000);for(f=0,a=e.length;f<a;f++){d=e[f];m.push(d.get_div().down("img"))}}b=function(i){if(!i.src.endsWith(Sprite.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return BatchThumbLoader.batch_load_thumbs(m,this.THUMBS_BATCH_SIZE,b)},get_files_in_view:function(){var c,d,b,a,f,e;f=Util.viewport_dimensions().height;e=Util.scroll_offsets().top;c=this._get_top_file_y_offset();d=this._get_elm_height();if(!c||!d){return[0,Browse.files.length]}b=Math.floor((e-c)/d);b=Math.max(b,0);a=b+Math.ceil(f/d);a=Math.min(a,Browse.files.length);return[b,a]},_get_top_file_y_offset:function(){if(Browse.files.length===0){return null}return Browse.files[0].get_div().cumulativeOffset().top},_get_elm_height:function(){var a;if(Browse.files.length<3){return null}a=Browse.files[1].get_div();return a.getLayout().get("margin-box-height")}};var Sort;Sort=(function(){var g,a,d,f,e,c,b;d=function(i){var h;h=i?1:-1;return function(j,k){return h*Util.sort_by_rank_or_key(j,k)}};f=function(i){var h;h=i?1:-1;return function(j,k){if(j.bytes>k.bytes){return h}else{if(j.bytes<k.bytes){return -h}else{return h*Sort.FILES_BY_NAME(j,k)}}}};g=function(i){var h;h=i?1:-1;return function(j,k){return h*(j.fq_path.toLowerCase()>k.fq_path.toLowerCase()?1:-1)}};a=function(i){var h;h=i?1:-1;return function(k,l){var j;j=k.ts===l.ts?0:k.ts>l.ts?1:-1;return h*j}};c=function(h){return function(k){var j,i;i=h(k);j=d(true);return function(l,m){if(l.dir^m.dir){return(l.dir?1:0)-(m.dir?1:0)}else{return i(l,m)||j(l,m)}}}};e=function(h){return function(k){var i,j;if(!Sort.FOLDERS_FIRST){return h(k)}j=h(k);i=k?1:-1;return function(m,n){var l;if(m.dir^n.dir){l=(m.dir?0:1)-(n.dir?0:1);return i*l}else{return j(m,n)}}}};b=function(h){return function(k){var i,j;j=Sort.FILES_BY_NAME(k);i=k?1:-1;return function(m,n){var l;if(m.is_deleted^n.is_deleted){return(m.is_deleted?1:0)-(n.is_deleted?1:0)}l=0;if(h){if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}}}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}else{if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}}}return(i*l)||j(m,n)}}};return{FILES_BY_NAME:e(d),FILES_BY_SIZE:c(f),FILES_BY_LOCATION:c(g),FILES_BY_KIND:c(b(true)),FILES_BY_EXTENSION:c(b(false)),FILES_BY_MODIFIED:c(a),FOLDERS_FIRST:!Util.is_mac(),ALL_BY_MODIFIED:a}})();var FlexColumn;FlexColumn=(function(){var i,c,l,g,d,h,b,a,k,e,j,f;i=[["FILES_BY_KIND",Sort.FILES_BY_KIND,_("Kind"),true],["FILES_BY_EXTENSION",Sort.FILES_BY_EXTENSION,_("Extension"),true],["FILES_BY_SIZE",Sort.FILES_BY_SIZE,_("Size"),false]];c={};l={};d=[];g=[];for(e=0,j=i.length;e<j;e++){f=i[e],k=f[0],b=f[1],h=f[2],a=f[3];d.push(b);c[k]=h;l[k]=a;g.push(k)}return{SORT_FUNCTIONS:d,DISPLAY:c,IS_ASC:l,LABELS:g}})();var FileSearch;FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,init:function(j){var b,l,i,c,g,f,m,a,h,e,d,k=this;this.fulltext_search_enabled=j;i=$("browse-search");l=$("browse-search-input");if(this.fulltext_search_enabled){l.observe("keypress",function(n){if(n.keyCode===Event.KEY_RETURN){k.search();return false}})}else{SickInput.add_interval_handler(i,this.search_with_delay.bind(this))}$("advanced-search-box").observe("submit",function(n){k.search();return Event.stop(n)});$("exit-search-xclose").observe("click",function(){return k.exit_search()});key("/",Browse.KEY_SCOPE,function(){if(BrowseJump.is_active()){return}if(!i.hasClassName("focused")){l.focus();return false}});key("escape",Browse.KEY_SCOPE,function(){if(Browse.in_search_mode()){k.exit_search();return false}if(l.getValue().strip()===""){l.blur();return false}});key("tab",Browse.KEY_SCOPE,function(n){if(document.activeElement===l){n.preventDefault();l.blur();if(Browse.files.length){BrowseSelection.set_selected_files(Browse.files[0])}else{if(Browse.in_search_mode()){k.toggle_advanced()}}return false}});c="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",c,this.toggle_advanced.bind(this));document.observe(FileEvents.RENAME,function(){return k.clear_cache()});h=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE];for(g=0,m=h.length;g<m;g++){b=h[g];document.observe(b,function(n){if(!Browse.inside_dir){return k.force_reload()}})}e=[UpdateEvents.ADD,UpdateEvents.MOVE,UpdateEvents.REMOVE];d=[];for(f=0,a=e.length;f<a;f++){b=e[f];d.push(document.observe(b,function(n){return k._update_number_results(Browse.files.length)}))}return d},get_state:function(){var c,f,b,e,a,d;f={is_advanced:!$("browse-search").visible()};if(f.is_advanced){d=["all_terms","any_terms","excluded_terms","exact"];for(e=0,a=d.length;e<a;e++){c=d[e];b=$(c).getValue();if(b){f[c]=b}}f.include_files=$("include_files").checked;f.include_folders=$("include_folders").checked;f.include_deleted=!Constants.can_see_trash&&$("include_deleted").checked}else{f.query_unnormalized=this.get_basic_query();f.query=f.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ")}return f},set_state:function(e){var b,d,a,c;if(e.is_advanced){c=["all_terms","any_terms","excluded_terms","exact"];for(d=0,a=c.length;d<a;d++){b=c[d];if(e[b]){$(b).setValue(e[b])}}$("include_files").checked=e.include_files;$("include_folders").checked=e.include_folders;if(!Constants.can_see_trash){$("include_deleted").checked=e.include_deleted}this.show_advanced();return this.search()}else{this.set_basic_query(e.query_unnormalized);this.show_basic();return this.search()}},state_changed:function(){var b,a;b=this.get_state();a=this.last_state;if(a===false){return !!b.query}return(b.is_advanced!==a.is_advanced)||(b.query!==a.query)},get_basic_query:function(){var a;a=$("browse-search-input");return a.getValue()},set_basic_query:function(a){if(a===this.get_basic_query()){return}$("browse-search-input").setValue(a);$("browse-search").show();return $("advanced-search-link").__date(_("Advanced search"))},set_title:function(){var a,b;a=this.get_state();b=_("Search - Dropbox");if(a.query_unnormalized){b=""+a.query_unnormalized+" - "+b}return document.title=b},_pending_search_q:"",search_with_delay:function(){var b,a;a=this.get_state();if(a.is_advanced){return}b=a.query;if(b.length===0&&Browse.in_search_mode()){this.search();return}if(b.length<=this.SHORT_PREFIX_LEN){if(b!==this._pending_search_q){this._pending_search_q=b;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(this.search.bind(this),this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return this.search()}}},search:function(){var b,a;a=this.get_state();b=""===this.get_basic_query();if(!a.is_advanced&&b){if(Browse.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=a;this._clear_on_reload=true;if(!Browse.in_search_mode()){BrowseSelection.deselect_all();Browse.clear();BrowseUtil.set_special_mode("search");if(Browse.inside_dir){this.last_fq_path=Browse.containing_fq_path()}else{this.last_fq_path=""}DBHistory.push_state("/search")}this._prune_cache();this.set_title();if(a.is_advanced){this.ask_server_advanced()}else{if(this.fulltext_search_enabled){this.ask_server()}else{if(a.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server()}}}}return T("search")},_prune_cache:function(){var c,d,f,e,b,a;c=new Date();d=[];for(f in this._cache_ts){if(c-this._cache_ts[f]>this.CACHE_TIME){d.push(f)}}a=[];for(e=0,b=d.length;e<b;e++){f=d[e];delete this._cache[f];a.push(delete this._cache_ts[f])}return a},show_empty:function(){return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},exit_search:function(){var b,d,a,c;c=$$("#advanced-search-box .sick-input input");for(d=0,a=c.length;d<a;d++){b=c[d];b.setValue("");b.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();Browse.first_load=true;return Browse.reload_fqpath(this.last_fq_path,true)},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},ask_server:function(){var b,a,c=this;b=this.get_state();assert(!b.is_advanced,"expected to be in basic search mode");$("web-search-results").__date(_("Searching..."));$("browse").addClassName("pending-search");a="/ajax_search";return new Ajax.DBRequest(a,{no_watch:true,evalJSON:false,parameters:{query:b.query},log_timing:true,onSuccess:function(d){var e;if(!Browse.in_search_mode()){return}e=JSON.parse(d.responseText);c._cache[b.query]=e;c._cache_ts[b.query]=new Date();if(!c.last_state.is_advanced&&(c.last_state.query===b.query)){return c.update_results()}},cleanUp:function(){return $("browse").removeClassName("pending-search")},subject_user:Browse.active_user})},ask_server_advanced:function(){var a,b=this;a=this.get_state();assert(a.is_advanced,"expected to be in advanced search mode");assert(!a.query,"expected advanced search params only");delete a.is_advanced;$("web-search-results").__date(_("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:a,log_timing:true,onSuccess:function(c){if(!Browse.in_search_mode()){return}b.advanced_results=JSON.parse(c.responseText);return b.update_results()},cleanUp:function(c){return $("browse").removeClassName("pending-search")},subject_user:Browse.active_user})},attempt_cache_filter:function(){var a,d,b,h,c,g,f,e;g=this.get_state().query;h=this._query_to_regex(g);b=function(i){return h.match(Util.filename(i.ns_path).toLowerCase())};if(g.length<=1){return false}for(c=f=e=g.length-1;e<=1?f<=1:f>=1;c=e<=1?++f:--f){d=g.substr(0,c).strip();if(d in this._cache){if(this._cache[d].file_info.length<this.MAX_RESULTS){a=Object.clone(this._cache[d]);a.file_info=a.file_info.findAll(b);this.update_results(a);return true}else{return false}}}return false},_query_to_regex:function(a){return new RegExp(RegExp.escape(a).split(new RegExp(" +")).join(".*"))},update_results:function(a){var d,c,b;Browse.reset_state();Browse.reset_sort();b=this.get_state();if(!a&&b.is_advanced){a=this.advanced_results}if(!a){c="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";assert(this.last_state&&!this.last_state.is_advanced,c);assert(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(a=this._cache[this.last_state.query]))}Browse.update(a);Browse.set_selection_from_fq_paths_or_index(FileSearch);this._update_number_results(a.file_info.length);d=b.is_advanced?_("Basic search"):_("Advanced search");$("advanced-search-link").__date(d);if(Browse.files.length){return this.hide_empty()}else{return this.show_empty()}},_update_number_results:function(b){var d,a,c;c=b===0?_("No results"):(d=ungettext("Search - %s result","Search - %s results",b),a=b+(b>=this.MAX_RESULTS?"+":""),d=d.format(a));return $("web-search-results").__date(c)},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(_("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(a){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(_("Advanced search"));$("browse-search").show();if(!a){return $("browse-search-input").focus()}},toggle_advanced:function(){var a,b;b=$("advanced-search-link");b.toggleClassName("selected");if(b.hasClassName("selected")){$("all_terms").setValue(this.get_basic_query());return this.show_advanced()}else{a=$("all_terms").getValue();if(a){this.set_basic_query(a);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(){var a;if(!this.last_state){BrowseURL.set_path_url(Constants.root_ns,"");return}if(this.state_changed()){this.set_state(this.last_state)}key.setScope(Browse.KEY_SCOPE);if(BrowseSelection.get_selected_files().length){a=BrowseSelection.get_selected_files()[0].get_div();return Browse.scrollToWithPadding(a,a.getHeight()*2)}},clear_searchbox:function(){return $("browse-search-input").setValue("")}};var BrowseKeys;BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var c,a,b,d=this;b=this.advanced_dict;for(a in b){c=b[a];key(c.key,Browse.KEY_SCOPE,c.onPress)}this.customize_chart();if(Util.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",function(f){if(f.charCode===63&&!Util.focus_in_input()){return d.advanced_dict.help.onPress()}})}},customize_chart:function(){var d,b,c,a;d=(Util.is_mac()?".key-windows":".key-macos");c=0;b=void 0;a=[];while(true){b=$("keys-chart").down(d,c++);if(!b){break}a.push(b.hide())}return a},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var a,b;a=$("keys-chart");a.style.position="fixed";b=$("browse-sort");if(b.getStyle("display")==="none"){b=$("browse-root-actions")}$j(a).clonePosition($j(b),{setHeight:false});a.style.top=b.cumulativeOffset()[1]+b.getHeight()+"px";a.setOpacity(0.9);return a.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:_("Rename selected files"),key:"f2",onPress:function(b,c){var a;a=BrowseSelection.get_selected_files();if(a.length){return a.first().edit()}}},"delete":{title:_("Delete selected files"),key:"delete, command+backspace, backspace",onPress:function(d,f){var a,c,b;Event.stop(d);b=BrowseSelection.get_selected_files();if(b.length===1){a=b.first();if(a.is_deleted){return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_delete(Browse.active_user,a.fq_path,a.dir)}}else{if(b.length>1){c=BrowseUtil.profile_files(b);if(c.deleted===b.length){return FileOps.show_bulk_purge(b)}else{if(c.deleted===0){return FileOps.show_bulk_delete(Browse.active_user,b)}}}}}},help:{title:_("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return BrowseKeys.toggle_chart()}},close_help:{title:_("Hide keyboard shorcuts"),key:"escape",onPress:function(){return BrowseKeys.hide_chart()}},up_dir:{title:_("Up a folder"),key:"left",onPress:function(){var a,b;Browse.keyboard_nav=true;if(!Browse.reloading){if(Browse.inside_dir){if(!Browse.containing_ns_path()&&Browse.containing_ns_id()!==Constants.root_ns){b=Constants.root_ns;a=Util.normalize(Util.parentDir(Browse.containing_fq_path()))}else{b=Browse.containing_ns_id();a=Util.normalize(Util.parentDir(Browse.containing_ns_path()))}if(Browse.containing_ns_path()!==a||Browse.containing_ns_id()!==b){Browse.select_fq_paths=[Browse.containing_fq_path()];return BrowseURL.set_path_url(b,a)}else{return BrowseSelection.flicker_selected()}}else{return BrowseSelection.flicker_selected()}}}},open_file:{title:_("Open highlighted file"),key:"enter",onPress:function(){var a,b;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];Browse.open_file(a,false)}return false}},open_dir:{title:_("Open highlighted folder"),key:"right",onPress:function(){var a,b;Browse.keyboard_nav=true;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];if(a.dir){Browse.select_index=0;Browse.open_folder(a)}else{BrowseSelection.flicker_selected()}}return false}},undo:{title:_("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){UndoAction.perform_undo();return false}}}};var BrowseURL;BrowseURL={_DEFAULTS:{d:false,select:false},_get_helper:function(a){var b;b=DBHistory.deconstruct_url().qargs;if(a in b){return !!b[a]}else{assert(a in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[a]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(a,c){var b;if(a!==Constants.root_ns&&(!(a in Browse.ns_id_to_mount_point))){a=Constants.root_ns}if(a===Constants.root_ns){return c}else{b=Browse.ns_id_to_mount_point[a];return b+c}},_make_url:function(a,h,g){var f,e,b,d,c;if(g==null){g={}}if(!a){a=Browse.active_user.root_ns}assert(typeof a==="number","expected ns_id as a number");assert(typeof h==="string","expected explicit ns_path string");f=this.ns_to_fq_path(a,h);d=URI({path:Util.get_browse_root(Browse.active_user)+f});b=DBHistory.deconstruct_url().qargs;for(e in g){c=g[e];if(e in this._DEFAULTS&&!!c!==this._DEFAULTS[e]){b[e]=c}}for(e in b){if(!(e in this._DEFAULTS)){delete b[e]}}return DBHistory.construct_url(String(d),b)},set_path_url:function(a,f,d){var e,c,b;if(!a){a=Browse.active_user.root_ns}else{c=parseInt(a,10);a=!isNaN(c)?c:Constants.root_ns}f=Util.normalize(f);b=d!=null?this._make_url(a,f,{d:d?1:0}):this._make_url(a,f);e=DBHistory.deconstruct_url(b);return DBHistory.push_state(e.path,e.qargs)},set_del_url:function(a){var c,d,b;b=DBHistory.deconstruct_url();c=b.path;d=b.qargs;if(a){d.d="1"}else{delete d.d}return DBHistory.push_state(c,d)},_first_load:true,_last_path:null,_last_qargs:null,history_change_handler:function(h,g){var f,a,b,i,d,c,e;key.setScope(Browse.KEY_SCOPE);h=Util.normalize(h);d=g.ns;i=this._last_path;b=(e=this._last_qargs)!=null?e.ns:void 0;c=false;if(!this._first_load){c=(!Browse.inside_dir)||(h!==i)||(d!==b)}f=false;if((g.d==="1")!==(Browse.deleted_shown===true)){f=true;Browse.deleted_shown=g.d==="1"}if(this._first_load||c||f){Browse.reload(d,h,true)}FileSearch.show_basic(true);this._first_load=false;this._last_path=h;this._last_qargs=g;if(BrowseSelection.get_selected_files().length){a=BrowseSelection.get_selected_files()[0].get_div();if(a){Browse.scrollToWithPadding(a,a.getHeight()*2)}}if(FileViewer.shown){return FileViewer.hide()}},parse_b2_hash:function(e){var c,b,d,a,f;a=e.split(":");if(a.length!==4){return false}d=a[0];c=a[2]==="1";b=a[3];f=!b||Util.isNumber(b);if(!f){return false}b=parseInt(b,10)||Constants.root_ns;return{ns_id:b,ns_path:d,deleted:c}}};var BrowseFile;BrowseFile=Class.create({initialize:function(b){var c,e,a;c=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;a=Util.filename(b.fq_path);this.icon=b.icon;this.filename=a;this.caption=a.em_snippet(c);this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.fq_path=b.fq_path;this.hash=b.hash;this.href=b.href;this.size=b.size!=="None"?b.size:"";this.bytes=b.bytes;this.is_deleted=this.bytes===-1;this.ago=b.ago;if(Browse.use_local_cache&&b.ts){if(this.is_deleted){this.ago=null}else{e=DateUtil.fromSecondsSinceEpochUTC(b.ts);this.ago=DateUtil.contextualFormat(e)}}this.ts=b.ts;this.dir=b.is_dir?1:0;this.tkey=b.tkey;this.target_ns=b.target_ns;this.sort_rank=b.sort_rank||0;this.sort_key=b.sort_key||[""];this.sjid=b.sjid;this.thumbnail_url_tmpl=b.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=b.large_thumbnail_url_tmpl;this.type=b.type;this.preview_type=b.preview_type;if(b.last_modified_fname){this.last_modified_fname=b.last_modified_fname.em_snippet(LAST_MODIFIED_FNAME_SNIPPET)}this.code_class=b.code_class;this.htmlified_link=b.htmlified_link;this.doc_preview_status=b.doc_preview_status;this.root_coll_item_counter=b.root_coll_item_counter;this.user_id=b.user_id;this.fulltext_search=b.fulltext_search;this.read_only=b.read_only?true:false;if(!(this.to_key() in BrowseFile._file_index)){Browse.add_file(this);return BrowseFile._file_index[this.to_key()]=this}},is_share:function(){return this.type===FileTypes.SHARED_FOLDER},is_sandbox:function(){return this.type===FileTypes.SANDBOX},video_transcode_url:function(){assert(this.fq_path,"video_transcode_url: expected a non-root fq_path");return URI({scheme:"https",authority:Constants.LIVE_TRANSCODE_SERVER,path:"/transcode_video/w/"+(this.hash+this.fq_path)}).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user.id).toString()},get_div:function(){return $("f_"+(this.to_key()))},rename:function(f,h,d,e,g,i){var b,j,a,c;b=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;a=this.fq_path;Browse.pre_action_selection=[a];j=Browse.find_file(f);if(j){Browse.remove_file(j)}this.filename=Util.filename(f);this.caption=this.filename.em_snippet(b);this.fq_path=f;this.ns_path=h;this.htmlified_link=i;this.hash=d;this.sort_key=e;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){c=this.href.split("/");c[c.length-1]=Util.urlquote(this.filename)+("?w="+d);this.href=c.join("/");this.icon=g}else{this.href="/home"+Util.urlquote(f);if(this.target_ns){Browse.ns_id_to_mount_point[this.target_ns]=f}}BrowseFile._file_index[this.to_key()]=this;Browse.update_file_pos(this);return document.fire(FileEvents.RENAME,{old_fq_path:a,file:this})},edit:function(){var c,a,b,d,e=this;this.editing=true;Browse.selectable();d=function(m){var g,f,j,o,l,i,p,n,k,h;h=m.responseText.evalJSON(true);assert(h.new_browse_files.length===1,"No new file data returned.");j=h.new_browse_files.first();o=j.fq_path;l=j.hash;k=Util.decode_sort_key(j.sort_key);p=j.icon;n=j.ns_path;i=j.htmlified_link;g=h.changesets;f=_("Rename complete.");Notify.server_success(f,null,null,g,FileOps.do_rollback);e.rename(o,n,l,k,p,i);BrowseSelection.set_selected_files([e]);e.get_div().smoothScrollIntoView();return BrowseUtil.load_visible_thumbs()};a=URI({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user).toString();c=new Ajax.InPlaceEditor(this.get_div().down(".filename-col a"),a,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:function(){return e.editing=false},onFailure:function(){},savingText:_("Saving..."),ajaxOptions:{job:true,subject_user:Browse.active_user,html_in_error_msg:true,progress_text:_("Renaming..."),method:"POST",onCreate:Notify.clear_all,onSuccess:d,onUninitialized:Browse.unselectable},callback:function(f,g){return{to_path:g||"",folder:(e.dir?"yes":"")}}});c.enterEditMode();b=this.get_div().down(".editor_field");if("selectionEnd" in b&&this.filename.lastIndexOf(".")>-1){return b.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var b,a;if(this.dir){if(Browse.inside_dir&&Browse.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&Browse.public_folder_enabled){b="PUBLIC_FOLDER"}}if(b==null){if(this.type===FileTypes.FOLDER){b="FOLDER"}else{if(this.type===FileTypes.PACKAGE){b="FOLDER"}else{if(this.type===FileTypes.SHARED_FOLDER){b="SHARED_FOLDER"}else{if(this.type===FileTypes.SANDBOX){b="SANDBOX"}else{if(this.target_ns){b="SHARED_FOLDER"}else{b="FOLDER"}}}}}}}if(b==null){b=BrowseFile.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}a=this.is_deleted?BrowseFile.CATEGORY_TO_DELETED_TRANSLATION[b]:BrowseFile.CATEGORY_TO_TRANSLATION[b];assert(a,"CATEGORY MISSING FOR "+b);return a},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return Util.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&Browse.is_shmodelable_path(this.fq_path)}});BrowseFile._CATEGORIES={IMAGE:"ai bmp cr2 eps gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"cdr csv doc docx fla indd keynote numbers otf pages pdf ppt pptx pps ppsx ps rtf swf txt wpd xls xlsx",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};BrowseFile.EXTENSION_TO_CATEGORY={};BrowseFile.CATEGORY_TO_TRANSLATION={FILE:_("file"),FOLDER:_("folder"),SHARED_FOLDER:_("shared folder"),PUBLIC_FOLDER:_("folder"),IMAGE:_("image"),VIDEO:_("video"),AUDIO:_("audio"),DOCUMENT:_("document"),COMPRESSED_FILE:_("archive"),CODE:_("code"),DISK_IMAGE:_("disk image"),EXECUTABLE:_("executable"),SHORTCUT:_("shortcut"),LINK:_("link"),FONT:_("font"),SANDBOX:_("app folder")};BrowseFile.CATEGORY_TO_DELETED_TRANSLATION={FILE:_("deleted file"),FOLDER:_("deleted folder"),SHARED_FOLDER:_("deleted shared folder"),PUBLIC_FOLDER:_("deleted folder"),IMAGE:_("deleted image"),VIDEO:_("deleted video"),AUDIO:_("deleted audio"),DOCUMENT:_("deleted document"),COMPRESSED_FILE:_("deleted archive"),CODE:_("deleted code"),DISK_IMAGE:_("deleted disk image"),EXECUTABLE:_("deleted executable"),SHORTCUT:_("deleted shortcut"),LINK:_("deleted link"),FONT:_("deleted font"),SANDBOX:_("deleted app folder")};(function(){var c,e,b,d,a;d=BrowseFile._CATEGORIES;a=[];for(c in d){b=d[c];a.push((function(){var i,g,f,h;f=b.trim().split(" ");h=[];for(i=0,g=f.length;i<g;i++){e=f[i];h.push(BrowseFile.EXTENSION_TO_CATEGORY[e]=c)}return h})())}return a})();BrowseFile._file_index={};BrowseFile.from_key=function(a){return BrowseFile._file_index[a]};BrowseFile.from_elem=function(b){var a;if(!b){return}a=b.readAttribute("data-identity");if(a){return BrowseFile.from_key(a)}else{return BrowseFile.from_elem(b.up("[data-identity]"))}};var BrowseActions,BrowseActionsBasic,BrowseActionsContext,GlobalActions,GlobalActionsBasic,GlobalActionsContext;BrowseActions=Class.create({initialize:function(a){return this._set_files(a)},unlisten:function(){},get_action_names:function(){var a;a=this.get_files();if(a.length<2){return this._get_actions_single(a.first())}else{return this._get_actions_multi(a)}},get_files:function(){return this._files},get_action_by_name:function(a){return this.evaluate_action(BrowseActions.option_dict[a],a)},evaluate_action:function(c,b){var d,f,a,e=this;d=function(h,g){if((g!=null)&&!(h!=null)){return g}if($j.isFunction(h)){return h.call(e)}else{if(h!=null){return h}else{return g}}};a={};a.icon_href=c.icon_href;a.target=c.target;a.click_handler=c.click_handler;a.type=c.type;a.name=b||c.name;a.is_dropdown=!!c.is_dropdown;a.icon=d(c.icon);a.text=d(c.text);a.detail_text=d(c.detail_text);a.href=d(c.href,"");if($j.isFunction(c.subactions)){a.subactions=c.subactions.call(this)}else{if($j.isArray(c.subactions)){a.subactions=(function(){var j,h,i,g;i=c.subactions;g=[];for(j=0,h=i.length;j<h;j++){f=i[j];g.push(this.get_action_by_name(f))}return g}).call(this)}else{if(c.subactions){assert(0,"subactions must be a function or an array of actions")}}}return a},_set_files:function(a){return this._files=$A(a)},_get_actions_single:function(c){var e,a,g,i,b,k,h,l,j,f,d;e=[];if(!c){return[]}g=Browse.public_folder_enabled&&c.fq_path.toLowerCase().startsWith("/public/");h=Browse.public_folder_enabled&&c.fq_path.toLowerCase()==="/public";b=c.target_ns;a=c.ns_id!==Constants.root_ns;j=c.type===FileTypes.SHARED_FOLDER;l=c.type===FileTypes.SANDBOX;k=c.type===FileTypes.PACKAGE;i=c.root_coll_item_counter>=0;if(c.is_deleted){e=e.concat(["restore"]);e.push("purge");if(!c.dir){e.push("revisions")}}else{if(Constants.send_a_copy_enabled){e.push("send_copy")}if(c.dir){if(l){e.push("app_info")}else{if(j){e.push("sharing_options")}else{if(!(a||b||g||h)){e.push("share")}}}if(Constants.quicksend_enabled&&((f=Browse.quicksend_contacts)!=null?f.length():void 0)>=2){if(c.is_shmodelable()){e.push("token_share_menu")}}else{if(c.is_shmodelable()){e.push("token_share")}}e.push("download");if(!h){e=e.concat(["delete","rename","move"]);if(!(k||b)){e.push("copy")}}if(Browse.can_use_photos_features){if(Browse.can_use_photos_features){e.push("album_from_folder")}}}else{if(Constants.quicksend_enabled&&((d=Browse.quicksend_contacts)!=null?d.length():void 0)>=2){if(c.is_shmodelable()){e.push("token_share_menu")}}else{if(c.is_shmodelable()){e.push("token_share")}}if(g||Browse.public_app_token){e.push("copy_url")}e.push("download");e=e.concat(["delete","rename","move","copy","revisions"]);if(i&&Browse.can_use_photos_features){e.push("view_in_photos")}}}return e},_get_actions_multi:function(c){var a,b;if(Constants.send_a_copy_enabled){a=["send_copy","download"]}else{a=["download"]}a=a.concat(["delete","move","copy","restore","purge","view_in_photos"]);b=BrowseUtil.profile_files(c);if(b.deleted>0||b.public_folder>0){a.removeItem("move");a.removeItem("copy");a.removeItem("delete")}if(b.shared_folders>0){a.removeItem("copy")}if(b.deleted>0){a.removeItem("delete");a.removeItem("download")}if(!Browse.inside_dir){a.removeItem("download")}if(b.deleted!==c.length){if(b.rejoinables!==c.length){a.removeItem("restore")}a.removeItem("purge")}if(b.in_root_coll!==c.length||!Browse.can_use_photos_features){a.removeItem("view_in_photos")}return a},_get_disabled_action_names:function(){var a;a=[];if(Browse.inside_read_only_shared_folder){a=a.concat(["move","rename","delete","restore","purge"])}return a}});Object.extend(BrowseActions,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(a){var b;Modal.icon_show("alert_32",Util.append_ellipsis(_("Copy public link")),DomUtil.fromElm("copy-public-url"),{wit_group:"copy_public_link"});Modal.onHide=function(){$("flash_copy_container").remove();delete Modal.onHide;return Modal.hide()};Util.addCopyUrlFlash(a);b=$("modal-content").down("#public_url");assert(b,"Text element not found for copy pulic link");b.setValue(a);return b.select()},shortenPublicLink:function(){var a;Util.shorten_url($F("public_url"),BrowseActions.updatePublicLink);a=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small.gif",className:"right"});return $("modal-content").down("a").__date(a)},updatePublicLink:function(a){$("public_url").setValue(a);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();return Util.addCopyUrlFlash(a)},option_dict:{new_folder:{icon:"folder_add",text:_("New folder"),click_handler:function(a){return Browse.new_folder()}},global_restore:{icon:"restore",text:function(){assert(Browse.inside_deleted_dir,"Global restore from not a deleted dir");if(Browse.inside_deleted_shared_folder){return Util.append_ellipsis(_("Rejoin shared folder"))}else{if(Browse.inside_deleted_sandbox){return _("Restore app folder")}else{return _("Restore folder")}}},click_handler:function(){var d,e,b,a,c;d=Browse.containing_fq_path();b=d.toLowerCase();if(Browse.inside_deleted_sandbox){assert(Browse.old_path_to_ns_id[b],"Deleted sandbox missing nsid");return Apps.restore_sandbox(Browse.active_user,d,Browse.old_path_to_ns_id[b])}else{if(Browse.inside_deleted_shared_folder){assert(Browse.old_path_to_ns_id[b],"Deleted shared folder missing nsid");return SharingModals.show_rejoin_modal(Browse.active_user,d,Browse.old_path_to_ns_id[b])}else{e=URI.parse(location.href).setFragment("").toString();a={prev:e};a[Constants.UID_PARAM_NAME]=Browse.active_user;c=URI({path:"/restore"+d}).updateQuery(a);return window.location.href=String(c)}}}},restore:{icon:"restore",text:function(){var b,a;b=this.get_files();a=BrowseUtil.profile_files(b);if(a.shared_folders===b.length){return Util.append_ellipsis(ungettext("Rejoin shared folder","Rejoin shared folders",b.length))}else{return _("Restore")}},click_handler:function(){var c,f,b,g,e,a,d;f=this.get_files();if(f.length===0){}else{if(f.length===1){c=f.first();if(!c.is_deleted){return}g=c.fq_path;b=g.toLowerCase();if(c.type===FileTypes.SANDBOX){assert(Browse.old_path_to_ns_id[b],"Restore missing ns");Apps.restore_sandbox(Browse.active_user,g,Browse.old_path_to_ns_id[b])}else{if(c.type===FileTypes.SHARED_FOLDER){assert(Browse.old_path_to_ns_id[b],"Rejoin missing ns");SharingModals.show_rejoin_modal(Browse.active_user,g,Browse.old_path_to_ns_id[b])}else{if(c.dir){e=URI.parse(location.href).updateQuery({select:c.filename});a={prev:String(e)};a[Constants.UID_PARAM_NAME]=Browse.active_user;d=URI({path:"/restore"+c.fq_path}).updateQuery(a);window.location=String(d)}else{FileOps.show_undelete(c)}}}}else{return FileOps.show_bulk_restore(f,Browse.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(Browse.inside_shared_folder){return Util.append_ellipsis(_("Shared folder options"))}else{if(Browse.containing_fq_path()===""){return Util.append_ellipsis(_("Share a folder"))}else{return Util.append_ellipsis(_("Share this folder"))}}},click_handler:function(a){a.preventDefault();if(Browse.containing_fq_path()===""){return SharingModals.start_wizard_for_user(Browse.active_user)}else{if(Browse.inside_shared_folder){return SharingModals.show_shared_folder_options_modal(Browse.containing_mount_point(),Browse.active_user)}else{return SharingModals.show_share_existing_modal(Browse.containing_fq_path(),Browse.active_user)}}}},sharing_options:{icon:"rainbow_16",text:Util.append_ellipsis(_("Shared folder options")),click_handler:function(a){return SharingModals.show_shared_folder_options_modal(this.get_files().first().fq_path,Browse.active_user)}},share:{icon:"rainbow_16",text:Util.append_ellipsis(_("Invite to folder")),click_handler:function(a){return SharingModals.show_share_existing_modal(this.get_files().first().fq_path,Browse.active_user)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=FileOps.build_revisions_uri(this.get_files().first().fq_path,Browse.active_user)},text:_("Previous versions")},token_share_menu:{icon:"s_link",is_dropdown:true,text:_("Share link"),click_handler:function(f,c){var a,d,b;if(!c.hasAttribute("submenu-index")){return}b=parseInt(c.getAttribute("submenu-index"),10);if(b>=3){a=b-3;d=this.get_files().first().fq_path;assert(d,"token_share_menu: expected non-root fq_path");return SharingShmodel.shmodel_quicksend(d,Browse.quicksend_contacts.contacts[a])}},subactions:function(){var h,d,f,b,e,a,g;d=[{name:"token_share_noshmodal",icon:"s_link",text:Util.append_ellipsis(_("Get link"))},{name:"token_share",icon:"send-to-contact",text:Util.append_ellipsis(_("Share with contact"))}];if(!((e=Browse.quicksend_contacts)!=null?e.length:void 0)){return d}d.push({type:"subheader",text:_("Quick Send")});a=Browse.quicksend_contacts.contacts;for(f=0,b=a.length;f<b;f++){h=a[f];if((g=h.name)!=null?g.length:void 0){d.push({text:h.name.em_snippet(15),detail_text:("("+h.email+")").em_snippet(15),name:"token_share_menu",icon:"send-to-contact"})}else{d.push({text:h.email.em_snippet(30),name:"token_share_menu",icon:"send-to-contact"})}}return d}},token_share:{icon:"s_link",text:Util.append_ellipsis(_("Share link")),click_handler:function(b){var a;ShmodelUILogger.log("via-browse-menu");a=this.get_files().first().fq_path;assert(a,"token_share: expected non-root fq_path");return SharingShmodel.shmodel(a)}},token_share_noshmodal:{icon:"s_link",text:Util.append_ellipsis(_("Open link")),click_handler:function(c){var b,a,d;ShmodelUILogger.log("via-browse-menu");b=this.get_files().first().fq_path;assert(b,"token_share: expected non-root fq_path");return SharingShmodel.shmodel(b,a=true,d=false)}},global_token_share:{icon:"s_link",text:Util.append_ellipsis(_("Share link")),click_handler:function(a){ShmodelUILogger.log("via-global-toolbar");return SharingShmodel.shmodel(Browse.containing_fq_path())}},copy_url:{icon:"world_link",text:Util.append_ellipsis(_("Copy public link")),click_handler:function(c){var b,a;b=this.get_files().first();if(Browse.public_app_token){a="/spa/"+Browse.public_app_token+b.ns_path}else{a="/u/"+Browse.active_user.id+b.fq_path.substring(BrowseActions.PUBLIC_FOLDER_PATH_LENGTH)}return BrowseActions.showCopyPublicUrlModal(String(new URI({scheme:"https",authority:Constants.PUBSERVER,path:a})))}},download:{icon:"download",text:function(){return _("Download")},click_handler:function(){var d,c,a,g,i,h,e,b,f;a=this.get_files();if(a.length===1&&!a[0].dir){c=a.first();f=[Constants.protocol,Constants.block,c.fq_path,c.hash],h=f[0],d=f[1],i=f[2],g=f[3];e={w:g,dl:1};b=URI({scheme:h,authority:d,path:"/get"+i,query:e});return window.location=String(b.updateQuery(Constants.UID_PARAM_NAME,Browse.active_user))}else{return FileOps.do_bulk_download(a)}}},view:{href:function(){var f,a,d,c,e,b;a=this.get_files().first();b=[Constants.protocol,Constants.block,Util.urlquote(a.fq_path),a.hash],e=b[0],f=b[1],c=b[2],d=b[3];return""+e+"://"+f+"/get"+c+"?w="+d},icon:"page_white_magnify",text:_("View file")},ignore:{click_handler:function(){return SharingModals.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:_("Permanently remove")},show_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"trash-can",text:_("Show deleted files")},hide_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"trash-can-open",text:_("Hide deleted files")},copy:{icon:"copy",text:Util.append_ellipsis(_("Copy")),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_copy(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_copy_bulk(b)}}}},get_link:{icon:"s_link",text:_("Get link"),click_handler:function(b){var a;return Snapshots.get_link((function(){var f,d,e,c;e=this.get_files();c=[];for(f=0,d=e.length;f<d;f++){a=e[f];c.push(a.fq_path)}return c}).call(this))}},send_copy:{icon:"move_16",text:Util.append_ellipsis(_("Send a copy")),click_handler:function(b){var a;return Snapshots.send_copy((function(){var f,d,e,c;e=this.get_files();c=[];for(f=0,d=e.length;f<d;f++){a=e[f];c.push(a.fq_path)}return c}).call(this))}},move:{icon:"move_16",text:Util.append_ellipsis(_("Move")),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_move(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_move_bulk(b)}}}},rename:{icon:"rename",text:_("Rename"),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:Util.append_ellipsis(_("Delete")),click_handler:function(c){var a,b;b=this.get_files();if(b.length>1){return FileOps.show_bulk_delete(Browse.active_user,b)}else{if(b.length===1){a=b.first();return FileOps.show_delete(Browse.active_user,a.fq_path,a.dir)}}}},global_purge:{icon:"cancel",text:Util.append_ellipsis(_("Permanently delete folder")),click_handler:function(){return FileOps.show_purge(Browse.containing_fq_path(),true)}},purge:{icon:"cancel",text:Util.append_ellipsis(_("Permanently delete")),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_bulk_purge(b)}}},upload:{icon:"upload_16",text:Util.append_ellipsis(_("Upload")),click_handler:function(a){return FileOps.show_upload()}},app_info:{icon:"application_double",text:Util.append_ellipsis(_("Application info")),click_handler:function(a){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:_("More"),click_handler:Prototype.emptyFunction},more_global_actions:{text:_("More actions"),click_handler:function(){GlobalActionsBasic.show_secondary();return document.body.observe("click",GlobalActionsBasic.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return _("View in Photos")},click_handler:function(){var a;a=this.get_files();return FileOps.do_bulk_photo_view(a)}},album_from_folder:{icon:"create-album",text:function(){return _("Create album")},click_handler:function(){var b,a;b=this.get_files();a=b.first();return FileOps.create_album_from_folder(a.fq_path,a.filename)}}}});BrowseActionsContext=Class.create(BrowseActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));$j("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));return $j("#context-menu-container").on("mouseout","li.primary",this._out.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");a=BrowseActions.option_dict[c];BrowseActionsContextMenuLogger.log(this.get_files(),c);if(!a.is_dropdown||b.hasAttribute("submenu-index")){ContextMenu.hide()}d.preventDefault();return a.click_handler.call(this,d,b)},_reset_all_submenus:function(){return $j("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(a){return $j(a).removeClass("hover")},_over:function(a){if($j(a.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return $j(a.currentTarget).addClass("hover")}},_out:function(a){var b=this;if($j(a.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout(function(){return b._reset_submenu(a.currentTarget)},300)}}});BrowseActionsBasic=Class.create(BrowseActions,{initialize:function($super){var a;a=BrowseSelection.get_selected_files();$super(a);this._render();return this._listen()},_listen:function(){var a;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(BrowseSelection.UPDATED_EVT,this.bound_update);document.observe(ContextMenu.SHOW_EVT,this.bound_disable);document.observe(ContextMenu.HIDE_EVT,this.bound_enable);a=$("browse-root-actions");a.stopObserving("click");return a.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(BrowseSelection.UPDATED_EVT,this.bound_update);document.stopObserving(ContextMenu.SHOW_EVT,this.bound_disable);document.stopObserving(ContextMenu.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(BrowseSelection.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(c){var b,a;a="#browse-root-actions #"+c+"_action_button";b=$j(a);b.addClass("disabled");return b.click(function(d){Notify.server_info(_("You only have permission to view."));return false})},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var x,r,t,k,v,y,A,q,s,m,a,h,i,j,u,g,B,o,e,l,n,p,f,d,b,w,z,c;h=this.get_files();t=this.get_action_names();x=13.5;s="";i="";if(h.length===1){s=h[0].filename.em_snippet(x);if(!h[0].dir&&h[0].bytes>=0){i=h[0].size}}else{if(1<h.length){e=BrowseUtil.profile_files(h);u=[];if(e.files){g=ungettext("%d file","%d files",e.files).format(e.files);u.push(g)}if(e.folders){g=ungettext("%d folder","%d folders",e.folders).format(e.folders);u.push(g)}s=Util.nice_list(u)}}y=$("browse-root-actions");v=y.getLayout().get("width");j=y.getStyle("font-size");assert(j.endsWith("px"),"Invalid font size "+j);j=parseInt(j,10);m=new Emstring(s).length*j;n=new Emstring(i).length*j;v-=m+n;p=[];l=[];v-=30;for(d=0,w=t.length;d<w;d++){B=t[d];r=this.get_action_by_name(B);f=new Emstring(r.text).length*j;A=f+16+8+10+9;if(v>A){p.push(B)}else{if(l.length===0){o=p.pop();l.push(o)}l.push(B)}v-=A}if(l.length){p.push("more_actions")}k=(function(){var E,D,C;C=[];for(E=0,D=p.length;E<D;E++){B=p[E];C.push(this.get_action_by_name(B))}return C}).call(this);if(l.length){k[k.length-1].subactions=(function(){var E,D,C;C=[];for(E=0,D=l.length;E<D;E++){B=l[E];C.push(this.get_action_by_name(B))}return C}).call(this)}q=HTML.tmpl("actions_bar_tmpl",{context:this,description:s,filesize:i,has_actions:!!t.length,actions:k});$("browse-root-actions").__date(q);a=this._get_disabled_action_names();c=[];for(b=0,z=a.length;b<z;b++){r=a[b];c.push(this._disable_action(r))}return c},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);d.preventDefault();return a.click_handler.call(this,d,b)}});Object.extend(BrowseActionsBasic,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos"]});GlobalActions=Class.create(BrowseActions,{initialize:function($super){return $super()},get_action_names:function(){var b,a;if(!Browse.inside_dir){return[]}b=[];if(!Browse.inside_deleted_dir){b=b.concat(["upload","new_folder"]);a=Browse.inside_shared_folder&&Browse.containing_ns_path();if(!(Browse.inside_sandbox||a)){b.push("global_share")}if(Browse.containing_fq_path()&&Browse.is_shmodelable_path(Browse.containing_fq_path())){b.push("global_token_share")}if(!Constants.can_see_trash){b.push((Browse.deleted_shown?"hide_del":"show_del"))}}else{b=b.concat(["global_restore"])}return b},get_disabled_action_names:function(){var a;a=[];if(Browse.inside_read_only_shared_folder){a=a.concat(["upload","new_folder"])}return a}});GlobalActionsBasic=Class.create(GlobalActions,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(ContextMenu.SHOW_EVT,this._disable.bind(this));return document.observe(ContextMenu.HIDE_EVT,this._enable.bind(this))},_render:function(){var c,d,g,j,a,f,h,e,i,b;d=this.get_action_names();h=d.intersect(GlobalActionsBasic.STANDARD_ACTIONS);f=d.without.apply(d,GlobalActionsBasic.STANDARD_ACTIONS);if(f.length===1){h=d;f=[]}if(f.length){h.push("more_global_actions")}g=HTML.tmpl("global_actions_tmpl",{context:this,standard_actions:(function(){var m,l,k;k=[];for(m=0,l=h.length;m<l;m++){a=h[m];k.push(this.get_action_by_name(a))}return k}).call(this),secondary_actions:(function(){var m,l,k;k=[];for(m=0,l=f.length;m<l;m++){a=f[m];k.push(this.get_action_by_name(a))}return k}).call(this)});$("global-actions").__date(g);j=this.get_disabled_action_names();b=[];for(e=0,i=j.length;e<i;e++){c=j[e];b.push(this._disable_action(c))}return b},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(c){var b,a;a="#global-actions #"+c+"_button";b=$j(a);b.addClass("disabled");return b.click(function(d){Notify.server_info(_("You only have permission to view."));return false})},_enable:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");return $$("#global-actions .action a").invoke("addClassName","title_bubble")},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);GlobalActionsBasic.hide_secondary();BrowseSelection.deselect_all();d.preventDefault();return a.click_handler.call(this,d,b)}});Object.extend(GlobalActionsBasic,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var a,b;b=$("secondary-actions");a=$("more_global_actions_button");b.show();return a.addClassName("down")},hide_secondary:function(){var a,b;b=$("secondary-actions");if(!b){return}a=$("more_global_actions_button");b.hide();return a.removeClassName("down")}});GlobalActionsContext=Class.create(GlobalActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");a=BrowseActions.option_dict[c];BrowseSelection.deselect_all();if(!a.is_dropdown){ContextMenu.hide()}d.preventDefault();return a.click_handler.call(this,d,b)}});var BrowseClipboard;BrowseClipboard=(function(){var i,f,c,g,e,k,m,h,b,a,j,d,l;i=0;f=1;e=[];c=null;l=function(){var p,r,o,s,q,n;if(Util.focus_in_input()){return}o=BrowseSelection.get_selected_files();if(o&&o.length){for(q=0,n=o.length;q<n;q++){r=o[q];if(r.bytes<0){Notify.server_error(_("Deleted files cannot be added to the clipboard"));return false}else{if(r.target_ns){s=_("'%(filename)s' cannot be added to the clipboard");s=s.format({filename:r.filename});Notify.server_error(s);return false}}}e=o;p=o.length;s=ungettext("Added %d item to clipboard","Added %d items to clipboard",p).format(p);Notify.server_success(s);return true}};k=function(){if(l()){c=i;return false}};m=function(){if(l()){c=f;return false}};h=function(n){var o;assert(typeof n!=="undefined","BrowseClipboard _paste got an undefined path");if(e.length){o=c===i?FileOps.do_bulk_copy:FileOps.do_bulk_move;o(e,n);return true}};d=function(n){var o;if(Util.focus_in_input()||Browse.in_search_mode()||Browse.inside_deleted_dir){return}o=h(Browse.containing_fq_path());if(o){return false}};g=function(){return e=[]};a=function(u){var t,p,r,s,q,o,n;r=u.memo.files;for(s=0,o=r.length;s<o;s++){p=r[s];for(q=0,n=e.length;q<n;q++){t=e[q];if(t.fq_path===p.fq_path||t.fq_path.startsWith(p.fq_path+"/")){g();return}}}};b=function(n){assert((n.memo.file!=null)&&!(n.memo.files!=null));n.memo.files=[n.memo.file];return a(n)};j=function(){var r,n,q,o,p;document.observe(FileEvents.RENAME,b);p=[FileEvents.DELETE,FileEvents.MOVE];for(q=0,o=p.length;q<o;q++){r=p[q];document.observe(r,a)}n=key.main_modifier();key(""+n+"+c",Browse.KEY_SCOPE,k);key(""+n+"+x",Browse.KEY_SCOPE,m);return key(""+n+"+v",Browse.KEY_SCOPE,d)};return{init:function(){return j()}}})();var BrowseSelection;BrowseSelection=(function(){var y,D,B,x,g,f,u,z,m,e,C,r,q,a,b,n,s,E,l,j,o,i,w,d,h,v,t,c,A,k,p;h=[];x=null;e=null;z=null;f=[];A=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select");return BrowseSelection.get_selected_files().invoke("get_div").findAll(function(F){return F}).invoke("addClassName","file-select")};k=function(){if(z){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);return BrowseSelection.get_selected_files().filter(function(F){return !F.editing}).invoke("get_div").findAll(function(F){return F}).invoke("writeAttribute","draggable","true")};p=function(F){F.apply(null,$A(arguments).slice(1));return document.fire(BrowseSelection.UPDATED_EVT)};v=function(H,G){var I,F;F=h.length;h=(H instanceof BrowseFile?[H]:$A(H));if(h.length!==F){T("Selected",h.length,"files")}I=G||h.last();assert(!I||I instanceof BrowseFile,"Invalid anchor type"+I);return x=I};v=v.wrap(p);y=function(G,F){if(G){h.push(G)}return x=F||G};y=y.wrap(p);j=function(F){var G;G=h.indexOf(F);if(G===-1){return}return h.splice(G,1)};j=j.wrap(p);o=function(){return h=[]};o=o.wrap(p);t=function(F){f=F;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return F.invoke("get_div").findAll(function(G){return G}).invoke("addClassName","context-select")};a=function(O){var L,J,I,K,R,H,Q,S,F,N,P,M,G;M=$(O.target);S=M.match("li.browse-file")?M:M.up("li.browse-file");L=M.match("a")?M:M.up("a");I=BrowseFile.from_elem(S);if(O.isRightClick()||!S||L){return}Browse.keyboard_nav=false;if(f.length){return}H=Util.is_mac();if((H&&O.metaKey)||(!H&&O.ctrlKey)){if(h.indexOf(I)===-1){return y(I)}else{return j(I)}}else{if(O.shiftKey){J=Browse.files.indexOf(x);G=Browse.files.indexOf(I);Q=Browse.files.indexOf(h.last());N=h.slice(0);R=Q<J?-1:1;K=J;while(K!==Q){K+=R;P=N.indexOf(Browse.files[K]);if(P!==-1){N.splice(P,1)}}R=G<J?-1:1;K=J;while(K!==G){K+=R;F=N.indexOf(Browse.files[K]);if(F!==-1){N.splice(F,1)}N.push(Browse.files[K])}return v(N,x)}else{return v(I)}}};b=function(K){var O,H,N,L,G,F,J,I,M;if(K.isRightClick()||f.length||Util.in_scrollbar(K.pointerX())){return}L=$(K.target);if(Element.match(L,"object")){L=L.parentNode}J=["browse-box","context-menu-container","modal","modal-overlay"];G=false;for(I=0,M=J.length;I<M;I++){F=J[I];if(L.descendantOf(F)||L.match("#"+F)){G=true;break}}if(!G){v();return}N=L.match("li.browse-file")?L:L.up("li.browse-file");H=BrowseFile.from_elem(N);O=L.match("[draggable]")||L.up("[draggable]");if(H&&!O){e=x;if(!K.shiftKey){if(H){e=H}else{if(L.match("#browse-files")){e=Browse.files.last()}}}z=[];if(K.metaKey||K.ctrlKey){return z=BrowseSelection.get_selected_files()}}};c=function(I){var G,F,H;ShmodelUILogger.log("via-browse-row-icon");H=$(I.target);F=H.match("li.browse-file")?H:H.up("li.browse-file");G=BrowseFile.from_elem(F);I.preventDefault();if(G){return SharingShmodel.shmodel(G.fq_path)}};g=function(I){var G,F,H;H=$(I.target);F=H.match("li.browse-file")?H:H.up("li.browse-file");G=BrowseFile.from_elem(F);if(G){return a(I)}};q=null;C=function(){var F;clearInterval(q);F=function(){Browse.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return q=setTimeout(F,100)};u=function(){if(!Browse.keyboard_nav){Browse.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};n=function(L){var I,H,G,K,N,F,J,M;C();if(!BrowseSelection.is_selecting()){return}I=Browse.files.indexOf(e);F=Browse.files.indexOf(BrowseFile.from_elem(L.target));assert(I<Browse.files.length&&I>=0,"anchor_index: "+I+" "+e);assert(F<Browse.files.length&&F>=0,"target_index: "+F);H=Browse.files.slice(Math.min(I,F),Math.max(I,F)+1);G=z.slice(0);for(J=0,M=H.length;J<M;J++){N=H[J];K=G.indexOf(N);if(K===-1){G.push(N)}else{G.splice(K,1)}}return v(G)};m=function(F){e=null;return z=null};l=function(H){var F,G;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(H){Event.extend(H).preventDefault()}G=h.length?h.last()===Browse.files.first()?Browse.files.first():(F=Browse.files.indexOf(h.last())-1,Browse.files[F]):Browse.files.last();v(G);if(G){return Browse.scrollTo(G.get_div())}};s=function(H){var F,G;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(H){Event.extend(H).preventDefault()}G=h.length?h.last()===Browse.files.last()?Browse.files.last():(F=Browse.files.indexOf(h.last())+1,Browse.files[F]):Browse.files.first();v(G);if(G){return Browse.scrollTo(G.get_div())}};B=function(N){var F,G,L,M,I,J,K,H;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(N){Event.extend(N).preventDefault()}if(h.length>0){M=Browse.files.indexOf(h.last());F=Browse.files.indexOf(x);if(x===h.last()||F>M){if(M>0){H=[];for(L=J=K=M-1;K<=0?J<=0:J>=0;L=K<=0?++J:--J){G=Browse.files[L];I=h.indexOf(G);y(G,x);if(I!==-1){H.push(h.splice(I,1))}else{Browse.scrollTo(G.get_div());break}}return H}}else{j(h.last());return Browse.scrollTo(h.last().get_div())}}else{return l()}};D=function(O){var F,G,M,N,J,K,L,I,H;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(O){Event.extend(O).preventDefault()}if(h.length>0){N=Browse.files.indexOf(h.last());F=Browse.files.indexOf(x);if(x===h.last()||F<N){H=[];for(M=K=L=N+1,I=Browse.files.length;L<=I?K<I:K>I;M=L<=I?++K:--K){G=Browse.files[M];J=h.indexOf(G);y(G,x);if(J!==-1){H.push(h.splice(J,1))}else{Browse.scrollTo(G.get_div());break}}return H}else{j(h.last());return Browse.scrollTo(h.last().get_div())}}else{return s()}};i=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}v(Browse.files);return false};d=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}return v(null,null,null)};w=function(F){return v(Browse.find_file(F.memo.fq_path))};r=function(){$$(".file-select").invoke("removeClassName","file-select");return setTimeout(A,100)};E=function(F){return F.memo.files.each(function(G){var H;H=h.indexOf(G[0]);if(H!==-1){h.splice(H,1);return y(G[1])}})};document.observe(UpdateEvents.REMOVE,function(F){return F.memo.files.each(j)});document.observe(UpdateEvents.MOVE,E);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var F;document.observe("click",g);document.observe("mousedown",b);document.observe("mouseup",m);document.observe("dragend",m);document.observe("mouseup",k);$("browse-files").on("mouseover","li.browse-file",n);$("browse-files").on("click",".shmodel-file",c);document.observe(BrowseSelection.UPDATED_EVT,A);document.observe(BrowseSelection.UPDATED_EVT,k);document.observe(Browse.RENDER_EVT,A);document.observe(Browse.RENDER_EVT,k);document.observe(Browse.UPDATE_EVT,v.bind(null,null,null));document.observe(BrowseSelection.LIGHTBOX_EXIT_SELECT_EVT,w);F=key.main_modifier();key("up",Browse.KEY_SCOPE,l);key("down",Browse.KEY_SCOPE,s);key(F+"+a",Browse.KEY_SCOPE,i);key("escape",Browse.KEY_SCOPE,d);key("shift+up",Browse.KEY_SCOPE,B);return key("shift+down",Browse.KEY_SCOPE,D)},set_selected_files:function(F){return v(F)},get_selected_files:function(){return h.slice(0)},get_selected_fq_paths:function(){return h.map(function(F){return F.fq_path})},is_selected:function(F){return h.indexOf(F)!==-1},is_selecting:function(){return !!e},deselect_all:o,set_context_selected:function(F){return t(F)},flicker_selected:r}})();var DragScroll;DragScroll={_timer:null,_mouse_y:0,_scroll_amount:40,_scroll_window:50,_exclude_move_event:null,init:function(a,b){this._exclude_move_event=a;if(b!=null){return this._scroll_window=b}},start:function(){this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(b){var a;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(b):void 0){return this._mouse_y=0}else{a=b.pointerY();return this._mouse_y=a-Util.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var a;a=0;if(this._mouse_y<this._scroll_window){a=-1*this._scroll_amount}else{if(this._mouse_y>Util.viewport_dimensions().height-this._scroll_window){a=this._scroll_amount}}if(a){return Util.scroll_to(Util.scroll_offsets().left,Util.scroll_offsets().top+a)}}};var BrowseDrag;BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var a;if(!Modernizr.draganddrop){return}this.listen();a=function(c){var b;b=$j(c.target);return b.closest("#browse-location").length||b.attr("id")==="browse-location"};return DragScroll.init(a,$j("#browse-header").height())},listen:function(){var a;a=$(document.body);document.observe(Browse.UPDATE_EVT,this._update_body_data.bind(this));a.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));a.on("dragend",this._body_dragend.bind(this));a.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){a.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));a.on("mousedown",this._ie_start_drags.bind(this));a.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}a.observe("dragover",this._body_dragover.bind(this));a.observe("dragleave",this._body_dragleave.bind(this));a.observe("dragstart",this._body_dragstart.bind(this));a.observe("mousemove",this._body_mousemove.bind(this));a.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(BrowseSelection.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(Browse.RENDER_EVT,this._build_selected_drag_icon.bind(this));a.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return a.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(b){var a;if(!window.event||window.event.button!==1){return}a=b.findElement("[draggable]");if(a&&a!==document&&a.dragDrop){a.dragDrop();return BrowseDrag._ie_end_drags()}},_ie_start_drags:function(a,b){if(b.tagName!=="OBJECT"&&$(b).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var b,a;b=Browse.inside_dir?"copy move":false;a=Browse.inside_dir?Browse.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",b);return $(document.documentElement).writeAttribute("data-fq_path",a)},_body_dragover:function(d){var b,c,a;b=this._get_event_browse_files();if(b.length){return this._update_status_position(d,b)}else{if(!this._drag_from_window&&((c=d.dataTransfer)!=null?(a=c.types)!=null?a.contains("Files"):void 0:void 0)){return UploadPrep.show_drop_indicators(d)}}},_body_dragleave:function(c){var b,a,d;a=c.x||c.clientX;d=c.y||c.clientY;b=Util.viewport_dimensions();if(!((0<a&&a<b.width)&&(0<d&&d<b.height))){return UploadPrep.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();UploadPrep.hide_drop_indicators();DragScroll.end();return this._drag_from_window=false},_body_mousemove:function(){return UploadPrep.hide_drop_indicators()},_ie_mouseover:function(b,a){if(!Util.focus_in_input()){return a.focus()}},_dropzone_dragover:function(g,a){var b,c,d,f;d=this._get_event_browse_files();f=this._target_fq_path(a);if(!d.pluck("fq_path").indexOf(f===-1)){return}if(!this._can_drop(g,a)){a.addClassName("drag_nodrop");return}try{c=g.dataTransfer.effectAllowed}catch(h){}if(c==="move"||c==="copyMove"||c==="linkMove"||c==="all"){g.dataTransfer.dropEffect="move"}else{g.dataTransfer.dropEffect="copy"}g.preventDefault();b=$$(".dragover");b.removeItem(a);b.invoke("removeClassName","dragover");if(!OverQuotaUploads.disabled){a.addClassName("dragover")}return UploadPrep.folder_dragover(f)},_dropzone_dragleave:function(b,a){return this._clear_hover_state(a)},_file_dragstart:function(h,k){var l,b,m,g,d,f,i,c;Util.clear_selected();if(BrowseSelection.is_selecting()){return h.preventDefault()}h.dataTransfer.effectAllowed="copyMove";h.dataTransfer.setData("URL","about:blank");g=BrowseFile.from_elem(k);this._set_event_browse_files(g);d=this._get_event_browse_files();if(d.length<=1&&!g.dir){c=g.href;f=(g.filename||_("file")).replace(/:/g,"-");i="application/octet-stream";try{h.dataTransfer.setData("DownloadURL",[i,f,c].join(":"))}catch(j){}}m=new Element("img",{src:"/static/images/icons/icon_spacer.gif",width:1,height:1});l=true;try{h.dataTransfer.setDragImage(m,150,150)}catch(a){l=Util.ie8}this._add_drop_indicators(h);DragScroll.start();if(l){this._update_status_position(h,d);b=$("drag-status");b.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(d.length>1){b.addClassName("rotatein")}if(this._is_dragging_selection()){b.addClassName("selection")}return b.addClassName("fadein")}},_add_drop_indicators:function(f){var g,d,b,c,a;$(document.body).addClassName(this._STATUS_CLASS);if(!OverQuotaUploads.disabled){c=$$('[dropzone="copy move"]');a=[];for(d=0,b=c.length;d<b;d++){g=c[d];if(this._can_drop(f,g)){a.push(g.addClassName("can_drop"))}else{a.push(void 0)}}return a}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var a,d,j,c,g,k,h,b,e,l,f;b=BrowseSelection.get_selected_files();j=new Element("div",{id:"drag-selection-status"});f=b.slice(0,4);for(g=e=0,l=f.length;e<l;g=++e){d=f[g];a=d.get_div();if(!a){continue}h=a.down(".icon");h.stopObserving("load");h.observe.bind(h).defer("load",BrowseDrag._build_selected_drag_icon);k=h.cloneNode(false);Element.addClassName(k,"icon icon"+g);j.__sert(k)}c=new Element("span",{className:"badge"});c.__date(b.length);j.appendChild(c);return $("drag-selection-status").replace(j)},_build_file_drag_icon:function(f,a){var b,g,d,c;b=BrowseFile.from_elem(a);c=b.get_div().down(".icon").cloneNode(false);Element.addClassName(c,"icon icon0");d=new Element("span",{className:"badge"});d.__date("1");g=new Element("div",{id:"drag-file-status"});g.__date(c).__sert(d);return $("drag-file-status").replace(g)},_drop:function(i,d){var a,c,f,g,b,h;i.preventDefault();c=this._get_event_browse_files();b=i.dataTransfer.files;h=i.dataTransfer.items;f=null;g=BrowseFile.from_elem(d);a=d.readAttribute("data-fq_path");if(g){f=g.fq_path}else{if(a||a===""){f=a}}if(b&&b.length){if(!UploadPrep.supported()){Notify.server_error(_("Drag and drop not supported. Please try the simple uploader."))}else{if(!UploadPrep.browse_indicators_enabled()&&!UploadPrep.modal_indicators_enabled()){Notify.server_error(_("You can't drag and drop upload right now."))}else{UploadPrep.upload(f,b,h)}}}else{if(c.length){if((i.dataTransfer.dropEffect==="copy")||(i.dataTransfer.effectAllowed==="copy")){FileOps.do_bulk_copy(c,f)}else{if(!Browse.inside_dir||Browse.containing_fq_path()!==f){FileOps.do_bulk_move(c,f)}}}}this._remove_drop_indicators();return UploadPrep.hide_drop_indicators()},_set_event_browse_files:function(a){var b;b=BrowseSelection.is_selected(a);return this._current_item_key=b?this._SELECTION_CONST:a.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var c,b;try{b=this._current_item_key;if(this._is_dragging_selection()){return BrowseSelection.get_selected_files()}else{if(b){c=BrowseFile.from_key(b);return(c?[c]:[])}}}catch(a){console.log(a)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_can_drop:function(d,b){var a,c;if(b.readAttribute("read_only")){return false}a=this._target_fq_path(b);c=this._get_event_browse_files();if(c.length){return !FileOps.bulk_move_error(c,a)}else{if($A(d.dataTransfer.types).indexOf("Files")!==-1){return UploadPrep.supported()}else{return false}}},_target_fq_path:function(a){var b;b=BrowseFile.from_elem(a);if(b){return b.fq_path}else{return a.readAttribute("data-fq_path")}},_clear_hover_state:function(b){var e,d,a,c;c=$$("#browse .dragover");for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){e.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(a){a=Event.extend(a);return Util.scry("drag-status").setStyle({left:(a.pointerX()-Util.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(a.pointerY()-Util.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var BrowseJump;BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(a){return a.charCodeAt(0)}),update:function(){var c,f,b,e,a,d;if(!BrowseJump._listening){BrowseJump.listen();BrowseJump._listening=true}c=[];d=Browse.files;for(e=0,a=d.length;e<a;e++){b=d[e];f=BrowseJump.to_codepoint_list(b.filename);c.push([f,b])}c.sort(function(h,g){return BrowseJump.cmp_codepoints(h[0],g[0])});return BrowseJump._CODEPOINTS=c},reset:function(){return BrowseJump._active=""},is_active:function(){return BrowseJump._active},jump:function(a){if(a){BrowseSelection.set_selected_files([a]);return Browse.scrollTo(a.get_div())}},listen:function(){var e,d,b,c,a;document.observe("keypress",function(g){var f;if(key.getScope()!==Browse.KEY_SCOPE){return}if(Util.focus_in_input()||g.metaKey||g.altKey||g.altGraphKey||g.ctrlKey){return}f=g.charCode||g.keyCode;if(f<32){return}if((33<=f&&f<=40)){return}if(f===32){if(BrowseJump._active){g.preventDefault()}else{return}}if(BrowseJump._BLACKLIST.indexOf(f)!==-1){return}clearTimeout(BrowseJump._RESET_TIMER_ID);BrowseJump._active+=String.fromCharCode(f).toLowerCase();BrowseJump.jump(BrowseJump.nearest_file(BrowseJump._active));return BrowseJump._RESET_TIMER_ID=setTimeout(BrowseJump.reset,BrowseJump._RESET_WAIT)});c=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.RENAME,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE,UpdateEvents.ADD,UpdateEvents.REMOVE,UpdateEvents.MOVE];a=[];for(d=0,b=c.length;d<b;d++){e=c[d];a.push(document.observe(e,function(f){return BrowseJump.update()}))}return a},nearest_file:function(i){var f,b,a,e,h,g,d,c;if((g=BrowseJump._CODEPOINTS)!=null?g.length:void 0){f=BrowseJump.to_codepoint_list(i);d=BrowseJump._CODEPOINTS;for(e=0,h=d.length;e<h;e++){c=d[e],a=c[0],b=c[1];if(BrowseJump.cmp_codepoints(f,a)<1){return b}}BrowseJump._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(e,d){var a,c,b;assert(e.length>0&&d.length>0,"bad input to cmp_codepoints");for(a=c=0,b=e.length;0<=b?c<b:c>b;a=0<=b?++c:--c){if(!(d[a]!=null)){return 1}if(e[a]!==d[a]){return(e[a]<d[a]?-1:1)}}if(d.length>e.length){return -1}else{return 0}},to_codepoint_list:function(b){var c,a,e,d;b=b.toLowerCase();a=[];for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){a.push(b.charCodeAt(c))}return a}};var ContextMenu;ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){var a=this;$j(document).click(this.hide_on_click);$j(document).on(Browse.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,function(b){return ContextMenu.hide()})},unlisten:function(){$j(document).off("click",this.hide_on_click);return $j(document).off(Browse.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(a){if(!(a.which===3||$j(a.target).parents("#context-menu").length)){return ContextMenu.hide()}},show_for_file:function(a,d,c){var f,b;Browse.keyboard_nav=false;this.hide();f=BrowseFile.from_elem(c);b=BrowseSelection.is_selected(f)?BrowseSelection.get_selected_files():[f];BrowseSelection.set_context_selected(b);return this._show(d,new a(b))},show_global:function(a,b){this.hide();return this._show(b,new a())},show_shmodel:function(f){var d,a,b,c;d=["get_original"];this.hide();b=f.findElement("img");c={get_original:{icon:"download",text:_("Download Original"),href:b.readAttribute("data-original-href")}};a=Class.create({get_action_names:function(){return d},get_action_by_name:function(e){var g;g=c[e];g.name=e;return g}});return this._show(f,new a())},show_for_lightbox:function(f){var d,a,b,c;d=["download","view_original"];this.hide();b=f.findElement("img");c={download:{icon:"download",text:_("Download"),href:URI.parse(b.readAttribute("data-original-href")).updateQuery({dl:1}).toString()},view_original:{icon:"view_original",text:Util.append_ellipsis(_("View original")),href:b.readAttribute("data-original-href"),target:"_blank"}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){var e;e=$("context-menu-container");e.stopObserving("click");e.stopObserving("contextmenu");e.on("click",".action button",this._click.bind(this));return e.on("contextmenu",".action button",this._click.bind(this))},_click:function(k,h){var j,g,i;j=h.readAttribute("data-value");g=c[j];ContextMenu.hide();k.preventDefault();return(i=g.click_handler)!=null?i.call(this,k):void 0},get_action_names:function(){return d},get_action_by_name:function(e){var g;g=c[e];g.name=e;return g}});return this._show(f,new a())},show_photos:function(j,n){var m,b,g,d,l,k,a,c,h,i,f;this.hide();d={divider:{type:"divider"},choose_album:{icon:"album_16",text:Util.append_ellipsis(_("Add %(num_photos)s to album").format({num_photos:n.length})),click_handler:function(o){PhotosCollections.show_add_to_album_modal(o,n);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.PCM,{num_photos:n.length})}},remove:{icon:"album_delete_16",text:_("Remove %(num_photos)s from album").format({num_photos:n.length}),click_handler:function(){PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),n);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.PCM,{num_photos:n.length})}},set_cover:{icon:"album_16",text:_("Set as cover"),click_handler:function(){Photos.get_current_collection().set_cover(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SET_AS_COVER,PhotosTriggers.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return Photos.show_timestamps_modal(n)}}};if(Photos.in_single_collection_view()){m=["share","choose_album","remove"];if(n.length===1){m.unshift("divider");m.unshift("set_cover")}}else{m=["share","choose_album"];m.push("divider");m.push("delete");if(Photos.timestamp_edit_enabled){l=(function(){var p,o,e;e=[];for(p=0,o=n.length;p<o;p++){c=n[p];if(!(c.time_taken!=null)){e.push(c)}}return e})();if(l.length===0){m.push("edit_timestamp")}else{if(l.length===n.length){d.edit_timestamp.text="Set timestamp";m.push("edit_timestamp")}}}}if(n.length===1){i=PhotosUtil.categorize_files(n),k=i[0],a=i[1];if(k){h=Util.append_ellipsis(_("Share photo"))}else{h=Util.append_ellipsis(_("Share video"))}Object.extend(d,{share:{icon:"s_link",text:h,click_handler:function(o){Foshmodal.show(n,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:1})}},"delete":{text:Util.append_ellipsis(_("Delete")),click_handler:function(){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:1})}},show_in_folder:{text:Util.append_ellipsis(_("Show in folder")),click_handler:function(){Photos.show_in_folder(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SHOW_IN_FOLDER,PhotosTriggers.PCM,{num_photos:1})}}});if(Photos.in_single_collection_view()){m.push("divider")}m.push("show_in_folder")}else{f=PhotosUtil.categorize_files(n),k=f[0],a=f[1];if(k&&a){h=ungettext("Share %(file_count)s item","Share %(file_count)s items",n.length);g=ungettext("Delete %(file_count)s item","Delete %(file_count)s items",n.length)}else{if(k){h=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",n.length);g=ungettext("Delete %(file_count)s photo","Delete %(file_count)s photos",n.length)}else{h=ungettext("Share %(file_count)s video","Share %(file_count)s videos",n.length);g=ungettext("Delete %(file_count)s video","Delete %(file_count)s videos",n.length)}}h=h.format({file_count:n.length});g=g.format({file_count:n.length});Object.extend(d,{share:{icon:"s_link",text:h,click_handler:function(o){Photos._share_selected();return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:n.length})}},"delete":{text:g,click_handler:function(o){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:n.length})}}})}b=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(r,p){var q,o,s;q=p.readAttribute("data-value");o=d[q];if(r.clientX===0&&r.clientY===0){return}ContextMenu.hide();return(s=o.click_handler)!=null?s.call(this,r):void 0},get_action_names:function(){return m},get_action_by_name:function(e){var o;o=d[e];o.name=e;return o}});return this._show(j,new b())},show_photo_collection:function(d,f,g){var c,a,b;this.hide();if(f.is_anonymous){c=["go_to_link","unshare"]}else{if(f.is_creator){c=["share","rename"];if(f.share_tkey!=null){c.push("unshare")}c.push("delete")}else{c=["share"]}}b={share:{icon:"s_link",text:Util.append_ellipsis(_("Share album")),click_handler:function(h){if(f.num_items===0){Notify.server_error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(f,true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},unshare:{icon:"lock",text:Util.append_ellipsis(f.is_anonymous?_("Unshare"):_("Unshare album")),click_handler:function(h){PhotosCollections.show_unshare_modal(f);return PhotosLogger.log_interaction(PhotosEvents.UNSHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},rename:{icon:"pencil",text:_("Rename album"),click_handler:function(h){f.rename(g.down(".collection-name"));return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},"delete":{icon:"album_delete_16",text:Util.append_ellipsis(_("Delete album")),click_handler:function(h){PhotosCollections.show_delete_modal(f);return PhotosLogger.log_interaction(PhotosEvents.DELETE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},go_to_link:{icon:"s_link",text:_("Go to link"),click_handler:function(h){PhotosCollections.go_to_link(f);return PhotosLogger.log_interaction(PhotosEvents.GO_TO_ALBUM_LINK,PhotosTriggers.CCM,{num_photos:f.num_photos})}}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(l,i){var k,h,j;k=i.readAttribute("data-value");h=b[k];ContextMenu.hide();return(j=h.click_handler)!=null?j.call(this):void 0},get_action_names:function(){return c},get_action_by_name:function(e){var h;h=b[e];h.name=e;return h}});return this._show(d,new a())},_show:function(t,l,s){var r,q,j,a,i,u,c,p,o,z,y,m,f,d,b,v,x,w,k,h,g;if(s==null){s=false}m=((t!=null?(k=t.target)!=null?k.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((t!=null?(h=t.target)!=null?h.type.toUpperCase():void 0:void 0)==="TEXT")||((t!=null?(g=t.target)!=null?g.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");p=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper"];y=$(t.target);if($j(y).parents("#context-menu").length){return}r=$j("#file-preview-modal");if(!r.find(y)||!$j(y).is("img")){for(f=0,v=p.length;f<v;f++){c=p[f];u=$$(c);if(u){for(d=0,x=u.length;d<x;d++){i=u[d];if(y.descendantOf(i)||y.match(c)){return}}}}}if((t!=null?t.shiftKey:void 0)||m){return}else{Event.stop(t)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=HTML.tmpl("context_menu_tmpl")}if(!l.get_action_names().length){return}FreshDropdown.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:l,actions:(function(){var A,e,B,n;B=l.get_action_names();n=[];for(A=0,e=B.length;A<e;A++){o=B[A];n.push(l.get_action_by_name(o))}return n})(),big:s}));a=this.get_disabled_action_names();for(b=0,w=a.length;b<w;b++){q=a[b];this.disable_action(q)}j=Event.pointer(t);z=Util.scroll_offsets();this.position_at(j.x-z.left,j.y-z.top);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(c,f){var b,a,d,e;e=Util.viewport_dimensions();a=parseInt($("context-menu").getStyle("width"),10);b=parseInt($("context-menu").getStyle("height"),10);d=15;if(c+a>e.width-d){$("context-menu").setStyle({left:(e.width-a-d)+"px"})}else{$("context-menu").setStyle({left:c+"px"})}if(f+b>e.height-d){return $("context-menu").setStyle({top:(e.height-b-d)+"px"})}else{return $("context-menu").setStyle({top:f+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();BrowseSelection.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}},get_disabled_action_names:function(){var a;a=[];if(Browse.inside_read_only_shared_folder){a=a.concat(["move","rename","delete","restore","purge","revisions"])}return a},disable_action:function(c){var b,a;a="#context-menu-container #"+c+"_button";b=$j(a);b.addClass("disabled");return b.click(function(d){Notify.server_info(_("You only have permission to view."));return false})}};var BROWSE_SNIPPET_LEN,Browse,BrowseUpdate,FILE_PPREVIEW_MODAL_FOR_DOCS,LAST_MODIFIED_FNAME_SNIPPET,SEARCH_SNIPPET_LEN,_this=this;BROWSE_SNIPPET_LEN=25;SEARCH_SNIPPET_LEN=20;LAST_MODIFIED_FNAME_SNIPPET=4;FILE_PPREVIEW_MODAL_FOR_DOCS=false;Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:[Sort.FILES_BY_NAME,true],folder_loading_notification:null,keyboard_nav:false,init:function(b,g,d,e,a,c){var f;this.browse_actions_ctor=g;this.global_actions_ctor=d;this.browse_actions_context_ctor=e;this.global_actions_context_ctor=a;assert(typeof c==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=viewer.get_user_by_id(c);window.active_user_loaded=true;assert(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();Util.viewport_dimensions();if($j.browser.chrome){this.previews_enabled=b&&Util.pdf_plugins().length}else{this.previews_enabled=b}if(viewer.is_paired){SharingState.set_role(this.active_user.role)}if(Constants.quicksend_enabled){this.quicksend_contacts=new ContactsList([],[]);return this.load_quicksend_contacts(f=false)}},load_quicksend_contacts:function(a){if(a==null){a=true}return DefaultContactsCache.load_contacts(a=a,function(b){var c;c=parseInt(Browse.active_user.id);return Browse.quicksend_contacts=b.includeForUser(c).excludeMe().excludeFacebook().slice(0,5)})},setup:function(b){var f,e,d,a,c;this.ns_id_to_mount_point=b.ns_id_to_mount_point;this.old_path_to_ns_id=b.old_path_to_ns_id;this.compiled_tmpl=HTML.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_dir=b.inside_dir;this.inside_deleted_dir=b.inside_deleted_dir;this.inside_shared_folder=b.inside_shared_folder;this.inside_read_only_shared_folder=b.inside_read_only_shared_folder;this.inside_sandbox=b.inside_sandbox;this.public_app_token=b.public_app_token;this.public_folder_enabled=b.public_folder_enabled;this.inside_deleted_sandbox=b.inside_deleted_sandbox;this.inside_deleted_shared_folder=b.inside_deleted_shared_folder;this.ns_map=b.ns_map;this.contents_cache_key=b.contents_cache_key;this.use_pdf_caching=b.use_pdf_caching;e="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(e)}else{$("browse").removeClassName(e)}this.block_hash=b.block_hash;this.block_hash_param=b.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=b.containing_ns_id;this._containing_ns_path=b.containing_ns_path;this._containing_fq_path=b.containing_fq_path;this._containing_mount_point=b.containing_mount_point;BrowseURL.set_path_url(this._containing_ns_id,this._containing_ns_path);this.breadcrumb();c=[this.browse_actions,this.global_actions];for(d=0,a=c.length;d<a;d++){f=c[d];if(f!=null){f.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!b.file_info){this.show_message(_('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}return this._push_files(b.file_info)},_push_files:function(b){var c,d,a;for(d=0,a=b.length;d<a;d++){c=b[d];BrowseUtil.make_browsefile(c)}return BrowseJump.update()},_get_helper:function(a){assert(this.inside_dir,"accessed "+a+", but not inside a directory");return Browse[a]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_fq_path:function(){return this._get_helper("_containing_fq_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},listen:function(){var b,f,n,i,h,e,l,c,a,m,j,g,d,k=this;$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",ContextMenu.show_for_file.bind(ContextMenu,this.browse_actions_context_ctor));this.enable_sorting();f="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover($("name-sorter"),true,f,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",ContextMenu.show_global.bind(ContextMenu,this.global_actions_context_ctor));document.observe(BrowseSelection.UPDATED_EVT,this.selection_handler.bind(this));document.observe(FileEvents.COPY,function(o){if(k.inside_dir&&o.memo.to_fq_path===k.containing_fq_path()){return k.force_reload()}});j=[FileEvents.MOVE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE];for(i=0,l=j.length;i<l;i++){b=j[i];document.observe(b,function(o){if(k.inside_dir){return k.force_reload()}})}g=[FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE];for(h=0,c=g.length;h<c;h++){b=g[h];document.observe(b,function(o){if(k.inside_dir){if(o.memo.target_ns_id===k.containing_ns_id()){if(o.memo.folder_deleted){return k.reload_fqpath("")}else{return k.reload_fqpath(k.containing_fq_path())}}else{return k.force_reload()}}})}d=[FileEvents.DELETE,FileEvents.PURGE];for(e=0,a=d.length;e<a;e++){b=d[e];document.observe(b,function(w){var t,v,p,u,o,r,s,q;if(k.inside_dir){if(w.eventName===FileEvents.PURGE||(w.eventName===FileEvents.DELETE&&!BrowseURL.get_del())){for(v=u=s=k.files.length-1;s<=0?u<=0:u>=0;v=s<=0?++u:--u){if(w.memo.files.indexOf(k.files[v])===-1){p=k.files[v]}else{break}}BrowseSelection.deselect_all();q=w.memo.files;for(r=0,o=q.length;r<o;r++){t=q[r];t.get_div().remove();k.files.removeItem(t)}if(k.files.length){if(p!=null){return BrowseSelection.set_selected_files(p)}else{return BrowseSelection.set_selected_files(k.files.last())}}else{return k.show_empty()}}else{if(k.keyboard_nav){k.select_fq_paths=[k.containing_fq_path()+"/"+w.memo.files.last().filename]}if(Lightbox.shown){return Lightbox.reload=true}else{return k.force_reload()}}}})}document.observe(ContextMenu.SHOW_EVT,this.disable_sorting.bind(this));document.observe(ContextMenu.HIDE_EVT,this.enable_sorting.bind(this));m=function(){var p,o;p=$("browse-header");o=p.cumulativeOffset().top+p.getHeight();return Util.viewport_dimensions().height-o};key("pagedown",this.KEY_SCOPE,function(o){Event.extend(o).preventDefault();return window.scrollBy(0,m())});key("pageup",this.KEY_SCOPE,function(o){Event.extend(o).preventDefault();return window.scrollBy(0,-1*m())});n=function(){var o;o=Browse.in_search_mode()?FileSearch:Browse;if(Browse.files.length===0){return o.show_empty()}else{return o.hide_empty()}};document.observe(UpdateEvents.ADD,function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];k.insert_file(p,true)}return n()});document.observe(UpdateEvents.REMOVE,function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];k.remove_file(p)}return n()});return document.observe(UpdateEvents.MOVE,function(r){var v,u,p,t,s,q,o;s=r.memo.files;o=[];for(p=0,t=s.length;p<t;p++){q=s[p],v=q[0],u=q[1];k.remove_file(v);o.push(k.insert_file(u))}return o})},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(b,c){var a;a=$(b.target);if(a.match("a.filename-link")||a.match("img.icon")){return this._click(b,c)}},dblclick:function(a,b){if($(a.target).match("a")){return}return this._click(a,b)},open_file:function(c,a){var b,d;b={mode:"get",file_ext:Util.file_extension_for_logging(c.filename),file_bytes:c.bytes};if(c.dir){if(a){return this.open_folder_in_new_window(c)}else{return this.open_folder(c)}}else{if(!a&&!((c.preview_type==="video")&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX)){if(this.previews_enabled||((d=c.preview_type)==="photo"||d==="video")){return BrowseUtil.filepreview_from_selected("fileclick",c)}else{UserActivityLogger.log("web","file_view",Object.toJSON(b));return window.open(c.href,"_blank")}}else{UserActivityLogger.log("web","file_view",Object.toJSON(b));return window.open(c.href,"_blank")}}},open_preview:function(a){var b,c=this;b=function(){var e,d,g,f;e=c.find_file(a);g=e.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;d=c.previews_enabled||((f=e.preview_type)==="photo"||f==="video");if(!g&&d){BrowseUtil.filepreview_from_selected("fileclick",e)}return document.stopObserving(c.UPDATE_EVT,b)};return document.observe(this.UPDATE_EVT,b)},_click:function(c,d){var b,a;this.keyboard_nav=false;b=BrowseFile.from_elem(d);if(b.editing){return}a=(c.which===2)||(Util.is_mac()&&c.metaKey);Browse.open_file(b,a);c.preventDefault()},crumb_click:function(d,a){var c,b;this.keyboard_nav=false;d.preventDefault();b=a.readAttribute("data-fq_path");c=this.details_from_fq_path(b);return BrowseURL.set_path_url(c.ns_id,c.ns_path)},parent_click:function(d,c){var a,b;this.keyboard_nav=false;d.preventDefault();b=c.readAttribute("data-parent_ns_path");a=parseInt(c.readAttribute("data-parent_ns_id"),10);return BrowseURL.set_path_url(a,b)},selection_handler:function(){if(BrowseSelection.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(BrowseUtil.load_visible_thumbs.bind(BrowseUtil),this.POST_SCROLL_WAIT)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var b,a;this.last_sort=[Sort.FILES_BY_NAME,true];a="#browse-sort a.sortable-column-header";b=$$(a)[0];Util.add_sort_arrow_mouseover(b,true,a,false);$("kind-sorter-label").__date(FlexColumn.DISPLAY.FILES_BY_KIND);return Sprite.src(b.down("img"),"web","arrow-up-gray")},sort_handler:function(h,i,d){var f,a,g,b,j,c;i=$(i);i.blur();f=i.readAttribute("data-sort");if(!(d!=null)){d=this.last_sort[0]===Sort[f]?i.readAttribute("data-ascending")==="false":true}if(FlexColumn.LABELS.indexOf(f)!==-1){j=FlexColumn.SORT_FUNCTIONS.indexOf(this.last_sort[0])!==-1;if(j){g=(FlexColumn.LABELS.indexOf(f)+1)%FlexColumn.LABELS.length;f=FlexColumn.LABELS[g];a=FlexColumn.DISPLAY[f];$("kind-sorter-label").__date(a)}i.writeAttribute("data-sort",f);d=FlexColumn.IS_ASC[f]}else{i.writeAttribute("data-ascending",(d?"true":"false"))}c="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover(i,d,c,true);b=Sort[f];this.sort(b,d);if(h){return h.stop()}},toggle_deleted:function(){var a;a=!BrowseURL.get_del();return BrowseURL.set_del_url(a)},new_folder:function(){var f,r,h,b,g,o,k,d,j,n,c,p,l,i,a,q,e,m=this;if(this.reloading||this.creating_folder){return}this.hide_empty();this.selectable();r=_("New folder");g=[];e=this.files;for(a=0,q=e.length;a<q;a++){o=e[a];if(o.dir&&o.filename.indexOf(r)!==-1){g.push(o.filename)}}d=r;f=1;while(true){if(g.indexOf(d)===-1){break}d=r+" ("+f+")";f++}i=HTML.tmpl("new_folder_tmpl",{name:d});k=-1;if(this.files.length){l=Util.scroll_offsets();if(l.top>0){p=this.files[0].get_div().getLayout().get("margin-box-height");k=Math.floor(l.top/p)}}if(k>0){this.files[k].get_div().__sert({after:i})}else{$("browse-files").__sert({top:i})}j=$$("#browse-files .browse-new-folder .name").first();assert(j!=null,"expected new_folder_name to be defined");h=this.containing_fq_path();c=function(u){var t,s,v;v=u.responseText.evalJSON(true);assert(v.new_browse_files.length===1,"No new file data returned.");t=Util.filename(v.new_browse_files.first().fq_path);s=_("Created folder '%(folder_name)s'");s=s.format({folder_name:t.em_snippet(25)});Notify.server_success(s);m.select_fq_paths=[v.new_browse_files.first().fq_path];return m.force_reload()};n=function(t){var s;s=$$("#browse-files li.browse-new-folder").first();if(s){s.remove()}return m.creating_folder=false};b=new Ajax.InPlaceEditor(j,"/cmd/new"+(Util.urlquote(h)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:n,savingText:_("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:c,subject_user:Browse.active_user},callback:function(s,t){m.creating_folder=true;return{to_path:t||"",folder:"yes"}}});return b.enterEditMode()},open_folder:function(c){var b,a,d,e=this;assert(c.dir,"Only open directories, not files");if(!(BrowseSelection.get_selected_files().length===1&&BrowseSelection.get_selected_files().indexOf(c)===0)){BrowseSelection.deselect_all();c.get_div().addClassName("file-select")}clearTimeout(this.folder_loading_notification);b=function(){var f;f=_("Loading %(filename)s...");f=f.format({filename:c.filename.em_snippet(50)});return Notify.server_success(f,60,true)};this.folder_loading_notification=setTimeout(b,1000);if(c.target_ns){a=c.target_ns;d=""}else{a=c.ns_id;d=c.ns_path}if(c.is_deleted){return BrowseURL.set_path_url(a,d,true)}else{return BrowseURL.set_path_url(a,d)}},open_folder_in_new_window:function(a){return window.open(BrowseURL._make_url(a.ns_id,a.ns_path),"_blank")},show_message:function(c){var b,a;if((typeof c)!==(typeof"string")){a=$("browse-files").down(".browse-message");if(a){a.show()}return}this.msg=c;b=new Element("div",{"class":"browse-message"});b.__date(c);return $("browse-files").__sert(b)},sort:function(a,d,c){var b;if(!c&&a===this.last_sort[0]&&d===this.last_sort[1]){return}this.last_sort=[a,d];b=a(d);this.files.sort(b);this.smartfill();return BrowseUtil.load_visible_thumbs()},resort:function(){var c,a,b;a=this.last_sort;b=a[0];c=a[1];return this.sort(b,c,true)},in_search_mode:function(){return $("browse").hasClassName("search")},flex_column:function(){return $("kind-sorter").readAttribute("data-sort")},smartfill:function(){var b,e,c,f,d,h,a,g;b=$("browse-files");d=[];f=this.in_search_mode();c=this.flex_column();g=this.files;for(h=0,a=g.length;h<a;h++){e=g[h];d.push(this.compiled_tmpl({file:e,in_search_mode:f,flex_column:c}))}b.__date(d);return document.fire(this.RENDER_EVT)},add_file:function(a){this.files.push(a);if(a.target_ns){Browse.ns_id_to_mount_point[a.target_ns]=a.fq_path}if(a.bytes<0){return this.deleted_shown=true}},insert_file:function(c,b){var a;if(!c){return}b=b||0;a=this.find_file(c.fq_path);if(a&&a!==c){this.remove_file(a);BrowseFile._file_index[c.to_key()]=c}this.update_file_pos(c);if(b){c.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(a){return Browse._push_files(a.file_info)},get_file_pos:function(a){var b;b=this.files.indexOf(a);assert(b!==-1,"file not present in @files");assert(a.to_key() in BrowseFile._file_index,"file not present in BrowseFile._file_index");return b},remove_file:function(a){var b;if(!a){return}b=this.files.indexOf(a);if(b!==-1){this.files.splice(b,1);delete BrowseFile._file_index[a.to_key()];return a.get_div().remove()}},update_file_pos:function(f){var a,i,d,e,g,c,b,h;h=this.files.indexOf(f);if(h!==-1){this.files.splice(h,1)}delete f.sort_rank;c=this.last_sort[0];g=this.last_sort[1];e=Util.bsearch(this.files,f,c(g),true);this.files.splice(e,0,f);d=f.get_div();a=$("browse-files");if(d){d.remove()}b=this.compiled_tmpl({file:f,in_search_mode:this.in_search_mode(),flex_column:this.flex_column()});i=a.childElements();if(e<i.length){return a.childElements()[e].__sert({before:b})}else{return a.__sert(b)}},find_file:function(a){return this.files.find(function(b){return b.fq_path.toLowerCase()===a.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];BrowseFile._file_index={};return BrowseDrag._body_dragend()},clear:function(){$("browse-files").__date();return this.hide_empty()},show_empty:function(){return $("browse-empty").show()},hide_empty:function(){return $("browse-empty").hide()},update:function(a){$("browse-box").show();$("browse-files").__date();if(typeof a==="string"){this.setup(JSON.parse(a))}else{this.setup(a)}this.resort();return document.fire(this.UPDATE_EVT)},reload_fqpath:function(b,a){return this.reload(null,Util.urlquote(b),a)},force_reload:function(){return this.reload(this.containing_ns_id(),Util.urlquote(this.containing_ns_path()),true)},set_title:function(){var a;a=this.containing_fq_path();return document.title=a?Util.filename(a)+" - Dropbox":viewer.is_paired&&Browse.active_user.role===Constants.ROLE_WORK?viewer.team_name+" - Dropbox":viewer.is_paired&&Browse.active_user.role===Constants.ROLE_PERSONAL?_("Personal")+" - Dropbox":_("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(i){var c,b,g,f,a,d,e,h;a=i.select_fq_paths;d=i.select_index;if(a||d>-1){b=[];if(a){for(e=0,h=a.length;e<h;e++){g=a[e];f=this.find_file(g);if(f){b.push(f)}}}if(!b.length&&d>-1){c=this.files[d];if(c){b.push(c)}}if(b.length){BrowseSelection.set_selected_files(b);this.scrollToWithPadding(b.first().get_div(),100)}i.select_fq_paths=false;return i.select_index=-1}else{return window.scrollTo(0,0)}},set_selection_from_item_counters:function(){var b,h,e,k,f,d,j,a,g,c;if(this.select_item_counters!=null){e={};g=this.select_item_counters;for(f=0,j=g.length;f<j;f++){h=g[f];e[h]=true}k=[];c=this.files;for(d=0,a=c.length;d<a;d++){b=c[d];if(b.root_coll_item_counter in e){k.push(b)}}BrowseSelection.set_selected_files(k);return this.select_item_counters=null}},reload:function(d,n,b){var q,f,k,e,i,o,p,c,j,g,m,a,h=this;c="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+n+")";assert(n.search(DBHistory.URL_ESCAPE_REGEX)===-1,c);if(d==null){d=Browse.active_user.root_ns}n=Util.normalize(n);if(BrowseUtil.get_mode()!==BrowseUtil.BROWSE_MODE){this.clear();BrowseUtil.set_browse_mode()}if(FileSearch._clear_on_reload){FileSearch.clear_searchbox()}if(!FileQueue.uploading){InlineUploadStatus.hide()}if(this.reloading){return}if(this.inside_dir&&n===this.containing_ns_path()&&d===this.containing_ns_id()&&!b){return}m=this.first_load?Constants.referrer:"";o=this.deleted_shown?"?show_deleted=yes":"";g={ns_id:d,referrer:m};g=Object.extend(g,this.extra_reload_args);T("Browse.reload:",n);this.reloading=true;a="/browse"+n+o;q=2;f=["browse",d,n,o,Browse.active_user.id,q];j=function(r){h.reset_state();h.update(r);(h.files.length?h.hide_empty.bind(h):h.show_empty.bind(h))();clearTimeout(h.folder_loading_notification);if(Notify.cancel_on_reload){Notify.clear_all();Notify.cancel_on_reload=false}Util.force_delete_cached_scroll_offsets();h.set_selection_from_fq_paths_or_index(Browse);return h.set_title()};k=false;if(this.use_local_cache){e=DBLocalStorage.getItem(f);try{p=JSON.parse(e)}catch(l){p={}}g.contents_cache_key=p.contents_cache_key;if(e){i=function(){try{j(p);h.reloading=false;return k=true}catch(r){return DBLocalStorage.removeItem(f)}};i.defer()}}new Ajax.DBRequest(a,{allow_retries:true,subject_user:Browse.active_user,parameters:g,log_timing:true,on304:function(r){},onSuccess:function(v){var y,s,x,t,u,w,r;if(h.in_search_mode()){return}p=JSON.parse(v.responseText);t=null;x=null;if(h.use_local_cache){u=function(){return DBLocalStorage.setItem(f,v.responseText)};u.defer();if(e&&k){if(!(h.containing_fq_path()===p.containing_fq_path)){return}t=BrowseSelection.get_selected_files();x=Util.scroll_offsets()}}j(p);if(t){s=[];for(w=0,r=t.length;w<r;w++){y=t[w];s.push(Browse.find_file(y.fq_path))}BrowseSelection.set_selected_files(s);return window.scrollTo(x[0],x[1])}else{return Browse.set_selection_from_item_counters()}},onFailure:function(){if(h.first_load){h.reload.bind(h).defer(Constants.root_ns,"")}return clearTimeout(h.folder_loading_notification)},cleanUp:function(){h.first_load=false;return h.reloading=false},no_feed_reload:true,evalJSON:false});return true},is_shmodelable_path:function(a){var b;if(Browse.public_app_token){return false}if(Browse.public_folder_enabled){b=a.toLowerCase();if(b.startsWith("/public/")){return false}}return true},can_get_details_from_fq_path:function(c){var b,a;b=this.containing_fq_path();a=this.containing_mount_point();return(a&&c.startsWith(a))||b.startsWith(c)},details_from_fq_path:function(d){var e,b,a,c;assert(this.can_get_details_from_fq_path(d));b=this.containing_mount_point();if(b&&d.startsWith(b)){a=this.containing_ns_id();c=d.slice(b.length);e=Util.filename(d,this._get_root_name())}else{a=Constants.root_ns;c=d;e=Util.filename(d,this._get_root_name())}return{ns_id:a,ns_path:c,fq_path:d,folder_name:e||this._get_root_name(),url:""+(Util.get_browse_root(Browse.active_user))+d,icon:(d.length?"folder_32":this._get_root_icon())}},_make_breadcrumbs_data:function(){var f,g,b,e,a,d,c;g=this.containing_fq_path();f=[];a=g.split("/");for(b=d=0,c=a.length;0<=c?d<c:d>c;b=0<=c?++d:--d){e=Util.normalize(a.slice(0,b+1).join("/"));f.push(this.details_from_fq_path(e))}return f},_get_root_icon:function(){if(!viewer.is_paired){return"glyph"}if(Browse.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(Browse.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return Util.role_title_for_user(Browse.active_user)||_("Dropbox")},_get_max_breadcrumb_width:function(b){var a;a=b?this._DROPDOWN_WIDTH:new Emstring(this._get_root_name()).length;return this._MAX_BREADCRUMB_WIDTH-a},_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var k,b,d,l,g,j,a,h,c,e,f;b=this._make_breadcrumbs_data();c=b.collect(function(i){return new Emstring(i.fq_path?i.folder_name:"").length});h=0;d=0;assert(b.length>0,"expected at least one breadcrumb");for(g=e=f=b.length-1;f<=0?e<=0:e>=0;g=f<=0?++e:--e){h+=c[g];if(h>this._get_max_breadcrumb_width()){break}d+=1;h+=this._CONNECT_WIDTH}l=b.slice(0,b.length-Math.max(1,d));b=b.slice(l.length,b.length);if(!l.length&&b.length>1){b.shift()}j=b.pop();k=HTML.tmpl("breadcrumb_tmpl",{breadcrumbs:b,dropdown:l,containing_fq_path:this.containing_fq_path(),url_root:Util.get_browse_root(Browse.active_user),root_name:this._get_root_name()});a=j.folder_name;if(j.fq_path!==""){a=a.em_snippet(this._get_max_breadcrumb_width(l.length>1))}$("browse-location").__date(k);$("browse-location").__sert(" "+a);if(l.length>1){return this._render_breadcrumbs_dropdown(l)}},_render_breadcrumbs_dropdown:function(f){var a,c,b,e,d=this;a=$("breadcrumbs-box");f.reverse();b=HTML.tmpl("breadcrumb_li_tmpl",{breadcrumbs:f});$("browse-location").__sert(b);c=$("breadcrumb-dropdown");e=function(h){var g;h.stopPropagation();c.show();g=$j(a);return $j(c).clonePosition(g,{setWidth:0,setHeight:0,offsetTop:g[0].offsetHeight,offsetLeft:parseInt(g.css("padding-left"),10)})};a.observe("click",e);a.observe("dragover",e);return document.observe("click",function(){a.removeClassName("down");return c.hide()})},viewportOffset:function(){var a,c,b;if(!this.files.length){return}if(!this.div_parent){c=this.files[0].get_div().offsetParent;if(!c){return}this._viewportOffset={};this.div_parent=$(c);this._cumulativeOffset=this.div_parent.cumulativeOffset()}a=Util.scrollLeft(this.div_parent);b=Util.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==b||this.scrollLeft!==a){this._viewportOffset.top=this._cumulativeOffset.top-b;this._viewportOffset.left=this._cumulativeOffset.left-a;this.scrollLeft=a;this.scrollTop=b}return this._viewportOffset},selectable:function(){return Util.enableSelection($("browse-files"))},unselectable:function(){return Util.disableSelection($("browse-files"))},_header_offset:(function(){var a;a=$("browse-header");return a.getHeight()+a.cumulativeOffset().top}).cached(1000),scrollTo:function(a){return this.scrollToWithPadding(a,3)},scrollToWithPadding:function(d,f){var c,g,b,e,a;if(!d){return}e=Util.viewport_dimensions();a=Util.scroll_offsets();g=d.cumulativeOffset().top-a.top;c=d.getHeight();b=this._header_offset();if(g<b){Util.scroll_to(0,a.top+g-b-f)}else{if(g+c>e.height){Util.scroll_to(0,a.top+g+c-e.height+f)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return Modal.fix_position()}}};BrowseUpdate=(function(){var a,h,g,d,f,e,c,b;c=function(j){var k,l,i;if(!Browse.inside_dir){return}l=j.parent_changes;if(l.change_to_fq_path!=null){if(l.change_type==="moved"){if(l.is_changing_view){k=_("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been moved")}}else{if(l.change_type==="renamed"){if(l.is_changing_view){k=_("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been renamed to '%s'.");i=l.change_to_fq_path.split("/");k=k.format(i[i.length-1].escapeHTML())}}else{k=_("The folder '%s' has been deleted.");k=k.format(l.old_fq_path.escapeHTML())}}if(l.is_changing_view){Notify.server_error(new HTML(k))}else{if(l.old_fq_path===Browse.containing_fq_path()){Notify.server_success(new HTML(k))}}Browse.reload_fqpath(l.change_to_fq_path);return}return e(j)};b=function(n){var j,q,p,i,s,o,l,r,m,k;q=[];o=[];if(!Browse.in_search_mode()){return}FileSearch.clear_cache();for(i in Browse.ns_id_to_mount_point){if(!(i in n.mount_points)){n.mount_points[i]=null}}m=n.mount_points;for(i in m){p=m[i];i=parseInt(i,10);s=Browse.ns_id_to_mount_point[i];if(p===s){continue}if(p){Browse.ns_id_to_mount_point[i]=p}else{delete Browse.ns_id_to_mount_point[i]}k=Browse.files;for(l=0,r=k.length;l<r;l++){j=k[l];if(j.fq_path.indexOf(s)===0&&j.target_ns!==i){if(p){j.fq_path=p+j.fq_path.slice(s.length);j.href=Util.get_browse_root(Browse.active_user)+p+j.href.slice(5+s.length);q.push([j,j])}else{o.push(j)}}}}return e(n,[],o,q)};e=function(B,q,w,p){var o,x,t,v,u,z,r,l,j,i,y,C,A,s,n,m,k;if(q==null){q=[]}if(w==null){w=[]}if(p==null){p=[]}s=B.added;for(l=0,y=s.length;l<y;l++){x=s[l];o=Util.normalize(Util.parentDir(x.ns_path));if(Browse.in_search_mode()||(x.ns_id===Browse.containing_ns_id()&&o===Browse.containing_ns_path())){q.push(BrowseUtil.make_browsefile(x))}}n=B.removed;for(j=0,C=n.length;j<C;j++){t=n[j];w.push(Browse.find_file(t))}m=B.moved;for(i=0,A=m.length;i<A;i++){k=m[i],v=k[0],r=k[1];z=Util.normalize(Util.parentDir(r.ns_path));u=null;if(Browse.in_search_mode()||(r.ns_id===Browse.containing_ns_id()&&z===Browse.containing_ns_path())){u=BrowseUtil.make_browsefile(r)}p.push([Browse.find_file(v),u])}document.fire(UpdateEvents.ADD,{files:q});document.fire(UpdateEvents.MOVE,{files:p});BrowseUtil.load_visible_thumbs();return f(q,w,p)};a=function(l,j,k,i){l.css("background","");return document.fire(UpdateEvents.REMOVE,{files:k})};f=function(s,r,t){var k,v,p,w,o,n,l,u,j,i,q,m;p=(s.length+r.length)<=10;for(o=0,u=s.length;o<u;o++){k=s[o];if(!(k&&k.get_div())){continue}h(k,p,s,r,t)}for(n=0,j=r.length;n<j;n++){k=r[n];if(!(k&&k.get_div())){continue}d(k,p,s,r,t)}m=[];for(l=0,i=t.length;l<i;l++){q=t[l],v=q[0],w=q[1];if(v){d(v,p,s,r,t)}if(w){m.push(h(w,p,s,r,t))}else{m.push(void 0)}}return m};g=function(i){var j;j=BrowseSelection.is_selected(i)?"#83B8DC":"#CCEAFF";return $j(i.get_div()).css("background-color",j)};d=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.show().slideUp("normal",function(){return a(n,k,m,j)})}else{n.hide();return a(n,k,m,j)}};h=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.hide().slideDown("normal",function(){return a(n,k,m,j)})}else{n.show();return a(n,k,m,j)}};return{init:function(){var j,i;i=NOTCLIENTS[Browse.active_user.id];return j=i.subscribe_sfj({name:"BrowseUpdater",handler:function(){var r,n,p,m,k,o,l,q=this;m=Browse.in_search_mode();r=m?b:c;l=m?"/update/list_search":"/update/list_dir";if(!(Browse.inside_dir||m)){i.handler_failure(j);return}if(m){o=FileSearch.get_state();if(o.is_advanced){p=o}else{p={all_terms:o.query}}}else{p={fq_dir:Browse.containing_fq_path(),show_deleted:Browse.deleted_shown}}p.ns_map=((function(){var t,s;t=i.get_ns_map();s=[];for(n in t){k=t[n];s.push(""+n+"_"+k)}return s})()).join(",");assert(Browse.active_user,"No active_user was set before calling "+l+". Active user loaded? "+(window.active_user_loaded||false)+".            Error before loading? "+(window.an_error_happened_before_loading||false)+".            Error after loading? "+(window.an_error_happened_after_loading||false)+".",true,[],false);return new $j.ajax(l,{data:p,dataType:"json",type:"POST",subject_user:Browse.active_user,success:function(s){r(s);return i.handler_success(j,{ns_map:s.ns_map})},error:function(){return i.handler_failure(j)}})}})}}})();var FileEvents;FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove"};var Job,ModalProgress,ProgressBar,ProgressWatcher;ProgressBar={MAGIC:42,make:function(a,b,c){var j,h,i,e,g,d,f;if(b==null){b=300}f=b.toString()+"px";c=(typeof c!=="undefined"?c:"0%");i=new Element("div",{"class":"outer-progress-bar",style:"width: "+f});j=new Element("div",{"class":"inner-progress-bar",id:"pb_"+a,style:"width: "+f});g=new Element("div",{"class":"under-pb progress-bar",style:"width: "+f});e=new Element("div",{style:"display: none","class":"over-pb progress-bar",id:"pb_"+a+"_over"});d=new Element("div",{"class":"pb-percentage",id:"pb_"+a+"_upct",style:"width: "+f});d.update(c);h=new Element("div",{"class":"pb-percentage",id:"pb_"+a+"_opct",style:"width: "+f});h.update(c);g.__sert(d);e.__sert(h);j.__sert(g);j.__sert(e);i.__sert(j);e.progress_width=b;return i},reset:function(a){return ProgressBar.set(a,0)},set:function(e,a,d){var c,b;a=Math.min(a,1);d=(typeof d!=="undefined"&&d!==false?d:Math.floor(a*100).toString()+"%");c=$("pb_"+e+"_over");if(!c){return}b=c.progress_width*a;c.show();c.makeClipping().setStyle({width:b.toString()+"px",backgroundColor:"#348DD3"});$("pb_"+e+"_upct").innerHTML=d;return $("pb_"+e+"_opct").innerHTML=d}};ModalProgress={show:function(c,a){var b;if(!c){return}a=$(a)||$("browse-box")||$("gallery-view-media");b=$("modal-progress-overlay");if(!(a!=null)){b.setStyle({position:"fixed",width:"100%",height:"100%"})}else{$j(b).clonePosition($j(a))}if(!b.getWidth()){return}$("modal-progress-text").__date(c);$("modal-progress-bar").setOpacity(1);$("modal-progress-bar").__date(ProgressBar.make("modal-progress",150,""));$j(b).fadeTo(250,0.7);return $j("#modal-progress-content").fadeIn(250)},update:function(a){var b;if(a.indexOf("/")>0){b=a.split("/");a=Number(b[0])/Number(b[1])}if(a){return ProgressBar.set("modal-progress",a,"")}},hide:function(){$j("#modal-progress-overlay").fadeOut(250);return $j("#modal-progress-content").fadeOut(250)}};Job={complete:{},handled:function(a){var b;if(!a){return false}b=!!Job.complete[a];Job.complete[a]=true;return b},peek:function(a){if(!a){return false}return !!Job.complete[a]}};ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(a,e){var d,c,b;if(a.async_task_id){if(!a.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}c=a.async_task_id}else{c=a.job_id}ProgressWatcher.job_info[c]={};d=ProgressWatcher.job_info[c];d.subject_user=a.subject_user||((b=a.parameters)!=null?b[Constants.UID_PARAM_NAME]:void 0);d.req=a;d.is_async_task=!!a.async_task_id;d.poll_int=ProgressWatcher.INIT_POLL_INT;d.poll_count=0;d.int_id=setInterval(ProgressWatcher.update_for(c),d.poll_int);d.failures=0;d.start_time=Util.time();return d.dont_hide=e},update_for:function(a){return function(){return ProgressWatcher.update(a)}},backoff:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);a.poll_int=Math.min(Math.floor(a.poll_int*1.5),30000);return a.int_id=setInterval(ProgressWatcher.update_for(b),a.poll_int)},update:function(c){var a,b;b=ProgressWatcher.job_info[c];if(Job.peek(c)){return ProgressWatcher.done(c)}b.poll_count++;if(b.poll_count%10===0){ProgressWatcher.backoff(c)}if(!b.modaled&&Util.time()-b.start_time>ProgressWatcher.MODAL_WAIT_MS){a=b.req.options;ModalProgress.show(a.progress_text,a.cover_this);a.onProgress=ModalProgress.update;if(a.on_modal_shown!=null){a.on_modal_shown()}b.modaled=true}if(b.is_async_task){return ProgressWatcher.get_async_task_status(c)}else{return ProgressWatcher.get_job_status(c)}},get_job_status:function(a){return new Ajax.DBRequest("/job_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},subject_user:ProgressWatcher.job_info[a].subject_user,onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(b.indexOf("err")===0){ProgressWatcher.done(a);if(d.req.options.onFailure&&!Job.handled(a)){d.req.options.onFailure(c)}return}if(b.indexOf("done")===0){d.req.options.job=false;if(!Job.peek(a)){new Ajax.Request("/job_results/"+a,{method:"post",parameters:{t:Constants.TOKEN},onSuccess:function(f){if(Job.handled(a)){return}Notify.clear_if(RequestWatcher.working_msg);if(d.req.options.onSuccess){return d.req.options.onSuccess(f)}},onFailure:function(f){if(Job.handled(a)){return}Notify.clear_if(RequestWatcher.working_msg);if(d.req.options.onFailure){return d.req.options.onFailure(f)}}})}return ProgressWatcher.done(a)}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){if(c.req.options.onFailure){c.req.options.onFailure(b,true)}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},get_async_task_status:function(a){return new Ajax.DBRequest("/async_task_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},subject_user:ProgressWatcher.job_info[a].subject_user,onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(!(b.indexOf("done:")&&b.indexOf("err:"))){Job.handled(a);Notify.clear_if(RequestWatcher.working_msg);if(b.indexOf("done:")===0){c.responseText=b.substr(5)}if(d.req.options.onSuccess){d.req.options.onSuccess(c)}if(d.req.options.onComplete){d.req.options.onComplete(c)}return ProgressWatcher.done(a)}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){if(c.req.options.onFailure){c.req.options.onFailure(b,true)}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},done:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);if(!a.dont_hide){delete ProgressWatcher.job_info[b];if(!(a.req.async_task_id&&a.req.async_task_id!==b)){return ModalProgress.hide(b)}}else{return ModalProgress.update("1/1")}}};var EventDatePicker,Events,NamespaceEvents;NamespaceEvents=(function(){function a(b){this.ns_id=b;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return a})();EventDatePicker=(function(){function a(c){var b,d,e,f=this;this.on_change=c;$j(document.body).on("click",function(g){return f.hide_calendar(g)});e=new Element("div",{id:"cal_container"});$j(e).bind("click",function(g){return g.preventDefault()});$j(document.body).append(e);this.calendar=new DBCalendar("cal_container",{onDateChange:function(g){return f.on_change(g)},disable_future:true});$j(e).css("position","fixed");d=$j("#cal_date");b=$j("#cal_container");b.clonePosition(d,{setWidth:false,setHeight:false,offsetTop:d.height(),offsetLeft:d.width()-b.children().first()[0].offsetWidth});this.hide_calendar()}a.prototype.show_calendar=function(b){if(this.shown){$j("#cal_container").hide();this.shown=false;return}$j("#cal_container").show();return this.shown=true};a.prototype.hide_calendar=function(b){if(b&&$j(b.target).closest("#cal_date").length>0){return}$j("#cal_container").hide();this.shown=false;return true};return a})();Events={ns:null,role:"all",now:Number(new Date()),timestamp:Util.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(a,e,f){var c,d,b,g=this;b=DBHistory.deconstruct_url();this.first_event_map=JSON.parse(a);this.date_picker=new EventDatePicker(function(h){g.change_date(h);return g.set_url()});this.roles=JSON.parse(e);this.rss_data=JSON.parse(f);if(this.roles.length===1){this.role=this.roles[0].role}this._init_state();this.role_picker=$j("#role-selector").controller();this.role_picker.on_state_change=function(){g.role=g.role_picker.get_state();if(g.ns&&!$u(g.valid_roles()).any(function(h){return h.ns_ids.contains(g.ns.ns_id)})){g.ns=null;ULSelectMenu.set_selected_by_value($j("#namespace-list")[0],"false")}g.set_url();return g.get_more(true)};MultiaccountLogin.set_during_login_callback(function(i,h){return window.location.reload()});$j(window).bind("beforeunload",function(){g.user_navigated_away=true;return void 0});$j("#namespace-list-container")[0].observe("db:change",function(h){g.ns=g.namespaces[JSON.parse(h.memo)];g.set_url();return g.get_more(true)});$j(window).on("scroll",function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-Util.viewport_dimensions().height-10);return g.get_more()});if(b.qargs.ns){ULSelectMenu.set_selected_by_value($j("#namespace-list")[0],b.qargs.ns);this.ns=this.namespaces[b.qargs.ns]}if(b.qargs.role){setTimeout((function(){return g.role_picker.set_state(b.qargs.role)}),10)}if(b.qargs.date){d=b.qargs.date.split("-").map(Number);c=new Date(d[2],d[1]-1,d[0]);this.date_picker.calendar.selected_date=c;this.change_date(c)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var b,e,h,f,d,c,g,a;this.namespaces={};g=$u(this.roles).values();for(h=0,d=g.length;h<d;h++){e=g[h];a=e.ns_ids;for(f=0,c=a.length;f<c;f++){b=a[f];this.namespaces[b]=new NamespaceEvents(b)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(a){this.timestamp=Number(a)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}$j("#cur_date_text").text(DateUtil.localize(a));return this.get_more(true)},is_scrolled_down:function(){var a,c,b;b=Util.scroll_offsets().top;c=Util.viewport_dimensions().height;a=$j("#events").height();return b+c+50>=a},get_more:function(d){var a,b,c=this;if(this.request_in_flight){return}if($u(this.valid_nss()).all(function(e){return e.done})){this.render();return}if(!(d||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();b=function(){return $u(c.valid_nss()).map(function(e){return e.ns_id}).join(",")};a=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:{page_size:25,ns_ids:b(),timestamp:a},onSuccess:function(r){var p,f,s,h,q,n,m,j,t,g,e,o,l,i,k;p=JSON.parse(r.responseText);c.request_in_flight=false;o=p.events;for(n=0,t=o.length;n<t;n++){f=o[n];f.html=$j(f.html)[0];q=f.pkey+" "+f.html.innerText;s=c.namespaces[f.ns_id];if(!s.seen[q]){s.events.push(f);s.seen[q]=true;s.earliest=f.timestamp}}if(p.events.length>0){l=p.ns_ids;for(m=0,g=l.length;m<g;m++){h=l[m];c.namespaces[h].earliest=$u(p.events).map(function(u){return u.timestamp}).min()}}c.render();if(p.events.last()){return c.get_more()}else{if($u(p.ns_ids).join(",")!==b()){return c.get_more()}else{i=p.ns_ids;k=[];for(j=0,e=i.length;j<e;j++){h=i[j];k.push(c.namespaces[h].done=true)}return k}}},onError:function(){c.request_in_flight=false;if(!c.user_navigated_away){return Notify.server_error(_("We had problems loading your events feed; please try again later."))}}})},valid_roles:function(){var a=this;if(this.role!=="all"){return $u(this.roles).filter(function(b){return b.role===a.role})}else{return this.roles}},valid_nss:function(){var a=this;if(this.ns){return[this.ns]}else{return $u(this.valid_roles()).map(function(b){return b.ns_ids}).flatten().map(function(b){return a.namespaces[b]}).uniq()}},earliest:function(){var a=this;return $u(this.valid_nss()).map(function(b){return b.earliest}).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){var a=this;this.date_picker.calendar.options.first_day=Util.start_of_day(new Date($u(this.valid_nss()).map(function(b){return a.first_event_map[b.ns_id]}).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=Util.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var b,c,a;a=new Date(this.timestamp-this.one_day);c=this.now-this.timestamp>0;b={};if(this.ns){b.ns=this.ns.ns_id}if(this.role!=="all"){b.role=this.role}if(c){b.date=""+(a.getDate())+"-"+(a.getMonth()+1)+"-"+(a.getFullYear())}return DBHistory.push_state("/events",b)},render:function(){var a,p,q,k,r,i,u,n,c,j,m,h,b,g,e,d,s,t,l,f,o=this;if(this.date_picker.calendar){this.update_calendar_first_day()}u=this.role;a=$u(this.valid_nss()).map(function(v){return v.events}).flatten();p=this.earliest();b=$u(a).sortBy(function(v){return -v.timestamp});k=$u(b).filter(function(v){return v.timestamp>=p&&v.timestamp<o.timestamp/1000&&(o.ns!==null||!v.is_dup)});if(k.length>0){$j("#event-table").empty();for(e=0,s=k.length;e<s;e++){j=k[e];q=$j(j.html);m=$u(this.valid_roles()).filter(function(v){return v.ns_ids.contains(j.ns_id)}).map(function(v){return v.name}).join(" & ");q.find("span.role-label > span").text(m);$j("#event-table").append(q)}$j("#events-container").show();$j(".empty-explanation").hide();$j(".page-explanation").show();$j("#events-empty-state").hide()}else{if(!this.request_in_flight){$j("#events-container").hide();$j(".page-explanation").hide();$j("#events-empty-state").show();$j(".empty-explanation").show()}else{$j(".empty-explanation").show();$j(".page-explanation").show();$j("#events-empty-state").hide();$j(".empty-explanation").hide()}}if(!this.request_in_flight){$j("#more-loading").hide()}else{$j("#more-loading").show()}$j("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");i=0;l=$j("#namespace-list > li");for(d=0,t=l.length;d<t;d++){r=l[d];c=$u(this.valid_roles()).map(function(v){return v.ns_ids}).flatten().any(function(v){return v===$j(r).data("value")});n=$j(r).data("value")===false;g=n||c;$j(r).css("display",g?"":"none");if(g){i+=1}}if(i===1){$j("#namespace-list-container").hide()}else{$j("#namespace-list-container").show()}h=this.rss_data[(f=this.ns)!=null?f.ns_id:void 0]||this.rss_data[u];if(h){$j("#rss-feed a").attr("data-title",h.title);$j("#rss_url").val(h.url);$j("#reset-rss-link").attr("href","/reset_rss/"+h.ns_id);$j("#rss_url").focus();return $j("#rss-feed").show()}else{return $j("#rss-feed").hide()}},show_rss_modal:function(){Modal.icon_show("feed_32",_("Subscribe to this RSS feed"),$j("#rss-modal")[0]);return Util.addCopyUrlFlash($j("#rss_url").val())}};var DateUtil;DateUtil={fromSecondsSinceEpochUTC:function(a){var b;b=new Date(1970,0,1);b.setSeconds(a);return b},utcnow:function(){var a;a=new Date();return new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds())},applyTimezoneOffset:function(b,d){var a,c;a=parseInt(d,10);c=60*(d-a);b.setHours(b.getHours()+a);return b.setMinutes(b.getMinutes()+c)},contextualFormat:function(b){var d,f,a,c,e;a=this.utcnow();c=(a.getTime()-b.getTime())/1000;d=0;if(c<8*3600){return this.ago(b)}this.applyTimezoneOffset(a,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(b,Constants.TIMEZONE_OFFSET);e=this.utcnow();this.applyTimezoneOffset(e,Constants.TIMEZONE_OFFSET);e.setDate(e.getDate()-1);if(b.getYear()===a.getYear()&&b.getMonth()===a.getMonth()&&b.getDate()===a.getDate()){f=_("Today %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{if(b.getYear()===e.getYear()&&b.getMonth()===e.getMonth()&&b.getDate()===e.getDate()){f=_("Yesterday %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{return DateUtil.format(b,Constants.datetime_format)}}},toUTCDate:function(a){return new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds())},differenceStr:function(d,g){var i,h,b,c,e,a,f;e=(d.getTime()-g.getTime())/1000;if(e<60){return ungettext("%d sec","%d secs",e).format(e)}else{if(e<3600){b=parseInt(e/60,10);return ungettext("%d min","%d mins",b).format(b)}else{if(e<86400){h=parseInt(e/3600,10);return ungettext("%d hour","%d hours",h).format(h)}else{if(e<2592000){i=parseInt(e/(60*60*24),10);return ungettext("%d day","%d days",i).format(i)}else{if(e<4838400){a=parseInt(e/(60*60*24*7),10);return ungettext("%d week","%d weeks",a).format(a)}else{if(e<31536000){c=parseInt(e/(60*60*24*30),10);return ungettext("%d month","%d months",c).format(c)}else{f=parseInt(e/(60*60*24*365),10);return ungettext("%d year","%d years",f).format(f)}}}}}}},ago:function(e){var i,h,c,d,f,b,a,g;b=this.utcnow();f=(b.getTime()-e.getTime())/1000;if(f<60){return ungettext("%d sec ago","%d secs ago",f).format(f)}else{if(f<3600){c=parseInt(f/60,10);return ungettext("%d min ago","%d mins ago",c).format(c)}else{if(f<86400){h=parseInt(f/3600,10);return ungettext("%d hour ago","%d hours ago",h).format(h)}else{if(f<2592000){i=parseInt(f/(60*60*24),10);return ungettext("%d day ago","%d days ago",i).format(i)}else{if(f<4838400){a=parseInt(f/(60*60*24*7),10);return ungettext("%d week ago","%d weeks ago",a).format(a)}else{if(f<31536000){d=parseInt(f/(60*60*24*30),10);return ungettext("%d month ago","%d months ago",d).format(d)}else{g=parseInt(f/(60*60*24*365),10);return ungettext("%d year ago","%d years ago",g).format(g)}}}}}}},localize:function(a){assert(Constants.date_format!=null,"Date format missing.");return DateUtil.format(a,Constants.date_format)},format:function(a,b){var c,d=this;assert(typeof b==="string","Date format requires a format string");c={yy:function(){return a.getFullYear().toString().substring(2)},yyyy:function(){return a.getFullYear().toString()},M:function(){return(a.getMonth()+1).toString()},MM:function(){return(a.getMonth()+1).toString().lpad(2)},d:function(){return a.getDate().toString()},dd:function(){return a.getDate().toString().lpad(2)},h:function(){return(a.getHours()%12||12).toString()},H:function(){return a.getHours().toString()},HH:function(){return a.getHours().toString().lpad(2)},m:function(){return a.getMinutes().toString()},mm:function(){return a.getMinutes().toString().lpad(2)},a:function(){if(a.getHours()>11){return _("PM")}else{return _("AM")}}};return b.replace(/([a-zA-Z]+)/g,function(e){if(c[e]!=null){return c[e]()}else{return e}})}};var Timezone;Timezone={check_timezone:function(){var a;if(!viewer.is_signed_in){return}a=Timezone.get_current_timezone();if(!(Constants.auto_timezone_offset!=null)||Constants.auto_timezone_offset!==a){return Timezone.update(a)}},get_current_timezone:function(){var d,c,a,b;c=new Date();c.setSeconds(0);c.setMilliseconds(0);b=c.toGMTString();d=new Date(b.substring(0,b.lastIndexOf(" ")));a=(c-d)/(1000*60*60);return a},update:function(a){assert(typeof a==="number","Timezone offset was not a number: "+a);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:a},noAutonotify:true})},update_timezones_dropdown:function(b,d){var c,a;if(d==null){d=null}a=Timezone.timezones_by_country[b];$j("#timezone_id").empty();$j("#timezone_id").append((function(){var g,f,e;e=[];for(g=0,f=a.length;g<f;g++){c=a[g];e.push($j('<option value="'+c.id+'">'+c.name+"</option>").prop("selected",c.id===d))}return e})());return Util.syncHeight()},auto:function(){var a;a=$F("timezone_auto");if(a){$j("#tz").hide()}else{if(Timezone.default_country){$j("#timezone_country").val(Timezone.default_country);Timezone.update_timezones_dropdown(Timezone.default_country)}$j("#tz").show()}return Util.syncHeight()},load_data:function(b,a){Timezone.timezones_by_country=b;return Timezone.default_country=a}};var Apps;Apps={init_create_app:function(c){var a,b;a=EmailVerification.getForRole(c);if(!a.verified()){a.show_verify_modal()}b=$j("#create-app-form");b.find("input[type=radio]").change(function(d){var e;e=d.target.name;b.find("input[name="+e+"]").each(function(){$j(this).parents("label").removeClass("active");return b.removeClass($j(this).data("next"))});$j(d.target).parents("label").addClass("active");return b.addClass($j(this).data("next"))});b.find("input[type=checkbox]").change(function(d){var e;$j(d.target).parents("label").toggleClass("active");e=b.find("input[name="+($j(this).attr("name"))+"]:checked");b.toggleClass($j(this).data("next"),e.length!==0)});b.find("input:checked").trigger("change");return b.submit(function(d){if(a.verified()){b=$j(d.target);Forms.ajax_submit(b[0],false,(function(e){return window.location.href=e.responseText}))}return false})},init_apps:function(){return $j("#show-disabled-apps").click(function(){$j(this).parent().hide();$j("#disabled-apps").show();return false})},init_app_info:function(a){$j("#app-info .icon-container").each(function(c,d){var b;b=$j(d);return b.append(Dropbox.createChooseButton({success:function(e){b.find(".icon").attr("src",e[0].thumbnailLink);return b.find("input[type=hidden]").val(e[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=HTML.tmpl("hoverable_tmpl");$j("#domain-list").on("click",".img-container",function(b){Apps.remove_domain(b.currentTarget.parentNode,a)});$j("#oauth-uri-list").on("click",".img-container",function(b){Apps.remove_oauth_uri(b.currentTarget.parentNode,a)});$j("#webhook-list").on("click",".img-container",function(b){Apps.remove_webhook(b.currentTarget.parentNode,a)});this.init_app_info_add_redirect_uri();return $j("#oauth2-allow-implicit-grant").on("change",function(b){return Apps.set_oauth2_allow_implicit_grant(b.currentTarget,a)})},init_app_info_add_redirect_uri:function(){var a,b,c,d;b=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!b){return}d=window.decodeURIComponent(b[1]);a=$j("#oauth-add-uri-form");$j("input[name=oauth_uri]",a).val(d);c=$j("#add-redirect-uri-modal")[0];$j("#add-redirect-uri-modal-uri").text(d);Modal.icon_show("alert_32",_("Add OAuth redirect URI"),c,{doit:function(){var e;if(window.history&&window.history.replaceState){e=window.location.href;e=e.substring(0,e.indexOf("#"));window.history.replaceState({},document.title,e)}else{window.location.hash=""}Modal.hide();return Apps.submit_new_oauth_uri($j("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(b){var a=this;this.ds_info=b;if(viewer.is_paired){this.role_picker=$j("#role-selector").controller();this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return MultiaccountLogin.set_during_login_callback(function(d,c){return a.app_datastores_browse_reload_info(function(){return c()},function(){c("Error displaying datastores");return window.location.reload()})})}},app_datastores_browse_reload_info:function(c,a){var b=this;$j.ajax({url:"/developers/apps/datastores/info",success:function(d){b.ds_info=d;b.app_datastores_browse_render();return typeof c==="function"?c():void 0},error:function(d){return typeof a==="function"?a(d):void 0}});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var c,b,a,d;b=$j("#no_apps_container").empty();if($j("#apps_developed_container").children().length!==0||$j("#apps_used_container").children().length!==0){return}c=$j("<div class='empty-state'></div>").appendTo(b);switch((d=this.role_picker)!=null?d.get_state():void 0){case RolePickerState.PERSONAL:case RolePickerState.WORK:a=viewer.get_user_by_role(this.role_picker.get_state());return c.append("You don't have any datastores in your "+Util.role_title_for_user(a)+" Dropbox.");default:return c.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(h){var b,g,d,f,e,c,a;f=this.app_datastores_browse_get_id_info(h);g=$j(h);g.empty();b="";for(c=0,a=f.length;c<a;c++){d=f[c];if(this.app_datastores_should_render(d.uid)){b+=d.html}}if(b){g.append(this.app_datastores_browse_get_id_header(h));e=$j("<div class='app-list clearfix'/>").appendTo(g);return e.html(b)}},app_datastores_should_render:function(b){var a;if(this.role_picker!=null){a=viewer.get_user_by_id(b);return this.role_picker.is_role_visible(a.role)}else{return true}},app_datastores_browse_get_id_info:function(a){switch(a){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return assert(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(a){switch(a){case"#apps_developed_container":return $j("<h2>Apps you develop</h2>");case"#apps_used_container":return $j("<h2>Apps you use</h2>");default:return assert(false,"invalid ds group id")}},confirm_disable:function(d,c,b){var e,a;e=(b?_("Are you sure you want to disable '%(app_name)s'?"):_("Are you sure you want to delete '%(app_name)s'?"));DomUtil.fillVal(e.format({app_name:d.escapeHTML()}),"app-disable-text");Modal.show((b?_("Confirm disable"):_("Confirm delete")),$("app-disable-modal"));a="/developers/disable_app/"+c;$("app-disable-modal").down("form").action=a;return $("disable-app-button").setValue((b?_("Disable"):_("Delete")))},enable_app:function(b){var a;a="/developers/enable_app/"+b;return window.location.href=a},show_uninstall:function(g,f,c,b,d,a){var h;if(g){Event.stop(g)}Modal.vars={app_id:c,delete_row_type:"inst-app",action:"uninstall_app",user_id:a};h=$j("#delete-"+b+"-app-confirm");if(b==="sandbox"){if(!d){return Apps.do_action()}$j(".app_folder",h).text(d)}$j(".app_name",h).text(f);Modal.show(_("Remove %(app_name)s?").format({app_name:f.em_snippet(22)}),h[0],Modal.vars);return null},do_uninstall:function(){var a;a=Modal.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(b){var c;Notify.server_success(b.responseText);c=$j(".apps-"+a);$j("#inst-app-"+Modal.vars.app_id+"-row",c).hide().removeClass("active_app");if($j(".active_app",c).length===0){c.hide()}if($j(".active_app").length===0){$j("#empty-explanation").text(_("You have no apps linked to your Dropbox."));return $j("#applications-explanation",c).remove()}},subject_user:a});return Modal.hide()},do_action:function(){return new Ajax.DBRequest("/api/"+Modal.vars.action,{parameters:{app_id:Modal.vars.app_id},onSuccess:function(a){Notify.server_success(a.responseText);if(Modal.vars.delete_row_type){return $(Modal.vars.delete_row_type+"-"+Modal.vars.app_id.toString()+"-row").hide()}else{return window.location.reload()}}})},enable_users_in_dev:function(a,b){new Ajax.DBRequest("/developers/enable_users_in_dev/"+a,{onSuccess:function(c){Modal.icon_show("alert_32",_("Limit raised to %d users").format(b),$("increased-dev-user-limit-modal"));$j("#users-in-dev-none, #users-in-dev-some").hide();return $j("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(a){Modal.icon_show("alert_32",_("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+a,{onSuccess:function(b){$j("#current-app-users-1, #current-app-users-2").text("0");return Modal.hide()}})}});return false},restore_sandbox:function(b,d,a){var f,c,e;f=$j("#restore-sandbox")[0];Modal.icon_show("folder_app_32",_("Restore app folder '%(filename)s'").format({filename:Util.filename(d).em_snippet(17)}),f);e=$j("#restore-sandbox-form")[0];c={ns_id:a};c[Constants.UID_PARAM_NAME]=b.id;return Forms.add_vars(e,c)},submit_restore_sandbox:function(b){var a;a=$("restore-sandbox-form");Forms.ajax_submit(a,false,(function(c){Modal.hide();Notify.server_success(_("Restored app folder"));if(c.responseText.length){return Browse.reload_fqpath(c.responseText)}else{return Browse.reload("","",true)}}),false,b.target);return false},submit_app_info:function(a){var b;b=$j(a).find("input[name=name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("App info updated.");if(b){return $j("#app-info h1").text(b)}}))},submit_folder_name:function(a){var b;b=$j(a).find("input[name=folder]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("App folder name updated.");$j("#folder-name .text").text(b);return Apps.hide_folder_input()}))},submit_new_webhook:function(a){var b;b=$j(a).find("input[name=webhook_url]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("Webhook URI added.");Apps.add_webhook(b);return $j(a).find("input[name=webhook_url]").val("")}))},add_webhook:function(a){var b;b=$j("#webhook-list");b.append(this._hoverable_tmpl({value:a}).toHTML());return b.show()},remove_webhook:function(c,b){var a,d;a=$j(c).find(".value").text();d=function(f){var e;Notify.server_success("Webhook URI removed.");e=c.parentNode;e.removeChild(c);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:b,webhook_url:a},dataType:"json",success:d,error:function(){return Notify.server_error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(b,a){return $j.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:a,allow:$j(b).val()},dataType:"json",success:function(c){return Notify.server_success("OAuth 2 allow implicit grant updated.")},error:function(){return Notify.server_error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(b){var a;a=$j(b).find("input[name=oauth_uri]").val();Forms.clear_errors(b);return Forms.ajax_submit(b,false,(function(){Notify.server_success("OAuth URI added.");Apps.add_oauth_uri(a);return $j(b).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(b){var a;a=$j("#oauth-uri-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_oauth_uri:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.server_success("OAuth URI removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:a,oauth_uri:d},dataType:"json",success:c,error:function(){return Notify.server_error("Unable to complete your request.")}})},submit_new_domain:function(a){var b;b=$j(a).find("input[name=domain_name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("Domain added.");Apps.add_domain(b);return $j(a).find("input[name=domain_name]").val("")}))},add_domain:function(b){var a;a=$j("#domain-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_domain:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.server_success("Domain removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:a,domain_name:d},dataType:"json",success:c,error:function(){return Notify.server_error("Unable to complete your request.")}})},show_need_users_modal:function(a){Modal.icon_show("alert_32",_("Please test this app"),$("app-need-users-modal"));return false},show_name_branding_modal:function(a){Modal.icon_show("alert_32",_("Please rename this app"),$("app-name-branding-modal"));return false},hide_folder_input:function(){$j("#folder-name").show();return $j("#folder-input").hide()},show_folder_input:function(){$j("#folder-name").hide();$j("#folder-input").show();return $j("#folder-input input[name=folder]").focus()}};var Twitter;window.twitter_auth_complete=function(a){assert(a!=null,"user_id must be provided");if(Twitter.onLoginSuccessCallback){Twitter.onLoginSuccessCallback(a)}else{window.location.reload()}return false};Twitter={is_authed:function(a){a=parseInt(a);if(!(Twitter._authed_users!=null)){Twitter._authed_users={}}return Twitter._authed_users[a]},set_is_authed:function(a,b){a=parseInt(a);if(!(Twitter._authed_users!=null)){Twitter._authed_users={}}return Twitter._authed_users[a]=b},get_progress_container:function(){var a;assert(Twitter.progress_container,"Twitter is missing progress_container");a=$(Twitter.progress_container);assert(a,"Missing progress_container elm");return a},follow_dropbox:function(b,a){var c;assert(a!=null,"user_id must be provided");if(b.showWorking){b.showWorking()}c=function(){if(b.onFailure){return b.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(d){if(!d.responseText.startsWith("ok")){return c()}else{if(b.onSuccess){return b.onSuccess()}}},onFailure:function(){return c()},subject_user:a})},do_auth:function(d,a){var c,b;assert(a!=null,"user_id must be provided");b=URI({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,a).toString();window.open(b,"twitter_auth","width=800,height=400");c=function(e){Twitter.set_is_authed(e,true);return typeof d==="function"?d(e):void 0};return Twitter.onLoginSuccessCallback=c},show_auth:function(a){if(a){Twitter.onLoginSuccessCallback=a}return DomUtil.updateFromElm(Twitter.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(Twitter.should_hide_modal()){Modal.hide()}return Twitter.get_progress_container().update(DomUtil.fromElm("sharing-progress"))},show_complete:function(b){var a;a=Twitter.get_progress_container();a.update(DomUtil.fromElm("sharing-posted"));return Twitter.show_complete_into(b,a)},show_complete_into:function(g,a){var d,e,c,f,b;d="twitter";f=_("View tweet");b=void 0;if(g.startsWith("ok")){b="http://www.twitter.com/"}else{b=g}e=a.down("#view-post");e.href=b;e.update(f);c=Sprite.make("web",d);return e.__sert({top:c})},post:function(d,f,c,a){var e,b;assert(a!=null,"user_id must be provided");assert(d,"Twitter message is empty");e={message:d,from_referrals:Twitter.from_referrals,from_getspace:Twitter.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:e,onSuccess:function(g){var h,i;if(g.responseText==="login"){Twitter.onLoginSuccessCallback=function(){return Twitter.post(d,null,null,a)};h=Twitter.custom_show_auth||Twitter.show_auth;return h()}else{if(Twitter.should_hide_modal()){Modal.hide()}i=Twitter.onPostSuccessCallback||Twitter.show_complete;return i(g.responseText)}},subject_user:a});b=Twitter.custom_show_posting||Twitter.show_posting;return b()},custom_post:function(b,c,a){assert(a!=null,"user_id must be provided");if(c){Twitter.onPostSuccessCallback=c}if(!b){return}assert(b,"Twitter message doesn't exist");if(!viewer.is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(b))}else{return Twitter.post(b,null,null,a)}},get_user_info:function(b,a){assert(a!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(c){return b(JSON.parse(c.responseText))},subject_user:a})},should_hide_modal:function(){if(typeof Twitter.hide_modal==="undefined"){return true}else{return Twitter.hide_modal}}};var FacebookOAuth;FacebookOAuth={get_progress_container:function(){var a;assert(FacebookOAuth.progress_container,"Facebook is missing progress_container");a=$j(FacebookOAuth.progress_container);assert(a.length,"Missing progress_container elm");return a},do_auth:function(c,a){var b;assert(a!=null,"user_id must be specified");b=window.open(URI({path:"/fb/access_token"}).updateQuery(Constants.UID_PARAM_NAME,a),"fb_auth","width=600,height=450");if(c){return FacebookOAuth.onLoginSuccessCallback=c}},show_posting:function(){Modal.hide();return FacebookOAuth.get_progress_container().html($j("#sharing-progress").html())},show_auth:function(a){if(a){FacebookOAuth.onLoginSuccessCallback=a}return DomUtil.updateFromElm(FacebookOAuth.get_progress_container()[0],"inline-facebook-auth")},show_complete:function(){var a,d,e,c,f,b;a=FacebookOAuth.get_progress_container();a.html(DomUtil.fromElm("sharing-posted"));d="facebook";f="View Post";b="http://www.facebook.com/profile.php?v=wall";e=a.down("#view-post");e.href=b;e.update(f);c=Sprite.make("web",d);return e.__sert({top:c})},post:function(g,f,e,d,h,a,b){var c;assert(b!=null,"user_id must be specified!");if(!viewer.is_signed_in){window.open("http://www.facebook.com/sharer.php?u="+encodeURI(f)+"&t="+encodeURI(e));return}c=FacebookOAuth.custom_show_posting||FacebookOAuth.show_posting;c();return new Ajax.DBRequest("/fb/post",{parameters:{message:g,link:f,link_name:e,description:d,from_referrals:FacebookOAuth.from_referrals,from_getspace:FacebookOAuth.from_getspace,picture:(h?h:"")},onSuccess:function(j){var i,k;i=j.responseText;if(i.startsWith("ok")){k=FacebookOAuth.custom_show_complete||FacebookOAuth.show_complete;return k()}else{if(i.startsWith("auth")){return FacebookOAuth.do_auth(function(){return FacebookOAuth.post(g,f,e,d,h,a,b)})}}},onFailure:function(){return typeof a==="function"?a():void 0},subject_user:b})}};var Scroll;Scroll={SCROLL_OFFSET:100,_get_cursor:null,_getting_more:false,_more_endpoint:null,_get_more_params:null,_render_more:null,_paused:true,_more:true,_scroller:null,init:function(b,c,d,f,e,a){this.SCROLL_OFFSET=b;this._more_endpoint=c;this._get_more_params=d;this._render_more=f;this._get_cursor=e;this._paused=false;this._more=true;return this._scroller=a},listen:function(){var a;return Event.observe((a=this._scroller)!=null?a:window,"scroll",this._window_scroll)},pause:function(){return this._paused=true},_window_scroll:function(){var c,b,a;if(Scroll._more){a=Util.scroll_offsets().top;b=Util.viewport_dimensions().height;c=document.body.getHeight();if(Scroll._scroller){if(Scroll._scroller.scrollTop+Scroll._scroller.offsetHeight+Scroll.SCROLL_OFFSET>=Scroll._scroller.scrollHeight){return Scroll._get_more()}}else{if(a+b+Scroll.SCROLL_OFFSET>=c){return Scroll._get_more()}}}},_get_more:function(){var a,b;if(Scroll._getting_more||Scroll._paused){return}Scroll._getting_more=true;if((b=$("more-loading"))!=null){b.show()}a={cursor:Scroll._get_cursor()};Object.extend(a,Scroll._get_more_params);return new Ajax.DBRequest(Scroll._more_endpoint,{method:"POST",parameters:a,onSuccess:function(d){var e,c;if((c=$("more-loading"))!=null){c.hide()}e=JSON.parse(d.responseText);Scroll._more=e.more;Scroll._render_more(e);return Scroll._getting_more=false}})}};var AllPhotosPhotoPreview,AllPhotosVideoPreview,LightboxPreviewBase,PhotoPreview,SingleCollectionPhotoPreview,SingleCollectionVideoPreview,VideoPreview,get_timeline_preview_classes,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};LightboxPreviewBase=(function(){function a(b){this.link_hash=b.link_hash;this.filename=b.filename;this.fq_path=b.fq_path;this.thumbnail_url_tmpl=b.thumbnail_url_tmpl;this.dl_url=b.dl_url;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.display_time=b.display_time||null;this.more_actions_item_tmpl=HTML.tmpl("lightbox_more_actions_item_tmpl")}a.prototype.preload=function(){};a.prototype.render=function(){};a.prototype.image_size=function(){var b;b=document.viewport.getDimensions();return Util.dimensions_to_imagesize(b.width,b.height)};a.prototype.get_more_actions_above_divider=function(c){var d,b;b=[];d=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,sprite_name:"lightbox_download",item_text:_("Download"),more_classes:"more-actions-item"});b.push(d);return b};a.prototype.get_more_actions_below_divider=function(b){return[]};a.prototype.is_a_timeline_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof AllPhotosPhotoPreview||this instanceof SingleCollectionVideoPreview||this instanceof AllPhotosVideoPreview};a.prototype.is_an_album_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof SingleCollectionVideoPreview};a.prototype.is_a_photo_preview=function(){return this instanceof PhotoPreview};a.prototype.is_a_video_preview=function(){return this instanceof VideoPreview};a.prototype.get_actions=function(f){var c,e,d,b,g=this;e=[];if(!this.is_a_timeline_preview()&&f.enable_sublinks){d=$j("<a />",{id:"lightbox_shmodel_link","class":"title_bubble black"});if(this.is_a_photo_preview()){d.attr("title",_("Share link to photo"))}else{if(this.is_a_video_preview()){d.attr("title",_("Share link to video"))}else{assert(false,"preview needs to be a photo or video")}}d.html(Sprite.make("web","link_white"));if(this.shmodel_link){d.attr("href",URI.parse(this.shmodel_link).updateQuery("m","1"));d.attr("target","_blank");b=function(h){return ShmodelUILogger.log("via-shmodel-lightbox")};d.on("click",b)}else{d.attr("href","#");b=(function(j){var h,i;j.preventDefault();ShmodelUILogger.log("via-browse-lightbox");h=String(URI({path:"/sm/create"+g.fq_path}));i={};i[Constants.UID_PARAM_NAME]=Browse.active_user.id;return Forms.postRequest(h,i,{target:"_blank"})});d.on("click",b)}e.push(d[0])}if(f.include_delete){c=$j("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:Photos.in_single_collection_view()?_("Remove"):_("Delete")});c.html(Sprite.make("web","lightbox_delete_16"));c.on("click",(function(h){h.preventDefault();return Lightbox.toggle_delete()}));e.push(c[0])}assert(Lightbox.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");e.push(Lightbox.more_actions_button);return e};a.prototype.delete_pressed=function(){var b;b=_("Deleting...");if(this.is_a_timeline_preview()){if(Photos.in_single_collection_view()){b=_("Removing...");Photos.get_current_collection().remove_photos([this.photo])}else{Photos._delete_photos([this.photo])}}else{document.fire(Lightbox.PHOTO_DELETE_EVT,this)}return Notify.server_success(b)};a.prototype.set_more_actions_event_handlers=function(b){};return a})();PhotoPreview=(function(b){__extends(a,b);function a(c){a.__super__.constructor.call(this,c);this.original_url=String(URI.parse(c.original_url).updateQuery(Constants.UID_PARAM_NAME,Browse.active_user));this.shmodel_link=c.shmodel_link;this.fail_image_src="/static/images/preview_fail.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false}a.prototype.show_fail=function(d){var c;return c=$j(d).find(".lightbox_fail_text").text(_("Unable to preview this item."))};a.prototype.fallback=function(d){var c,f;c=$(d.target);c.writeAttribute({src:this.fail_image_src,width:128,height:128});f=c.up("div.content-item");if(f){return this.show_fail(f)}};a.prototype.is_gif=function(){return"gif"===Util.file_extension(this.filename).toLowerCase()};a.prototype.preload=function(e){var d,f,c,g=this;c=URI.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){c=this.thumbnail_url_tmpl}f=function(){if(typeof e==="function"){e()}return g.loaded=true};Util.preload_image(c,this.fallback.bind(this),f);d=$(Util.preloaded_images[c]);d.writeAttribute("data-original-href",this.original_url);d.writeAttribute("class","thumbnail");return d};a.prototype.render=function(e){var f,d,g,c,h;if(this.loaded){e()}d=this.preload(e);h=$j("<div />").append(d);f=$j("<div />",{"class":"lightbox_fail_text"});$j(h).append(f);g=d.getAttribute("src").length;c=d.getAttribute("src").substring(g-this.fail_image_src.length,g);if(c===this.fail_image_src){this.show_fail(h)}return h[0]};a.prototype.advance_on_click=true;a.prototype.get_more_actions_above_divider=function(e){var d,c;c=a.__super__.get_more_actions_above_divider.call(this,e);d=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:_("View original"),more_classes:"more-actions-item"});c.push(d);return c};return a})(LightboxPreviewBase);VideoPreview=(function(a){__extends(b,a);function b(c){this._player_error=__bind(this._player_error,this);this._player_ready=__bind(this._player_ready,this);b.__super__.constructor.call(this,c);this.preview_url=c.preview_url;this.shmodel_link=c.shmodel_link;this.thumbnail_div=null;this.metadata_link=c.metadata_link!=null?c.metadata_link:void 0;this.metadata=null}b.prototype.render_error=function(){var d,c,e;d=new Element("div");c=new Element("img",{src:"/static/images/preview_fail.png","class":"video-preview-fail"});e=new Element("div",{"class":"video-preview-fail"});e.__sert(_("Unable to preview this item."));d.__sert(c);d.__sert(e);return d};b.prototype._player_ready=function(){var c;c=function(){return $j(".vjs-big-play-button").focus()};return c.defer()};b.prototype._player_error=function(c){this.div=this.render_error();return $j("#file-preview-modal .content-item").html(this.div)};b.prototype.preload=function(){};b.prototype.render=function(){this.div=this.render_video();return this.div};b.prototype.render_video=function(f){var c,h,e,d,i,g,j=this;if(!FlashDetect.installed){return this.render_error()}g=new Element("div",{"class":"video-player"});i=this.image_size().split("x")[0]*0.8;d=parseInt(i*0.55,10);h=false;e=URI.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();c=function(k){return j.metadata=k};VideoUtil.embed(g,{src:this.preview_url,type:"video/flv",width:i,height:d,controls:true,preload:"auto",poster:e,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:c});g.down(".video-js").setStyle({margin:"0 auto"});return g};return b})(LightboxPreviewBase);get_timeline_preview_classes=function(c){var a,b;a=(function(e){__extends(d,e);function d(f){f.ns_id=f.photo.ns_id;f.ns_path=f.photo.ns_path;d.__super__.constructor.call(this,f);this.photo=f.photo;TitleBubble.set_vertical_space(3);if(Photos.in_single_collection_view()){$j("#lightbox-delete-photo").val(_("Remove"))}else{$j("#lightbox-delete-photo").val(_("Delete"))}}d.prototype.get_more_actions_above_divider=function(h){var g,f;f=d.__super__.get_more_actions_above_divider.call(this,h);g=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:_("Add to album"),more_classes:"more-actions-item"});f.push(g);return f};d.prototype.toggle_select_button_off=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Select video"))}}f.html(Sprite.make("web","lightbox_unselected"));f.removeClass("selected");f.addClass("elbboggiw");return setTimeout((function(){return f.removeClass("elbboggiw")}),540)};d.prototype.toggle_select_button_on=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Un-select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Un-select video"))}}f.html(Sprite.make("web","lightbox_selected"));f.addClass("selected");f.addClass("wiggobble");return setTimeout((function(){return f.removeClass("wiggobble")}),540)};d.prototype.toggle_select=function(g){var f;g.preventDefault();f=$j("#lightbox-select-button");TitleBubble.hide_all();if(PhotosSelection.contains(this.photo)){PhotosSelection._remove(this.photo);return this.toggle_select_button_off(f)}else{PhotosSelection._add(this.photo);return this.toggle_select_button_on(f)}};d.prototype.get_actions=function(h){var g,f,j,i=this;g=[];j=$j("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});Lightbox.update_share_button_text(null,$j(j));j.on("click",(function(l){var k;l.preventDefault();k=PhotosSelection.get();if(k.length===0){return Foshmodal.show([i.photo],false)}else{return Foshmodal.show(PhotosSelection.get(),false)}}));f=$j("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:_("Select this photo")});if(PhotosSelection.contains(this.photo)){f.html(Sprite.make("web","lightbox_selected"))}else{f.html(Sprite.make("web","lightbox_unselected"))}f.on("click",this.toggle_select.bind(this));g.push(j[0]);g.push(f[0]);return g.concat(d.__super__.get_actions.call(this,h))};d.prototype.set_more_actions_event_handlers=function(f){var g=this;$("lightbox_add_to_album").observe("click",(function(h){h.preventDefault();return PhotosCollections.show_add_to_album_modal(h,[g.photo])}));$("lightbox_show_in_folder").observe("click",(function(h){h.preventDefault();return Photos.show_in_folder(g.photo)}));return d.__super__.set_more_actions_event_handlers.call(this,f)};d.prototype.get_more_actions_below_divider=function(h){var g,f;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:_("Show in folder"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};return d})(c);b=(function(e){__extends(d,e);function d(){return d.__super__.constructor.apply(this,arguments)}d.prototype.get_more_actions_below_divider=function(h){var f,g;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:_("Remove from album"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};d.prototype.set_more_actions_event_handlers=function(f){var g=this;$("lightbox_remove_from_album").observe("click",(function(h){h.preventDefault();return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),[g.photo])}));return d.__super__.set_more_actions_event_handlers.call(this,f)};return d})(a);return[a,b]};_ref=get_timeline_preview_classes(PhotoPreview),AllPhotosPhotoPreview=_ref[0],SingleCollectionPhotoPreview=_ref[1];_ref1=get_timeline_preview_classes(VideoPreview),AllPhotosVideoPreview=_ref1[0],SingleCollectionVideoPreview=_ref1[1];var Lightbox;Lightbox=(function(){var q,o,U,S,H,g,f,a,v,D,Y,R,C,M,m,L,A,I,X,l,O,N,e,t,Q,B,h,w,x,F,c,p,E,P,W,K,n,s,d,r,G,b,i,J,y,z,k,u,j,V;S=[];q=0;H=false;U=true;y=void 0;f="lightbox";a=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;g=false;Q=void 0;M=void 0;G=-1;b=null;I=null;l=function(Z){return Z.complete!==false};d=function(){var Z;if($$("#file-preview-modal .loading-image").length){return}Z=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black.gif"});return $$("#file-preview-modal .preview-content").first().__sert(Z)};A=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};x=function(){var af,ae,ab,Z,ad,ac,aa;ae=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!ae||!l(ae)){return}Z=$$("#file-preview-modal .preview").first().getDimensions();af=void 0;if(!ae.naturalHeight){af=ae.getDimensions();ae.naturalHeight=af.height;ae.naturalWidth=af.width}else{af={width:ae.naturalWidth,height:ae.naturalHeight}}ab=af.width/Z.width;aa=af.height/Z.height;ac=Math.max(ab,aa);ae.style.visibility="";if(ac<1){ae.style.width="";ae.style.height=""}else{ae.style.width=Math.floor(af.width/ac)+"px";ae.style.height=Math.floor(af.height/ac)+"px"}ad=$j("#file-preview-modal .paging-block").position().left-16;return $j("#file-preview-modal .filename").css("max-width",ad)};C=void 0;N=function(){var ag,ab,af,ae,ad,aa,ac,Z;ab=$("file-preview-modal");ae=ab.down(".menu");af=ab.down(".header");ac=$$(".lightbox-not-important");Z=[];for(ad=0,aa=ac.length;ad<aa;ad++){ag=ac[ad];Z.push(ag.addClassName("opacity-zero"))}return Z};r=function(){var ad,ac,aa,ab,Z;if(C){clearTimeout(C)}ab=$$(".lightbox-not-important");Z=[];for(ac=0,aa=ab.length;ac<aa;ac++){ad=ab[ac];Z.push(ad.removeClassName("opacity-zero"))}return Z};F=function(aa){var Z;r();Z=aa&&$(aa.target).descendantOf("file-preview-menu");if(C!=null){clearTimeout(C)}if(U){if(!g&&!Z){return C=setTimeout(N,3112)}}};J=function(){if(C!=null){clearTimeout(C)}return U=false};i=function(){U=true;return F()};X=function(aa){var Z;Z=S.length;return(Z+(q+aa)%Z)%Z};B=function(aa){var Z,ab;if(Q.no_preload){return}Z=n.bind(null,aa);return typeof(ab=S[aa]).preload==="function"?ab.preload(Z):void 0};h=function(){var ab,ad,aa,ac,Z;ac=[1,2,3,4,5,6,-1,-2];Z=[];for(ad=0,aa=ac.length;ad<aa;ad++){ab=ac[ad];if(Math.abs(ab)<S.length){Z.push(B(X(ab)))}else{Z.push(void 0)}}return Z};p=function(Z){if(!Q.filename_in_url){return}if(Z!=null){return HashRouter.replace_hash("lh",Z)}else{return HashRouter.replace_hash("")}};E=function(ac,at){var ai,aj,ak,ao,ae,Z,an,ar,aq,am,ag,aa,af,al,ap,ab,au,ah,ad;G=Util.time();Lightbox.vid_player=null;assert(q<S.length,"Invalid index "+q);al=S[q];if(typeof al!=="object"){if(b){clearTimeout(b)}b=setTimeout((function(){if((Lightbox.shown!=null)&&Lightbox.shown){return E(ac,at)}}),100);return}$j("#file-preview-modal").trigger("lightbox-preview",{preview:al});an={mode:"lightbox"};UserActivityLogger.log("web","file_view",Object.toJSON(an));af=ac?K:n;ae=al.render(af);ae.addClassName("content-item");aq=$("file-preview-modal");ap=aq.down(".preview-content");ap.__date(ae);if(!I){I=aq.on("contextmenu","img.thumbnail",ContextMenu.show_for_lightbox.bind(ContextMenu))}p(al.link_hash);aa=Q.num_previews||S.length;aq.down(".lightbox-index-text-container").__date(_("%(cur_file_num)s of %(num_total_files)s").format({cur_file_num:q+1,num_total_files:aa}));if(al.display_time){if(al.filename.match(a)){aq.down(".filename").__date(al.display_time)}else{aq.down(".filename").__date(al.display_time+" - "+al.filename)}}else{aq.down(".filename").__date(al.filename)}aq.down(".filename").writeAttribute("title",al.filename);if(Photos.in_single_collection_view()&&((ah=Photos.get_current_collection().member_fnames)!=null?ah.length:void 0)>1&&(((ad=al.photo)!=null?ad.item_owner_fname:void 0)!=null)){ao="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";ao+=_("Added by %(fname)s").format({fname:al.photo.item_owner_fname.em_snippet(7)});aq.down(".added-by").__date(new HTML(ao));aq.down(".added-by").show()}else{aq.down(".added-by").hide()}if(S.length===1){aq.down(".prev").addClassName("opacity-zero");aq.down(".next").addClassName("opacity-zero")}else{if(q===0&&Q.no_wrap){aq.down(".prev").addClassName("opacity-zero");aq.down(".next").removeClassName("opacity-zero")}else{if(q===S.length-1&&Q.no_wrap){aq.down(".prev").removeClassName("opacity-zero");aq.down(".next").addClassName("opacity-zero")}else{aq.down(".prev").removeClassName("opacity-zero");aq.down(".next").removeClassName("opacity-zero")}}}ag=HTML.tmpl("lightbox_more_actions_item_tmpl");am=al.get_more_actions_above_divider(Q);ak=al.get_more_actions_below_divider(Q);if(ak.length){am.push(ag({divider:true}));am=am.concat(ak)}$("lightbox-more-actions-list").__date(am);al.set_more_actions_event_handlers(Q);aj=al.get_actions(Q);Z=document.createDocumentFragment();for(ab=0,au=aj.length;ab<au;ab++){ai=aj[ab];Z.appendChild(ai)}aq.down(".actions").__date();aq.down(".actions").appendChild(Z);document.fire(Lightbox.ACTIONS_ADDED);if(Photos.in_single_collection_view()){aq.down(".album-name").show().__date(Photos.get_current_collection().name.em_snippet(15,1));aq.down(".filename").addClassName("faded")}else{aq.down(".album-name").hide();aq.down(".filename").removeClassName("faded")}ae=ae.down("img.thumbnail");if(ae){if(!l(ae)){ae.hide();d();ae.observe("load",function(){A();ae.style.visibility="hidden";ae.show();return x()})}else{ae.show();x()}}ar={preview_obj:al,index:q,direction:at};return document.fire(Lightbox.PHOTO_CHANGE_EVT,ar)};W=function(ab){var Z,aa;if(G===-1){return}aa=Util.time()-G;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){Z=PhotosLogger.get_current_view()}else{if(typeof SharingModel!=="undefined"&&SharingModel!==null?SharingModel.is_album:void 0){Z="album_shmodel"}else{Z="not_photos"}}WebTimingLogger.log_ajax_transition(aa,ab,{current_view:Z});G=-1;return h()};K=function(){return W("file-preview-lightbox-load-initial")};n=function(Z){var aa;if(typeof Z==="number"){if((aa=S[Z])!=null){aa.loaded=true}if(Z===q){return W("file-preview-lightbox-load")}}else{return W("file-preview-lightbox-load")}};P=function(Z){var aa;aa=$j("#lightbox-click-catcher");if(!aa.length){aa=$j("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});aa.appendTo("#file-preview-modal .modal-preview-content");if($j.browser.msie_version_at_most(10)){aa.css("background","black");aa.fadeTo(0,0)}}aa.off("click");aa.on("click",(function(ab){ab.preventDefault();return Z()}));return aa.show()};m=function(){return $j("#lightbox-click-catcher").hide()};Y=function(){var Z;Z=$("lightbox_more_actions_button");if(Z.hasClassName("toggled")){m();Z.removeClassName("toggled");$("lightbox-more-actions-menu").hide();i();return true}return false};t=function(){var Z;Z=$j("#lightbox_more_actions_button");if(!Z.hasClass("toggled")){Z.addClass("toggled");TitleBubble.hide_all();$j("#lightbox-more-actions-menu").show();J();return P(Lightbox.close_more_actions_menu)}};k=function(){if($j("#lightbox_more_actions_button").hasClass("toggled")){return Y()}else{return t()}};e=function(Z){Y();if(Z){Z.preventDefault()}if(q===S.length-1&&Q.no_wrap){return}q=X(1);if(q===0){F()}return E(null,Lightbox.NEXT)};w=function(Z){Y();if(Z){Z.preventDefault()}if(q===0&&Q.no_wrap){return}q=X(-1);return E(null,Lightbox.PREV)};D=function(Z){if(Z){Z.preventDefault()}if(S[q].advance_on_click){if(Z.clientX<$j(window).width()/10){return w()}else{return e()}}};R=function(af){var ac,ab,ae,ag,ad,aa,Z;ac=S.dict_by("fq_path");ag=void 0;if(af.memo.files){ag=af.memo.files.collect(function(ah){return ah.fq_path})}else{ag=af.memo.fq_paths}Z=[];for(ad=0,aa=ag.length;ad<aa;ad++){ae=ag[ad];if(ac[ae]){ab=S.indexOf(ac[ae]);S.splice(ab,1);if(Q.num_previews){Q.num_previews--}if(!Q.num_previews&&!S.length){Z.push(M())}else{if(ab===S.length){Z.push(w())}else{Z.push(E())}}}else{Z.push(void 0)}}return Z};c=function(Z){if(S[q].is_a_timeline_preview()){return S[q].toggle_select(Z)}};u=function(){Event.stopObserving(document,"mousemove",F);Event.stopObserving(document,"click",F);document.stopObserving(FileEvents.DELETE,R);document.stopObserving(PhotosSelection.CHANGE_EVT,j);return clearInterval(y)};M=function(ac){var aa,ab,Z;if(ac){ac.preventDefault()}if(!Lightbox.shown){return}aa=$("file-preview-modal");aa.hide();if(Lightbox.vid_player&&Lightbox.vid_player.sendEvent){Lightbox.vid_player.sendEvent("stop")}aa.down(".preview-content").__date();Util.set_page_scrollable(true);u();p();Lightbox.shown=0;aa.stopObserving("click",Lightbox.back);if((ab=$$(".preview-content"))!=null){if((Z=ab.first())!=null){Z.stopObserving("click")}}if(Lightbox.reload){return Browse.force_reload()}};o="db:filepreview:exitselect";v=function(Z){if(Q.keep_url){M()}else{window.history.go(-1)}if(Z!=null){if(Z.originalEvent){Z=Z.originalEvent}Event.extend(Z).stop()}return document.fire(o,S[q])};O=function(){var Z,aa=this;if(!H){Z=$j("#file-preview-modal");Z.on("click",".close",v);key("esc",f,(function(ab){if($j("#lightbox_more_actions_button").hasClass("toggled")){return Y()}else{if(g){return L()}else{return v(ab)}}}));Z.on("click",".next",e);Z.on("click",".prev",w);Z.on("click",".preview-container",D);key("left, k",f,function(ab){return w()});key("right, j",f,function(ab){e();return false});key("up, down",f,function(ab){return false});key("x, s, space",f,function(ab){c(ab);return false});if(Q.include_delete){key("delete, command+backspace, backspace",f,function(ab){Event.extend(ab).preventDefault();return Lightbox.toggle_delete()});$j("#lightbox-delete-photo").on("click",(function(ab){z();return S[q].delete_pressed()}));$j("#lightbox-delete-cancel").on("click",L)}DBHistory.add_exit_callback("/lightbox",function(){return M()});Util.disableSelection(Z.find(".preview-container")[0]);Util.disableSelection(Z.find(".header")[0]);H=true}Event.observe(document,"mousemove",F);Event.observe(document,"click",F);document.observe(FileEvents.DELETE,R);document.observe(Lightbox.PHOTO_DELETE_EVT,function(ab){return FileOps.do_delete(ab.memo.fq_path)});document.observe(PhotosSelection.CHANGE_EVT,j);key.setScope(f);return y=setInterval(x,500)};V=function(){return on_script_loaded(function(){HashRouter.watch("lh",function(ac){var ad,Z,af,ae,ab,aa;Z=decodeURIComponent(ac);aa=[];for(ad=ae=0,ab=S.length;ae<ab;ad=++ae){af=S[ad];if(af.link_hash&&af.link_hash.toLowerCase()===Z.toLowerCase()){q=ad;if(!Lightbox.shown){aa.push(Lightbox.show())}else{aa.push(E())}}else{aa.push(void 0)}}return aa});return HashRouter.watch("f",function(Z){var ac,ad,af,ae,ab,aa;ac=decodeURIComponent(Z);aa=[];for(ad=ae=0,ab=S.length;ae<ab;ad=++ae){af=S[ad];if(af.filename.toLowerCase()===ac.toLowerCase()){q=ad;if(!Lightbox.shown){aa.push(Lightbox.show())}else{aa.push(E())}}else{aa.push(void 0)}}return aa})})};j=function(ad,af){var ab,ae,aa,ac,Z;if(af==null){af=$j("#lightbox_share")}aa=PhotosSelection.get();ac=PhotosUtil.categorize_files(aa),ab=ac[0],ae=ac[1];if(aa.length===0){af.text(_("Share"));return(Z=S[q])!=null?Z.toggle_select_button_off($j("#lightbox-select-button")):void 0}else{if(aa.length===1){if(ab){return af.text(_("Share 1 photo"))}else{return af.text(_("Share 1 video"))}}else{if(ab&&ae){return af.text(_("Share %(num_files)s items").format({num_files:aa.length}))}else{if(ab){return af.text(_("Share %(num_photos)s photos").format({num_photos:aa.length}))}else{return af.text(_("Share %(num_videos)s videos").format({num_videos:aa.length}))}}}}};s=function(){TitleBubble.hide_all();$j("#file-preview-modal .delete-file-prompt").show();r();g=true;P(Lightbox.toggle_delete);return $j("#lightbox-delete-photo").focus()};L=function(){var aa,Z;if(g){aa=$j("#file-preview-modal .delete-file-prompt");aa.hide();if((Z=aa.find(":focus")[0])!=null){Z.blur()}F();g=false;return m()}};z=function(){if(g){return L()}else{return s()}};return{init_from_preview_objs:function(ad,Z,ab){var aa,ag,af,ac,ah,ae=this;if(ab==null){ab=true}af=[];for(ac=0,ah=ad.length;ac<ah;ac++){aa=ad[ac];if(aa.is_video){ag=new VideoPreview({filename:aa.filename,fq_path:aa.path,thumbnail_url_tmpl:aa.thumbnail_url,preview_url:aa.preview_url,dl_url:URI.parse(aa.orig_url).updateQuery({dl:"1"}).toString(),shmodel_link:aa.shmodel_link,ns_id:aa.ns_id,ns_path:aa.path,link_hash:aa.item_id+"-"+aa.filename,metadata_link:aa.metadata_link})}else{ag=new PhotoPreview({filename:aa.filename,fq_path:aa.path,thumbnail_url_tmpl:aa.thumbnail_url,dl_url:URI.parse(aa.orig_url).updateQuery({dl:"1"}).toString(),original_url:aa.orig_url,shmodel_link:aa.shmodel_link,ns_id:aa.ns_id,ns_path:aa.ns_path,link_hash:aa.item_id+"-"+aa.filename})}af.push(ag)}Lightbox.init(af,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:ab});return document.on(Lightbox.EXIT_SELECT_EVT,function(aj){var ai;key.setScope("all");ai=$j(Z)[af.indexOf(aj.memo)];Util.scroll_to_thumb(ai);$j(ai).addClass("wiggobble");return setTimeout((function(){return $j(ai).removeClass("wiggobble")}),1000)})},init:function(Z,ab){var aa=this;if(Lightbox.shown){return}Lightbox.more_actions_button=new Element("a",{id:"lightbox_more_actions_button",href:"#","class":"lightbox_more_actions_button title_bubble black",title:_("More actions")});Lightbox.more_actions_button.observe("click",(function(ac){ac.preventDefault();return Lightbox.toggle_more_actions_menu()}));Lightbox.more_actions_button.__date(Sprite.make("web","lightbox_more"));ab=ab||{};Q={include_delete:ab.include_delete||false,keep_url:ab.keep_url||false,num_previews:ab.num_previews||null,filename_in_url:ab.filename_in_url||false,no_wrap:(ab.no_wrap||false)||true,no_preload:ab.no_preload||false,enable_sublinks:ab.enable_sublinks!=null?ab.enable_sublinks:true};assert(!Q.filename_in_url||Q.keep_url,"filename_in_url cannot be used with keep_url off");S=Z;if(ab.start_index!=null){Lightbox.show(ab.start_index)}if(Q.filename_in_url){V()}return $(document.body).on("click",".more-actions-item",function(ac,ad){if(ad.down("a").getAttribute("href").length<2){ac.preventDefault()}return Lightbox.close_more_actions_menu()})},update_previews:function(Z){return S=Z},show:function(Z){var aa;if(Lightbox.shown){return}assert(S&&S.length,"Lightbox.show() requires file preview objects to show");O();if(Z!=null){q=Z}$j("#file-preview-modal").trigger("lightbox-init-show",{preview:S[q]});assert(!Lightbox.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();Util.set_page_scrollable(false);E(true);Lightbox.shown=1;if(!Q.keep_url){aa=DBHistory.deconstruct_url(DBHistory.get_url());if(aa.path.indexOf("/lightbox/")!==0){DBHistory.push_state("/lightbox"+aa.path,aa.qargs)}}return F()},jump_to:function(Z){assert(Lightbox.shown,"Lightbox should be showing");q=Z;E();return F()},set_no_wrap:function(Z){return Q.no_wrap=Z},num_previews:function(){return Q.num_previews||S.length},get_previews:function(){return S},current_index:function(){return q},close_more_actions_menu:Y,toggle_more_actions_menu:k,update_share_button_text:j,toggle_delete:z,back:v,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:o,reload:false,NEXT:1,PREV:-1,vid_player:null,vid_player_loading:null,vid_player_error:null,vid_thumbnail_hidden:null}})();var Tour;Tour=(function(){var d,c,f,g,k,i,j,h,e,l,b,a;c=6;d=0;b=function(m){var v,u,t,o,n,p,r,s,q;$$(".page-end").each(Element.remove);n=m;r=c-m-1;v=document.createDocumentFragment();for(u=s=0;0<=n?s<n:s>n;u=0<=n?++s:--s){o=new Element("img",{src:"/static/images/page-left.png","class":"page-end-left page-end"});o.style.left=(28-u*5)+"px";o.style.zIndex=c-u;v.appendChild(o)}for(t=q=0;0<=r?q<r:q>r;t=0<=r?++q:--q){p=new Element("img",{src:"/static/images/page-right.png","class":"page-end-right page-end"});p.style.right=(31-t*5)+"px";p.style.zIndex=c-t;v.appendChild(p)}return $("book").appendChild(v)};a=function(m){(m>0?Element.show:Element.hide)("tour-page-back");return(m+1<c?Element.show:Element.hide)("tour-page-forward")};e=function(m){$$(".pages").invoke("hide");return $("page-"+m).show()};f=function(m){a(m);b(m);e(m);return d=m};h=function(n){var m;Event.extend(n).preventDefault();m=d-1;if(m<0){return}f(m);return DBHistory.push_state("/tour/"+m)};i=function(n){var m;Event.extend(n).preventDefault();m=d+1;if(m>=c){return}f(m);return DBHistory.push_state("/tour/"+m)};l=function(n,o){var m;n.preventDefault();m=parseInt(o.href.split("/").last(),10);f(m);return DBHistory.push_state("/tour/"+m)};k=function(){$("tour-page-back").observe("click",h);$("tour-page-forward").observe("click",i);key("right",i);key("left",h);return $("toc").on("click","a",l)};g=function(n,o){var m;m=parseInt(n,10)||0;return f(m)};j=function(){var q,p,n,o,m;o=$$(".page-right img");m=[];for(p=0,n=o.length;p<n;p++){q=o[p];m.push(Util.preload_image(q.src))}return m};return{setup:function(){return Util.smartLoad(function(){DBHistory.add_callback("/tour",g);k();return j()})}}})();var BillingInfo,CashUtil,CreditCardHighlighter,DropboxCreditInfoModal,PaypalUtil,PciInputBase,UpgradeDesign1,UpgradeLogger,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1},_this=this;PciInputBase={set_data_encrypted_names:function(){return $j.each($j(".pci_encrypted_field input, .pci_encrypted_field select"),function(a,b){return $j(b).attr("data-encrypted-name",b.id)})}};UpgradeLogger={log:function(a,b,d){var e,c;e={evt:a,tags:b.join(",")};for(c in d){e[c]=d[c]}return $j.ajax("/upgrade_log",{method:"post",noAutonotify:true,data:e})}};CreditCardHighlighter={card_toggle:function(a){return function(c){var b;b=$(c);if(c===a||!a){return b.removeClassName("cc-icon-off")}else{return b.addClassName("cc-icon-off")}}},highlightCardtype:function(){var c,a,d,b;d=$j("#ccn").val();a=$j.payment.cardType(d);b=null;c=CreditCardUtil.getAllTypes();if(__indexOf.call(c,a)>=0){b=a}return c.each(CreditCardHighlighter.card_toggle(b))},runCardHighlighter:function(){$j("#ccn").payment("formatCardNumber");return $j("#ccn").on("payment.cardType",function(a){return CreditCardHighlighter.highlightCardtype()})}};PaypalUtil={updateBillingInfoForPaypal:function(){if(!Forms.submitOnlyOnce()){return}return location.href="/paypal_billing_info"}};BillingInfo={initialize:function(){return $j('[name="country_code"]').change(BillingInfo.updateBillingInfoForm)},updateBillingInfoForm:function(b){var c,a;c=$j('[name="country_code"]').val();a=CreditCardUtil.getValidCardTypesForCountryCode(c);return $j(".cc-icon").each(function(){var d;d=$j(this).attr("id");return $j(this).toggle(__indexOf.call(a,d)>=0)})}};UpgradeDesign1={submitPaypal:function(){var a,b,c;c=false;$j("#paypal-info #zip_paypal").removeClass("invalid-input");$j("span.error-message").remove();$j("div.upgrade-error-message").remove();a=$j("#country-list-paypal").val();c=$j("#paypal-info #zip_paypal").val()||$u.contains(this.countryCodesWithoutPostalCodes,a);if(a==="US"){c=c&&/^[0-9]{5}(-{0,1}[0-9]{4}){0,1}$/g.test(c)}if(!c){$j("#paypal-info #zip_paypal").addClass("invalid-input");$j("#paypal-info .other-billing-client-side-error").empty().html(_("Please enter a valid ZIP/postal code."));UpgradeLogger.log("upgrade-button-click",["zip"],{form_country:a});return false}if(!Forms.submitOnlyOnce()){return}b={plan_id:$j('[name="plan_id"]:checked').val()||$j("#plan_id").val(),period_id:$j("#period_id").val(),currency:Forms.value("currency"),country_code:$j("#country-list-paypal").val(),zip:$j("#paypal-info #zip_paypal").val()};if(Forms.value("packrat")==="yes"){b.packrat="yes"}return location.href=URI({path:"/paypal_upgrade"}).updateQuery(b).toString()},upgradeViaLogin:function(){var a,b;if(!Forms.submitOnlyOnce()){return}a={plan_id:$j('[name="plan_id"]:checked').val()||$j("#plan_id").val(),period_id:$j("#period_id").val()};if(Forms.value("packrat")){a.packrat=Forms.value("packrat")}else{a.packrat="no"}if(location.href.indexOf("all_plans=1")>-1||Forms.value("all_plans")){a.all_plans="1"}b=URI({path:"/upgrade"}).updateQuery(a).toString();return location.href=URI({path:"/login"}).updateQuery({cont:b}).toString()},setFormToObserveLogin:function(){var a=this;return $("upgrade-login-button").on("click",function(){return a.upgradeViaLogin()})},setFormPaypalSubmitState:function(a){var b,c=this;b=$("upgrade-button");if(!b){return}if(a){return b.on("click",function(){return c.submitPaypal()})}else{return b.stopObserving("click")}},updateFormPaypalSubmitState:function(){var a;a=$j(".stored-new-payment-toggle.selected");if(a&&a.attr("id")==="stored-new-toggle-stored"){return this.setFormPaypalSubmitState(this.args.paypal_preferred)}else{if($j("input:radio[name=payment_method]:checked").val()==="cc-checked"){return this.setFormPaypalSubmitState(false)}else{return this.setFormPaypalSubmitState(true)}}},setCountryCodesWithoutPostalCodes:function(a){this.countryCodesWithoutPostalCodes=a},setCountryToCurrencyMap:function(a){this.countryToCurrencyMap=a},watchPaymentOptions:function(){var a=this;return $j(".stored-new-payment-toggle").on("click",function(c){var b;b=$j(c.target).closest(".stored-new-payment-toggle");$j(".stored-new-payment-toggle").removeClass("selected");b.addClass("selected");if(b.attr("id")==="stored-new-toggle-stored"){$j("#upgrade-form").attr("action","/stored_upgrade");$j(".credit-card-info-container").hide()}else{$j("#upgrade-form").attr("action","/upgrade");$j(".credit-card-info-container").slideDown()}return a.updateFormPaypalSubmitState()})},bounceAndHighlightPricingInfo:function(){var b,a;$j(".currency-banner").show();b="animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd";$j(".receipt-box").addClass("js-currency-changed").on(b,function(){return $j(this).removeClass("js-currency-changed")});$j(".upgrade-price-inner").addClass("js-currency-changed").on(b,function(){return $j(this).removeClass("js-currency-changed")});a=".summary_price, .monthly-price, .yearly-price";return $j(a).addClass("highlight-payment-amounts").on(b,function(){return $j(this).removeClass("highlight-payment-amounts")})},plan_to_prices:{},plan_to_display_name:{},period_to_description:{},monthly_packrat_cost:0,yearly_packrat_cost:0,packrat_monthly_display_price:0,packrat_yearly_display_price:0,prorate_amount:0,will_have_packrat:false,plan_box_holder_ids:[],user_current_plan_id:0,user_current_billing_period:"",user_has_downgraded:false,express_yearly_pricing_as_monthly:false,transition_view_models:[],use_transition_space_pricing:false,expressYearlyPricingAsMonthly:function(a){this.express_yearly_pricing_as_monthly=a},initializeUpgradeForm:function(a){var b,d,c;this.args=a;c=this.args;for(b in c){d=c[b];this[b]=d}return this.setFormPaypalSubmitState(this.args.paypal_preferred)},getPriceInfo:function(h,j,a,g){var k,f,d,i,e,c,b;k=(e=this.plan_to_prices)!=null?(c=e[h])!=null?c[j][a]:void 0:void 0;if(!this.use_transition_space_pricing){return k}b=this.transition_view_models;for(d=0,i=b.length;d<i;d++){f=b[d];if(f.plan===parseInt(h,10)&&f.packrat===j&&f.is_monthly===a&&f.currency===g){return f}}return assert(false,"We were unable to find the price for your selected plan. Please try                  again at a later time.")},setUseTransitionSpacePricing:function(a){this.use_transition_space_pricing=a},setTransitionViewModels:function(a){this.transition_view_models=a},registerPrice:function(a){var c,b,d;d=a.plan;b=a.packrat;c=a.is_monthly;if(!this.plan_to_prices[d]){this.plan_to_prices[d]=[]}if(!this.plan_to_prices[d][b]){this.plan_to_prices[d][b]=[]}return this.plan_to_prices[d][b][c]=a},registerPeriod:function(a,b){return this.period_to_description[a]=b},registerPlanDisplayName:function(b,a){return this.plan_to_display_name[b]=[a]},registerPlanBoxHolderId:function(b,a){var c=this;this.plan_box_holder_ids.push(b);return $(a).on("click",function(){return c.updateSelectedPlanBoxHolder(b)})},updateSelectedPlanBoxHolder:function(d){var c,f,b,e,a;if(!$(d)){return}$(d).addClassName("selected-plan");e=this.plan_box_holder_ids;a=[];for(f=0,b=e.length;f<b;f++){c=e[f];if(c!==d){a.push($(c).removeClassName("selected-plan"))}else{a.push(void 0)}}return a},togglePostalCodeBasedOnCountry:function(){var a,b;if($j("input:radio[name=payment_method]:checked").val()==="cc-checked"){a=$j("#country-list").val()}else{a=$j("#country-list-paypal").val()}b=__indexOf.call(this.countryCodesWithoutPostalCodes,a)>=0;$j("#zip, #paypal-info #zip_paypal").prop("disabled",b).closest(".zip-field-with-label").toggleClass("hide-zip",b);if(b){return $j("#zip, #paypal-info #zip_paypal").val("")}},updateCreditCardListBasedOnCountry:function(){var b,a;b=$j("#country-list").val();a=CreditCardUtil.getValidCardTypesForCountryCode(b);return $j(".cc-icon-design-1").each(function(){var c;c=$j(this).attr("id");return $j(this).toggle(__indexOf.call(a,c)>=0)})},updateBillingForm:function(){var y,F,P,z,J,q,k,p,c,b,w,v,D,O,C,m,K,N,B,f,o,a,G,A,I,x,h,M,t,d,n,H,u,R,Q,L,r,g,e,E,l,j,i;H=0;B=null;C=$("packrat");b=this.will_have_packrat||((C!=null)&&C.type==="checkbox"&&C.checked);D=_("month");O=this.packrat_yearly_display_price;N=$("period-month")?$("period-month").checked:false;I=$j("#period_id");if(I.length){h=I.val();N=this.period_to_description[h]==="month"}this.togglePostalCodeBasedOnCountry();this.updateCreditCardListBasedOnCountry();if(b){$j(".packrat-holder").addClass("packrat-selected")}else{$j(".packrat-holder").removeClass("packrat-selected")}J=$j("input[name='currency']").val();I=$j("#plan_id");if(I.length){B=I.val()}else{E=$j("[name='plan_id']");for(R=0,r=E.length;R<r;R++){k=E[R];if(N){$j(k).parent().parent().find(".plan-pricing.monthly-pricing").removeClass("hidden_elem");$j(k).parent().parent().find(".plan-pricing.yearly-pricing").addClass("hidden_elem");$j(k).parent().parent().find(".plan-pricing.yearly-as-monthly-pricing").addClass("hidden_elem");$j(".yearly-as-monthly-footnote").html("&nbsp;");$j("#billing-footer").addClass("hidden_elem")}else{if(this.express_yearly_pricing_as_monthly){$j(k).parent().parent().find(".plan-pricing.monthly-pricing").addClass("hidden_elem");$j(k).parent().parent().find(".plan-pricing.yearly-as-monthly-pricing").removeClass("hidden_elem");$j("#billing-footer").removeClass("hidden_elem");$j(".yearly-as-monthly-footnote").removeClass("hidden_elem").html(_("Billed annually")+"*")}else{$j(k).parent().parent().find(".plan-pricing.monthly-pricing").addClass("hidden_elem");$j(k).parent().parent().find(".plan-pricing.yearly-pricing").removeClass("hidden_elem")}}if(k.checked){B=k.getValue();this.updateSelectedPlanBoxHolder("plan-"+B+"-holder")}}}if($j("input:radio[name=payment_method]:checked").val()==="cc-checked"){F=$j("#country-list").val()}else{F=$j("#country-list-paypal").val()}J=((l=this.countryToCurrencyMap)!=null?l[F]:void 0)||$j("input[name='currency']").val();if(J!==$j("input[name='currency']").val()){$j("input[name='currency']").val(J);$j(".upgrade-terms-currency").html(J);this.bounceAndHighlightPricingInfo()}if(N){$j(".billing-periods .monthly .sub-right").addClass("selected-billing-period");$j(".billing-periods .yearly .sub-right").removeClass("selected-billing-period");if(b){w=this.monthly_packrat_cost}O=this.packrat_monthly_display_price;D=_("month");n="month"}else{$j(".billing-periods .monthly .sub-right").removeClass("selected-billing-period");$j(".billing-periods .yearly .sub-right").addClass("selected-billing-period");if(b){w=this.yearly_packrat_cost}O=this.packrat_yearly_display_price;D=_("year");n="year"}o=this.getPriceInfo(B,b,N,J);v=o.amount;H=v;a=o.prorate_amount;G=o.rebill_amount;if(parseInt(B)===this.user_current_plan_id&&!this.user_has_downgraded){$j("#current-plan-desc").removeClass("hidden_elem");if(this.user_current_billing_period===parseInt(h)&&(Boolean(this.will_have_packrat)===b)){$j("#billing-information").addClass("hidden_elem");$j(".charge-and-credit-amount").addClass("hidden_elem");$j(".account-summary").addClass("account-summary-no-charge")}else{$j("#billing-information").removeClass("hidden_elem");$j(".charge-and-credit-amount").removeClass("hidden_elem");$j(".account-summary").removeClass("account-summary-no-charge")}}else{$j("#current-plan-desc").addClass("hidden_elem");$j("#billing-information").removeClass("hidden_elem");$j(".charge-and-credit-amount").removeClass("hidden_elem");$j(".account-summary").removeClass("account-summary-no-charge")}m=$j("#packrat-price").text(CashUtil.formatCurrency(O,J)+(n==="year"?_("/yr"):_("/mo")));$j(".receipt-summary h2").text(_("Dropbox ")+this.plan_to_display_name[B]);u=this.getPriceInfo(B,b,true,J).rebill_amount*12;p=this.getPriceInfo(B,b,false,J).rebill_amount;x=u-p;K=x/u*100;K=Math.round(K);y=0;P=0;if(this.dropbox_dollars>=H){y=0;P=H}else{y=H-this.dropbox_dollars;P=this.dropbox_dollars}P+=a;if(this.user_has_downgraded&&B===this.user_current_plan_id&&n===this.user_current_billing_period){y=0;P=0}$j("#expected_price").val(y);f=$("plan-name");if(f){f.__date(this.plan_to_display_name[B])}$j(".summary_price").text(CashUtil.formatCurrency(y,J));$j(".total_price").text(CashUtil.formatCurrency(G,J));$j(".monthly-price").text(CashUtil.formatCurrency(this.getPriceInfo(B,b,true,J).amount,J));$j(".yearly-price").text(CashUtil.formatCurrency(this.getPriceInfo(B,b,false,J).amount,J));$j(".billing-period-total").text(" "+CashUtil.formatNumber(K,{precision:0})+"% ("+CashUtil.formatCurrency(x,J)+")");if(P>0){$j(".credit").removeClass("hidden_elem").find(".line-item-amount").text(CashUtil.formatCurrency(-1*P,J));$j(".price").removeClass("hidden_elem")}else{$j(".credit").addClass("hidden_elem");$j(".price").addClass("hidden_elem")}if(P){j=$$(".credit-holder");for(Q=0,g=j.length;Q<g;Q++){z=j[Q];z.removeClassName("hidden_elem")}$j(".credit-amount").text(CashUtil.formatCurrency(P,J))}else{i=$$(".credit-holder");for(L=0,e=i.length;L<e;L++){z=i[L];z.addClassName("hidden_elem")}}d=o.scheduling_plan;t=o.scheduling_packrat;A=o.reset_interval;q="";if(this.ios_quota_extra){q=_("Pro 100",{comment:"The name we show for the iOS plan."})}else{q=this.plan_to_display_name[this.user_current_plan_id]}c={current_plan_display_name:q,new_plan_display_name:this.plan_to_display_name[B],new_period:N?_("/mo"):_("/yr"),new_plan_long_period:N?_("Monthly"):_("Yearly"),current_plan_long_period:this.current_period_is_monthly?_("Monthly"):_("Yearly"),billing_date:this.rebill_date,disp_rebill_amount:CashUtil.formatCurrency(G,J),disp_new_sub_amount:CashUtil.formatCurrency(y,J)};M="";if(d){if(A){M="<p>"+_("Your current plan (%(current_plan_display_name)s %(current_plan_long_period)s) will continue until the end of your current billing period. Your change to %(new_plan_display_name)s %(new_plan_long_period)s will be applied at your next billing date on <b>%(billing_date)s</b>. You will be charged <b>%(disp_rebill_amount)s%(new_period)s</b> starting on %(billing_date)s.",{comment:"disp_rebill_amount is a currency amount; new_period is an abbreviated period ('/mo' or '/yr')"}).format(c)+"</p>"}else{M="<p>"+_("Your current plan is effective until <b>%(billing_date)s</b>. To upgrade to %(new_plan_display_name)s %(new_plan_long_period)s through %(billing_date)s, you will incur a one-time charge of <b>%(disp_new_sub_amount)s</b>. This amount equals the price of the new plan for the remainder of your billing period minus what you already paid under the old plan for the same period. Your change to monthly billing will be applied at your next billing date on %(billing_date)s. You will be charged <b>%(disp_rebill_amount)s</b> monthly going forward after %(billing_date)s.").format(c)+"</p>";$j(".credit").addClass("hidden_elem");$j(".price").addClass("hidden_elem")}}if(this.scheduled_extras&&a>0){M+="<p>"+_("You previously scheduled Packrat to be removed on %(billing_date)s. To change to %(new_plan_display_name)s, we will immediately remove Packrat and apply the remaining value to your new plan.").format(c)+"</p>"}if(M!==""&&(parseInt(B)!==this.scheduled_plan_id||parseInt(h)!==this.scheduled_plan_schedule)){$j("#schedule-messages").removeClass("hidden_elem").find("#schedule-messages-body").html(M)}else{$j("#schedule-messages").addClass("hidden_elem")}$j(".upgrade-terms-cost").text(CashUtil.formatCurrency(G,J));if(N){$j(".yearly-discount").addClass("hidden_elem");$j(".upgrade-terms-period").text(_("monthly"))}else{$j(".yearly-discount").removeClass("hidden_elem");$j(".upgrade-terms-period").text(_("yearly"))}if(d){return $j(".upgrade-terms-asof").removeClass("hidden_elem")}else{return $j(".upgrade-terms-asof").addClass("hidden_elem")}},runPlanWatcher:function(){var b,f,c,h,e,a,d,g=this;d=$j("[name='plan_id']");for(e=0,a=d.length;e<a;e++){b=d[e];b.on("click",function(){return g.updateBillingForm()})}h=function(i){return $j("#plan-"+i+"-holder").on("click",function(){$j("[name='plan_id']").prop("checked",false);$j("#plan-"+i).prop("checked",true);return g.updateBillingForm()})};for(f in this.plan_to_prices){h(f)}$j("#plan_id").change(function(){return g.updateBillingForm()});$j("label").click(function(){switch($j(this).attr("for")){case"period-month":case"period-year":$j("#"+$j(this).attr("for")).prop("checked",true);return UpgradeDesign1.updateBillingForm();case"plan-100":case"plan-200":case"plan-500":$j("[name='plan_id']").prop("checked",false);$j("#"+$j(this).attr("for")).prop("checked",true);return UpgradeDesign1.updateBillingForm()}});$j("#period_id").change(function(){return g.updateBillingForm()});c=$("packrat");if(c!=null){c.on("click",function(){return g.updateBillingForm()})}return $j("#country-list, #country-list-paypal").change(function(){return g.updateBillingForm()})},logFormStarted:function(c){var b,a;if(this.logged_form_start){return}a=$j(c.delegateTarget).attr("id");if(!a){if($j(c.delegateTarget).attr("type")==="radio"){a=$j(c.delegateTarget).attr("name")+":"+$j(c.delegateTarget).attr("value")}}b={};if(a){b.element_id=a}UpgradeLogger.log("upgrade-form-started",["success"],b);return this.logged_form_start=true},validateUpgradeFormInputs:function(){var a,b=this;a=[_("Please enter a valid ZIP/postal code."),_("Please enter a valid security code."),_("Please enter a valid ZIP/postal code and security code."),_("Please enter a valid expiration date."),_("Please enter a valid ZIP/postal code and expiration date."),_("Please enter a valid security code and expiration date."),_("Please enter a valid ZIP/postal code, security code and expiration date.")];return $j(document).ready(function(){$j("#period_id").change(function(f){var d,c;c=$j(f.target).val();d=b.period_to_description[c];return b.updateBillingForm()});$j("input:radio[name=payment_method]").on("click",function(c){if($j(c.target).val()==="cc-checked"){$("credit-card-info").removeClassName("hidden_elem");$("paypal-info").addClassName("hidden_elem");$j("#credit-card-info #country-list").val($j("#country-list-paypal").val())}else{$("credit-card-info").addClassName("hidden_elem");$("paypal-info").removeClassName("hidden_elem");$j("#country-list-paypal").val($j("#credit-card-info #country-list").val())}return b.updateFormPaypalSubmitState()});b.updateBillingForm();$j("#ccn, #zip, #ccode").focus(function(c){return b.logFormStarted(c)});$j("#country-list, #expmo, #expyr").change(function(c){return b.logFormStarted(c)});$j("input:radio[name=payment_method]").click(function(c){return b.logFormStarted(c)});$j("#ccn").payment("formatCardNumber");$j("#ccode").payment("formatCardCVC");$j("#ccn").focus(function(){return $j("#ccn").removeClass("invalid-input")});$j("#ccode").focus(function(){return $j("#ccode").removeClass("invalid-input")});$j("#expmo").focus(function(){$j("#expmo").removeClass("invalid-input");return $j("#expyr").removeClass("invalid-input")});$j("#expyr").focus(function(){$j("#expyr").removeClass("invalid-input");return $j("#expmo").removeClass("invalid-input")});$j("#zip").focus(function(){return $j("#zip").removeClass("invalid-input")});return $j("#upgrade-button").click(function(p){var k,t,o,h,l,j,s,i,m,n,c,r,f,g,q,d;t=r=g=q=d=false;$j("#ccn").removeClass("invalid-input");$j("#ccode").removeClass("invalid-input");$j("#expmo").removeClass("invalid-input");$j("#expyr").removeClass("invalid-input");$j("#zip").removeClass("invalid-input");$j("#credit-card-info .ccn-client-side-error").empty();$j("#credit-card-info .card-type-error").empty();$j("#credit-card-info .other-billing-client-side-error").empty();$j("span.error-message").remove();$j("div.upgrade-error-message").remove();i=[];m={};try{if($j("#upgrade-form").attr("action")==="/stored_upgrade"){UpgradeLogger.log("upgrade-button-click",["success"],m);return true}j=$j("#country-list").val();l=$j("#ccn").val();k=$j.payment.cardType(l);n=l.indexOf("*")===0;t=n||__indexOf.call(CreditCardUtil.getAllTypes(),k)>=0;r=($j.payment.validateCardNumber($j("#ccn").val()))||n;if(!r){i.push("card_number");$j("#ccn").addClass("invalid-input");$j("#credit-card-info .ccn-client-side-error").empty().html(_("Please enter a valid credit card number."))}if(r&&!t){f=CreditCardUtil.getValidCardTypesForCountryCode(j);c=(function(){var v,u,e;e=[];for(v=0,u=f.length;v<u;v++){o=f[v];e.push(CreditCardUtil.getNameForType(o))}return e})();if(c.length===2){h=_("Please use either a %(card_type_1)s or %(card_type_2)s card.").format({card_type_1:c[0],card_type_2:c[1]})}else{if(c.length===3){h=_("Please use a %(card_type_1)s, %(card_type_2)s or %(card_type_3)s card.").format({card_type_1:c[0],card_type_2:c[1],card_type_3:c[2]})}else{if(c.length===4){h=_("Please use a %(card_type_1)s, %(card_type_2)s, %(card_type_3)s or %(card_type_4)s card.").format({card_type_1:c[0],card_type_2:c[1],card_type_3:c[2],card_type_4:c[3]})}else{h=_("Please use a valid credit card type.")}}}$j("#credit-card-info .card-type-error").empty().html(h)}if(t){$j("#card_type").val(k)}else{i.push("card_type")}g=$j.payment.validateCardCVC($j("#ccode").val(),k);g=n||(k==="amex"?$j("#ccode").val().length===4:g);if(!g){$j("#ccode").addClass("invalid-input");i.push("cvc")}q=$j.payment.validateCardExpiry($j("#expmo").val(),$j("#expyr").val().substring(2));if(!q){$j("#expmo").addClass("invalid-input");$j("#expyr").addClass("invalid-input");i.push("expiration")}d=$j("#zip").val()||$u.contains(b.countryCodesWithoutPostalCodes,j);if(j==="US"){d=d&&/^[0-9]{5}(-{0,1}[0-9]{4}){0,1}$/g.test(d)}if(!d){i.push("zip");m.form_country=$j("#country-list").val();$j("#zip").addClass("invalid-input")}if(!$u.every([g,q,d])){s=0;if(!d){s|=1}if(!g){s|=2}if(!q){s|=4}assert(s>0&&a[s-1]!==null);$j("#credit-card-info .other-billing-client-side-error").empty().html(a[s-1])}}catch(p){UpgradeLogger.log("upgrade-button-click",["exception"],m);return false}if($u.every([t,r,g,q,d])){UpgradeLogger.log("upgrade-button-click",["success"],m);return true}UpgradeLogger.log("upgrade-button-click",i,m);return false})})}};CashUtil={_groupSymbol:",",_decimalSymbol:".",_minusSignSymbol:"-",_currencyFormatMap:{USD:"$%v"},set_locale_number_format:function(a,b,c){this._groupSymbol=a!=null?a:",";this._decimalSymbol=b!=null?b:".";this._minusSignSymbol=c!=null?c:"-"},set_currency_format_map:function(a){this._currencyFormatMap=a},_formatAmountThousandsHelper:function(a){var b;b=Math.abs(parseInt(a)).toFixed(0)+"";if(b.length<=3){return b}return this._formatAmountThousandsHelper(b.substr(0,b.length-3))+this._groupSymbol+b.substr(b.length-3)},formatCurrency:function(c,b,a){var e,d;if(b==null){b="USD"}if(a==null){a=2}e=this.formatNumber(c,a);return((d=this._currencyFormatMap[b])!=null?d.replace("%v",e):void 0)||(e+" "+b)},formatNumber:function(b,a){if(a==null){a=2}return(b<0?this._minusSignSymbol:"")+this._formatAmountThousandsHelper(b)+(a>0?this._decimalSymbol+b.toFixed(a).split(".")[1]:"")}};DropboxCreditInfoModal={init:function(){return $j("#info_link").click(function(a){var c,b;b=_("What is Dropbox credit?");c=_("Dropbox credit is similar to store credit when you return an item or\nreceive a refund. It is virtual money that will be applied to your bill\nbefore we charge the remainder to your credit card. Normally you receive\nDropbox credit as a result of changing your subscription.");return Modal.icon_show("alert_32",b,c)})}};var Photos,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(g,b,d,k,h,c,a,i,m){var f,j,l,e;this.event_metadata_cache=a;this.initialized=true;this.disable_selection();Util.disable_ie_image_dragging();this._tmpl=HTML.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=HTML.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=h!=null?h.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=i.include_shared_folders;this.show_hidden=i.show_hidden;this.timestamp_edit_enabled=m.timestamp_edit_enabled;this.undo_enabled=m.undo_enabled;this.local_storage_enabled=m.local_storage_enabled;j=DBHistory.deconstruct_url();e="share" in j.qargs;for(l in k){if(k.hasOwnProperty(l)){PhotosSelection.inc_num_loading_events_before_select(e)}}this._init_timeline(g,b,d,k);this._init_lightbox();f=[];if(h!=null){f.push(new PhotoCollection(h,false))}PhotosCollections.init(f,c);PhotosSelection.drag_select_enabled=m.drag_select_enabled;if(i.show_photos_tour){PhotosTour.next()}delete j.qargs.selr;delete j.qargs.user_email;delete j.qargs.uid;delete j.qargs.share;delete j.qargs.m;if("uuid" in j.qargs){delete j.qargs.uuid;delete j.qargs.id}if(HTML5_HISTORY){DBHistory.replace_state(j.path,j.qargs)}else{if(!Util.url_hash()){DBHistory.push_state("/photos",j.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(Lightbox.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(Lightbox.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(Lightbox.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(Lightbox.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(ContextMenu.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));DBHistory.add_callback("/photos",this._history_change_handler.bind(this));document.observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(PhotoEvent.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(PhotoTimeline.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(PhotoTimeline.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));$j("#photos-nav-item").on("click",this.show_all_photos.bind(this));$j("#back-to-photos").on("click",this._back_to_photos.bind(this));$j("#back-to-albums").on("click",this._back_to_albums.bind(this));$j("#share-selected").on("click",this._share_selected.bind(this));$j("#clear-selected").on("click",this._clear_selected.bind(this));$j("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){$j("#do-include-shared-folders").prop("checked",true)}else{$j("#dont-include-shared-folders").prop("checked",true)}$j("input[name=shared-folder-pref]").on(($j.browser.msie_version_at_most(8)?"click":"change"),this._change_memory_lane_settings.bind(this));PhotosCollections.listen();PhotosSelection.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));return $(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this))},_select_event:function(i){var d,h,c,g,b,f,a;h=$(i.target).up(".cu-month-header").identify().slice(2);d=this.get_timeline().events.valueFromKey(h);f=d.photos;a=[];for(g=0,b=f.length;g<b;g++){c=f[g];a.push(PhotosSelection._add(c))}return a},_share_event:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return this._share_selected()},_add_event_to_album:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return PhotosCollections.show_add_to_album_modal(h,PhotosSelection.get())},_init_timeline:function(h,c,d,j){var b,k,i,a,l,g,f,e;if(!h.length){this.show_empty_state();return}b=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");g=$("cu-view").cumulativeOffset().top+b.getLayout().get("margin-top")+b.getLayout().get("padding-top");i=$("cu-view").cumulativeOffset().left+b.getLayout().get("margin-left")+b.getLayout().get("padding-left");k={top_offset:g,left_offset:i,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};a={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};l=new PhotoTimeline(b,null,h,c,d,j,this._tmpl,k,a);if(this.in_single_collection_view()){if((f=this._single_collection_timeline)!=null){f.unlisten()}this._single_collection_timeline=l}else{if((e=this._all_photos_timeline)!=null){e.unlisten()}this._all_photos_timeline=l}return this.get_timeline().render()},_init_lightbox:function(){var b,a;if(this.get_timeline()==null){return}if(Lightbox.shown){a=this.get_timeline().get_preview_objs();if(a.length){Lightbox.update_previews(a);b=Math.min(Lightbox.current_index(),a.length-1);return Lightbox.jump_to(b)}else{return Lightbox.back()}}else{return Lightbox.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(b){var a;if((a=this.get_timeline())!=null){a.unlisten()}PhotosSelection.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(b);return window.scrollTo(0,0)},_refresh_photo_events:function(b){var a=this;this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:function(c){var d;d=JSON.parse(c.responseText);if(d==="deleted_collection"){a._current_collection_gid=null;PhotosCollections.reload();a.show_all_collections();Notify.server_error(_("This album has been deleted!"));return}a._init_timeline(d.header_ids,d.header_id_to_name,d.header_id_to_num_photos,{});a._init_lightbox();return typeof b==="function"?b():void 0}})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(a){if(a.duplicates_info!=null){return this._show_duplicates_modal(a,false)}else{return window.open(this._get_browse_link(a),"_blank")}},_get_browse_link:function(b){var a;a=Util.get_browse_root(viewer.photos_user);return String(URI({path:""+a+(Util.normalize(Util.parentDir(b.fq_path))),query:{select:b.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return PhotosCollections.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return Util.enableSelection($(document.body))},disable_selection:function(){return Util.disableSelection($(document.body))},show_collection:function(c){var b,a;PhotosLogger.log_transition_to(PhotosViews.SINGLE_COLLECTION_VIEW);a=DBHistory.deconstruct_url();b="/lightbox";if(a.path.indexOf(b)===0){a.path=a.path.slice(b.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(__indexOf.call(a.path,"/album/")<0){if(a.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(c!=null){a.path=PhotosCollections.get(c).url}return DBHistory.push_state(a.path,a.qargs)},show_all_collections:function(){PhotosLogger.log_transition_to(PhotosViews.ALBUMS_VIEW);return DBHistory.push_state("/photos/all_albums")},show_all_photos:function(b){var a;b.preventDefault();PhotosLogger.log_transition_to(PhotosViews.PHOTOS_VIEW);a=DBHistory.deconstruct_url();if(a.path==="/photos"){return this._refresh_view()}else{PhotosSelection.clear();return DBHistory.push_state("/photos")}},_back_to_photos:function(a){PhotosSelection.clear();return this.show_all_photos(a)},_back_to_albums:function(a){PhotosSelection.clear();return this.show_all_collections()},get_thumb_click_event_data:function(c,a){var b;b=c.event;return{timeline_photo_index:a,event_photo_index:b.photos.indexOf(c),num_photos_in_event:b.photos.length,event_index:this.get_timeline().events.list.indexOf(b.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(b){var a;a=this.get_timeline().get_photo_for_thumb_elm($(b.target));if(PhotosSelection._drag_drop.ignore_next_click){return PhotosSelection._drag_drop.ignore_next_click=false}else{return PhotosSelection.photo_click(b,a)}},_thumb_double_click:function(d){var c,b,a;b=this.get_timeline().get_photo_for_thumb_elm($(d.target));a=this.get_timeline().index_of_photo(b);this._preview(a);c=this.get_thumb_click_event_data(b,a);return PhotosLogger.log_interaction(PhotosEvents.OPEN_LIGHTBOX,PhotosTriggers.DBL_CLICK,c)},_thumb_context_menu:function(g){var c,h,f,b,d,a;c=this.get_timeline().get_photo_for_thumb_elm($(g.target));if(g.shiftKey){PhotosSelection.photo_click(g,c);return}if(PhotosSelection.contains(c)){h=PhotosSelection.get()}else{h=[c]}ContextMenu.show_photos(g,h);a=[];for(f=0,b=h.length;f<b;f++){c=h[f];a.push((d=this.get_timeline().get_thumb_elm_for_photo(c))!=null?d.addClassName("context-selected"):void 0)}return a},_context_menu_hide:function(a){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(b){var a;a=PhotosSelection.get();if(!a.length){return}Foshmodal.show(a,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.SAH,{num_photos:a.length})},_clear_selected:function(b){var a;a=PhotosSelection.get().length;PhotosSelection.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.SAH,{num_photos:a})},_share_collection:function(b){var a;assert(this.in_single_collection_view(),"_share_collection can only happen in single collection view");a=this.get_current_collection();if(a.num_items===0){Notify.server_error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(this.get_current_collection(),true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.SCA)},toggle_mem_lane_settings:function(a){var c,b;if(a){Event.extend(a).preventDefault()}if(!$j("#memory-lane-settings-menu").visible()){b=$j("#memory-lane-settings-menu");FreshDropdown.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));c=function(d){return d.stopPropagation()};b.off("mousedown");b.off("click");b.on("mousedown",c);return b.on("click",c)}},_change_memory_lane_settings:function(){var a=this;FreshDropdown.hide_all();this.include_shared_folders=$j("#do-include-shared-folders").is(":checked");return new Ajax.DBRequest("/toggle_shared_folder_pref",{parameters:{value:this.include_shared_folders},onSuccess:function(e){var d,h,i,c,g,b,f;if(a.include_shared_folders){Notify.server_success(_("All photos and videos in your Dropbox are now shown."))}else{Notify.server_success(_("Photos and videos from shared folders you joined are no                                    longer shown."))}if(a.get_timeline()!=null){h=null;c=Util.get_viewport();i=c.top+a.get_timeline().top_offset;f=a.get_timeline().events.getValues();for(g=0,b=f.length;g<b;g++){d=f[g];h=d.unique_id;if((d.top_offset>=i)||(d.top_offset+d.get_height()>=c.bottom)){break}}return a._refresh_photo_events(function(){var l,m,k,j;if(__indexOf.call(a.get_timeline().events.list,h)<0){l=h;j=a.get_timeline().events.list;for(m=0,k=j.length;m<k;m++){h=j[m];if(h<l){break}}}d=a.get_timeline().events.valueFromKey(h);return Util.scroll_to(0,d.top_offset-a.get_timeline().top_offset)})}}})},show_delete_photos_modal:function(i){var j,f,c,g,a,b,d,h,e;if(i.length===1){b=i[0];if(b.duplicates_info!=null){this._show_duplicates_modal(b,true);return}}else{j=[];for(d=0,h=i.length;d<h;d++){b=i[d];if(b.duplicates_info!=null){f=b.duplicates_info.slice(0);f.push(b);f.sort(function(l,k){return k.mtime-l.mtime});j=j.concat(f)}}if(j.length){this._show_delete_multiple_duplicates_modal(i,j);return}}e=PhotosUtil.categorize_files(i),g=e[0],a=e[1];if(g&&a){c=ungettext("Delete %(file_count)s item?","Delete %(file_count)s items?",i.length)}else{if(g){c=ungettext("Delete %(file_count)s photo?","Delete %(file_count)s photos?",i.length)}else{c=ungettext("Delete %(file_count)s video?","Delete %(file_count)s videos?",i.length)}}c=c.format({file_count:i.length});DomUtil.fillVal(PhotosUtil.file_desc(i),"delete_filename");return Modal.icon_show("delete_32",c,DomUtil.fromElm("delete-file"),{action:this._delete_photos.curry(i),wit_group:"delete-confirm"})},_delete_photos:function(q){var m,j,d,n,a,b,p,i,g,f,o,c,h,e,k,l=this;q=q.slice(0);p=[];for(g=0,o=q.length;g<o;g++){b=q[g];p.push(b.fq_path);if(b.duplicates_info!=null){h=b.duplicates_info;for(f=0,c=h.length;f<c;f++){d=h[f];p.push(d.fq_path)}}}e=PhotosUtil.categorize_files(q),n=e[0],a=e[1];if(n&&a){j=ungettext("Deleting file","Deleting files",p.length);m=ungettext("Deleted file.","Deleted files.",p.length)}else{if(n){j=ungettext("Deleting photo","Deleting photos",p.length);m=ungettext("Deleted photo.","Deleted photos.",p.length)}else{j=ungettext("Deleting video","Deleting videos",p.length);m=ungettext("Deleted video.","Deleted videos.",p.length)}}k=function(r){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(r)},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(s){var t;t=_("Undo complete");Notify.server_success(t);return Photos._all_photos_timeline.restore_removed_photos()},subject_user:viewer.photos_user})};i=function(r){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:p},job:p.length>Photos.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:viewer.photos_user,progress_text:j,onSuccess:function(u){var s,v,t;v=u.responseText.evalJSON();t=Photos.undo_enabled&&(Photos._all_photos_timeline!=null);s=t?v.changesets:null;Notify.server_success(m,null,null,s,k);Photos.get_timeline().remove_photos(q);if(r.length>0){return PhotosCollections.refresh_album_views(r)}},subject_user:viewer.photos_user})};return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(p)},onSuccess:function(t){var s,r,u,v;r=JSON.parse(t.responseText);u=[];for(v in r){s=r[v];u=u.concat(s)}return i(u)}})},_preview:function(a){return Lightbox.show(a)},_lightbox_delete:function(a){var b;b=a.memo.photo;PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.LIGHTBOX);return this.show_delete_photos_modal([b])},_lightbox_remove:function(b){var a;a=b.memo.photo;this.get_current_collection().remove_photos([a]);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.LIGHTBOX)},_show_duplicates_modal:function(b,q){var i,p,g,k,j,d,m,c,h,l,a,o,e,n,f;j=b.duplicates_info.slice(0);j.push(b);j.sort(function(s,r){return r.mtime-s.mtime});k=$("cu-duplicate-files");d=[];for(e=0,n=j.length;e<n;e++){g=j[e];p="Dropbox"+Util.normalize(Util.parentDir(g.fq_path));d.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:g.filename.em_snippet(this.DUPLICATES_SNIPPET_LENGTH),path_snippet:p.em_snippet(this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}k.__date(d);if(j.length>=5){k.addClassName("scroll")}else{k.removeClassName("scroll")}f=PhotosUtil.categorize_files([b]),l=f[0],a=f[1];if(l){c=_("There are multiple copies of this photo.");h=_("Delete all copies of this photo?")}else{c=_("There are multiple copies of this video.");h=_("Delete all copies of this video?")}if(q){m="delete_32";o=h;i=c+" "+_("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{m="folder_32";o=_("Show in folder");i=c+" "+_("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}DomUtil.fillVal(i,"cu-duplicates-desc");return Modal.icon_show(m,o,$("cu-duplicates-modal"),{action:this._delete_photos.curry([b])})},_show_delete_multiple_duplicates_modal:function(n,i){var m,g,j,c,b,h,f,k,a,d,l,e;j=$("cu-multiple-duplicate-files");c=[];for(d=0,l=i.length;d<l;d++){g=i[d];m="Dropbox"+Util.normalize(Util.parentDir(g.fq_path));c.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:g.filename.em_snippet(this.DUPLICATES_SNIPPET_LENGTH),path_snippet:m.em_snippet(this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}j.__date(c);if(i.length>=5){j.addClassName("scroll")}else{j.removeClassName("scroll")}e=PhotosUtil.categorize_files(n),k=e[0],a=e[1];if(k&&a){b=_("Delete %(num_files)s files and all copies?").format({num_files:n.length});h=_("There are multiple copies of these files in your Dropbox.");f=_("Show files with multiple copies")}else{if(k){b=_("Delete %(num_photos)s photos and all copies?").format({num_photos:n.length});h=_("There are multiple copies of these photos in your Dropbox.");f=_("Show photos with multiple copies")}else{b=_("Delete %(num_videos)s videos and all copies?").format({num_videos:n.length});h=_("There are multiple copies of these videos in your Dropbox.");f=_("Show videos with multiple copies")}}DomUtil.fillVal(h,"cu-multiple-duplicates-desc");DomUtil.fillVal(f,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return Modal.icon_show("delete_32",b,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(n)})},show_timestamps_modal:function(f){var b,c,d,a,e;f.sort_by_key((function(g){return g.time_taken}),true);a=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.time_taken)}return g})();b=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.item_counter)}return g})();c=(function(){var i,h,g;g=[];for(i=0,h=a.length;i<h;i++){e=a[i];if(!(e!=null)){g.push(e)}}return g})();if(c.length===a.length){return this._show_add_timestamps_modal(f,a,b)}else{if(c.length===0){return this._show_edit_timestamps_modal(f,a,b)}else{return assert(false,"Timestamp modal should only open when all selected photos either have or don't        have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(a,b){var c=this;return this._refresh_photo_events(function(){var d,e;e=("m_"+(b.getFullYear()))+(""+(b.getMonth()+1)).lpad(2);d=c.get_timeline().events.valueFromKey(e);assert(d!=null,"Event is missing after a timestamp edit!");ModalProgress.update("2/3");d.on_load_all_metadata=function(){c.get_timeline().scroll_to_photo_with_key(a.uniqueness_key);ModalProgress.hide();return Notify.server_success("New timestamps have been saved!")};if(d.has_loaded_metadata()){d.on_load_all_metadata();return d.on_load_all_metadata=null}else{return d.load_metadata()}})},_show_add_timestamps_modal:function(f,b,a){var d,c,e=this;c=$j("#add-timestamp-modal");d=new DBCalendar("date_picker",{disable_future:true});return Modal.show("Set Timestamps",c[0],{action:function(){var k,o,m,n,h,j,l,g;m=Util.to_iso8601_date(d.selected_date,false,true);n=(function(){var q,p,i;i=[];for(j=q=0,p=f.length;0<=p?q<p:q>p;j=0<=p?++q:--q){i.push(m)}return i})();h={};for(k=l=0,g=a.length;l<g;k=++l){o=a[k];h[o]=n[k]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(h)},onSuccess:function(i){ModalProgress.update("1/3");return e._scroll_to_photo_after_timestamp_edit(f[0],d.selected_date)}})}})},_show_edit_timestamps_modal:function(j,i,e){var a,h,c,f,g,b,d=this;h=$j("#edit-timestamp-modal");a=(function(){var m,l,k;k=[];for(m=0,l=i.length;m<l;m++){f=i[m];k.push(DateUtil.toUTCDate(new Date(f)))}return k})();c={year:0,month:0,day:0,hour:0};g=function(k){return _("%(date)s at %(time)s").format({date:DateUtil.localize(k),time:DateUtil.format(k,Constants.time_format)})};b=function(k,o,p,n){var m,l;if(k==null){k=0}if(o==null){o=0}if(p==null){p=0}if(n==null){n=0}c.year+=k;c.month+=o;c.day+=p;c.hour+=n;l=Util.incrementDate(new Date(a[0]),c.year,c.month,c.day,c.hour,0);m=Util.incrementDate(new Date(a[a.length-1]),c.year,c.month,c.day,c.hour,0);if(j.length===1){return h.find("#timestamp-new").text(g(l))}else{h.find("#timestamp-new-start").text(g(l));return h.find("#timestamp-new-end").text(g(m))}};if(j.length===1){h.find("#edit-timestamp-single").show();h.find("#edit-timestamp-multi").hide();h.find("#timestamp-current").text(g(a[0]))}else{h.find("#edit-timestamp-single").hide();h.find("#edit-timestamp-multi").show();h.find("#timestamp-current-start").text(g(a[0]));h.find("#timestamp-current-end").text(g(a[a.length-1]))}b();$j("#timestamp-year-plus").on("click",b.curry(1,0,0,0));$j("#timestamp-year-minus").on("click",b.curry(-1,0,0,0));$j("#timestamp-month-plus").on("click",b.curry(0,1,0,0));$j("#timestamp-month-minus").on("click",b.curry(0,-1,0,0));$j("#timestamp-day-plus").on("click",b.curry(0,0,1,0));$j("#timestamp-day-minus").on("click",b.curry(0,0,-1,0));$j("#timestamp-hour-plus").on("click",b.curry(0,0,0,1));$j("#timestamp-hour-minus").on("click",b.curry(0,0,0,-1));Modal.onHide=function(){var k,n,l,m;m=["year","month","day","hour"];for(n=0,l=m.length;n<l;n++){k=m[n];$j("#timestamp-"+k+"-plus").off("click");$j("#timestamp-"+k+"-minus").off("click")}Modal.onHide=null;return Modal.hide()};return Modal.show("Edit Timestamps",h[0],{action:function(){var u,q,k,l,r,w,s,o,v,p,n,m;if((((c.year===(m=c.month)&&m===(n=c.day))&&n===(p=c.hour))&&p===0)){return}PhotosLogger.log_interaction(PhotosEvents.EDIT_TIMESTAMP,PhotosTriggers.PCM,{num_photos:j.length});l=(function(){var y,x,t;t=[];for(y=0,x=a.length;y<x;y++){u=a[y];t.push(Util.incrementDate(u,c.year,c.month,c.day,c.hour,0))}return t})();r=(function(){var y,x,t;t=[];for(y=0,x=l.length;y<x;y++){w=l[y];t.push(Util.to_iso8601_date(w,false,true))}return t})();s={};for(q=o=0,v=e.length;o<v;q=++o){k=e[q];s[k]=r[q]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(s)},job:j.length>d.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:viewer.photos_user,onSuccess:function(t){ModalProgress.update("1/3");return d._scroll_to_photo_after_timestamp_edit(j[0],l[0])}})}})},_preload_file_previews:function(d){var k,h,c,a,p,o,l,j,m,g,f,n,b,e;m=this.get_timeline().get_photos();if(d[0]<=d[d.length-1]){j=null;for(g=0,n=d.length;g<n;g++){h=d[g];a=m[h];if(a.status!==Photo.PLACEHOLDER){continue}p=a.event;if(!(j!=null)){j=p;l=a}if(p===j){continue}if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}j.load_metadata();j=p;l=a}if((j!=null)&&!j.has_loaded_metadata()){k=j.photos.indexOf(l);c=j.photos.indexOf(a);if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return j.load_metadata_range(k,c)}}else{e=[];for(f=0,b=d.length;f<b;f++){h=d[f];a=m[h];if(a.status!==Photo.PLACEHOLDER){continue}p=a.event;o=p.photos.indexOf(a);e.push(p.load_metadata(o))}return e}},_lightbox_photo_change:function(j){var a,l,g,k,h,f,i,d,c,b;this._last_lightbox_photo=j.memo.preview_obj.photo;a=j.memo.index;g=Lightbox.num_previews();if(a===0||a===g-1){return}if(j.memo.direction===Lightbox.NEXT||!(j.memo.direction!=null)){l=Math.min(a+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,g-1);return this._preload_file_previews((function(){c=[];for(var e=i=a+1;i<=l?e<=l:e>=l;i<=l?e++:e--){c.push(e)}return c}).apply(this))}else{if(j.memo.direction===Lightbox.PREV){k=Math.max(a-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){b=[];for(var e=d=a-1;d<=k?e<=k:e>=k;d<=k?e++:e--){b.push(e)}return b}).apply(this))}}},_lightbox_exit:function(a){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var c,b,d,a;b=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");c=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((d=this._all_photos_timeline)!=null){d.update_offsets(b,c)}return(a=this._single_collection_timeline)!=null?a.update_offsets(b,c):void 0},_history_change_handler:function(n,m){var i,j,k,f,d,g,l,h,e,c,b,a;if(this._init_finished){if(Modal.shown()){Modal.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((h=this.get_timeline())!=null){h.unlisten()}if(n==="all_albums"){PhotosCollections.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((e=$("all-albums-sidebar"))!=null){e.addClassName("selected")}PhotosSelection.clear();document.title=_("Albums")+" - Dropbox";PhotosCollections.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(n.startsWith("album/")){i=PhotosCollections.get_from_url("/photos/"+n);c=$$(".sidebar-album");for(g=0,l=c.length;g<l;g++){k=c[g];if(k.readAttribute("data-gid")===i.gid){k.addClassName("selected");break}}$("single-collection-title").__date(i.name.em_snippet(PhotosCollections.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(i.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",i.shmodel_url);if(((b=i.member_fnames)!=null?b.length:void 0)>1){j=_("%(photo_video_desc)s from %(album_members)s").format({photo_video_desc:PhotosUtil.album_desc(i),album_members:Util.nice_list(i.member_fnames)});$("single-collection-share-status").__date(j)}else{$("single-collection-share-status").__date(_("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!i.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+i.name+" - Dropbox";AlbumsLogger.log_event("show_collection",i.gid,i.num_photos,i.is_anonymous)}else{i=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=_("Photos")+" - Dropbox"}f=false;if(i!=null){if(i.gid!==this._current_collection_gid){f=true}}else{if(!(this._all_photos_timeline!=null)){f=true}}this._current_collection_gid=i!=null?i.gid:null;if(f){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){d=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(d);if((a=$(d))!=null){a.addClassName("wiggobble")}setTimeout((function(){return $(d).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var PhotosTour;PhotosTour={_frame:0,next:function(){var a,b=this;Modal.show("",$j("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);a=this._frame;PhotosLogger.log_interaction(PhotosTourEvents.SHOW_MODAL,"",{frame:a});$j("#modal-x").off("click");$j("#modal-x").on("click",(function(){return PhotosLogger.log_interaction(PhotosTourEvents.EXIT_MODAL,"",{frame:a})}));return this._frame=(this._frame+1)%4},hide:function(a){PhotosLogger.log_interaction(a,"");return Modal.hide()}};var PhotosUtil;PhotosUtil={categorize_files:function(b){var c,a;c=b.filter(function(d){return d.preview_type==="photo"});a=b.filter(function(d){return d.preview_type==="video"});return[c.length,a.length]},file_desc:function(f,c,a){var b,e,d;if(c==null){c=false}if(a==null){a=false}d=this.categorize_files(f),b=d[0],e=d[1];return this._photo_video_desc(b,e,c,a)},album_desc:function(c,b,a){if(b==null){b=false}if(a==null){a=false}return this._photo_video_desc(c.num_photos,c.num_videos,b,a)},_photo_video_desc:function(b,g,c,a){var d,f,e;f=ungettext("%d photo","%d photos",b).format(b);e=ungettext("%d video","%d videos",g).format(g);if(b&&g){if(c){d=b+g;return ungettext("%d item","%d items",d).format(d)}else{if(a){return new HTML(""+f+"<br/>"+e)}else{return _("%(num_photos)s and %(num_videos)s").format({num_photos:f,num_videos:e})}}}else{if(b){return f}else{if(g){return e}else{return""}}}}};var PhotosSelection,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){var a=this;$(document.body).on("keydown",function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&a._last_mouseover&&!Util.focus_in_input()){return a._highlight_range(a._last_selected,a._last_mouseover)}});$(document.body).on("keyup",function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&!a._marquee.active){return a.clear_highlighted()}});key("delete, command+backspace, backspace",Photos.KEY_SCOPE,function(b){b.preventDefault();if(Photos.in_single_collection_view()){if(a._selected.length){return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),a._selected)}}else{if(a._selected.length){return Photos.show_delete_photos_modal(a._selected)}}});key("esc",Photos.KEY_SCOPE,function(c){var b;if(typeof c.preventDefault==="function"){c.preventDefault()}if(a._drag_drop.active){a._drag_drop.active=false;if((b=$("albums-sidebar-list"))!=null){b.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{a.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.ESC)}});$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document.body).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return DragScroll.init(null,$j("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(b){var a,d,c;d=(function(){var h,f,g,e;g=this._selected;e=[];for(h=0,f=g.length;h<f;h++){a=g[h];e.push(a.uniqueness_key)}return e}).call(this);return c=b.uniqueness_key,__indexOf.call(d,c)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");FreshDropdown.hide_all();return document.fire(PhotosSelection.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(b,a){if(b.isRightClick()&&!b.shiftKey){return}if(b.shiftKey){return this._select_highlighted()}else{if(this.contains(a)){return this._remove(a)}else{return this._add(a)}}},num_selected:function(){return this._selected.length},refresh:function(d){var f,g,c,h,e,b,a;h=(function(){var l,j,k,i;k=this._selected;i=[];for(l=0,j=k.length;l<j;l++){c=k[l];i.push(c.uniqueness_key)}return i}).call(this);a=[];for(e=0,b=d.length;e<b;e++){g=d[e];f=h.indexOf(g.uniqueness_key);if(f>=0){a.push(this._selected[f]=g)}else{a.push(void 0)}}return a},inc_num_loading_events_before_select:function(a){if(!this._show_share_after_loading_selected){ModalProgress.show(_("Loading photos..."))}this._show_share_after_loading_selected=a;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;ModalProgress.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){ModalProgress.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return Photos._share_selected()}}}},_photo_mouseover:function(a){this._last_mouseover=Photos.get_timeline().get_photo_for_thumb_elm($(a.target));if(a.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(a){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(d){var a,b,c;if(Photos.in_all_collections_view()||d.isRightClick()||this._invalid_mouse_target($(d.target))){return}ContextMenu.hide();FreshDropdown.hide_all();a=(c=Photos.get_timeline())!=null?c.get_photo_for_thumb_elm($(d.target)):void 0;if(a!=null){if(this.contains(a)||!PhotosSelection.drag_select_enabled){b=Util.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=d.clientX+b.left;this._drag_drop.start_y=d.clientY+b.top;this._drag_drop.anchor=$(d.target);this._drag_drop.single_photo=this.contains(a)?null:a;this._build_drag_status(a);this._update_drag_status_position(d)}else{this._drag_select.active=true;this._drag_select.anchor=a}}else{b=Util.scroll_offsets();if((d.clientX+b.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=d.clientX+b.left;this._marquee.start_y=d.clientY+b.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return DragScroll.start()},_body_mousemove:function(d){var b,a,f,c;b=Util.scroll_offsets();a=d.clientX+b.left;f=d.clientY+b.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(a-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=a;this._marquee.end_y=f;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(a-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(d);$$(".sidebar-album").invoke("removeClassName","album-flash");if((c=$("albums-sidebar-list"))!=null){c.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(c){var b,a;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();b=this._highlighted.length;this._select_highlighted();if(b){PhotosLogger.log_interaction(PhotosEvents.MARQUEE_SELECT,PhotosTriggers.DRAG,{num_selected:b})}}if(this._drag_drop.active){if($(c.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((a=$("albums-sidebar-list"))!=null){a.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return DragScroll.end()},_body_double_click:function(a){if(Photos.get_timeline().get_photo_for_thumb_elm($(a.target))||this._invalid_mouse_target($(a.target))){return}this.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.DBL_CLICK)},_draw_marquee:function(){var a,e,d,c,b;b=Math.abs(this._marquee.start_x-this._marquee.end_x);a=Math.abs(this._marquee.start_y-this._marquee.end_y);d=Math.min(this._marquee.start_y,this._marquee.end_y);e=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:b+"px",height:a+"px",top:d+"px",left:e+"px"});$("marquee").show();c=false;if(Photos.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);c=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);c=true}if(c){return this._update_marquee_highlight(d,e,b,a)}}},_update_marquee_highlight:function(m,c,a,o){var k,l,h,b,g,f,n,j,e,d;this.clear_highlighted();b=[];l=Photos.get_timeline().grid.photo_col_offsets.length;j=Photos.get_timeline().grid.photo_col_offsets.slice(0,l-1);for(k=g=0,n=j.length;g<n;k=++g){h=j[k];if(h<=c+a&&Photos.get_timeline().grid.photo_col_offsets[k+1]>=c){b.push(k)}}d=[];for(k=f=0,e=Photos.get_timeline().events.length();0<=e?f<e:f>e;k=0<=e?++f:--f){d.push(Photos.get_timeline().events.valueAtIndex(k).marquee_highlight(m,m+o,b))}return d},_update_marquee_x_bounds:function(a){var d,g,h,f,c,e,b;g=$(document.body).getWidth();if(a<Photos.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=Photos.get_timeline().grid.photo_col_offsets.first()}else{if(a>Photos.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=g}else{e=Photos.get_timeline().grid.photo_col_offsets;b=[];for(d=f=0,c=e.length;f<c;d=++f){h=e[d];if(h>a){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets[d-1];this._marquee.x_max_boundary=h;break}else{b.push(void 0)}}return b}}},_update_marquee_y_bounds:function(h){var a,e,d,g,c,f,b;d=$(document.body).getHeight();if(h<Photos.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=Photos.get_timeline().grid.photo_row_offsets.first()}else{if(h>Photos.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=d}else{f=Photos.get_timeline().grid.photo_row_offsets;b=[];for(e=g=0,c=f.length;g<c;e=++g){a=f[e];if(a>h){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets[e-1];this._marquee.y_max_boundary=a;break}else{b.push(void 0)}}return b}}},_build_drag_status:function(d){var c,a,b;a=Photos.get_timeline().get_thumb_elm_for_photo(d);b=a.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(b);c=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(PhotosUtil.file_desc(c,false,true))},_update_drag_status_position:function(a){return $("photos-drag-status").setStyle({left:(a.pointerX()-Util.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(a.pointerY()-Util.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(n,m,c){var l,a,d,h,k,j,b,f,g,e;if(c==null){c=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=n;this._last_highlight_to_photo=m;d=Photos.get_timeline().index_of_photo(n);b=Photos.get_timeline().index_of_photo(m);l=!c&&this.contains(m)&&!this.contains(n);e=[];for(h=f=d;d<=b?f<=b:f>=b;h=d<=b?++f:--f){j=Photos.get_timeline().photo_at_index(h);if(j.status===Photo.PLACEHOLDER){if(j.event!==k){a=j.event;if(!a.has_loaded_metadata()){a.on_load_all_metadata=this._highlight_range_incremental.bind(this);a.load_metadata();if(g=a.unique_id,__indexOf.call(this._events_highlighting,g)<0){this._events_highlighting.push(a.unique_id)}e.push(k=a)}else{e.push(void 0)}}else{e.push(void 0)}}else{if(this.contains(j)){if(l){e.push(this._dehighlight(j))}else{e.push(void 0)}}else{if(!l){e.push(this._highlight(j))}else{e.push(void 0)}}}}return e},_highlight_range_incremental:function(a){var h,c,j,e,f,b,g,d;j=this._last_highlight_from_photo;g=this._last_highlight_to_photo;if(!((j!=null)&&(g!=null))){return}c=Photos.get_timeline().index_of_photo(j);b=Photos.get_timeline().index_of_photo(g);for(e=d=c;c<=b?d<=b:d>=b;e=c<=b?++d:--d){f=Photos.get_timeline().photo_at_index(e);if(f.status!==Photo.PLACEHOLDER&&!this.contains(f)&&this._highlighted.indexOf(f)===-1){this._highlight(f)}}h=this._events_highlighting.indexOf(a.unique_id);if(h>=0){this._events_highlighting.splice(h,1)}if(this._select_highlighted_waiting){ModalProgress.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(d){var c,e,b,a;this.clear_highlighted();a=[];for(e=0,b=d.length;e<b;e++){c=d[e];if(!this.contains(c)){a.push(this._highlight(c))}else{a.push(void 0)}}return a},_select_highlighted:function(){var d,g,e,c,b,f,a;if(this._events_highlighting.length>0){ModalProgress.show(_("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}f=this._highlighted;for(g=0,c=f.length;g<c;g++){d=f[g];this._add(d)}a=this._dehighlighted;for(e=0,b=a.length;e<b;e++){d=a[e];this._remove(d)}if(this._select_highlighted_waiting){ModalProgress.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(b){var a;this._highlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("highlighted"):void 0},_dehighlight:function(b){var a;this._dehighlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("dehighlighted"):void 0},_add:function(b){var a;assert(b.status!==Photo.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);a=Photos.get_timeline().get_thumb_elm_for_photo(b);if(a!=null){a.addClassName("selected")}this._selected.push(b);this._last_selected=b;DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(PhotosSelection.CHANGE_EVT)},_remove:function(c){var b,a;a=Photos.get_timeline().get_thumb_elm_for_photo(c);if(a!=null){a.removeClassName("selected")}b=this._selected.indexOf(c);if(b!==-1){this._selected.splice(b,1);this._last_selected=c;if(this._selected.length){DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(PhotosSelection.CHANGE_EVT)},_invalid_mouse_target:function(c){var a,b;a=c.classNames().toArray().concat(c.up().classNames().toArray());return(__indexOf.call(a,"freshbutton")>=0)||(__indexOf.call(a,"freshbutton-blue")>=0)||(__indexOf.call(a,"freshbutton-lightblue")>=0)||(__indexOf.call(a,"freshbutton-blue-on-gray")>=0)||(__indexOf.call(a,"timeline-elm")>=0)||(c.up(".no-marquee")!=null)||(c.up("#context-menu")!=null)||(c.up(".freshdropdown-menu")!=null)||c.nodeName==="A"||((b=c.tagName.toUpperCase())==="INPUT"||b==="TEXTAREA"||b==="SELECT")||Modal.shown()||$("modal-progress-content").visible()||Lightbox.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var PhotosCollections,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new HTML('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(b,a){this._collections=b;this._gid_to_collection=b.dict_by("gid");this._url_to_collection=b.dict_by("url");this._collection_list_item_tmpl=HTML.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=HTML.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var a;a=DBHistory.deconstruct_url();if(a.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(a){var b=this;if(this._num_loading_collections!==null&&(this._num_loading_collections<a||a===null)){this._num_loading_collections=a;return new Ajax.DBRequest("/collections",{parameters:{limit:a},allow_retries:true,onSuccess:function(e){var i,h,d,g,c,f;d=JSON.parse(e.responseText);for(g=0,c=d.length;g<c;g++){h=d[g];if(!(h.gid in b._gid_to_collection)&&!(f=h.gid,__indexOf.call(b._removed_pre_load,f)>=0)){i=new PhotoCollection(h,false);b._collections.push(i);b._gid_to_collection[i.gid]=i;b._url_to_collection[i.url]=i}}if(a===null||d.length<a){b._all_collections_loaded=true;b._sidebar_collections_loaded=true}if(a>=5){b._sidebar_collections_loaded=true}return b.refresh_album_views()}})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){var a=this;$("single-collection-title").observe("click",function(b){if(!Photos.get_current_collection().is_creator){return}a.header_rename();return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CLICK_TITLE)});$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(ContextMenu.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(PhotoCollection.CREATE_EVT,this._collection_created.bind(this));document.observe(PhotoCollection.ADD_EVT,this._collection_photos_added.bind(this));document.observe(PhotoCollection.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(PhotoCollection.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(PhotoCollection.RENAME_EVT,this._collection_renamed.bind(this));document.observe(PhotoCollection.DELETE_EVT,this._collection_deleted.bind(this));document.observe(PhotoCollection.SHARE_EVT,this._collection_shared.bind(this));document.observe(PhotoCollection.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(PhotoCollection.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var e,b,d,a,c;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}b=[];c=this._collections;for(d=0,a=c.length;d<a;d++){e=c[d];b.push(this._collection_list_item_tmpl({collection:e,additional_class:"albums-list-item show-collection-target"}))}$("albums-list").__date(b);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var f,b,c,e,a,d;b=[];c={name:_("Create new album"),thumbnail_url_256:"/static/images/new_album_big.png"};b.push(this._collection_list_item_tmpl({collection:c,additional_class:"create-album-target",hide_icons:true}));d=this._collections;for(e=0,a=d.length;e<a;e++){f=d[e];b.push(this._collection_list_item_tmpl({collection:f,additional_class:"add-to-album-target"}))}$("add-to-album-modal-list").__date(b);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var h,j,e,i,f,d,b,a,c,g=this;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();j=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5)});if((f=$("albums-sidebar"))!=null){f.__date(j)}if((d=$("all-albums-sidebar"))!=null){d.observe("click",Photos.show_all_collections)}if((b=$("all-albums-sidebar"))!=null){b.observe("mouseup",function(k){var l;if(!PhotosSelection._drag_drop.active){return}if(PhotosSelection._drag_drop.single_photo!=null){l=[PhotosSelection._drag_drop.single_photo]}else{l=PhotosSelection.get()}g.show_add_to_album_modal(k,l);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})})}if(Photos.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(Photos.in_single_collection_view()){a=$$(".sidebar-album");c=[];for(e=0,i=a.length;e<i;e++){h=a[e];if(h.readAttribute("data-gid")===Photos.get_current_collection().gid){h.addClassName("selected");break}else{c.push(void 0)}}return c}}},refresh_album_views:function(b){var a,c=this;if(b==null){b=null}a=function(){c.render_all_albums_view();c.render_albums_sidebar();return c.render_add_to_album_modal()};if(b!=null?b.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:JSON.stringify(b.unique())},onSuccess:function(n){var m,l,e,k,h,g,o,d,j,f;j=JSON.parse(n.responseText);for(h=0,o=j.length;h<o;h++){e=j[h];l=new PhotoCollection(e,false);c._gid_to_collection[l.gid]=l;c._url_to_collection[l.url]=l;f=c._collections;for(k=g=0,d=f.length;g<d;k=++g){m=f[k];if(m.gid===l.gid){c._collections[k]=l;break}}}return a()}})}else{return a()}},show_add_to_album_modal:function(a,b){if(b!==PhotosSelection.get()&&!(PhotosSelection._drag_drop.single_photo!=null)){PhotosSelection._context_selected=b}Modal.onHide=function(){PhotosSelection._context_selected=null;delete Modal.onHide;return Modal.hide()};Modal.show(_("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(c,e,b){var a,d;if(b==null){b=true}d=null;if(Photos.in_single_collection_view()){d=Photos.get_current_collection().gid}a=e.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;Notify.server_success(_("Adding to album..."));return c.add_photos(e,d,a,b)},show_remove_photos_modal:function(d,g){var c,a,f,b,e=this;b=PhotosUtil.categorize_files(g),a=b[0],f=b[1];if(a&&f){c=ungettext("Remove %(file_count)s item?","Remove %(file_count)s items?",g.length)}else{if(a){c=ungettext("Remove %(file_count)s photo?","Remove %(file_count)s photos?",g.length)}else{c=ungettext("Remove %(file_count)s video?","Remove %(file_count)s videos?",g.length)}}c=c.format({file_count:g.length});DomUtil.fillVal(PhotosUtil.file_desc(g),"collection-remove-files");DomUtil.fillVal(d.name.escapeHTML(),"collection-remove-name");return Modal.icon_show("delete_32",c,DomUtil.fromElm("collection-remove-modal"),{action:function(){var h;g=g.slice(0);h=g.length>e.NUM_PHOTOS_LONG_RUNNING_REMOVES;return d.remove_photos(g,h)}})},header_rename:function(){if($j("#single-collection-title-container").hasClass("editing")){return}$j("#single-collection-title-container").addClass("editing");return Photos.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-delete-name");a=_("Delete album?");return Modal.icon_show("delete_32",a,DomUtil.fromElm("collection-delete-modal"),{action:function(){if(b.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){Notify.server_success(_("Deleting '%(collection_name)s'...").format({collection_name:b.name}),100)}return b["delete"]()}})},show_unshare_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-unshare-name");a=_("Unshare album?");return Modal.icon_show("alert_32",a,DomUtil.fromElm("collection-unshare-modal"),{action:function(){return b.unshare()}})},create:function(k,j,o,b){var d,g,c,h,m,n,l,a,i,f=this;if(b==null){b=false}if(k){Event.extend(k).preventDefault();i=$(k.target);if(i.hasClassName("inplaceeditor-form")||(i.up(".inplaceeditor-form")!=null)){return}if(i.up("#context-menu")){d=true}else{if(i.up(".freshdropdown-menu")){c=true}}}Photos.enable_selection();if(!o){o=PhotosSelection.get()}h=(function(){var q,p,e;e=[];for(q=0,p=o.length;q<p;q++){a=o[q];e.push(a.item_counter)}return e})();o.sort_by_key(function(e){return e.time_taken});m=o.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;l=function(p){var s,q,e,r;q=JSON.parse(p.responseText);s=new PhotoCollection(q);PhotosSelection.clear();FreshDropdown.hide_all();ContextMenu.hide();Modal.hide();Photos.disable_selection();r=_("Created '%(collection_name)s'");e=s.name.escapeHTML();r=r.format({collection_name:"<a data-gid='"+s.gid+"' class='show-collection-target'>"+e+"</a>"});Notify.server_success(new HTML(r));return f.flash_sidebar_album(s.gid)};n=function(){if(!c){FreshDropdown.hide_all()}if(!d){ContextMenu.hide()}PhotosCollections.render_albums_sidebar();return Photos.disable_selection()};g=new Ajax.InPlaceEditor(j,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:b,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:n,onFailure:function(){},savingText:_("Creating..."),onLeaveEditMode:Photos.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:l,job:m,job_user:viewer.photos_user,progress_text:_("Creating album...")},callback:function(e,q){var p;Notify.server_success(_("Creating album..."));p={collection_name:q,item_counters:JSON.stringify(h)};if(Photos.in_single_collection_view()){p.source_collection_gid=Photos.get_current_collection().gid}return p}});g.enterEditMode();if(!b){return g._controls.editor.observe("blur",n)}},toggle_more_selected_actions:function(a){if(a){Event.extend(a).preventDefault()}if(!$("more-selected-actions-menu").visible()){return FreshDropdown.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(a){var b;if(a){Event.extend(a).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(Photos.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if($j.browser.msie_version_at_most(10)){b=$j("#more-collection-actions-menu");if(!b.parent().is("body")){$j(document.body).append(b.remove())}}return FreshDropdown.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(a){var b;b=a.memo.collection;if(!b.is_anonymous){this._collections.unshift(b)}this._gid_to_collection[b.gid]=b;this._url_to_collection[b.url]=b;return this.refresh_album_views()},_collection_changed:function(a){this._collections.removeItem(a);this._collections.unshift(a);return this.refresh_album_views()},_collection_photos_added:function(i){var h,f,d,j,k,c,a,b,l,g;h=i.memo.collection;l=i.memo.photos;j=i.memo.num_items_added;c=i.memo.num_photos_added;b=i.memo.num_videos_added;if(i.memo.promote_collection&&j>0){this._collection_changed(h)}else{this.refresh_album_views()}if(l===PhotosSelection.get()){PhotosSelection.clear()}if(j<1){g=PhotosUtil.categorize_files(l),k=g[0],a=g[1];if(k&&a){d=ungettext("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",l.length)}else{if(k){d=ungettext("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",l.length)}else{d=ungettext("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",l.length)}}}else{if(c&&b){d=ungettext("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",l.length)}else{if(c){d=ungettext("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",l.length)}else{d=ungettext("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",l.length)}}}f=h.name.escapeHTML();d=d.format({collection_name:"<a data-gid='"+h.gid+"' class='show-collection-target'>"+f+"</a>"});return Notify.server_success(new HTML(d))},_collection_photos_removed:function(b){var c,d,a;c=b.memo.collection;d=b.memo.photos;a=Photos.undo_enabled?b.memo.undo_changeset:null;Photos.get_timeline().remove_photos(d);this._collection_changed(c);return Notify.server_success(_("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:PhotosUtil.file_desc(d),collection_name:c.name}),null,null,a,(function(){return c.undo_remove(a)}))},_collection_undid_remove:function(a){var b;b=a.memo.collection;Photos.get_timeline().restore_removed_photos();PhotosCollections.refresh_album_views([b.gid]);return Notify.server_success(_("Undo complete"))},_collection_renamed:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-title").text(c.name.em_snippet(this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+c.name+" - Dropbox"}this._collection_changed(c);return Notify.server_success(_("Renamed '%(collection_name)s'").format({collection_name:c.name}))},_collection_deleted:function(b){var c,a;c=b.memo.collection;this._collections.removeItem(c);if(!this._all_collections_loaded){this._removed_pre_load.push(c.gid)}this.refresh_album_views();if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){Photos.show_all_collections()}delete this._gid_to_collection[c.gid];delete this._url_to_collection[c.url];return Notify.server_success(_("Deleted '%(collection_name)s'").format({collection_name:c.name}))},_collection_shared:function(b){var c,a;c=b.memo.collection;this._collection_changed(c);if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text(_("Shared"));return $j("#single-collection-share-status").attr("href",c.shmodel_url)}},_collection_unshared:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text("")}return Notify.server_success(_("Unshared '%(collection_name)s'").format({collection_name:c.name}))},_collection_cover_changed:function(a){var c,b;c=a.memo.collection;this._collection_changed(c);b=_("Changed cover photo for '%(collection_name)s'");b=b.format({collection_name:c.name.escapeHTML()});return Notify.server_success(b)},_albums_list_item_contextmenu:function(b,a){ContextMenu.show_photo_collection(b,this.get(a.readAttribute("data-gid")),a);a.removeClassName("album-flash");return a.addClassName("context-selected")},_show_collection_click:function(c,a){var b;b=$(c.target);if(b.hasClassName("inplaceeditor-form")||(b.up(".inplaceeditor-form")!=null)){return}return Photos.show_collection(a.readAttribute("data-gid"))},_collection_shmodel_click:function(b,a){return this.go_to_link(this.get(a.readAttribute("data-gid")))},_add_to_album_click:function(b,a){if(PhotosSelection._context_selected){this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection._context_selected);PhotosSelection._context_selected=null}else{this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection.get())}delete Modal.onHide;Modal.hide();return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.SAH,{num_photos:PhotosSelection.get().length})},_drop_target_mouseover:function(b,a){if(PhotosSelection._drag_drop.active){a.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(b,a){if(PhotosSelection._drag_drop.active){a.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(b,a){var c;if(a.hasClassName("hovered")){a.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(PhotosSelection._drag_drop.single_photo!=null){c=[PhotosSelection._drag_drop.single_photo]}else{c=PhotosSelection.get()}if(a.readAttribute("data-gid")!=null){this.add_photos(this.get(a.readAttribute("data-gid")),c,false)}if(a.identify()==="add-to-album-sidebar-new"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_NEW_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{if(a.identify()==="all-albums-sidebar"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}}}},_create_album_click:function(a,b){if(PhotosSelection._context_selected){this.create(a,b.down(".collection-name"),PhotosSelection._context_selected,true);return PhotosSelection._context_selected=null}else{return this.create(a,b.down(".collection-name"),PhotosSelection.get(),true)}},_window_scroll:function(){if(Photos.in_all_collections_view()){return this._all_albums_scroll_position=Util.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(a){return this._url_to_collection[a]},get:function(a){return this._gid_to_collection[a]},go_to_link:function(a){return window.open(a.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(c,b){var a,e,d;a=c.em_snippet(b,1);e=a.lastIndexOf(" ");if(e===-1){return a}else{a=a.slice(0,e+1||9000000000);d=c.slice(e+1).em_snippet(b,1);return a+d}},get_default_album_name:function(){var a;a=_("Untitled album");return this.increment_collection_name_until_valid(a)},collection_name_in_use:function(b){var e,d,a,c;c=this.get_all();for(d=0,a=c.length;d<a;d++){e=c[d];if(e.name===b.trim()){return true}}return false},increment_collection_name_until_valid:function(b){var c,a;c=this.collection_name_in_use(b);a=0;while(c){a++;c=this.collection_name_in_use(b+(" ("+a+")"))}return(a===0?b:b+(" ("+a+")"))},flash_sidebar_album:function(e){var f,d,b,c,a;c=$$(".sidebar-album");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];if(f.readAttribute("data-gid")===e){f.removeClassName("album-flash");f.addClassName("album-flash");break}else{a.push(void 0)}}return a}};var PhotoTimeline;PhotoTimeline=(function(){a.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";a.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";a.prototype.THUMB_SIZE=null;a.prototype.HEADER_HEIGHT=null;a.prototype.THUMBS_PER_ROW=4;a.prototype.RENDER_SCROLL_WAIT=100;a.prototype.RENDER_SCROLL_MAX_WAIT=750;a.prototype.HIDE_TIMELINE_NAV_DELAY=1500;a.prototype.THUMBS_BATCH_SIZE=12;a.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;a.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;a.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;a.prototype.TIMELINE_NAV_ELM_HEIGHT=20;a.prototype.TIMELINE_DOT_HTML=Sprite.html("web","timeline_dot");a.container;a.scroll_container;a.events;a.current_event;a.key_to_photo;a.preview_objs;a.tmpl;a.last_render_scroll_timeout;a.start_render_scroll_time;a.last_scroll_position;a.hide_timeline_nav_timeout;a.grid;a._skip_scroll_update;a.header_id_to_sel_items;a.event_remove_info;a.opts;function a(c,d,g,e,f,h,i,j,b){this.container=c;this.scroll_container=d;this.tmpl=i;this.opts=b;this.THUMB_SIZE=j.thumb_size;this.HEADER_HEIGHT=j.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=h;this.event_remove_info=[];this._init_events(g,e,f);this.update_offsets(j.top_offset,j.left_offset);this.listen();Velocity.start_capture(this.scroll_container)}a.prototype._init_events=function(j,d,f){var c,h,m,e,g,k,b,i,l;if(j.length<1){this.events=new OrderedDictionary([],{});return}h=[];g={};m=false;for(i=0,l=j.length;i<l;i++){e=j[i];e=String(e);b=e in this.header_id_to_sel_items?this.header_id_to_sel_items[e]:[];k=false;if(b.length&&!m){m=true;k=true}c=new PhotoEvent(this,e,d[e],f[e],b,k);h.push(e);g[e]=c}return this.events=new OrderedDictionary(h,g)};a.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};a.prototype.unlisten=function(){var c,b,d;if((c=this._body_mousemove_handler)!=null){c.stop()}if((b=this._timeline_elm_click_handler)!=null){b.stop()}if((d=this._show_missing_timestamp_bucket_handler)!=null){d.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(PhotoEvent.EVENT_MISCOUNT_EVT)};a.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};a.prototype.update_offsets=function(d,c){var e,g,f,b;this.top_offset=d;this.refresh_row_offsets();this.left_offset=c;this.grid.photo_col_offsets=[];b=[];for(e=g=0,f=this.THUMBS_PER_ROW;0<=f?g<=f:g>=f;e=0<=f?++g:--g){b.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*e))}return b};a.prototype.refresh_row_offsets=function(){var h,e,d,g,c,f,b;this.grid.photo_row_offsets=[];h=this.top_offset;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];e.top_offset=h;h+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(h);b.push((function(){var k,i,j;j=[];for(d=k=0,i=e.get_num_rows();0<=i?k<i:k>i;d=0<=i?++k:--k){h+=this.THUMB_SIZE;j.push(this.grid.photo_row_offsets.push(h))}return j}).call(this))}return b};a.prototype._render_empty_grid=function(){var c,f,e,b,d;this.container.__date();d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!(c.is_missing_timestamp_bucket()&&this.events.length()>1)){c.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){f=$j('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(_("Show photos with missing dates"));return $j(this.container).append(f)}};a.prototype._render_viewport=function(e){var c,n,f,m,p,k,j,h,o,d,b,l,i,g;if(e==null){e=false}this.start_render_scroll_time=-1;p=this.get_viewport_info();n=[];l=this.events.getValues();for(k=0,o=l.length;k<o;k++){c=l[k];if(!(c.has_loaded_metadata()||c.loading_metadata||(c.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(c.in_current_viewport(p,false)){n.unshift(c)}else{if(c.in_current_viewport(p,true)){n.push(c)}}}}for(j=0,d=n.length;j<d;j++){c=n[j];i=c.get_photo_range_to_render(p,true),f=i[0],m=i[1];c.load_metadata_range(f,m)}if(e){p=this.get_viewport_info();g=this.events.getValues();for(h=0,b=g.length;h<b;h++){c=g[h];if(c.in_current_viewport(p,false)){c.timing_stopped_scrolling_on_event=Util.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};a.prototype._load_metadata_for_sel_events=function(){var d,f,b,e,c;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}e=this.header_id_to_sel_items;c=[];for(f in e){b=e[f];d=this.events.valueFromKey(f);if(d!=null){d.load_metadata()}c.push(assert(d!=null,"Missing "+f+" in list of events with selected photos"))}return c};a.prototype._load_visible_photos=function(){var d,f,c,e,b;e=this.events.getValues();b=[];for(f=0,c=e.length;f<c;f++){d=e[f];if(!(d.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){b.push(d.update_photo_divs())}else{b.push(void 0)}}return b};a.prototype._body_mousemove=function(b){if(!this.opts.uses_timeline_nav){return}if((b.clientX+Util.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};a.prototype._timeline_elm_click=function(f,d){var b,c;c=d.readAttribute("data-event-id");if(c){b=this.events.valueFromKey(c)}this._update_timeline_position(b);if(b.is_missing_timestamp_bucket()){PhotosLogger.log_interaction(PhotosViews.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(b)};a.prototype._scroll_to_event=function(d,b){var c;if(b==null){b=false}c=d.top_offset-this.top_offset;if(d&&(Util.scroll_offsets().top!==c)){if(b){return $j("html, body").animate({scrollTop:c},200)}else{this._skip_scroll_update=true;return window.scrollTo(Util.scroll_offsets().left,c)}}};a.prototype._window_scroll=function(){var e,d,h,g,c,f,b,i=this;d=Util.time();BatchThumbLoader.clear_all_pending_batches();if(this.start_render_scroll_time===-1||d-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=d}h=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),h);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout((function(){return $("timeline-nav").removeClassName("scroll-active")}),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=Util.scroll_offsets().top;Photos.scroll_count++;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];b.push(e.logged_thumbs_arrived=false)}return b};a.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};a.prototype.init_timeline_nav=function(){var c,e,b,d;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();d=this.events.getValues().reverse();for(e=0,b=d.length;e<b;e++){c=d[e];c.add_to_timeline_nav(c===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};a.prototype._resize_timeline_nav=function(){var b;if(!this.opts.uses_timeline_nav){return}b=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:b+"px"})};a.prototype._update_timeline_position=function(h){var l,i,b,k,f,e,j,c,g,d;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(!(h!=null)){k=this.get_viewport_info();if(this.scroll_container==null){k.top=document.viewport.getScrollOffsets().top}l=k.top+k.height/2;g=this.events.getValues();for(f=0,j=g.length;f<j;f++){b=g[f];if(b.top_offset>l){break}h=b}}if(!(h!=null)||h===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");d=$$(".timeline-elm");for(e=0,c=d.length;e<c;e++){i=d[e];if(i.readAttribute("data-event-id")===h.unique_id){i.addClassName("current");break}}return this.current_event=h};a.prototype._show_hide_timeline_elms=function(){var i,f,d,e,h,c,g,b;if(!this.opts.uses_timeline_nav){return}d=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();f=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();g=$$(".timeline-elm");b=[];for(h=0,c=g.length;h<c;h++){i=g[h];i.show();e=i.cumulativeOffset();if(e.top<f&&e.left<d){b.push(i.hide())}else{b.push(void 0)}}return b};a.prototype._event_miscount=function(b){this.refresh_row_offsets();return this._load_visible_photos()};a.prototype.remove_photos=function(i){var e,g,h,d,c,f,b;i=i.slice(0);this.event_remove_info=[];h={};for(f=0,b=i.length;f<b;f++){d=i[f];g=d.event.unique_id;if(g in h){h[g].push(d)}else{h[g]=[d]}}for(g in h){i=h[g];e=this.events.valueFromKey(g);c=e.remove_photos(i);this.event_remove_info.push({event:e,remove_info:c})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_REMOVED_EVT,this)};a.prototype.restore_removed_photos=function(){var c,q,m,p,n,e,l,j,i,g,o,d,b,k,h,f;PhotosSelection.clear();k=this.event_remove_info.reverse();for(j=0,o=k.length;j<o;j++){q=k[j];c=q.event;n=q.remove_info;if(n.removed_event_index!=null){this.events.insertAtIndex(n.removed_event_index,c.unique_id,c);c.restore()}c.add_photos(n.removed_photos_and_indexes.reverse());h=n.removed_photos_and_indexes;for(i=0,d=h.length;i<d;i++){p=h[i];PhotosSelection._add(p.photo)}}e=null;l=null;f=this.event_remove_info;for(g=0,b=f.length;g<b;g++){q=f[g];c=q.event;n=q.remove_info;m=this.events.indexOfKey(c.unique_id);if(!(e!=null)||e>m){e=m;l=n.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(l!=null){this.scroll_to_photo_with_key(l.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_ADDED_EVT,this)};a.prototype.get_photos=function(){var c,f,e,b,d;f=[];d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];f=f.concat(c.photos)}return f};a.prototype.num_photos=function(){var d,c,f,b,e;c=0;e=this.events.getValues();for(f=0,b=e.length;f<b;f++){d=e[f];c+=d.photos.length}return c};a.prototype.get_preview_objs=function(){var b,c,i,g,f,j,d,h,e;i=[];h=this.events.getValues();for(g=0,j=h.length;g<j;g++){b=h[g];e=b.photos;for(f=0,d=e.length;f<d;f++){c=e[f];i.push(c.preview_obj)}}return i};a.prototype.index_of_photo=function(d){var e,c,g,b,f;c=0;f=this.events.getValues();for(g=0,b=f.length;g<b;g++){e=f[g];if(e===d.event){c+=e.photos.indexOf(d);break}else{c+=e.photos.length}}return c};a.prototype.photo_at_index=function(d){var b,e,g,c,f;b=0;f=this.events.getValues();for(g=0,c=f.length;g<c;g++){e=f[g];if(b+e.photos.length>d){return e.photos[d-b]}else{b+=e.photos.length}}return null};a.prototype.get_thumb_elm_for_photo=function(b){return $(b.uniqueness_key)};a.prototype.get_photo_for_thumb_elm=function(b){if(!b.hasClassName("cu-thumb")){b=b.up(".cu-thumb")}if(b){return this.key_to_photo[b.identify()]}else{return null}};a.prototype.get_viewport_info=function(){var b,c;if(this.scroll_container!=null){c=this.scroll_container.scrollTop;b=this.scroll_container.getHeight();return{top:c,height:b,bottom:c+b}}else{return Util.get_viewport()}};a.prototype.scroll_to_photo_with_key=function(c){var g,d,b,f,e;Util.set_page_scrollable(true);g=$(c);if(g!=null?g.visible():void 0){Util.scroll_to_thumb(g)}else{b=this.key_to_photo[c];d=b.event;if(b.event!=null){f=Math.floor(d.photos.indexOf(b)/this.THUMBS_PER_ROW);e=this.get_viewport_info().height;Util.scroll_to(0,d.top_offset+this.HEADER_HEIGHT+f*this.THUMB_SIZE-e/2)}}return this._load_visible_photos()};a.prototype.restore_scroll_position=function(){Util.set_page_scrollable(true);if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};a.prototype.visible_thumbs_loaded=function(){var c,e,b,d;d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!c.visible_thumbs_loaded()){return false}}return true};a.prototype.has_missing_timestamp_bucket=function(){var b;b=this.events.getValues();return b[b.length-1].is_missing_timestamp_bucket()};a.prototype.is_missing_timestamp_bucket_shown=function(){var b,c;if(!this.has_missing_timestamp_bucket()){return false}b=this.events.getValues();c=b[b.length-1].unique_id;return $j("#p-"+c).length>0};a.prototype._show_missing_timestamp_bucket=function(b,e){var d,c;if(b==null){b=true}if(e==null){e=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}c=this.events.getValues();d=c[c.length-1];$j("#show-missing-timestamps-button").hide();d.add_html_elements_to(this.container);if(!e){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(d,b);this._render_viewport()}return this.init_timeline_nav()};return a})();var PhotoEvent;PhotoEvent=(function(){a.EVENT_MISCOUNT_EVT="db:photoevent:miscount";a.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";a.prototype.MONTH_PREFIX="m_";a.prototype.COLLECTION_PREFIX="c_";a.prototype.EVENT_PREFIX="e_";a.prototype.MISSING_TIMESTAMP_PREFIX="a_";a.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;a.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;a.timeline;a.unique_id;a.name;a.init_num_photos;a.photos;a.header_html;a.placeholder_html;a.top_offset;a.loading_metadata;a.cursor;a.num_photos_loaded;a.prototype.LOADING_ORDER_NOT_DECIDED=-1;a.prototype.LOADING_ORDER_TOP_DOWN=0;a.prototype.LOADING_ORDER_BOTTOM_UP=1;a.loading_order;a.num_photos_to_load;a.on_load_all_metadata;a.init_sel_items;a.scroll_to_first_sel;a.num_to_select;a.logged_thumbs_arrived;a.timing_metadata_received;a.timing_stopped_scrolling_on_event;a.scroll_count;function a(k,g,c,h,b,f){var e,l,d,j;this.timeline=k;this.unique_id=g;this.name=c;this.init_num_photos=h;this.photos=(function(){var m,i;i=[];for(e=m=0;0<=h?m<h:m>h;e=0<=h?++m:--m){i.push(new Photo(this))}return i}).call(this);this.init_sel_items={};for(d=0,j=b.length;d<j;d++){l=b[d];this.init_sel_items[l]=true}this.num_to_select=b.length;this.scroll_to_first_sel=f;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(h===0){$("single-album-empty").show()}}a.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};a.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};a.prototype.get_month=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(6,8),10);assert(!isNaN(b),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.get_year=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(2,6),10);assert(!isNaN(b),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};a.prototype.get_collection_gid=function(){assert(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};a.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};a.prototype._generate_container_html=function(){var e,c,f,h,d,b,g;h=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(h);e=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});e.__date(Sprite.html("web","event_add_to_album"));this.header_html.__sert(e);g=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});g.__date(Sprite.html("web","event_share"));this.header_html.__sert(g);b=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});b.__date(Sprite.html("web","event_select"));this.header_html.__sert(b)}else{this.header_html=new HTML("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+h+"</span></h1>")}c=this.get_content_height();d=this.photos.length%this.timeline.THUMBS_PER_ROW;f=d===0?0:(this.timeline.THUMBS_PER_ROW-d)*this.timeline.THUMB_SIZE;return this.placeholder_html=new HTML('<div style="height: '+c+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+c+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+f+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};a.prototype.add_html_elements_to=function(c){var b;if(this.is_event()){b=new Element("div",{"class":"photo-event"});b.__sert(this.header_html);b.__sert(this.placeholder_html);return c.__sert(b)}else{c.__sert(this.header_html);return c.__sert(this.placeholder_html)}};a.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};a.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};a.prototype.add_to_timeline_nav=function(i){var b,g,j,c,k,f,e,h,d;if(i==null){i=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}d=this.timeline.get_viewport_info().height;k=this.timeline.TIMELINE_NAV_ELM_HEIGHT;f=$(document.body).getHeight();e=this.top_offset/f*100;if(this.is_event()){c=this.name}else{if(this.is_missing_timestamp_bucket()){c=_("Missing dates")}else{c=Util.monthAbrWithYear(this.get_month()-1,this.get_year())}}j=false;for(h in this.timeline.grid.side_nav){b=Math.abs(this.timeline.events.valueFromKey(h).top_offset-this.top_offset);if(b/f*d<k){j=true;if(i){$j("#timeline-nav-"+h).remove()}}}g=$j("#timeline-nav-"+this.unique_id);if(!j||i){if(g.length){g.css("top",""+e+"%")}else{g=$j("<div/>");g.addClass("timeline-elm");g.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});g.css("top",""+e+"%");g.text(c);$j("#timeline-nav").append(g)}return this.timeline.grid.side_nav[this.unique_id]=e}else{if(g.length){return g.remove()}}};a.prototype.marquee_highlight=function(b,i,f){var d,j,c,k,m,e,h,g,l;if(this.top_offset>i||this.top_offset+this.get_height()<b){return}if(b<this.top_offset){i-=this.top_offset;if(i<this.timeline.HEADER_HEIGHT){return}e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(i>this.top_offset+this.get_height()){b-=this.top_offset;m=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(b<this.timeline.HEADER_HEIGHT){e=0}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{b-=this.top_offset;i-=this.top_offset;if(b<this.timeline.HEADER_HEIGHT&&i<this.timeline.HEADER_HEIGHT){return}else{if(b<this.timeline.HEADER_HEIGHT){e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(k=h=e;e<=m?h<=m:h>=m;k=e<=m?++h:--h){for(g=0,l=f.length;g<l;g++){d=f[g];j=this.timeline.THUMBS_PER_ROW*k+d;if(j<this.photos.length){c=this.photos[j];if(c.status!==Photo.PLACEHOLDER&&!PhotosSelection.contains(c)){PhotosSelection._highlight(c)}}}}};a.prototype.add_photos=function(e){var d,c,f,g,b;for(g=0,b=e.length;g<b;g++){f=e[g];c=f.photo;d=f.index;assert(d<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(d,0,c);if(c.status>=Photo.LOADED){c.status=Photo.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};a.prototype.remove_photos=function(j){var g,b,f,h,c,d,i,e;g=this.timeline.events.indexOfKey(this.unique_id);c=[];for(d=0,i=j.length;d<i;d++){b=j[d];f=this.photos.indexOf(b);assert(f>-1,"Photo not found in the photos array!");this.photos.splice(f,1);if(b.status>=Photo.LOADED){this.num_photos_loaded--;if((e=$(b.uniqueness_key))!=null){e.remove()}b.status=Photo.LOADED}PhotosSelection._remove(b);c.push({photo:b,index:f})}this._num_photos_changed();h={removed_photos_and_indexes:c};if(this.photos.length===0){h.removed_event_index=g}return h};a.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};a.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};a.prototype._update_placeholder_container=function(){var c,b;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});b=this.photos.length%this.timeline.THUMBS_PER_ROW;c=b!==0?(this.timeline.THUMBS_PER_ROW-b)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+c+"px"})};a.prototype.load_metadata=function(h){var c,j,f,e,i,b,g,d=this;e=0;if((!this._is_valid_photo_index(h))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}e=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=h*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}e=this._is_loading_from_bottom()?this.photos.length-h:h+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,e);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;i={show_hidden:Photos.show_hidden};if(this.cursor!=null){i.cursor=this.cursor}if(this._is_loading_from_bottom()){i.chron_order=true}i.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(i.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){i.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){b=this.unique_id.split("_");c=b[2];j=b[1];i.filters=JSON.stringify({date_begin:c,date_end:j},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){i.filters=JSON.stringify({other:true})}else{if(this.is_month()){g=this.get_year();f=this.get_month();c=Util.to_iso8601_date(new Date(g,f-1,1,0,0,0,0),false,true);j=Util.to_iso8601_date(new Date(g,f,1,0,0,0),false,true);i.filters=JSON.stringify({date_begin:c,date_end:j},{year:g,month:f})}else{if(this.is_collection()){i.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{assert(false,"invalid photo event id: "+this.unique_id)}}}}return new Ajax.DBRequest("/photos_event_metadata",{parameters:i,allow_retries:true,onSuccess:function(k){var l;l=JSON.parse(k.responseText);d.timing_metadata_received=Util.time();d.cursor=l.cursor;return d._load_metadata_callback(l.photos,l.key_to_duplicates,(l.more!=null)&&l.more)}})};a.prototype.load_metadata_range=function(c,b){if(!(this._is_valid_photo_index(c)&&this._is_valid_photo_index(b))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=c*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(c)}else{return this.load_metadata(b)}};a.prototype.load_cached_metadata=function(){var b,c;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||!(((c=Photos.event_metadata_cache)!=null?c[this.unique_id]:void 0)!=null)){return false}b=Photos.event_metadata_cache[this.unique_id];this.cursor=b.cursor;this._load_metadata_callback(b.photos,b.key_to_duplicates,b.more);return true};a.prototype._load_metadata_callback=function(o,g,h){var n,j,t,k,u,d,l,r,f,p,e,m,c,b,q,s;k=[];f=[];m=false;for(n=c=0,q=o.length;c<q;n=++c){l=o[n];if(this.has_loaded_metadata()){d=new Photo(this);if(this._is_loading_from_bottom()){this.photos.unshift(d)}else{this.photos.push(d)}m=true}else{if(this.num_photos_loaded<this.photos.length){j=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;d=this.photos[j]}else{assert(false,"num_photos_loaded should never be greater than photos.length")}}d.init_metadata(l);if(d.uniqueness_key in g){d.set_duplicates(g[d.uniqueness_key])}if(n<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){f.push(d.preview_obj)}k.push(d)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var x,w,v,i;i=[];for(w=0,v=f.length;w<v;w++){x=f[w];i.push(x.preload())}return i}),500)}PhotosSelection.refresh(k);for(b=0,s=k.length;b<s;b++){d=k[b];if(d.item_counter in this.init_sel_items){PhotosSelection._add(d);this.num_to_select--;if(this.num_to_select===0){PhotosSelection.dec_num_loading_events_before_select()}delete this.init_sel_items[d.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;e=this.timeline;t=d.uniqueness_key;$j(document).ready(function(){return e.scroll_to_photo_with_key(t)})}}}if(!h){if(this.num_photos_loaded<this.photos.length){u=this.photos.length-this.num_photos_loaded;p=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(p,u);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(m||u){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(a.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){r=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(r)}};a.prototype._fix_photo_miscount=function(){var d,c,b;d=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);c=this.get_num_rows()-d;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){PhotosLogger.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}b=Util.scroll_offsets().top;if(this.top_offset+this.get_height()<b){Util.scroll_to(0,b+c*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(a.EVENT_MISCOUNT_EVT,this)};a.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};a.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};a.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};a.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};a.prototype.visible_thumbs_loaded=function(d){var h,g,c,b,f,e;if(d==null){d=this.timeline.get_viewport_info()}e=this.get_photo_range_to_render(d,false),h=e[0],g=e[1];if(h===null&&g===null){return true}for(b=f=h;h<=g?f<=g:f>=g;b=h<=g?++f:--f){c=this.photos[b];if(!(c!=null)||!(c.status>=Photo.RENDERED)){return false}}return true};a.prototype._is_loaded=function(b){var c,d;if(this._is_loading_from_bottom()){d=this.photos.length-this.num_photos_loaded;c=this.photos.length-1}else{d=0;c=this.num_photos_loaded-1}return(d<=b&&b<=c)};a.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};a.prototype._is_valid_photo_index=function(b){return(b!=null)&&(b>=0)&&(b<=this.photos.length-1)};a.prototype.update_photo_divs=function(){var d,c,s,r,w,z,t,o,i,A,q,x,m,j,g,e,B,C,b,y,p,n,l,h,f,k,v,u;if(!this.num_photos_loaded){return}x=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(x)){return}y=this.get_photo_range_to_render(x),s=y[0],r=y[1];assert((s!=null)&&(r!=null),"This line is after @hide_photos_if_not_in_      current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(s))||(!this._is_loaded(r)))){this.load_metadata_range(s,r);if(this._is_loading_from_bottom()){s=Math.max(s,this.photos.length-this.num_photos_loaded)}else{r=Math.min(r,this.num_photos_loaded-1)}if(s>r){return}}z=Math.floor(s/this.timeline.THUMBS_PER_ROW);q=z*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:q+"px"});w=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(r/this.timeline.THUMBS_PER_ROW);c=w*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:c+"px"});this._hide_photos((function(){k=[];for(var D=0;0<=s?D<s:D>s;0<=s?D++:D--){k.push(D)}return k}).apply(this));this._hide_photos((function(){v=[];for(var D=p=r+1,E=this.photos.length;p<=E?D<E:D>E;p<=E?D++:D--){v.push(D)}return v}).apply(this));this._show_photos((function(){u=[];for(var D=s;s<=r?D<=r:D>=r;s<=r?D++:D--){u.push(D)}return u}).apply(this));l=PhotosSelection.get();for(e=0,B=l.length;e<B;e++){o=l[e];if((h=$(o.uniqueness_key))!=null){h.addClassName("selected")}}this.scroll_count=Photos.scroll_count;d=[];f=this.get_thumb_indexes_to_load(x);for(b=0,C=f.length;b<C;b++){i=f[b];o=this.photos[i];if((o!=null)&&o.status>=Photo.RENDERED){A=$(o.uniqueness_key);if((A!=null?A.down("img"):void 0)!=null){d.push(A.down("img"))}}}t=function(D){return D.up(".cu-thumb").addClassName("thumb-loaded")};return BatchThumbLoader.batch_load_thumbs(d,this.timeline.THUMBS_BATCH_SIZE,t,this.log_thumb_load.bind(this))};a.prototype._hide_photos=function(f){var d,e,c,b;b=[];for(e=0,c=f.length;e<c;e++){d=f[e];b.push(this._hide_photo(d))}return b};a.prototype._hide_photo=function(b){var c;c=this.photos[b];if(!(c!=null)||!(c.status===Photo.DISPLAYED)){return}$(c.uniqueness_key).hide();return c.status=Photo.RENDERED};a.prototype._show_photos=function(s){var o,n,r,f,p,l,e,m,k,h,g,q,d,c,b,j;f=[];for(m=0,q=s.length;m<q;m++){n=s[m];p=this._get_photo_insert_info(n);if(!p){continue}r=p[0],e=p[1];l=false;for(k=0,d=f.length;k<d;k++){o=f[k];if(o.after===r){o.photos.push(e);l=true;break}}if(!l){f.push({after:r,photos:[e]})}}for(h=0,c=f.length;h<c;h++){o=f[h];o.after.__sert({after:o.photos})}j=[];for(g=0,b=s.length;g<b;g++){n=s[g];j.push(this.photos[n].status=Photo.DISPLAYED)}return j};a.prototype._get_photo_insert_info=function(b){var e,c,d,j,f,h,g;d=this.photos[b];if(!(d!=null)||d.status===Photo.DISPLAYED){return}if(d.status===Photo.RENDERED){$(d.uniqueness_key).show()}else{c=$("p-top-"+this.unique_id);if(b!==0){for(e=h=g=b-1;g<=0?h<=0:h>=0;e=g<=0?++h:--h){j=this.photos[e];if((j!=null)&&j.status>=Photo.RENDERED){f=$(j.uniqueness_key);assert(f!=null,"photo "+e+" was marked as rendered, but its thumb elm doesn't exist");c=f;break}}}return[c,d.thumb_html]}};a.prototype.in_y_range=function(c,b){return !(this.top_offset+this.timeline.HEADER_HEIGHT>b||this.top_offset+this.get_height()<c)};a.prototype.in_current_viewport=function(d,f){var b,c,e;if(d==null){d=this.timeline.get_viewport_info()}if(f==null){f=true}c=d.top;b=d.top+d.height;if(f){e=this._blur_range(c,b,d),c=e[0],b=e[1]}return this.in_y_range(c,b)};a.prototype.hide_photos_if_not_in_current_viewport=function(e){var c,g,d,f,b,h;if(!this.in_current_viewport(e)){if(this._is_loading_from_bottom()){for(c=g=f=this.photos.length-this.num_photos_loaded,b=this.photos.length;f<=b?g<b:g>b;c=f<=b?++g:--g){this._hide_photo(c)}}else{for(c=d=0,h=this.num_photos_loaded;0<=h?d<h:d>h;c=0<=h?++d:--d){this._hide_photo(c)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};a.prototype._blur_range=function(e,b,g){var d,c,f;if(g==null){g=this.timeline.get_viewport_info()}f=Velocity.get();if(f>=0){c=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;d=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(f<0){c=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;d=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}e-=c*g.height;b+=d*g.height;return[e,b]};a.prototype.get_photo_range_to_render=function(j,d){var h,c,g,i,f,b,e;if(d==null){d=true}b=j.top;f=j.bottom;if(d){e=this._blur_range(b,f,j),b=e[0],f=e[1]}if(!this.in_y_range(b,f)){return[null,null]}i=Math.floor((b-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);h=Math.floor((f-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);c=Math.min(this.photos.length-1,i*this.timeline.THUMBS_PER_ROW);g=Math.min(this.photos.length-1,(h+1)*this.timeline.THUMBS_PER_ROW-1);assert(!isNaN(g),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+j.bottom+" ")+("viewport_data.height="+j.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+h+" "),true,["photo_event_nan_limit"]);return[Math.max(0,c),g]};a.prototype.get_photo_range_to_render_with_blur=function(e){var c,h,d,g,f,b;f=this.get_photo_range_to_render(e,true),h=f[0],g=f[1];b=this.get_photo_range_to_render(e,false),c=b[0],d=b[1];return[h,c,d,g]};a.prototype.get_thumb_indexes_to_load=function(o){var v,l,j,i,s,u,r,t,p,f,d,c,b,q,h,g,e,n,m,k;q=this.get_photo_range_to_render_with_blur(o),l=q[0],v=q[1],j=q[2],i=q[3];if(v==null){s=(function(){e=[];for(var w=l;l<=i?w<=i:w>=i;l<=i?w++:w--){e.push(w)}return e}).apply(this);if(this.top_offset>o.bottom){return s}else{return s.reverse()}}t=(function(){n=[];for(var w=v;v<=j?w<=j:w>=j;v<=j?w++:w--){n.push(w)}return n}).apply(this);u=[];r=[];if(l<v){u=(function(){m=[];for(var w=h=v-1;h<=l?w<=l:w>=l;h<=l?w++:w--){m.push(w)}return m}).apply(this)}if(i>j){r=(function(){k=[];for(var w=g=j+1;g<=i?w<=i:w>=i;g<=i?w++:w--){k.push(w)}return k}).apply(this)}p=Velocity.get();if(p>=0){return t.concat(r).concat(u)}else{return t.concat(u).concat(r)}};a.prototype.log_thumb_load=function(c,d){var f,b,e;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===Photos.scroll_count&&!this.logged_thumbs_arrived){if((c+1)%this.timeline.THUMBS_PER_ROW===0||c+1===d){if(this.visible_thumbs_loaded()){b=this.timeline.get_viewport_info();f=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<b.bottom&&b.bottom<this.top_offset+this.get_height())||f){if(Photos.scroll_count<2&&((e=PhotosLogger.get_current_view())===PhotosViews.PHOTOS_VIEW||e===PhotosViews.CAMERA_VIEW)){this.log_timing_event(PhotosTimingEvents.viewport_initial_load);Photos.scroll_count+=2}else{this.log_timing_event(PhotosTimingEvents.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};a.prototype.log_timing_event=function(e){var b,c,f,d;c=Util.time();b={};if(e===PhotosTimingEvents.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(d=performance.timing)!=null?d.navigationStart:void 0:void 0)!=null){f=Util.time()-performance.timing.navigationStart;b={current_view:PhotosLogger.get_current_view()};WebTimingLogger.log_ajax_transition(f,e,b,e)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(e===PhotosTimingEvents.viewport_loaded){f=c-this.timing_stopped_scrolling_on_event}return WebTimingLogger.log_ajax_transition(f,e,b,e)};return a})();var Photo;Photo=(function(){a.PLACEHOLDER=0;a.LOADED=1;a.RENDERED=2;a.DISPLAYED=3;a.uniqueness_key;a.item_counter;a.filename;a.ns_id;a.ns_path;a.fq_path;a.href;a.thumbnail_url;a.large_thumbnail_url;a.time_taken;a.display_time_taken;a.preview_type;a.mtime;a.video_streaming_url;a.is_visible;a.user_id;a.event;a.status;a.thumb_html;a.preview_obj;a.duplicates_info;function a(b){this.event=b;this.status=a.PLACEHOLDER;this.preview_obj=b.unique_id}a.prototype.init_metadata=function(b){this.uniqueness_key=b.uniqueness_key;this.item_counter=b.item_counter;this.filename=b.filename;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.fq_path=b.path;this.href=b.href;this.thumbnail_url=b.thumbnail_url;this.large_thumbnail_url=b.large_thumbnail_url;this.time_taken=b.time_taken;this.display_time_taken=b.display_time_taken;this.preview_type=b.preview_type;this.mtime=b.mtime;this.video_streaming_url=b.video_streaming_url;this.is_visible=b.is_visible;this.user_id=b.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true});this.preview_obj=this._get_preview_obj();this.status=a.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};a.prototype.set_duplicates=function(d){var c,e,b;for(e=0,b=d.length;e<b;e++){c=d[e];c.fq_path=c.path}return this.duplicates_info=d};a.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(Photos.in_single_collection_view()){return new SingleCollectionPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new AllPhotosPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(Photos.in_single_collection_view()){return new SingleCollectionVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new AllPhotosVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:URI.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};a.prototype._get_display_date=function(){var b;if(this.time_taken!=null){b=new Date(this.time_taken);return Util.niceDateWithMonthName(b,b.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return a})();var PhotoCollection;PhotoCollection=(function(){a.CREATE_EVT="db:photocollection:create";a.ADD_EVT="db:photocollection:add";a.REMOVE_EVT="db:photocollection:remove";a.UNDO_REMOVE_EVT="db:photocollection:undo_remove";a.RENAME_EVT="db:photocollection:rename";a.DELETE_EVT="db:photocollection:delete";a.SHARE_EVT="db:photocollection:share";a.UNSHARE_EVT="db:photocollection:unshare";a.COVER_CHANGE_EVT="db:photocollection:cover_change";a.gid;a.name;a.num_items;a.num_photos;a.num_videos;a.thumbnail_url_32;a.thumbnail_url_256;a.is_anonymous;a.share_tkey;a.shmodel_url;a.short_url;a.is_creator;a.member_fnames;function a(c,b){if(b==null){b=true}assert((c.gid!=null)&&(c.url!=null)&&(c.name!=null)&&(c.num_items!=null)&&(c.num_photos!=null)&&(c.num_videos!=null),"missing required PhotoCollection params");this.gid=c.gid;this.url=c.url;this.name=c.name;this.num_items=c.num_items;this.num_photos=c.num_photos;this.num_videos=c.num_videos;this.thumbnail_url_32=c.thumbnail_url_32||null;this.thumbnail_url_256=c.thumbnail_url_256||null;this.is_anonymous=c.is_anonymous!=null?c.is_anonymous:false;this.share_tkey=c.share_tkey||null;this.shmodel_url=c.shmodel_url||null;this.short_url=c.short_url||null;this.is_creator=c.is_creator!=null?c.is_creator:true;this.member_fnames=c.member_fnames||[_("You")];if(b){document.fire(a.CREATE_EVT,{collection:this})}}a.prototype.add_photos=function(i,h,d,f){var b,e,c,g=this;if(h==null){h=null}if(d==null){d=false}if(f==null){f=true}b=(function(){var l,k,j;j=[];for(l=0,k=i.length;l<k;l++){c=i[l];j.push(c.item_counter)}return j})();assert(b.length,"Have to add at least one photo");e={collection_gid:this.gid,item_counters:JSON.stringify(b)};if(h!=null){e.source_collection_gid=h}return new Ajax.DBRequest("/collection_add",{parameters:e,job:d,job_user:viewer.photos_user,progress_text:_("Adding to album..."),onSuccess:function(l){var j,m,k,n;n=JSON.parse(l.responseText);g.thumbnail_url_32=n.thumbnail_url_32;g.thumbnail_url_256=n.thumbnail_url_256;m=n.new_num_photos-g.num_photos;k=n.new_num_videos-g.num_videos;j=n.new_num_items-g.num_items;g.num_photos=n.new_num_photos;g.num_videos=n.new_num_videos;g.num_items=n.new_num_items;return document.fire(a.ADD_EVT,{collection:g,photos:i,num_items_added:j,num_photos_added:m,num_videos_added:k,promote_collection:f})}})};a.prototype.remove_photos=function(f,d){var b,c,e=this;if(d==null){d=false}b=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){c=f[i];g.push(c.item_counter)}return g})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(b),is_shared:this.share_tkey!=null,num_items:this.num_items},job:d,job_user:viewer.photos_user,progress_text:_("Removing from album..."),onSuccess:function(g){var h;h=JSON.parse(g.responseText);e.thumbnail_url_32=h.thumbnail_url_32;e.thumbnail_url_256=h.thumbnail_url_256;e.num_photos=h.new_num_photos;e.num_videos=h.new_num_videos;e.num_items=h.new_num_items;return document.fire(a.REMOVE_EVT,{collection:e,photos:f,undo_changeset:h.undo_changeset})}})};a.prototype.undo_remove=function(c){var b=this;return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:c},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(){return document.fire(a.UNDO_REMOVE_EVT,{collection:b})}})};a.prototype.rename=function(c){var b,d=this;Photos.enable_selection();b=new Ajax.InPlaceEditor(c,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return $j("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:_("Saving..."),onLeaveEditMode:Photos.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:function(e){d.name=e.responseText;return document.fire(a.RENAME_EVT,{collection:d})}},callback:function(e,f){return{collection_gid:d.gid,new_collection_name:f,is_shared:d.share_tkey!=null}}});return b.enterEditMode()};a.prototype["delete"]=function(){var b=this;if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:viewer.photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:viewer.photos_user,onSuccess:function(){return document.fire(a.DELETE_EVT,{collection:b})}})};a.prototype.attach_to_token=function(d,g,c,f,b){var e=this;return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:d,collection_gid:this.gid,num_items:this.num_items},onSuccess:function(){e.share_tkey=d;e.shmodel_url=g;e.short_url=c;if(typeof f==="function"){f()}return document.fire(a.SHARE_EVT,{collection:e})},onFailure:function(){return typeof b==="function"?b():void 0}})};a.prototype.send_link=function(j,c,b,h,g,e){var i,d,f=this;i=function(){f.share_tkey=c;f.shmodel_url=b;f.short_url=h;if(typeof g==="function"){g()}return document.fire(a.SHARE_EVT,{collection:f})};d={collection_gid:this.gid,share_tkey:c,num_items:this.num_items};return Forms.ajax_submit(j,"/collection_share",i,e,j.down(".tokenizer-submit-button"),d)};a.prototype.unshare=function(){var b=this;assert(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:function(){b.share_tkey=null;b.shmodel_url=null;b.short_url=null;return document.fire(a.UNSHARE_EVT,{collection:b})},subject_user:viewer.photos_user})};a.prototype.set_cover=function(b){var c=this;return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:b.item_counter},onSuccess:function(d){var e;e=JSON.parse(d.responseText);c.thumbnail_url_32=e.thumbnail_url_32;c.thumbnail_url_256=e.thumbnail_url_256;return document.fire(a.COVER_CHANGE_EVT,{collection:c})}})};return a})();var FilePreview;FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(f,c,b,e){var a,d,g=this;this._log_pdf_render_time(f);if(f==="pdf-embedded"||f==="pdf-js"){Util.smart_window_load(function(){$j("#pdf-embed-iframe").attr("src",e);return g._fire_pdf_render_event()});if($j.browser.chrome){d=function(){var h;h=$j('link[rel="shortcut icon"]').remove();return $j("head").append(h)};setTimeout(d,1000)}a=$$("#pdf-embed-container iframe");return window.setTimeout((function(){return a.invoke("setStyle",{visibility:"visible"})}),200)}},init_font:function(){var a=this;return Util.smartLoad(function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}})},init_photo:function(d,g){var i,e,h,f,c,a,b;$("preview-img").observe("error",this._preview_failed.bind(this));if((f=window.performance)!=null?(c=f.timing)!=null?c.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var j;j=Util.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(j,"file-preview-photo")})}$("full-img").src=d;a=$$("#preview-img, #full-img");b=[];for(e=0,h=a.length;e<h;e++){i=a[e];i.setAttribute("data-original-href",g);b.push(i.on("contextmenu","img",ContextMenu.show_shmodel.bind(ContextMenu)))}return b},init_text:function(g,b,i,e){var a,d,f,h,c=this;if(e==null){e=true}a=0;f=function(k){var j,l;if(!(k.responseText&&(200<=(l=k.status)&&l<300))){return}j=k.responseText.length;if(a===0&&j>c.PARTIAL_TEXT_LENGTH_THRESHOLD){h(k.responseText,true);return a=j}};d=function(j){return h(j.responseText)};window.got_text=function(j){if(j){j=Util.decode_b64(j)}return h(j)};h=function(j,k){var m,l,n;if(!j||!j.length){$("code-wrapper").remove();return}$j("#code-loading").hide();if(typeof i==="function"){i()}l=$$("#code-wrapper #code")[0];m=l.className;n=j.substring(a);l.appendChild(document.createTextNode(n));if(b&&!k){SyntaxHighlighter.defaults.toolbar=false;SyntaxHighlighter.defaults["quick-code"]=false;SyntaxHighlighter.highlight(l)}return window.filled_text=1};return Util.smartLoad(function(){var j,k;j=function(){return Util.add_script(URI.parse(g).updateQuery({js_callback:"got_text",b64:"1"}).toString())};if(Prototype.BrowserFeatures.DB_CORS){k={method:"GET",parameters:{},log_timing:true,onInteractive:f,onSuccess:d,onFailure:j};if(e){k.withCredentials=true}new Ajax.DBRequest(g,k)}else{j()}return setTimeout((function(){if(!window.filled_text){return c._preview_failed()}}),10000)})},init_htmlified:function(){var a=this;if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this._preview_failed();return}return setTimeout((function(){if(!window.htmlified_height){return a._preview_failed()}}),10000)},htmlified_loaded:function(){var a;if((a=$("htmlified-loading"))!=null){a.remove()}$("htmlified").style.height=window.htmlified_height+"px";return $("htmlified").style.visibility=""},init_video:function(f,c,d,g,i,a,h){var j,b,e=this;if(a){b=(Util.viewport_dimensions().width-a)*0.9}else{b=Util.viewport_dimensions().width*0.9}j=b*0.55;return Util.smartLoad(function(){var k;k=e._preview_failed;if(g==="hls"){return VideoUtil.embed("#video",{src:d,type:"application/vnd.apple.mpegurl",width:b,height:j,controls:true,poster:i,onError:k,metadata_link:h})}else{if(f){$("video").__date();if(c){return VideoUtil.embed("#video",{src:d,type:"video/mp4",width:b,height:j,controls:true,poster:i,onError:k,metadata_link:h})}else{return k()}}else{if(FlashDetect.installed){$("video").__date();return VideoUtil.embed("#video",{src:d,type:"video/flv",width:b,height:j,controls:true,poster:i,onError:k,metadata_link:h})}else{return k()}}}})},photo_loaded:function(c){var b,a;if((b=window.performance)!=null?(a=b.timing)!=null?a.navigationStart:void 0:void 0){c=c-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(c,"file-preview-photo")}},_preview_failed:function(){var a;a=$j(document.body);if(a.hasClass("shmodel-body")){a.removeClass("file-preview-body")}return Notify.server_error(_("Preview failed."))},_fire_pdf_render_event:function(){var a;if(document.createEvent&&window.dispatchEvent){a=document.createEvent("UIEvents");a.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(a)}},_log_pdf_render_time:function(b){var a;a=function(f){var d,e,c;if((e=window.performance)!=null?(c=e.timing)!=null?c.navigationStart:void 0:void 0){d=Util.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(d,f)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return a(b)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return a(""+b+"-parse")})}};var parse_color_to_rgba;Effect.BlindFadeUp=function(d,c){var b,a;b=new Effect.BlindUp(d,c);a=new Effect.Fade(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.BlindFadeDown=function(d,c){var b,a;b=new Effect.BlindDown(d,c);a=new Effect.Appear(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.Flash=function(c,b,a){assert(b.startcolor&&b.endcolor,"Start and end colors must be specified");assert(b.cycles,"Fade cycles must be specified");a=a||0;return new Effect.Highlight(c,{duration:1,startcolor:b.startcolor,endcolor:b.endcolor,restorecolor:b.endcolor,afterFinish:function(){return new Effect.Highlight(c,{duration:1,startcolor:b.endcolor,endcolor:b.startcolor,restorecolor:b.startcolor,afterFinish:function(){if(a<b.cycles){return Effect.Flash(c,b,a+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var r,p,x,l,q,s,m,n,h,e,c,b,y,D,B,z,w,v,u,t,a,E,C,A,o,j,i,g,d,f;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};o=["top","left","width","height","fontSize"];for(h=0,y=o.length;h<y;h++){s=o[h];this.originalStyle[s]=this.element.style[s]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;l=this.element.getStyle("font-size")||"100%";j=["em","px","%","pt"];for(e=0,D=j.length;e<D;e++){q=j[e];if(l.indexOf(q)>0){this.fontSize=parseFloat(l);this.fontSizeType=q}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;p=["border%sWidth","margin%s","padding%s"];for(c=0,B=p.length;c<B;c++){m=p[c];i=["Top","Bottom","Left","Right"];for(b=0,z=i.length;b<z;b++){x=i[b];n=m.format(x);this.dims[n]=parseFloat(this.element.getStyle(n));if(x==="Top"||x==="Bottom"){this.full_height+=this.dims[n]}else{this.full_width+=this.dims[n]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(a=0,w=p.length;a<w;a++){r=p[a];this.attrs_horizontal.push(r.format("Left"))}this.attrs_horizontal.push("width");g=p.reverse();for(E=0,v=g.length;E<v;E++){r=g[E];this.attrs_horizontal.push(r.format("Right"))}}if(this.options.scaleY){for(C=0,u=p.length;C<u;C++){r=p[C];this.attrs_vertical.push(r.format("Top"))}this.attrs_vertical.push("height");d=p.reverse();f=[];for(A=0,t=d.length;A<t;A++){r=d[A];f.push(this.attrs_vertical.push(r.format("Bottom")))}return f}},update:function(a){var b;b=(this.options.scaleFrom/100)+(this.factor*a);b=(-0.5+1/(1+Math.exp((0.5-b)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*b+this.fontSizeType})}return this.setDimensions(b)},setDimensions:function(f){var k,n,l,i,j,b,g,e,m,a,h,c;l={};h=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(g=0,m=h.length;g<m;g++){c=h[g],i=c[0],n=c[1];j=i*f;for(e=0,a=n.length;e<a;e++){k=n[e];b=this.dims[k];if(b<j){l[k]=b+"px";j-=b}else{l[k]=j.round()+"px";j=0}}}return this.element.setStyle(l)}});Effect.BlindUpComprehensive=function(a){a=$(a);a.makeClipping();return new Effect.ScaleComprehensive(a,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(b){return b.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(b){var a;b=$(b);a=b.getDimensions();return new Effect.ScaleComprehensive(b,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:a.height,originalWidth:a.width},restoreAfterFinish:true,afterSetup:function(c){return c.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(c){return c.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var k,h,c,g,j,d,l,f,b,a;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{h=new Element("div");j="rgba(1, 1, 1, 0)";h.setStyle({backgroundColor:j});this._supports_alpha=(h.getStyle("background-color"))===j}catch(m){}this._base=parse_color_to_rgba(this.options.startcolor);if((f=this.options.endcolor)==="transparent"||f==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){c=this._base.slice(0);c[3]=0}else{c=[255,255,255,1]}}else{c=parse_color_to_rgba(this.options.endcolor)}this._delta=[];b=this._base;a=[];for(g=d=0,l=b.length;d<l;g=++d){k=b[g];a.push(this._delta.push(c[g]-k))}return a},update:function(a){var h,c,g,d,f,b,e;g=[];e=this._base;for(d=f=0,b=e.length;f<b;d=++f){h=e[d];c=h+this._delta[d]*a;if(!(d>2)){c=Math.round(c)}g.push(c)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(g.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(g.slice(0,3).join(", "))+")"})}}});parse_color_to_rgba=function(c){var d,g,f,e,a,b,h,j,i;b=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;a=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;e=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;g=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;f=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;d=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(j=c.match(b)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})()}else{if(j=c.match(a)){i=(function(){var n,l,m,k;m=j.slice(1,4);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})();i[3]=parseFloat(j[4])}else{if(j=c.match(e)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(g)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(f)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}else{if(j=c.match(d)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}}}}}}i=i||[255,255,255,1];h=i.length;if(h===3){i.push(1)}else{if(h===4&&i[h-1]>1){i[h-1]=i[h-1]/255}}return i};var ClientDownload;ClientDownload=(function(){function a(){}a.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(b){var c;c=new Element("div",{"class":"brodal-header"});c.__sert(_("Install Dropbox"));return Modal.show(c,$("client-download"),{},false,450)},subject_user:Browse.active_user})};return a})();var WebTimingLogger;WebTimingLogger={init:function(a){this.source_type=a!=null?a:"web";if(!Constants.WEB_TIMING_ENABLED||!window.performance){return}return Util.smart_window_load(function(){return setTimeout(WebTimingLogger._log_navigation,0)})},_log_navigation:function(){var a,c,d,b;b=window.performance&&window.performance.timing;if(!b){return}d=b.navigationStart||b.fetchStart;if(!d){return}a={};if(Constants.GSLB_ENABLED){a.gslb_enabled=true}if(Constants.IS_SPDY){a.is_spdy=true}c={navigation_type:WebTimingLogger._get_navigation_type(),redirect_time:b.fetchStart-d,connect_time:b.requestStart-d,time_to_first_byte:b.responseStart-d,dom_load_time:b.domContentLoadedEventEnd-d,page_load_time:b.loadEventEnd-d,extra_columns:JSON.stringify(a)};return WebTimingLogger._log(c)},log_ajax_transition:function(g,a,d,c,f,b){var e;e={navigation_type:"ajax",page_load_time:g,url:b};if(f!=null){e.server_response_time=f}if(Constants.GSLB_ENABLED){d=d||{};d.gslb_enabled=true}if(d!=null){e.extra_columns=JSON.stringify(d)}if(c!=null){e.stopwatch_suffix=c}return WebTimingLogger._log(e,a)},_log:function(b,a,c){if(c==null){c="/web_timing_log"}if(!Constants.WEB_TIMING_ENABLED){return}b.url=b.url||window.location.href;b.request_id=Constants.REQUEST_ID;b.source_type=this.source_type;if(a){b.url_info=a}return $j.ajax({url:c,type:"POST",data:b})},_get_navigation_type:function(){switch(window.performance.navigation.type){case 0:return"navigate";case 1:return"reload";case 2:return"back_forward"}}};var HiRes,_this=this;HiRes=(function(){var a;a=false;if("devicePixelRatio" in window&&window.devicePixelRatio>1){a=true}return{init:function(){var i,h,f,e,d,g,b,c;if(!a){return}g=$j("[data-hi-res]");for(h=0,e=g.length;h<e;h++){i=g[h];this._replace(i,$j(i).attr("data-hi-res"),this._replace_img)}b=$j("[data-hi-res-background]");c=[];for(f=0,d=b.length;f<d;f++){i=b[f];c.push(this._replace(i,$j(i).attr("data-hi-res-background"),this._replace_background))}return c},get_background:function(c,b){if(!a){return}return this._replace(c,b,this._replace_background)},_replace:function(e,c,d){var b;if(!c){return}b=new Image();b.src=c;return $j(b).on("load",function(){return d(e,c,b.width,b.height)})},_replace_img:function(e,c,b,d){e.src=c;e.width=b/2;return e.height=d/2},_replace_background:function(f,b,c,d){var e;e="url('%(src)s')".format({src:b});return f.setStyle({backgroundImage:e})}}})();Util.smartLoad(function(){return HiRes.init()});var TwoFactorAuth;TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(a){this._user=viewer.get_user_by_id(a);assert(this._user,""+a+" is invalid");return $j("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){$j("#resend-link").on("click",this.resend_phone_code.bind(this));return $j("#code").focus()},init:function(a){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();return Util.async_load_script(a)},account_listen:function(){var h,a,b,d,f,k,l,c,j,g,i,e=this;j={name:"delivery_choice",enter:function(m){var n;e.hide_error();n=0;$j(".delivery-choice").each(function(){var o;o=$j(this).height();return n=Math.max(o,n)});$j(".delivery-choice").height(n);return $j(".delivery-choice.selected > input").prop("checked",true)},contents:$j("#twofactor-delivery-choice"),onSubmit:function(m,n,o){m.vars.sms=!!($j("#use-sms")[0].getValue()==="on");if(!m.vars.sms){return e.fetch_offline_key(m,n)}else{return n.next()}}};g={name:"enter_phone_number",enter:function(n){var o,m;e.hide_error();e._is_offline_setup=false;e._phone_number=null;o=$("twofactor-enter-phone");m=e.fill_phone_number_for_edit(o,$j("#twofactor-row-"+e._user.role+" #twofactor-sms-number").text());return m.focus()},contents:$j("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};i={name:"offline_setup",enter:function(m){e.hide_error();e._is_offline_setup=true;return e._phone_number=null},contents:$j("#twofactor-offline-setup")};c={name:"confirm_phone",enter:function(m){var n;e._invalid_code_count=0;if(e._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{n=m.vars.phone_number;assert(n,"expected a display_phone argument");$("phone-number-placeholder").__date(n);$("twofactor-enable-confirm").removeClassName("offline")}e.hide_error();$("phone-code").clear().focus();return e.fill_delivery_choice(n)},onSubmit:this.submit_phone_code.bind(this),contents:$j("#twofactor-enable-confirm")};l={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:$j("#twofactor-enter-backup-phone")};f=new ModalFlow(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:$j("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,function(m,n){e.successfully_enabled=false;m.vars.mode="ENABLE";m.vars.passed_password=true;return n.next()}),contents:$j("#twofactor-enter-password")},j,g,i,c,l,{name:"recovery_code",enter:function(){e.fill_backup_phone(e._backup_phone);return e.hide_error.bind(e)},onSubmit:this.submit_finish.bind(this),contents:$j("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:_("Congrats! You've enabled two-step verification!"),contents:$j("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});f.addExitListener(function(m){if(f.vars.passed_password&&m&&!e.successfully_enabled){return Notify.server_error(_("Two-step verification is not enabled"))}});d=new ModalFlow(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(n,o){var m;e.successfully_enabled=false;$j(".delivery-choice").removeClass("selected");m=!$j("#twofactor-row").hasClass("with-sms");$j(m?"#app-choice":"#sms-choice").addClass("selected");$j("#twofactor-recovery").addClass("edit-mode");n.vars.passed_password=true;return o.next()}),contents:$j("#twofactor-enter-password")},j,g,i,c,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(m){if(m.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});d.addExitListener(function(m){if(d.vars.passed_password&&m&&!e.successfully_enabled){return Notify.server_error(_("Two-step verification has not been changed"))}});a=new ModalFlow(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,function(m,n){e.successfully_disabled=false;m.vars.passed_password=true;return n.next()}),contents:$j("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:$j("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});a.addExitListener(function(m){if(a.vars.passed_password&&m&&!e.successfully_disabled){return Notify.server_error(_("Two-step verification is still enabled"))}});h=new ModalFlow(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(m,n){return n.next()}),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");b=new ModalFlow(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(m,n){return n.next()}),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");k=new ModalFlow(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(m,n){return new Ajax.DBRequest(e.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:e._checkpoint_token},onSuccess:function(o){var p;p=o.responseText.strip();if(p.startsWith("OK:")){e.fill_recovery_code(p.substr(3),"backup-code-div-edit");return n.next()}else{switch(p){case"EXPIRED":return e.show_error_expired();case"ALREADY_DISABLED":$j("#twofactor-row").removeClass("twofactor-enabled");Notify.server_success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:e.show_error500.bind(e),cleanUp:e.hide_loading.bind(e),subject_user:e._user})}),contents:$j("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:$j("#twofactor-recovery-edit"),onSubmit:function(m,n){e._checkpoint_token=null;return n.next()}}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");$j(".enable-twofactor").on("click",function(m){return e.start_flow(m,f)});$j(".disable-twofactor").on("click",function(m){return e.start_flow(m,a)});$j(".add-twofactor-backup-link").on("click",function(m){return e.start_flow(m,h)});$j(".edit-twofactor-backup").on("click",function(m){return e.start_flow(m,b)});$j(".edit-twofactor-recovery").on("click",function(m){return e.start_flow(m,k)});$j(".edit-twofactor-sms, .edit-twofactor-offline").on("click",function(m){return e.start_flow(m,d)});$j("#generate-new-recovery-code").on("click",function(m){e.show_loading();return new Ajax.DBRequest(e.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:e._checkpoint_token},onSuccess:function(n){var o;o=n.responseText.strip();if(o.startsWith("OK:")){return e.fill_recovery_code(o.substr(3),"backup-code-div-edit")}else{switch(o){case"EXPIRED":k.to_state("password");return e.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:e.show_error500.bind(e),cleanUp:e.hide_loading.bind(e),subject_user:e._user})});$j("#twofactor-enter-phone #country-code")[0].on("change",this.reset_phone_field_and_backup_country.bind(this));$j("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));$j("#resend-link").on("click",this.enable_resend_phone_code.bind(this));$j("#twofactor-delivery-choice input").change(function(){$j(".delivery-choice").removeClass("selected");return $j(this).parents(".delivery-choice").addClass("selected")});$j("#show-qr").on("click",function(m){$j("#twofactor-offline-setup").addClass("showing-qr");return false});$j("#hide-qr").on("click",function(m){$j("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&$j("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(h)}},start_flow:function(c,b){var a;c.preventDefault();a=$j(c.target).data("uid");TwoFactorAuth.set_user(viewer.get_user_by_id(a));this._current_flow=b;b.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return $j("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(b){var a,c=this;if(this.is_resending()){return}this.show_resending();a="/twofactor_resend";if($j("#twofactor-confirm").hasClass("backup")){a=URI.parse(a).updateQuery({backup:true}).toString()}new Ajax.DBRequest(a,{onSuccess:function(d){switch(d.responseText.strip()){case"OK":c.hide_error();return c.notify_resent();case"UNREACHABLE":return c.show_error_unreachable(true);case"BADCARRIER":return c.show_error_bad_carrier();case"INVALIDNUMBER":return c.show_error_invalid_number();case"NOTAMOBILE":return c.show_error_not_a_mobile();case"RATELIMIT":return Notify.server_error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(a){var b=this;if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return Notify.server_error(error_unreachable(true));case"BADCARRIER":return Notify.server_error(error_bad_carrier());case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return Notify.server_error(error_not_a_mobile());case"RATELIMIT":return Notify.server_error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}},onFailure:function(c){return Notify.server_error(b.error500())},cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(a){var b=this;if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return b.show_error_unreachable();case"BADCARRIER":return b.show_error_bad_carrier();case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return b.show_error_not_a_mobile();case"RATELIMIT":return Notify.server_error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":b._current_flow.to_state("password");return b.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:_("Enable two-step verification"),DEFAULT_EDIT_TITLE:_("Edit two-step verification"),DEFAULT_DISABLE_TITLE:_("Disable two-step verification"),ADD_BACKUP_TITLE:_("Add a backup phone number"),EDIT_BACKUP_TITLE:_("Edit backup phone number"),EDIT_RECOVERY_TITLE:_("View recovery code"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var a;this.hide_error();$j("#twofactor-recovery").removeClass("edit-mode");a=$("twofactor-enter-password");$j("#password",a).val("").focus();return false},submit_password:function(c,h,a,d,f){var b,g=this;b=$("password").getValue();if(!b){this.show_error(_("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(c,{parameters:{password:b},onSuccess:function(e){var i;i=e.responseText.strip();if(i.startsWith("OK:")){g._checkpoint_token=i.substr(3);return h(a,d)}else{switch(i){case"EXPIRED_PASSWORD":return g.show_error_expired_password();case"INVALID":return g.show_error(_("Invalid password"));case"RATELIMIT":return g.show_error(_("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is already enabled. Did you maybe enable it in another window?"));return Modal.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(a,b){var c=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:function(d){var e;e=d.responseText.strip();if(e.startsWith("OK:")){c.fill_key(e.substr(3));return b.next()}else{switch(e){case"EXPIRED":a.to_state("password");return c.show_error_expired()}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(b){var a,d,c;b=b.replace(new RegExp("=+$"),"");a=b.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(a);$("qr-div").__date();c=Constants.IS_PROD?"Dropbox":"DropboxDev";d={text:"otpauth://totp/"+c+":"+this._user.email+"?secret="+b+"&issuer="+c,width:200,height:200};if(!Modernizr.canvas){d.render="table"}$j("#qr-div").qrcode(d);if(!Modernizr.canvas){return $j("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(a,d,f){var c,b,g=this;b=$j.trim($j("#phone-number").val());if(!b){this.show_error(_("Please enter your phone number"));return}c=$j.trim($j("#country-code",f.currentTarget).val());b=this.validate_phone_number(c,b);if(!b){this.show_error(_("Invalid phone number"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:b},onSuccess:function(e){switch(e.responseText.strip()){case"OK":g._phone_number=b;a.vars.phone_number=b;return d.next();case"EXPIRED":a.to_state("password");return g.show_error_expired();case"UNREACHABLE":return g.show_error_unreachable();case"BADCARRIER":return g.show_error_bad_carrier();case"INVALIDNUMBER":return g.show_error_invalid_number();case"NOTAMOBILE":return g.show_error_not_a_mobile();case"RATELIMIT":return g.show_error(_("You've added too many phone numbers. Please try again in a few minutes."))}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},validate_phone_number:function(b,a){var c;a=a.replace(/\D/g,"");c=""+b+" "+a;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){if(!phone_helpers.is_valid(c)){return}return""+b+" "+(phone_helpers.format(b,a))}if(b==="+1"){if(a.length!==10){return}}else{if(!(a.length>=4)){return}}return c},submit_phone_code:function(a,b,d){var c,f=this;c=$("phone-code").getValue().strip();if(!c){this.show_error(_("Please enter the security code"));return}if(c.search(/^\d{6}$/)===-1){this.show_error(_("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:c},onSuccess:function(e){var h,g;g=e.responseText.strip();if(g.startsWith("OK:")){f.fill_recovery_code(g.substr(3),"backup-code-div");return b.next()}else{switch(g){case"INVALID":f._invalid_code_count+=1;h=f._invalid_code_count<=2?_("Invalid code"):f._is_offline_setup?_("Invalid code. Check the clock on your phone: it must be accurate to the minute."):_("Invalid code");return f.show_error(h);case"EXPIRED":a.to_state("password");return f.show_error_expired();case"RATELIMIT":return f.show_error(_("Too many invalid codes. Try again in a few minutes."))}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(d,b){var c,a;this.hide_error();c=$("twofactor-enter-backup-phone");a=this.fill_phone_number_for_edit(c,$j("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());a.focus();if(d==="back_next"){$j("#twofactor-backup-back-next").show();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").hide()}else{if(d==="cancel_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").show();return $j("#twofactor-backup-back-save").hide()}else{if(d==="back_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(f,c,a,g,h){var d,b;b=$j.trim($j("#backup-phone-number").val());if(b){d=$j.trim($j("#country-code",h.currentTarget).val());b=this.validate_phone_number(d,b);if(!b){this.show_error(_("Invalid phone number"));return}if(this.is_primary_number(b)){this.show_error(_("You can't use your primary phone as your backup"));return}}else{if(f){this.show_error(_("Please enter phone number"));return}}this._backup_phone=b;if(c==="save_backup_phone"){this.save_added_backup_phone(a,f,b)}else{if(c==="save_everything"){this.submit_finish(a,g,h)}else{if(c==="save_none"){return g.next()}}}},is_same_phone_number:function(b,a){if(!b||!a){return false}return b.replace(/\D+/g,"")===a.replace(/\D+/g,"")},is_primary_number:function(a){var b;b=$j("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(a,b.data("primary_phone"))){return true}if(this.is_same_phone_number(a,$j("#twofactor-sms-number",b).text())){return true}return false},save_added_backup_phone:function(a,c,b){var d=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:b},onSuccess:function(e){var f;switch(e.responseText.strip()){case"OK":d.hide_error();f="#twofactor-row-"+d._user.role;$j(""+f+" #twofactor-backup-number").text(b);$j(f).toggleClass("with-backup",!!b);Util.syncHeight();if(!b){Notify.server_success(_("Backup phone number removed"))}else{if(!c){Notify.server_success(_("Backup phone number updated"))}else{Notify.server_success(_("Backup phone number added"))}}return Modal.hide();case"EXPIRED":a.to_state("password");return d.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(d,f){var e,b,c,a;b=$j(".sick-input > input",d);if(!f){return b.val("")}a=$j('select[name="country_code"]',d);e=/^\+\d+/.exec(f);e=e?e[0]:"";c=this.option_for_country_code(a,e);if(c!=null){c.selected=true}b.val($j.trim(f.slice(e.length)));if(b.length){b[0].select()}return b},option_for_country_code:function(a,c){var b;if(c){b=$j('option[value="'+c+'"]',a);if(b.length>1){b=b.filter("[selected]")}if(b.length){return b[0]}}return $j("option[selected]",a)[0]},fill_delivery_choice:function(a){$j("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!a);$j("#twofactor-delivery-offline-label").toggle(!a);$j("#confirm-phone-primary-number").text(a);return $j("#twofactor-row-"+this._user.role).data("primary_phone",a)},fill_backup_phone:function(a){$j("#confirm-phone-backup").toggle(!!a);return $j("#confirm-phone-backup-number").text(a)},fill_recovery_code:function(b,a){b=b.toLowerCase().replace(/(.{4})/g,"$1 ");return $(a).__date(b)},submit_finish:function(a,b,c){var d,f=this;this.show_loading();d={checkpoint_token:this._checkpoint_token};if(this._backup_phone){d.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:d,onSuccess:function(e){switch(e.responseText.strip()){case"OK":f.successfully_enabled=true;if(a.vars.mode!=="ENABLE"){return f.after_enabled(a,b)}else{return b.next()}break;case"EXPIRED":a.to_state("password");return f.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(b,c){var a;this._checkpoint_token=null;this.hide_error();a=$j("#twofactor-row-"+this._user.role);a.toggleClass("with-sms",!!this._phone_number);$j("#twofactor-sms-number",a).text(this._phone_number||"");a.toggleClass("with-backup",!!this._backup_phone);$j("#twofactor-backup-number",a).text(this._backup_phone||"");a.addClass("twofactor-enabled");Util.syncHeight();if(b.vars.mode!=="ENABLE"){Notify.server_success(_("Two-step verification updated"));return c!=null?c.next():void 0}},disable_submit:function(a,b){var c=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:function(e){var d;switch(e.responseText.strip()){case"OK":c.successfully_disabled=true;c._checkpoint_token=null;d=$j("#twofactor-row-"+c._user.role);d.removeClass("twofactor-enabled with-sms with-backup");$j("#twofactor-sms-number, #twofactor-backup-number",d).text("");Util.syncHeight();Notify.server_success(_("Two-step verification is now disabled."));return b.next();case"EXPIRED":a.to_state("password");return c.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(b){var a;a=$$(this._error_selector);if(b===this.error_expired_password()||b===this.error_unreachable(true)){a.invoke("update",b)}else{a.invoke("__date",b)}return a.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(){return this.show_error(this.error_bad_carrier())},show_error_invalid_number:function(){return this.show_error(this.error_invalid_number())},show_error_not_a_mobile:function(){return this.show_error(this.error_not_a_mobile())},show_error_unreachable:function(a){if(a==null){a=false}return this.show_error(this.error_unreachable(a))},show_error_expired:function(){return this.show_error(this.error_expired())},show_error_expired_password:function(){return this.show_error(this.error_expired_password())},error_500:function(){return _("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return _("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return _("That is not a valid phone number.")},error_not_a_mobile:function(){return _("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(a){if(a==null){a=false}if(a){return _('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return _("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return _("Since it's been a while, please enter your password again.")},error_expired_password:function(){return _('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return Notify.server_success(_("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(b){var a,c;a=b.element();c=$j(".sick-input",a.form);$j("input",c).val("").focus();return this.fill_example_phone_number(a,c)},fill_example_phone_number:function(a,d){var c,b;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){c=$j(a).val().substr(1);b=phone_helpers.get_example_mobile_number(c);return $j("label",d).text(_("Example: ")+b)}},reset_phone_field_and_backup_country:function(b){var a;this.reset_phone_field(b);if($j("#backup-phone-number").val()===""){a=$j("#twofactor-enter-backup-phone #country-code");a.val(b.element().getValue());return this.fill_example_phone_number(a,$j(".sick-input",a[0].form))}}};var PseudoLocalStorage;PseudoLocalStorage={_store:{},getItem:function(a){return this._store[a]},setItem:function(a,b){return this._store[a]=b},removeItem:function(a){return delete this._store[a]},clear:function(){return this._store={}}};var DBLocalStorage;DBLocalStorage={dbstore:Modernizr.localstorage?window.localStorage:PseudoLocalStorage,_access_order_key:"ao",_get_access_order:function(){var a;a=this.dbstore.getItem(this._access_order_key);try{a=JSON.parse(a)}catch(b){a=[]}if(a instanceof Array){return a}else{return[]}},_to_key:function(a){return JSON.stringify(a)},attemptWrite:function(g,d){var i,c,e,h,f,j,b;i=0;c=10;f=0;b=[];while(i<c&&!f){e=this._get_access_order();e.push(g);try{this.dbstore.setItem(g,d);this.dbstore.setItem(this._access_order_key,JSON.stringify(e));f=1}catch(a){h=this._get_access_order();if(h.length){j=h.shift();this.dbstore.removeItem(j);this.dbstore.setItem(this._access_order_key,JSON.stringify(h))}else{this.dbstore.clear()}}b.push(i+=1)}return b},getItem:function(b){var c,a,d;b=this._to_key(b);d=this.dbstore.getItem(b);if(d){c=this._get_access_order();c.removeItem(b);c.push(b);this.dbstore.setItem(this._access_order_key,JSON.stringify(c));a=JSON.parse(d);return a}},setItem:function(a,b){return this.attemptWrite(this._to_key(a),JSON.stringify(b))},removeItem:function(a){var b;a=this._to_key(a);b=this._get_access_order();b.removeItem(a);this.dbstore.setItem(this._access_order_key,JSON.stringify(b));return this.dbstore.removeItem(a)},clear:function(){return this.dbstore.clear()}};var FileViewer;FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,file:null,has_preview:false,modal_type:this._MODAL_FILEINFO,shown:false,is_loaded:false,has_key_listener:false,is_file_private:true,history_length:null,preview_status_timeout_obj:null,preview_status_request:null,_get_extension:function(b){var a;a=b.lastIndexOf(".");return(a===-1?"":b.substr(a+1))},show:function(a,b){this.file=a;this.is_file_private=b;this.shown=true;this.history_length=window.history.length;if(this.file.preview_type==="download"){return window.location.href=this.file.href}else{this._render_viewer();return $j("#file-viewer").show()}},_log_view:function(){var a;a={mode:"file-preview",file_ext:Util.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,has_preview:this.has_preview&&this.file.bytes>0,doc_preview_status:this.file.doc_preview_status,file_bytes:this.file.bytes};return UserActivityLogger.log("web","file_view",JSON.stringify(a))},_render_viewer:function(){var a,h,j,c,l,k,i,m,b,d,g,e,f=this;Util.set_page_scrollable(false);a=$j("#file-viewer");j=URI.parse(this.file.href).updateQuery({dl:1}).toString();g=function(n){if(n==null){n=true}a.find(".title-bar .filename").text(f.file.filename.em_snippet(35));a.addClass("has-preview");if(f.file.htmlified_link){a.addClass("markdown-preview")}else{if(f.file.code_class){a.addClass("code-preview")}else{if(f.file.preview_type==="excel"){a.addClass("html-preview");a.find(".loading").css("z-index","-1")}else{a.addClass(""+f.file.preview_type+"-preview")}}}if(n){a.find(".loading").show()}a.find(".download-img-button").attr({href:j});f.modal_type=f._MODAL_PREVIEW;return f._listen()};l=function(){a.removeClass();a.find(".loading").hide();return f._unlisten()};d=function(n,p,o){if(n==null){n=false}if(p==null){p=true}if(o==null){o=false}f._log_view();if(!n){g(p)}f._render_preview(o);return f._initial_resize()};b=function(){var n;a.find(".title-bar .filename").text(f.file.filename.em_snippet(20));a.addClass("no-preview");a.find(".file-thumbnail img").attr({src:"/static/images/icons128/"+(Util.filename_to_icon(f.file.filename))+".png"});a.find(".file-type").text(typeof(n=f.file).get_category==="function"?n.get_category().capitalize():void 0);a.find(".file-size").text(f.file.size);a.find(".file-modified").text(f.file.ago);a.find(".download-button").attr({href:j});f.modal_type=f._MODAL_FILEINFO;f._listen();return f._initial_resize()};c=this._get_extension(this.file.fq_path);m=(this.file.preview_type==="doc"||this.file.preview_type==="excel")&&this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B;this.has_preview=(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(m&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE);if(this.has_preview){return d(false,!(this.file.preview_type==="doc"))}k=m&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS;if(!k){return b()}g();i=URI({path:"/doc_preview_status"+this.file.fq_path}).toString();e=Date.now();return(h=function(){var n;n=Date.now();if(n-e>=5000){l();return b()}return f.preview_status_request=$j.ajax(i,{success:function(o){if(f.file){return f.file.doc_preview_status=parseInt(o,10)}},complete:function(o,p){if(p==="abort"){return}if(f.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){f.has_preview=true;return d(true,false,true)}else{if(f.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return f.preview_status_timeout_obj=setTimeout(h,1000)}else{l();return b()}}},timeout:5000-(n-e),subject_user:Browse.active_user})})()},_remove_loading:function(a){if(a==null){a=true}$j("#file-viewer .loading").hide();return this.is_loaded=a},_initial_resize:function(){if(this.is_loaded){return}return setTimeout($j.proxy(this._resize,this),100)},_render_preview:function(b){var c,d,f,a,e,h,g=this;if(b==null){b=false}if(b){this._remove_loading(false)}f=$j("#file-viewer .preview");if(this.file.preview_type==="text"&&!this.file.htmlified_link){h=$j("<div/>",{id:"code-wrapper",tabindex:"0"});h.append($j("<pre/>",{id:"code","class":this.file.code_class||"plain-text"}));f.append(h);window.setTimeout((function(){return h.focus()}),0);window.addEventListener("message",function(i){if(i.data==="syntax.js"){FilePreview.init_text(g.file.href,true,$j.proxy(g._remove_loading,g),g.is_file_private);return window._syntax_js_loaded=true}});if(!window._syntax_js_loaded){Util.async_load_script(Constants.static_url_syntax_js);return Util.async_load_css("/static/css/syntax.css")}else{return FilePreview.init_text(this.file.href,true,$j.proxy(this._remove_loading,this),this.is_file_private)}}else{if(this.file.htmlified_link){d=$j("<iframe/>",{src:this.file.htmlified_link});f.append(d);return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){a=URI.parse(this.file.href).updateQuery({get_preview:1});if(Browse.use_pdf_caching){a.updateQuery({use_pdf_caching:1})}else{a.updateQuery({disable_range:1})}if(Constants.PDF_PREVIEW_MODE==="pdf-js"){c=a.toString();a.setPath(Constants.static_url_pdfjs_viewer);a.setQuery({file:c})}e=String(a.updateQuery(Constants.UID_PARAM_NAME,Browse.active_user));d=$j("<iframe/>",{src:e});f.append(d);return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){d=$j("<iframe/>",{src:this.file.href,sandbox:""});f.append(d);return d.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){a=URI.parse(this.file.href).updateQuery({get_preview:1});d=$j("<iframe/>",{src:a,sandbox:"allow-scripts"});f.append(d);return d.on("load",this._remove_loading)}}}}}},_listen:function(){var a;a=$j("#file-viewer");a.on("click",$j.proxy(this._hide,this));a.find("#file-viewer-container").on("click",function(b){return b.stopPropagation()});a.find(".close-img-button").on("click",$j.proxy(this._hide,this));if(!this.has_key_listener){key("esc",this.KEY_SCOPE,$j.proxy(this._hide,this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){a.find(".share-img-button").on("click",$j.proxy(this._share,this));a.find(".send-img-button").on("click",function(b){return Snapshots.send_copy([FileViewer.file.fq_path])});a.find(".link-img-button").on("click",function(b){return Snapshots.get_link([FileViewer.file.fq_path])})}else{if(this.modal_type===this._MODAL_FILEINFO){a.find(".share-button").on("click",$j.proxy(this._share,this));a.find(".send-button").on("click",function(b){return Snapshots.send_copy([FileViewer.file.fq_path])});a.find(".link-button").on("click",function(b){return Snapshots.get_link([FileViewer.file.fq_path])})}}return $j(window).on("resize",$j.proxy(this._resize,this))},_unlisten:function(){var a;a=$j("#file-viewer");a.off("click",$j.proxy(this._hide,this));a.find("#file-viewer-container").off("click",function(b){return b.stopPropagation()});a.find(".close-img-button").off("click",$j.proxy(this._hide,this));if(this.modal_type===this._MODAL_PREVIEW){a.find(".share-img-button").off("click",$j.proxy(this._share,this))}else{if(this.modal_type===this._MODAL_FILEINFO){a.find(".share-button").off("click",$j.proxy(this._share,this))}}$j(window).off("resize",$j.proxy(this._resize,this));return key.setScope(this.prev_scope)},_resize:function(c){var b,a;b=$j("#file-viewer");a=b.find("#file-viewer-container").height()-(b.find(".title-bar").height()+1);b.find(".preview").height(a);return b.trigger("height-resize",{height:a})},_share:function(c){var a,b;ShmodelUILogger.log("via-browse-file-viewer");c.preventDefault();b={};b[Constants.UID_PARAM_NAME]=Browse.active_user.id;a=String(URI({path:"/sm/create"+this.file.fq_path}));return Forms.postRequest(a,b,{target:"_blank"})},_hide:function(){var a;if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}BrowseSelection.set_selected_files(this.file);Util.set_page_scrollable(true);a=$j("#file-viewer");a.hide().removeClass("has-preview").removeClass("no-preview");a.find(".preview").empty();a.find(".file-thumbnail img").attr({src:""});a.find(".title-bar .filename").text("");a.attr({"class":""});this._unlisten();this._remove_loading();this.last_file=this.file;this.file=null;this.shown=false;return this.is_loaded=false},hide:function(){return this._hide()}};var Index2;Index2={init:function(h){var f,b,i,e,a,c,d,g;PasswordStrengthWatcher.watch("#password-field");$j("#sign-in").on("click",function(o){var j,m,l,k,n;o.preventDefault();l=$j("#sign-in-form");Modal.show(_("Sign in"),l[0],false,false,350,false,"sign-in-modal");m=l.find("#login_email");m.focus();return new SsoLoginChecks(j=m,n=function(){l.find("#password-field").hide();l.find("#remember-me").hide();l.find("#login_submit").val(_("Continue"));l.find("#forgot_password_link").hide();return l.find("#sso_description_footer").show()},k=function(){l.find("#password-field").show();l.find("#remember-me").show();l.find("#login_submit").val(_("Sign in"));l.find("#forgot_password_link").show();return l.find("#sso_description_footer").hide()})});f=function(){if(!$j("#signup-form").hasClass("form_shown")){return $j.when($j("#register-partial-container").animate({height:251},{easing:"easeInOutCubic",duration:500}).promise(),$j("#signup-form").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){$j("#signup-form").addClass("form_shown");return $j("#register-partial input").filter(":visible").first().focus()})}};if(!h){$j("#register-submit").on("click",function(j){if(!$j("#signup-form").hasClass("form_shown")){j.preventDefault();return f()}});Index2.animate()}else{$j(".photo").show();$j("#register-partial input").filter(":visible").first().focus()}$j(".buttons .freshbutton-blue").on("click",function(j){j.preventDefault();$j("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:f});return false});$j("#learn-more").on("click",function(j){j.preventDefault();$j("html, body").animate({scrollTop:$j("#divider").offset().top},{queue:false,duration:500});return false});if(Cookies.check_cookies_enabled()){WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}a=["#devices-background","#register-submit","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];c=function(j){return $j(j).on("click",function(){return WebMiscActivityLogger.log("index_page",{event_name:"click",id:j})})};for(d=0,g=a.length;d<g;d++){b=a[d];c(b)}e=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];i={};return $j(window).scroll(function(){var p,q,o,m,l,n,k,j;j=[];for(n=0,k=e.length;n<k;n++){o=e[n];if($j(o).length&&!i[o]){q=$j(window).scrollTop();p=q+$j(window).outerHeight();l=$j(o).offset().top;m=l+$j(o).outerHeight();if(m<=p){WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:o});j.push(i[o]=true)}else{j.push(void 0)}}else{j.push(void 0)}}return j})},_animate_points:function(g,h,k,b,m,f,a){var d,c,e,l;if(a==null){a=0}a=Math.min(Math.max(a,0),1);e=f(a);l=[(function(){var n,j,i;i=[];for(d=n=0,j=h.length;0<=j?n<j:n>j;d=0<=j?++n:--n){i.push([(function(){var p,o;o=[];for(c=p=0;p<2;c=++p){o.push(h[d][c]+(k[d][c]-h[d][c])*e)}return o})()])}return i})()];g.attr("points",Index2.points_array_to_str(l));if(a>=1){return m.resolve()}else{return setTimeout(function(){return Index2._animate_points(g,h,k,b,m,f,a+(10/b))},10)}},animate_points:function(b,g,f,c,e,d){var a;if(d==null){d=jQuery.easing.linear}a=$j.Deferred();Index2._animate_points(b,g,f,c,a,d);return a.done(function(){return typeof e==="function"?e():void 0}).promise()},animate_hide_rects:function(b,f,h){var a,c,g,e,d;a=$j.Deferred().resolve().promise();g=function(j){var o,l,n,k,m;k=$j(b[j]);o=Index2.points_str_to_array(k.attr("points"));m=[o[1],o[1],o[2],o[2]];l=Index2.inverse(jQuery.easing.linear);n=f*(l((j+1)/b.length)-l(j/b.length));return a=a.then(function(){return Index2.animate_points(k,o,m,n)})};for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){g(c)}return a.done(function(){return typeof h==="function"?h():void 0}).promise()},animate_delay:function(b){var a;a=$j.Deferred();setTimeout(a.resolve,b);return a.promise()},animate:function(){return $j.Deferred().resolve().promise().then(function(){return Index2.animate_docs()}).then(function(){return Index2.animate_graphs()}).then(function(){return Index2.animate_photos()})},inverse:function(b,a){if(a==null){a=0.000001}return function(f){var d,e,c;e=0;d=1;while(d-e>a){c=(e+d)/2;if(b(c)<f){e=c}else{d=c}}return e}},points_str_to_array:function(g){var c,f,e,b,d,a;d=g.split(" ");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];a.push((function(){var k,i,h,j;h=f.split(",");j=[];for(k=0,i=h.length;k<i;k++){c=h[k];j.push(parseFloat(c))}return j})())}return a},points_array_to_str:function(b){var a;return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push(a.join(","))}return c})()).join(" ")},animate_docs:function(){var g,a,d,c,f,b,e;b=[[5,6],[177,1],[184,157],[13,180]];a="";for(f=e=0.475;0.475<=0.625?e<=0.625:e>=0.625;f=e+=0.05){g=f+0.05;d=[[b[0][0]+(b[3][0]-b[0][0])*f,b[0][1]+(b[3][1]-b[0][1])*f],[b[1][0]+(b[2][0]-b[1][0])*f,b[1][1]+(b[2][1]-b[1][1])*f],[b[1][0]+(b[2][0]-b[1][0])*g,b[1][1]+(b[2][1]-b[1][1])*g],[b[0][0]+(b[3][0]-b[0][0])*g,b[0][1]+(b[3][1]-b[0][1])*g]];d=Index2.points_array_to_str(d);a+="<polygon points='"+d+"' style='fill:#f5f9fc;stroke:none;' />"}c=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+a+"\n</svg>");return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".comp.doc").append(c);return $j(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return Index2.animate_hide_rects(c.find("polygon"),2500,c.remove)}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return Index2.animate_delay(1500)}).then(function(){return $j(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var b,a;b=[[83,98],[158,37],[241,77],[171,145]];a=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');a.find("polygon").attr("points",Index2.points_array_to_str(b));return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".tablet.graph .graph-grid").hide();$j(".tablet.graph").append(a);return $j(".tablet.graph").show("fade",{},500).promise()}).then(function(){var c;c=[b[0],b[1],b[1],b[0]];return Index2.animate_points(a.find("polygon"),b,c,600,a.remove)}).then(function(){if(!$j.browser.msie_version_at_most(8)){return $j(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return Index2.animate_delay(2000)}).then(function(){return $j(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});$j(".phone.photo").show();return $j.when((function(){if(!$j.browser.msie_version_at_most(8)){return $j(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return $j.Deferred().resolve().promise().then(function(){return $j(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return Index2.animate_delay(750)}).then(function(){return $j(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var PasswordStrengthWatcher;PasswordStrengthWatcher={watch:function(a){var c,h,e,d,b,j,g,f=this;a=$j(a);c=_("Good passwords are hard to guess. Use uncommon words or inside jokes, non-standard uPPercasing, creative spelllling, and non-obvious numbers and symbols.");h=$j('<div class="db-password-bubble db-left-arrow">\n  <div class="db-arrow-border" />\n  <div class="db-arrow" />\n  <div class="password-bubble-title"></div>\n  <div class="password-bubble-desc">'+c+"</div>\n</div>").hide();j=function(){var i;i=$j(window).width()-($j("#password-field").offset().left+$j("#password-field").outerWidth())-40;h.width(Math.min(Math.max(120,i),160));return DbBubble.position(h,a,"right+4px")};b=$j('<div class="db-password-meter"/>').append((function(){var k,i;i=[];for(e=k=0;k<4;e=++k){i.push($j('<div class="db-password-dot"/>'))}return i})()).hover((function(){h.show();return j()}),(function(){return h.hide()}));if($j.browser.msie_version_at_most(9)){b.css("background-color","white")}a.append(h).append(b);d="";g=function(){var k,m,l,i;k=a.find("input").val();if(d===k){return}d=k;if(k==="correcthorsebatterystaple"||k==="Tr0ub4dour&3"||k==="Tr0ub4dor&3"){m=0;l=_("lol");$j(".password-bubble-title").text(l);if(k==="correcthorsebatterystaple"){$j(".password-bubble-desc").text(_("Whoa there, don't take advice from a webcomic too literally ;)"))}else{$j(".password-bubble-desc").text(_("Guess again"))}}else{i=["",_("Weak"),_("So-so"),_("Good"),_("Great!")];m=f.score(k);l=i[m];$j(".password-bubble-title").text(l);$j(".password-bubble-desc").text(c)}j();return b.find("div").css("background-color","#cce6f9").slice(4-m,4).css("background-color","#4093e0")};return setInterval(g,200)},get_user_inputs:function(){var b,a;a=["dropbox"];return a.concat((function(){var f,d,e,c;e=$j("#fname, #lname, #email");c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push($j(b).val())}return c})())},score:function(a){if(!(window.zxcvbn&&a)){return 0}return Math.max(1,zxcvbn(a,this.get_user_inputs()).score)}};var BatchThumbLoader;BatchThumbLoader={MAX_THUMB_BATCH_REQUESTS:24,MAX_URL_LENGTH:6000,batch_load_thumbs_queue:[],num_pending_batch_requests:0,batch_load_thumbs:function(h,g,b,j){var f,a,e,d,i,c;a={};for(d=0,i=h.length;d<i;d++){f=h[d];f=$j(f);e=f.data("uid");if(!(e in a)){a[e]=[]}a[e].push(f)}c=[];for(e in a){c.push(this.batch_load_thumbs_by_user(a[e],g,b,j,parseInt(e)||null))}return c},batch_load_thumbs_by_user:function(g,f,a,i,d){var e,b,c,h;b=[];for(c=0,h=g.length;c<h;c++){e=g[c];e=$j(e);if(e.data("src")){if($j.support.cors&&Constants.BATCH_THUMB_ENDPOINTS.length){b.push(e);if(b.length===f){this.batch_load_thumbs_queue.push([d,b]);b=[]}}else{Util.thumb_load(e,a)}}}if(b.length){this.batch_load_thumbs_queue.push([d,b])}if(this.num_pending_batch_requests<this.MAX_THUMB_BATCH_REQUESTS){return this._do_batch_load(a,i)}},_do_batch_load:function(f,o){var p,d,m,e,g,b,l,a,c,i,h,n,j,k=this;if(this.batch_load_thumbs_queue.length===0){return}j=this.batch_load_thumbs_queue.shift(),i=j[0],e=j[1];g=[];m=[];for(h=0,n=e.length;h<n;h++){d=e[h];a=d.data("src");if(a){d.data("src",null);d.data("loading-src",a);a=a.replace(/https?:\/\/[^\/]+\//,"/");c=URI.parse(a);delete c._query.dict[Constants.UID_PARAM_NAME];a=c.toString();g.push(a);m.push(d)}}if(!g.length){return}p=Constants.BATCH_THUMB_ENDPOINTS[Math.abs(Util.string_hash(JSON.stringify(g))%Constants.BATCH_THUMB_ENDPOINTS.length)];c=p+"?image_urls="+encodeURIComponent(JSON.stringify(g));b=(c.length<this.MAX_URL_LENGTH?"GET":"POST");l=function(v,z){var y,C,A,D,x,B,w,u,s,r,q,t;if(z==null){z=false}if(!v){return}D=v.split("\n");if(D.length<2){return}D.splice(D.length-1);x=function(G,F,E){if(!E){G.load(function(){return typeof f==="function"?f(G[0]):void 0});G.error(function(){return G.attr("src",G.data("fail-src")||Sprite.SPACER)})}G.attr("src",F);G.data("loading-src",null);if(E){return typeof f==="function"?f(G[0]):void 0}};for(A=u=0,r=D.length;u<r;A=++u){C=D[A];B=C.indexOf(":");if(B===-1){continue}w=C.substring(0,B).split("-");y=parseInt(w[0],10);C=C.substring(B+1);d=m[y];if(!d.length||!d.data("loading-src")){continue}if(C.indexOf("data:image")!==0){x(d,d.data("loading-src"),false);continue}x(d,C,true);if(typeof o==="function"){o(A,m.length)}}if(z){t=[];for(s=0,q=e.length;s<q;s++){d=e[s];if(d.data("loading-src")){t.push(x(d,d.data("loading-src"),false))}else{t.push(void 0)}}return t}};this.num_pending_batch_requests++;$j.ajax({url:p,type:b,data:{image_urls:JSON.stringify(g),parallel:true},dataType:"text",xhrFields:{withCredentials:true},progress:l,error:$j.ajax.retryOnce,success:function(q){return l(q,true)},complete:function(){k.num_pending_batch_requests--},subject_user:i});return this._do_batch_load(f,o)},clear_all_pending_batches:function(){return BatchThumbLoader.batch_load_thumbs_queue=[]}};var NotificationUIButton,UserNotifier,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var b,c,a;this.refresh_feed();$j("#event-feed-container").scroll(function(){if(UserNotifier._has_more){if(UserNotifier._scroller_within_offset_to_bottom(UserNotifier.SCROLLING_OFFSET)){return UserNotifier._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));$j("#event-feed").on("click",this._mouseclick.bind(this));a=[];for(c in NOTCLIENTS){b=NOTCLIENTS[c];a.push(this._subscribe_user(b))}return a},refresh_feed:function(a,b){var d,e,c,f=this;c=function(h){var k,i,j,g;f._unread_count=h.unread_count;f._notifications=h.notifications;if(h.meta_notification){i=h.meta_notification;j=f._identifier(i);if(j!==f._get_last_acked_meta_not_id()){f._unread_count++}f._current_meta_not_id=j;f._notifications.push(i)}f._has_acked=false;f._notifications.sort(f._sort_key);f._append_event_rows(true);f.update_jewel_ui(f._unread_count);if((a!=null)&&(b!=null)){g=a.get_user_id();k=h.latest_nid[g];a.handler_success(b,{nid:h.latest_nid[g]})}if(Sharing){return Sharing.refresh_inbox_counts()}};e=function(){return f._is_retrieving_feed=false};d=function(){var g;f._is_retrieving_feed=true;g={count:f.MAX_ROWS_TO_RETRIEVE};return new $j.ajax("/web/notifications/retrieve",{data:g,dataType:"json",type:"POST",success:c,error:function(){if((a!=null)&&(b!=null)){return a.handler_failure(b)}},complete:e})};return d()},ack_unread_notifications:function(){var a=this;if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new $j.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:function(d){var e,g,f,c,b;b=[];for(f=0,c=d.length;f<c;f++){g=d[f];e=a._identifier(g);a._acked_ids[e]=true;b.push(a._append_event_rows())}return b}});return this._has_acked=true}},update_jewel_ui:function(a){$j("#new-notification-count").text(a).toggleClass("show",a>0);if(a>0){$j(".notifications-bell").addClass("shake")}return setTimeout((function(){return $j(".notifications-bell").removeClass("shake")}),500)},scrolling:function(a){var b;if(a.originalEvent){a=a.originalEvent}b=a.detail?a.detail*(-40):a.wheelDelta;if(!this._has_more&&b<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(a)}else{if(b>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(a)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(a){if(typeof a.preventDefault==="function"){a.preventDefault()}return a.returnValue=false},_subscribe_user:function(a){var b,c=this;return b=a.subscribe_user({name:"NotificationFeedUpdater",handler:function(){return c.refresh_feed(a,b)}})},_append_event_rows:function(p){var g,a,n,i,d,r,f,k,j,o,e,l,b,c,q,h,m=this;if(p==null){p=false}if(p){$j("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}o=$j(".feed-row").size();a=[];h=this._notifications;for(f=c=0,q=h.length;c<q;f=++c){j=h[f];if(o>=this._num_event_rows){break}d=this._identifier(j);if(d in this._shown){continue}this._shown[d]=true;l=j.status;i=$j(j.notification_div);$j("#event-feed").append(i);o++;r=i.find("img").get(0);if(r){g=$j(r);n=g.attr("data-src");if(n){if(this._thumb_cache[n]){k=this._thumb_cache[n];g.attr("src",k);if(!k.endsWith(Sprite.SPACER)){this._add_thumbnail_frame(g)}}else{if(!(n in this._thumb_cache)){this._thumb_cache[n]=false;b=j.user_id;g.data("uid",b);g.data("not-identifier",d);a.push($(r))}}}}if(!i.hasClass("feed-row")){i=i.find(".feed-row")}if(j.type_id===Constants.NOTIFICATION_TYPE_META){i.addClass("meta-feed");if((!(d in this._acked_ids))&&(d===this._get_last_acked_meta_not_id())){i.addClass("read")}}if(l===this.USER_NOTIFICATION_STATUS_INVISIBLE){i.addClass("invisible");if(d in this._acked_ids){delete this._acked_ids[d]}}if(l===this.USER_NOTIFICATION_STATUS_READ){if(!(d in this._acked_ids)){i.addClass("read")}}}e=function(v){var t,s,u;if(!v.src.endsWith(Sprite.SPACER)){t=$j(v);m._add_thumbnail_frame(t);d=t.data("not-identifier");u=t.attr("data-src");s=t.attr("src");return m._thumb_cache[u]=s}};BatchThumbLoader.batch_load_thumbs(a,this.THUMBS_BATCH_SIZE,e);this._has_more=this._num_event_rows<this._notifications.length;if($j(".feed-row").length===0){return $j("#event-feed-container").addClass("empty")}else{return $j("#event-feed-container").removeClass("empty")}},_identifier:function(a){return""+a.user_id+" "+a.type_id+" "+a.target_object_key},_sort_key:function(d,c){if(d.sticky&&!c.sticky){return -1}if(c.sticky&&!d.sticky){return 1}if(d.status===UserNotifier.USER_NOTIFICATION_STATUS_UNREAD&&c.status!==UserNotifier.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(c.status===UserNotifier.USER_NOTIFICATION_STATUS_UNREAD&&d.status!==UserNotifier.USER_NOTIFICATION_STATUS_UNREAD){return 1}return c.feed_time-d.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(a){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,a)}},_add_thumbnail_frame:function(a){$j(a).addClass("thumbnail");return $j(a).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(c){var b,a;b=$j(c.target);if(b.is("a")){if(b.hasClass("view")){c.preventDefault();a=b.attr("data-mount");return window.open(a)}}},_scroller_within_offset_to_bottom:function(b){var a;a=$("event-feed-container");return a.scrollTop+a.offsetHeight+b>=a.scrollHeight}};NotificationUIButton=(function(b){__extends(a,b);a.prototype.selector=function(){return".notification-button"};function a(){this.clear=__bind(this.clear,this);this.active=__bind(this.active,this);this._clear_sticky_notification_on_popover_close=__bind(this._clear_sticky_notification_on_popover_close,this);a.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}a.prototype._clear_sticky_notification_on_popover_close=function(){if(!$j(this.selector())[0].hasClassName("active")){return UserNotifier.clear_cached_client_states()}};a.prototype.active=function(c,f){var d;d=c.target.hasClassName("feed-row")?c.target:$(c.target).up(".feed-row");if(d){if(!d.hasClassName("clickable")){return}}a.__super__.active.call(this,c,f);return this._clear_sticky_notification_on_popover_close()};a.prototype.clear=function(c){a.__super__.clear.call(this,c);return this._clear_sticky_notification_on_popover_close()};return a})(UIButton);var BetaLocaleNotificationBar,ExpiredCCNotificationBar,TopNotificationBar,TwoAccountAdminBar,UnsupportedBrowser;TopNotificationBar={SHOW_EVENT:"db:topnotificationbar:show",HIDE_EVENT:"db:topnotificationbar:hide",show:function(){var b,a;b=$j("#top-notification-bar-container");a=b.find(".top-notification-bar").attr("data-style-class");b.addClass(a).show();$j("body").addClass("top-notification-bar");$j("#notify-wrapper").addClass("has-top-notification-bar");return $j(document).trigger(this.SHOW_EVENT)},hide:function(){$j("#top-notification-bar-container").hide();$j("body").removeClass("top-notification-bar");$j("#notify-wrapper").removeClass("has-top-notification-bar");return $j(document).trigger(this.HIDE_EVENT)}};UnsupportedBrowser={init:function(){return $j("#unsupported-browser-dismiss").on("click",function(a){a.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};TwoAccountAdminBar={init:function(){$j("#two-account-admin-dismiss").on("click",function(a){a.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_two_account_msg",type:"POST",data:{is_admin:true}})});return $j("#two-account-banner-dismiss").on("click",function(a){a.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_two_account_msg",type:"POST"})})}};ExpiredCCNotificationBar={init:function(a){return $j(".expired-dismiss").on("click",function(b){b.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:a}})})}};BetaLocaleNotificationBar={init:function(a){return $j(".beta-locale-dismiss").on("click",function(b){b.preventDefault();TopNotificationBar.hide();return $j.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:a}})})}};var DBLoginForm;DBLoginForm=(function(){a.prototype.INVALID_CODE=1;a.prototype.BAD_REQUEST=2;a.prototype.get_error_message=function(b){switch(b){case this.INVALID_CODE:return _("Invalid code.");case this.BAD_REQUEST:return _("Sorry, an error occured. Please try again later.")}};function a(b,c){var d=this;this.root=b;this.container=this.root.parent();this.login_form=this.root.find(".auth-login-form");this.twofactor_form=this.root.find(".twofactor-login-form");this.login_endpoint=(c!=null?c.login_endpoint:void 0)||"/ajax_login";this.twofactor_endpoint=(c!=null?c.twofactor_endpoint:void 0)||"/ajax_verify_code";this.post_login_url=(c!=null?c.post_login_url:void 0)||"/home";this.redirect=c!=null?c.redirect:void 0;this.login_form.submit(function(){return d._auth()});this.twofactor_form.submit(function(){return d._twofactor_auth()});this.root.controller(this)}a.prototype.reset=function(){this._reset_login();this._reset_twofactor();return this.root.removeClass("checkpointed")};a.prototype._auth=function(){var b,c,d,e=this;this._clear_errors(this.login_form);b=$j("#login_submit");b.prop("disabled",true);d=function(g){var f;f=JSON.parse(g.responseText);switch(f.status){case"OK":e._success(f);if(e.redirect){return window.location.href=e.post_login_url}break;case"SSO":return window.location.href=f.sso_url;case"TWOFACTOR":e._checkpoint(f.remember_me,f.last_four_digits);return $j(document).trigger("twofactor.login");case"ERROR":e.reset();Notify.server_error(_(f.message));return e._process_csrf(f)}};c=function(f){var g;b.prop("disabled",false);if(e._has_validation_error(f)){return}g=e.get_error_message(e.BAD_REQUEST);return Notify.server_error(g)};b=this.login_form.find("input[type=submit]");Forms.ajax_submit(this.login_form[0],this.login_endpoint,d,c,b[0],{},"after");return false};a.prototype._twofactor_auth=function(){var b,c,d,e=this;this._clear_errors(this.twofactor_form);if(!$j("#code",this.root).val()){this._error(this.twofactor_form,this.INVALID_CODE,null);return}d=function(g){var f;f=JSON.parse(g.responseText);switch(f.status){case"OK":e._success(f);if(e.redirect){return window.location.href=e.post_login_url}break;case"INVALID":return e._error(e.twofactor_form,e.INVALID_CODE,g);case"EXPIRED":e.reset();return Notify.server_error(_("Sorry, your phone code has expired. Please try again."));case"ERROR":e.reset();Notify.server_error(_(f.message));return e._process_csrf(f)}};c=function(f){var g;g=e.get_error_message(e.BAD_REQUEST);return Notify.server_error(g)};b=this.twofactor_form.find("input[type=submit]");Forms.ajax_submit(this.twofactor_form[0],this.twofactor_endpoint,d,c,b[0],{},"after");return false};a.prototype._checkpoint=function(d,b){var c;if(b){this.root.find(".last-four-digits").text(b);this.twofactor_form.addClass("sms")}else{this.twofactor_form.removeClass("sms")}c=this.twofactor_form.find('input[name="remember_me"]');c.prop("checked",d);this.root.addClass("checkpointed");return this.root.find("#code-field input").focus()};a.prototype._reset_twofactor=function(){Forms.clear_errors(this.twofactor_form[0]);return this.twofactor_form.find("input[name=code]").val("")};a.prototype._reset_login=function(){var c,b;b=this.login_form.find("input[type=submit]");Forms.enable(b[0]);Forms.clear_errors(this.login_form[0]);c=this.login_form.find("input[type=password]");return c.val("")};a.prototype._clear_errors=function(b){Forms.clear_errors(b[0]);return b.find(".error-message").hide()};a.prototype._has_validation_error=function(b){return b.responseText.indexOf("err:")===0};a.prototype._error=function(d,c,b){var e;if(b&&this._has_validation_error(b)){return}e=this.get_error_message(c);return d.find(".error-message").text(e).show()};a.prototype._process_csrf=function(b){if(b.csrf_token!=null){return Constants.TOKEN=b.csrf_token}};a.prototype._success=function(c){var e,d,f,b;this._process_csrf(c);e=$j(".unblock-link-after-login");for(f=0,b=e.length;f<b;f++){d=e[f];$j(d).attr("onclick","");$j(d).attr("href",$j(d).data("href"))}$j(".remove-onclick-after-login").attr("onclick","");$j(".hide-after-login").hide();$j(".show-after-login").show();$j(document).trigger("login:success");return false};return a})();var AjaxForm,__bind=function(a,b){return function(){return a.apply(b,arguments)}};AjaxForm=(function(){a.SUCCESS_EVENT="db:ajaxform:success";a.ERROR_EVENT="db:ajaxform:error";a.prototype._submitted=false;function a(b,c){this.$form=b;this.do_before_submitting=c;this._fill_errors=__bind(this._fill_errors,this);this._clear_errors=__bind(this._clear_errors,this);this._on_complete=__bind(this._on_complete,this);this._on_error=__bind(this._on_error,this);this._on_success=__bind(this._on_success,this);this._submit_form=__bind(this._submit_form,this);this.$form.submit(this._submit_form);this.$submit_button=this.$form.find("[type='submit']")}a.prototype._get_form_data=function(){var h,c,d,g,f,b,e;h={};e=this.$form.find("input, select, textarea");for(f=0,b=e.length;f<b;f++){c=e[f];d=$j(c).attr("name");if(d){if($j(c).attr("type")==="checkbox"){g=$j(c).prop("checked")?"True":""}else{g=$j(c).val()}assert(!(d in h),"found multiple inputs with the same name");h[d]=g}}return h};a.prototype._submit_form=function(b){if(this._submitted){return false}if(typeof this.do_before_submitting==="function"){this.do_before_submitting()}this._clear_errors();this._submitted=true;this.$submit_button.prop("disabled",true);$j.ajax({url:this.$form.attr("action"),type:"POST",data:this._get_form_data(),dataType:"text",success:this._on_success,error:this._on_error,complete:this._on_complete});return false};a.prototype._on_success=function(d){var b;if(d.indexOf("err:")===0){this._on_error(d.substr(4));return}try{b=JSON.parse(d)}catch(c){this.$form.trigger(a.ERROR_EVENT);Notify.server_error();return}return this.$form.trigger(a.SUCCESS_EVENT,b)};a.prototype._on_error=function(c){var d;try{d=JSON.parse(c)}catch(b){if(typeof c==="string"){Notify.server_error(c)}else{Notify.server_error()}return}this._fill_errors(d);return this.$form.trigger(a.ERROR_EVENT)};a.prototype._on_complete=function(){this._submitted=false;return this.$submit_button.prop("disabled",false)};a.prototype._clear_errors=function(){this.$form.find(".error-message").remove();return this.$form.find("input").removeClass("input-error")};a.prototype._fill_errors=function(d){var f,c,e,b;b=[];for(c in d){e=d[c];f=$j("<span>",{"class":"error-message"}).text(e.message_text);f.insertBefore(this.$form.find("[data-error-field-name='"+c+"']"));b.push(this.$form.find("input[name='"+c+"']").addClass("input-error"))}return b};return a})();var BugReporter,BugReporterModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};BugReporterModal=(function(b){__extends(a,b);function a(){this._add_or_fill_hidden_input=__bind(this._add_or_fill_hidden_input,this);this._add_hidden_inputs=__bind(this._add_hidden_inputs,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_show=function(){var c=this;this.$modal_el=$j("#bug-report-modal");this.$modal_el.find(".bug-report-current-url").text(window.location.pathname);this.$modal_el.find(".bug-report-user-agent").text(navigator.userAgent);this.$form=this.$modal_el.find(".bug-report-form");new AjaxForm(this.$form,this._add_hidden_inputs);return this.$form.on(AjaxForm.SUCCESS_EVENT,function(){Notify.server_success("Thank you for reporting your bug! You rock!");c.hide();return delete c})};a.prototype._add_hidden_inputs=function(){this._add_or_fill_hidden_input("js_console_output",BugReporter.console_dump);this._add_or_fill_hidden_input("path",window.location.pathname);return this._add_or_fill_hidden_input("user_agent",navigator.userAgent)};a.prototype._add_or_fill_hidden_input=function(d,e){var c;c=this.$form.find("input[name="+d+"]");if(!c.length){c=$j("<input/>",{type:"hidden",name:d}).appendTo(this.$form)}return c.val(e)};return a})(DBModal);BugReporter=(function(){a.console_dump="";function a(b){var c=this;if(!window.console){window.console={}}this._catch_log_outputs();this._catch_asserts();if($j(".content-flag").length){b.addClass("content-flag")}b.click(function(){if(!c.modal){c.modal=new BugReporterModal({element_id:"bug-report-modal",focus:"#bug-report-desc"})}return c.modal.show()})}a.prototype._catch_log_outputs=function(){var b;if(typeof window.console.log!=="function"){window.console.log=function(){}}if(typeof window.console.debug!=="function"){window.console.debug=function(){}}if(typeof window.console.warn!=="function"){window.console.warn=function(){}}if(typeof window.console.error!=="function"){window.console.error=function(){}}b=function(c){return function(){var d;d=Array.prototype.slice.call(arguments);a.console_dump+=d.join(" ");a.console_dump+="\n";return c.apply(window.console,arguments)}};window.console.log=b(window.console.log);window.console.debug=b(window.console.debug);window.console.warn=b(window.console.warn);return window.console.error=b(window.console.error)};a.prototype._catch_asserts=function(){var b;if(typeof window.console.assert!=="function"){window.console.assert=function(){}}if(typeof window.assert!=="function"){window.assert=function(){}}b=function(d,c){return function(f,g){if(!f){try{throw new Error("Assertion failed: "+g)}catch(e){a.console_dump+=e.stack;a.console_dump+="\n"}}return c.apply(d,arguments)}};window.console.assert=b(window.console,window.console.assert);return window.assert=b(window,window.assert)};return a})();var HeaderBubble;HeaderBubble={init:function(b){var a;a=$j("#header-bubble-div");a.parent().addClass("active");return a.find(".header-bubble-close").on("click",function(c){c.preventDefault();a.parent().removeClass("active");return $j.ajax({url:b,type:"POST"})})}};var viewer;viewer=(function(){var a;a=null;if(typeof Constants!=="undefined"&&Constants!==null){a=Constants._viewer_properties;delete Constants._viewer_properties}return new Viewer(a)})();var handler,listener,_i,_j,_len,_len1,_ref,_ref1;if(!Constants.is_test){Util.smartLoad(Timezone.check_timezone)}if(window._document_observe_listeners){_ref=window._document_observe_listeners;for(_i=0,_len=_ref.length;_i<_len;_i++){listener=_ref[_i];if(document.loaded){listener.func()}else{document.observe(listener.event,listener.func)}}}if(window._jquery_ready_handlers){_ref1=window._jquery_ready_handlers;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){handler=_ref1[_j];$j(handler)}}Util.smartLoad(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});window.LoadedJsSuccessfully=true;